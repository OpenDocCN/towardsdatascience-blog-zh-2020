<html>
<head>
<title>Survival Analysis with LightGBM plus Poisson Regression</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于LightGBM加泊松回归的生存分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/survival-analysis-with-lightgbm-plus-poisson-regression-6b3cc897af82?source=collection_archive---------22-----------------------#2020-02-04">https://towardsdatascience.com/survival-analysis-with-lightgbm-plus-poisson-regression-6b3cc897af82?source=collection_archive---------22-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7f29" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">应用生存方法估计概率密度函数</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4cb7e742ba98ee7031415b90a96a8b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Lz6E5a1VdduMWmrI"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@filip42?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Philippe D. </a>拍摄的照片</p></figure><p id="07bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生存分析经常被用来解决诸如“T4”这样的问题，一个特定的事件还要多久才会发生？’。<strong class="lb iu">事件</strong>和<strong class="lb iu">时间</strong>是这种方法的关键变量。这些事件被认为是每时每刻都可能发生的极端情况:典型的例子是搅动、死亡、故障等等。时间的定义很简单，但是有点抽象。我们认为时间是持续时间；从这个意义上说，很明显，并非所有的“极端事件”都已经发生。由于一些外部环境，我们无法查看所有的生命历史，这意味着将持续时间视为相对的，即开始可能发生在不同的时间。</p><p id="4e9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">传统上，生存分析被用来衡量个体的寿命。该分析不仅可以进一步应用于传统的出生和死亡，还可以应用于任何持续时间等……我们如何通过生存建模来处理分类/回归问题令人惊讶。我们需要定义的只是<strong class="lb iu">事件</strong>和<strong class="lb iu">时间</strong>。</p><p id="06b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们开发了一个解决方案来预测<em class="lv">在某种时间和天气条件下</em>每天有多少自行车租赁被注册。任务是回归问题的形式，我们必须预测计数，这也可以提醒我们泊松回归问题，我们必须模拟离散变量。考虑到<strong class="lb iu">时间</strong>是逐渐“到达目前为止”的租赁次数，而<strong class="lb iu">事件</strong>是一天结束时记录的最终计数，我们的附加价值是将观点转换为生存方法。为了模拟这种现象，我们将使用一个经过调整的LightGBM估计器。</p><h1 id="c4f0" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">从倒退到生存</h1><p id="6994" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当时间和事件被定义时(即，我们分别有观察和目标)，我们必须思考如何才能达到我们的最终范围:估计一个<strong class="lb iu">生存函数</strong>。</p><p id="69f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有战略量化时间；它是一个非负的连续随机变量，其分布由概率密度函数<strong class="lb iu"> (PDF) </strong>或累积分布函数<strong class="lb iu"> (CDF) </strong>表征。</p><p id="bb1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">生存函数</strong>是时间的函数，它定义了死亡事件在时间t尚未发生的概率，或者等价地，给出了事件发生时间值大于t的人口比例。数学上，它是1-CDF。<strong class="lb iu">危险函数</strong> <strong class="lb iu"> (H) </strong>是事件发生的速率。给定一个固定的时间间隔，这是一个风险度量:危险越大，失败的风险越大。数学上，它是-log(S)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/5ef0cbd5a1399f897d49dc1537371c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgLYV5XvZA9hO20JyILbkQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">生存函数估计中涉及的所有元素的直观映射。来源:<a class="ae ky" href="https://lifelines.readthedocs.io/en/latest/Survival%20Analysis%20intro.html" rel="noopener ugc nofollow" target="_blank">生命线</a></p></figure><p id="223d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有各种方法来拟合生存模型。具体来说，我们对所谓的<em class="lv">半参数方法</em>感兴趣，在该方法中，我们试图用一种非常优雅和简单的技巧来学习风险函数:我们假设可以将时间细分为合理的小区间，即我们在每个区间中考虑我们的基线风险常数。在这种格式中，分段比例风险模型相当于某个泊松回归模型。<strong class="lb iu">生存函数</strong>可以从<strong class="lb iu">风险函数</strong>中导出，反之亦然，这一事实特别有用，因为它允许我们根据自己的兴趣轻松切换目标。</p><h1 id="a28f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据</h1><p id="5e41" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我们使用的数据集与华盛顿特区首都自行车共享系统2011年和2012年的两年历史数据相关，这些数据以每日和每小时的格式在此<a class="ae ky" href="https://www.kaggle.com/marklvl/bike-sharing-dataset" rel="noopener ugc nofollow" target="_blank">公开提供。目前，我们认为每日数据将我们的注意力集中在预测一天结束时临时用户的数量上。各种预测器可用于生成预报，如时间或天气回归。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/8b6094859a38446edaf1481051ad47bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UycBEF0Mxr7vhU6QTcppRQ.png"/></div></div></figure><p id="e687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，我们将<strong class="lb iu">时间</strong>变量定义为“到达目前为止”的租金，将<strong class="lb iu">事件</strong>定义为登记的最终计数，因此一个好的起点是绘制<strong class="lb iu">时间</strong>的CDF。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/295bfb584290d2135087c6b91c076dda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*rEEl7e_cBi1I5hxFOPYcBA.png"/></div></figure><p id="dd3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在固定的最大可达数量(4000)下，很明显我们的train-test分区的CDF非常不同。</p><h1 id="71fd" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">泊松回归下的生存光GBM</h1><p id="7d76" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">利用LGBM回归器，应用<em class="lv">半参数指数法</em>学习风险函数相当容易。这是可能的(如上所述),因为生存问题的负对数似然性与泊松回归的负对数似然性是一对一映射的，这在LGBM库中是默认初始化的。</p><p id="a5bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要做的就是为此目的整理我们的数据。特别地，数据集必须首先被扩展:每一行被复制成多行，从0到偶然计数登记，这是我们的死亡事件。然后生成两个新列:</p><ul class=""><li id="bd12" class="mw mx it lb b lc ld lf lg li my lm mz lq na lu nb nc nd ne bi translated"><em class="lv">到目前为止的计数</em>:从0到随机计数取值登记；</li><li id="c9e2" class="mw mx it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated"><em class="lv">停止</em>:除了到目前为止<em class="lv">计数的行</em> = <em class="lv">随机计数</em>外，其他地方都等于0</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/606b950238a095c5282a14800a0a6f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*KWBJxwCnKY_HsSNJquEyZg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">生成的新变量示例</p></figure><p id="2b15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了扩展的数据集，我们就可以开始训练了。拟合的计算一如既往:我们的目标由<em class="lv">分数</em>(一个0-1变量)表示，我们的回归变量是所有可用的外部变量加上迄今为止的<em class="lv">计数</em>，之前由我们自己生成。所有的魔法都是由我们的假设和泊松损失造成的。在预测阶段，我们必须像以前一样操作我们的测试数据，通过创建迄今为止的<em class="lv">计数</em>变量来扩展输入数据(<em class="lv">得分</em>未知)。为了使我们的生存函数有一个统一的形状并便于分数评估，一个好的做法是将目前为止的<em class="lv">计数与其他预测因子一起扩展到一个预先设定的极限，对我们来说是4000。还记得LGBM预测风险函数，为了获得相应的生存函数，我们必须操作这个简单的后处理转换:1-exp(cumsum(H))。</em></p><p id="0991" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用图表来检查一些预测:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/4c73a76ed0fb457e9cfa77f60ad3334e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssUEmoLROqbGFZ8biYwu7w.png"/></div></div></figure><p id="c8c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，从风险函数中导出的预测生存函数试图复制从一天结束时临时用户的总数中构建的真实CDF。我们预测总用户数的累积概率分布。换句话说，我们预测的每个值都表明了一天结束时最终计数小于或等于该数字的概率。</p><p id="19cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我们结果的评估是根据这类任务的标准分数进行的。连续排序概率得分(CRPS)将MAE推广到概率预测的情况。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/0c4f7486f46a045a49141f6f8524f335.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*6i4sfMzNvOOn-xNUS4Wshg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CRPS对我们任务的提法</p></figure><p id="fe72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CPRS是概率预测中使用最广泛的精确度指标之一。它需要评估所涉及的整个概率函数，因此需要估计每个每日样本的整个生存曲线。最后，我们可以在测试上达到0.283 CRPS，这比基于测试生存函数的哑估计的简单模型更好，其中CDF来自于训练(0.291 CRPS)。</p><h1 id="5933" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">摘要</h1><p id="d868" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在这篇文章中，我们开发了一个生存LGBM，它能够在给定一些外部预测和一些简单假设的情况下估计生存函数。我们解决了一个非经典的生存问题，在这个问题中，我们不需要估计在过去的时间中幸存的概率，但是我们估计了在一天结束时特定事件发生的概率。这是一个简单的例子，但它显示了如何应用生存建模技术，在一个不常见的场景中，我们的职责是估计概率密度函数。</p></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="1a78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/cerlymarco/MEDIUM_NoteBook" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">查看我的GITHUB回购</strong> </a></p><p id="db98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保持联系:<a class="ae ky" href="https://www.linkedin.com/in/marco-cerliani-b0bba714b/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a></p></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="49e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">参考文献</strong></p><p id="d0dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kaggle: <a class="ae ky" href="https://www.kaggle.com/c/nfl-big-data-bowl-2020/discussion/119433" rel="noopener ugc nofollow" target="_blank"> NFL大数据碗</a></p><p id="a1f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生命线:<a class="ae ky" href="https://lifelines.readthedocs.io/en/latest/Survival%20Analysis%20intro.html#hazard-function" rel="noopener ugc nofollow" target="_blank">生存分析介绍</a></p><p id="862d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">普林斯顿大学:<a class="ae ky" href="https://data.princeton.edu/wws509/notes/c7.pdf" rel="noopener ugc nofollow" target="_blank">广义线性模型，第七章，生存模型</a></p></div></div>    
</body>
</html>