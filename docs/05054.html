<html>
<head>
<title>How to do advanced analytics on graph data in Azure Cosmos DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure Cosmos DB中对图形数据进行高级分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-advanced-analytics-on-graph-databases-in-azure-cosmos-db-f0a83b4cb5c4?source=collection_archive---------32-----------------------#2020-05-01">https://towardsdatascience.com/how-to-do-advanced-analytics-on-graph-databases-in-azure-cosmos-db-f0a83b4cb5c4?source=collection_archive---------32-----------------------#2020-05-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e72a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习使用Gremlin在Cosmos DB中编写图形数据，然后使用GraphFrames读取/分析Azure Databricks中的数据。</h2></div><h1 id="38e3" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">0.介绍</h1><p id="b70d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure Cosmos DB 是一个完全托管的多数据库服务。它使您能够在全球范围内构建高度响应的应用程序。作为Cosmos DB的一部分，graph数据库支持Gremlin。由于Cosmos DB针对快速处理进行了优化(<a class="ae lw" href="https://en.wikipedia.org/wiki/Online_transaction_processing" rel="noopener ugc nofollow" target="_blank"> OLTP </a>)，<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/cosmos-db/gremlin-limits#limits" rel="noopener ugc nofollow" target="_blank">遍历限制</a>可能适用于繁重的分析工作负载(<a class="ae lw" href="https://en.wikipedia.org/wiki/Online_analytical_processing" rel="noopener ugc nofollow" target="_blank"> OLAP </a>)。在这种情况下，Azure Databricks和GraphFrames可以用作高级分析的替代方法，参见下面的架构。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/acd5503375783881d2127d1b125803ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lHiveLRvyEYj3FdrJVXXWA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">0.建筑(作者图片)</p></figure><p id="aaeb" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">在博客的剩余部分，完成了以下工作:</p><ul class=""><li id="c140" class="ms mt it lc b ld mn lg mo lj mu ln mv lr mw lv mx my mz na bi translated">OLTP:使用Gremlin API和Python将图形数据写入Cosmos DB</li><li id="5cf8" class="ms mt it lc b ld nb lg nc lj nd ln ne lr nf lv mx my mz na bi translated">OLAP:从Cosmos DB读取数据，分析Azure Databricks中的数据</li></ul><p id="941f" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">最后，在最后一章中得出结论。</p><h1 id="637b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.OLTP:使用Gremlin API将数据写入Cosmos DB</h1><p id="fe28" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本章中，Gremlin API和Python将用于向Cosmos DB写入数据。因为Azure Databricks将在下一章中用于OLAP，所以Azure Databricks集群也用于使用Gremlin API将数据写入Cosmos DB。然而，任何Python3环境都可以用来将数据写入Cosmos DB，例如Visual Code、PyCharm或Azure函数。执行以下步骤:</p><ul class=""><li id="1bfe" class="ms mt it lc b ld mn lg mo lj mu ln mv lr mw lv mx my mz na bi translated">1.1.安装必备组件</li><li id="3e86" class="ms mt it lc b ld nb lg nc lj nd ln ne lr nf lv mx my mz na bi translated">1.2.在Azure数据块中安装Gremlin Python库</li><li id="1317" class="ms mt it lc b ld nb lg nc lj nd ln ne lr nf lv mx my mz na bi translated">1.3.获取并运行笔记本</li></ul><p id="9567" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">另请参见下面的架构。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/d74be76b4d60fae74222601b5f13ca15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vc2VkfGP6-4NAxPsW5pVhg.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.OLTP:使用Gremlin API将数据写入Cosmos DB(图片由作者提供)</p></figure><h2 id="8367" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.1.安装必备组件</h2><p id="50a0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">需要安装以下先决条件:</p><ul class=""><li id="3def" class="ms mt it lc b ld mn lg mo lj mu ln mv lr mw lv mx my mz na bi translated"><a class="ae lw" href="https://docs.microsoft.com/nl-nl/azure/azure-databricks/quickstart-create-databricks-workspace-portal?toc=/azure/databricks/toc.json&amp;bc=/azure/databricks/breadcrumb/toc.json#step-2-create-a-databricks-workspace" rel="noopener ugc nofollow" target="_blank"> Azure数据块</a></li><li id="5261" class="ms mt it lc b ld nb lg nc lj nd ln ne lr nf lv mx my mz na bi translated"><a class="ae lw" href="https://docs.microsoft.com/nl-nl/azure/cosmos-db/create-graph-gremlin-console#create-a-database-account" rel="noopener ugc nofollow" target="_blank">带Gremlin API的Cosmos DB</a></li></ul><p id="2248" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">在Cosmos DB中创建数据库和图形时，可以使用/name作为分区键。将PeopleDB作为数据库的名称，将friends作为图形的名称，请参见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ns"><img src="../Images/c132d76e6c9665e5775c3a8412fcbd9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i6SOp0eClgW070-MfY1pag.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.1./name作为朋友图和PeopleDB数据中的分区键(图片由作者提供)</p></figure><h2 id="c848" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.2.在Azure数据块中安装Gremlin Python库</h2><p id="390d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">启动Azure Databricks工作区并转到群集。使用Databricks运行时版本6.4创建一个新集群，并且只有一个工作节点，另请参见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nt"><img src="../Images/32e2e3771a07cadd2e377825fe912528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0QNMy94z1Cbqc-frPvHy2Q.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.2a .创建数据块集群(图片由作者提供)</p></figure><p id="4a28" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">随后，转到您的集群并单击安装库。然后选择Pypi并搜索gremlinpython，然后单击install，另见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nu"><img src="../Images/87fc7e06d41584ce3b9076b8723f865a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nDpOWW1lddw2gdHUzpOJOA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.2b .在集群上安装gremlinpython库(图片由作者提供)</p></figure><h2 id="0caf" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.3.获取并运行笔记本</h2><p id="69ec" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的Azure Databricks工作区，右键单击，然后选择导入。在单选按钮中，选择使用URL导入以下笔记本:</p><pre class="ly lz ma mb gt nv nw nx ny aw nz bi"><span id="8dde" class="ng kj it nw b gy oa ob l oc od"><a class="ae lw" href="https://raw.githubusercontent.com/rebremer/cosmosdb-databricks-olap/master/insert_data_CosmosDB_OLTP_Python_Gremlin.py" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/rebremer/cosmosdb-databricks-olap/master/insert_data_CosmosDB_OLTP_Python_Gremlin.py</a></span></pre><p id="0a1f" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">笔记本导入后，您需要更改您的Cosmos DB端点的URL和您的Cosmos DB密钥，这可以在门户中找到，也请参见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oe"><img src="../Images/560a027d83cf8019689a584fabedb9f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wyHih1djxDT1brH5la4T1w.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.3a .使用gremlin API写入Cosmos DB的笔记本(图片由作者提供)</p></figure><p id="a18e" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">现在选择运行笔记本，数据将被写入Cosmos DB。验证数据是否存在，另见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi of"><img src="../Images/e354f59d88504d75ade3001e1a951819.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eFA9idTOgyJyq3tS0R8QBA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">1.3b . Cosmos DB中的数据(图片由作者提供)</p></figure><p id="ec93" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">在本章中，使用Gremlin API、Python和Azure Databricks添加了图形数据。在下一章中，将对数据进行分析，其中重复使用了Databricks集群。</p><h1 id="e76b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">2.OLAP:获取数据，用Azure Databricks进行分析</h1><p id="ab90" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本章中，数据是从Cosmos DB中检索的，并在Azure Databricks中使用GraphFrames进行分析。在这种情况下，数据直接从Azure Databricks中的Cosmos DB读取。由于Cosmos DB通常用作OLTP，因此可能需要首先在ADLSgen2中暂存数据，以最小化Cosmos DB上的负载，防止在需要大量数据加载时超时，并节省成本。然而，为了简单起见，在这篇博客中，数据直接从Cosmos DB读取到Azure Databricks。执行以下步骤:</p><ul class=""><li id="f674" class="ms mt it lc b ld mn lg mo lj mu ln mv lr mw lv mx my mz na bi translated">2.1.在Azure数据块中安装Cosmos DB和GraphFrames库</li><li id="eb68" class="ms mt it lc b ld nb lg nc lj nd ln ne lr nf lv mx my mz na bi translated">2.2.获取并运行笔记本</li></ul><p id="8eff" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">另请参见下面的架构。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/0f882d4a6ee838d6471c9ad1e1aba471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWjOL9aYLiVbVQsL_wdMwA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">2.OLAP:从Cosmos DB获取图形数据，并使用GraphFrames进行分析(图片由作者提供)</p></figure><h2 id="dcb3" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">2.1.在Azure数据块中安装Cosmos DB和GraphFrames库</h2><p id="e904" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Cosmos DB连接器和GraphFrames需要作为jar文件安装到上一章创建的集群中。使用此<a class="ae lw" href="https://github.com/Azure/azure-cosmosdb-spark#working-with-the-connector" rel="noopener ugc nofollow" target="_blank">链接</a>下载最新的uber Cosmos DB连接器到您的桌面。随后，转到your Azure Databricks集群并单击安装库。然后选择jar并放下Jar文件，也见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi og"><img src="../Images/21b4f6a0d3d1e0fcfd9f1429897ee0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0MQcB-5YgItK4yaYF9ygbw.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">2.1a .将Cosmos DB连接器安装到集群(图片由作者提供)</p></figure><p id="68c5" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">随后，使用这个<a class="ae lw" href="https://spark-packages.org/package/graphframes/graphframes" rel="noopener ugc nofollow" target="_blank">链接</a>下载最新的GraphFreams，并将其安装在与Cosmos DB连接器相同的was中。验证所有库是否安装正确，另请参见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oh"><img src="../Images/bb2d5664edb724894ab4affd025e7d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C-oNJR9elcw98FGNFGeuKg.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">2.1b .库安装正确(图片由作者提供)</p></figure><h2 id="3d44" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">2.2.获取并运行笔记本</h2><p id="b167" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的Azure Databricks工作区，右键单击，然后选择导入。在单选按钮中，选择使用URL导入以下笔记本:</p><pre class="ly lz ma mb gt nv nw nx ny aw nz bi"><span id="2db3" class="ng kj it nw b gy oa ob l oc od"><a class="ae lw" href="https://raw.githubusercontent.com/rebremer/cosmosdb-databricks-olap/master/get_data_cosmosDB_OLAP_Scala_GraphFrames.scala" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/rebremer/cosmosdb-databricks-olap/master/get_data_cosmosDB_OLAP_Scala_GraphFrames.scala</a></span></pre><p id="0917" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">笔记本导入后，您需要更改您的cosmos DB端点的URL和您的Cosmos DB密钥，这可以在门户中找到，也请参见下文。最后你可以运行笔记本了。在最后一个单元格中，您可以找到标签传播算法的结果，这是在社区检测中使用的，也请参见下文。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi oi"><img src="../Images/5c177fefa49c6aca7dc20d635845afa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQF6M-aLmTptRqFHNa7sIQ.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">2.2.Azure Databricks中图形的更高级查询(图片由作者提供)</p></figure><h1 id="6503" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">3.结论</h1><p id="f0fc" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae lw" href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction" rel="noopener ugc nofollow" target="_blank"> Cosmos DB </a>是Azure中的多模型数据库服务，支持图形数据库。由于Cosmos DB针对OLTP进行了优化，因此<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/cosmos-db/gremlin-limits#limits" rel="noopener ugc nofollow" target="_blank">遍历限制</a>可能适用于繁重的OLAP工作负载。在这种情况下，Azure Databricks和GraphFrames可以用作高级分析的替代方法，参见下面的架构。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/acd5503375783881d2127d1b125803ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lHiveLRvyEYj3FdrJVXXWA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">3.建筑(作者图片)</p></figure></div></div>    
</body>
</html>