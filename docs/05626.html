<html>
<head>
<title>Datalake File Ingestion: From FTP to AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据湖文件摄取:从FTP到AWS S3</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/datalake-file-ingestion-from-ftp-to-aws-s3-253022ae54d4?source=collection_archive---------9-----------------------#2020-05-11">https://towardsdatascience.com/datalake-file-ingestion-from-ftp-to-aws-s3-253022ae54d4?source=collection_archive---------9-----------------------#2020-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="701a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python中的Paramiko将文件从FTP服务器传输到AWS s3</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/8b10df22d1528069988b26025034ff0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*_HR7IsN5BMXOwed9zOF9AA.png"/></div></figure><p id="8a09" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">大家好。在开发Datalake管道时，数据接收是整个过程中的一个重要步骤。我们需要一个可靠，安全和容错的方法来把我们的文件从源(客户端FTP服务器)到我们的目标(AWS S3)。考虑到这一步的重要性，我用python开发了一个实现，可以用来将文件从FTP服务器接收到AWS s3。我以这样的方式设计代码，它可以在托管(AWS Glue)或未托管(本地机器)环境中使用，以将文件从FTP服务器传输到AWS s3。</p><p id="19cc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本文中，我将解释如何使用Python中的Paramiko库将存在于FileZilla等FTP服务器上的文件传输到Amazon s3。</p><p id="b707" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">文件摄取代码可以在我的GitHub <a class="ae lm" href="https://github.com/furqanshahid85-python/Python-FTP-File-Ingestion" rel="noopener ugc nofollow" target="_blank">库</a>中找到。文件接收代码执行以下操作:</p><ul class=""><li id="c3b6" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">使用Paramiko创建与文件服务器的安全ssh SFTP连接。</li><li id="c3eb" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">根据文件大小自动处理单部分和多部分上传(多部分在100MB或以上)。</li><li id="c4cf" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">在多零件上传期间，如果零件上传失败，会自动处理报废。</li><li id="9d7f" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">基于当前年、月、日、小时对s3中的数据进行分区。</li><li id="0a97" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">确保哪个文件已经上传</li><li id="bf0c" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">可以在AWS Glue中用作python作业，使用AWS Glue将文件从FTP传输到S3。</li></ul><p id="9d55" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了更好地理解，我将一步一步地介绍代码的每一部分。所以让我们开始吧。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="cf00" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">先决条件</h1><p id="17de" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">在开始之前，我们需要在本地机器上做一些安装设置，并在FTP服务器上设置一个目录。</p><h2 id="a5fb" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">本地机器设置</h2><p id="f095" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">我假设你们已经在机器上安装了python。如果你还没有安装python，访问这个<a class="ae lm" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank">链接</a>在你的机器上安装python。<br/>在进入代码之前，我们需要确保我们已经安装了以下模块:</p><p id="837c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">首先我们将安装Paramiko。</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="2def" class="nf mj it ns b gy nw nx l ny nz">pip install paramiko</span></pre><p id="9707" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">因为我们将上传文件到s3，我们将需要boto3客户端。</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="37fe" class="nf mj it ns b gy nw nx l ny nz">pip install boto3</span></pre><h2 id="4f4b" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">FTP服务器目录设置</h2><p id="1f73" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">我们需要在我们的FTP服务器上创建几个我们将在实现中使用的目录。</p><p id="9fc2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">注意:</strong>这个目录设置是一次性的，我们不必每次都做。</p><p id="1b27" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">连接到您的FTP服务器。我在我的案例中使用FileZilla。转到站点管理器。在协议下拉菜单中选择SFTP选项。输入您的主机、ip、用户名和密码，然后按连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ob oc di od bf oe"><div class="gh gi oa"><img src="../Images/853dfb762ac45e997b1468d8b04c2f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FkkTIxEAeX_qHnrOacQp5Q.png"/></div></div></figure><p id="945e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">连接后，在FTP服务器上创建两个目录:</p><ul class=""><li id="d709" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">您将上传文件的父目录。</li><li id="7935" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">经过处理的目录。这个目录将用于跟踪哪些文件已经上传到s3。</li></ul><p id="4ba0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">完成以上两个步骤后，我们现在已经安装了所有必要的模块和目录结构。我们现在可以开始实际的实现了。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="e39d" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">FTP到S3的实现</h1><p id="1325" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">让我们首先简单地浏览一下git存储库中的两个文件。</p><h2 id="db9f" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated"><strong class="ak">python _ glue _ injestion _ job . py</strong></h2><p id="6c77" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">我们的整个FTPIngestion类实现如下。我将逐一解释代码的每个部分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">python_glue_injestion_job.py</p></figure><p id="aa36" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">注意:</strong>我称之为python glue作业，因为我们可以在AWS Glue python shell环境中运行相同的代码，并使用AWS Glue实现相同的FTP文件传输功能。</p><h2 id="dd0b" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">配置. py</h2><p id="8c1e" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这个文件将定义我们所有的配置，如主机名、IP、端口、用户名、密码、s3存储桶名、ftp目录路径等。将所有配置保存在一个单独的文件中是一个很好的编程习惯。这使得我们的代码更易于管理。</p><p id="25dd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们通过将该文件导入python_glue_ingestion_job.py文件来使用它。我们的config.py文件如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">配置. py</p></figure><p id="5293" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在简要概述了我们的两个文件之后，让我们深入到代码的每一部分。</p><h2 id="9fd9" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">代码流</h2><p id="b11f" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">我们的代码从main方法开始。我们首先创建一个FTPIngestion类的对象<strong class="ks iu">。在创建对象时，调用<strong class="ks iu"> __init(self)__ </strong>方法来设置所有的配置值。</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">主要方法</p></figure><p id="3bd5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后<strong class="ks iu"> ftp_obj </strong>调用<strong class="ks iu">initiate _ ingestion(self)</strong>方法，该方法将首先使用<strong class="ks iu"> create_ssh_connection(self)方法</strong>创建一个与我们的ftp服务器的ssh连接。成功连接后，将使用<strong class="ks iu">create _ sftp _ connection(self)</strong>方法创建一个SFTP连接，我们将用它来访问FTP服务器。</p><p id="be96" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦建立了SFTP连接，我们执行以下操作</p><ul class=""><li id="0eb8" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">将当前目录更改为父目录</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="4313" class="nf mj it ns b gy nw nx l ny nz">self.sftp_client.chdir(self.ftp_directory_path)</span></pre><ul class=""><li id="f754" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">获取所有要上传到S3的文件</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="1d00" class="nf mj it ns b gy nw nx l ny nz">files_to_upload = self.sftp_client.listdir()</span></pre><ul class=""><li id="7472" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">使用<strong class="ks iu">create _ s3 _ partition(self)</strong>方法创建S3分区结构。我使用当前日期时间来设置分区结构，如下所示:</li></ul><p id="9177" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu"> / &lt;目录_名称&gt;/年= &lt;年&gt; /月= &lt;月&gt; /日= &lt;日&gt; /小时= &lt;小时&gt;/文件</strong></p><ul class=""><li id="f472" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">之后，我们开始一个接一个地上传文件。列表中的每个文件都被传递给<strong class="ks iu">S3 _ upload _ file _ multipart()</strong>方法。如果文件大小大于100Mb，文件将通过多部分上传，否则作为标准文件上传。</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="70f4" class="nf mj it ns b gy nw nx l ny nz">for ftp_file in files_to_upload:                    <br/>    sftp_file_obj = self.sftp_client.file(ftp_file, mode='r')<br/>    if self.s3_upload_file_multipart(sftp_file_obj,<br/>                                     s3_partition+ftp_file):<br/>        print('file uploaded to s3')<br/>        files_to_move.append(ftp_file)</span></pre><ul class=""><li id="36a2" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">在每次成功上传时，使用我们在FTP服务器上创建的<strong class="ks iu">move _ files _ to _ processed()</strong>方法将文件移动到已处理的目录中。这样做是为了跟踪已经成功上传到s3的所有文件。</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="fda4" class="nf mj it ns b gy nw nx l ny nz">if files_to_move:                    <br/>    for uploaded_file in files_to_move:<br/>        self.move_files_to_processed(uploaded_file)<br/>else:<br/>    print("nothing to upload")</span></pre><ul class=""><li id="e2be" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">所有文件成功上传后，我们使用<strong class="ks iu"> close_connections(self) </strong>方法关闭所有连接。</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="d515" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">更深入地了解我们的代码:</h1><p id="5daf" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">现在让我们详细讨论一下FTPIngestion类的每一部分。</p><h2 id="be05" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">初始化方法</h2><p id="b56b" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这是init方法，也称为我们类的构造函数。当我们创建一个FTPIngestion类的对象时，所有的属性都是在对象创建时设置的。每个属性的值都是从config.py类中获取的，我们在这个类中定义了它们的值。我们将config.py文件作为<strong class="ks iu"> cfg </strong>导入，并为每个属性设置相应的值。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">初始化方法</p></figure><p id="b0af" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">推荐:</strong>我们可以使用AWS SSM来代替config.py类，在这里我们为每个属性定义键值对，就像在config.py文件中一样。使用SSM更加可靠和安全。</p><h2 id="fa25" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">创建ssh连接方法</h2><p id="2c78" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这个方法使用给定的凭证创建一个与我们的FTP服务器的安全ssh连接。成功连接后，它会将<strong class="ks iu"> self.ssh_ok </strong>属性设置为True并返回。否则<strong class="ks iu"> self.ssh_ok </strong>设置为False并返回。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="dee1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这个方法中需要注意的一点是<strong class="ks iu">self . ssh _ client . set _ missing _ host _ key _ policy(paramiko。AutoAddPolicy())。</strong>我们将其配置为使用自动生成的策略设置缺失的主机密钥。如果您打算在AWS Glue中作为python shell作业运行此任务，请使用主机策略，而不是添加自动添加策略。为此，请在代码中执行以下操作</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="16bf" class="nf mj it ns b gy nw nx l ny nz">#self.ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())<br/># in production, use load_system_host_keys            <br/> self.ssh_client.load_system_host_keys()</span></pre><h2 id="6f07" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">创建_ sftp _连接方法</h2><p id="bc2f" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这个方法调用<strong class="ks iu"> create_ssh_connection </strong>方法创建ssh连接，然后继续打开SFTP连接。如果连接成功，它会将<strong class="ks iu"> self.sftp_ok </strong>设置为真，如果连接失败，则将其设置为假并返回值。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">创建_ sftp _连接方法</p></figure><h2 id="a156" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">移动文件到已处理的方法</h2><p id="b8e9" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">文件成功上传到s3后，在<strong class="ks iu"> initiate_ingestion </strong>方法中调用该方法。这个方法以文件名作为参数。将FTP服务器上的源路径和目的路径设置为<strong class="ks iu"> src </strong>和<strong class="ks iu"> dest </strong>，然后执行以下命令，将文件从<strong class="ks iu"> src </strong>路径移动到<strong class="ks iu"> dest </strong>路径。</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="94cd" class="nf mj it ns b gy nw nx l ny nz">try:<br/>    _, _, _ = self.ssh_client.exec_command("mv " + src+" " + dest)        except Exception as error:<br/>    print("error moving files to processed directory, error: ", error)</span></pre><p id="cbc0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们的<strong class="ks iu">move _ files _ to _ processed</strong>方法如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">移动文件到已处理的方法</p></figure><h2 id="83a7" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">创建_ s3 _分区方法</h2><p id="c80a" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这个方法创建s3分区结构。分区由根目录名后跟年、月、日、小时组成。通过这种方式，我们可以获得基于时间的分区数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">创建_ s3 _分区方法</p></figure><h2 id="762c" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">s3 _上传_文件_多部分方法</h2><p id="e56a" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">该方法将文件上传到指定的s3存储桶。它使用<strong class="ks iu"> TransferConfig </strong>类来处理多部分上传。我们为TransferConfig指定如下配置:</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="2d03" class="nf mj it ns b gy nw nx l ny nz">config = TransferConfig(multipart_threshold=cfg.MULTIPART_THRESHOLD,<br/>                        multipart_chunksize=cfg.MULTIPART_CHUNKSIZE,<br/>                        max_concurrency=cfg.MAX_CONCURRENCY,<br/>                        use_threads=cfg.USER_THREADS<br/>                        )</span></pre><ul class=""><li id="7e4a" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated"><strong class="ks iu"> multipart_threshold </strong>参数确定文件的最小大小，超过该值后，文件将通过multipart上传。AWS建议所有大于100MB的文件通过multipart上传，所以我把这个参数设置为100MB。这可以在config.py文件中更改。</li><li id="4fb5" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><strong class="ks iu"> multipart_chunksize </strong>参数决定了多部分上传期间每个部分的大小。我把它设置为20MB。</li><li id="61f8" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><strong class="ks iu"> max_concurrency </strong>参数决定了用于上传每个部分的并发S3 API传输操作的最大数量。默认值为10。</li><li id="3845" class="ln lo it ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">最后，<strong class="ks iu"> use_threads </strong>参数决定传输操作是否使用线程来实现并发。通过将use_threads属性设置为False，可以禁用线程使用。如果禁用线程使用，则不会发生传输并发。因此，max_concurrency属性的值将被忽略。</li></ul><p id="acd2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将这个配置对象作为参数传递给我们的s <strong class="ks iu"> 3.upload_fileobj </strong></p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="4a26" class="nf mj it ns b gy nw nx l ny nz">self.s3.upload_fileobj(source_file, self.s3_bucket_name,<br/>                       s3_target_file, Config=config)</span></pre><p id="9bde" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu"> TransferConfig </strong>类自动检查文件是作为单个部分上传还是通过多部分上传。它会自动处理失败的上传，并在失败时进行重试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="oh oi gj gh gi oj ok bd b be z dk translated">s3 _上传_文件_多部分方法</p></figure><h2 id="a239" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">initiate _摄取方法</h2><p id="8f43" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这个方法启动建立ssh和sftp连接的调用。将FTP目录路径更改为文件所在的指定路径。获取FTP指定路径中所有文件的列表，并开始上传到s3。成功上传到S3的文件被移动到FTP服务器上的已处理目录中。所有文件上传后，关闭所有连接。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="d2c9" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">关闭连接方法</h2><p id="cbed" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">这种方法用于关闭ssh和sftp连接。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="a2a6" class="nf mj it bd mk ng nh dn mo ni nj dp ms kz nk nl mu ld nm nn mw lh no np my nq bi translated">将代码用作AWS粘合工作</h2><p id="2a1e" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">如前所述，同样的实现可以用在AWS Glue这样的托管环境中。如果用户有文件在特定时间段(小时、天、月等)到达FTP服务器，他可以安排作业在特定时间运行，将所有文件从FTP服务器接收到s3。</p><p id="416e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们必须修改代码中的一些内容，以便能够将这个实现作为AWS Glue Python shell作业来运行</p><ul class=""><li id="91ed" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">在我们的<strong class="ks iu">python _ glue _ in jestion _ job . py</strong>文件的imports部分中，取消对以下导入的注释。我们使用easy install在Glue环境中安装paramiko模块，因为它没有默认的Python安装。</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="85b5" class="nf mj it ns b gy nw nx l ny nz">install_path = os.environ['GLUE_INSTALLATION']</span><span id="c70f" class="nf mj it ns b gy ol nx l ny nz">easy_install.main( ["--install-dir", install_path, "https://files.pythonhosted.org/packages/ac/15/4351003352e11300b9f44 a13576bff52dcdc6e4a911129c07447bda0a358/paramiko-2.7.1.tar.gz"] )</span><span id="35ed" class="nf mj it ns b gy ol nx l ny nz">reload(site)</span></pre><ul class=""><li id="10d8" class="ln lo it ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">在<strong class="ks iu"> create_ssh_connection </strong>方法中注释如下</li></ul><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="9199" class="nf mj it ns b gy nw nx l ny nz">#self.ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span></pre><p id="f5e7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">并取消对以下内容的注释</p><pre class="kj kk kl km gt nr ns nt nu aw nv bi"><span id="5546" class="nf mj it ns b gy nw nx l ny nz">self.ssh_client.load_system_host_keys()</span></pre><p id="62a8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们所做的不是使用<strong class="ks iu">自动生成的策略</strong>，而是使用我们所处环境的<strong class="ks iu">主机密钥。</strong></p><p id="edf7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">完成上述步骤后，我们可以在AWS Glue中将这段代码作为Python shell作业运行。</p><h1 id="a29f" class="mi mj it bd mk ml om mn mo mp on mr ms jz oo ka mu kc op kd mw kf oq kg my mz bi translated">摘要</h1><p id="a466" class="pw-post-body-paragraph kq kr it ks b kt na ju kv kw nb jx ky kz nc lb lc ld nd lf lg lh ne lj lk ll im bi translated">在本文中，我们研究了如何执行Datalake管道的数据接收步骤。我们学习了如何使用paramiko库创建与FTP服务器的安全ssh SFTP连接，并将文件从服务器上传到我们的AWS S3存储桶。我们还简要介绍了如何在AWS Glue这样的托管环境中使用给定的实现。</p><p id="5b69" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">链接到我的Github库:</strong></p><div class="or os gp gr ot ou"><a href="https://github.com/furqanshahid85-python/Python-FTP-File-Ingestion" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">furqanshahid 85-Python/Python-FTP-文件-摄取</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">这个模块提供了从FTP服务器上传文件到s3的功能。SFTP连接是通过…创建的</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">github.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ko ou"/></div></div></a></div></div></div>    
</body>
</html>