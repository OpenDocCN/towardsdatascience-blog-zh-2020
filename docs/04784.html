<html>
<head>
<title>Are you still using Pandas for big data?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你还在用熊猫做大数据吗？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/are-you-still-using-pandas-for-big-data-12788018ba1a?source=collection_archive---------1-----------------------#2020-04-27">https://towardsdatascience.com/are-you-still-using-pandas-for-big-data-12788018ba1a?source=collection_archive---------1-----------------------#2020-04-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9c1a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Pandas不支持多重处理，处理大数据集时速度很慢。有一个更好的工具可以让这些CPU内核发挥作用！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9e372810e020f3d0331e5efb0ce3299b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hUb5aYfQiMENzyxj8oYdzg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯·库里在<a class="ae ky" href="https://unsplash.com/s/photos/panda?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="ee00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谈到<a class="ae ky" rel="noopener" target="_blank" href="/exploratory-data-analysis-with-pandas-508a5e8a5964">探索性数据分析</a>，Pandas是最好的工具之一。但这并不意味着它是每项任务的最佳工具，比如大数据处理。我花了太多时间等待熊猫读取一堆文件，或者聚合它们并计算特征。</p><p id="a17a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我花时间找到了一个更好的工具，它使我更新了我的数据处理管道。我使用这个工具处理大量数据——比如读取多个10gb数据的文件，对它们应用过滤器并进行聚合。当我完成繁重的处理后，我将结果保存到一个较小的“熊猫友好”CSV文件中，并继续对熊猫进行探索性数据分析。</p><p id="93e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">这里有几个你可能会感兴趣的链接:</strong></p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a134" class="ma mb it lw b gy mc md l me mf">- <a class="ae ky" href="https://trymito.io/" rel="noopener ugc nofollow" target="_blank">Complete your Python analyses 10x faster with Mito</a> [Product]</span><span id="cf78" class="ma mb it lw b gy mg md l me mf">- <a class="ae ky" href="https://aigents.co/skills" rel="noopener ugc nofollow" target="_blank">Free skill tests for Data Scientists &amp; ML Engineers</a> [Test]</span><span id="1e41" class="ma mb it lw b gy mg md l me mf">- <a class="ae ky" href="https://imp.i115008.net/c/2402645/1116216/11298" rel="noopener ugc nofollow" target="_blank">All New Self-Driving Car Engineer Nanodegree</a><strong class="lw iu"> </strong>[Course]</span></pre><p id="9b53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">你愿意多看一些这样的文章吗？如果是这样，你可以点击上面的任何链接来支持我。其中一些是附属链接，但你不需要购买任何东西。</em></p><h1 id="a9f6" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">见见达斯克</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/8730e46d531cf4cefd9d37c47b17466c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frlSCqXvbbNW1y6Lv6LMaw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://dask.org/" rel="noopener ugc nofollow" target="_blank"> Dask <strong class="bd na">的dask标志。组织</strong> </a></p></figure><p id="2514" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dask为分析提供了先进的并行性，为您喜爱的工具提供了大规模性能。这包括numpy，熊猫和sklearn。<strong class="lb iu">它是开源的，可以免费获得。</strong>它使用现有的Python APIs和数据结构，使得在Dask支持的等价物之间切换变得容易。</p><blockquote class="nb"><p id="d000" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated">Dask让简单的事情变得简单，让复杂的事情变得可能</p></blockquote><h2 id="7f28" class="ma mb it bd mj nl nm dn mn nn no dp mr li np nq mt lm nr ns mv lq nt nu mx nv bi translated">熊猫大战达斯克</h2><p id="fdfe" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">我可以继续描述Dask，因为它有如此多的特性，但是，让我们看一个实际的例子。在工作中，我通常会收到一堆需要分析的文件。让我们模拟我的工作日，创建10个100K条目的文件(每个文件有196 MB)。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="31ed" class="ma mb it lw b gy mc md l me mf">from sklearn.datasets import make_classification<br/><strong class="lw iu">import</strong> pandas <strong class="lw iu">as</strong> pd</span><span id="488f" class="ma mb it lw b gy mg md l me mf">for i in range(1, 11):<br/>    print('Generating trainset %d' % i)<br/>    x, y = make_classification(n_samples=100_000, n_features=100)<br/>    df = pd.DataFrame(data=x)<br/>    df['y'] = y<br/>    df.to_csv('trainset_%d.csv' % i, index=False)</span></pre><p id="94bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们一起阅读那些有熊猫的文件，并测量时间。Pandas没有本地glob支持，所以我们需要循环读取文件。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="5fa4" class="ma mb it lw b gy mc md l me mf">%%time</span><span id="c805" class="ma mb it lw b gy mg md l me mf">import glob</span><span id="0bca" class="ma mb it lw b gy mg md l me mf">df_list = []<br/>for filename in glob.glob('trainset_*.csv'):<br/>    df_ = pd.read_csv(filename)<br/>    df_list.append(df_)<br/>df = pd.concat(df_list)<br/>df.shape</span></pre><p id="38a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">熊猫读文件花了16秒。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1ce0" class="ma mb it lw b gy mc md l me mf">CPU times: user 14.6 s, sys: 1.29 s, total: 15.9 s<br/>Wall time: 16 s</span></pre><p id="81dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，想象一下如果这些文件大100倍——你甚至不能用熊猫来读它们。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/443ac99c1b46e78ec5cc7d2378ff2c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*TNWm0YqmTMS2TryK.jpg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用<a class="ae ky" href="https://imgflip.com/memegenerator" rel="noopener ugc nofollow" target="_blank"> imgflip </a>创建的迷因</p></figure><p id="2531" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dask可以通过将数据分成块并指定任务链来处理不适合内存的数据。让我们测量一下Dask加载这些文件需要多长时间。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="b168" class="ma mb it lw b gy mc md l me mf">import dask.dataframe as dd</span><span id="23a7" class="ma mb it lw b gy mg md l me mf">%%time<br/>df = dd.read_csv('trainset_*.csv')</span><span id="e342" class="ma mb it lw b gy mg md l me mf">CPU times: user 154 ms, sys: 58.6 ms, total: 212 ms<br/>Wall time: 212 ms</span></pre><p id="dc09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dask需要154毫秒！这怎么可能呢？嗯，不是的。 Dask有延迟执行范式。它只在需要的时候计算东西。我们定义执行图，这样Dask就可以优化任务的执行。让我们重复这个实验——还要注意Dask的read_csv函数本身就接受glob。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="5d36" class="ma mb it lw b gy mc md l me mf">%%time</span><span id="58f2" class="ma mb it lw b gy mg md l me mf">df = dd.read_csv('trainset_*.csv').compute()</span><span id="70e4" class="ma mb it lw b gy mg md l me mf">CPU times: user 39.5 s, sys: 5.3 s, total: 44.8 s<br/>Wall time: 8.21 s</span></pre><p id="6777" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">compute函数强制Dask返回结果。Dask读取文件的速度是熊猫的两倍。</p><blockquote class="nb"><p id="a3a1" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated">Dask原生缩放Python</p></blockquote><h2 id="8b14" class="ma mb it bd mj nl nm dn mn nn no dp mr li np nq mt lm nr ns mv lq nt nu mx nv bi translated">熊猫与Dask CPU使用率</h2><p id="c237" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">Dask使用您购买的所有内核吗？我们来比较一下熊猫和Dask在读取文件时的CPU使用情况——代码同上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/91141ce154cc46be231dc3d00ac63059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*IjR4W2jngmIdGEgo.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">读取文件时熊猫的CPU使用率</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/da4d7e004632ad38a772ea799f428e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*QyDWXPkMHFSxvkZT.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">读取文件时Dask的CPU使用情况</p></figure><p id="d7fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的屏幕记录中，当读取文件时，pandas和Dask在多重处理上的差异是显而易见的。</p><h1 id="fdd8" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">幕后发生了什么？</h1><p id="1487" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">Dask的数据帧由多个熊猫数据帧组成，这些数据帧通过索引进行拆分。当我们用Dask执行read_csv时，多个进程读取一个文件。</p><p id="f493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们甚至可以可视化执行图。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="d199" class="ma mb it lw b gy mc md l me mf">exec_graph = dd.read_csv('trainset_*.csv')<br/>exec_graph.visualize()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/c4d8c3bc1b827223ff8a85c4664b3276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6lqbwbRNuO3M_TyBFkxR9w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">读取多个文件时的Dask执行图。</p></figure><h1 id="2562" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">Dask的缺点</h1><p id="f73d" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">你可能会想，如果达斯克这么伟大，为什么不一起抛弃熊猫呢？嗯，没那么简单。只有熊猫的某些功能被移植到Dask。其中一些很难并行化，比如对值进行排序和对未排序的列设置索引。Dask不是灵丹妙药——建议只对不适合主存的数据集使用Dask。由于Dask是建立在熊猫的基础上的，所以在熊猫中慢的操作在Dask中也会慢下来。就像我之前提到的，Dask是数据管道过程中的一个有用的工具，但是它不能取代其他库。</p><blockquote class="nb"><p id="243b" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated"><strong class="ak"> Dask仅推荐用于不适合主存的数据集</strong></p></blockquote><h1 id="eeee" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz oe ka mt kc of kd mv kf og kg mx my bi translated">如何安装Dask</h1><p id="3f4e" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">要安装Dask，只需运行:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ae0f" class="ma mb it lw b gy mc md l me mf">python -m pip install "dask[complete]"</span></pre><p id="3aaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将安装整个Dask库。</p><h1 id="4aa5" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">结论</h1><p id="798e" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在这篇博文中，我只触及了Dask库的皮毛。如果你想更深入地研究，请查看令人惊叹的<a class="ae ky" href="https://github.com/dask/dask-tutorial" rel="noopener ugc nofollow" target="_blank"> Dask教程</a>和<a class="ae ky" href="https://docs.dask.org/en/latest/dataframe.html" rel="noopener ugc nofollow" target="_blank"> Dask的数据框架</a>文档。对Dask支持哪些DataFrame函数感兴趣？检查<a class="ae ky" href="https://docs.dask.org/en/latest/dataframe-api.html" rel="noopener ugc nofollow" target="_blank">数据帧API </a>。</p><p id="e595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下载<a class="ae ky" href="https://romanorac.github.io/assets/notebooks/2020-04-27-are-you-still-using-pandas.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>跟随示例。</p><h1 id="ccfc" class="mi mb it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">在你走之前</h1><p id="dea3" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在<a class="ae ky" href="https://twitter.com/romanorac" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，在那里我定期<a class="ae ky" href="https://twitter.com/romanorac/status/1328952374447267843" rel="noopener ugc nofollow" target="_blank">发布关于数据科学和机器学习的</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/b5d426b68cc5a21b1a35d0a157ebc4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*69rP1pwjJi9mLSFE"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@cmhedger?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">考特尼·海杰</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure></div></div>    
</body>
</html>