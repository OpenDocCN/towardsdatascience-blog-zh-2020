<html>
<head>
<title>Build with PyCaret: Deploy on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 PyCaret 构建:部署在 Google 云平台上</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-pycaret-deploy-gcp-521415a6c330?source=collection_archive---------36-----------------------#2020-07-10">https://towardsdatascience.com/build-pycaret-deploy-gcp-521415a6c330?source=collection_archive---------36-----------------------#2020-07-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="3ea3" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">实用教程</h2><div class=""/><div class=""><h2 id="4f4a" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">将机器学习模型部署到谷歌云平台</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/40618bc0ad768943569a1f778bab6cb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lQRN9e1F1WdolD9ibtSUlw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">由作者创建</p></figure><p id="2b6b" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi md translated"><span class="l me mf mg bm mh mi mj mk ml di">在</span>这个故事中，我开发了一个关于在谷歌云平台上部署一个用<code class="fe mm mn mo mp b">pycaret</code>训练的模型的工作教程。本教程可以用来部署任何机器学习模型，稍加修改。</p><p id="4ae6" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将学习如何将使用<code class="fe mm mn mo mp b">pycaret</code>训练的模型部署到 Google 云平台。正如你可能知道的，<code class="fe mm mn mo mp b">pycaret</code>已经支持在 AWS 上部署训练好的模型，但目前还不支持 GCP 或 Azure。我遵循了库中用于在<a class="ae mq" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS </a>上部署模型的类似代码实践，并为 GCP 部署添加了必要的实用程序。</p><blockquote class="mr ms mt"><p id="629f" class="lh li mu lj b lk ll kd lm ln lo kg lp mv lr ls lt mw lv lw lx mx lz ma mb mc im bi translated">PyCaret 是 Python 中的一个开源、低代码机器学习库，它允许您在选择的笔记本环境中在几秒钟内从准备数据到部署模型。</p></blockquote><p id="3a5c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">PyCaret 是公民数据科学家的 autoML 框架，在其官方文档中使用。PyCaret 相对来说是一个新的库，几个月前发布供公众使用，目前仍在积极开发中。在浏览了一些源代码后，我意识到当前的公开版本缺乏对将经过训练/最终确定的模型部署到 Google 云平台的支持。但是，它只支持在 Amazon web services 上部署。</p><p id="dee9" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">考虑到 GCP 作为云服务的广泛使用，我尝试添加了一个教程，使用 PyCaret 的方式在 google cloud 上部署训练好的模型。</p><p id="4c7f" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">对于本教程，我们将使用<a class="ae mq" href="https://pycaret.org/reg101/" rel="noopener ugc nofollow" target="_blank">回归教程(REG101) —初级初学者</a>进行模型训练。</p><h2 id="a0f2" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">正在安装 PyCaret</h2><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="2bbf" class="my mz it mp b gy nu nv l nw nx">!pip install pycaret</span></pre><h2 id="338e" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">安装 Gdrive</h2><p id="4e6d" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">我们需要安装 google drive 来在 colab 环境中读/写数据。下面是最简单的安装方法。您将被要求输入访问过程生成的令牌。这里是关于<a class="ae mq" href="https://medium.com/@prajwal.prashanth22/google-colab-drive-as-persistent-storage-for-long-training-runs-cb82bc1d5b71" rel="noopener">安装 gdrive </a>的文章的链接</p><p id="4892" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在本教程中，我们将在 Google drive 上本地保存模型。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="e138" class="my mz it mp b gy nu nv l nw nx">from google.colab import drive<br/>drive.mount('/content/drive')</span><span id="469f" class="my mz it mp b gy od nv l nw nx">Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount("/content/drive", force_remount=True).</span></pre><p id="4720" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们创建一个目录来本地保存模型。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="e710" class="my mz it mp b gy nu nv l nw nx"># Create directory on google drive to save models locally. You can use temp paths.<br/>import os<br/>model_dir = '/content/drive/My Drive/gcp_deploy_model/'<br/>os.makedirs(model_dir, exist_ok=True)</span></pre><h1 id="38a4" class="oe mz it bd na of og oh nd oi oj ok ng ki ol kj nj kl om km nm ko on kp np oo bi translated">获取数据</h1><p id="81de" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">您可以从这里找到的原始源<a class="ae mq" href="https://github.com/DardenDSC/sarah-gets-a-diamond" rel="noopener ugc nofollow" target="_blank"><strong class="lj jd"/></a>下载数据，并使用 pandas <a class="ae mq" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jd">(了解如何使用)</strong> </a>加载数据，或者您可以使用 PyCaret 的数据存储库使用<code class="fe mm mn mo mp b">get_data()</code>函数加载数据(这将需要互联网连接)。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="7d9b" class="my mz it mp b gy nu nv l nw nx">from pycaret.datasets import get_data<br/>dataset = get_data('diamond')</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/66446cbf687a18a102c1fe15260841ce.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0zsEfrfrCHDKqXlN04hFjA.png"/></div></figure><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="132d" class="my mz it mp b gy nu nv l nw nx">#check the shape of data<br/>dataset.shape</span><span id="477c" class="my mz it mp b gy od nv l nw nx">(6000, 8)</span><span id="2c5b" class="my mz it mp b gy od nv l nw nx">data = dataset.sample(frac=0.9, random_state=786).reset_index(drop=True)<br/>data_unseen = dataset.drop(data.index).reset_index(drop=True)<br/><br/>print('Data for Modeling: ' + str(data.shape))<br/>print('Unseen Data For Predictions: ' + str(data_unseen.shape))</span><span id="2d01" class="my mz it mp b gy od nv l nw nx">Data for Modeling: (5400, 8)<br/>Unseen Data For Predictions: (600, 8)</span></pre><h2 id="be55" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">在 PyCaret 中设置环境</h2><p id="488a" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">让我们使用 PyCaret 的设置模块准备一个建模管道。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="acca" class="my mz it mp b gy nu nv l nw nx">from pycaret.regression import *</span><span id="bd41" class="my mz it mp b gy od nv l nw nx">exp_reg101 = setup(data = data, target = 'Price', session_id=123)</span><span id="91ae" class="my mz it mp b gy od nv l nw nx">Setup Succesfully Completed!</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/cd48414f2699aa99836c8cc2d473ced7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZYEDD5gQbj9U7twC93g5LQ.png"/></div></figure><h2 id="7749" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">创建一个轻型 GBM 模型</h2><p id="0cc0" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">对于本教程，我们使用 PyCaret 中实现的许多选项中的轻量级 GBM 对数据进行建模。您可以选择任何您喜欢的模型，但这不是本教程的重点。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="65ba" class="my mz it mp b gy nu nv l nw nx">lightgbm = create_model('lightgbm')</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/c81f1f42e47cda2b366ac5b8174515d0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8tBv6VUE5oNRZf1APwhAhg.png"/></div></figure><h2 id="21f8" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">调谐光梯度增强机</h2><p id="ede9" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">让我们来训练这个模型，用 PyCaret 的术语来说也叫做调整模型。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="66df" class="my mz it mp b gy nu nv l nw nx">tuned_lightgbm = tune_model('lightgbm')</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/f1e4fa9d3365c331cd2c323310fd1350.png" data-original-src="https://miro.medium.com/v2/format:webp/1*d286OlD7mjiE6GaBudIhpw.png"/></div></figure><h2 id="0f71" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">残差图</h2><p id="6926" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">下图显示了模型的残差</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="bb8f" class="my mz it mp b gy nu nv l nw nx">plot_model(tuned_lightgbm)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/354daee46e7b0e89bb33865a2d8af5ca.png" data-original-src="https://miro.medium.com/v2/format:webp/1*XMJ-ftbPicwpxkl4csGvaw.png"/></div></figure><p id="7011" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们画出预测误差与目标值的关系图。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="8587" class="my mz it mp b gy nu nv l nw nx">plot_model(tuned_lightgbm, plot = 'error')</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/932b7845482aa0aaaaebf3d9a8730c93.png" data-original-src="https://miro.medium.com/v2/format:webp/1*K6vDHlh-33TDBGpSg4xJfg.png"/></div></figure><h2 id="f73b" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">特征重要性图</h2><p id="b9e6" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">特征重要性是一个非常有用的图，可以看到模型中每个特征的贡献。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="2854" class="my mz it mp b gy nu nv l nw nx">plot_model(tuned_lightgbm, plot='feature')</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/871225bde4dc4b05464bc176a48ad62c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*N4wWX3DhJDvek9IDZLh1gw.png"/></div></figure><p id="a7fc" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">分析模型性能的另一种方法是使用<code class="fe mm mn mo mp b">evaluate_model()</code>函数，该函数显示给定模型的所有可用图的用户界面。它在内部使用<code class="fe mm mn mo mp b">plot_model()</code>功能。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="c619" class="my mz it mp b gy nu nv l nw nx">evaluate_model(tuned_lightgbm)</span><span id="90e1" class="my mz it mp b gy od nv l nw nx">interactive(children=(ToggleButtons(description='Plot Type:', icons=('',), options=(('Hyperparameters', 'param…</span></pre><h2 id="8fc4" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">根据测试/保留样本进行预测</h2><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="6beb" class="my mz it mp b gy nu nv l nw nx">predict_model(tuned_lightgbm);</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/94c6d10cb3df4ac900dfa5f455540763.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_oQ7cXKxMZiJTp3Gh0PQUg.png"/></div></figure><h2 id="307c" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">最终确定用于部署的模型</h2><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="b08f" class="my mz it mp b gy nu nv l nw nx">final_lightgbm = finalize_model(tuned_lightgbm)</span><span id="f80c" class="my mz it mp b gy od nv l nw nx">#Final Light Gradient Boosting Machine parameters for deployment<br/>print(final_lightgbm)</span><span id="8a52" class="my mz it mp b gy od nv l nw nx">LGBMRegressor(boosting_type='gbdt', class_weight=None, colsample_bytree=1.0,<br/>              importance_type='split', learning_rate=0.4, max_depth=10,<br/>              min_child_samples=20, min_child_weight=0.001, min_split_gain=0.9,<br/>              n_estimators=90, n_jobs=-1, num_leaves=10, objective=None,<br/>              random_state=123, reg_alpha=0.9, reg_lambda=0.2, silent=True,<br/>              subsample=1.0, subsample_for_bin=200000, subsample_freq=0)</span><span id="0f26" class="my mz it mp b gy od nv l nw nx">predict_model(final_lightgbm)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/0f461a17603a143160ec0e877fe366f0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cvr3tDKItHh_ukc83zIBPA.png"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/f6b4e90e43e4a3ee4acf637346bb32da.png" data-original-src="https://miro.medium.com/v2/format:webp/1*fBtRYBD96IAcc4ZzouL72g.png"/></div></figure><h2 id="063d" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">根据看不见的数据预测</h2><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="c6e5" class="my mz it mp b gy nu nv l nw nx">unseen_predictions = predict_model(final_lightgbm, data=data_unseen)<br/>unseen_predictions.head()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><p id="01df" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe mm mn mo mp b">Label</code>列被添加到<code class="fe mm mn mo mp b">data_unseen</code>集合中。标签是使用<code class="fe mm mn mo mp b">final_lightgbm</code>模型的预测值。如果您想对预测进行四舍五入，您可以在<code class="fe mm mn mo mp b">predict_model()</code>中使用<code class="fe mm mn mo mp b">round</code>参数。</p><h2 id="5478" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">在本地保存模型</h2><p id="4a0d" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">让我们首先在本地保存模型</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="0b07" class="my mz it mp b gy nu nv l nw nx">model_dir<br/>model_name = 'Final_lightgbm_model'</span><span id="0369" class="my mz it mp b gy od nv l nw nx">'/content/drive/My Drive/gcp_deploy_model/'</span><span id="20bd" class="my mz it mp b gy od nv l nw nx"># Saving model to google drive<br/><br/>save_model(final_lightgbm, model_dir + model_name)</span><span id="44c2" class="my mz it mp b gy od nv l nw nx">Transformation Pipeline and Model Succesfully Saved</span></pre><h2 id="3414" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">加载保存的模型</h2><p id="01a9" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">为了在将来的某一天在相同或不同的环境中加载已保存的模型，我们将使用 PyCaret 的<code class="fe mm mn mo mp b">load_model()</code>函数，然后轻松地将已保存的模型应用于新的未知数据进行预测。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="fa20" class="my mz it mp b gy nu nv l nw nx">saved_final_lightgbm = load_model(model_dir + model_name)</span><span id="5bbe" class="my mz it mp b gy od nv l nw nx">Transformation Pipeline and Model Sucessfully Loaded</span></pre><p id="512d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">一旦模型被加载到环境中，您可以使用相同的<code class="fe mm mn mo mp b">predict_model()</code>函数简单地使用它来预测任何新数据。下面我们应用了加载模型来预测我们在上一节中使用的相同的<code class="fe mm mn mo mp b">data_unseen</code>。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="e32d" class="my mz it mp b gy nu nv l nw nx">new_prediction = predict_model(saved_final_lightgbm, data=data_unseen)</span><span id="5d84" class="my mz it mp b gy od nv l nw nx">new_prediction.head()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><p id="3e24" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">注意<code class="fe mm mn mo mp b">unseen_predictions</code>和<code class="fe mm mn mo mp b">new_prediction</code>的结果是相同的。</p><h1 id="7566" class="oe mz it bd na of og oh nd oi oj ok ng ki ol kj nj kl om km nm ko on kp np oo bi translated">在谷歌云平台上部署训练好的模型</h1><p id="afa4" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">一旦我们有了训练好的模型，下一个任务就是部署它来为客户服务。有各种部署选项可用，但在这一节中，我将重点放在部署在谷歌云人工智能平台上。我尝试使用类似于<code class="fe mm mn mo mp b">pycaret</code>库中的方法在 AWS 上部署。</p><h2 id="9dd7" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">先决条件</h2><p id="cde9" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">在 google cloud 上部署机器学习模型的先决条件是</p><ul class=""><li id="7918" class="oq or it lj b lk ll ln lo lq os lu ot ly ou mc ov ow ox oy bi translated">熟悉谷歌云项目</li><li id="3004" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">对存储桶和 it gsutil 命令行工具有基本的了解</li><li id="4438" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">基本了解 gcloud 命令行工具与 Google Cloud 的交互</li><li id="cc2f" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">使用 PyCaret 的最终训练模型</li></ul><blockquote class="mr ms mt"><p id="f94a" class="lh li mu lj b lk ll kd lm ln lo kg lp mv lr ls lt mw lv lw lx mx lz ma mb mc im bi translated"><a class="ae mq" href="https://cloud.google.com/ai-platform/prediction/docs/deploying-models#scikit-learn-or-xgboost-model-file" rel="noopener ugc nofollow" target="_blank">阅读指南</a></p></blockquote><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="b089" class="my mz it mp b gy nu nv l nw nx">from google.colab import auth<br/>auth.authenticate_user()</span></pre><p id="ff89" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">定义 google cloud project，target bucket，设置 cloud_project 环境变量。创建一个谷歌云项目，如果之前没有创建的话。请遵循上述指南获取更多信息。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="6d3c" class="my mz it mp b gy nu nv l nw nx"># GCP project name, Change the name based on your own GCP project.<br/>CLOUD_PROJECT = 'gcpessentials-rz' # GCP project name<br/>bucket_name = 'pycaret-reg101-rz' # bucket name for storage of your model<br/>BUCKET = 'gs://' + CLOUD_PROJECT + '-{}'.format(bucket_name)<br/># Set the gcloud consol to $CLOUD_PROJECT Environment Variable for your Desired Project)<br/>!gcloud config set project $CLOUD_PROJECT</span><span id="aec1" class="my mz it mp b gy od nv l nw nx">Updated property [core/project].</span></pre><p id="1aed" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们定义了一些实用函数来创建 google 云存储桶，将 blob 上传到存储桶，并从存储桶下载 blob。</p><p id="acb7" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">代码取自谷歌官方文档，并根据我们的要求稍作修改。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="dc24" class="my mz it mp b gy nu nv l nw nx">from google.cloud import storage<br/><br/>def create_bucket(project_name, bucket_name):<br/>    """Creates a new bucket."""<br/>    # bucket_name = "your-new-bucket-name"<br/><br/>    storage_client = storage.Client(project_name)<br/><br/>    buckets = storage_client.list_buckets()<br/><br/>    if bucket_name not in buckets:<br/>      bucket = storage_client.create_bucket(bucket_name)<br/>      print("Bucket {} created".format(bucket.name))<br/>    else:<br/>      raise FileExistsError('{} already exists'.format(bucket_name))<br/><br/><br/>def upload_blob(project_name, bucket_name, source_file_name, destination_blob_name):<br/>    """Uploads a file to the bucket."""<br/>    # bucket_name = "your-bucket-name"<br/>    # source_file_name = "local/path/to/file"<br/>    # destination_blob_name = "storage-object-name"<br/><br/>    storage_client = storage.Client(project_name)<br/>    bucket = storage_client.bucket(bucket_name)<br/>    blob = bucket.blob(destination_blob_name)<br/><br/>    blob.upload_from_filename(source_file_name)<br/><br/>    print(<br/>        "File {} uploaded to {}.".format(<br/>            source_file_name, destination_blob_name<br/>        )<br/>    )<br/><br/>def download_blob(project_name, bucket_name, source_blob_name, destination_file_name):<br/>    """Downloads a blob from the bucket."""<br/>    # bucket_name = "your-bucket-name"<br/>    # source_blob_name = "storage-object-name"<br/>    # destination_file_name = "local/path/to/file"<br/><br/>    storage_client = storage.Client(project_name)<br/><br/>    bucket = storage_client.bucket(bucket_name)<br/>    blob = bucket.blob(source_blob_name)<br/>    <br/>    if destination_file_name is not None: <br/>      blob.download_to_filename(destination_file_name)<br/><br/>      print(<br/>          "Blob {} downloaded to {}.".format(<br/>              source_blob_name, destination_file_name<br/>          )<br/>      )<br/>    <br/>  <br/>    return blob</span></pre><h2 id="b1bb" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">将模型保存到 GCP 存储桶</h2><p id="e9d7" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">使用上面的实用程序，使用下面的代码将模型上传到 GCP 存储桶。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="09e2" class="my mz it mp b gy nu nv l nw nx"># Create Bucket<br/>create_bucket(CLOUD_PROJECT, bucket_name)</span><span id="a186" class="my mz it mp b gy od nv l nw nx">Bucket pycaret-reg101-rz created</span></pre><p id="422d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">将模型上传到 google 云存储桶</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="f040" class="my mz it mp b gy nu nv l nw nx"># Save Model Local/google drive and upload to GCP<br/>model_name_gcp = 'lightgbm-reg101-gcp'<br/>save_model(final_lightgbm, model_name= model_dir + model_name_gcp, verbose=False)<br/>model_src = model_dir + model_name_gcp +'.pkl'<br/>model_dst = str(model_name)+'.pkl'</span><span id="8e94" class="my mz it mp b gy od nv l nw nx">upload_blob(CLOUD_PROJECT, bucket_name, model_src, model_dst)</span><span id="1b18" class="my mz it mp b gy od nv l nw nx">File /content/drive/My Drive/gcp_deploy_model/lightgbm-reg101-gcp.pkl uploaded to Final_lightgbm_model.pkl.</span></pre><h2 id="8d1b" class="my mz it bd na nb nc dn nd ne nf dp ng lq nh ni nj lu nk nl nm ly nn no np iz bi translated">从 GCP 下载预测模型</h2><p id="a895" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">一旦你的模型上传到 GCP，你可以随时下载来进行预测。我遵循一个简单的流程，首先在本地或 google drive 中下载模型，然后使用<code class="fe mm mn mo mp b">load_model</code>函数，可以生成预测。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="fdf3" class="my mz it mp b gy nu nv l nw nx">outfile_name = model_dir + 'lightgbm-reg101-gcp-downloaded'<br/>model_gcp_src = str(model_name)+'.pkl'<br/>model_downloaded = download_blob(CLOUD_PROJECT, bucket_name, model_gcp_src, outfile_name + '.pkl')</span><span id="df1b" class="my mz it mp b gy od nv l nw nx">Blob Final_lightgbm_model.pkl downloaded to /content/drive/My Drive/gcp_deploy_model/lightgbm-reg101-gcp-downloaded.pkl.</span><span id="a1fb" class="my mz it mp b gy od nv l nw nx">os.listdir(model_dir)</span><span id="58c5" class="my mz it mp b gy od nv l nw nx">['Final_lightgbm_model.pkl',<br/> 'lightgbm-reg101-gcp.pkl',<br/> 'lightgbm-reg101-gcp-downloaded.pkl']</span></pre><p id="c7b3" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">使用最近从 GCP 下载的模型进行预测。</p><pre class="ks kt ku kv gt nq mp nr ns aw nt bi"><span id="f0bc" class="my mz it mp b gy nu nv l nw nx"># Loading the model for predictions<br/>gcp_final_lightgbm = load_model(outfile_name)</span><span id="2652" class="my mz it mp b gy od nv l nw nx">Transformation Pipeline and Model Sucessfully Loaded</span><span id="2d81" class="my mz it mp b gy od nv l nw nx"># Predictions from deployed model<br/>new_prediction_gcp = predict_model(gcp_final_lightgbm, data=data_unseen)</span><span id="3168" class="my mz it mp b gy od nv l nw nx">new_prediction_gcp.head()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl op"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><h1 id="77c5" class="oe mz it bd na of og oh nd oi oj ok ng ki ol kj nj kl om km nm ko on kp np oo bi translated">谷歌 Colab 笔记本</h1><p id="65a5" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">按照下面的谷歌合作笔记本来复制和实践这个指南。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pe pf l"/></div></figure><h1 id="f530" class="oe mz it bd na of og oh nd oi oj ok ng ki ol kj nj kl om km nm ko on kp np oo bi translated">结论</h1><p id="2176" class="pw-post-body-paragraph lh li it lj b lk ny kd lm ln nz kg lp lq oa ls lt lu ob lw lx ly oc ma mb mc im bi translated">在本教程中，我们学习了如何在使用<code class="fe mm mn mo mp b">pycaret</code>库训练时将模型部署到 GCP。</p><p id="3238" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">主要目标是使用<code class="fe mm mn mo mp b"><a class="ae mq" href="https://github.com/pycaret/pycaret" rel="noopener ugc nofollow" target="_blank">pycaret</a></code>的内置实用程序从 GCP 部署和加载模型。以下是一些亮点</p><ul class=""><li id="e89e" class="oq or it lj b lk ll ln lo lq os lu ot ly ou mc ov ow ox oy bi translated">安装 google drive 以保存模型</li><li id="1703" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">用<code class="fe mm mn mo mp b">pycaret</code>训练回归模型</li><li id="f443" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">保存并加载经过训练/最终确定的模型 google drive</li><li id="c77a" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">将经过培训/最终确定的模型部署到 GCP 存储桶</li><li id="69db" class="oq or it lj b lk oz ln pa lq pb lu pc ly pd mc ov ow ox oy bi translated">使用 GCP 部署的模型来执行预测</li></ul></div></div>    
</body>
</html>