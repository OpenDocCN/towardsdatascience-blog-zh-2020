<html>
<head>
<title>How to use Dynamic SQL in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BigQuery中使用动态SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-dynamic-sql-in-bigquery-8c04dcc0f0de?source=collection_archive---------2-----------------------#2020-05-20">https://towardsdatascience.com/how-to-use-dynamic-sql-in-bigquery-8c04dcc0f0de?source=collection_archive---------2-----------------------#2020-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4668" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">格式化字符串，并使用立即执行</h2></div><p id="13a3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">比方说，我们想要查找过去3天加拿大各省确诊的COVID病例数。有一个BigQuery公共数据集，里面有Johns Hopkins发布的信息，我们可以如下查询:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="adb9" class="lk ll iq lg b gy lm ln l lo lp">SELECT <br/> *   <br/>FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases<br/>WHERE country_region LIKE 'Canada'</span></pre><p id="d4aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lq"><img src="../Images/5da84c7409506e55df71effd4e69c795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yuMeF9N1BYx3ihDWxd-KrA.png"/></div></div><p class="ly lz gj gh gi ma mb bd b be z dk translated">每个日期都有一栏</p></figure><p id="a7f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">呀！每个日期都有一栏。我们如何找到最近三天的数据？</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mc"><img src="../Images/732f3439e6249e8f8c61f3b7c495b4c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TT5hKdI7Uzvso1qJUYWlEA.jpeg"/></div></div><p class="ly lz gj gh gi ma mb bd b be z dk translated">BigQuery中的动态SQL！图片由来自<a class="ae md" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=166539" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae md" href="https://pixabay.com/users/44833-44833/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=166539" rel="noopener ugc nofollow" target="_blank"> Jim Semonik </a>拍摄</p></figure><h2 id="59eb" class="lk ll iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">获取列的信息模式</h2><p id="fef7" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我们可以使用INFORMATION_SCHEMA来获取列的列表，并使用以下命令来查找最近三天:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="f366" class="lk ll iq lg b gy lm ln l lo lp">SELECT <br/>   column_name, <br/>    parse_date('_%m_%d_%y', column_name) AS date<br/>FROM <br/>  `bigquery-public-data`.covid19_jhu_csse.INFORMATION_SCHEMA.COLUMNS<br/>WHERE <br/>    table_name = 'confirmed_cases' AND <br/>    STARTS_WITH(column_name, '_')<br/>ORDER BY date DESC LIMIT 3</span></pre><p id="a8b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将返回:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/407377f833b2ae3513a996aec48eb2b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*blgS__1fPnab6PJM1oFVBw.png"/></div><p class="ly lz gj gh gi ma mb bd b be z dk translated">表中的最近天数</p></figure><h2 id="b2ff" class="lk ll iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">创建动态SQL语句</h2><p id="4da1" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">您可以使用EXECUTE IMMEDIATE运行动态SQL语句。例如，假设我们有一个列名为_5_18_20的变量，这就是如何使用它来执行SELECT语句:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4085" class="lk ll iq lg b gy lm ln l lo lp">DECLARE col_0 STRING;<br/>SET col_0 = '_5_18_20';</span><span id="e664" class="lk ll iq lg b gy nb ln l lo lp"><strong class="lg ir">EXECUTE IMMEDIATE</strong> <strong class="lg ir">format</strong>("""<br/>  SELECT <br/>     country_region, province_state, <br/>    <strong class="lg ir"> %s</strong> AS cases_day0<br/>  FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases<br/>  WHERE country_region LIKE 'Canada'<br/>  ORDER BY cases_day0 DESC<br/>""", <strong class="lg ir">col_0);</strong></span></pre><p id="d2f7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仔细看看上面的查询。首先，因为我声明了一个变量，等等。，这是一个BigQuery脚本，其中每个语句都以分号结束。</p><p id="2dc6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我使用BigQuery的<a class="ae md" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#format_string" rel="noopener ugc nofollow" target="_blank">字符串格式函数</a>来创建我想要运行的语句。因为我要传入一个字符串，所以我在格式字符串中指定了%s，并传入col_0。</p><p id="9a9f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果包括两个阶段:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nc"><img src="../Images/bffa28b91b9e419d35a96b1571c1359a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oC_Quv3n-MB1USKLPU0rgQ.png"/></div></div></figure><p id="fdf7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二阶段的结果是:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/687daf2f5854ea29562d5d6a983c0f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*RkGz_db3LAgaWo_KH7oJrw.png"/></div></figure><h2 id="cf14" class="lk ll iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">编写过去3天的脚本</h2><p id="59a2" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我们可以结合以上三个想法——INFORMATION _ SCHEMA、脚本和立即执行来获得过去3天的数据。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1485" class="lk ll iq lg b gy lm ln l lo lp">DECLARE columns ARRAY&lt;STRUCT&lt;column_name STRING, date DATE&gt;&gt;;</span><span id="42c8" class="lk ll iq lg b gy nb ln l lo lp">SET columns = (<br/>  WITH all_date_columns AS (<br/>    SELECT column_name, parse_date('_%m_%d_%y', column_name) AS date<br/>    FROM `bigquery-public-data`.covid19_jhu_csse.INFORMATION_SCHEMA.COLUMNS<br/>    WHERE table_name = 'confirmed_cases' AND STARTS_WITH(column_name, '_')<br/>  )<br/>  SELECT ARRAY_AGG(STRUCT(column_name, date) ORDER BY date DESC LIMIT 3) AS columns<br/>  FROM all_date_columns<br/>);</span><span id="9ec3" class="lk ll iq lg b gy nb ln l lo lp">EXECUTE IMMEDIATE format("""<br/>  SELECT <br/>     country_region, province_state, <br/>     %s AS cases_day0, '%t' AS date_day0,<br/>     %s AS cases_day1, '%t' AS date_day1,<br/>     %s AS cases_day2, '%t' AS date_day2<br/>  FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases<br/>  WHERE country_region LIKE 'Canada'<br/>  ORDER BY cases_day0 DESC<br/>""", <br/>columns[OFFSET(0)].column_name, columns[OFFSET(0)].date,<br/>columns[OFFSET(1)].column_name, columns[OFFSET(1)].date,<br/>columns[OFFSET(2)].column_name, columns[OFFSET(2)].date<br/>);</span></pre><p id="afaf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">步骤:</p><ul class=""><li id="0eb4" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">将列声明为一个数组变量，该变量将存储最近3天的列名和日期</li><li id="bc7c" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">将列设置为获取3天的查询结果。请注意，我正在使用ARRAY_AGG，这样我就可以将完整的结果集存储在一个变量中。</li><li id="8881" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">格式化查询。请注意，我使用`%t '来表示时间戳(有关详细信息，请参见字符串格式文档),并传入了六个参数。</li></ul><p id="2b37" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果是:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ns"><img src="../Images/c04f372501c0ea692d81a835b9850356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_IlsqIV0kH7qePvcz6eF0w.png"/></div></div></figure><h2 id="1332" class="lk ll iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">使用立即执行</h2><p id="dc51" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">除了使用字符串格式，您还可以使用如下命名变量:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="afb9" class="lk ll iq lg b gy lm ln l lo lp">EXECUTE IMMEDIATE """<br/>  SELECT country_region, province_state, _5_18_20 AS cases <br/>  FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases <br/>  WHERE country_region LIKE <a class="ae md" href="http://twitter.com/country" rel="noopener ugc nofollow" target="_blank"><strong class="lg ir">@country</strong></a><br/>  ORDER BY cases DESC LIMIT 3<br/>"""<br/><strong class="lg ir">USING 'Canada' AS country;</strong></span></pre><p id="e83d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您也可以使用问号来处理位置变量:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d35e" class="lk ll iq lg b gy lm ln l lo lp">EXECUTE IMMEDIATE """<br/>  SELECT country_region, province_state, _5_18_20 AS cases <br/>  FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases <br/>  WHERE country_region <strong class="lg ir">LIKE ?</strong><br/>  ORDER BY cases DESC <strong class="lg ir">LIMIT ?</strong><br/>"""<br/><strong class="lg ir">USING 'Canada', 3;</strong></span></pre><p id="d9f7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">USING子句在某些情况下很棘手。例如，以下内容不起作用:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9187" class="lk ll iq lg b gy lm ln l lo lp"><em class="nt">EXECUTE IMMEDIATE """<br/>  SELECT country_region, province_state, ? AS cases -- PROBLEM!!!<br/>  FROM `bigquery-public-data`.covid19_jhu_csse.confirmed_cases <br/>  WHERE country_region LIKE ?<br/>  ORDER BY cases DESC LIMIT ?<br/>"""<br/>USING '_5_18_20', 'Canada', 3; -- DOESNT WORK!!!!</em></span></pre><p id="8f0f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是因为第一个参数被解释为:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="8f51" class="lk ll iq lg b gy lm ln l lo lp"><em class="nt">'_5_18_20' AS cases</em></span></pre><p id="14a9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，不能通过使用。因此，我推荐使用String FORMAT()来创建立即执行的查询，因为它没有这些问题。</p><h2 id="825b" class="lk ll iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">下一步是什么？PIVOT()，就是这样！</h2><p id="1ad8" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">动态SQL特性是在big query 10岁生日的时候发布的。这里有一个视频，一些BigQuery的朋友祝它生日快乐:</p><figure class="lb lc ld le gt lr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="5d98" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来自10年前的第一个用户线程对在几秒钟内处理60B记录赞不绝口，并对近乎实时的查询(事情越变越多……)深思熟虑。在同一个线程中是第一个功能请求…枢轴:</p><figure class="lb lc ld le gt lr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/03b4b0774731cbba6c77910610633606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*voryfyUPWmT_XZmbiPSe1Q.png"/></div></figure><p id="0f17" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">动态SQL最终使这成为可能，<a class="nx ny ep" href="https://medium.com/u/279fe54c149a?source=post_page-----8c04dcc0f0de--------------------------------" rel="noopener" target="_blank"> Felipe Hoffa </a>承诺他将编写一个函数，最终能够在BigQuery中使用PIVOT()——敬请期待。</p><p id="0c59" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><p id="21dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nt">感谢我的同事</em><a class="nx ny ep" href="https://medium.com/u/ac51b9da0e54?source=post_page-----8c04dcc0f0de--------------------------------" rel="noopener" target="_blank"><em class="nt">Jagan r . Athreya</em></a><em class="nt">对使用格式的有益讨论和建议，并感谢</em><a class="nx ny ep" href="https://medium.com/u/279fe54c149a?source=post_page-----8c04dcc0f0de--------------------------------" rel="noopener" target="_blank"><em class="nt">feli PE Hoffa</em></a><em class="nt">的怀旧之旅。</em></p></div></div>    
</body>
</html>