<html>
<head>
<title>A Simple Kalman Filter Implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种简单的卡尔曼滤波实现</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-simple-kalman-filter-implementation-e13f75987195?source=collection_archive---------15-----------------------#2020-04-26">https://towardsdatascience.com/a-simple-kalman-filter-implementation-e13f75987195?source=collection_archive---------15-----------------------#2020-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="86a7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个储罐液位测量应用程序，帮助你开发卡尔曼滤波器的直觉</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8249335dbb5b505f797f4899f1d87450.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LHgBlRnX44cfYxSY"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">泰勒·尼克斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="1fd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi ls translated"><span class="l lt lu lv bm lw lx ly lz ma di">传感器本身并不能解决您的测量问题。它们本质上很吵，这可能会导致严重的问题。例如，当用作PID控制器的输入时，噪声数据可能会产生单位脉冲——高频信号的导数变得无穷大，导致执行器饱和，过程控制穿过窗口。</span></p><p id="d584" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一种需要准确性的情况是批量转移。在这种情况下，供应商希望尽可能精确地测量转移产品的体积，以防止损失金钱或向客户多收费。</p><p id="2e18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将演示一个简单的例子，说明如何开发一个卡尔曼滤波器来使用超声波传感器测量水箱的水位。</p><h2 id="2a98" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">该传感器</h2><p id="95f2" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">HC-SR04配有声学接收器和发射器。发射机发出一个波，这个波经过障碍物反射后到达接收机。传播时间除以两倍音速，得到传感器和感兴趣物体之间的距离。该传感器的工作范围为2至400厘米。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/366b0a850538a861b341e5d4f0e4a5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*TI_ODJ-WyRt2ylow4uHJcQ.jpeg"/></div></figure><p id="9a26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与许多传感器不同，这款传感器不需要模拟端口。通过微控制器的数字输出激活“Trig”引脚后，传感器将发出一个声波，该声波将反射并返回传感器，到达接收器，“Echo”引脚将变为高电平。“Trig”和“Echo”激活之间的时间除以2就是波传播时间。</p><h2 id="5ff6" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">该设置</h2><p id="573d" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">我在公寓的阳台上养了一些植物，为此我在上面放了一个带水泵的水箱，定期给它们浇水。每次这个油箱低于30%时，我都会收到系统的电子邮件通知。如果你有兴趣了解如何实现物联网，你可以看看我写的另一篇文章:</p><div class="na nb gp gr nc nd"><a href="https://medium.com/@cunhafh/iot-home-irrigation-system-using-losant-and-particle-photon-130df98ce386" rel="noopener follow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">使用氯生和粒子光子的物联网家庭灌溉系统</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">自动给植物浇水，获取警报，并分析数据</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">medium.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr kp nd"/></div></div></a></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/1e3a429f32f69b2383dc17dc9588cb99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rwgGw6yS1Hc_YLN_q5JJEg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我知道，我需要清理这个水箱。</p></figure><h2 id="5dae" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">卡尔曼滤波器</h2><p id="d663" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">该算法分为预测和更新两个阶段。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/111d42642e94fe3069ee48e7fe1422cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HPbaARB8GuFSjWJrteISqw.jpeg"/></div></div></figure><p id="b244" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不要让代数符号吓倒你，让我们分解这些方程。</p><p id="00a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在预测期间，系统通过执行过去的估计和系统输入的线性组合来估计储罐的容积。在我们的例子中，矩阵F将近似等于1(为了简单起见，我们可以忽略蒸发的影响)，因此在给定时刻罐的体积将是过去时刻的体积减去由泵抽吸的体积(我的系统输入)。</p><p id="d9ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我每天只灌溉植物一次，而且我的数据是通过wi-fi传输的，所以我想最小化负载。因此，我们可以忽略系统输入'<em class="nu"> u </em>'的影响。但是请注意，这是有代价的，滤波器的动态响应将受到影响。</p><p id="3beb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">预测的第二步是估计协方差Pk。我们不知道储罐液位的真实值，我们能做的最好的事情是估计最可能的值，并将其分配给最可能的方差。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/4e6de0c6fae369e47509fec6d671133f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fXBYYA1dhjY5bq0Lyx-UQ.jpeg"/></div></div></figure><p id="92d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在创新步骤中，我们将添加更多的信息，并尝试改进这一估计。让我们来看看:</p><p id="76c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要计算增益k，现在忽略计算的数学过程，我们将简化它。</p><p id="7b54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦计算出K，我们就可以计算出'<em class="nu">后验</em>'状态估计。注意，该量对应于预测状态和‘T4’新息的线性组合，新息由增益和误差的乘积定义。</p><p id="266c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们需要更新协方差p。</p><blockquote class="nw"><p id="3c26" class="nx ny iq bd nz oa ob oc od oe of lr dk translated">算法将总是从产生较小p值的组件(预测或创新)获得更多贡献。</p></blockquote><p id="7d2f" class="pw-post-body-paragraph kw kx iq ky b kz og jr lb lc oh ju le lf oi lh li lj oj ll lm ln ok lp lq lr ij bi translated">因此，对于我们的状态观测器，我们将有:</p><p id="2bca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">f =[1]<br/>B =[0]<br/>H =[1]<br/>Q =[1e-5]<br/>R =[3e-3]</p><p id="62ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我们可以把方程改写成:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/573e45cbe512b60c2833250cf033467a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Idf7pgqFpL2hRsPG47t_ww.jpeg"/></div></div></figure><h2 id="d6d9" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">密码</h2><p id="e1dc" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">有大量的C++卡尔曼滤波器库可供您使用。我仍然认为编写自己的代码来巩固知识是有用的。在我的例子中，我在本地声明了所有的变量，这样它们就可以被函数访问，但是还有更好的方法。</p><pre class="kg kh ki kj gt om on oo op aw oq bi"><span id="a4f8" class="mb mc iq on b gy or os l ot ou">int kalman_filter(){<br/>    //prediction<br/>    x_hat_k_a_priori = x_hat_k_minus_1;<br/>    P_k_a_priori = P_k_minus_1 + Q;<br/>    <br/>    //obtaining z_k: my tank height = 25.4, calculates %<br/>    digitalWrite(trigger, LOW);<br/>    delayMicroseconds(2);<br/>    digitalWrite(trigger, HIGH);<br/>    delayMicroseconds(10);<br/>    digitalWrite(trigger, LOW);<br/>    duration = pulseIn(echo, HIGH);<br/>    z_k = (25.4-duration*0.017)/25.4; <br/>    <br/>    //innovation <br/>    K_k = P_k_a_priori * (P_k_a_priori + R);<br/>    x_hat_k = x_hat_k_a_priori + K_k * (z_k - x_hat_k_a_priori);<br/>    P_k = (1 - K_k) * P_k_a_priori;<br/>    <br/>    return x_hat_k;<br/>}</span></pre><h2 id="2a84" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">结果</h2><p id="c138" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">下图显示了获得的结果。注意时间序列是平滑的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/58ac03efff100ab3fa9b10e0f378a8f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pic89PaoB3JT3hDwK37VQg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">储罐液位瞬时和历史测量值</p></figure><p id="e88f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">体积的突然增加是由于油箱重新装满。由于泵的激活，出现了小的下降。</p><h2 id="d189" class="mb mc iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">结论</h2><p id="67a7" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">实施并测试KF算法以从超声波传感器HC-SR04获取数据。测试结果表明，该算法能够显著降低噪声。</p><p id="1620" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">卡尔曼滤波器可用于多种应用，如传感器融合、不可及变量的状态估计甚至股票市场预测。</p><p id="e115" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你喜欢这篇文章或者想分享你的想法，请不要犹豫，在下面留下你的评论。</p><p id="1328" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谢谢！</p></div></div>    
</body>
</html>