<html>
<head>
<title>Hands-on guide to Python Optimal Transport toolbox: Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 最优传输工具箱实践指南:第 1 部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hands-on-guide-to-python-optimal-transport-toolbox-part-1-922a2e82e621?source=collection_archive---------26-----------------------#2020-08-25">https://towardsdatascience.com/hands-on-guide-to-python-optimal-transport-toolbox-part-1-922a2e82e621?source=collection_archive---------26-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bf47" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">最佳运输的第一步</h2></div><p id="a127" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为 Ievgen Redko 的关于最优传输的介绍性文章的后续文章，我将在下面介绍如何在实践中使用<a class="ae le" href="https://pythonot.github.io/" rel="noopener ugc nofollow" target="_blank"> Python 最优传输(POT) </a>工具箱求解最优传输(OT)。</p><p id="ec43" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，让我们从终端使用 pip 安装 POT，只需运行</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="e7cc" class="lo lp it lk b gy lq lr l ls lt">pip3 install pot</span></pre><p id="8729" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或与康达</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="6b5b" class="lo lp it lk b gy lq lr l ls lt">conda install -c conda-forge pot</span></pre><p id="b5ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切顺利，您现在已经安装了 POT，可以在您的计算机上使用了。</p><h1 id="bdb2" class="lu lp it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">POT Python 最佳运输工具箱</h1><h2 id="5320" class="lo lp it bd lv ml mm dn lz mn mo dp md kr mp mq mf kv mr ms mh kz mt mu mj mv bi translated">导入工具箱</h2><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="24b4" class="lo lp it lk b gy lq lr l ls lt">import numpy as np # always need it<br/>import scipy as sp # often use it<br/>import pylab as pl # do the plots</span><span id="7309" class="lo lp it lk b gy mw lr l ls lt">import ot # ot</span></pre><h2 id="c10c" class="lo lp it bd lv ml mm dn lz mn mo dp md kr mp mq mf kv mr ms mh kz mt mu mj mv bi translated">获得帮助</h2><p id="7b44" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">POT 的在线文档可从<a class="ae le" href="http://pot.readthedocs.io" rel="noopener ugc nofollow" target="_blank"> http://pot.readthedocs.io、</a>获得，或者您可以查看在线帮助<code class="fe nc nd ne lk b">help(ot.dist)</code>。</p><p id="a436" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在准备开始我们的例子。</p><h1 id="320f" class="lu lp it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">简单 OT 问题</h1><p id="7f76" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">我们将解决面包店/咖啡馆将羊角面包从一个城市(在本例中为曼哈顿)的多个面包店运送到咖啡馆的问题。我们在谷歌地图上快速搜索了曼哈顿的面包店和咖啡馆:</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/98df53b57026948cd21f37a4cd602417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*2We6thSOTNaRXPs21LYzwQ.png"/></div></figure><p id="f95c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们从这一搜索中提取他们的位置，并生成虚构的生产和销售数字(两者的总和相同)。</p><p id="6b58" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以访问描述<strong class="kk iu">来源分布</strong>的面包店<code class="fe nc nd ne lk b">bakery_pos</code>的位置及其各自的生产<code class="fe nc nd ne lk b">bakery_prod</code>。出售羊角面包的咖啡馆也由其位置<code class="fe nc nd ne lk b">cafe_pos</code>和<code class="fe nc nd ne lk b">cafe_prod</code>决定，并描述了<strong class="kk iu">目标分布</strong>。</p><p id="066f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们加载数据</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="190c" class="lo lp it lk b gy lq lr l ls lt">data = np.load('<a class="ae le" href="https://github.com/PythonOT/POT/raw/master/data/manhattan.npz" rel="noopener ugc nofollow" target="_blank">https://github.com/PythonOT/POT/raw/master/data/manhattan.npz</a>')</span><span id="29bd" class="lo lp it lk b gy mw lr l ls lt">bakery_pos = data['bakery_pos']<br/>bakery_prod = data['bakery_prod']<br/>cafe_pos = data['cafe_pos']<br/>cafe_prod = data['cafe_prod']<br/>Imap = data['Imap']</span><span id="b6e1" class="lo lp it lk b gy mw lr l ls lt">print('Bakery production: {}'.format(bakery_prod))<br/>print('Cafe sale: {}'.format(cafe_prod))<br/>print('Total croissants : {}'.format(cafe_prod.sum()))</span></pre><p id="b1f9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这给出了:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="4cff" class="lo lp it lk b gy lq lr l ls lt">Bakery production: [31. 48. 82. 30. 40. 48. 89. 73.]<br/>Cafe sale: [82. 88. 92. 88. 91.]<br/>Total croissants : 441.0</span></pre><h2 id="608c" class="lo lp it bd lv ml mm dn lz mn mo dp md kr mp mq mf kv mr ms mh kz mt mu mj mv bi translated">策划城市中的面包店</h2><p id="2aaf" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">接下来，我们在地图上标出面包店和咖啡馆的位置。圆圈的大小与它们的产量成正比。</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/3f830f79be55817bcd919317e1b6ec82.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*c_II5LhSLLpgXhqjgsVWUw.png"/></div></figure><h2 id="0de9" class="lo lp it bd lv ml mm dn lz mn mo dp md kr mp mq mf kv mr ms mh kz mt mu mj mv bi translated">成本矩阵</h2><p id="42a5" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">我们现在可以计算面包店和咖啡馆之间的成本矩阵，这将是<strong class="kk iu">运输成本矩阵</strong>。这可以使用<code class="fe nc nd ne lk b"><a class="ae le" href="https://pythonot.github.io/all.html#ot.dist" rel="noopener ugc nofollow" target="_blank">ot.dist</a></code>函数来完成，该函数默认为平方欧几里得距离，但可以返回其他值，如城市街区(或曼哈顿距离)。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="93e9" class="lo lp it lk b gy lq lr l ls lt">M = ot.dist(bakery_pos, cafe_pos)</span></pre><figure class="lf lg lh li gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nk"><img src="../Images/7c4e138372d072effacfc02ae731377b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BlLeJWIsSPv4uMkSKKS56w.png"/></div></div><p class="np nq gj gh gi nr ns bd b be z dk translated">面包店-咖啡馆问题的平方欧氏距离成本矩阵 M</p></figure><p id="0e68" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">矩阵图中的红色单元显示的是距离较远的面包店和咖啡馆，因此从一个地方到另一个地方的运输成本更高，而蓝色单元显示的是距离平方欧几里得距离非常近的面包店和咖啡馆。</p><h1 id="9227" class="lu lp it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">用推土机的距离解决加班问题</h1><p id="f130" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">我们现在来看问题本身，即找到将羊角面包从面包店运送到咖啡馆的最佳解决方案。为了做到这一点，让我们来看一点数学。</p><p id="4529" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">目标是找到传输矩阵<code class="fe nc nd ne lk b">gamma</code>,使得</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/c3c05ebd659298ddc288c2b91cb142cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*qzZpxaScOvLaZc1obZe65w.png"/></div></figure><p id="ddb8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中 M 是成本矩阵，a 和 b 分别是源和目标的样本权重。</p><blockquote class="nu nv nw"><p id="60bf" class="ki kj nx kk b kl km ju kn ko kp jx kq ny ks kt ku nz kw kx ky oa la lb lc ld im bi translated">这意味着，我们考虑了通过<em class="it"> M </em>将羊角面包从一家面包店运送到一家咖啡馆的成本，我们希望每一行<code class="fe nc nd ne lk b">gamma</code>的总和是相应的面包店要出售的羊角面包的数量，每一列的总和是相应的咖啡馆需要的羊角面包的数量。因此，运输矩阵的每个元素将对应于面包店必须送到咖啡馆的羊角面包的数量。</p></blockquote><p id="3699" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个问题被称为推土机的距离，或 EMD，也称为离散 Wasserstein 距离。</p><p id="f30c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们看看它在我们的例子中给出了什么。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="cf04" class="lo lp it lk b gy lq lr l ls lt">gamma_emd = ot.emd(bakery_prod, cafe_prod, M)</span></pre><p id="ed05" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下图(左图)显示了从面包店到咖啡馆的运输，线的宽度与要运输的羊角面包数量成比例。在右边，我们可以看到带有精确值的传输矩阵。我们可以看到，面包店只需要将羊角面包运输到一两家咖啡馆，运输矩阵非常稀疏。</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi ob"><img src="../Images/a71b28403d26a9966c430789f88f3096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIty5VZQDQFwMv9YkIw_jw.png"/></div></div><p class="np nq gj gh gi nr ns bd b be z dk translated">EMD 下的最优运输</p></figure><h1 id="45d5" class="lu lp it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">用 Sinkhorn 正则化 OT</h1><p id="701a" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">EMD 的一个问题是它的算法复杂度是 O( <em class="nx"> n </em> log( <em class="nx"> n </em>)，<em class="nx"> n </em>是源和目标之间的最大维度。在我们的例子中，<em class="nx"> n </em>很小，所以可以使用 EMD，但是对于更大的<em class="nx"> n </em>值，我们可能需要考虑其他选项。</p><p id="ee77" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当一个算法的计算时间很长时，我们可以将其正则化，以获得一个更简单或更快的问题的解决方案。Sinkhorn 算法通过添加熵正则化项来实现这一点，从而解决了以下问题。</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi oc"><img src="../Images/528046cb89dc6261b2180b31b85ca29e.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*zzSg43MT77t05mEyOLbATw.png"/></div></div></figure><p id="f674" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中<em class="nx"> reg </em>是超参数，<em class="nx"> Omega </em>是熵正则项，定义如下:</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div class="gh gi od"><img src="../Images/939ccd1fd644c954707f92e549bfc8eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:398/format:webp/1*my5Y1l51E5cEbeklafF6LQ.png"/></div></figure><p id="b536" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Sinkhorn 算法的编码非常简单。您可以使用以下伪代码直接实现它:</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/50a4a277d684065da068b2065bbfb25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*6a59ZHlhTim4ozJYvoAhYg.png"/></div></figure><p id="59a4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">小心数字问题。Sinkhorn 的一个好的预处理是用成本矩阵<code class="fe nc nd ne lk b">M</code>除以它的最大值。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="ef7f" class="lo lp it lk b gy lq lr l ls lt">reg = 0.1<br/>K = np.exp(-M / M.max() / reg)<br/>nit = 100<br/>u = np.ones((len(bakery_prod), ))<br/>for i in range(1, nit):<br/>    v = cafe_prod / np.dot(K.T, u)<br/>    u = bakery_prod / (np.dot(K, v))<br/>gamma_sink_algo = np.atleast_2d(u).T * (K * v.T)  # Equivalent to np.dot(np.diag(u), np.dot(K, np.diag(v)))</span></pre><p id="a04e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一种方法是使用带有<a class="ae le" href="https://pythonot.github.io/all.html#ot.sinkhorn" rel="noopener ugc nofollow" target="_blank"> ot.sinkhorn </a>的 POT 工具箱:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="8524" class="lo lp it lk b gy lq lr l ls lt">gamma_sinkhorn = ot.sinkhorn(bakery_prod, cafe_prod, reg=reg, M=M/M.max())</span></pre><blockquote class="nu nv nw"><p id="693e" class="ki kj nx kk b kl km ju kn ko kp jx kq ny ks kt ku nz kw kx ky oa la lb lc ld im bi translated">当绘制最终的运输矩阵时，我们马上注意到，使用 Sinkhorn，它一点也不稀疏，每个面包店都使用该解决方案向所有 5 家咖啡馆运送羊角面包。此外，这个解决方案给出了分数的传输，这在羊角面包的情况下没有意义。EMD 的情况并非如此。</p></blockquote><figure class="lf lg lh li gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi of"><img src="../Images/4dc8226bf310e1053415dbbf5094eadd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_OF_MKVBaK6th89QgGvTg.png"/></div></div><p class="np nq gj gh gi nr ns bd b be z dk translated">带 Sinkhorn 的正则化最优运输</p></figure><h2 id="470e" class="lo lp it bd lv ml mm dn lz mn mo dp md kr mp mq mf kv mr ms mh kz mt mu mj mv bi translated">改变 Sinkhorn 中的正则化参数</h2><p id="e0df" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">显然，新疆的正则化超参数<em class="nx"> reg </em>起着重要的作用。让我们通过下面的图表，从不同的值来看它是如何影响运输矩阵的。</p><figure class="lf lg lh li gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi og"><img src="../Images/5d205ccbe266e7b7f0ba027a4f7dc52f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O_D_HlXq9nhnTwslGldQtw.png"/></div></div><p class="np nq gj gh gi nr ns bd b be z dk translated">reg 对运输矩阵的影响</p></figure><p id="1798" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一系列图表显示，对于非常小的正则化参数值<code class="fe nc nd ne lk b">reg</code>，Sinkhorn 的解开始于非常类似于 EMD 的东西(尽管不是稀疏的),并且随着<code class="fe nc nd ne lk b">reg</code>的增加而趋向于更一致的解。</p><h1 id="55d9" class="lu lp it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">结论</h1><p id="d968" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">第一部分展示了一个使用 POT 库应用优化传输的简单示例。正如 Ievgen Redko 在<a class="ae le" rel="noopener" target="_blank" href="/hands-on-guide-to-python-optimal-transport-toolbox-part-2-783029a1f062">第二部分中所讨论的，最优运输是一个可以在许多方面应用的强大工具。</a></p></div></div>    
</body>
</html>