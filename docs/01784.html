<html>
<head>
<title>Pairs Check Implementation on Quantopian</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Quantopian上的Pairs校验实现</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pairs-check-implementation-on-quantopian-3b10f4e06a34?source=collection_archive---------30-----------------------#2020-02-18">https://towardsdatascience.com/pairs-check-implementation-on-quantopian-3b10f4e06a34?source=collection_archive---------30-----------------------#2020-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="475a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">两种证券的协整研究及配对检验交易策略的实施。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47709be0a640d26a8faa6bd7cf2378e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uu7RvVD6GdSvUhES"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">克里斯·利维拉尼在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6c22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">算法交易包括使用交易指令自动执行股票市场中的订单。这些指令是设计用于检测模式并将其用作执行操作的触发器的程序。这种技术利用了计算机相对于人类交易者的速度和情感。</p><p id="74ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章展示了如何在Quantopian上实现一个叫做Pairs Check的算法交易策略。</p><p id="92a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了实现这一目标，我们将这篇文章分成5个部分:</p><ol class=""><li id="0a01" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">结对检查，效果如何？</strong></li><li id="f30e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">分析股票对:CNQ和PXD </strong></li><li id="b4f3" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">quanto pian上的代码实现</strong></li><li id="a094" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">回溯测试策略</strong></li><li id="8eca" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">结论</strong></li></ol><h1 id="a8d8" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">配对检查，它是如何工作的？</h1><p id="5ef8" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">配对交易是一种独立于市场条件(上升趋势、下降趋势或横向运动)的市场交易策略，几乎在任何情况下都可以获得正回报。这种策略被归类为统计套利和集中交易策略。它的算法实现允许交易者在人类交易者有机会调整市场之前利用市场的低效率。</p><p id="698e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Pairs Check监控两种历史上共同整合的证券的价差。协整背后的直觉可以用一个人遛狗的类比来说明。它们一起移动，它们之间的距离受到皮带长度的限制。在行走过程中，皮带会拉伸和放松，但大多数时候距离在这两个极端之间。</p><p id="442f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当两只股票之间的价差暂时增大时，例如一只股票上涨，而另一只股票下跌，配对交易将是做空表现出色的股票，做多表现不佳的股票，押注价格差异将会收敛。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/f7c7aad6149ad79a0a46e02fad18ff96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uAbvez2C8AyoHTZaZAVdjw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">两种证券之间的正常差价。</p></figure><p id="2039" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上图中，我们可以看到两个共同整合证券之间的标准化利差。每当当前价差高于1.2或低于-1.2时，算法就会下单做空价格过高的股票，做多价格过低的股票。</p><h1 id="83f0" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">分析股票对:CNQ和PXD</h1><p id="a422" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">在我们的案例研究中，我们将分析CNQ(加拿大自然资源公司)和PXD(先锋自然资源公司)之间的关系。我们将使用<strong class="ky ir">stats models . TSA . stat tools</strong>中的<strong class="ky ir"> coint </strong>函数来测试协同集成。</p><p id="48b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用的软件包有:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="e0bc" class="nj mh iq nf b gy nk nl l nm nn">import statsmodels.tsa.stattools as sts<br/>import pandas as pd<br/>import numpy as np<br/>import yfinance<br/>import matplotlib.pyplot as plt</span></pre><p id="0667" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后导入数据:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="e431" class="nj mh iq nf b gy nk nl l nm nn"><em class="no"># importing data</em><br/>co1 = 'CNQ'<br/>co2 = 'PXD'<br/>tickers = co1 + " " + co2<br/>raw_data = yfinance.download (tickers = tickers, interval = '1d', group_by = 'ticker',auto_adjust = <strong class="nf ir">True</strong>, treads = <strong class="nf ir">True</strong>)</span></pre><p id="d671" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并为分析做准备:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="f0cb" class="nj mh iq nf b gy nk nl l nm nn"><em class="no"># defining interval for analysis</em><br/>start = '2014-01-01'<br/>end = '2016-06-01'</span><span id="b2ac" class="nj mh iq nf b gy np nl l nm nn">cnq = pd.DataFrame(raw_data[co1][start:end].Close)<br/>pxd = pd.DataFrame(raw_data[co2][start:end].Close)</span><span id="a418" class="nj mh iq nf b gy np nl l nm nn"><em class="no"># filling data gaps</em><br/>cnq = cnq.fillna(method = 'bfill')<br/>pxd = pxd.fillna(method = 'bfill')</span><span id="b0c4" class="nj mh iq nf b gy np nl l nm nn"><em class="no"># renaming columns</em><br/>cnq = cnq.rename(columns = {'Close': 'CNQ'})<br/>pxd = pxd.rename(columns = {'Close': 'PXD'})</span><span id="6e1e" class="nj mh iq nf b gy np nl l nm nn"><em class="no"># normalizing data</em><br/>cnq = cnq.apply(<strong class="nf ir">lambda</strong> x: (x-x.min())/(x.max()-x.min()))<br/>pxd = pxd.apply(<strong class="nf ir">lambda</strong> x: (x-x.min())/(x.max()-x.min()))</span><span id="1858" class="nj mh iq nf b gy np nl l nm nn"><em class="no"># charting prices</em><br/>chart = pd.concat([cnq, pxd], axis = 1)<br/>chart['CNQ'].plot(figsize = (20,8), color = 'blue')<br/>chart['PXD'].plot()<br/>plt.title('CNQ vs PXD closing prices', size = 24)<br/>plt.legend()<br/>plt.plot()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/e0bd8aabb78db0184500e8c60a843f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsAzuH1kmJPwgMnLV1Gm2A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">股票对的标准化价格</p></figure><p id="4c52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们运行协整检验:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="aa53" class="nj mh iq nf b gy nk nl l nm nn"><em class="no"># co-integration test</em><br/>sts.coint(cnq, pxd)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/170075350df64142ed61bc0418a96aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jjptbz-NsCMSd0hXL_Djsw.png"/></div></div></figure><p id="717e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<strong class="ky ir"> coint </strong>测试中的零假设是两个时间序列没有协整。</p><p id="02e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，从2014年到2016年，CNQ和PDX高度协整，p值为0.0012，这使得这对夫妇成为我们算法的完美候选人。</p><h1 id="dcc1" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">量子乌托邦上的代码实现</h1><p id="f7c1" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">下面的代码是在Quantopian IDE上实现的。时间表功能每天在市场关闭前60分钟运行程序。阈值根据经验定义为+-1.2。改变这些值可以改变策略的回报。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="d0a2" class="nj mh iq nf b gy nk nl l nm nn">import numpy as np</span><span id="cc1e" class="nj mh iq nf b gy np nl l nm nn">def initialize(context):<br/>    schedule_function(check_pairs, date_rules.every_day(), time_rules.market_close(minutes=60))<br/>        <br/>    # Canadian Natural Resources<br/>    context.cnq = sid(21735)<br/>    <br/>    # Pioneer Natural Resources Company<br/>    context.pxd = sid(17436)<br/>    <br/>    context.long_on_spread = False<br/>    context.shorting_spread = False<br/>    <br/>    <br/>def check_pairs(context, data):<br/>    cnq = context.cnq<br/>    pxd = context.pxd<br/>    <br/>    prices = data.history([cnq, pxd], 'price', 30, '1d')<br/>    <br/>    short_prices = prices.iloc[-1:]<br/>    <br/>    # Spread<br/>    mavg_30 = np.mean(prices[cnq] - prices[pxd])<br/>    std_30 = np.std(prices[cnq] - prices[pxd])<br/>    mavg_1 = np.mean(short_prices[cnq] - short_prices[pxd])<br/>    <br/>    if std_30 &gt; 0:<br/>        zscore = (mavg_1 - mavg_30) / std_30<br/>        <br/>        # Spread = CNQ - PXD<br/>        if zscore &gt; 1.2 and not context.shorting_spread:<br/>            order_target_percent(cnq, -0.5) <br/>            order_target_percent(pxd, 0.5) <br/>            context.shorting_spread = True<br/>            context.long_on_spread = False<br/>            <br/>        elif zscore &lt; 1.2 and not context.long_on_spread:<br/>            order_target_percent(cnq, 0.5) <br/>            order_target_percent(pxd, -0.5) <br/>            context.shorting_spread = False<br/>            context.long_on_spread = True<br/>            <br/>        elif abs(zscore) &lt; 0.1:<br/>            order_target_percent(cnq, 0)<br/>            order_target_percent(pxd, 0)<br/>            context.shorting_spread = False<br/>            context.long_on_spread = False<br/>                <br/>        record(Z_score = zscore)</span></pre><h1 id="cdcd" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">回溯测试策略</h1><p id="8b17" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">下面我们可以看到配对检查策略的回溯测试结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/8960b03e8799bc04580da83ea697be56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0owWSSJNSsqK4b37rMbxRA.png"/></div></div></figure><p id="fbb8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回报明显好于SPY基准，但夏普比率和提款可能会有所改善。</p><h1 id="2344" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">结论</h1><p id="d42e" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果这么简单，为什么不是每个人都用支票赚钱呢？嗯，共同整合的股票是独角兽，找到它们并不是一件容易的事情。除此之外，两种证券之间的共同整合可能会随着时间的推移而发生变化，原因有几个:管理和监管变化、客户基础多样化、新技术…</p><p id="cc9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回溯测试结果显示了优于SPY基准的回报，但是夏普比率和提取可以改进。</p><p id="eca5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你喜欢这篇文章，我很想听听你关于如何改进这段代码的想法。</p><p id="e01b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="no">来自《走向数据科学》编辑的提示:</em> </strong> <em class="no">虽然我们允许独立作者根据我们的</em> <a class="ae kv" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="no">规则和指导方针</em> </a> <em class="no">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae kv" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="no">读者术语</em> </a> <em class="no">。</em></p></div></div>    
</body>
</html>