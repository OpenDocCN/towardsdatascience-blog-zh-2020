<html>
<head>
<title>Getting Started with Data Analysis on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS数据分析入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-data-analysis-on-aws-7b74ecbfe572?source=collection_archive---------14-----------------------#2020-01-10">https://towardsdatascience.com/getting-started-with-data-analysis-on-aws-7b74ecbfe572?source=collection_archive---------14-----------------------#2020-01-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5bef" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用AWS Glue、Amazon Athena和Amazon QuickSight来转换、丰富、分析和可视化半结构化数据。</h2></div><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="kn ko l"/></div><p class="kp kq gj gh gi kr ks bd b be z dk translated">帖子的音频介绍</p></figure><h1 id="b944" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">介绍</h1><p id="06c5" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">根据<a class="ae mh" href="https://en.wikipedia.org/wiki/Data_analysis" rel="noopener ugc nofollow" target="_blank">维基百科</a>的说法，数据分析是"<em class="mi">一个检查、清理、转换和建模数据的过程，目的是发现有用的信息，告知结论，并支持决策。</em>“在这篇文章中，我们将探索如何开始在AWS上进行数据分析，使用亚马逊Athena、AWS Glue、亚马逊QuickSight、亚马逊S3和AWS Lambda的无服务器功能。我们将学习如何使用这些补充服务来转换、丰富、分析和可视化半结构化数据。</p><blockquote class="mj mk ml"><p id="ff41" class="ll lm mi ln b lo mm ju lq lr mn jx lt mo mp lw lx mq mr ma mb ms mt me mf mg im bi translated">数据分析——发现有用的信息，提供结论，支持决策。–维基百科</p></blockquote><p id="7dec" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">我们将学习如何使用亚马逊S3、AWS Glue、亚马逊Athena和AWS Lambda以多种格式接收、转换和丰富原始的半结构化数据。我们将构建一个基于S3的数据湖，并了解AWS如何利用开源技术，如Presto、Apache Hive和Apache Parquet。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="mu ko l"/></div></figure><p id="b09d" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">亚马逊<a class="ae mh" href="https://aws.amazon.com/about-aws/whats-new/2019/11/amazon-quicksight-adds-api-support-for-data-dashboard-spice-and-permissions/" rel="noopener ugc nofollow" target="_blank">最近增加了</a>全套<code class="fe mv mw mx my b">aws quicksight</code>API，用于与QuickSight交互。然而，对于演示的最后一部分，我们将从亚马逊QuickSight控制台进行操作，而不是AWS CLI、AWS CDK或CloudFormation模板。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="mu ko l"/></div></figure><h1 id="d56d" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">示范</h1><p id="2b85" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在本次演示中，我们将扮演一家美国大型电力供应商的角色。这家能源提供商开发了其下一代智能电力监控中心(Smart Hub)。他们已经向美国的大量居民客户出售了智能集线器。这个假想的智能集线器通过无线方式从分散在住宅各处的单个智能电源插座和电路仪表中收集详细的用电数据。电力使用数据经过加密，并安全地从客户的智能枢纽传输到电力供应商，后者在AWS上开展业务。</p><p id="5460" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">客户能够以精细的粒度、每台设备和一段时间来分析他们的用电情况。智能集线器的目标是使客户能够利用数据降低电力成本。由于客户将使用转移到非高峰时间以节省资金，该提供商受益于现有电网上负载的减少和每日电力负载的更好分配。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/02de8340f77c78eaf422badd165fcd86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qQfPAxhlM7jeicTg.png"/></div></div><p class="kp kq gj gh gi kr ks bd b be z dk translated"><em class="ng">亚马逊QuickSight中post的数据预览。</em></p></figure><p id="d24f" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">这篇文章将关注数据分析，而不是数据捕获的实时流方面或数据如何在AWS上持久化。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/aa421e2474ec5071d23d32ceb2a55d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-H0h2GdZjC3_muET.png"/></div></div><p class="kp kq gj gh gi kr ks bd b be z dk translated"><em class="ng">演示的高级AWS架构图。</em></p></figure><h1 id="97e5" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">特色技术</h1><p id="2ab5" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">以下AWS服务和开源技术是这篇文章的重点。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ni"><img src="../Images/906c71dbd0664d38ca133868e7e24a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/0*8ait-BzoNywnwzry.png"/></div></div></figure><h2 id="bd90" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">基于亚马逊S3的数据湖</h2><p id="22eb" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">一个<a class="ae mh" href="https://docs.aws.amazon.com/whitepapers/latest/building-data-lakes/amazon-s3-data-lake-storage-platform.html" rel="noopener ugc nofollow" target="_blank">基于亚马逊S3的数据湖</a>使用亚马逊S3作为其主要存储平台。亚马逊S3为数据湖提供了一个最佳的基础，因为它具有几乎无限的可扩展性，从千兆字节到千兆字节的内容。亚马逊S3提供“11个9”(99.999999999%)的耐用性。它具有可扩展的性能、易于使用的特性以及本机加密和访问控制功能。</p><h2 id="312c" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS胶水</h2><p id="e2a7" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated"><a class="ae mh" href="https://aws.amazon.com/glue/" rel="noopener ugc nofollow" target="_blank"> AWS Glue </a>是一个完全托管的提取、转换和加载(ETL)服务，用于准备和加载数据进行分析。AWS Glue发现您的数据，并将关联的元数据(例如，表定义和模式)存储在AWS Glue数据目录中。一旦编目，您的数据就可以立即被搜索、查询和用于ETL。</p><h2 id="b7e3" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS粘合数据目录</h2><p id="c06f" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated"><a class="ae mh" href="https://aws.amazon.com/glue/faqs/#AWS_Glue_Data_Catalog" rel="noopener ugc nofollow" target="_blank"> AWS粘合数据目录</a>是一个<a class="ae mh" href="https://hive.apache.org/index.html" rel="noopener ugc nofollow" target="_blank"> Apache Hive </a> Metastore兼容的中央存储库，用于存储数据资产的结构和操作元数据。对于给定的数据集，存储表定义、物理位置、添加与业务相关的属性，以及跟踪数据随时间的变化。</p><h2 id="f70c" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS胶水爬行器</h2><p id="da1b" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">一个<a class="ae mh" href="https://aws.amazon.com/glue/faqs/" rel="noopener ugc nofollow" target="_blank"> AWS Glue Crawler </a>连接到一个数据存储，通过一个优先的分类器列表提取数据和其他统计数据的模式，然后用这些元数据填充Glue数据目录。爬网程序可以定期运行，以检测新数据的可用性以及对现有数据的更改，包括表定义的更改。爬网程序会自动添加新表、现有表的新分区以及新版本的表定义。你甚至可以定制胶水爬虫来分类你自己的文件类型。</p><h2 id="30be" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS粘合ETL作业</h2><p id="f592" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">AWS Glue ETL作业是在AWS Glue中执行提取、转换和加载(ETL)工作的业务逻辑。当您启动一个作业时，AWS Glue运行一个脚本，该脚本从源中提取数据，转换数据，并将其加载到目标中。AWS Glue生成PySpark或Scala脚本，运行在Apache Spark上。</p><h2 id="5d43" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">亚马逊雅典娜</h2><p id="a080" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated"><a class="ae mh" href="https://aws.amazon.com/athena/" rel="noopener ugc nofollow" target="_blank"> Amazon Athena </a>是一种交互式查询服务，使用标准SQL可以轻松分析亚马逊S3的数据。Athena支持并使用各种标准数据格式，包括CSV、JSON、Apache ORC、Apache Avro和Apache Parquet。Athena集成了现成的AWS粘合数据目录。Athena是无服务器的，所以不需要管理基础设施，您只需为运行的查询付费。</p><p id="0016" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">亚马逊Athena背后的底层技术是<a class="ae mh" href="https://prestodb.io/" rel="noopener ugc nofollow" target="_blank"> Presto </a>，这是由脸书创建的用于大数据的开源分布式SQL查询引擎。根据AWS，Athena查询引擎基于<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/DocHistory.html" rel="noopener ugc nofollow" target="_blank">Presto 0.172</a>(2017年4月9日发布)。除了Presto之外，Athena还使用<a class="ae mh" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL" rel="noopener ugc nofollow" target="_blank"> Apache Hive </a> DDL来定义表。</p><h2 id="2d91" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">亚马逊QuickSight</h2><p id="c956" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated"><a class="ae mh" href="https://aws.amazon.com/quicksight/" rel="noopener ugc nofollow" target="_blank"> Amazon QuickSight </a>是一项完全托管的商业智能(BI)服务。QuickSight允许您创建和发布包含<a class="ae mh" href="https://aws.amazon.com/quicksight/features-ml/" rel="noopener ugc nofollow" target="_blank"> ML Insights </a>的交互式仪表盘。仪表板可以从任何设备访问，并嵌入到您的应用程序、门户和网站中。QuickSight无需服务器即可自动从数十名用户扩展到数万名用户，无需任何基础架构管理。</p><h2 id="e48f" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">自动气象站λ</h2><p id="6f3f" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated"><a class="ae mh" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>自动运行代码，无需配置或管理服务器。AWS Lambda通过运行代码来响应触发器，从而自动扩展应用程序。Lambda代码并行运行。有了AWS Lambda，您的代码每执行100毫秒就要付费，代码被触发的次数也是如此。您只需为消耗的计算时间付费。</p><h1 id="9159" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">智能枢纽数据</h1><p id="d454" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">这篇文章中的一切都围绕着数据。为了这篇文章的演示，我们将从四类原始的合成数据开始。这些数据类别包括智能集线器用电数据、智能集线器传感器映射数据、智能集线器住宅位置数据和电费数据。为了展示AWS Glue处理多种数据格式的能力，四类原始数据由三种不同的文件格式组成:XML、JSON和CSV。我试图将尽可能多的“真实世界”的复杂性融入到数据中，同时又不忽略这篇文章的主题。样本数据集故意很小，以使您的AWS成本在演示中保持最低。</p><p id="6249" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">为了进一步降低成本，我们将使用多种数据分区方案。根据<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/partitions.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>的说法，通过对你的数据进行分区，可以限制每次查询扫描的数据量，从而提高性能，降低成本。我们只有很少的数据用于演示，在这种情况下，分区可能会对查询性能产生负面影响。然而，在“真实世界”的场景中，将会有数百万潜在的住宅用户产生万亿字节的数据。在这种情况下，数据分区对于成本和性能都是至关重要的。</p><h2 id="d2c7" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">智能集线器用电数据</h2><p id="f5be" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">Smart Hub的时序用电数据是从客户的Smart Hub中收集的。在演示的示例用电数据中，每一行代表完全任意的五分钟时间间隔。总共有十个电传感器，其用电量以千瓦小时(kW)为单位进行记录和传输。每个智能集线器记录并传输10个设备传感器的用电量，每天288次(24小时/ 5分钟间隔)，每个智能集线器每天总共2，880个数据点。该演示有两天的使用数据，总共有5，760个数据点。数据以<a class="ae mh" href="http://jsonlines.org/" rel="noopener ugc nofollow" target="_blank"> JSON行</a>格式存储。使用数据将按照日期(例如，“dt = 2019–12–21”)在基于亚马逊S3的数据湖中进行分区。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="a2a6" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">请注意，用电数据包含嵌套数据。十个传感器中的每一个传感器的用电量都包含在JSON数组中的每个时间序列条目中。该数组包含十个double类型的数值。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="bf89" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">真实数据通常很复杂，而且嵌套很深。在这篇文章的后面，我们将看到AWS Glue可以映射许多常见的数据类型，包括嵌套的数据对象，如下图所示。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/e339410b728823bd08b07ae0192fade7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vtgv0tV4ZGiEfFNw.png"/></div></div></figure><h2 id="a1e7" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">智能集线器传感器映射</h2><p id="1842" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">智能集线器传感器映射数据将使用数据中的传感器列(例如“s_01”)映射到相应的实际设备(例如“中央空调”)。该数据包含设备位置、瓦特数和上次修改记录的时间。数据也以<a class="ae mh" href="http://jsonlines.org/" rel="noopener ugc nofollow" target="_blank"> JSON行</a>格式存储。传感器映射数据将在基于亚马逊S3的数据湖中按照居住的州进行划分(例如，俄勒冈州的“state=or”)。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="b66b" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">智能枢纽位置</h2><p id="4047" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">智能中心位置数据包含每个住宅智能中心的地理空间坐标、家庭地址和时区。数据以CSV格式存储。本次演示中包含的四个城市的数据来自<a class="ae mh" href="https://openaddresses.io/" rel="noopener ugc nofollow" target="_blank"> OpenAddresses </a>、<em class="mi">免费开放的全球地址收集。</em>‘大概有4k的位置记录。位置数据将在基于亚马逊S3的数据湖中按照安装智能中心的居住州进行划分(例如，俄勒冈州的“state=or”)。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="190a" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">电费</h2><p id="3668" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">最后，电价数据包含电费。在本演示中，假设汇率因州、月份和一天中的小时而异。数据存储在XML中，这种数据导出格式在旧的遗留系统中仍然很常见。电价数据不会在基于亚马逊S3的数据湖中被分割。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h1 id="a296" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">数据分析过程</h1><p id="8135" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">由于演示中的数据分析过程涉及的步骤很多，我将该过程分为四个逻辑阶段:1)原始数据接收，2)数据转换，3)数据丰富，以及4)数据可视化和商业智能(BI)。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nw"><img src="../Images/2d712586f1de34e3aa5d9ec784d9bb9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ljser6CiiZV5CiyW.png"/></div></div><p class="kp kq gj gh gi kr ks bd b be z dk translated"><em class="ng">全数据分析工作流程图(点击放大…) </em></p></figure><h2 id="cb8b" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">原始数据摄取</h2><p id="901c" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在原始数据接收阶段，半结构化CSV、XML和JSON格式的数据文件被复制到一个安全的<a class="ae mh" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">亚马逊简单存储服务</a> (S3)桶中。在存储桶中，数据文件根据其物理数据结构(模式)组织到文件夹中。由于数据文件的数量可能没有限制，文件被进一步组织(分区)到子文件夹中。数据文件的组织策略基于日期、时间、地理位置、客户id或其他常见的数据特征。</p><p id="8f8d" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">这种半结构化数据文件、S3桶和分区的集合形成了所谓的数据湖。根据AWS的说法，数据湖是一个集中式存储库，允许您存储任何规模的所有结构化和非结构化数据。</p><p id="ce3f" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">一系列的<a class="ae mh" href="https://docs.aws.amazon.com/glue/latest/dg/add-crawler.html" rel="noopener ugc nofollow" target="_blank"> AWS胶合爬虫</a>处理原始的CSV-、XML-和JSON-格式文件，提取元数据并在<a class="ae mh" href="https://docs.aws.amazon.com/glue/latest/dg/populate-data-catalog.html" rel="noopener ugc nofollow" target="_blank"> AWS胶合数据目录</a>中创建表定义。根据AWS，AWS Glue数据目录包含元数据表，其中每个表指定一个数据存储。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nx"><img src="../Images/7aa1b281614fad3cf1ebe0246fc5312d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N3-EBxiz56xm-EeX.png"/></div></div></figure><h2 id="3804" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">数据转换</h2><p id="274e" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在数据转换阶段，转换前一阶段的原始数据。数据转换可以包括修改数据和改变数据格式。数据修改包括数据清理、重新转换数据类型、更改日期格式、字段级计算和字段连接。</p><p id="4365" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">然后，数据从CSV、XML和JSON格式转换成<a class="ae mh" href="https://parquet.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Parquet </a>格式，并写回到基于亚马逊S3的数据湖。Apache Parquet是一种压缩的、高效的列存储格式。和许多基于云的服务一样，Amazon Athena按每次查询扫描的数据量收费。因此，使用数据分区、分桶、压缩和列存储格式(如Parquet)将降低查询成本。</p><p id="8d81" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">最后，将转换后的Parquet格式数据编目到新的表中，与原始的CSV、XML和JSON数据放在一起，放在Glue数据目录中。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nx"><img src="../Images/fce73fe3537d7ec47ec834626dfb8ed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Bl0VeBoFDT3X1U-L.png"/></div></div></figure><h2 id="b19f" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">数据丰富</h2><p id="e749" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">根据<a class="ae mh" href="https://www.sciencedirect.com/topics/computer-science/data-enrichment" rel="noopener ugc nofollow" target="_blank"> ScienceDirect </a>的说法，数据丰富或扩充是通过补充缺失或不完整的数据来增强现有信息的过程。通常，数据丰富是通过使用外部数据源实现的，但情况并非总是如此。</p><blockquote class="mj mk ml"><p id="1cb7" class="ll lm mi ln b lo mm ju lq lr mn jx lt mo mp lw lx mq mr ma mb ms mt me mf mg im bi translated"><em class="it">数据丰富——通过补充缺失或不完整的数据来增强现有信息的过程。–科学指导</em></p></blockquote><p id="0f59" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">在数据丰富阶段，Parquet格式的Smart Hub使用数据会增加来自其他三个数据源的相关数据:传感器映射、位置和电费。基于客户的地理位置和一天中的时间，客户的Smart Hub使用数据丰富了客户的设备类型、客户的时区以及每个监控期的客户电力成本。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ny"><img src="../Images/2a48a5d26c27f1bd37df29496c7f9d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Pk96G28MVx15XM-R.png"/></div></div></figure><p id="d5cb" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">一旦数据得到丰富，它就被转换成Parquet并针对查询性能进行优化，存储在数据湖中，并被编目。此时，原始的CSV、XML和JSON格式的原始数据文件、转换后的Parquet格式的数据文件和Parquet格式的丰富数据文件都存储在基于亚马逊S3的数据湖中，并在Glue数据目录中编目。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nz"><img src="../Images/a8855e6f0cedce7f0c6789ce0046d543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H9dESc2pKvN21ioL.png"/></div></div></figure><h2 id="4415" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">数据可视化和商业智能</h2><p id="eb7d" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在最后的数据可视化和商业智能(BI)阶段，呈现和分析丰富的数据。有许多企业级服务可用于可视化和商业智能，它们与Athena集成。亚马逊服务包括<a class="ae mh" href="https://aws.amazon.com/quicksight/" rel="noopener ugc nofollow" target="_blank">亚马逊QuickSight </a>、<a class="ae mh" href="https://aws.amazon.com/emr/" rel="noopener ugc nofollow" target="_blank">亚马逊EMR </a>、<a class="ae mh" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker </a>。来自AWS合作伙伴的第三方解决方案可在<a class="ae mh" href="https://aws.amazon.com/marketplace" rel="noopener ugc nofollow" target="_blank"> AWS Marketplace </a>上获得，包括<a class="ae mh" href="https://aws.amazon.com/marketplace/seller-profile?id=0ef849c5-c2fa-4699-9f67-c47555e148a5&amp;ref=dtl_prodview-f4r47zzmas57k" rel="noopener ugc nofollow" target="_blank"> Tableau </a>、<a class="ae mh" href="https://aws.amazon.com/marketplace/seller-profile?id=f2b415a2-1013-4f3f-ba68-ad1895504098" rel="noopener ugc nofollow" target="_blank"> Looker </a>、<a class="ae mh" href="https://aws.amazon.com/marketplace/seller-profile?id=b9a3a7ee-d8b2-4322-a03a-eec7853e8610" rel="noopener ugc nofollow" target="_blank"> Sisense </a>和<a class="ae mh" href="https://aws.amazon.com/marketplace/seller-profile?id=7b1d10b8-b3fc-469e-a33d-d5bcc84caba9" rel="noopener ugc nofollow" target="_blank"> Domo </a>。在本次演示中，我们将重点介绍Amazon QuickSight。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/3b3793a192a360fc81f36b3e9197512a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/0*eFhXROxRY3TFyYn7.png"/></div></figure><h1 id="f039" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">入门指南</h1><h2 id="d2c5" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">要求</h2><p id="1c7d" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">为了进行演示，您需要一个AWS帐户和当前版本的<a class="ae mh" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>。为了从演示中获得最大收益，您还应该在您的工作环境中安装<a class="ae mh" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank"> Python 3 </a>和<a class="ae mh" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>。</p><h2 id="8998" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">源代码</h2><p id="6214" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">这篇文章的所有源代码可以在<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>找到。使用以下命令克隆项目的副本。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="efca" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">本文中的源代码示例显示为GitHub <a class="ae mh" href="https://help.github.com/articles/about-gists/" rel="noopener ugc nofollow" target="_blank"> Gists </a>，在一些移动和社交媒体浏览器上无法正确显示。</p><h2 id="a2c7" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">TL；博士？</h2><p id="e3a2" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">不看说明书就想跳进去？这篇文章中的所有AWS CLI命令都整合在GitHub项目的README文件中。</p><h2 id="7097" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">云形成堆栈</h2><p id="2364" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">首先，使用<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/cloudformation/smart-hub-athena-glue.yml" rel="noopener ugc nofollow" target="_blank">smart-hub-Athena-glue . yml</a>模板创建“smart-hub-Athena-glue-stack”cloud formation堆栈。该模板将创建(3)亚马逊S3桶，(1) AWS胶水数据目录数据库，(5)数据目录数据库表，(6) AWS胶水爬虫，(1) AWS胶水ETL作业，以及(1)AWS胶水IAM服务角色。</p><p id="bf6a" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">首先，确保将<code class="fe mv mw mx my b">DATA_BUCKET</code>、<code class="fe mv mw mx my b">SCRIPT_BUCKET</code>和<code class="fe mv mw mx my b">LOG_BUCKET</code>变量更改为您自己唯一的S3存储桶名称。我总是建议使用标准的AWS三部分约定来命名您的存储桶(例如，“smart-hub-data-123456789012-us-east-1”)。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="a061" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">原始数据文件</h2><p id="2cf8" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">接下来，将原始的CSV、XML和JSON格式的数据文件从本地项目复制到<code class="fe mv mw mx my b">DATA_BUCKET</code> S3存储桶中( <a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">中的<em class="mi">步骤1a-1b)工作流程图</em> </em></a>)。这些文件代表了S3数据湖的开端。每一类数据都使用不同的策略来组织和分离文件。注意使用了<a class="ae mh" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-AlterPartition" rel="noopener ugc nofollow" target="_blank"> Apache Hive风格的分区</a>(例如<code class="fe mv mw mx my b">/smart_hub_data_json/<strong class="ln iu">dt=2019-12-21</strong></code>)。如前所述，假设数据湖中实际的大量数据需要使用分区来提高查询性能。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="3b71" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">用以下命令确认<code class="fe mv mw mx my b">DATA_BUCKET</code> S3桶的内容。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="e84a" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">在<code class="fe mv mw mx my b">DATA_BUCKET</code> S3桶中应该总共有(14)个原始数据文件。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="db95" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">λ函数</h2><p id="bde0" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">接下来，打包(5)基于Python3.8的AWS Lambda函数进行部署。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="c3d6" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">将五个Lambda包复制到<code class="fe mv mw mx my b">SCRIPT_BUCKET</code> S3桶中。第二个CloudFormation堆栈<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/cloudformation/smart-hub-lambda.yml" rel="noopener ugc nofollow" target="_blank"> smart-hub-serverless </a>访问<a class="ae mh" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html" rel="noopener ugc nofollow" target="_blank"> ZIP存档Lambda包</a>。如果在<code class="fe mv mw mx my b">SCRIPT_BUCKET</code> S3桶中没有找到包，这个创建Lambda函数的CloudFormation栈将无法部署。</p><p id="0772" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">我选择将包放在不同的S3桶中，然后是原始数据文件。在真实的生产环境中，出于安全考虑，这两种类型的文件至少会被分隔到不同的存储桶中。请记住，只有数据应该进入数据湖。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="2341" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">使用<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/cloudformation/smart-hub-lambda.yml" rel="noopener ugc nofollow" target="_blank">smart-hub-lambda . yml</a>cloud formation模板创建第二个“smart-hub-lambda-stack”cloud formation堆栈。该模板将创建(5) AWS Lambda函数和(1) <a class="ae mh" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html" rel="noopener ugc nofollow" target="_blank"> Lambda执行IAM服务角色</a>。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="0c8a" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">此时，我们已经使用CloudFormation部署了演示所需的所有AWS资源。我们还复制了亚马逊S3数据湖中所有原始的CSV、XML和JSON格式的数据文件。</p><h2 id="3e08" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS胶水爬行器</h2><p id="7729" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">如果您还记得，我们在Glue Data Catalog数据库中创建了五个表，作为CloudFormation堆栈的一部分。四种原始数据类型各有一个表，一个表用于保存稍后演示中的临时ELT数据。要确认这五个表是在粘合数据目录数据库中创建的，请使用粘合数据目录控制台，或者运行以下AWS CLI / jq命令。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="7116" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">五个数据目录表应该如下所示。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="92bd" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">我们还创建了六个Glue爬虫作为CloudFormation模板的一部分。其中四个爬虫负责将来自S3的原始CSV、XML和JSON格式的数据编目到相应的现有Glue Data Catalog数据库表中。爬行器将检测任何新的分区，并将它们添加到表中。每个爬虫对应于四种原始数据类型中的一种。爬虫可以被<a class="ae mh" href="https://docs.aws.amazon.com/glue/latest/dg/schedule-crawler.html" rel="noopener ugc nofollow" target="_blank">调度</a>定期运行，编目新数据并更新数据分区。爬虫还会创建一个数据目录数据库表。我们使用爬虫来创建新的表格，稍后在文章中。</p><p id="c68f" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">使用AWS CLI运行四个胶水爬行器( <a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">工作流程图</em> </a>中的<em class="mi">步骤1c)。</em></p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="dbda" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">您可以检查Glue Crawler控制台，以确保四个Crawler成功完成。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/04b0c7419384933b6d5529aec0d26d22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pAvC3uqeI1ypl9hK.png"/></div></div></figure><p id="ae67" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">或者，使用另一个AWS CLI / jq命令。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="24c2" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">完成后，所有爬网程序都应处于“仍在估计=假”和“TimeLeftSeconds = 0”的状态。根据我的经验，爬虫程序在估计阶段后需要一分钟来启动，完成后需要一分钟来停止。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="1c2b" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">成功运行四个爬行器完成了演示的原始数据接收阶段。</p><h2 id="7d5c" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">用CTAS改造成拼花地板</h2><p id="cf44" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">原始数据接收阶段完成后，我们现在将使用三个AWS Lambda函数将原始Smart Hub使用数据、传感器映射数据和位置数据转换为Parquet格式。每个Lambda随后调用Athena，后者执行一个<code class="fe mv mw mx my b">CREATE TABLE AS SELECT</code> SQL语句(又名<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/ctas.html" rel="noopener ugc nofollow" target="_blank"> CTAS </a>)。每个Lambda都执行类似的命令，不同之处仅在于数据源、数据目的地和分区方案。下面是用于智能集线器用电数据的命令示例，取自基于Python的Lambda，<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/lambdas/athena-json-to-parquet-data/index.py" rel="noopener ugc nofollow" target="_blank">Athena-JSON-to-parquet-data/index . py</a>。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="3072" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">这个简洁而强大的CTAS语句将原始JSON和CSV格式数据文件的副本转换为Parquet格式，并将结果文件分区并存储回基于S3的数据湖。此外，CTAS SQL语句将拼花地板格式的数据文件编入胶合数据目录数据库的新表中。不幸的是，这种方法不适用于XML格式的原始数据文件，这是我们接下来要解决的问题。</p><p id="790d" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">从Lambda控制台的functions选项卡上应该可以看到五个已部署的Lambda函数。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/020f68cec6679dd52b897820860001f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Avjz9B4anTW_QaIb.png"/></div></div></figure><p id="2b28" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">使用AWS CLI调用三个Lambda函数。(<em class="mi"/><a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"><em class="mi">工作流程图</em> </a>中步骤2a的一部分)。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="0e48" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">这是同一个CTAS命令的一个例子，上面显示了Smart Hub电力使用数据，因为它是由Athena成功执行的。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="1e35" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">我们可以从Athena控制台的History选项卡中查看任何Athena SQL查询。单击一个查询(粉色)会将其复制到查询编辑器选项卡并执行它。下面，我们看到Lamba函数执行的三个SQL语句。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/e0fa23f41483277af5a0d0d022d913fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iKW4GxzJqoY3yVba.png"/></div></div></figure><h2 id="b490" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">AWS为XML粘合ETL作业</h2><p id="83fd" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">如果您还记得，电价数据是XML格式的。我们刚刚执行的Lambda函数使用Athena将CSV和JSON数据转换为Parquet。目前，与CSV、JSON、ORC、Parquet和Avro不同，<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/supported-format.html" rel="noopener ugc nofollow" target="_blank"> Athena不支持</a>更老的XML数据格式。对于XML数据文件，我们将使用AWS Glue ETL作业将XML数据转换成Parquet。Glue ETL作业是用Python编写的，使用了<a class="ae mh" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Spark </a>，以及几个<a class="ae mh" href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-python-extensions.html" rel="noopener ugc nofollow" target="_blank"> AWS Glue PySpark扩展</a>。对于这项工作，我使用在Glue ETL作业控制台中创建的现有脚本作为基础，然后修改脚本以满足我的需要。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="d9d8" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">脚本期望的三个Python命令行参数(上面的第10-12行)在CloudFormation模板<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/cloudformation/smart-hub-athena-glue.yml" rel="noopener ugc nofollow" target="_blank">smart-hub-Athena-glue . yml</a>中定义。下面，我们在CloudFormation代码片段的第10–12行看到了它们。它们是在作业运行时自动注入的，并且可以在启动作业时从命令行覆盖。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="b3b7" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">首先，将Glue ETL Job Python脚本复制到<code class="fe mv mw mx my b">SCRIPT_BUCKET</code> S3桶中。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="09af" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">接下来，启动Glue ETL作业( <a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">工作流程图</em> </a>中步骤2a的<em class="mi">部分)。虽然转换是一组相对简单的任务，但是创建Apache Spark环境来执行这些任务需要几分钟的时间。尽管Glue Crawlers平均需要大约2分钟，但是根据我的经验，Glue ETL工作可能需要10-15分钟。实际执行时间只需要10-15分钟中的1-2分钟。在我看来，等待15分钟对于针对较小数据集的临时作业来说太长了；Glue ETL作业肯定是针对大数据的。</em></p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="9aa2" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">要检查作业的状态，请使用Glue ETL作业控制台，或者使用AWS CLI。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="5590" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">完成后，您应该会看到类似下面的结果。请注意,“JobRunState”为“SUCCEEDED”这个特定的作业总共运行了14.92分钟，而实际执行时间是2.25分钟。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="1f16" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">作业的进度和结果也可以在AWS Glue控制台的ETL作业选项卡中看到。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/0669b986933865956388915690bc100d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qox6jhK3wgRU1Axx.png"/></div></div></figure><p id="190f" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">CloudWatch管理控制台中也提供了详细的Apache Spark日志，可以从AWS Glue控制台的ETL Jobs选项卡中的logs链接直接访问。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/8051b2ee31de15481dbe69c8285187c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A1RMMoEVwZydFiAQ.png"/></div></div></figure><p id="8dd6" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">数据转换阶段的最后一步是使用另一个Glue Crawler(在 <a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">工作流图</em> </a>中的<em class="mi">步骤2b的一部分)将之前的Glue ETL作业创建的拼花格式的电费数据转换成目录。启动下面的Glue Crawler来编目Parquet格式的电费数据。</em></p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="921d" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">数据转换阶段到此结束。原始数据和转换后的数据在数据湖中，下面的九个表应该在Glue数据目录中。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="2439" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">如果我们检查这些表，我们应该观察到我们用来组织基于亚马逊S3的数据湖中的数据文件的数据分区包含在表元数据中。下面，我们看到了基于状态的拼花格式位置数据的四个分区。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/9f507739f937b9b0007aac31d6107523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uehbI8oQHhF8lUB0.png"/></div></div></figure><h2 id="d016" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">数据丰富</h2><p id="240b" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">为了开始数据丰富阶段，我们将调用AWS Lambda，<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/lambdas/athena-complex-etl-query/index.py" rel="noopener ugc nofollow" target="_blank">Athena-complex-ETL-query/index . py</a>。这个Lambda接受输入参数(下面的第28–30行)，在Lambda处理程序的事件参数中传递。参数包括Smart Hub ID、请求数据的开始日期和请求数据的结束日期。演示的场景是，一个具有位置id值的客户使用电力供应商的应用程序请求特定日期范围(开始日期和结束日期)的数据，以进行可视化和分析。</p><p id="bd77" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">Lambda执行一系列Athena <code class="fe mv mw mx my b">INSERT INTO</code> SQL语句，每个语句对应一个可能的Smart Hub连接的电气传感器<code class="fe mv mw mx my b">s_01</code>到<code class="fe mv mw mx my b">s_10</code>，Smart Hub电气使用数据中有这些传感器的值。亚马逊<a class="ae mh" href="https://aws.amazon.com/about-aws/whats-new/2019/09/amazon-athena-adds-support-inserting-data-into-table-results-of-select-query/" rel="noopener ugc nofollow" target="_blank">刚刚在2019年9月发布了</a>亚马逊Athena <code class="fe mv mw mx my b">INSERT INTO</code>一个使用选择查询功能结果的表，这是对Athena的一个重要补充。Athena的新功能在<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/release-notes.html" rel="noopener ugc nofollow" target="_blank">发行说明</a>中列出。</p><p id="bbc9" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">这里，选择查询实际上是一系列链式子查询，使用Presto SQL的<a class="ae mh" href="https://prestodb.io/docs/current/sql/select.html" rel="noopener ugc nofollow" target="_blank"> WITH子句</a>功能。这些查询将基于S3的数据湖中的拼花格式智能集线器用电数据源与其他三个基于S3的拼花格式数据源(传感器映射、位置和电费)连接起来。拼花格式的数据作为单独的文件写入S3，并插入到现有的“etl_tmp_output_parquet”胶合数据目录数据库表中。与传统的基于关系数据库的查询相比，Glue和Athena能够跨存储在S3的多个半结构化数据文件进行复杂的SQL查询，这真是令人惊叹！</p><blockquote class="mj mk ml"><p id="cc3c" class="ll lm mi ln b lo mm ju lq lr mn jx lt mo mp lw lx mq mr ma mb ms mt me mf mg im bi translated"><em class="it">Glue和Athena能够对存储在S3的多个半结构化数据文件进行复杂的SQL查询，这真是令人惊叹！</em></p></blockquote><p id="57d7" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">下面，我们看到从第43行开始的SQL语句。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="f6d8" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">下面是Athena对<code class="fe mv mw mx my b">s_10</code>传感器执行的最终查询之一的示例。所有输入参数值、Python变量和环境变量都已被解析到查询中。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="b88d" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">在丰富数据的同时，该查询使用其他数据源执行额外的数据转换。例如，根据客户的位置，Unix时间戳被转换为包含日期和时间的本地化时间戳(上面的第7行)。转换日期和时间是一项频繁且痛苦的数据分析任务。数据丰富的另一个例子是用新的计算列增加数据。该列的值是使用另外两列的值计算的(上面的第33行)。</p><p id="1e1c" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">使用有效负载中的以下三个参数调用Lambda(<a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"><em class="mi">工作流图</em> </a>中的<em class="mi">步骤3a)。</em></p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="a1bd" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">十个<code class="fe mv mw mx my b">INSERT INTO</code> SQL语句的结果状态(每个设备传感器一个)可从Athena控制台的History选项卡中看到。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/22ad2dba6f42a57ee1d2752820c22e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p2_HB1jtSNOkBT09.png"/></div></div></figure><p id="8c77" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">每次Athena查询执行都将查询结果作为单独的、未压缩的Parquet格式数据文件保存到基于S3的数据湖中。数据在基于亚马逊S3的数据湖中按照智能电表位置ID(例如‘loc _ ID = b6a8d 42425 FDE 548’)进行分区。</p><p id="f066" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">以下是客户洗衣机(传感器s _ 04’)的丰富数据片段。请注意，时间戳现在是客户当地时区的实际日期和时间(例如，“2019–12–21 20:10:00.000”)。传感器ID ('s_04 ')被替换为实际的设备名称('洗衣机')。增加了设备的位置(“地下室”)和用电时段的类型(如“高峰”或“部分高峰”)。最后，计算成本列。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="dc6f" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">为了将丰富的CSV格式数据转换为Parquet格式，我们需要使用另一个爬虫对CSV格式的结果进行编目，首先( <a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">中的<em class="mi">步骤3d，工作流图</em> </em></a>)。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="fd19" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">优化丰富的数据</h2><p id="d02d" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">上一步创建了丰富的拼花格式数据。然而，这些数据在查询效率方面并没有得到应有的优化。使用Athena <code class="fe mv mw mx my b">INSERT INTO WITH</code> SQL语句，允许对数据进行分区。然而，该方法不允许拼花数据被容易地组合成更大的文件并被压缩。为了执行这两个优化，我们将使用最后一个Lambda，<a class="ae mh" href="https://github.com/garystafford/athena-glue-quicksight-demo/blob/master/lambdas/athena-parquet-to-parquet-elt-data/index.py" rel="noopener ugc nofollow" target="_blank">Athena-parquet-to-parquet-ELT-data/index . py</a>。Lambda将在基于亚马逊S3的数据湖中创建一个新位置，在一个文件中包含所有丰富的数据，并使用<a class="ae mh" href="https://en.wikipedia.org/wiki/Snappy_(compression)" rel="noopener ugc nofollow" target="_blank"> Snappy </a>压缩进行压缩。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="7c9c" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">生成的拼花文件可以在S3管理控制台中看到。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/1b548784da25b71c1578a93e4da48264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NEbKeVREIA7AFgoM.png"/></div></div></figure><p id="fdec" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">数据丰富阶段的最后一步是对优化的Parquet格式的丰富ETL数据进行编目。为了对数据进行分类，运行下面的Glue Crawler(在<a class="ae mh" href="https://programmaticponderings.files.wordpress.com/2020/01/athena-glue-0-4.png" rel="noopener ugc nofollow" target="_blank"> <em class="mi">工作流程图</em> </a>中的步骤3i)</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="c01a" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">最终数据湖和数据目录</h2><p id="100d" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在基于S3的数据湖中，我们现在应该有以下十个分区数据的顶级文件夹。可以忽略“tmp”文件夹。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="77fd" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">类似地，我们现在应该在Glue数据目录中有以下十个对应的表。使用AWS Glue控制台确认这些表是否存在。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/b0f4164b0363a639729bcb43bd3c8755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DFu1MXnqNepSeiRg.png"/></div></div></figure><p id="a303" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">或者，使用以下AWS CLI / jq命令列出表名。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h2 id="f495" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">“未知”错误</h2><p id="9bc3" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">您可能已经注意到，使用CTAS SQL语句，用AWS Lambda函数创建的四个表错误地将“分类”设为“未知”,而不是“拼花”。我不知道为什么，我相信这是一个与CTAS功能可能的错误。这似乎对桌子的功能没有负面影响。但是，要解决此问题，请运行以下命令集。这个<code class="fe mv mw mx my b">aws glue update-table</code>攻击将把桌子的“分类”切换到“拼花”。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="b03c" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">从AWS Glue控制台可以看到修复的结果。所有十个表现在都被正确分类。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/3b05e59922988b3d7cff42ccd16b86e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4hdfY1qE3GOS7veb.png"/></div></div></figure><h1 id="7189" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">探索数据</h1><p id="6f5d" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在开始使用Amazon QuickSight可视化和分析数据之前，尝试使用Athena查询编辑器对Glue Data Catalog数据库中的表执行一些Athena查询。在编辑器中工作是理解数据、学习Athena以及调试SQL语句和查询的最佳方式。Athena查询编辑器具有方便的开发人员特性，如SQL自动完成和查询格式化功能。</p><p id="0549" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">在编写查询和在互联网上搜索SQL参考时要注意，Athena查询引擎是基于Presto <a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/DocHistory.html" rel="noopener ugc nofollow" target="_blank"> 0.172 </a>的。Presto的当前版本，<a class="ae mh" href="https://github.com/prestodb/presto/releases/tag/0.229" rel="noopener ugc nofollow" target="_blank"> 0.229 </a>，比当前雅典娜版本领先50多个版本。Athena和Presto的功能都发生了变化和分化。对于Athena中的SQL查询，还有一些额外的<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/other-notable-limitations.html" rel="noopener ugc nofollow" target="_blank">注意事项和限制</a>。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/fa855979180ee0ed9fdcbd5885121872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*slfQgovIBgSsIhIz.png"/></div></div></figure><p id="24da" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">下面是一些在Athena查询编辑器中运行的简单的特别查询。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h1 id="7cec" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">使用QuickSight实现数据可视化和商业智能</h1><p id="eaf4" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">对于演示的最后一部分，我们将使用Amazon QuickSight控制台，而不是AWS CLI、CloudFormation模板和Python脚本。</p><h2 id="6ea7" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">注册QuickSight</h2><p id="354b" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">要使用Amazon QuickSight，您必须注册QuickSight。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/06e7d96ef87b9a0286d21f0ae5b640b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GyAurNQIZBZ4Q2ZM.png"/></div></div></figure><p id="628b" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">亚马逊QuickSight有两个版本，标准版和企业版。对于这个演示，标准版就足够了。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/2d13d7b853129da6ed8e2bc819b8529f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jx4FHDye6kVrLyLY.png"/></div></div></figure><h2 id="8284" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">QuickSight数据集</h2><p id="e234" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">Amazon QuickSight使用数据集作为所有数据可视化的基础。据亚马逊称，QuickSight数据集可以从各种各样的数据源中创建，包括亚马逊RDS、亚马逊Aurora、亚马逊Redshift、亚马逊Athena和亚马逊S3。您还可以上传Excel电子表格或平面文件(CSV、TSV、CLF、ELF和JSON)，连接到SQL Server、MySQL和PostgreSQL等内部数据库，并从Salesforce等SaaS应用程序导入数据。下面，我们看到了QuickSight新数据集控制台中可用的最新数据源列表。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ob"><img src="../Images/011a571bb540384321f20133c8906f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DRK5ST13eEVSfhAc.png"/></div></div></figure><h2 id="fc53" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">演示数据集</h2><p id="cace" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">为了演示，我创建了三个QuickSight数据集，它们都基于Amazon Athena作为数据源。当使用Amazon Athena作为数据源时，您有两种选择。第一个选项是从AWS Glue Data Catalog数据库中选择一个表，比如我们在文章的第一部分“smart_hub_data_catalog”中创建的数据库第二个选项是基于AWS Glue数据目录数据库中的一个或多个表创建一个定制的SQL查询。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/a026d4dd3db4144635db8ef2f7de2e35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kkFkjbxJgzKc-6tw.png"/></div></div></figure><p id="dd97" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">在本演示第二部分创建的三个数据集中，两个数据集直接使用数据目录中的表，包括“etl_output_parquet”和“electricity_rates_parquet”第三个数据集使用自定义SQL查询，基于单个数据目录表“smart_hub_locations_parquet”用于创建数据集的所有三个表都代表了位于S3的数据湖中丰富、高效的Parquet格式数据源。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/56fc6ab607a5163f00053c8d295b54a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zMqeiicEm0XagzZE.png"/></div></div></figure><h2 id="d692" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">数据集特征</h2><p id="e8f8" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">创建和配置数据集时，有大量功能可用。我们不可能在这篇文章中涵盖所有的内容。让我们来看三个特性:地理空间字段类型、计算字段和自定义SQL。</p><h2 id="f831" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">地理空间数据类型</h2><p id="eb1f" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">QuickSight可以智能地检测数据源中常见类型的地理字段，并分配QuickSight地理数据类型，包括国家、县、城市、邮政编码和州。QuickSight还可以检测<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/geospatial-data-prep.html" rel="noopener ugc nofollow" target="_blank">地理空间数据</a>，包括纬度和经度。我们将利用QuickSight特性来处理三个数据集的数据源，包括州、邮政编码、纬度和经度字段类型。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/d0ebd0be2f5f4d65237477fa30f1c187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JJMQ1cvHkt0wXI_S.png"/></div></div></figure><h2 id="2e4c" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">计算字段</h2><p id="6348" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">一个常用的QuickSight数据集功能是“计算字段”对于“etl_output_parquet”数据集，我创建了一个新字段(列)“cost_dollar”</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nw"><img src="../Images/13c6390f32f1da1fe461fb9fb6479935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Hnt2xqGPV9tBCU7i.png"/></div></div></figure><p id="fc81" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated"><code class="fe mv mw mx my b">cost</code>字段是设备在五分钟时间间隔内的电力成本，单位为美分()。计算出的<code class="fe mv mw mx my b">cost_dollar</code>字段是<code class="fe mv mw mx my b">cost</code>字段除以100的商。该值表示设备在五分钟时间间隔内的电力成本，单位为美元($)。这是一个简单的例子。但是，计算字段可能非常复杂，由多个算术、比较和条件函数、字符串计算和数据集字段构成。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/0a03d78e3d51f4eec83f194701d3d55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6zl1ApgkwbgXJU9m.png"/></div></div></figure><p id="cc74" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">数据集计算字段也可以从QuickSight分析控制台创建和编辑(稍后讨论)。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/1bc4a1b3dbee2d51998e137eb23d41cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K9cAek7vgZPrx8-o.png"/></div></div></figure><h2 id="2edf" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">自定义SQL</h2><p id="a7b0" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">第三个QuickSight数据集基于Amazon Athena定制SQL查询。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="cbd0" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">虽然您可以在QuickSight数据准备控制台中编写查询，但我更喜欢使用Athena查询编辑器编写自定义Athena查询。首先，使用编辑器，您可以编写、运行、调试和优化查询，以确保它们正常运行。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/70387cc3907437135192fafbc66b72ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2FuuncOXVL3KnJnF.png"/></div></div></figure><p id="9c09" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">然后Athena查询可以粘贴到自定义SQL窗口中。在窗口中单击“完成”相当于在Athena查询编辑器控制台中单击“运行查询”。查询运行并返回数据。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/2976bf34db742960324fc4c73452e8bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n85uq_VMQ_rZp82G.png"/></div></div></figure><p id="a1fc" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">与Athena查询编辑器类似，在QuickSight数据准备控制台中执行的查询将显示在Athena历史选项卡中，带有一个<code class="fe mv mw mx my b">/* QuickSight */</code>注释前缀。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/70fdbfa8017f49e2ebe7bd8f3d57e035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H5VmrZUoPbR1G0d1.png"/></div></div></figure><h2 id="8cf0" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">香料</h2><p id="aec3" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">您会注意到三个QuickSight数据集被标记为“SPICE”据亚马逊网站称，首字母缩写SPICE代表“超高速、并行、内存计算引擎”。QuickSight的内存计算引擎SPICE可在大规模应用中实现极快的性能。SPICE自动复制数据以实现高可用性，允许成千上万的用户同时执行快速、交互式的分析，同时保护您的底层数据基础架构，节省您的时间和资源。使用QuickSight的标准版，作为第一作者，您可以免费获得1 GB的SPICE内存数据。</p><h2 id="64a3" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">快速视力分析</h2><p id="1a04" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">QuickSight分析控制台是创建分析的地方。特定的QuickSight分析将包含一组数据集和<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/working-with-visuals.html" rel="noopener ugc nofollow" target="_blank">数据可视化</a>(视觉效果)。每个视觉与单个数据集相关联。</p><p id="917e" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">QuickSight分析视觉效果的类型包括:水平和垂直、单个和堆叠条形图、折线图、组合图、面积折线图、散点图、热图、饼图和圆环图、树状图、数据透视表、仪表图、关键性能指标(KPI)、地理空间图和文字云。可以轻松修改单个可视标题、图例、轴和其他可视方面。视觉效果可以包含<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/adding-drill-downs.html" rel="noopener ugc nofollow" target="_blank">下钻</a>。</p><p id="4514" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">可以从分析控制台中修改数据集的字段。可以为显示自定义字段类型和格式，如日期、数字、货币字段。该分析可以包括标题和副标题。有一些可定制的主题可以用来改变分析的整体外观。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/bd62aea721a4b03049514c241c6170ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d4nFmg1uDrvQdXja.png"/></div></div></figure><h2 id="58a9" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">分析过滤器</h2><p id="8167" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">使用<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/filtering-visual-data.html" rel="noopener ugc nofollow" target="_blank">过滤器</a>、<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/conditional-formatting-for-visuals.html" rel="noopener ugc nofollow" target="_blank">条件格式</a>和<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/parameterize-a-filter.html" rel="noopener ugc nofollow" target="_blank">参数</a>的组合，可以进一步调整视觉效果中显示的数据。下面，我们将看到一个基于日期和时间范围的典型过滤器示例。数据集包含两整天的数据。在这里，我们将数据过滤到14小时的用电高峰期，即2019年12月21日上午8点到晚上10点。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/8b9329205aa1f5e834e3b8ef04a1b709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V6lgsB7X_6yqsZrz.png"/></div></div></figure><h2 id="5a86" class="nj ku it bd kv nk nl dn kz nm nn dp ld lu no np lf ly nq nr lh mc ns nt lj nu bi translated">向下钻取、向上钻取、聚焦和排除</h2><p id="1f60" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">根据<a class="ae mh" href="https://docs.aws.amazon.com/quicksight/latest/user/adding-drill-downs.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>的说法，除了数据透视表之外的所有可视类型都提供了为可视元素创建字段层次结构的能力。层次结构允许您向下或向上钻取，以查看层次结构不同级别的数据。焦点可以让你专注于字段层次结构中的单个元素。“排除”允许您从字段层次结构中删除元素。下面，我们看到一个例子，所有这四个特点，可适用于“中央空调”。由于空调设备是平均每天最大的电力消耗者，应用这些滤波器来了解其对整体电力使用的影响可能有助于分析。我们还可以从几小时深入到几分钟，或者从几小时深入到几天。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/f9842b68a96bc39e0e8e7b9b905d1dd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*82C_XDz3Zu835mIz.png"/></div></div></figure><h1 id="13e8" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">示例QuickSight分析</h1><p id="9090" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">分析作者将QuickSight分析作为QuickSight仪表板进行共享。下面，我们将看到一个QuickSight仪表盘示例，它是为本次演示而构建和共享的。“住宅用电分析”是根据之前创建的三个数据集构建的。根据这些数据集，我们构建了几个视觉效果，包括地理空间图、圆环图、热图、关键性能指标、堆叠垂直条形图和折线图。每个视频的标题、布局和字段显示都是定制的。视觉效果中显示的数据经过了不同的过滤，包括按日期和时间、按客户id ( <code class="fe mv mw mx my b">loc_id</code>)和按州。条件格式用于增强视觉效果的视觉外观，例如“总电力成本”KPI。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/ab74b70cdab68647fa775d46c21466eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vP8Oal_SscWqhUoD.png"/></div></div></figure><h1 id="ce1d" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">QuickSight APIs</h1><p id="c900" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">虽然我们在这次演示中没有使用它们，但Amazon <a class="ae mh" href="https://aws.amazon.com/about-aws/whats-new/2019/11/amazon-quicksight-adds-api-support-for-data-dashboard-spice-and-permissions/" rel="noopener ugc nofollow" target="_blank">最近添加了一整套用于以编程方式与QuickSight交互的</a>API。例如，要预览在演示的这一部分创建的三个QuickSight数据集，使用AWS CLI，我们可以使用<code class="fe mv mw mx my b">list-data-sets</code>命令。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><p id="229b" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">要使用AWS CLI检查单个数据集的细节，我们可以使用<code class="fe mv mw mx my b">describe-data-set</code>命令。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h1 id="5399" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">清理</h1><p id="e579" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">要清理在本演示中创建的AWS资源，请执行以下AWS CLI命令。为了避免失败，请确保在运行后续命令之前完成每个命令。您需要使用AWS CloudFormation控制台或AWS CLI确认CloudFormation堆栈已删除。请注意，这些命令不会删除您可能从控制台创建的任何Amazon QuickSight数据集、分析和仪表板。但是，删除AWS粘合数据目录和底层数据源将影响在QuickSight中可视化数据的能力。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="nv ko l"/></div></figure><h1 id="cbeb" class="kt ku it bd kv kw kx ky kz la lb lc ld jz le ka lf kc lg kd lh kf li kg lj lk bi translated">结论</h1><p id="c653" class="pw-post-body-paragraph ll lm it ln b lo lp ju lq lr ls jx lt lu lv lw lx ly lz ma mb mc md me mf mg im bi translated">在这篇文章中，我们学习了如何使用亚马逊S3、AWS Glue、亚马逊Athena和AWS Lambda以多种格式接收、转换和丰富原始的半结构化数据。我们建立了一个基于S3的数据湖，并了解了AWS如何利用开源技术，包括Presto、Apache Hive和Apache Parquet。最后，我们使用存储在数据湖中的经过转换和丰富的数据集，通过Amazon QuickSight创建引人注目的可视化效果。</p></div><div class="ab cl oc od hx oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="im in io ip iq"><p id="05d1" class="pw-post-body-paragraph ll lm it ln b lo mm ju lq lr mn jx lt lu mp lw lx ly mr ma mb mc mt me mf mg im bi translated">本文表达的所有观点都是我个人的，不一定代表我现在或过去的雇主或他们的客户的观点。</p></div></div>    
</body>
</html>