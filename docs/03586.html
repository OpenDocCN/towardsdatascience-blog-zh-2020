<html>
<head>
<title>Send Emails in Python with Gmail</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python和Gmail发送电子邮件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automate-sending-emails-with-gmail-in-python-449cc0c3c317?source=collection_archive---------3-----------------------#2020-04-05">https://towardsdatascience.com/automate-sending-emails-with-gmail-in-python-449cc0c3c317?source=collection_archive---------3-----------------------#2020-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="808e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用几行代码发送电子邮件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/346a1ae19bcfbeec29153e16f38ddcf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8-F9UhhzOJcLDjgvD08TkA.png"/></div></div></figure><p id="7428" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这篇文章将解释如何在Google帐户中设置应用程序密码，并使用Python在几行代码中发送电子邮件，用于自动报告、测试自动化或CI/CD故障通知等。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="22eb" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">Google帐户设置</h1><p id="37f9" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated">要使用Gmail帐户通过第三方应用程序(如Python脚本)发送电子邮件，我们需要设置应用程序密码。出于安全原因，普通Gmail密码仅限于网络登录。从2020年开始，即使你打开了谷歌账户中的<a class="ae mu" href="https://support.google.com/accounts/answer/6010255?hl=en" rel="noopener ugc nofollow" target="_blank">“不太安全的应用访问”</a>选项，也无法使用Python脚本中的普通密码登录你的Gmail账户。</p><p id="1ab9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，您需要启用两步验证。只需进入您的Google帐户&gt;安全&gt;登录Google，选择两步验证并按照说明进行操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/f271bda5bcc0f943e41bd855b945133f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPVO-ut1oXg7Z1azhGhn5A.jpeg"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">启用两步验证</p></figure><p id="c736" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，创建一个应用程序密码。只需选择“两步验证”下的“应用程序密码”，您将看到如下窗口。在“选择应用程序”下拉列表中选择“其他”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/4b036594422fb14946b41cac8f640046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8MAo8rx8tWEwsT3ZW2VQ3Q.jpeg"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">应用程序密码/步骤1</p></figure><p id="7f46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">输入一个名称，例如Python，然后单击“生成”。请注意，该名称与Python脚本没有任何联系，可以是任何名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/9d08f8981380a960c7830fdb2e6906d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBvhO67iaKnd8xholRSdUQ.jpeg"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">应用程序密码/步骤2</p></figure><p id="f76f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后你会得到一个新的应用程序密码。复制并保存不带空格的16字符密码，例如xnwbjmgvjeeevlgc，以便在Python脚本中使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/4c024b7d67046b746759efe92e2ac5a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*81aBu4jAsLjwAxYrNC1gOw.jpeg"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">应用程序密码/步骤3</p></figure></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="773e" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">用yagmail发送电子邮件</h1><p id="a032" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated"><a class="ae mu" href="https://github.com/kootenpv/yagmail" rel="noopener ugc nofollow" target="_blank"> yagmail </a>是Python标准库smtplib的包装器，使得发送邮件变得非常容易。</p><p id="1ee1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要在Python中安装yagmail，只需运行<code class="fe nd ne nf ng b">pip install yagmail</code>。</p><p id="34d3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面是发送带有两个附件的电子邮件的示例脚本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="10ea" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这段代码非常简单，不言自明，所以几乎不需要任何解释。除了您的Gmail用户名和应用程序密码，您只需定义收件人、主题和内容，就像从web Gmail写电子邮件一样。内容是一个列表，第一个元素是正文部分，其余是附件。在本例中，我们从脚本所在的同一文件夹中附加了“pytest.ini”和“test.png”。</p><p id="fe17" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要运行这个脚本，只需在任何平台上运行<code class="fe nd ne nf ng b">python send_gmail_by_yagmail.py</code>，Windows、Linux或MacOS。您将在收件人帐户中收到一封电子邮件，如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/08c52da844bb5f74a3dd53850813c010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*VevCs5v3Z-AuqVD5K-8A2A.png"/></div><p class="mw mx gj gh gi my mz bd b be z dk translated">示例电子邮件</p></figure><p id="83bc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要发送一组收件人，只需将“收件人”更改为一个列表。</p><p id="db1b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nd ne nf ng b">to = [‘user1@gmail.com’, ‘user2@yahoo.com’]</code></p><p id="ea1a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意，yagmail默认使用gmail SMTP服务器，你可以显式定义SMTP服务器和端口。</p><pre class="kj kk kl km gt nk ng nl nm aw nn bi"><span id="027f" class="no ly it ng b gy np nq l nr ns">host = 'smtp.gmail.com'<br/>port = 465<br/>with yagmail.SMTP(user, password, host, port) as yag:</span></pre></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="e3b4" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">使用Python标准库</h1><p id="670f" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated">我们也可以使用Python标准库，不需要安装任何额外的包来发送邮件。</p><p id="0ef1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们导入标准的email和smtplib包，并定义相关的变量。</p><ul class=""><li id="b8a5" class="nt nu it kw b kx ky la lb ld nv lh nw ll nx lp ny nz oa ob bi translated">Gmail用户名和应用程序密码</li><li id="3906" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">Gmail主机和端口</li><li id="ccca" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">到</li><li id="d829" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">科目</li><li id="d38e" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">正文内容</li><li id="0583" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">附件</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/9d3653bf8da778f05b8fbf19ca98f01e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*HG3Bhlh3cp3vp02QkTHtmg.jpeg"/></div><p class="mw mx gj gh gi my mz bd b be z dk translated">标准库/第1部分</p></figure><p id="dec8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">其次，我们用上面的信息定义一个电子邮件对象。消息被定义为MIMEMultipart，这样我们可以添加附件，每个部分都是一个MIMEText对象，它也支持二进制文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/ef8d76df8489d528ab96ba9e1578f5c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IrcSNWASm6SYXnCMoHT-xA.jpeg"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">标准库/第2部分</p></figure><p id="7ed5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，我们调用smtplib登录并发送消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/0dc648ebd206882a2a170ee9d664a53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*oGLerWgb5B_myb0-fza_Qw.jpeg"/></div><p class="mw mx gj gh gi my mz bd b be z dk translated">标准库/第3部分</p></figure><p id="2d18" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你可以在这里找到完整的脚本send_gmail_standard_lib.py <a class="ae mu" href="https://gist.github.com/peterjpxie/decd14f5926a895f5cb1d842f2350781" rel="noopener ugc nofollow" target="_blank">。当然要运行，只需输入<code class="fe nd ne nf ng b">python send_gmail_standard_lib.py</code>。</a></p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="e548" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">Python 3.6+中的变化</h1><p id="c26d" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated">上面两个例子支持Python 3.5甚至更低版本。Python 3.6中引入了新的<a class="ae mu" href="https://docs.python.org/3/library/email.message.html#email.message.EmailMessage" rel="noopener ugc nofollow" target="_blank"> EmailMessage </a> API来定义电子邮件。更多细节可以参考最新的<a class="ae mu" href="https://docs.python.org/3/library/email.html" rel="noopener ugc nofollow" target="_blank">文档</a>和一个例子<a class="ae mu" href="https://docs.python.org/3/library/email.examples.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h1 id="a9fd" class="lx ly it bd lz ma ok mc md me ol mg mh jz om ka mj kc on kd ml kf oo kg mn mo bi translated">常见问题解答</h1><p id="6eb2" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated">在非英语Windows操作系统上，您可能会遇到如下UnicodeDecodeError错误。</p><pre class="kj kk kl km gt nk ng nl nm aw nn bi"><span id="6b0d" class="no ly it ng b gy np nq l nr ns">server = smtplib.SMTP_SSL(smtp_host, smtp_port)<br/>  File "C:\Program Files (x86)\Python37-32\lib\smtplib.py", line 1031, in __init__<br/>    source_address)<br/>  File "C:\Program Files (x86)\Python37-32\lib\smtplib.py", line 261, in __init__<br/>    fqdn = socket.getfqdn()<br/>  File "C:\Program Files (x86)\Python37-32\lib\socket.py", line 676, in getfqdn<br/>    hostname, aliases, ipaddrs = gethostbyaddr(name)<br/>UnicodeDecodeError: 'utf-8' codec can't decode byte 0xc3 in position 2: invalid continuation byte</span></pre><p id="2b4f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这似乎是Python smtplib模块的一个bug。原因是您的计算机名包含非英语字符。因此，解决方法是简单地用英文字符重命名您的计算机名。</p><h1 id="6c34" class="lx ly it bd lz ma ok mc md me ol mg mh jz om ka mj kc on kd ml kf oo kg mn mo bi translated">参考</h1><p id="ecc2" class="pw-post-body-paragraph ku kv it kw b kx mp ju kz la mq jx lc ld mr lf lg lh ms lj lk ll mt ln lo lp im bi translated"><a class="ae mu" href="https://github.com/kootenpv/yagmail" rel="noopener ugc nofollow" target="_blank">https://github.com/kootenpv/yagmail</a><br/><a class="ae mu" href="https://mp.weixin.qq.com/s/AMYeOiMX7URc_PFczqQ-5Q" rel="noopener ugc nofollow" target="_blank">https://mp.weixin.qq.com/s/AMYeOiMX7URc_PFczqQ-5Q</a><br/><a class="ae mu" href="https://docs.python.org/3/library/smtplib.html" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/library/smtplib.html</a><br/>T18】https://docs.python.org/3/library/email.html</p></div></div>    
</body>
</html>