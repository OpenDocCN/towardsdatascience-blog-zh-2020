<html>
<head>
<title>Data Pipeline in GCP: Cloud Function Basics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP的数据管道:云功能基础</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-pipeline-in-gcp-cloud-function-basics-524e870cfaa5?source=collection_archive---------40-----------------------#2020-05-19">https://towardsdatascience.com/data-pipeline-in-gcp-cloud-function-basics-524e870cfaa5?source=collection_archive---------40-----------------------#2020-05-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d4e0101505451d4afc3a62ea7edaf99b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-CtJdmyP99Vtq5oG-iV4g.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">来源:谷歌云</p></figure><p id="5d22" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">大多数数据科学家更喜欢拥有他们模型的端到端数据管道，但是拥有管道需要大量的工程工作。</p><p id="3a97" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本文中，我将讨论云功能，这是一个无服务器、简单且经济的选项。</p><h1 id="3b17" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第一步:日程安排</h1><p id="47ae" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">GCP提供了一个简单的调度工具，叫做“云调度器”。从左上角的导航菜单中找到云调度程序。</p><p id="783f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">给你的工作一个名字和描述。接下来，您需要提供计划的频率。如果您曾经使用过包括Cron作业在内的任何调度程序，您在这里都会很好。</p><p id="ba4e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择时区和发布/订阅作为目标。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/2339ace88ef5de21c4fff268d5036542.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_Oznnvaj2dt6BWWYoovLA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">云调度程序用户界面</p></figure><p id="1d86" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦你点击主题和有效载荷的发布/订阅选项。主题名称稍后将用作Python函数的名称，因此请记住使用Python中可接受的函数名称主题。现在给payload一些任意的字符串。</p><p id="156b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您喜欢使用命令行，可以运行以下命令:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1636" class="mn lb iq mj b gy mo mp l mq mr">gcloud alpha scheduler jobs create pubsub scheduler-name --schedule="0 8 * * *" --topic="my_pipeline_topic" --message-body=" "</span></pre><p id="476e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，您应该能够在Cloud Scheduler中看到您的计划作业。</p><h1 id="c480" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第二步:发布/订阅</h1><p id="000c" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">我推荐你阅读谷歌关于<a class="ae ms" href="https://cloud.google.com/pubsub" rel="noopener ugc nofollow" target="_blank"> Pub/Sub </a>的文档。但是简单一句话，Pub/Sub允许你在不同的应用之间发送消息。您可以将发布/订阅用于批处理和流数据管道。</p><p id="ec9e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在使用该主题创建一个发布/订阅主题</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6ef2" class="mn lb iq mj b gy mo mp l mq mr">gcloud pubsub topics create my_pipeline_name</span></pre><p id="2f9e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以选择使用UI创建发布/订阅主题:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/2a2a5674bd61eee52a1dce8bc829604b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0IGdimL-fcSweNAFSkm8WA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">从用户界面创建发布/订阅主题</p></figure><h1 id="28f6" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第三步:云功能</h1><p id="9337" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">你可以选择从用户界面创建你的云功能，但我不建议这样做。首先，如果你的代码中有一个bug，你将会丢失你的工作。第二，您很容易忘记您的更改和版本。</p><p id="6fea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">作为第一步，让我们在本地创建我们的函数，并将它们手动部署到GCP。</p><p id="b9cc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你需要什么？</p><p id="d897" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你需要一个“main.py”函数。这是所有函数和类的包装器。在main.py中应该有一个函数使用我们的云函数名。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="79d3" class="mn lb iq mj b gy mo mp l mq mr">your imports here<br/>def my_pipeline_name(event,contex):<br/>    your_code_here</span></pre><p id="570b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将其余的功能放在同一个文件夹中，这样更容易！</p><p id="b5f8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面是根据<a class="ae ms" href="https://cloud.google.com/functions/docs/writing/background" rel="noopener ugc nofollow" target="_blank">谷歌</a>对事件和背景的定义:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ff13" class="mn lb iq mj b gy mo mp l mq mr">event (dict):  The dictionary with data specific to this type of<br/>         event. The `data` field contains the PubsubMessage message. <br/>context (google.cloud.functions.Context): The Cloud Functions event<br/>         `timestamp` field contains the publish time.</span></pre><p id="b521" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以别管他们了！</p><p id="e2e2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个. gcloudignore文件。这个文件类似于一个. gitignore，但是用于云部署。您可以包含不想部署的文件(比如您保存在文件夹中用于本地测试的密钥)</p><p id="e7ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用所需的包创建一个requirements.txt文件。</p><p id="0367" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在运行过程中，您可能需要保存一些文件，但是您的云函数的根是只读的！您需要使用<code class="fe mu mv mw mj b">/temp/</code>目录来存放临时文件和可修改文件。</p><p id="236d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">是时候部署了！</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d31f" class="mn lb iq mj b gy mo mp l mq mr">gcloud functions deploy my_pipeline_name  --runtime python37<br/>--trigger-topic my_pipeline_topic --timeout 540</span></pre><p id="52bb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里有一个很大的限制！根据<a class="ae ms" href="https://cloud.google.com/functions/docs/concepts/exec#timeout" rel="noopener ugc nofollow" target="_blank">文档</a>，云功能的最大超时为9分钟。</p><p id="bda9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">查看<a class="ae ms" href="https://medium.com/google-cloud/simple-serverless-data-pipeline-on-google-cloud-platform-ab8941ce0f8e" rel="noopener">兹登科的</a>文章和GitHub了解更多详情。</p><h1 id="b269" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤4:在UI上测试</h1><p id="dc66" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">转到GCP UI上的云功能，然后单击功能名称，它会将您重定向到一个名为“功能详细信息”的新页面，其中有最新的部署版本</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/c0bc70db8ca15808281590956e27bb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i1VRKneQt8LD8ornTshLjA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">云功能详细信息</p></figure><p id="b6d7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在general选项卡中，您可以找到调用、执行时间、内存使用和活动实例。所有这些都是计费的重要因素(我知道云功能很便宜，但跟踪成本是一种很好的做法)。可以参考你Romin的关于<a class="ae ms" href="https://rominirani.com/google-cloud-functions-tutorial-pricing-9cc6dc47f7c0" rel="noopener ugc nofollow" target="_blank">云函数</a>定价的文章。</p><p id="5215" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以点击顶部中间的“编辑”,更改内存、功能或…</p><p id="4cd7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">单击Source，您将找到已部署的文件，您可以单击edit在线修改它们(不推荐)。</p><p id="dd6c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">转到测试选项卡，点击<code class="fe mu mv mw mj b">TEST THE FUNCTION</code>，代码将运行，如果有任何问题，将返回一个错误。但这是对云功能的测试，Pub/Sub和Scheduler呢？</p><p id="34d0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以从导航菜单进入“云调度程序”，您会在您的作业名称前找到一个<code class="fe mu mv mw mj b">Run Now</code>按钮。你可以用它来测试和检查<code class="fe mu mv mw mj b">Result</code>栏下的信息。</p><h1 id="6fec" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第五步:密钥</h1><p id="6664" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">我不喜欢在代码中部署我的秘密密钥，这里我将回顾一下我处理秘密的两个最佳选择。</p><p id="a5ce" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第一个是将环境变量添加到云函数中。您可以使用UI或命令行。这个选项不是我最喜欢的，因为首先秘密就在UI中，其次我必须再次为其他功能部署它。</p><p id="390e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第二个选择是使用GCP的秘密经理。我将从Dustin关于管理云函数秘密的帖子中借用一些材料。</p><p id="08c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在可以用云壳了。图标在搜索栏的右上方。</p><p id="46d1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">启用“机密管理器API”:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cf7e" class="mn lb iq mj b gy mo mp l mq mr">gcloud services enable secretmanager.googleapis.com<!-- --> </span></pre><p id="53e2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创造一个秘密:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="db50" class="mn lb iq mj b gy mo mp l mq mr">echo -n "your secret text here" | \<br/>    gcloud beta secrets create my-secret \<br/>      --data-file=- \<br/>      --replication-policy automatic</span></pre><p id="5267" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你的秘密文件中有双引号，那就用单引号括起来。</p><p id="07fd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">编写一个函数来检索您的秘密:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8995" class="mn lb iq mj b gy mo mp l mq mr">import os<br/>from google.cloud import secretmanager<br/>import json<br/>def get_secret<em class="my">(</em>secret_name<em class="my">)</em>:<br/>    client = secretmanager.SecretManagerServiceClient<em class="my">()<br/>    </em>project_id = 'my_gcp_project'<br/>    resource_name = f"projects/<em class="my">{</em>project_id<em class="my">}</em>/secrets/<em class="my">{</em>secret_name<em class="my">}</em>/versions/latest"<br/>    response = client.access_secret_version<em class="my">(</em>resource_name<em class="my">)<br/>    </em>secret_string = response.payload.data.decode<em class="my">(</em>'UTF-8'<em class="my">)<br/>    </em>secret_string = json.loads<em class="my">(</em>secret_string<em class="my">)<br/>    </em>return secret_string</span></pre><p id="9010" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以在剩下的代码中调用这个函数来检索您的密钥。确保将“google-cloud-secret-manager”添加到您的需求文件中。</p><p id="4d88" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你准备好了！去UI测试！</p><h1 id="126c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第六步:连接回购</h1><p id="6ce6" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">即使您可以从本地部署，Google也提供了一个<a class="ae ms" href="https://cloud.google.com/functions/docs/deploying/repo" rel="noopener ugc nofollow" target="_blank">选项</a>，用于从GitHub或BitBucket之类的源代码控件进行部署。让我们一步一步来。</p><p id="ad0d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae ms" href="https://cloud.google.com/source-repositories/docs/mirroring-a-bitbucket-repository" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">镜幽库</strong> </a></p><ol class=""><li id="aeb2" class="mz na iq ke b kf kg kj kk kn nb kr nc kv nd kz ne nf ng nh bi translated">在Google Cloud控制台中，打开云源代码库。</li><li id="f822" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated"><a class="ae ms" href="https://source.cloud.google.com/repos" rel="noopener ugc nofollow" target="_blank">开放云源代码库</a></li><li id="caaa" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">点击<strong class="ke ir">添加存储库</strong>。</li><li id="7e68" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">将打开<strong class="ke ir">添加存储库</strong>页面。</li><li id="91ff" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">选择<strong class="ke ir">连接外部库</strong>并点击<strong class="ke ir">继续</strong>。</li><li id="f3dd" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">将打开<strong class="ke ir">连接外部存储库</strong>页面。</li><li id="a5b0" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">在<strong class="ke ir">项目</strong>下拉列表中，选择镜像存储库所属的Google Cloud项目。</li><li id="ba6e" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">在<strong class="ke ir"> Git提供者</strong>下拉列表中，选择<strong class="ke ir"> Bitbucket </strong>。</li><li id="3819" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">选中复选框以授权云源存储库存储您的凭据。</li><li id="24dc" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">点击<strong class="ke ir">连接到铲斗</strong>。</li><li id="c0c4" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">使用您的机器用户凭据登录Bitbucket。</li><li id="2109" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">点击<strong class="ke ir">授权GoogleCloudPlatform </strong>。</li><li id="a929" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">此选项授予Google Cloud对您的存储库的读取权限。</li><li id="8c55" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">授权完成后，您将返回到<strong class="ke ir">连接外部存储库</strong>页面。将打开存储库列表。</li><li id="8ab8" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">从存储库列表中，选择要镜像的存储库。</li><li id="b085" class="mz na iq ke b kf ni kj nj kn nk kr nl kv nm kz ne nf ng nh bi translated">点击<strong class="ke ir">连接选中的库</strong>。</li></ol><p id="1004" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在左上方的“云资源存储库”下方，您可以找到您的存储库的名称以及活动分支。点击下拉菜单，更改查看其余分支。</p><p id="1b02" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">从云回购部署</strong></p><p id="368a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以使用以下命令从云源存储库部署到云功能:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6928" class="mn lb iq mj b gy mo mp l mq mr">gcloud functions deploy my_pipeline_name \<br/>  --source <a class="ae ms" href="https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/google_ads/[folder" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/[folder</a>_under_that_branch]/ \<br/>  --runtime python37 \<br/>  --trigger-topic my_pipeline_topic --timeout 540</span></pre><p id="685f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在检查你的功能，版本应该增加。前往<code class="fe mu mv mw mj b">TESTING</code>选项卡，享受通过测试的乐趣吧！</p><p id="b510" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在您已经将您的存储库镜像到“云源存储库”了，如果您检查您的云函数的源代码，您会看到它现在指向您的repo！</p><p id="8949" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这一步似乎是多余的，因为您可以从本地部署，但是让我们进入下一步。</p><h1 id="dfda" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第七步:CI/CD</h1><p id="fd80" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">到目前为止，我们已经学习了如何从本地和从云repo进行部署，下面让我们学习如何设置CI/CD！</p><p id="ba43" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您需要在您的目录中添加一个“cloudbuild.yaml ”,并放入以下内容:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4464" class="mn lb iq mj b gy mo mp l mq mr">steps:<br/>- name: gcr.io/cloud-builders/gcloud<br/>  args:<br/>    - functions<br/>    - deploy<br/>    - my_pipeline_name<br/>    - --source=https://source.developers.google.com/projects/[<a class="ae ms" href="https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/google_ads/[folder" rel="noopener ugc nofollow" target="_blank">gcp_project_name</a>]/repos/<a class="ae ms" href="https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/google_ads/[folder" rel="noopener ugc nofollow" target="_blank">[cloud_source_repository_root]</a>/moveable-aliases/<a class="ae ms" href="https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/google_ads/[folder" rel="noopener ugc nofollow" target="_blank">[branch]</a>/paths/google_ads/<a class="ae ms" href="https://source.developers.google.com/projects/[gcp_project_name]/repos/[cloud_source_repository_root]/moveable-aliases/[branch]/paths/google_ads/[folder" rel="noopener ugc nofollow" target="_blank">[folder</a>_under_that_branch]/<br/>    - --trigger-topic=my_pipeline_topic<br/>    - --runtime=python37<br/>    - --timeout=540</span></pre><p id="7bd7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在从GCP的导航菜单转到云构建，转到触发器，并点击“创建新的”。现在应该是直截了当了！给你的触发器一个名称和描述。我想在每次推送到分支时触发构建，所以将选择该选项。在source部分，我将找到步骤6中的镜像repo，并输入分支的名称。</p><p id="fd84" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于构建配置保存在cloudbuild中，我将选择第一个选项，并将路径复制并粘贴到YAML文件。</p><p id="3cc0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一切就绪，单击“创建”并享受您的CI/CD管道！</p></div></div>    
</body>
</html>