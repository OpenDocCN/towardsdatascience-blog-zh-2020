# åœ¨ Docker ä¸Šè¿è¡Œã€ä¿æŠ¤å’Œéƒ¨ç½²å¼¹æ€§å †æ ˆğŸ³

> åŸæ–‡ï¼š<https://towardsdatascience.com/running-securing-and-deploying-elastic-stack-on-docker-f1a8ebf1dc5b?source=collection_archive---------4----------------------->

## åœ¨ Docker ä¸Šä¸ºå°è§„æ¨¡ç”Ÿäº§éƒ¨ç½²å’Œå¼€å‘æ„å»ºå’Œé…ç½®å¼¹æ€§å †æ ˆ(ELK)

## ä»€ä¹ˆæ˜¯å¼¹æ€§å åŠ ï¼Ÿ

Elastic Stack(åˆå **ELK** )æ˜¯æ‚¨ç»„ç»‡çš„é›†ä¸­å¼ç»“æ„åŒ–æ—¥å¿—è®°å½•çš„å½“å‰é¦–é€‰å †æ ˆã€‚å®ƒ**æ”¶é›†**ã€**å¸æ”¶**ã€**å­˜å‚¨**æ‚¨çš„æœåŠ¡æ—¥å¿—(ä»¥åŠæŒ‡æ ‡),åŒæ—¶**ä½¿å®ƒä»¬å¯æœç´¢&å¯èšé›†&å¯è§‚å¯Ÿ**ã€‚ç„¶åï¼ŒåŸºäºè¿™äº›æ•°æ®æ„å»ºè­¦æŠ¥å’Œä»ªè¡¨æ¿ã€‚

![](img/007c32bf94cb4a4a66c185d155473c6e.png)

æ´»åŠ¨ä¸­çš„å¼¹æ€§å †æ ˆã€‚

## è¿è¡Œå¼¹æ€§å †æ ˆ

åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Docker&Docker-Compose**ç¼–å†™**ã€**é…ç½®**ã€**å®‰å…¨**ã€**éƒ¨ç½²**å¼¹æ€§å †æ ˆã€‚æˆ‘ä»¬å°†æ„å»ºçš„å†…å®¹å¯ç”¨äº docker ä¸»æœºä¸Šçš„**å¼€å‘**å’Œ**å°è§„æ¨¡ç”Ÿäº§éƒ¨ç½²**ã€‚

*   ä¸ºæ¯ä¸ªç»„ä»¶æ„å»ºä¸€ä¸ªæ˜ åƒã€‚
*   å‚æ•°åŒ–é…ç½®&é¿å…ç¡¬ç¼–ç å‡­è¯ã€‚
*   å°† Elasticsearch è®¾ç½®ä¸ºå¯æ‰©å±•çš„ç”Ÿäº§å•èŠ‚ç‚¹é›†ç¾¤ã€‚
*   è®¾ç½®å®‰å…¨æ€§å’ŒåŠ å¯†ã€‚
*   åœ¨å®¹å™¨å¤–ä¿å­˜ç§˜å¯†ã€è¯ä¹¦å’Œæ•°æ®ã€‚
*   åœ¨ Docker-Compose ä¸­å°†æ‰€æœ‰å†…å®¹ç»„åˆåœ¨ä¸€èµ·ã€‚

**è¦è·³è¿‡é€æ­¥æ•™ç¨‹**ä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„ [Elastdocker](https://github.com/sherifabdlnaby/elastdocker) æ¨¡æ¿åº“ï¼Œç”¨ä¸€ä¸ªå‘½ä»¤åœ¨ Docker **ä¸Šæ—‹è½¬å¼¹æ€§å †æ ˆã€‚**

[](https://github.com/sherifabdlnaby/elastdocker) [## sherifabdlnaby/elastdocker

### ç”¨åƒ Curatorï¼ŒRubbanï¼ŒElastAlert è¿™æ ·çš„å·¥å…·è¿›è¡Œé¢„è­¦ã€‚å¼¹æ€§å †æ ˆ(åˆå ELK) Docker ç»„æˆï¼Œé¢„é…ç½®â€¦

github.com](https://github.com/sherifabdlnaby/elastdocker) 

```
git clone [https://github.com/sherifabdlnaby/elastdocker.git](https://github.com/sherifabdlnaby/elastdocker.git)
cd elastdocker
make setup & make elk
```

> Elastdocker template å…·æœ‰æ›´å®Œå–„çš„é…ç½®å’Œæ›´å¥½çš„å®‰å…¨æ€§ï¼Œä»¥åŠç»å¸¸ä¸ Elastic Stack ä¸€èµ·ä½¿ç”¨çš„ç›‘æ§å’Œå·¥å…·ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæœ¬æ•™ç¨‹ä¸­çœç•¥äº†è¿™äº›é¢å¤–çš„å†…å®¹ã€‚

# æ­¥ä¼

1.  ä¸ºæˆ‘ä»¬çš„å †æ ˆåˆ›å»º Docker æ˜ åƒ(ä½¿ç”¨æˆ‘ä»¬çš„é…ç½®)ã€‚
2.  åˆ›å»ºä¸€ä¸ªè®¾ç½®å®¹å™¨æ¥ç”Ÿæˆ Elasticsearch å¯†é’¥åº“å’Œè¯ä¹¦ã€‚
3.  ä½¿ç”¨ Docker-Compose å°†å †æ ˆæ”¾åœ¨ä¸€èµ·ã€‚
4.  å¼€å§‹è¿é€æ—¥å¿—ï¼ğŸ‰

# 1.ä¸ºæˆ‘ä»¬çš„å †æ ˆåˆ›å»º Docker å›¾åƒã€‚

è®©æˆ‘ä»¬ä»åˆ¶ä½œæ ¹ç›®å½•`elk`å¼€å§‹ï¼Œåˆ›å»ºäº”ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼›`elasticsearch`ã€`logstash`ã€`kibana`ã€`setup`å’Œ`secrets`ç›®å½•ã€‚

å¦å¤–ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`.env`æ–‡ä»¶æ¥ä¿å­˜æˆ‘ä»¬çš„å‚æ•°ã€‚

## å¼¹æ€§æœç´¢

åœ¨`./elasticsearch`ç›®å½•ä¸­åˆ›å»º`Dockerfile`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

ç„¶åæˆ‘ä»¬è¿˜å°†`elasticsearch.yml`æ·»åŠ åˆ°`./elastichsearch/config/` ç›®å½•ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶å°†åœ¨å®¹å™¨å¯åŠ¨æ—¶åŠ è½½ä»¥é…ç½® elasticsearchã€‚

*   æ³¨æ„`${ELASTIC_XXX}`é…ç½®å°†ä»å®¹å™¨çš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼Œæˆ‘ä»¬ç¨åå°†åœ¨è¿è¡Œæ—¶ä¼ é€’è¿™äº›å˜é‡ã€‚

**Logstash** åœ¨`./logstash`ç›®å½•ä¸‹åˆ›å»º`Dockerfile`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

å°†`logstash.yml`æ·»åŠ åˆ°`logstash/config`ç›®å½•ä¸­ã€‚

å°†`logstash.conf`æ·»åŠ åˆ°`logstash/pipeline`ç›®å½•ä¸­ã€‚

ä» Beats = to => Elasticsearch è½¬å‘æ•°æ®çš„ç®€å•ç®¡é“ã€‚

## åŸºå·´çº³

åœ¨`kibana`ç›®å½•ä¸­åˆ›å»º`Dockerfile`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

å°†`kibana.yml`æ·»åŠ åˆ°`kibana\config`ç›®å½•:

# 2.åˆ›å»ºä¸€ä¸ªè®¾ç½®å®¹å™¨æ¥ç”Ÿæˆ Elasticsearch å¯†é’¥åº“å’Œè®¤è¯

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥ç”Ÿæˆ Elasticsearch å¯†é’¥åº“ï¼Œå…¶ä¸­åŒ…å« Elasticsearch çš„ç”¨æˆ·(å’Œè¶…çº§ç”¨æˆ·)å¯†ç ï¼Œä»¥åŠå…¶ä»–å‡­è¯(ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ S3 æ’ä»¶ï¼Œå°±åƒ AWS å¯†é’¥ä¸€æ ·)ã€‚
è¯¥å¯†é’¥åº“ç”± Elasticsearch docker æ˜ åƒä¸­çš„`*elasticsearch-keystore*` *åˆ›å»ºã€‚*

**2.1** å¢åŠ `setup-keystore.sh`åˆ°`/setup`

è¿™ä¸ªè„šæœ¬åˆ›å»ºä¸€ä¸ª Keystore å¹¶å°†å…¶å†™å…¥`/secrets/elasticsearch.keystore`ï¼Œç„¶åå°†`$ELASTIC_PASSWORD`æ·»åŠ ä¸ºé»˜è®¤è¶…çº§ç”¨æˆ·`elastic`ï¼Œç¨åæˆ‘ä»¬å°†ä½¿ç”¨`docker-compose`å°†`$ELASTIC_PASSWORD`ä¼ é€’ç»™å®‰è£…å®¹å™¨ã€‚

**2.2** å¢åŠ `setup-certs.sh`åˆ°`/setup`

è¯¥è„šæœ¬åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„å•ä¸ª PKCS#12 å¯†é’¥åº“ï¼Œå…¶ä¸­åŒ…æ‹¬èŠ‚ç‚¹è¯ä¹¦ã€èŠ‚ç‚¹å¯†é’¥å’Œ CA è¯ä¹¦ã€‚

**2.3** åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º`docker-compose.setup.yml`å°†å¯åŠ¨å®‰è£…å®¹å™¨ã€‚

è¿™ä¸ª`docker-compose`åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼Œå®ƒä½¿ç”¨æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„è„šæœ¬ç”Ÿæˆå¯†é’¥åº“å’Œè¯ä¹¦ã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ:

```
docker-compose -f docker-compose.setup.yml run --rm keystore
docker-compose -f docker-compose.setup.yml run --rm certs
```

è¿™å°†åˆ›å»ºå®¹å™¨ï¼Œå¹¶åœ¨å®Œæˆæ—¶åˆ é™¤å®ƒä»¬ä»¥èŠ‚çœç©ºé—´ã€‚å°†å…¶è¾“å‡ºä¿å­˜åˆ°`/secrets`ç›®å½•ã€‚

# 3.ä½¿ç”¨ Docker-Compose å°†å †æ ˆæ”¾åœ¨ä¸€èµ·ã€‚

æœ€åï¼Œåˆ›å»ºä¸»`docker-compose.yml`æ–‡ä»¶ï¼Œå°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€èµ·ã€‚

Docker-Compose æ–‡ä»¶ä¸­æœ‰ä»€ä¹ˆï¼Ÿ

1.  æˆ‘ä»¬å£°æ˜ Elasticsearch çš„å®¹é‡å°†æŒä¹…å­˜å‚¨æ•°æ®ã€‚
2.  æˆ‘ä»¬å£°æ˜ä¼ é€’ç»™ Elasticsearch çš„ç§˜å¯†å¯†é’¥åº“ï¼Œå®ƒåŒ…å«å‡­è¯(ç›®å‰åªæœ‰è¶…çº§ç”¨æˆ·å¯†ç ï¼Œä½†æ˜¯ä»¥åå¯ä»¥é€šè¿‡æ‰©å±•`setup-keystore.sh`è„šæœ¬æ¥ä¿å­˜è®¸å¤šå…¶ä»–å‡­è¯)
3.  æˆ‘ä»¬å£°æ˜ ELK çš„ 3 ä¸ªæœåŠ¡(Elasticsearchã€Logstash å’Œ Kibana)
    ä¼ é€’æ„å»ºå›¾åƒå’Œè¿è¡Œå®¹å™¨æ‰€éœ€çš„ç¯å¢ƒå˜é‡ï¼Œå¬å›æ‰€æœ‰åŒ…å«`${ELASTIC_XXX}`é…ç½®çš„é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¿…é¡»åœ¨è¿™é‡Œçœ‹åˆ°å®ƒä»¬è¢«ä¼ é€’ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰åœ¨`Docker-Compose`æ–‡ä»¶ä¸­ç¡¬ç¼–ç å®ƒä»¬çš„å€¼ï¼Œè€Œæ˜¯åœ¨`.env`æ–‡ä»¶ä¸­å£°æ˜æ‰€æœ‰å†…å®¹ï¼Œè¿™æ ·å®ƒå°±ä¿å­˜äº†æ‰€æœ‰å‚æ•°ã€‚
4.  æˆ‘ä»¬è¿˜å£°æ˜äº† Elasticsearch çš„æ¨èè®¾ç½®ï¼Œå¦‚`ulimit`å’Œ`ES_JAVA_OPTS`ï¼Œå¹¶ä¸ºå †æ ˆç»„ä»¶è®¾ç½®äº†å †å¤§å°ã€‚

**å°†æ‰€æœ‰å‚æ•°æ·»åŠ åˆ°** `**.env**` **æ–‡ä»¶**

## å¯åŠ¨å †æ ˆ

è¿è¡Œä»¥ä¸‹å‘½ä»¤:

**è®¾ç½®(ä»…è¿è¡Œä¸€æ¬¡)**

```
docker-compose -f docker-compose.setup.yml run --rm keystore
docker-compose -f docker-compose.setup.yml run --rm certs
```

**å¯åŠ¨å¼¹æ€§å †æ ˆ**

```
docker-compose up -d
```

**å‰å¾€**[localhost:5601](http://localhost:5601)
**ç”¨æˆ·å** : `elastic`
**å¯†ç ** : `changeme`

![](img/ac65890067532479e39aab25615655aa.png)

ç™»å½•å¼¹æ€§åŸºå·´çº³

# 4.å¼€å§‹è¿é€æ—¥å¿—ï¼ğŸ‰

æ‚¨ç°åœ¨å¯ä»¥å¼€å§‹å°†æ—¥å¿—å’ŒæŒ‡æ ‡å‘é€åˆ° Elastic Stackã€‚
1ã€‚[ä½¿ç”¨ Filebeat ä»æœåŠ¡ä¸­å‘é€æ—¥å¿—](http://localhost:5601/app/kibana#/home/tutorial_directory/logging)ã€‚
2ã€‚[ä½¿ç”¨ Metricbeat ä»æœåŠ¡ä¸­å‘é€æŒ‡æ ‡ã€‚](http://localhost:5601/app/kibana#/home/tutorial_directory/metrics)
ç›´æ¥åˆ° Elasticsearch æˆ–è€…ç”¨ Logstash æ‘„å–ã€‚å¹¶åœ¨ Kibana çš„å‘ç°çª—å£ä¸­æµè§ˆå®ƒä»¬ã€‚

> æœ‰è®¸å¤šæŒ‡å—å¯ä»¥å¸®åŠ©ä½ å°†åŸæœ¨è¿é€åˆ°å¼¹æ€§å †ä¸Šã€‚

# ä»è¿™é‡Œå»å“ªé‡Œï¼Ÿ

æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥å¢å¼ºè¿™ç§ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨è‡ªæˆ‘ç›‘æ§ï¼Œæˆ–æ·»åŠ  Prometheus Exporters ä»¥ä½¿ç”¨ Grafana ç›‘æ§å †æ ˆï¼Œé™¤äº†æˆ‘ä»¬å¯ç”¨çš„å†…éƒ¨èŠ‚ç‚¹ä¼ è¾“åŠ å¯†ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä¸º HTTP å±‚å¯ç”¨ SSLï¼Œä¸ºæ˜ åƒæ·»åŠ å¥åº·æ£€æŸ¥ï¼Œä½¿ç”¨ ElastAlert æˆ– Curator ç­‰å·¥å…·æ¥åˆ©ç”¨å †æ ˆï¼Œå‘é›†ç¾¤æ·»åŠ æ›´å¤šèŠ‚ç‚¹ã€‚

## ä½¿ç”¨ [Elastdocker](https://github.com/sherifabdlnaby/elastdocker) ä»£æ›¿ã€‚

[Elastdocker](https://github.com/sherifabdlnaby/elastdocker) æ˜¯ä¸€ä¸ªæ¨¡æ¿åº“ï¼Œæ‹¥æœ‰æˆ‘ä»¬åˆšåˆšåˆ¶ä½œçš„æ›´å¤æ‚ç‰ˆæœ¬çš„å¼¹æ€§å †æ ˆè®¾ç½®ï¼ŒåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æ‰€æœ‰è¦ç‚¹ã€‚

[](https://github.com/sherifabdlnaby/elastdocker) [## sherifabdlnaby/elastdocker

### ç”¨åƒ Curatorï¼ŒRubbanï¼ŒElastAlert è¿™æ ·çš„å·¥å…·è¿›è¡Œé¢„è­¦ã€‚å¼¹æ€§å †æ ˆ(åˆå ELK) Docker ç»„æˆï¼Œé¢„é…ç½®â€¦

github.com](https://github.com/sherifabdlnaby/elastdocker) 

## ç¼©æ”¾å¼¹æ€§å †æ ˆ

è¿™ç§è®¾ç½®å¯ä»¥å¤„ç†å°‘é‡ç”Ÿäº§å·¥ä½œè´Ÿè½½ï¼Œä½†æœ€ç»ˆéœ€è¦æ‰©å±•ã€‚

*   æ‚¨éœ€è¦å°†æ ˆç»„ä»¶è§£è€¦ï¼Œä»¥ä¾¿ç‹¬ç«‹åœ°éƒ¨ç½²åˆ°ä¸åŒçš„ docker ä¸»æœºä¸Šã€‚
*   æ‚¨å¯èƒ½éœ€è¦æ·»åŠ é¢å¤–çš„ Elasticsearch èŠ‚ç‚¹ã€‚
*   æ‚¨å¯èƒ½éœ€è¦æ¨ªå‘æ‰©å±• Logstashã€‚
*   å°†å½“å‰è®¾ç½®è½¬æ¢ä¸º Kubernetes è®¾ç½®ï¼Œæ”¹ä¸ºä½¿ç”¨**çª—æ ¼**å’Œ**å›¾è¡¨**ã€‚(å‰ææ˜¯ä½ çš„ç»„ç»‡é‡Œæœ‰ k8ã€‚)

![](img/95c0346053474dac0960fa5a9210504a.png)

åˆ†è§£æˆåŠèˆ±çš„å¼¹æ€§å †æ ˆçš„å¯èƒ½ K8S éƒ¨ç½²

**æ‚¨å¯ä»¥çœ‹çœ‹æ‰˜ç®¡å¼¹æ€§å †æ ˆäº§å“ã€‚**

æœ¬å¸–ä½¿ç”¨çš„ä»£ç :[https://github.com/sherifabdlnaby/medium-elastic-stack](https://github.com/sherifabdlnaby/medium-elastic-stack)