# ä»è¾¹ç¼˜åˆ°äº‘çš„é®ç½©æ£€æµ‹â€”ä½¿ç”¨ TensorFlow å’Œ Kafka

> åŸæ–‡ï¼š<https://towardsdatascience.com/mask-detection-from-the-edge-to-the-cloud-with-tensorflow-and-kafka-1b6668f15a60?source=collection_archive---------47----------------------->

## ä½¿ç”¨ Raspberry Pi å’Œ Coral USB edge TPU åœ¨è¾¹ç¼˜è¿›è¡Œæ¨¡å‹æ¨æ–­

![](img/23a28e30f7ce6b59be658dde2d37d5b9.png)

Benedikt Geyer åœ¨ [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

ä¸€ä¸ªåœ¨è¿™ä¸ªç¤¾ä¼šè·ç¦»è¶Šæ¥è¶Šè¿œçš„æ—¶ä»£ï¼Œç§‘æŠ€æ›´æ–°äº†å®ƒå»ºç«‹ä¸€ä¸ªæ›´å®‰å…¨ä¸–ç•Œçš„æ‰¿è¯ºã€‚çƒ­åƒä»ªã€æ©æ¨¡æ£€æµ‹æœºåˆ¶ä¸æ˜¯ COVID ç–«æƒ…çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å¯ä»¥å¸®åŠ©æ£€æµ‹é£é™©åŒºåŸŸï¼Œå¹¶é€šè¿‡è°ƒæ•´å½“åœ°å…¬å…±æ”¿ç­–æ¥å‡ç¼“é›†ç¾¤çš„å¢é•¿ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æ¦‚è¿°äº†å¦‚ä½•åŸºäºé…å¤‡æ‘„åƒå¤´å’Œäººè„¸æ£€æµ‹äººå·¥æ™ºèƒ½çš„ç‰©è”ç½‘è®¾å¤‡ç½‘ç»œæ„å»ºä¸€ä¸ªç³»ç»Ÿï¼Œä»¥è¯†åˆ«æŸä¸ªç©ºé—´å†…çš„äººä»¬æ˜¯å¦æˆ´ç€é¢ç½©ï¼Œå¹¶æ”¶é›†æ­¤ç±»äº‹ä»¶ã€‚

![](img/3c666ffc1ea6805fafa17b2fa188e705.png)

æ¼”ç¤ºâ€”åœ¨ Pi ä¸Šè¿è¡Œå±è”½æ£€æµ‹ï¼Œå¹¶å‘ Kafka ä¸»é¢˜å‘å‡ºå’Œå‘å¸ƒè­¦æŠ¥â€”å›¾ç‰‡ç”±ä½œè€…æä¾›

æœ¬é¡¹ç›®ä¸­ä½¿ç”¨çš„å·¥å…·æœ‰:

*   é¢å‘äººè„¸æ£€æµ‹æ¨¡å‹(TensorFlow)çš„è¾¹ç¼˜ Pythonã€‚
*   å‰©ä¸‹çš„ä»£ç ç”¨ [Go](https://golang.org/) ç¼–ç¨‹è¯­è¨€ã€‚
*   [Kafka](https://kafka.apache.org/) ç”¨äºæœåŠ¡é—´çš„å¼‚æ­¥é€šä¿¡ã€‚
*   [ç”¨äºæ¨¡å¼å®šä¹‰å’Œæ¶ˆæ¯ä¸²è¡ŒåŒ–çš„åè®®ç¼“å†²å™¨](https://developers.google.com/protocol-buffers)ã€‚
*   ç”¨äºå­˜å‚¨çš„ SQL æ•°æ®åº“( [SQLite](https://www.sqlite.org/index.html) åœ¨è¾¹ç¼˜ï¼Œ [PostgreSQL](https://www.postgresql.org/) åœ¨äº‘ç«¯)ã€‚

è¿™ä¸ªé¡¹ç›®ä½ éœ€è¦ä¸€ä¸ª[æ ‘è“ Pi](https://en.wikipedia.org/wiki/Raspberry_Pi) 4 å’Œå®ƒçš„[ç›¸æœº](https://projects.raspberrypi.org/en/projects/getting-started-with-picamera)ã€‚æˆ‘è¿˜ä½¿ç”¨äº†ä¸€ä¸ª [Coral USB åŠ é€Ÿå™¨](https://coral.ai/products/accelerator/)æ¥æ›´å¿«åœ°æ¨æ–­åœ†å‘¨ç‡ã€‚

![](img/9a39499bfbbad2f212fef840d54a5206.png)

ç”¨äºæ”¶é›†å’Œå¤„ç†äº‹ä»¶â€œè¿™ä¸ªäººæ²¡æœ‰æˆ´é¢å…·â€çš„æ¶æ„çš„å¤§å›¾â€”äº‹ä»¶é©±åŠ¨çš„æ¶æ„â€”å›¾ç‰‡ç”±ä½œè€…æä¾›

ä¸ä»»ä½•æ¶æ„å’Œå·¥å…·é€‰æ‹©ä¸€æ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªå›ºæ‰§å·±è§çš„é—®é¢˜ã€‚æˆ‘åœ¨æ–‡ç« çš„æœ€åç•¥å¾®é˜è¿°äº†æˆ‘é€‰æ‹©çš„å·¥å…·çš„ä¼˜ç‚¹ã€ç¼ºç‚¹ã€å±€é™æ€§å’Œä¼˜åŠ¿ã€‚ä½ æœ‰ä»€ä¹ˆçƒ¦å¿ƒäº‹å—ï¼Ÿå¤§å®¶åœ¨è¯„è®ºé‡Œè®¨è®ºä¸€ä¸‹å§ã€‚ğŸ˜‰

# æ·±æ½œ

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°è¿™ä¸ªä½“ç³»ç»“æ„çš„æ¯ä¸ªç»„ä»¶ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªç³»ç»Ÿåˆ†æˆä¸‰ä¸ªä¸åŒçš„éƒ¨åˆ†ã€‚å®Œæ•´çš„ä»£ç å¯ä»¥ä»æˆ‘çš„ GitHub è·å¾—ã€‚

1.  ä» Raspberry Pi æ‘„åƒå¤´é¦ˆé€ä¸­æ£€æµ‹æŸäººæ˜¯å¦æˆ´ç€é¢å…·ã€‚ã€github.com/fpaupier/pi-mask-detectionã€‘-
2.  ä» Pi åˆ° Google Cloud å¼•æ“çš„äº‹ä»¶æ”¶é›†å’Œåˆ†å‘:
    -[github.com/fpaupier/alertDispatcher](https://github.com/fpaupier/alertDispatcher)-
    -[github.com/fpaupier/alertIngress](https://github.com/fpaupier/alertIngress)
3.  äº‹ä»¶çš„è¿›ä¸€æ­¥å¤„ç†:
    -[github.com/fpaupier/notifyMask](https://github.com/fpaupier/notifyMask)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿™äº›ç»„ä»¶ä¹‹é—´çš„è”ç³»ã€‚

## 1.æ©æ¨¡æ£€æµ‹

åœ¨æˆ‘ä»¬ç³»ç»Ÿçš„è¾¹ç¼˜ï¼Œé…å¤‡äº†ä¸€ä¸ª Piï¼Œå®ƒçš„æ‘„åƒå¤´æ£€æµ‹æ˜¯å¦æœ‰*äº‹ä»¶*å‘ç”Ÿã€‚æˆ‘å°†äº‹ä»¶å®šä¹‰ä¸º:â€œ*æŸäººæ²¡æœ‰æˆ´é¢å…·ã€‚â€*

![](img/efc67b4102998571c60fc3c22aa75d4a.png)

ä½œè€…å›¾ç‰‡

ä¸ºäº†æ£€æµ‹æŸäººæ˜¯å¦æˆ´ç€é¢å…·ï¼Œæˆ‘ä»¬éµå¾ªä»¥ä¸‹æ­¥éª¤:

1.  æ£€æµ‹å½“å‰ç”»é¢ä¸­æ˜¯å¦æœ‰äººè„¸( [MobileNet v2](https://ai.googleblog.com/2018/04/mobilenetv2-next-generation-of-on.html) )
2.  å¦‚æœæ˜¯ï¼Œå°†å›¾åƒè£å‰ªåˆ°è¯¥é¢éƒ¨è¾¹ç•Œæ¡†ã€‚
3.  åœ¨è£å‰ªçš„é¢ä¸Šåº”ç”¨é®ç½©/æ— é®ç½©äºŒå…ƒåˆ†ç±»å™¨ã€‚([å‹å·](https://github.com/fpaupier/pi-mask-detection/tree/master/models/mask_detector)ä¸ºæ­¤é¡¹ç›®åŸ¹è®­)
4.  å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ©ç ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚

é€»è¾‘è¯¦è§æˆ‘çš„`[detect_mask.py](https://github.com/fpaupier/pi-mask-detection/blob/master/detect_mask.py)`çš„`main()`åŠŸèƒ½

## 2.æ”¶é›†äº‹ä»¶

ä¸€æ—¦ Pi è®°å½•äº†ä¸€ä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬å°±å°†å…¶å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œå­˜æ¡£å’Œè¿›ä¸€æ­¥å¤„ç†ã€‚

![](img/28ac5abbee47db5add78628e69fc6934.png)

ä½œè€…å›¾ç‰‡

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Pi ä¸Šç›´æ¥è¿è¡Œé€šçŸ¥ç³»ç»Ÿã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçš„ç›®æ ‡æ˜¯è¯´æ˜ä¸€ä¸ªç”±å‡ ä¸ªç‰©è”ç½‘è®¾å¤‡æŠ¥å‘Šäº‹ä»¶çš„ç³»ç»Ÿã€‚è¿›ä¸€æ­¥çš„å¤„ç†æ˜¯åœ¨äº‘ä¸Šå®Œæˆçš„ï¼Œä»¥ä¾¿åœ¨ 1)è¾¹ç¼˜çš„äº‹ä»¶æ”¶é›†å’Œ 2)å—æ§ç¯å¢ƒä¸­çš„é«˜çº§å¤„ç†ä¹‹é—´è¿›è¡Œé€‚å½“çš„åˆ†ç¦»ã€‚

è€ƒè™‘è¿™éƒ¨åˆ†çš„ä¸¤ä¸ªå­˜å‚¨åº“:

*   [github.com/fpaupier/alertDispatcher](https://github.com/fpaupier/alertDispatcher)ä¸ºåœ†å‘¨ç‡ä¸Šè¿è¡Œçš„ä»£ç å‘å¸ƒäº†ä¸€ä¸ªå¡å¤«å¡ä¸»é¢˜çš„æç¤ºã€‚
*   [github.com/fpaupier/alertIngress](https://github.com/fpaupier/alertIngress)ç”¨äºåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ä»£ç ï¼Œè®¢é˜… Kafka ä¸»é¢˜å¹¶å°†æ¥è‡ªä¸åŒè®¾å¤‡çš„è­¦æŠ¥å­˜å‚¨åˆ° PostgreSQL å®ä¾‹ä¸­ã€‚

æ¯ä¸ªè®¾å¤‡å°†å…¶äº‹ä»¶å‘å¸ƒåˆ° Kafka ä¸»é¢˜â€”â€œ*è­¦æŠ¥â€”ä¸»é¢˜*â€â€”ç”¨äº Pi å’Œè­¦æŠ¥å…¥å£æœåŠ¡ä¹‹é—´çš„å¼‚æ­¥é€šä¿¡ã€‚äº‹ä»¶æ¶ˆæ¯ç¬¦åˆä½¿ç”¨[åè®®ç¼“å†²åŒºå®šä¹‰çš„æ¨¡å¼ã€‚](https://developers.google.com/protocol-buffers)

åœ¨äº‘ä¸Šï¼Œalert ingress æœåŠ¡è®¢é˜…äº† *alert-topic* ï¼Œå¹¶å°†ä¼ å…¥çš„äº‹ä»¶å­˜æ¡£åœ¨ PostgreSQL ä¸­ã€‚ç„¶åï¼Œå…¥å£æœåŠ¡å‘å¸ƒé€šçŸ¥æœåŠ¡å°†ä½¿ç”¨çš„æ¶ˆæ¯ã€‚

## 3.é€šçŸ¥æœåŠ¡

![](img/e606cbaaf30d27cbd336c996aca7e097.png)

ä½œè€…å›¾ç‰‡

æ‚¨å·²ç»å°†äº‹ä»¶å­˜æ¡£åœ¨äº‘ä¸­ï¼Œç°åœ¨è¯¥æ€ä¹ˆåŠï¼Ÿè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé€šçŸ¥æœåŠ¡ï¼Œå‘ç®¡ç†å‘˜å‘é€åŒ…å«äº‹ä»¶æ‘˜è¦çš„ç”µå­é‚®ä»¶ã€‚

![](img/64f403cf49c892ddb1b5a1c229cf3d77.png)

é€šçŸ¥æœåŠ¡å‘é€çš„ç”µå­é‚®ä»¶-ä½œè€…å›¾ç‰‡

ä¸€ä¸ªæœ‰è¶£çš„åç»­å·¥ä½œæ˜¯æ„å»ºä¸€ä¸ªåœ°ç†å¯è§†åŒ–å·¥å…·æ¥åˆ†ææ¯ä¸ªä½ç½®å’Œæ—¶é—´çš„äº‹ä»¶ğŸ“ğŸ—º

## æ”¹è¿›çš„ä½™åœ°

è¿™ä¸ªåŸå‹è¯´æ˜äº†è¿™ä¸ªæ¦‚å¿µï¼Œä½†ä¸æ˜¯ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„åŸºç¡€è®¾æ–½ã€‚å°†è¿™ä¸€æ¦‚å¿µåº”ç”¨åˆ°ç”Ÿäº§ä¸­éœ€è¦è€ƒè™‘çš„å…³é”®å› ç´ æœ‰:

*   äº‹ä»¶é‡å¤æ•°æ®åˆ é™¤â€”â€”å½“å‰çš„å®æ–½ä¸ºå•ä¸ªè­¦æŠ¥å‘é€å¤šä¸ªé€šçŸ¥ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ºæ¯ä¸ªå¼•å‘çš„è­¦æŠ¥å‘é€ä¸€å°ç”µå­é‚®ä»¶ã€‚æŸä¸ªæ²¡æˆ´é¢å…·çš„äººå¯èƒ½ä¼šå‡ºç°åœ¨æ‘„åƒæœºè§†é¢‘ä¸­ä¸€æ®µæ—¶é—´ã€‚å¯ä»¥åœ¨æœåŠ¡å™¨çº§åˆ«å®æ–½é‡å¤æ•°æ®æ¶ˆé™¤ç­–ç•¥ã€‚
*   æƒ³æƒ³æ‚¨çš„[ä¿ç•™ç­–ç•¥](https://en.wikipedia.org/wiki/Retention_period) â€”å®šä¹‰ä¸€ä¸ªåˆç†çš„æœŸé™ï¼Œåœ¨æ­¤æœŸé™å†…ï¼Œæ‚¨å¯ä»¥å­˜å‚¨è­¦æŠ¥ï¼Œç„¶åå†åˆ é™¤å®ƒä»¬ã€‚æ‚¨ä¸å¸Œæœ›å°†æ•æ„Ÿæ•°æ®(å¦‚äººè„¸)ä¿ç•™ä¸€æ®µä¸ç¡®å®šçš„æ—¶é—´ã€‚
*   [æ¨¡å¼æ³¨å†Œä¸­å¿ƒ](https://docs.cloudera.com/csp/2.0.1/schema-registry-overview/topics/csp-schema_registry_overview.html) â€”æ¨¡å¼æ³¨å†Œä¸­å¿ƒç¡®ä¿è·¨æœåŠ¡çš„ä¸€è‡´æ¶ˆæ¯å®šä¹‰ã€‚æ›´æ–°å’Œå‘åå…¼å®¹æ€§ä¸æ˜¯å°äº‹ã€‚å¦‚æœæ‚¨å†³å®šæ›´æ”¹ã€æ·»åŠ æˆ–åˆ é™¤è­¦æŠ¥äº‹ä»¶ä¸­çš„å­—æ®µï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæ‚¨å¦‚ä½•å°†è¿™ç§å˜åŒ–ä¼ æ’­åˆ°æ‚¨çš„ç‰©è”ç½‘è®¾å¤‡ä¸­ï¼Ÿ
*   æœºå™¨å­¦ä¹ æ¨¡å‹ç®¡ç†-æ‚¨åœ¨è¾¹ç¼˜æ¨é€å’Œéƒ¨ç½²çš„æ¨¡å‹å¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œ[æ¼‚ç§»](https://en.wikipedia.org/wiki/Concept_drift)å¹¶çœ‹åˆ°å…¶æ€§èƒ½ä¸‹é™ï¼Œä»è€Œå¯¼è‡´è¯¯æŠ¥æˆ–æˆ´é¢å…·çš„äººæœªè¢«æŠ¥å‘Šã€‚æ£€æŸ¥ [ML æµç¨‹](https://mlflow.org/)é¡¹ç›®ï¼Œäº†è§£å…³äºè¯¥ä¸»é¢˜çš„è§è§£ã€‚
*   è®¾å¤‡æ³¨å†Œæµç¨‹â€”å¯ä»¥æ‰‹åŠ¨éƒ¨ç½²å’Œè®¾ç½®æ‚¨çš„ç¬¬ä¸€æ‰¹è®¾å¤‡ã€‚åå‡ å¹´åå®ƒå˜æˆäº†æŒ‘æˆ˜ï¼Œä¸€ç™¾å¹´åå®ƒå˜æˆäº†å™©æ¢¦ã€‚è€ƒè™‘ä¸ºåŠ å…¥æ‚¨çš„ç‰©è”ç½‘è®¾å¤‡ç¾¤çš„è®¾å¤‡è‡ªåŠ¨æ‰§è¡Œå…¥èŒæµç¨‹(ä¸‹è½½ ML æ¨¡å‹ï¼Œè·å– Kafka è¯ä¹¦)

## å·¥å…·

**è¯­è¨€é€‰æ‹©â€”** ä¸ºä»€ä¹ˆé€‰æ‹© Python å’Œ Goï¼ŸPython ä¾¿äºä¸ TensorFlow é›†æˆã€‚è¯·ä½¿ç”¨å®ƒçš„å¼ºç±»å‹å’Œå¯¹ç½‘ç»œç›¸å…³æ“ä½œçš„æœ¬æœºæ”¯æŒã€‚

**å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©** â€”ä¸ºä»€ä¹ˆæ˜¯å¡å¤«å¡ï¼Ÿè®¸å¤šå…¶ä»–è§£å†³æ–¹æ¡ˆåœ¨å†…å­˜å ç”¨æ–¹é¢æ›´è½»é‡çº§ï¼Œå¯ä»¥åœ¨è¾¹ç¼˜å®ç°è¿™ä¸ªåŠŸèƒ½( [MQTT](https://mqtt.org/) )ã€‚ä½†æ˜¯ï¼Œéšç€ä»Šå¤©æ—¥ç›Šå¢é•¿çš„è®¡ç®—èƒ½åŠ›çš„è¾¹ç¼˜ï¼Œä¸ºä»€ä¹ˆçƒ¦æ¼å‘¢ï¼Ÿä¸€ä¸ªæ ‘è“ Pi 4 æœ‰ 8Go å†…å­˜ã€‚

**æ¨¡å¼å®šä¹‰ç­–ç•¥â€”** ä¸ºä»€ä¹ˆé€‰æ‹© Protobufsï¼Ÿæˆ‘æ˜ç™½ä½ çš„æ„æ€ï¼›JSON ä½¿ç”¨èµ·æ¥ä¼šæ›´èˆ’æœï¼Œè€Œä¸”åœ¨è¿™é‡Œä¹Ÿèƒ½åšåˆ°ã€‚ä¸ºäº†åƒè¿™æ ·çš„æ¦‚å¿µéªŒè¯ï¼Œä½¿ç”¨ JSON å°†çœå»å¾ˆå¤šéº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä»¬å¤„ç†çš„æ˜¯å•ä¸ªè®¾å¤‡ã€‚ç„¶è€Œï¼Œæ¨¡å¼å®šä¹‰å’Œä¸€è‡´æ€§æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼Œprotobufs ä½¿è¿™å˜å¾—æ›´å®¹æ˜“ã€‚

## ä¼¦ç†è€ƒè™‘

è¿™ç§æƒ³æ³•æœ‰åŠ©äºå®šä½å’Œç¼“è§£é›†ç¾¤çš„å¢é•¿ï¼Œä½†å¯èƒ½ä¼šå¯¹ä¸ªäººéšç§æ„æˆä¸¥é‡å¨èƒã€‚

å…³äºè´Ÿè´£ä»»çš„æœºå™¨å­¦ä¹ çš„èµ„æºå˜å¾—è¶Šæ¥è¶Šå®¹æ˜“è·å¾—ï¼Œæˆ‘é‚€è¯·ä½ åœ¨æ„å»ºåŸºäºäººå·¥æ™ºèƒ½çš„ç³»ç»Ÿæ—¶è®°ä½è¿™äº›æŒ‡å¯¼åŸåˆ™ã€‚

å¦è¯·æ³¨æ„ï¼Œé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹( [GDPR](https://eur-lex.europa.eu/eli/reg/2016/679/oj) )å¯¹ä¸ªäººæ•°æ®çš„æ”¶é›†å’Œå¤„ç†è¿›è¡Œäº†ä¸¥æ ¼çš„è§„å®šã€‚

> æ²¡æœ‰è‰¯çŸ¥çš„ç§‘å­¦æ˜¯æ°¸æ’çš„â€” [*å¼—æœ—ç´¢ç“¦Â·æ‹‰ä¼¯é›·*](https://en.wikipedia.org/wiki/Fran%C3%A7ois_Rabelais) *åœ¨* [*çš„ã€Šå·¨å¤§çš„ç”Ÿå‘½ä¸å·¨å¤§çš„ç—›è‹¦ã€‹*](https://en.wikipedia.org/wiki/Gargantua_and_Pantagruel)