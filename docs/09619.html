<html>
<head>
<title>Follow Along With My Extreme Budget Makeover (ft. the Gmail API)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跟随我的极端预算改造(英尺。Gmail API)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/follow-along-with-my-extreme-budget-makeover-ft-the-gmail-api-2872cc006b60?source=collection_archive---------43-----------------------#2020-07-08">https://towardsdatascience.com/follow-along-with-my-extreme-budget-makeover-ft-the-gmail-api-2872cc006b60?source=collection_archive---------43-----------------------#2020-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="71f6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 Gmail 和 Google Sheets APIs 的端到端支出跟踪器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/194092ac2d071062140a70d8886f2b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jvCFn4P_xzouqFVZ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@blankerwahnsinn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">费边布兰克</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="0985" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2020 年是改善之年——对自己，对政府和现有机构，对消费习惯。我的预算方法拥抱了这一主题，并把自己从一个半可接受的过程(使用<a class="ae kv" rel="noopener" target="_blank" href="/how-i-diyd-my-budget-using-python-for-selenium-and-beautiful-soup-4d2edc5c519">硒和美丽的汤</a>)磨练成一个精炼无缝的过程(使用 Gmail API)。</p><p id="e572" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我第一次偶然发现使用 Gmail 的想法是因为我注意到每次我完成与 Venmo 的交易后都会收到一封电子邮件。这些邮件包含了我预算所需的所有信息——日期、商家和金额。我研究了 Gmail API，看能否解析出这些信息，并将其插入到 Google Sheets 中。这是一个令人惊讶的无痛过程，我发现我可以通过打开任何超过 0.00 美元的交易的电子邮件通知，用我的每张信用卡收到类似的交易电子邮件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/68eb53d5de535cb3f20f0a49152dcced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*DQo8pwudxZ1R5Kn2llN3rA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">打开信用卡交易通知的选项</p></figure><p id="605c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与我以前使用 Selenium 和 Beautiful Soup 的方法不同，使用 Gmail API 提供了更好的安全性和对历史数据的访问。API 只需要一个认证步骤，并且不需要本地机器上的明文密码。您还可以在收件箱中检索任何过去的交易，只要电子邮件格式没有改变。然后，我使用 Google Sheets API 上传所有这些检索到的事务，以便于查看、分类和聚合。这些实质性的好处带来了比以前更好的用户体验。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/7f8f92fadca400f6e7938bb8f090f6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Dq3_P6nwqWJ-grM5DyGBA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">这一过程的最终产品</p></figure><p id="daeb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">跟着我来创建你自己的端到端方法，来掌握你今年的消费习惯。</p><p id="a3cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="lu">完整代码可以在我的 Github </em> <a class="ae kv" href="https://github.com/jenniferrkim/budget_gmailapi" rel="noopener ugc nofollow" target="_blank"> <em class="lu">这里</em> </a> <em class="lu">找到。如果你想建立自己的预算工具，我很乐意帮忙——到 jenniferrkim7@gmail.com 找我。</em></p><h2 id="8de3" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">目录:</h2><ol class=""><li id="e844" class="mo mp iq ky b kz mq lc mr lf ms lj mt ln mu lr mv mw mx my bi translated">检索交易电子邮件</li><li id="6f9f" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">提取交易数据</li><li id="13d9" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">发送到 Google 工作表</li><li id="aecb" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">死刑</li><li id="a184" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">结论</li></ol><h1 id="4683" class="ne lw iq bd lx nf ng nh ma ni nj nk md jw nl jx mg jz nm ka mj kc nn kd mm no bi translated">检索交易电子邮件</h1><h2 id="7016" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">证明</h2><p id="4430" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">我们首先需要认证才能访问我们所有的电子邮件。Gmail API 的<a class="ae kv" href="https://developers.google.com/gmail/api/quickstart/python" rel="noopener ugc nofollow" target="_blank"> Python Quickstart </a>(也有其他语言版本)让这一切变得简单，因为它提供了一个完整的样本，可以验证您的第一个请求。因为我们将只在本地机器上使用这个脚本，所以如下所示的认证方法对于这个项目来说已经足够了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/d665e1f1cd09046d26c52d74d5c5e60c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-zwTj5ZnmggErWCiR0GWYw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用 Python 快速启动 Gmail API 的身份验证</p></figure><p id="816e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经通过了身份验证，是时候发出请求了。</p><h2 id="d660" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">使用 Gmail 的用户检索电子邮件。邮件:列表和获取</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="3d7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用户消息:列表</strong></p><pre class="kg kh ki kj gt nv nw nx ny aw nz bi"><span id="03b0" class="lv lw iq nw b gy oa ob l oc od">response = service.users().messages().list(userId='me', q=query).execute()</span></pre><p id="945d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oe of og nw b"><a class="ae kv" href="https://developers.google.com/gmail/api/v1/reference/users/messages/list" rel="noopener ugc nofollow" target="_blank">list</a></code> <a class="ae kv" href="https://developers.google.com/gmail/api/v1/reference/users/messages/list" rel="noopener ugc nofollow" target="_blank">方法</a>返回我们检索的电子邮件的 id 和 threadId，稍后可以将它们传递给<code class="fe oe of og nw b">get</code>方法以获得电子邮件的文本。多亏了<code class="fe oe of og nw b">query</code>参数，我们可以让这个方法只返回我们感兴趣的邮件。这里，我们以与<a class="ae kv" href="https://support.google.com/mail/answer/7190?hl=en" rel="noopener ugc nofollow" target="_blank"> Gmail 搜索框</a>相同的查询格式传入一个参数。由于每个银行机构的电子邮件格式不同，我们可以创建一个函数，根据选择的银行返回不同的查询。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="2f5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用文档中的以下代码片段来查看多页回复。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/65b0afb65ac2c5330d4e117b9599e8b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*YYbp9Cea8m2_rLUvv71Wig.png"/></div></figure><p id="fb0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用户.消息:获取</strong></p><p id="e4e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oe of og nw b"><a class="ae kv" href="https://developers.google.com/gmail/api/v1/reference/users/messages/get" rel="noopener ugc nofollow" target="_blank">get</a></code> <a class="ae kv" href="https://developers.google.com/gmail/api/v1/reference/users/messages/get" rel="noopener ugc nofollow" target="_blank">方法</a>返回给定来自<code class="fe oe of og nw b">list</code>方法的 id 的特定电子邮件的附加信息。</p><pre class="kg kh ki kj gt nv nw nx ny aw nz bi"><span id="a2b9" class="lv lw iq nw b gy oa ob l oc od">msg = service.users().messages().get(userId='me', id=item['id'], format = raw_or_nah).execute()</span></pre><p id="4363" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如上所示，<code class="fe oe of og nw b">get</code>方法有一个<code class="fe oe of og nw b">format</code>参数，我们可以在“完整”、“元数据”、“最小”和“原始”之间选择消息的格式。我们首先必须确定是否可以从“元数据”格式返回的片段中获得我们需要的数据，该片段包含电子邮件的主题和前几行。如果我们需要的信息不在这个代码片段中，我们可以在格式“full”或“raw”之间进行选择，这将以 base64url 编码的字符串形式返回完整的电子邮件。我选择了“原始”</p><p id="46d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们有了我们的信息，是时候提取<a class="ae kv" href="https://www.youtube.com/watch?v=YIALlhlyqO4" rel="noopener ugc nofollow" target="_blank">有趣的</a>信息了。</p><h1 id="d354" class="ne lw iq bd lx nf ng nh ma ni nj nk md jw nl jx mg jz nm ka mj kc nn kd mm no bi translated">提取交易数据</h1><h2 id="869b" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">正在解析格式为“元数据”的消息</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="3ec0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要的交易信息是日期、商家和金额。来自美国银行和 Venmo 的交易通知电子邮件在以“元数据”格式返回的消息中包含了所有这三个内容</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/bbfbe1b91d467a0d60c1d896e01b2bca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IMVJbHI9tNsg0PualX4r_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">“元数据”格式的消息示例</p></figure><p id="71cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不幸的是，不容易看到信息在哪里，因为这些信息中的每一条都是一个又大又乱的字典。我们必须通读字典，看看我们需要哪些键值对。日期可能嵌套在关键字“payload”和“headers”中，我们可以使用<code class="fe oe of og nw b"><a class="ae kv" href="https://dateutil.readthedocs.io/en/stable/parser.html" rel="noopener ugc nofollow" target="_blank">parser.parse</a></code>提取日期值。</p><pre class="kg kh ki kj gt nv nw nx ny aw nz bi"><span id="90c8" class="lv lw iq nw b gy oa ob l oc od">for msg in msgli:        <br/>    # getting dates        <br/>    headerli = msg['payload']['headers']        <br/>    for nestdic in headerli:            <br/>        if nestdic['name'] == 'Date':                <br/>            date = parser.parse(nestdic['value']).date()<br/>            dateli.append(date)</span></pre><p id="06c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其余信息可能包含在关键字“snippet”的值中。我们可以使用 money-parser 包的<a class="ae kv" href="https://pypi.org/project/money-parser/" rel="noopener ugc nofollow" target="_blank"> price_str </a>函数来查找交易的金额，并通过识别我们知道的指示商家信息/描述所在位置的关键字来定位商家。</p><pre class="kg kh ki kj gt nv nw nx ny aw nz bi"><span id="8a19" class="lv lw iq nw b gy oa ob l oc od"># getting amounts and description of transaction        <br/>snippet = msg['snippet']        <br/>amount_index = snippet.find("Amount")        <br/>date_index = snippet.find("Date")        <br/>where_index = snippet.find("Where")        <br/>end_index = snippet.find("View details")        <br/>if end_index == -1:            <br/>    end_index = snippet.find("This may")         </span><span id="8732" class="lv lw iq nw b gy oj ob l oc od">amt_string = snippet[amount_index:date_index]        <br/>where_string = snippet[where_index + 7:end_index]</span></pre><p id="2c23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们从每条消息中提取日期、商家和金额时，我们可以将每条信息添加到它们各自的列表中，以便在提取完成后放入数据帧中。</p><p id="fc90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="lu">在 Venmo 上的旁白</em></p><p id="8ba8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在信用卡账单上，返还给我们的钱显示为负余额，与消费交易相反。然而，在 Venmo 上，无论我们是付款人还是收款人，金额总是正的。为了保持我们的支出数字准确，我们必须将我们被支付时的实例数量乘以-1。要查看代码，请参考上面 parse_venmo.py 中的第 21 行。</p><h2 id="ae04" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">解析格式为“raw”的消息</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="ce62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们的信息不在关键字“snippet”的值中时，我们需要完整的电子邮件数据，使用格式“raw”进行检索。由于这种格式返回的字符串是 base64url 字符串，因此必须先对其进行解码才能读取(第 9 行)。解码后，我们需要的信息可以像元数据片段中的商家一样提取出来——根据关键字的位置解析字符串。</p><h2 id="3ef5" class="lv lw iq bd lx ly lz dn ma mb mc dp md lf me mf mg lj mh mi mj ln mk ml mm mn bi translated">当您想要解析的数据在电子邮件中不存在时</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="352d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时候，生活会让你陷入困境。其他时候，巴克莱会这么做。巴克莱发送的电子邮件只包含交易的日期和金额，没有商家。这个我们真的无能为力，可能想用<a class="ae kv" rel="noopener" target="_blank" href="/how-i-diyd-my-budget-using-python-for-selenium-and-beautiful-soup-4d2edc5c519"> Selenium 和 Beautiful Soup </a>之类的工具直接从银行网站获取信息。</p><h1 id="26be" class="ne lw iq bd lx nf ng nh ma ni nj nk md jw nl jx mg jz nm ka mj kc nn kd mm no bi translated">发送到 Google 工作表</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/7d67192e947033950542e53a294d5cd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwwGWyBlRdTMmxzxbPY08w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">谷歌工作表公式计算每个类别的总和</p></figure><p id="9c96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Google Sheets 提供了一个可访问的基础来创建一个体面的预算界面，上面就是一个例子。我们可以通过 pygsheets 使用 Google Sheets API 将所有交易信息发送到预算文件中的一个表中。下面的方法来自埃里克·鲁德的帖子<a class="ae kv" href="https://erikrood.com/Posts/py_gsheets.html" rel="noopener ugc nofollow" target="_blank">这里</a>。在对表中某一列的交易进行手动分类后，我们可以使用“sum if”公式计算每个支出类别的总额。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/7f8f92fadca400f6e7938bb8f090f6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Dq3_P6nwqWJ-grM5DyGBA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Google Sheets 中的最终数据框架</p></figure><h1 id="fcd1" class="ne lw iq bd lx nf ng nh ma ni nj nk md jw nl jx mg jz nm ka mj kc nn kd mm no bi translated">死刑</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="30c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了便于执行，我们可以将上述所有函数添加到一个<code class="fe oe of og nw b">main</code>函数中，该函数根据我们选择的金融机构(包括选择“all”)启动整个交易聚合过程。</p><h1 id="e9ce" class="ne lw iq bd lx nf ng nh ma ni nj nk md jw nl jx mg jz nm ka mj kc nn kd mm no bi translated">结论</h1><p id="1a8c" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">我们现在有了一个脚本，可以和 Mint 一样好地获取我们的支出数据(如果不是更好，也要感谢包含了 Venmo)。借助 Google Sheets 的强大功能，我们甚至可以根据自己的需要定制界面。凭借这一新发现的力量，我们有望在 2020 年及以后继续培养良好的理财习惯。</p></div><div class="ab cl ol om hu on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="ij ik il im in"><p id="69a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="lu">完整代码可以在我的 Github </em> <a class="ae kv" href="https://github.com/jenniferrkim/budget_gmailapi" rel="noopener ugc nofollow" target="_blank"> <em class="lu">这里</em> </a> <em class="lu">找到。如果你想建立自己的预算工具，我很乐意帮忙——到 jenniferrkim7@gmail.com 找我。</em></p></div></div>    
</body>
</html>