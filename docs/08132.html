<html>
<head>
<title>Many ways of Pivoting with Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫的多种旋转方式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/many-ways-of-pivoting-with-pandas-a763d9653a0?source=collection_archive---------41-----------------------#2020-06-15">https://towardsdatascience.com/many-ways-of-pivoting-with-pandas-a763d9653a0?source=collection_archive---------41-----------------------#2020-06-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6c38" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Pythoneers爱好者的数据探索技巧</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e7f69434e753fd22f19796b1ee4ec85e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7juoOyvl5Zz4QWyPhSpRxw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Tekton在<a class="ae ky" href="https://unsplash.com/photos/kzlxOJwD6i8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="efb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas提供了无数的数据探索工具，这些工具使用起来很直观，值得一试。本文探索了这样一个工具，<em class="lv">旋转</em>。在许多情况下，数据是以线性表格/非透视/堆叠形式的原始状态获取的，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/fa21c44fd4091382ad264ea4bc38fe06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*9TAMEEIi2FevBBbFfdM3_A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用透视更容易理解的表格数据示例</p></figure><p id="3762" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一种非常方便的数据处理形式，尤其是在处理Tableau、Power BI、Qlik等可视化工具时。大多数解释或支点，如“每个客户/日期/产品的订单”都内置于这些工具中。</p><p id="0e67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种桌子的旋转形式使得用工具可视化或用熊猫进一步处理变得乏味。但是，在某些情况下，可能需要以表格形式查看原始数据，而交叉表或透视是人眼最喜欢、最直观的显示形式。这也是从数据源提取数据的首选格式，因为它将数据压缩到更少的行中，并避免重复输入。下面是用excel <em class="lv"> (Gesamtergebnis的意思是总计，原谅我的德语)</em>透视的上述数据的例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/0640d235a6cf3a9bfbc15fc045f0dcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*wl-kJ26sZeL6zEeZT7UHBw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示订购产品数量的透视</p></figure><p id="2d9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将比较熊猫的各种旋转方式。Pandas提供了以下函数来透视数据:<em class="lv"> crosstab、pivot、pivot_table和groupby </em>。对于本例，您只需要以下库:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="1b70" class="md me it lz b gy mf mg l mh mi">import pandas as pd</span></pre><h2 id="8590" class="md me it bd mj mk ml dn mm mn mo dp mp li mq mr ms lm mt mu mv lq mw mx my mz bi translated">交叉表透视</h2><p id="6a4e" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">交叉表是熊猫最直观、最简单的旋转方式。它会自动计算相应行的列值的出现次数。您可以使用聚合函数(aggfunc)指定一个不同的聚合来填充这个透视。</p><p id="5466" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我想看看每位客户订购的每种产品的总数量(按其客户ID):</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="7164" class="md me it lz b gy mf mg l mh mi">orders_db = pd.read_excel(‘path/to/orders/orders_database.xlsx’)</span><span id="917d" class="md me it lz b gy nf mg l mh mi">crosstab_pivot = pd.crosstab(orders_db.CustomerID,  <br/>                 orders_db.Product,values=orders_db.Quantity,<br/>                 aggfunc=’sum’,<br/>                 margins=True,margins_name=’Total_Qtty’).fillna(0)</span></pre><p id="9d4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">交叉表的工作方式很直观。因为我们希望在数据透视表结果中看到“数量”的总和，所以我们将该列作为“总和”传递给值和聚合函数。kwargs 'margin '和' margin_name '指定我们是否希望输出包含类似于excel的总计列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/8fb6ecf8f127120025c1252ce51c8c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*B1ynvsuxtaa9GEWSHZE4gQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这里是交叉表透视表的输出</p></figure><p id="33ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在交叉表中，如果不指定values参数，它将返回列值出现的频率:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="952d" class="md me it lz b gy mf mg l mh mi">crosstab_pivot = pd.crosstab(orders_db.CustomerID,    <br/>                 orders_db.Product,<br/>                 margins=True,margins_name=’Total_Qtty’).fillna(0)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/4a47879305e366876a7127b48baf8ac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*EJGztGkOE3bXxZwDujeDKQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每个客户的产品出现频率</p></figure><p id="e7e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果要将多列/多行分组到透视，只需将列作为列表传递，如下所示:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="f107" class="md me it lz b gy mf mg l mh mi">crosstab_pivot = pd.crosstab(                      <br/>                 [orders_db.CustomerID,      <br/>                 orders_db.Date,orders_db.Address], <br/>                 [orders_db.Product],<br/>                 values = orders_db.Quantity,      <br/>                 aggfunc=’sum’,margins=True,margins_name=’Total <br/>                 Qtty.’).fillna(0)</span><span id="814a" class="md me it lz b gy nf mg l mh mi">pd.set_option('max_columns',100)</span><span id="d352" class="md me it lz b gy nf mg l mh mi">print(crosstab_pivot)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/a1d102f073f15d93371c410e243b05cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*8u5yx1dHtWvO60zi-JhJZQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">多个分组列的交叉表结果</p></figure><p id="36ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用名为“normalize”的关键字参数，您可以选择将所有值表示为总数的百分比。包括normalize = " index "/" columns "/" all "以将您的值规范化为总计。以下是跨列标准化的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/0145b730ae8bc9b1a9591f923054f7ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*G1Z6c0HXqXI-PPf5fXuv6w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">跨列标准化的输出量</p></figure><h2 id="395f" class="md me it bd mj mk ml dn mm mn mo dp mp li mq mr ms lm mt mu mv lq mw mx my mz bi translated">带枢轴旋转</h2><p id="9bb1" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">pandas提供了一个非常基本的pivot函数，只有在索引-列组合是惟一的情况下才能使用。它不会对值列进行任何聚合，也不会像crosstab那样简单地返回一个计数。举个和上面一样的例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/6bf908fb171e9594db3a88febe181efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPD6Fr0wbtNVjSwdRQV3Zg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">订单数据库摘录:PRSDNT +产品A的多个数量值</p></figure><p id="1858" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">客户ID <em class="lv"> PRSDNT </em>用不同的订单号两次订购了相同的<em class="lv">产品A </em>。因为pivot函数不执行聚合，所以它不知道在该列中为“值”填充什么。</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="0e94" class="md me it lz b gy mf mg l mh mi">pivot_db =  orders_db.pivot(index = ‘Customer ID’,<br/>            columns = ‘Product’,values=’Quantity’)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/07ac4299e38b9ede97c085235efd22c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*WAOcBUQbKvm_JngqEwGOBw.png"/></div></figure><p id="2492" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将适用于索引+列的唯一组合，如下例所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/e786b5ab8b95913b6097929e2e77c891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LcyMPEP5AwGX8fhr_vg_7g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此条目对于SHRLK1，产品组合具有唯一值</p></figure><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="3333" class="md me it lz b gy mf mg l mh mi">pivot_db = orders_db[orders_db.Name==’Holmes’].pivot(index = <br/>           ‘Customer ID’,columns = ‘Product’,values=’Quantity’)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/d116a4d9c4b2f4424c8c2c00190c7682.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/1*BYpZ-5ztP_cNZJe4DcyE3Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">解决办法</p></figure><p id="00c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们有这样不明确的条目时，这是现实应用程序中的大多数情况，我们使用更灵活的pivot_table函数，它允许聚合。</p><h2 id="d389" class="md me it bd mj mk ml dn mm mn mo dp mp li mq mr ms lm mt mu mv lq mw mx my mz bi translated">使用数据透视表旋转_table</h2><p id="49cb" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">数据透视表功能类似于交叉表</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="967b" class="md me it lz b gy mf mg l mh mi">pd.pivot_table(orders_db, values=’Quantity’, <br/>               index=[‘Customer ID’,’Address’], <br/>               columns=’Product’,<br/>               aggfunc=[‘sum’,len,’mean’],<br/>               margins=True,fill_value=0)</span></pre><p id="0f4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以传递多个聚合函数，为每个聚合函数返回一组列。这里已经传递了[sum，len，mean]，len表示条目的计数。您还可以通过传递一个类似于索引列表的列表，将这种方法扩展到多个值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/1fefa4068cb36ec80a24268e204038a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*gydh4xpsuOzIXQMjzJGy-g.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/2bbc1220d417da1d843324fe4266aa00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*wASGN7mEq4Gr9aBZx_OyaA.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c42a96ed22b0f61a9ca3defdd662798b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*6Cfesawx8eRY9zcee3wt4w.png"/></div></figure><p id="8520" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用pandas crosstab还是pivot_table是一个选择问题。请注意，您不需要将数据放在交叉表的数据框中。你也可以交叉表数组，序列等。</p><h2 id="bdad" class="md me it bd mj mk ml dn mm mn mo dp mp li mq mr ms lm mt mu mv lq mw mx my mz bi translated">与分组一起旋转</h2><p id="01fa" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">Groupby是一个非常方便的熊猫功能，你应该经常使用。让我们看看我们的<em class="lv">是如何通过</em>进行分组的。我们希望获得客户订购的每种产品的总数量:</p><p id="2508" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">方法1:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="a517" class="md me it lz b gy mf mg l mh mi">orders_db.groupby(['Customer ID','Address','Product'])  <br/>                 ['Quantity'].sum()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/00e4fac8f6a65aea7d691a2d0cd0fe25.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*DHk2VFmTJoAhfnGCrjkm4g.png"/></div></figure><p id="d6ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">方法二:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="d718" class="md me it lz b gy mf mg l mh mi">groupedby_db = orders_db.groupby([‘CustomerID’,’Address’,’Product’]).agg({‘Quantity’:’sum’})</span></pre><p id="9c1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种方法中，您可以指定如何聚合每一列。(例如，如果您有另一个名为“weight”的列，您需要它的平均值，您可以将其指定为:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="c4f8" class="md me it lz b gy mf mg l mh mi">orders_db.groupby([‘CustomerID’,’Address’,’Product’]).agg({‘Quantity’:’sum’, ‘weight’:’mean’})</span></pre><p id="debb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您也可以使用groupby的便捷过滤功能将过滤器应用到您的组中。假设您只想查看订购了至少4件或更多产品的客户及其地址:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="7caf" class="md me it lz b gy mf mg l mh mi">big_orders = orders_db.groupby([‘CustomerID’,<br/>             ’Product’]).filter(lambda x: <br/>             x[‘Quantity’].sum()&gt;3)</span></pre><p id="2e4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该筛选器采用一个lambda函数参数，该参数指定特定列聚合应该满足的函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/54313fc0163a81fafcfecd2e06e62bfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Zf9ATNO3rlVP9oVEQjeMw.png"/></div></div></figure></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="bb5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是关于熊猫的基本旋转。回头见，更多熊猫黑客！</p></div></div>    
</body>
</html>