<html>
<head>
<title>A/B testing with probabilistic programming and PyMC3 (part II)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用概率编程和 PyMC3 进行 A/B 测试(第二部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-b-testing-with-probabilistic-programming-and-pymc3-part-ii-10f0c16c8d1c?source=collection_archive---------31-----------------------#2020-09-09">https://towardsdatascience.com/a-b-testing-with-probabilistic-programming-and-pymc3-part-ii-10f0c16c8d1c?source=collection_archive---------31-----------------------#2020-09-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6cd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的<a class="ae kl" rel="noopener" target="_blank" href="/a-b-testing-with-probabilistic-programming-and-pymc3-part-i-7ae52d45bc41">上一篇文章</a>中，我们解释了如何使用 PyMC3 对离散变量进行贝叶斯 A/B 测试。在本文中，我们将对连续变量做同样的事情。</p><p id="01c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章的结构如下。</p><p id="009f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.大约在 2013 年，<a class="ae kl" href="https://psych.indiana.edu/directory/faculty/kruschke-john.html" rel="noopener ugc nofollow" target="_blank"> John Kruschke </a>发明的最佳方法(贝叶斯取代 t 检验)概述。</p><p id="8db5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.要进行统计推断，我们需要数据！我们将解释如何使用名为<a class="ae kl" href="https://en.wikipedia.org/wiki/Beautiful_Soup_(HTML_parser)" rel="noopener ugc nofollow" target="_blank">美汤</a>的 Python 包从互联网上抓取数据。在我们的案例中，我们将从 EPSN.com 刮 NBA 的工资来做我们的分析。</p><p id="36e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.NBA 球员薪酬最佳方法的一个具体例子。更准确地说，我们将使用第二部分的数据比较不同位置的 NBA 球员的工资。</p><p id="f4fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于第二部分主要是获取相关数据，那些只想看看最佳作品如何的人可以跳过。我们搜集的数据可以在这个<a class="ae kl" href="https://github.com/tungprime/Bayesian-A-B-testing-with-PyMC3" rel="noopener ugc nofollow" target="_blank"> Github 存储库中找到。</a></p><p id="3cd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们深入细节之前，我们想对我们的分析做一点小小的评论。从我们与<a class="ae kl" href="https://austinrochford.com/" rel="noopener ugc nofollow" target="_blank">奥斯汀·罗奇福德</a>的讨论中，我们了解到薪水和职位之间的关系应该是相关的，而不是因果关系，奥斯汀·罗奇福德是<a class="ae kl" href="https://www.nba.com/teams/sixers" rel="noopener ugc nofollow" target="_blank">费城 76 人</a>的忠实粉丝。一个特别的原因是，工资完全不是随机的，因为它们取决于过去的表现。我们感谢奥斯汀对我们结果的专业反馈。</p><p id="6d40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 1 部分:贝叶斯取代了 t 检验</strong></p><p id="4fa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们在第一部分所解释的，经典的 t 检验有几个缺点，尤其是从商业角度来看。为了克服这些问题，2013 年，印第安纳大学的 John Kruschke 从贝叶斯的角度发明了一种新的 A/B 测试程序。</p><p id="f622" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们在<a class="ae kl" rel="noopener" target="_blank" href="/a-b-testing-with-probabilistic-programming-and-pymc3-part-i-7ae52d45bc41">第一部分</a>中解释的，经典 t 检验有几个缺点，尤其是从商业角度来看。为了克服这些问题，2013 年，印第安纳大学的<a class="ae kl" href="https://psych.indiana.edu/directory/faculty/kruschke-john.html" rel="noopener ugc nofollow" target="_blank"> John Kruschke </a>从贝叶斯的角度发明了一种新的 A/B 测试程序。</p><p id="a0af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个过程中，数据由一个<a class="ae kl" href="https://en.wikipedia.org/wiki/Student%27s_t-distribution" rel="noopener ugc nofollow" target="_blank">学生 t 分布来描述。</a>这种选择无疑比使用正态分布更能提供信息，因为它可以表示带尾部的分布，在我们的例子中就是这样。</p><p id="d907" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要三个参数来描述 Student-t 分布:均值μ、标准差σ和自由度ν。Kruschke 对这些参数使用了以下先验分布。</p><ul class=""><li id="a6e2" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">μ服从正态分布。</li><li id="ca79" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">σ遵循均匀分布</li><li id="c172" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">ν遵循移位指数分布。</li></ul><p id="21e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，ν参数控制数据的正态性:当ν&gt;30 时，学生 t 分布接近正态分布。然而，如果ν很小，学生 t 分布就有很重的尾部。这就是为什么我们在ν的先验分布中选择参数 1/29:这是正态性的“截止值”。</p><p id="9876" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的图形表示总结了上面的描述。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/3f51434f5141978f4eace6a4e92aeb79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qKyrVpjaEnZd0MrQ2yT1Yw.jpeg"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">BEST 的图形表示(作者的手绘)</p></figure><p id="119b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 1.1 部分。实际等效区域。</strong></p><p id="f624" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际等价区域(ROPE)是空值周围的区域，其中包含的值与空值的差异可以忽略不计。绳索的选择取决于特定的应用。例如，假设我们怀疑产品描述越简短，人们越有可能购买。在这种情况下，我们可以做一个 A/B 测试来比较这个新策略和旧策略(如何做的过程在我们的<a class="ae kl" rel="noopener" target="_blank" href="/a-b-testing-with-probabilistic-programming-and-pymc3-part-i-7ae52d45bc41">上一篇文章</a>中有解释)。在贝叶斯框架中，我们感兴趣的是两个版本的平均订单的平均差异是否合理地接近于 0。如果我们非常有信心新策略会奏效，我们可以选择 0 左右的大绳。另一方面，如果我们不太自信，可以选择小绳子。</p><p id="25a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于绳子的更多细节，见<a class="ae kl" href="https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html#:~:text=The%20ROPE%2C%20being%20a%20region,enough%20to%20be%20cared%20about).&amp;text=In%20other%20words%2C%20it%20checks,null%20region%20(the%20ROPE)." rel="noopener ugc nofollow" target="_blank">本</a>。</p><p id="8027" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 1.2 部分。最高密度区间。</strong></p><p id="aa42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最高密度层段(HDI)的定义相当专业。粗略地说，HDI 是这样一个区间，它包含的点比位于它之外的点具有更高的概率密度。<a class="ae kl" href="https://en.wikipedia.org/wiki/Confidence_interval" rel="noopener ugc nofollow" target="_blank">像置信区间</a>一样，我们可以选择人类发展指数覆盖整个人口的程度。通常，我们可以选择覆盖 95%分布的人类发展指数。</p><p id="dc71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">贝叶斯世界中一个更一般的概念，直接类似于置信区间，就是<a class="ae kl" href="https://en.wikipedia.org/wiki/Credible_interval" rel="noopener ugc nofollow" target="_blank">可信区间</a>的概念。我们不会详细讨论这个概念；鼓励读者在这里查看详细内容<a class="ae kl" href="https://easystats.github.io/bayestestR/articles/credible_interval.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="a2a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 1.3 部分。最佳决策。</strong></p><p id="3105" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦指定了 ROPE 和 HDI，我们就可以使用它们来进行统计决策。</p><ul class=""><li id="90ec" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">如果 ROPE 位于 HDI 之外，那么我们拒绝零假设。</li><li id="4567" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">如果 ROPE 包含 HDI，那么我们接受零假设。</li><li id="e24e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">否则，我们保留我们的决定。</li></ul><p id="f3ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最后一种情况下，最好的测试说，没有足够的证据来做出结论性的决定。在这种情况下，我们有几种选择。例如，我们可以改变绳子和/或 HDI。更实际的是，我们可以获得更多的样品。</p><p id="e2a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第二部分:网络搜集的 NBA 薪资数据</strong></p><p id="90f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本节中，我们将解释如何使用 Python 包<a class="ae kl" href="https://en.wikipedia.org/wiki/Beautiful_Soup_(HTML_parser)" rel="noopener ugc nofollow" target="_blank"> Beautiful Soup </a>从互联网上获取数据。我们将使用<a class="ae kl" href="http://www.espn.com/nba/salaries/_/page/_/seasontype/3" rel="noopener ugc nofollow" target="_blank"> ESPN </a>网站获取 2019-2020 赛季 NBA 球员的工资。首先，我们需要导入几个包(对于本节，相关的包是 BeautifulSoup、table 和 requests。)</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="7277" class="lv lw iq lr b gy lx ly l lz ma">import pandas as pd<br/>import requests<br/>from bs4 import BeautifulSoup<br/>from tabulate import tabulate<br/>import numpy as np</span><span id="db4e" class="lv lw iq lr b gy mb ly l lz ma">import pymc3 as pm<br/>import scipy.stats as stats<br/>import matplotlib.pyplot as plt<br/>%matplotlib inline<br/>from IPython.core.pylabtools import figsize<br/>import theano.tensor as tt<br/>from scipy.stats.mstats import mquantiles</span></pre><p id="7f95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用下面的函数来获取原始数据。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="ca07" class="lv lw iq lr b gy lx ly l lz ma">def get_raw_data(link):<br/>    """<br/>    Given a link, get the raw data from ESPN.com<br/>    """<br/>    #get the raw data from the website<br/>    res = requests.get(link) <br/>    soup = BeautifulSoup(res.content,'lxml')<br/>    table = soup.find_all('table')[0] <br/>    df= pd.read_html(str(table))[0]<br/>     <br/>    #remove irrelevant rows</span><span id="6db4" class="lv lw iq lr b gy mb ly l lz ma">    df=df.drop(df[df[1]=='NAME'].index)<br/>   <br/>    #change the name of the columns  <br/>    df.columns=['RK', 'Name', 'Team', 'Salary']<br/>    <br/>    #Make the RK column be the index<br/>    df.set_index('RK', inplace=True)<br/>    return df</span></pre><p id="e96d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，让我们将这个函数应用于这个<a class="ae kl" href="http://www.espn.com/nba/salaries/_/page/_/seasontype/3" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="9509" class="lv lw iq lr b gy lx ly l lz ma">link="http://www.espn.com/nba/salaries/_/seasontype/3"<br/>df1=get_raw_data(link)<br/>df1.head()</span></pre><p id="2f35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/e55efb0388c2e7805cec7687df85e27b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/0*oWPrVzjHRYcCz7UW.jpeg"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">NBA 球员及其工资样本</p></figure><p id="0bbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这不是所有球员及其薪水的完整列表。还有 14 页。幸运的是，当页面在 2–14 之间时，有一个模式。我们可以利用这个事实快速获得数据。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="1687" class="lv lw iq lr b gy lx ly l lz ma">df =df1<br/>for i in range(2,15):<br/>    #get the data for page i</span><span id="f2ac" class="lv lw iq lr b gy mb ly l lz ma">    df_i=get_raw_data(link=    f"http://www.espn.com/nba/salaries/_/page/{i}/seasontype/3") <br/>    <br/>    #combine all the data<br/>    <br/>    df=pd.concat([df, df_i], axis=0)</span></pre><p id="8724" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要清理这些数据。首先，我们必须从这些数据中获得 NBA 球员的位置。正如我们所看到的，这个信息包含在 name 列中。我们可以使用下面的函数来提取它。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="6076" class="lv lw iq lr b gy lx ly l lz ma">def get_position(text):<br/>    return text.split(', ')[-1]</span></pre><p id="2c4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其次，薪水有美元符号；我们应该将它们转换成浮点数据类型。为了避免使用大数字，我们将使用百万美元作为单位。下面几行简单的代码完成了这些清理工作。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="db41" class="lv lw iq lr b gy lx ly l lz ma">df['Position']=df['Name'].apply(get_position)</span><span id="6699" class="lv lw iq lr b gy mb ly l lz ma">df['Salary']=(df['Salary'].apply(convert_string_to_float))/10**6</span><span id="9b6d" class="lv lw iq lr b gy mb ly l lz ma">df.head()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi md"><img src="../Images/c185fed59c1cbded756cd5a5bc09719e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KhN0V2agRw4podfK.jpeg"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">NBA 球员的薪水和职位样本</p></figure><p id="041a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以将数据保存到 CSV 文件中以备将来使用。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="4902" class="lv lw iq lr b gy lx ly l lz ma">df.to_csv('NBA_salary')</span></pre><p id="db1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第三部分:NBA 不同职位的薪水</strong></p><p id="826a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用在第二步中获得的数据来进行分析。我们将采取可视化的方法来帮助读者对我们的分析有一个直观的理解。</p><p id="0970" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们得到这个数据集中的所有位置。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="a2bc" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5,4)<br/>positions=df['Position'].value_counts()<br/>positions.sort_values(inplace=True)<br/>bar=sns.barplot(x=positions.index, y=positions)<br/>plt.xlabel("Position")<br/>plt.ylabel("Number of players")<br/>plt.title("Number of players by positions")<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi me"><img src="../Images/2e22725850cc376151a92053e8af85e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dA5fAoiK9koRPA_h.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">按位置分列的 NBA 球员人数</p></figure><p id="47eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有七种不同的位置:</p><ul class=""><li id="ab46" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">得分后卫</li><li id="023f" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">小前锋</li><li id="d8b2" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">大前锋</li><li id="aa96" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">c(中间)</li><li id="ef27" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">控卫</li><li id="debf" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">g(防护)</li><li id="ee06" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">f(向前)</li></ul><p id="e59c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中，SF 和 SG 的玩家数量最多。前锋和后卫位置的样本量明显小于其他位置。</p><p id="b91f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们比较一下每种职位的平均工资。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="4c75" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5,4)<br/>salary=df.groupby('Position')['Salary'].mean()<br/>salary.sort_values(inplace=True)<br/>bar=sns.barplot(x=salary.index, y=salary)<br/>plt.xlabel("Position")<br/>plt.ylabel("Salary, million dollar")<br/>plt.title("Average salary across different positions")<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mf"><img src="../Images/d39b87f4962c37671934725ea5b98b34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b15j-gkz3GmsyU00.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">不同职位的平均工资</p></figure><p id="1e3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到，平均而言，得分后卫和中锋球员收入最高。另一方面，小后卫球员挣得最少。我们也可以使用箱线图来获得一个更广阔的图景。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="93d1" class="lv lw iq lr b gy lx ly l lz ma">figsize(16,6)<br/>my_order = df.groupby("Position")['Salary'].median().sort_values(ascending=False).index<br/>sns.boxplot(data=df, x='Position', y='Salary', order=my_order)<br/>plt.title("Salary for different positions")<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mg"><img src="../Images/149689a543e53cb0ea86cdeed5c0a83e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9cfUfEmDfKzhT9UB.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">每个职位的工资箱线图</p></figure><p id="645b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于所有职位，工资都有尾部分布。此外，PG 和 Center 的薪资分布非常相似。总的来说，好像 SG 赚的最少。</p><p id="cb57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 3.1 部分:得分后卫和控卫</strong></p><p id="15c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第一部分，我们比较得分后卫和控球后卫的薪水。如上图所示，我们预计，平均而言，控卫球员比 SG 球员挣得多。</p><p id="6835" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们过滤掉 SG 和 PG 位置的数据。我们还计算混合样本均值和混合样本方差，如[1]所述。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="ddcf" class="lv lw iq lr b gy lx ly l lz ma">SG=df[df['Position']=='SG']['Salary']<br/>PG=df[df['Position']=='PG']['Salary']<br/>pooled_mean=np.r_[SG, PG].mean()<br/>pooled_std=np.r_[SG, PG].std()<br/>variance=2*pooled_std</span></pre><p id="2cc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们为均值、方差和自由度变量设置先验分布。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="f9cf" class="lv lw iq lr b gy lx ly l lz ma">with pm.Model() as model_1:<br/>    mu_A=pm.Normal("mu_A", pooled_mean, sd=variance)<br/>    mu_B=pm.Normal("mu_B", pooled_mean, sd=variance)<br/>    std_A=pm.Uniform("std_A", 1/100, 100)<br/>    std_B=pm.Uniform("std_B", 1/100, 100)<br/>    nu_minus_1=pm.Exponential("nu-1", 1.0/29)</span></pre><p id="3873" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将数据放入模型中。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="7f33" class="lv lw iq lr b gy lx ly l lz ma">with model_1:<br/>    obs_A=pm.StudentT("obs_A", mu=mu_A, lam=1.0/std_A**2, nu=nu_minus_1+1, observed=SG)<br/>    obs_B=pm.StudentT("obs_B", mu=mu_B, lam=1.0/std_B**2, nu=nu_minus_1+1, observed=PG)<br/>    start=pm.find_MAP()<br/>    step=pm.Metropolis(vars=[mu_A, mu_B, std_A, std_B, nu_minus_1])<br/>    trace_1=pm.sample(25000, step=step)<br/>    burned_trace_1=trace_1[10000:]</span></pre><p id="9dac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦完成，我们就有了变量后验分布的样本。然后我们可以绘制它们来比较 SG 和 PG 球员的薪水。</p><p id="a6b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们画出这两个职位的平均工资。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="221c" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5, 4)<br/>SG_mean=burned_trace_1['mu_A']<br/>PG_mean=burned_trace_1['mu_B']<br/>plt.hist(SG_mean, bins=40, label=r'Posterior distribution of $\mu_{SG}$')<br/>plt.hist(PG_mean, bins=40, label=r'Posterior distribution of $\mu_{PG}$')<br/>plt.title('Posterior distributions of average salaries for SG and PG')<br/>plt.legend()<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mh"><img src="../Images/f4cdfc98e5388403391f876a48a87fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Fu9XLbNEogUZ9qH5.png"/></div></div></figure><p id="8699" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个图说明 PG 球员平均收入比 SG 球员高。这些职位的薪资浮动情况如何？</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="7aa2" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5, 4)<br/>SG_std=burned_trace_1['std_A']<br/>PG_std=burned_trace_1['std_B']<br/>plt.hist(SG_std, bins=40, label=r'Posterior distribution of $\sigma_{SG}$')<br/>plt.hist(PG_std, bins=40, label=r'Posterior distribution of $\sigma_{PG}$')<br/>plt.title('Posterior distributions of  standard derivation derived from PyMC3')<br/>plt.legend()<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mh"><img src="../Images/d45a622e008c25290e9f5dd8bfb6aa51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2JmClpWLcWsXrNT5.png"/></div></div></figure><p id="01ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于 PG 职位，即使平均工资更高，但波动也更大。</p><p id="cd6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们应用 ROPE=[-0.1，0.1]和 95% HDI 的最佳值。这最好通过下面的可视化来完成。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="497d" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5, 4)<br/>difference=PG_mean-SG_mean #difference of the means </span><span id="ab2b" class="lv lw iq lr b gy mb ly l lz ma">hdi=pm.stats.hpd(difference, hdi_prob=0.95) #the 95% HDI interval of the difference</span><span id="03b7" class="lv lw iq lr b gy mb ly l lz ma">rope=[-0.1, 0.1] #the ROPE region </span><span id="d523" class="lv lw iq lr b gy mb ly l lz ma">plt.hist(difference, bins=50, density=True, label='Differene of the mean salaries')<br/>plt.title('Posterior distribution of the the difference of the means')<br/>plt.vlines(hdi[0], 0,0.6, linestyle='--', color='red', label='HDI')<br/>plt.vlines(hdi[1], 0, 0.6, linestyle='--', color='red')<br/>plt.vlines(rope[0], 0, 0.6, linestyle='--', color='black', label='ROPE')<br/>plt.vlines(rope[1], 0, 0.6, linestyle='--', color='black')<br/>plt.title('Posterior distribution of the the difference of the mean salaries for PG and SG')<br/>plt.legend(loc='upper right')<br/>plt.show()</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mi"><img src="../Images/76c8e2b4445598dc2b8098fa243a8aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Df7ryo-koNEPKwWe.png"/></div></div></figure><p id="c7a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于绳子完全在 HDI 区间之外，我们拒绝零假设:我们相信，平均而言，PG 球员比 SG 球员挣得多。我们注意到，在这种情况下，人类发展指数</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="b1d4" class="lv lw iq lr b gy lx ly l lz ma">[0.5580346 , 3.57072747]</span></pre><p id="21a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，即使我们取[-0.5，0.5]这样更宽的绳子，仍然可以拒绝零假设。此外，正如上一篇文章中所讨论的，贝叶斯观点允许我们回答更复杂的问题。比如说，我们有多大把握说一个控卫球员比 SG 球员多赚 50%呢？</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="0191" class="lv lw iq lr b gy lx ly l lz ma">figsize(12.5, 4)<br/>rel_difference=100*(PG_mean-SG_mean)/SG_mean #difference of the means<br/>prob=len(rel_difference[rel_difference&gt;50])/len(rel_difference)<br/>plt.hist(rel_difference, bins=50, density=True, label='Relative differene of the mean salaries')<br/>plt.title('Posterior distribution of the the relative difference of the means')<br/>plt.vlines(50, 0,0.011, linestyle='--', color='red', label='HDI')<br/>print(f"The probability that a PG player earn 50% more than an SG player is: {prob}")<br/>plt.show()</span><span id="0cb3" class="lv lw iq lr b gy mb ly l lz ma">The probability that a PG player earn 50% more than an SG player is: 0.8830833333333333</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mj"><img src="../Images/6af0f7f4b8201ee772a231ae03701ffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NPwvyLNdKsfTnau1.png"/></div></div></figure><p id="67c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们很有信心 PG 球员比 SG 球员多挣 50%。</p><p id="720b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 3.2 部分:小前锋和大前锋</strong></p><p id="2bce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用上一节中的框架来做类似的分析。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="2287" class="lv lw iq lr b gy lx ly l lz ma">SF=df[df['Position']=='SF']['Salary']<br/>PF=df[df['Position']=='PF']['Salary']<br/>pooled_mean=np.r_[SF, PF].mean()<br/>pooled_std=np.r_[SF, PF].std()</span><span id="071a" class="lv lw iq lr b gy mb ly l lz ma">variance=2*pooled_std<br/>with pm.Model() as model_2:<br/>    mu_A=pm.Normal("mu_A", pooled_mean, sd=variance)<br/>    mu_B=pm.Normal("mu_B", pooled_mean, sd=variance)<br/>    std_A=pm.Uniform("std_A", 1/100, 100)<br/>    std_B=pm.Uniform("std_B", 1/100, 100)<br/>    nu_minus_1=pm.Exponential("nu-1", 1.0/29)</span><span id="d15f" class="lv lw iq lr b gy mb ly l lz ma">    obs_A=pm.StudentT("obs_A", mu=mu_A, lam=1.0/std_A**2, nu=nu_minus_1+1, observed=SF)<br/>    obs_B=pm.StudentT("obs_B", mu=mu_B, lam=1.0/std_B**2, nu=nu_minus_1+1, observed=PF)<br/>    start=pm.find_MAP()<br/>    step=pm.Metropolis(vars=[mu_A, mu_B, std_A, std_B, nu_minus_1])<br/>    trace_2=pm.sample(25000, step=step)<br/>    burned_trace_2=trace_2[10000:]</span></pre><p id="6f6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们绘制了 SF 和 PF 职位平均工资的后验分布直方图。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mh"><img src="../Images/2d3de202d63c31441cb709cbad747f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H_Ig213Y55mq4As0.png"/></div></div></figure><p id="ae80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与之前的比较不同，我们看到两个后验分布重叠更多。我们可以研究这两种分布的区别。首先，我们使用 ROPE=[-0.1，0.1]和 95% HDI 区间。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mi"><img src="../Images/67f78d42f057b4d80f63c13426e6646d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TkRVN0Uuot04nHVx.png"/></div></div></figure><p id="3dc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们没有足够的证据通过上述决策规则拒绝或接受这些 ROPE 和 HDI 选择的零假设。让我们仔细看看人类发展指数。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="7871" class="lv lw iq lr b gy lx ly l lz ma">array([-0.44822444,  1.34450148])</span></pre><p id="2d05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到，如果我们坚持这个人类发展指数，那么除非我们选择一个非常宽的绳子(因此，接受零假设)，我们的数据不足以做出结论性的决定。</p><p id="9741" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 3.3 部分:中锋 vs 大前锋</strong></p><p id="0423" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过类似的代码，我们可以比较中锋和大前锋的工资。我们将根据几种选择以及 HDI 和 ROPE 绘制平均工资的差异。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mi"><img src="../Images/f2628c8b32a594fc9b1c6e68baed4b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uOkq2uVHrKyTzRuu.png"/></div></div></figure><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mi"><img src="../Images/f2f985a791ea95d2a22e1f368f2d6ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6sIXmgrqB40PI__m.png"/></div></div></figure><p id="4996" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到，如果选择 ROPE=[-0.1，0.1]和 95% HDI 区间，我们的数据无法做出最终决定。然而，假设我们把人类发展指数降低到 80%。在这种情况下，我们有信心中锋球员的平均收入高于大前锋球员。</p><p id="f674" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="d5c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望读者能从这篇文章中学到一些东西。首先，BEST 提供了一个进行贝叶斯 A/B 测试的通用框架，它可以定制客户的业务方法。其次，BEST 可以方便地用 PyMC3 实现。最后但同样重要的是，对于 NBA 来说，我们很有信心得分后卫球员的平均收入高于得分后卫球员。我们不太有信心说中锋比大前锋挣得多。然而，我们没有足够的证据来区分小前锋和大前锋球员的工资。</p><p id="e042" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考文献</strong></p><p id="8eb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[1] John K. Kruschke，贝叶斯估计取代了 t 检验</p><p id="de86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[2] PyMC3 最佳教程，<a class="ae kl" href="https://docs.pymc.io/notebooks/BEST.html" rel="noopener ugc nofollow" target="_blank">https://docs.pymc.io/notebooks/BEST.html</a></p></div></div>    
</body>
</html>