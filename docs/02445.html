<html>
<head>
<title>Using AWS DMS to tail MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS DMS跟踪MongoDB</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-aws-dms-to-tail-mongodb-978967aed8dd?source=collection_archive---------29-----------------------#2020-03-08">https://towardsdatascience.com/using-aws-dms-to-tail-mongodb-978967aed8dd?source=collection_archive---------29-----------------------#2020-03-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="a510" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">数据摄取</h2><div class=""/><div class=""><h2 id="a41c" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">AWS DMS作为一个持续的数据摄取工具。</h2></div><p id="a137" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><a class="ae lk" href="https://aws.amazon.com/dms/" rel="noopener ugc nofollow" target="_blank"> AWS DMS </a>是一项旨在将一个数据库迁移到另一个数据库的服务。无论是本地数据库到AWS RDS还是AWS EC2(自管理数据库)到RDS。目的很简单，并且假设迁移通常是短期的。DMS不仅允许迁移整个数据库，还允许在满载时连续复制更改的数据。</p><p id="30ac" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">从技术上讲，对迁移任务的持续时间没有限制。拥有一个本质上无限运行的迁移任务意味着它可以用于将数据库更改流式传输到S3。因此，让我们来看看DMS，以及我们如何使用它来填充我们的湖泊。</p><h1 id="6cea" class="ll lm iq bd ln lo lp lq lr ls lt lu lv kf lw kg lx ki ly kj lz kl ma km mb mc bi translated">AWS数据库迁移服务</h1><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/01442a075f1415b06fbdd60795bd59c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/0*fuXyIHVTx0rBhT3T.png"/></div></figure><p id="d221" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">DMS服务概念相当简单，使用起来也很简单。如果默认值保持不变，则简单。有三个主要组件:端点、复制实例和任务。</p><h2 id="2bd4" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">端点</h2><p id="e304" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">端点定义了到源和目标的连接。端点可以被配置为源或目标，以便限制误用。支持各种数据库，包括AWS DocumentDB和S3。</p><h2 id="6db7" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">任务</h2><p id="77c6" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">任务定义将哪个源端点迁移到目标。每个任务可以将一个源迁移到一个目标。端点可以在多个任务中引用。任务还定义了是执行完整迁移还是持续复制，或者两者都执行。完整迁移会在目标系统中创建时间点快照，而持续迁移会将每个更改复制到目标系统。</p><p id="98ce" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">还可以将任务配置为从目标中删除现有的表或将其截断。其他优化设置包括在迁移中包括和排除哪些模式和表。</p><p id="1dc5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">任务可以在多个状态之间转换，这些状态可以恢复、暂停或重置任务。如果作为任务的一部分迁移多个表，那么如果需要，可以单独重新加载每个表。对于正在进行的复制，该任务还在内部维护一个检查点状态，用于恢复复制。</p><p id="670e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">可以在每个任务中应用一些基本的转换规则。它们作用于模式、表或列，并允许重命名、删除或在名称中添加前缀和后缀。数据不能被操纵。</p><h2 id="5784" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">复制实例</h2><p id="b8ed" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">这些任务需要在一些EC2实例上执行。DMS不是无服务器的，但是配置只涉及创建一个实例。不需要也没有能力通过SSH访问实例，甚至管理它。除非需要进行大量转换，否则大多数任务都是内存受限的。DMS实例家族是一个很好的起点。Cloudwatch指标允许对此进行监控，并且应该用于测试和容量规划。</p><h1 id="d6f1" class="ll lm iq bd ln lo lp lq lr ls lt lu lv kf lw kg lx ki ly kj lz kl ma km mb mc bi translated">跟踪MongoDB到S3</h1><p id="ed71" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">我假设您有一个运行副本集的MongoDB服务器。如果没有，您可以很容易地在AWS EC2或ECS中设置一个。我将在EC2上使用一个，这是我专门为这个演示设置的。</p><p id="1a96" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">首先，我们需要创建端点。有两个:源和目标。源端点应该指向MongoDB主机，目标指向S3桶。</p><h2 id="35ea" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">复制实例</h2><p id="8558" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">首先创建复制实例使我们能够测试到源和端点的连接。实例的大小应该由内存和磁盘需求决定。限制每个实例复制的表的数量是一个很好的做法。</p><p id="a010" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">下面的屏幕截图显示了如何配置该实例。<a class="ae lk" href="https://docs.aws.amazon.com/dms/latest/userguide/CHAP_ReplicationInstance.html#CHAP_ReplicationInstance.Creating" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/DMS/latest/user guide/CHAP _ replication instance . html # CHAP _ replication instance。正在创建</a></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/319dfe2e215a516ee3c81a5ea9296e9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LeHs7-YJ4RvRxHoS8jydNw.jpeg"/></div></div></figure><p id="d5f6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">创建复制实例非常重要，因为复制任务无法在实例之间轻松迁移。建议使用多个复制实例，尤其是当您有多个源和50多个表/集合要复制时。</p><h2 id="4c26" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">源端点</h2><p id="613b" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">AWS DMS支持大量数据源，包括所有RDS数据库类型、MongoDB和S3。</p><p id="04c0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">是时候创建到我们的源MongoDB集群的连接了。如果您有一个集群和路由器，不幸的是，您不能连接到路由器，因为无法访问<code class="fe nb nc nd ne b">oplog</code>集合。您需要选择一个实例进行复制。您可以选择一个辅助节点，以便写入群集的数据不受影响，但数据仍能正确复制。</p><p id="c9a2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于这个演示，我有一个MongoDB实例运行在EC2实例的副本集中。下面的配置是一个例子。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nk"><img src="../Images/b889dfa39413b03d004f453b08649be6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i6oOQHdeRP9ItebFxyBjEA.jpeg"/></div></div></figure><p id="c5e7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">有几个关键的配置选项值得讨论。首先是元数据模式。DMS支持MongoDB的<code class="fe nb nc nd ne b">document</code>或<code class="fe nb nc nd ne b">table</code>模式。<code class="fe nb nc nd ne b">document</code>模式将操作日志和文档保存为JSON，而<code class="fe nb nc nd ne b">table</code>模式将其保存为CSV。使用<code class="fe nb nc nd ne b">table</code>模式，可以使用<code class="fe nb nc nd ne b">nestingLevel</code>作为<code class="fe nb nc nd ne b">NONE</code>或<code class="fe nb nc nd ne b">ONE</code>来指定要展平的级数。</p><p id="2714" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来是<code class="fe nb nc nd ne b">_id as a separate column</code>或者<code class="fe nb nc nd ne b">extractDocId</code>。这允许提取文档<code class="fe nb nc nd ne b">_id</code>作为一个新列。如果这是false(未选中)并且元数据模式被设置为<code class="fe nb nc nd ne b">document</code>，那么输出文件有一个包含JSON字符串的单列。使用<code class="fe nb nc nd ne b">extractDocId=true</code>，输出文件有两列CSV格式，第一列是<code class="fe nb nc nd ne b">_id</code>，第二列是字符串形式的JSON文档。稍后当我们查看复制任务输出时，这一点会变得更加明显。你可以在这里找到更多信息<a class="ae lk" href="https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Source.MongoDB.html" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="07a7" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">目标端点</h2><p id="69e0" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">AWS DMS支持多种目标数据库类型和S3。配置S3目标相当简单，如下所示。<code class="fe nb nc nd ne b">bucket folder</code>定义了每个表的前缀。</p><p id="6bb9" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">最重要的设置是<code class="fe nb nc nd ne b">Extra Connection Attributes</code>。这是针对任何目标的。您可以指定压缩、分隔符、格式等。AWS文档对此非常详细，并提供了很好的示例。我发现<code class="fe nb nc nd ne b">CDC Path</code>不起作用，也许这是因为DMS API实际上不允许指定这个。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nl"><img src="../Images/b381d8dab646bc3f4963d67bf7b19a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oD4ttuaEYnVkB9vAewu2vQ.jpeg"/></div></div></figure><h2 id="934b" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">迁移任务</h2><p id="a380" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">一旦定义了端点，我们需要定义一个迁移任务。迁移任务定义了哪些数据以及如何将数据从源端点复制到目标端点。迁移类型设置允许作为一次性加载或连续复制进行迁移。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nm"><img src="../Images/33cb235caf53c597886d65da3bccdbe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ex1kbso9C1mIR3-BlSxNuw.jpeg"/></div></div></figure><p id="74ef" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个<code class="fe nb nc nd ne b">Task Settings</code>很值得讨论。第一个选项是<code class="fe nb nc nd ne b">Target Table Preparation Mode</code>；这定义了写入目标表的行为。对于S3，这是指前缀。<code class="fe nb nc nd ne b">Do Nothing</code>将添加数据，<code class="fe nb nc nd ne b">Drop Tables on Target</code>将删除所选表格的表格前缀，<code class="fe nb nc nd ne b">truncate</code>将删除表格前缀下的所有数据对象。这是任务中所有选定表的全局设置。</p><p id="3b4e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><code class="fe nb nc nd ne b">Include LOB Columns in Replication</code>控制迁移多大的二进制对象。BLOB/CLOB字段类型可能包含难以迁移的兆字节数据。DMS允许读取这种类型的截断形式，或者可以完全排除它们。通常情况下，<code class="fe nb nc nd ne b">Limited LOB mode</code>是最佳实践，但是，当目标数据库/系统能够处理这种数据类型时，也可以使用<code class="fe nb nc nd ne b">Full LOB mode</code>。不幸的是，S3目标端点不支持完整的LOB模式。</p><p id="98ef" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><code class="fe nb nc nd ne b">Enable Validation</code>这是一个很棒的功能，但同样不被S3支持。对于其他数据库类型，DMS允许验证所有数据都已被完整准确地复制。对于S3，我们可以在查看指标时看到这一点。</p><p id="c2d6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">简单地说，<code class="fe nb nc nd ne b">Control Tables</code>允许审计和记录DMS动作和状态。除了日志之外，这对于快速检查状态也很有用。</p><h2 id="8aaa" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">运行和监控任务</h2><p id="3fa7" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">创建并启动任务后，数据将开始通过复制实例流动。请注意，任务创建后，复制实例不能更改。如果您需要在新的复制实例上运行任务，则需要创建新的任务。</p><p id="197a" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">下面是DMS提供的一个监控的框架，碰巧相当详细。我的MongoDB源代码是一个带有模拟数据的小实例。所以只有几百份文件。然而，很明显，表/集合级别的监控是可能的，并且几乎可以通过CloudWatch即时更新，包括所有的插入、更新和删除。满载和CDC指标也在任务级别单独提供。EC2指标以及这些指标可以决定在每个复制实例上运行多少任务，以及实例类型是否需要更新。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nn"><img src="../Images/70cb0db7603bddfde8f9467b3f41c2b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QWvBvpqLIn_xovWXVe80iQ.jpeg"/></div></div></figure><h2 id="87fd" class="ml lm iq bd ln mm mn dn lr mo mp dp lv kx mq mr lx lb ms mt lz lf mu mv mb iw bi translated">摘要</h2><p id="365e" class="pw-post-body-paragraph ko kp iq kq b kr mw ka kt ku mx kd kw kx my kz la lb mz ld le lf na lh li lj ij bi translated">希望本指南为您提供了一个关于DMS的良好起点，以及它不仅可以用于数据库迁移，还可以用于数据湖的数据接收。我已经向您展示了一个连接到MongoDB的示例，但是，您也可以连接与MongoDB兼容的DynamoDB！随着DMS和DynamoDB新版本的发布，这将增加更多功能，包括CDC复制。由于DMS是一项托管服务，因此它更易于操作，并提供了与Cloudwatch的完全集成，用于监控和警报。</p></div></div>    
</body>
</html>