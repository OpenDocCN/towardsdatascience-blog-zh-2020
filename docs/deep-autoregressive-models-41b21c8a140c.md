# TensorFlow 2.0 中的自回归过程表示

> 原文：<https://towardsdatascience.com/deep-autoregressive-models-41b21c8a140c?source=collection_archive---------22----------------------->

## 张量流中自回归过程的一阶泰勒级数表示

## 张量流 2.0

与业务相关的时间序列通常是非连续的，或离散的，基于时间的过程。从操作上来说，对于企业来说，知道或者能够量化一个时间序列在未来什么时候会达到顶峰或者低谷可能是有用的。目标是捕捉趋势和周期模式，并预测未来大于 1 个样本的信号。示例笔记本可在本文的张量流公式部分获得。

## 趋势、周期性和噪声

在大多数与商业相关的应用中，时间序列在一段时间内具有非常数的均值和方差，或者可以说是*非平稳*。这与电路、音频系统和通信系统分析中使用的静态信号和系统形成对比。平均值变化的方向表示时间序列的**趋势**。**噪声**的变化也可能是某个随机过程的函数。这种噪声可能随着时间的变化而增大或减小。

有一个粒度*时间限制*到哪个**周期**或循环模式可以被捕获。在数字信号处理中，[奈奎斯特速率](https://en.wikipedia.org/wiki/Nyquist_rate)是捕获周期为 n 的重复出现的模式所需的最小采样周期。本质上，采样速率需要小于重复出现模式的半个周期。例如，假设数据中有一个功能，它每 6 个小时测量一次销售额。可以捕获的最精细的模式是每 12 小时重复一次的模式。

# 自回归模型公式

自回归模型和开环反馈系统(一种控制系统)有一些相似之处。这两个系统都依赖于模型先前的输出。我们希望这两个系统都是稳定的，也就是说，不会爆发成指数输出。这些系统的不同之处在于，自回归预测可能依赖于多个滞后输入特征。[自回归模型](https://en.wikipedia.org/wiki/Autoregressive_model)的形式如式(0)所示。

![](img/1f7305ba498fd108ace0df0c0de89d28.png)

其中 T 是滞后要素的数量，w 表示自回归权重，y(t-i)表示滞后时间序列，y*(t+1)是 t+1 时的预测值。

目标是使用一阶[泰勒级数](https://en.wikipedia.org/wiki/Taylor_series)近似值创建自回归模型的线性化形式。自回归公式是递归的，这意味着下一个值取决于前一个值的级联。y(t+1)处的值是使用时间步长 t 周围的 f(t+1)的泰勒级数展开来估计的。等式(2)显示了使用一阶泰勒级数近似的 y(t+1)的估计值。注意，等式(2)右侧的-1 常数将被权重吸收。

![](img/2af4733e5652521c769b16890d058743.png)

其中 f(t)是一个递归密集层，它用一些误差项表示 y(t)，y*是预测输出，w_t 是权重，T 是滞后特征的数量。等式(2)示出了简单情况下的泰勒级数展开，其中 y(t+1)取决于先前的值，即 f(t+1)。我使用 f(t)而不是 y(t)的原因是因为 y(t)代表实际滞后的数据点，而不是依赖于时间的自回归函数。

在方程(3.1)中，f(t+1)相对于 f(t)的偏导数是相对于 w(t)取的。这种偏导数产生 f(t)，即前一个函数值，可以用一阶泰勒级数展开式再次展开。有趣的是，这将导致类似于自回归公式的模型公式。区别在于滞后特征是有限的和离散的，而不是无限的。

![](img/909ae177257b73a798a1ee9494465213.png)

(3.2)可以通过用每个滞后时间步长的先前时间序列值替换递归层 f(t)而被重新表述为线性模型，即 f(t)的值被 y(t)替换。最后，可以添加额外的滞后成分来创建自回归模型。

用于训练自回归模型的最终形式在等式(4)中示出。截距被限制为自回归权重之和。这使得该模型对中心趋势没有偏见，并且随着时间的推移具有适应性。

![](img/a0fc1f7441d93ed34a78b22e08635203.png)

其中 N 是数据点的数量，T 是滞后要素的总数，w 表示自回归权重，y(t-i)表示滞后时间序列，y*(t+1)是 t+1 时的预测值。等式(5)中所示的目标函数 MSE 相对于参数是可微分的，并且可以用 TensorFlow 来优化。

应用同样的逻辑，可以预测多变量时间序列。所有时间序列的前一个值用作协变量，以同时预测所有时间序列的下一个值。在这种情况下，截距是输出节点的自回归权重之和。多元公式允许堆叠多个自回归层，以创建深度自回归模型。

# 澳大利亚墨尔本的每日最低温度和降雨量

[澳大利亚墨尔本日最低温度和降雨量](https://datamarket.com/data/set/2324/daily-minimum-temperatures-in-melbourne-australia-1981-1990#!ds=2324&display=line)数据集用于建立自回归预测模型。该数据集包括从 1981 年开始的 3625 天的温度和降雨量。有一些丢失的值，但是这些值是为每个系列插入的。这些序列同时预测使用深度自回归模型。

## 温度

下图显示了整个时间段墨尔本的气温。随着时间的推移，温度似乎有明显的周期性变化。

![](img/88b8a64f86433335dac6c02b83c1c048.png)

## 降雨

下图显示了墨尔本不同时间段的降雨量系列。降雨量被限制在每天 0 厘米的降雨量，这使得使用自回归模型建模变得困难。为了使用降雨量，创建了降雨量的 60 滚动平均值，如下图所示。

![](img/74675c6bbef64c602451bcdae904d40a.png)![](img/2e14684291a0b384c44334cdd5e3cd8d.png)

## 数据集构建

1.  这两个系列，即温度和降雨量，在训练之前首先被标准化。
2.  数据集是通过为时间序列中的每个观察值创建 365 个滞后特征来构建的。例如，观测 365+1 将具有之前的 365*2 特征。
3.  前 365 个观察值从训练数据集中排除，以避免丢失值。
4.  两个时间序列的最后 1，130 个观测值，即 3 年，被用作检验预测有效性的保留集。

## 张量流公式

下面的代码块显示了上述自回归模型的 TensorFlow 代码。示例笔记本可在[这里](https://github.com/freedomtowin/ml-projects/blob/master/Deep-Autoregressive-Model/deep-autoregressive-model-v1.ipynb)找到。

![](img/6a785c8dedc7a61996545237c22abf10.png)

该模型具有大小为(N，M)的输入，其中 N 是数据点的数量，M 对应于降雨和温度的 730 个滞后特征。大小为 30 的隐藏层与自回归激活一起使用。该模型用随机梯度下降、均方误差损失、Adam 优化器、早期停止和小学习率来训练。虽然利用了早期停止，但它可能不是必要的，因为自回归模型产生的结果应该是固有地正则化的。

## 滚雪球自回归时间序列

可以通过将以前的预测滚雪球式地加入自回归模型来创建预测。*滚雪球式的时间序列*的方差可能有随时间增加的趋势，或者变得不稳定，即使实际的时间序列是稳定的。一个不合适的模型可能会变得不稳定，并随着时间的推移而发生变化。如果预测的*滚雪球式的时间序列*始终偏于实际趋势之上或之下，就会出现不稳定性。在模型公式中，约束截距应随着时间的推移产生更大的稳定性和适应性。

为了评估预测稳定性，该模型在不同的随机训练验证分裂上训练了 100 次，并且创建了 100 个模型。为保留集上的每个模型生成了一个*滚雪球式的时间序列*。期望值和标准差分别用于创建预测和置信区间。

## 温度预报结果

![](img/35148666c74538b61346410b979af0e2.png)

## 降雨量(60 滚动平均值)预测结果

![](img/7fd2badc629e91e9de2d73e0ab3eb9e6.png)

在上面的图中，实际观测值、训练预测值和滚雪球式预测值分别用绿色、蓝色和橙色系列表示。温度的预测值和预报值似乎捕捉到了全球周期模式。然而，100 个预测的变化没有捕捉到时间的变化。降雨量的预测值(60 个滚动平均值)在训练数据集中似乎过拟合。过度拟合可能是由于使用了滚动平均特征。该系列的趋势在崩溃为周期性模式之前，准确地捕捉了约 1 年的预测值。大约 1 年后未能准确捕捉到趋势。

# 结论

自回归函数的一阶近似用于制定目标函数和模型定义。发现自回归激活层的截距被约束为输入权重的和。通过堆叠自回归层，使用 TensorFlow 2.0 创建了深度自回归模型。该模式被用来同时预报澳大利亚墨尔本的温度和降雨量。自回归公式不适用于截断时间序列，需要滚动平均变换来预测降雨量。这些预测是通过将以前的预测滚雪球式地回归到模型中来创建的。该模型似乎捕捉到了小的全球趋势和周期性模式。

# FB Prophet 预测比较

该模型与 FB Prophet 相比如何？Prophet 是一个完整的时间序列预测套件，有许多可调参数。为了比较，我使用了来自[快速入门教程](https://facebook.github.io/prophet/docs/quick_start.html#python-api)的开箱即用模型。

Prophet 似乎使用了周期图模型。它基本上挑选出顶部的周期频率 f，并将其包装在正弦和余弦函数中，以创建特征集，即 sin(f)和 cos(f)。该软件包似乎也使用了逻辑回归模型的输出。逻辑回归模型预测序列是上升还是下降。该软件包似乎支持向预测中添加额外的变量，但似乎还不支持同步多变量预测。该比较已添加到示例笔记本中。

## 温度预报结果

![](img/97569f3ef5bc1ef33d86ac2b78036867.png)

## 降雨量(60 滚动平均值)预测结果

![](img/3d137ae2372a1d20c18af1ef3e377e79.png)

在上面的图中，实际观测值、训练预测值和滚雪球式预测值分别用绿色、蓝色和橙色系列表示。温度的预测值和预报值似乎捕捉到了全球周期模式。100 个预测的变化捕捉到了随时间的变化。温度趋势似乎是上升的，但这可能不是实际趋势。降雨量的预测值(60 个滚动平均值)似乎反映了一种一般的年度周期模式。该模式在整个验证过程中是一致的。降雨量似乎呈下降趋势，但这可能不是实际趋势。