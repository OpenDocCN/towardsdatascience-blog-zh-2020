<html>
<head>
<title>Building A Modern Batch Data Warehouse Without UPDATEs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建无需更新的现代批量数据仓库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-modern-batch-data-warehouse-without-updates-7819bfa3c1ee?source=collection_archive---------4-----------------------#2020-01-31">https://towardsdatascience.com/building-a-modern-batch-data-warehouse-without-updates-7819bfa3c1ee?source=collection_archive---------4-----------------------#2020-01-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/4e0dd9c0e59c248a5c5345d466a81b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IwI3UFT8BmTwyY9k_vcbg.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">在<a class="ae jg" href="https://unsplash.com/@helloquence?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae jg" href="https://unsplash.com/@helloquence?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Helloquence </a>拍摄的照片</p></figure><h2 id="56e6" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph">功能数据工程|星形模式</h2><div class=""/><div class=""><h2 id="80ff" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">创建没有更新、锁定或ACID合规性的星型模式</h2></div><p id="94de" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在这篇文章中，我将描述如何设计<strong class="lj jt">维度</strong>、<strong class="lj jt">事实</strong>以及在不执行<em class="md">可变</em>变更的情况下为其提供信息的流程。</p><p id="91eb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">出于本文的目的，我将假设数据在一个便宜的云存储上，由一个直接操作文件的计算引擎处理，并写入不可变的块中。</p><p id="ac95" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">了解大数据堆栈中的事务性、更新和锁定选项。Databricks和Snowflake围绕提供这些服务(以及更多服务)建立了非常成功的企业。Databricks甚至开源了“<a class="ae jg" href="https://delta.io/" rel="noopener ugc nofollow" target="_blank"> Delta Lake </a>”，为Apache Spark带来了其中的一些功能。</p><p id="c9b8" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而，更新是大数据堆栈中复杂的操作。我相信保持我们的大部分数据处理不变是更容易维护和推理的。</p><p id="db3a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">更新可能会给数据管道带来不必要的灵活性。我见过一个团队只通过(非常低效的)更新来扩展另一个团队拥有的表，而不是协作和扩展公共脚本。不变性迫使数据管道具有某种<strong class="lj jt">结构</strong>。</p><p id="ba51" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我将从高层次描述星型模式概念开始，并解释为什么它们今天仍然相关。如果你熟悉这些概念，我邀请你跳到<strong class="lj jt">“管理维度”</strong>。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="ceb7" class="ml mm jj bd mn mo mp mq mr ms mt mu mv ky mw kz mx lb my lc mz le na lf nb nc bi translated">星形模式</h1><p id="e621" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">星型模式是一种关系建模技术，它将与业务流程相关的度量或事件(事实)从其上下文(维度)中分离出来。</p><p id="56ff" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">与关系数据库模式(应用程序数据库)相比，它更加<a class="ae jg" href="https://medium.com/@katedoesdev/normalized-vs-denormalized-databases-210e1d67927d" rel="noopener">非规范化</a>，并且被设计为对分析查询(<a class="ae jg" href="https://en.wikipedia.org/wiki/Online_analytical_processing" rel="noopener ugc nofollow" target="_blank"> OLAP </a>工作负载)高效。</p><p id="5249" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt">举例:</strong></p><p id="61f4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在电子商务网站中，业务流程的一个例子是网站上的交易。</p><p id="521f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在这种情况下，一些示例度量是:交易期间支付的金额和购买的产品数量。</p><p id="cdbf" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">上下文包括:进行交易的用户、交易日期和购买的产品。</p><figure class="nj nk nl nm gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ni"><img src="../Images/cf2510f1979a0b6736570efd7e327ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PG8JSNSROK-S0oyc9WvuKg.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">简化星形模式提取</p></figure><p id="cee0" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><em class="md">实际上，每个交易可能包含不同的产品:这是一个简化的模型</em></p><blockquote class="nn no np"><p id="5278" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated">星型模式的名字来源于物理模型与星型的相似性，星型的中心有一个事实表，周围的维度表代表星型的点</p><p id="2ccc" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated"><a class="ae jg" href="https://en.wikipedia.org/wiki/Star_schema" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Star_schema</a></p></blockquote><h2 id="6864" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">雪花模式</h2><p id="0578" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">维度可以进一步规范化:例如，产品的“品牌”可以保存在一个单独的表中，该表具有与“产品”的外键关系，从而创建一个从<em class="md">维度到</em>维度的关系。</p><p id="cd45" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">星型模式维度的进一步规范化导致了“雪花模式”，从历史上看，其主要目标是<em class="md">减少冗余数据量</em>(节省存储)。</p><p id="3dce" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">缺点是雪花模式通过更多的连接引入了更多的复杂性。随着存储变得不那么受关注，对于大多数情况来说,“雪花模式”方法是不合适的。</p><h2 id="be9f" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">大数据中的星型模式相关性</h2><p id="a5ed" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">星型模式是在存储和计算昂贵的时代创建的。因为存储昂贵且有限，减少数据冗余是数据仓库团队的主要关注点。</p><p id="b93b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这也是支持数据仓库查询的有效方式，因为通过维度表的连接和过滤器，可以跳过事实表上的大量数据。可预测的访问模式允许简单的优化，比如在事实表的外键上创建索引。</p><blockquote class="nn no np"><p id="e548" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated">简洁明了—所有外键列都应该有一个非聚集的非唯一索引。</p><p id="c661" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated"><a class="ae jg" href="https://www.datavail.com/blog/how-to-index-a-fact-table-a-best-practice/" rel="noopener ugc nofollow" target="_blank">https://www . data vail . com/blog/how-to-index-a-fact-table-a-best-practice/</a></p></blockquote><p id="a910" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如今，存储很便宜，并且根据需要配置计算能力(相对而言)很容易。我们可以衡量设计和实现这些模型的工程成本与节省的硬件成本，并问自己— <strong class="lj jt">这样做还值得吗？</strong></p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><figure class="nj nk nl nm gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oe"><img src="../Images/e91e295e1108ae39c059ec1c1011ad1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHNokdWQ3m-IP0YwrAB4Lw.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@acharki95?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿齐兹·阿查基</a>在<a class="ae jg" href="https://unsplash.com/s/photos/star?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="0fae" class="ml mm jj bd mn mo of mq mr ms og mu mv ky oh kz mx lb oi lc mz le oj lf nb nc bi translated"><strong class="ak">为什么星型模式仍然相关？</strong></h1><h2 id="3e78" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">多样的来源</h2><p id="8786" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">公司从越来越多的来源收集越来越多的数据，需要对产生的数据集进行协调以进行分析。</p><p id="1d4d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">例如，有线电视网络可能有非常不同的系统来托管有关其电视订户和其新推出的流媒体服务的订户的信息。同样，他们的“客户支持”分析必须整合来自Twitter、第三方呼叫中心和支持电子邮件的数据。</p><p id="7ba9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">标准化工作的目标是汇集“订户”、“客户反馈”和其他逻辑实体的不同定义，消除否则将由异构源系统引入的分析复杂性。</p><h2 id="d445" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">标准</h2><p id="7587" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">Ralph Kimball编写的数据仓库工具包(1996)和Kimball集团网站<a class="ae jg" href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/" rel="noopener ugc nofollow" target="_blank">定义了业内广泛理解的概念(如星型模式)。</a></p><p id="408e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">新员工可以快速掌握数据仓库结构，而不需要熟悉组织的具体情况。</p><p id="15b3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">数据工程师、数据科学家和分析师有共同的术语(事实、维度、粒度)，有助于协作。</p><h2 id="967e" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">展开性</h2><p id="40d1" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">新添加的事实可以重用现有的维度。</p><p id="7a9b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">通过向事实表添加更多的外键，可以向事实添加新的维度。</p><p id="3092" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">因此，可以集成新的数据集，而无需对模式进行重大更改。</p><h2 id="d023" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">表演</h2><p id="31b5" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">星型模式可以完全通过在Map-Reduce框架中容易并行化的插入和计算来填充(我们将在下一节中看到“如何进行”)。</p><p id="ebcb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt">查询性能调优:</strong></p><p id="8acb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">虽然外键索引通常不是一个选项，因为它们在许多现代数据仓库框架中不受支持，但是我们有其他选项来提高性能。</p><p id="7c64" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">维度通常很小，有时可以放在内存中，支持<a class="ae jg" href="https://jaceklaskowski.gitbooks.io/mastering-spark-sql/spark-sql-joins-broadcast.html" rel="noopener ugc nofollow" target="_blank">地图端</a>连接优化(参见<a class="ae jg" href="https://jaceklaskowski.gitbooks.io/mastering-spark-sql/spark-sql-joins-broadcast.html" rel="noopener ugc nofollow" target="_blank"> Spark的BroadcastJoin </a>)。</p><p id="7340" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们可以在维度表上使用<a class="ae jg" href="https://kb.databricks.com/data/bucketing.html" rel="noopener ugc nofollow" target="_blank">桶</a>。</p><p id="74dc" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Spark支持<a class="ae jg" href="https://developer.ibm.com/code/2018/04/16/star-schema-enhancements-in-apache-spark/" rel="noopener ugc nofollow" target="_blank">星型模式检测、</a>对连接进行重新排序并有效地跳过数据。</p><h2 id="f212" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">适应大数据</h2><p id="8000" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">1996年的许多实践今天仍然适用，但是一些方法需要重新定义。</p><p id="a99f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Lyft<a class="ok ol ep" href="https://medium.com/u/54708edc644b?source=post_page-----7819bfa3c1ee--------------------------------" rel="noopener" target="_blank">等公司已经成功地更新了这些数据仓库实践，以适应新的技术环境。</a><a class="ok ol ep" href="https://medium.com/u/9f4d525c99e2?source=post_page-----7819bfa3c1ee--------------------------------" rel="noopener" target="_blank"> Maxime Beauchemin </a>就这个主题做了一个很棒的演讲<a class="ae jg" href="https://www.youtube.com/watch?v=4Spo2QRTz1k&amp;t=989s" rel="noopener ugc nofollow" target="_blank">，</a>这篇文章的“管理维度”部分很大程度上受到了它的启发。</p><blockquote class="nn no np"><p id="6580" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated">来自同一个演讲:</p><p id="aa90" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated"><em class="jj">先学习规则，再打破规则</em></p></blockquote></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><figure class="nj nk nl nm gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi om"><img src="../Images/1adb410390f094656dc104731343bf40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWCvCd-9zjyInx7EyswoQA.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://www.pexels.com/@eye4dtail?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd on">乔治·贝克尔</strong> </a>发自<a class="ae jg" href="https://www.pexels.com/photo/close-up-of-keys-333837/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd on">派克斯</strong> </a></p></figure><h1 id="65d0" class="ml mm jj bd mn mo of mq mr ms og mu mv ky oh kz mx lb oi lc mz le oj lf nb nc bi translated">外键</h1><h2 id="68da" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">自然键</h2><p id="9c4e" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">数据仓库书籍警告<a class="ae jg" href="https://www.kimballgroup.com/1998/05/surrogate-keys/" rel="noopener ugc nofollow" target="_blank">不要重复使用“自然键”</a>(来自生产系统的唯一id)作为事实表中的外键。</p><p id="6d46" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果表被部分清空(出于性能原因)，生产系统中的自然键可能会重用id。因为数据仓库保存历史数据，IDs的重用会产生难以解决的冲突。</p><h2 id="9baa" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">顺序生成的id</h2><p id="5548" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">创建“代理键”<strong class="lj jt">的最佳实践是</strong>使用由数据处理系统顺序生成的整数id，并与生产系统的自然键分离。</p><p id="e9ce" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">整数可以节省存储空间，创建更小更高效的T4索引。</p><p id="763c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">现代数据仓库中不使用索引。Hive 3.0 <a class="ae jg" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Indexing" rel="noopener ugc nofollow" target="_blank">移除了索引</a>，它们被<em class="md">替换为</em>在文件(ORC、Parquet)、物理分区和存储桶中编译的统计信息/元数据，这同样能够跳过大部分数据。</p><h2 id="1d52" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">性能命中</h2><p id="b173" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">生成代理键是一个复杂的并行操作。</p><p id="823a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这篇<a class="ae jg" href="https://cloud.google.com/blog/products/data-analytics/bigquery-and-surrogate-keys-practical-approach" rel="noopener ugc nofollow" target="_blank"> BigQuery (Google)博客文章</a>描述了使用通用方法(对新行使用<code class="fe oo op oq or b">ROW_NUMBER</code>函数)添加生成序列的限制:</p><blockquote class="nn no np"><p id="782a" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated">不幸的是，这种方法是有限的。为了实现<code class="fe oo op oq or b">ROW_NUMBER()</code>，BigQuery需要在执行树的根节点对值进行排序，这受限于一个执行节点的内存量。</p></blockquote><h2 id="c977" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">解决方案</h2><p id="be6c" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">UUIDs和散列更容易并行化，这使得它成为为“大”数据集生成id的更具可伸缩性的方法。</p><p id="03b4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">对于“维度快照”，我们更喜欢使用散列而不是UUIDs，我们将在下面的小节中讨论动机:<strong class="lj jt">“管理维度”/“代理键”</strong>。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><figure class="nj nk nl nm gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi os"><img src="../Images/494f5c298c22299d31e8a5e66da3b4bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvK0Kn6I-HQpxwF8dGTQ4w.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片来自<a class="ae jg" href="https://www.pexels.com/@startup-stock-photos?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd on">创业股票照片</strong> </a>来自<a class="ae jg" href="https://www.pexels.com/photo/man-marker-blackboard-handwriting-7364/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd on"> Pexels </strong> </a></p></figure><h1 id="beba" class="ml mm jj bd mn mo of mq mr ms og mu mv ky oh kz mx lb oi lc mz le oj lf nb nc bi translated">管理维度</h1><h2 id="b99f" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated"><strong class="ak">静态尺寸</strong></h2><p id="c8a1" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">一些特殊维度如<a class="ae jg" href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/calendar-date-dimension/" rel="noopener ugc nofollow" target="_blank">“日期”维度</a>(静态维度)，是<strong class="lj jt">生成</strong>，而不是数据处理的结果。这些表可以预先生成，并且不会保留它们的更改历史。</p><p id="76e1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">当一个维度是静态的时，我们可以在每次需要对它进行修改时简单地用<strong class="lj jt">覆盖</strong>整个数据。</p><h2 id="4fe3" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">缓慢和快速变化的尺寸</h2><p id="c74f" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">对于要求<em class="md">随时间变化的维度</em>，我们需要一种策略来改变数据。</p><p id="f331" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">用户可以更改其家庭地址，产品可以更改名称，品牌可以更换所有者。</p><p id="fa0f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">多年来，许多“类型”的缓慢和快速变化的维度管理策略被形式化了。其中一些保留历史记录，大多数使用“更新”就地添加或修改信息。</p><p id="6385" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这里的<strong class="lj jt">是</strong>具有<strong class="lj jt">快速改变</strong>属性的维度和具有<strong class="lj jt">缓慢改变</strong>属性的维度之间的分离。</p><p id="f50f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在保存历史记录的维度中，当记录中的任何属性发生更改时，需要复制整行数据，如果属性经常更改，则会使用更多的存储空间。</p><p id="5ab3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这些技术很复杂，因为它们是在严格的存储限制下设计的。</p><p id="0b03" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">维度快照使用<strong class="lj jt">更多的存储</strong>，但是它们<strong class="lj jt">更容易创建和查询</strong>。</p><h2 id="ce83" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">维度快照</h2><p id="b982" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">尺寸应该比事实小得多。一个电子商务的交易、订单和客户评论(事实)可能有数百万，但是独立客户的数量(维度)会小得多。</p><p id="e7c3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">维度也因其携带的“状态”而不同于事实。维度中的记录将有一个“身份”,当其他属性改变时，需要保留该身份。</p><p id="b33b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt">维度快照易于管理</strong></p><p id="b9b8" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">每天，我们都会在版本化快照中重写整个维度表</p><pre class="nj nk nl nm gt ot or ou ov aw ow bi"><span id="7c1d" class="nt mm jj or b gy ox oy l oz pa">s3://my_data_warehouse/dim_users/ds=2020-01-01<br/>s3://my_data_warehouse/dim_users/ds=2020-01-02<br/>...</span></pre><p id="4d96" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">因为不管发生多少变化，整个表都会被重写，所以对于快速和缓慢变化的维度采用不同的策略没有什么好处。</p><p id="f4ff" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt">历史</strong></p><p id="2160" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">有了这个模型，我们可以通过在特定的日子加入一个<strong class="lj jt">过滤器来轻松回答历史问题。</strong></p><p id="6d70" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">历史记录也不会减慢查询速度，因为传递特定日期实际上会跳过其他日期的文件。</p><p id="a0ac" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">该表的结构使得尺寸表上的<strong class="lj jt">时序</strong>变得容易。例如，我们可以计算一段时间内每个居住国家的用户数量。</p><p id="76e3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt">代理键</strong></p><p id="cb3b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">UUIDs引入了<em class="md">随机性。为了保持新的代理键与前一个快照的代理键一致，我们需要查询那个快照。</em></p><p id="7dbb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">相反，散列是基于构成记录“身份”的键的连接(不包括自然键)，因此我们只能从<strong class="lj jt">当前数据</strong>重新计算它。这就是为什么我们更喜欢在维度快照中使用UUIDs散列的原因。</p><p id="8963" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">请注意，每日快照消除了对第二个密钥的需要。某些类型的渐变维度实现了两个代理键:一个指向维度记录的“最新”状态，另一个指向特定事实被摄取时记录的历史快照。因为每个快照都包含该时间点的所有数据，所以我们可以使用快照的日期来获得“最新”状态，或者给定时间点的状态。</p><p id="f4b0" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">那不会产生大量数据吗？</p><p id="343d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">数据重复是维度快照的主要缺点。</p><p id="6c63" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">另一个缺点是维度只需要从<strong class="lj jt">的一个进程</strong>中创建，因为一天多个快照会加重重复。</p><p id="157e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">以比每天更频繁的频率刷新维度的要求也会放大重复。</p><p id="25f9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">收益是<strong class="lj jt">简单性</strong>、<strong class="lj jt">易于访问历史</strong>、<strong class="lj jt">维度上的时间序列</strong>和<strong class="lj jt">在写入和查询方面的性能</strong>。</p><p id="1b96" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而，在数据复制不可行的情况下，我们可以求助于另一种缓慢变化的维度管理。使用像<a class="ae jg" href="https://delta.io/" rel="noopener ugc nofollow" target="_blank">三角洲湖</a>这样的项目来支持更新。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><figure class="nj nk nl nm gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pb"><img src="../Images/d5da416a89e3a64a01b91ae6783cfc20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQ1Ye5gzzP8IFbLgG8TgoA.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@climatereality?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash<a class="ae jg" href="https://unsplash.com/s/photos/facts-matter?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">上的</a>气候现实项目拍摄</a></p></figure><h1 id="8d09" class="ml mm jj bd mn mo of mq mr ms og mu mv ky oh kz mx lb oi lc mz le oj lf nb nc bi translated">管理事实</h1><blockquote class="nn no np"><p id="f50a" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated">事实表是数据仓库的基础。它们包含企业的基本度量，并且是大多数数据仓库查询的最终目标</p><p id="95d1" class="lh li md lj b lk ll kt lm ln lo kw lp nq lr ls lt nr lv lw lx ns lz ma mb mc im bi translated"><a class="ae jg" href="https://www.kimballgroup.com/2008/11/fact-tables/" rel="noopener ugc nofollow" target="_blank">https://www.kimballgroup.com/2008/11/fact-tables/</a></p></blockquote><p id="6ad8" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">有多种类型的事实模型来涵盖事实表旨在捕捉的不同度量和事件。</p><h2 id="ec9a" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">谷物</h2><p id="e441" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">在设计事实时，我们需要决定表中每一行的详细程度。</p><p id="5801" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">预先汇总事实可以节省存储空间，但这是一个高风险的赌注，因为来自业务的分析需求可能在未来需要更多的细节。对于今天的大多数情况，在<strong class="lj jt">最低细节层次</strong>捕捉事实信息是可取的。</p><h2 id="adf5" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">仅插入</h2><p id="f44c" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">绝大多数事实不需要更新。即使在<a class="ae jg" href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/accumulating-snapshot-fact-table/" rel="noopener ugc nofollow" target="_blank">累积快照</a>的特定情况下，我们也可以通过一种消除可变性需求的方式来设计模型。</p><p id="be4f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">例如，对于电子商务订单，如果我们有状态:<code class="fe oo op oq or b">ORDER_BEING_PREPARED, ORDER_SHIPPED, ORDER_IN_TRANSIT</code>。我们可以创建新的状态来象征先前状态的结束，而不是每次动作结束时都去事实表并用一个<code class="fe oo op oq or b">end_date</code>来更新行:<code class="fe oo op oq or b">ORDER_BEING_PREPARED_END, ORDER_SHIPPED_END, ORDER_IN_TRANSIT_END</code>。现在每个状态的改变都是一个可以插入的独立事件。</p><h2 id="ef1a" class="nt mm jj bd mn nu nv dn mr nw nx dp mv lq ny nz mx lu oa ob mz ly oc od nb jp bi translated">物理分区</h2><p id="c66d" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">为了创建在上游错误或业务需求变化的情况下可以被覆盖的不可变分区，我们需要按照“<strong class="lj jt">提取日期</strong>”——从源系统提取数据的日期——对我们的数据进行分区。</p><p id="da57" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">第一个分区键通常对查询性能没什么用，但是对于实现<a class="ae jg" href="https://medium.com/@maximebeauchemin/functional-data-engineering-a-modern-paradigm-for-batch-data-processing-2327ec32c42a" rel="noopener">等幂批处理作业</a>来说很重要。</p><p id="cbc4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">此外，建议按“<strong class="lj jt">事件日期</strong>进行分区，因为查询经常使用它作为过滤器(WHERE子句)。</p><p id="3cbf" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">可以添加其他分区键来额外提高查询速度，但是我们需要确保它们在过滤器中使用，并且生成的文件<a class="ae jg" href="https://blog.cloudera.com/the-small-files-problem/" rel="noopener ugc nofollow" target="_blank">不会太小</a>。</p><p id="695d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><em class="md">表格结构示例:</em></p><pre class="nj nk nl nm gt ot or ou ov aw ow bi"><span id="26c5" class="nt mm jj or b gy ox oy l oz pa">under s3://my_data_warehouse/fact_transactions:</span><span id="dec4" class="nt mm jj or b gy pc oy l oz pa">/event_date=2020-02-05/extraction_date=2020-02-05/event_date=2020-02-05/extraction_date=2020-02-06<br/>/event_date=2020-02-06/extraction_date=2020-02-06<br/>...</span></pre><p id="c3e0" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们的数据处理作业在5号创建了1个分区:即<code class="fe oo op oq or b">/event_date=2020–02–05/extraction_date=2020–02–05</code>分区。</p><p id="319d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而在6号:在<em class="md">前一天</em>发生的一些事务被<em class="md"> </em>延迟捕获，因此创建了两个分区:<code class="fe oo op oq or b">/event_date=2020–02–05/extraction_date=2020–02–06</code>和<code class="fe oo op oq or b">/event_date=2020–02–06/extraction_date=2020–02–06</code>，这通常被称为<a class="ae jg" href="https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/late-arriving-fact/" rel="noopener ugc nofollow" target="_blank">、</a>，并且由该表结构支持。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="4060" class="ml mm jj bd mn mo mp mq mr ms mt mu mv ky mw kz mx lb my lc mz le na lf nb nc bi translated">最后</h1><p id="9a4a" class="pw-post-body-paragraph lh li jj lj b lk nd kt lm ln ne kw lp lq nf ls lt lu ng lw lx ly nh ma mb mc im bi translated">通过采用“星型架构”方法来利用廉价的云存储，我们可以避免数据仓库中的更新、锁定和ACID合规性需求。</p><ul class=""><li id="97ce" class="pd pe jj lj b lk ll ln lo lq pf lu pg ly ph mc pi pj pk pl bi translated">外键是<strong class="lj jt">散列</strong>而不是整数序列</li><li id="4f8a" class="pd pe jj lj b lk pm ln pn lq po lu pp ly pq mc pi pj pk pl bi translated">维度使用<strong class="lj jt">每日快照</strong></li><li id="71b5" class="pd pe jj lj b lk pm ln pn lq po lu pp ly pq mc pi pj pk pl bi translated">事实按照“<strong class="lj jt">提取日期</strong>进行分区，以支持等幂处理和分区的潜在覆盖</li></ul></div></div>    
</body>
</html>