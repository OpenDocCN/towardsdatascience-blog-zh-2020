<html>
<head>
<title>Using One Line of Code to Write to a Relational Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用一行代码写入关系数据库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-just-one-line-of-code-to-write-to-a-relational-database-3ed08a643c5f?source=collection_archive---------23-----------------------#2020-07-28">https://towardsdatascience.com/using-just-one-line-of-code-to-write-to-a-relational-database-3ed08a643c5f?source=collection_archive---------23-----------------------#2020-07-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="849a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">PYTHON 和 SQL</h2><div class=""/><div class=""><h2 id="3179" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">这将使添加到数据库变得更加容易。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/5fa65c81d0a3b4850d3ad8f5712f2cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hdLjG8zc1ns5KiIW-2wOZg.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">由 Instagram @softie__art 制作的艺术作品<a class="ae lh" href="https://www.instagram.com/softie__arts/" rel="noopener ugc nofollow" target="_blank"/></p></figure><p id="6785" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当将数据从 Pandas 数据帧写入 SQL 数据库时，我们将使用<code class="fe me mf mg mh b">DataFrame.to_sql</code>方法。虽然您可以执行一个<code class="fe me mf mg mh b">INSERT INTO</code>类型的 SQL 查询，但是原生的 Pandas 方法使得这个过程更加容易。</p><p id="c9f1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下面是从<a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_sql.html" rel="noopener ugc nofollow" target="_blank">熊猫文档</a>中摘录的<code class="fe me mf mg mh b">DataFrame.to_sql</code>的完整参数列表:</p><p id="7df7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe me mf mg mh b"><strong class="lk jd">DataFrame.to_sql</strong></code> ( <em class="mi"> self </em>，<em class="mi">name:</em><a class="ae lh" href="https://docs.python.org/3/library/stdtypes.html#str" rel="noopener ugc nofollow" target="_blank"><em class="mi">str</em></a>，<em class="mi"> con </em>，<em class="mi"> schema=None </em>，<em class="mi">if _ exists:</em><a class="ae lh" href="https://docs.python.org/3/library/stdtypes.html#str" rel="noopener ugc nofollow" target="_blank"><em class="mi">str</em></a><em class="mi">= ' fail '</em>，<em class="mi">index:</em><a class="ae lh" href="https://docs.python.org/3/library/functions.html#bool" rel="noopener ugc nofollow" target="_blank"><em class="mi">bool</em></a><em class="mi"/></p><p id="b57c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了向您展示这种方法是如何工作的，我们将通过几个例子向费用记录的数据库添加交易。在本文中，我们将使用 SQLite 数据库。<code class="fe me mf mg mh b">DataFrame.to_sql</code>与 SQLite 和 SQLAlchemy 支持的其他数据库一起工作。</p><p id="eda5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请随意创建您自己的数据库，以便您可以跟进。如果您对创建数据库不熟悉，下面快速介绍一下如何免费设置一个简单的 SQLite 数据库:</p><div class="mj mk gp gr ml mm"><a rel="noopener follow" target="_blank" href="/an-easy-way-to-get-started-with-databases-on-your-own-computer-46f01709561"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd jd gy z fp mr fr fs ms fu fw jc bi translated">在自己的计算机上开始使用数据库的简单方法</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">介绍如何使用 SQLite 浏览器来管理自己的数据库。</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">towardsdatascience.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na lb mm"/></div></div></a></div><p id="f43e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在开始之前，不要忘记导入 Pandas 和 SQLite:</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="d0b6" class="nf ng it mh b gy nh ni l nj nk">import sqlite3<br/>import pandas as pd</span></pre><h1 id="fdbb" class="nl ng it bd nm nn no np nq nr ns nt nu ki nv kj nw kl nx km ny ko nz kp oa ob bi translated">用熊猫写数据库</h1><p id="039d" class="pw-post-body-paragraph li lj it lk b ll oc kd ln lo od kg lq lr oe lt lu lv of lx ly lz og mb mc md im bi translated">在本练习中，我将在数据库的“Expense”表中插入新行:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/fdec37b7c0b2eaa64259d6dab5cd4ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*mDF_nXrU8CzESbF2TnJv6Q.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">示例 SQLite 数据库表</p></figure><p id="fc25" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我用以下代码生成了一个示例事务数据框架:</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="52ec" class="nf ng it mh b gy nh ni l nj nk">data = {'Person': ['Byron'], 'Amount': [20], 'Category': ['Groceries'], 'Date':['27-08-20']}<br/>df = pd.DataFrame.from_dict(data)</span></pre><p id="155b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将插入到费用表中的数据帧如下所示:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oi"><img src="../Images/ec36a1f1a455c5fc77cf99c7edeab403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LULcBSIIAdr6cHpHUUEngQ.png"/></div></div></figure><p id="8c85" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">准备输入新记录时，请确保数据框架中的列名与数据库表中的列名相匹配。</p><p id="8915" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">此外，所有操作都需要一个连接参数，您可以将它作为参数提供给<code class="fe me mf mg mh b">con</code>。要为 SQLite 数据库这样做，只需准备好这个变量供重用，其中<code class="fe me mf mg mh b">db</code>是本地 SQLite 数据库的文件路径。</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="2c6d" class="nf ng it mh b gy nh ni l nj nk">conn = sqlite3.connect(db)</span></pre><p id="e1da" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在我们准备好开始了！</p><h2 id="589e" class="nf ng it bd nm oj ok dn nq ol om dp nu lr on oo nw lv op oq ny lz or os oa iz bi translated">基本插入(和警告)</h2><p id="1a71" class="pw-post-body-paragraph li lj it lk b ll oc kd ln lo od kg lq lr oe lt lu lv of lx ly lz og mb mc md im bi translated">对于第一个例子，正如我们承诺的，我们使用下面一行代码:</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="b191" class="nf ng it mh b gy nh ni l nj nk">df.to_sql(‘Expenses’, con=conn, if_exists=’append’, index=False)</span></pre><p id="fb68" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这里，我们将<code class="fe me mf mg mh b">"Expenses"</code>作为我们想要写入的 SQLite 数据库中的表名。如前所述，我们还包含了<code class="fe me mf mg mh b">con=conn</code>，这样我们就可以连接到相关的 SQL 数据库。</p><p id="d6b0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">默认情况下，如果一个表不存在，并且您尝试了上面的代码，<strong class="lk jd">一个新的表将在您的数据库中以您指定的名称创建</strong>。如果您想用现有的数据框架创建一个表，这是一种可行的方法。</p><p id="49f3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于我们的例子，表已经存在，所以我们需要指定应该发生什么。因为我们希望向表中添加新行并保留表中已有的行，所以我们传递<code class="fe me mf mg mh b">if_exists='append'</code>，以便将数据帧中的新值插入到数据库表中。确保包括这一点，因为默认行为是<code class="fe me mf mg mh b">if_exists='fail'</code>，这意味着代码将<strong class="lk jd">而不是</strong>执行。</p><p id="d53b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们还传递了<code class="fe me mf mg mh b">index=False</code>，因为<code class="fe me mf mg mh b">index=True</code>的默认行为是将数据帧的索引作为一列写入数据库表。但是，我们不需要这些信息，因为当我们添加新行时，SQLite 数据库中的“ID”列会自动增加。</p><p id="c994" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">自己摆弄这些参数，然后用 DB Browser for SQLite 检查更改，或者打印如下表格:</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="951c" class="nf ng it mh b gy nh ni l nj nk">conn.execute("SELECT * FROM Expenses").fetchall()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ot"><img src="../Images/e80e35d88d4175b5dd8a648ced8510bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Rol54kE11EpmYghuaTGgw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">用于检查结果的 SQL 查询的部分输出</p></figure><h2 id="7cff" class="nf ng it bd nm oj ok dn nq ol om dp nu lr on oo nw lv op oq ny lz or os oa iz bi translated">写入大型数据帧—块大小</h2><p id="032c" class="pw-post-body-paragraph li lj it lk b ll oc kd ln lo od kg lq lr oe lt lu lv of lx ly lz og mb mc md im bi translated">在前面的例子中，我们所做的只是将一个包含一行的数据帧插入到数据库表中。然而，对于更大的操作，如果您想写一个有几千行的数据帧，您可能会遇到一些问题。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/b6d96bdfc8d3f7ee7650b7126f645e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ke8jlDt7u51VZtPFIrrJdg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">从<a class="ae lh" href="https://stackoverflow.com/questions/48440957/cloud-sql-insert-error-when-missing-values-big-file" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a>发出样本</p></figure><p id="56bd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这可能是因为不同数据库的数据包大小限制。如果您的数据帧超过最大数据包大小(即一次发送的数据太多)，将会发生错误，因为默认情况下，所有行都是一次写入的。</p><p id="1f9c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以通过指定一个<code class="fe me mf mg mh b">chunksize</code>来避免这种错误，T8 是您想要一次插入到数据库表中的数据帧中的行数。</p><p id="05df" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">例如，如果您有一个包含 2，000 行的表，并且您使用的数据库的最大数据包大小一次只允许 1，000 行，那么您可以将 chunksize 设置为 1，000 来满足该要求。</p><pre class="ks kt ku kv gt nb mh nc nd aw ne bi"><span id="2cab" class="nf ng it mh b gy nh ni l nj nk">df.to_sql(‘Expenses’, con=conn, index=False, chunksize=1000)</span></pre></div><div class="ab cl ov ow hx ox" role="separator"><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa"/></div><div class="im in io ip iq"><p id="5c6c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我希望这个快速概述对您有用！Pandas 库提供了丰富的功能，可以进行各种各样的数据相关操作，您可以充分利用这些功能。如果您总是使用 SQL 查询或其他 Python 方法向数据库写入数据，那么单行的<code class="fe me mf mg mh b">DataFrame.to_sql</code>方法应该会为您提供一种快速而简单的替代方法。</p><p id="1cb3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您正在寻找一种简单的方法来探索和理解您的数据，Pandas 还提供了不同的排序功能来实现这一点:</p><div class="mj mk gp gr ml mm"><a rel="noopener follow" target="_blank" href="/4-different-ways-to-efficiently-sort-a-pandas-dataframe-9aba423f12db"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd jd gy z fp mr fr fs ms fu fw jc bi translated">4 种不同的方法来有效地排序熊猫数据帧</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">正确探索、理解和组织您的数据。</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">towardsdatascience.com</p></div></div><div class="mv l"><div class="pc l mx my mz mv na lb mm"/></div></div></a></div><p id="972a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要了解 Pandas MultiIndex 功能，它可用于各种高级数据分析任务，请查看以下内容:</p><div class="mj mk gp gr ml mm"><a rel="noopener follow" target="_blank" href="/how-to-use-multiindex-in-pandas-to-level-up-your-analysis-aeac7f451fce"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd jd gy z fp mr fr fs ms fu fw jc bi translated">如何在 Pandas 中使用 MultiIndex 来提升您的分析</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">复杂数据分析中数据帧的层次索引介绍</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">towardsdatascience.com</p></div></div><div class="mv l"><div class="pd l mx my mz mv na lb mm"/></div></div></a></div></div></div>    
</body>
</html>