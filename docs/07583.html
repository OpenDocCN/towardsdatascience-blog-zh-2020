<html>
<head>
<title>Identify Variables High On Memory Consumption</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">识别内存消耗高的变量</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/did-you-know-how-to-identify-variables-in-your-python-code-which-are-high-on-memory-consumption-787bef949dbd?source=collection_archive---------52-----------------------#2020-06-07">https://towardsdatascience.com/did-you-know-how-to-identify-variables-in-your-python-code-which-are-high-on-memory-consumption-787bef949dbd?source=collection_archive---------52-----------------------#2020-06-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d6b0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">优化 Python 代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/536d544916c8e1e7892e8c86678616f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S_Ocj8BbwAxKmuxK"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@possessedphotography?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">附身摄影</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="ff47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时候，在执行 Python 脚本时，我们会遇到<strong class="ky ir">内存错误</strong>。这些错误主要是由于一些变量<strong class="ky ir">内存消耗高</strong>。</p><p id="d88a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我们将重点关注剖析 Python 代码以<strong class="ky ir">优化内存消耗</strong>。<strong class="ky ir">内存分析</strong>是一个过程，使用它我们可以剖析我们的代码并识别导致内存错误的变量。</p><h2 id="f05e" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated"><strong class="ak"> 1。)内存分析器</strong></h2><ul class=""><li id="d28a" class="ml mm iq ky b kz mn lc mo lf mp lj mq ln mr lr ms mt mu mv bi translated"><strong class="ky ir">内存分析器</strong>是一个 python 包，它评估函数中编写的每一行 Python 代码，并相应地检查内部内存的使用情况。</li><li id="aeb1" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated">我们可以使用<strong class="ky ir"> <em class="nb"> pip 或者 conda 包管理器</em> </strong> <em class="nb"> </em>来安装这个包。如果使用<strong class="ky ir"> <em class="nb"> Anaconda </em> </strong>发行版，我会推荐使用<strong class="ky ir"> <em class="nb"> conda install </em> </strong>，因为它会自动解决依赖和环境问题。</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="98ee" class="ls lt iq nd b gy nh ni l nj nk"><strong class="nd ir">#### Install Packages<br/></strong>conda install memory_profiler</span></pre><ul class=""><li id="f2d8" class="ml mm iq ky b kz la lc ld lf nl lj nm ln nn lr ms mt mu mv bi translated">安装完成后，可以使用以下代码行在<strong class="ky ir"> <em class="nb"> iPython </em> </strong>环境中加载评测器:</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="3016" class="ls lt iq nd b gy nh ni l nj nk"><strong class="nd ir">#### Loading Memory Profiler Package<br/></strong>%load_ext memory_profiler</span></pre><ul class=""><li id="6e94" class="ml mm iq ky b kz la lc ld lf nl lj nm ln nn lr ms mt mu mv bi translated">加载后，使用以下语法对任何预定义的函数进行内存分析:</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="d84c" class="ls lt iq nd b gy nh ni l nj nk"><strong class="nd ir">#### Memory Profiling a Function<br/></strong>%mprun -f function_name_only Call_to_function_with_arguments</span></pre><p id="c38b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注</strong>:要使用内存评测器评测一个函数，将其作为一个模块导入，这意味着将其写入一个单独的<strong class="ky ir"> <em class="nb">。py </em> </strong>文件，然后像其他包一样导入到主程序中。</p><h2 id="a651" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">2.)工作示例</h2><p id="a5dd" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf no lh li lj np ll lm ln nq lp lq lr ij bi translated">对于本教程，我使用了与<a class="ae kv" href="https://pypi.org/project/memory-profiler/" rel="noopener ugc nofollow" target="_blank">内存分析器的 PyPi 网页</a>相同的功能。它<strong class="ky ir">创建两个有大量元素的列表变量</strong>，然后删除其中一个(参考下面代码中的函数定义)。然后我们保存并导入这个函数到主程序中进行分析。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="dfdb" class="ls lt iq nd b gy nh ni l nj nk"><strong class="nd ir">#### Function Definition (Saved as example.py file)</strong><br/>def my_func(): <br/>    a = [1] * (10 ** 6) <br/>    b = [2] * (2 * 10 ** 7) <br/>    del b <br/>    return a</span><span id="df16" class="ls lt iq nd b gy nr ni l nj nk"><strong class="nd ir">#### Loading the line profiler within ipython/jupyter environment<br/></strong>%load_ext memory_profiler<br/>from example import my_func</span><span id="61bf" class="ls lt iq nd b gy nr ni l nj nk"><strong class="nd ir">#### Profiling the function using line_profiler</strong><br/>%mprun -f my_func my_func()</span><span id="7c83" class="ls lt iq nd b gy nr ni l nj nk"><strong class="nd ir">#### Memory Profile Output</strong><br/>Line #    Mem usage    Increment   Line Contents<br/>================================================<br/>     1     50.8 MiB     50.8 MiB   def my_func():<br/>     2     58.4 MiB      7.6 MiB    a = [1] * (10 ** 6)<br/>     3    211.0 MiB    152.6 MiB    b = [2] * (2 * 10 ** 7)<br/>     4     58.4 MiB      0.0 MiB    del b<br/>     5     58.4 MiB      0.0 MiB    return a</span></pre><h1 id="bbdf" class="ns lt iq bd lu nt nu nv lx nw nx ny ma jw nz jx md jz oa ka mg kc ob kd mj oc bi translated">说明</h1><p id="51cd" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf no lh li lj np ll lm ln nq lp lq lr ij bi translated">从内存分析器的输出中，可以看到输出表有四列:</p><ul class=""><li id="156e" class="ml mm iq ky b kz la lc ld lf nl lj nm ln nn lr ms mt mu mv bi translated"><strong class="ky ir">第 1 列(行号)</strong> —代码行号</li><li id="0bae" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated"><strong class="ky ir">第 2 列(内存使用)</strong> —函数使用的总内存，直到行号</li><li id="9de2" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated"><strong class="ky ir">第 3 列(增量)</strong> —程序特定行使用的内存</li><li id="21ee" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated"><strong class="ky ir">第 4 列(内容)</strong> —实际代码内容</li></ul><p id="b20e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:从程序中去掉<strong class="ky ir"> <em class="nb">变量“b”</em></strong>后内存消耗明显下降。</p><p id="8a91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从表中可以清楚地看出，<strong class="ky ir"> <em class="nb">变量“b”</em></strong>的创建导致了内存使用量的突然激增。在实时场景中，一旦我们意识到这样的发现，我们总是可以寻找其他方法来编写代码，使内存消耗保持在可接受的范围内。</p><h1 id="e791" class="ns lt iq bd lu nt nu nv lx nw nx ny ma jw nz jx md jz oa ka mg kc ob kd mj oc bi translated">结束语</h1><p id="3bfd" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf no lh li lj np ll lm ln nq lp lq lr ij bi translated">在这个简短的教程中，我们学习了 Python 代码的内存分析。要了解 Python 代码的时间分析，请参考<a class="ae kv" rel="noopener" target="_blank" href="/did-you-know-you-can-measure-the-execution-time-of-python-codes-14c3b422d438">本</a>教程。</p><p id="b529" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这个<strong class="ky ir">你知道吗</strong>系列的教程信息丰富，足智多谋。</p><p id="615a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在未来的教程中尝试引入更多有趣的话题。在此之前:</p><p id="a515" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快乐学习！！！！</p></div></div>    
</body>
</html>