<html>
<head>
<title>Solving dependency management in Python with Poetry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用诗歌解决 Python 中的依赖管理</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/solving-dependency-management-in-python-with-poetry-165b92069e9d?source=collection_archive---------12-----------------------#2020-02-16">https://towardsdatascience.com/solving-dependency-management-in-python-with-poetry-165b92069e9d?source=collection_archive---------12-----------------------#2020-02-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2fde" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" rel="noopener" target="_blank" href="https://towardsdatascience.com/data-science-in-the-real-world/home">现实世界中的数据科学</a></h2><div class=""/><div class=""><h2 id="2e85" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">为我们的 Python 工作流带来简单性和一致性</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/38a4cf36a7b17a3c594fcc6e0af9c87e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mM8cgc1ZhN1eEbJzsXUc-g.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">一列火车拉着它在加利福尼亚州埃默里维尔的所有附属物</p></figure><p id="5114" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我的团队最近选择向我们的技术堆栈添加另一个工具，<a class="ae me" href="https://python-poetry.org/" rel="noopener ugc nofollow" target="_blank">poem</a>。与每一个技术决策一样，这个决策是经过仔细考虑的，以避免不必要的复杂性。那么我们为什么决定用诗歌呢？</p><p id="42e4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">来自<a class="ae me" href="https://medium.com/bbc-design-engineering/server-timing-in-the-wild-bfb34816322e" rel="noopener">一个建设网站的世界</a>，我已经习惯了<a class="ae me" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a>。有了 npm，JavaScript 世界将依赖性管理视为一个已解决的问题。在我们的 Python 项目中，我们只是使用 pip，我们可以遵循两个基本的工作流程:</p><ul class=""><li id="c102" class="mf mg it lk b ll lm lo lp lr mh lv mi lz mj md mk ml mm mn bi translated">手动管理顶层所需的依赖项</li><li id="626d" class="mf mg it lk b ll mo lo mp lr mq lv mr lz ms md mk ml mm mn bi translated">使用<code class="fe mt mu mv mw b">pip freeze</code>收集所有的依赖项</li></ul><h1 id="b347" class="mx my it bd mz na nb nc nd ne nf ng nh ki ni kj nj kl nk km nl ko nm kp nn no bi translated">定义你需要什么</h1><p id="b16a" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr nr lt lu lv ns lx ly lz nt mb mc md im bi translated">在这种方法中，您创建一个需求文件，看起来像:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="d155" class="ny my it mw b gy nz oa l ob oc">pandas==1.0.1</span></pre><p id="0f75" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这样做的好处是更容易理解，因为你只是直接使用熊猫。然后使用 pip 安装这些依赖项及其依赖项:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="ced3" class="ny my it mw b gy nz oa l ob oc">pip install -r requirements.txt</span></pre><p id="2b3c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这意味着您可以为任何开发依赖项创建一个单独的文件:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="e185" class="ny my it mw b gy nz oa l ob oc">pip install -r dev_requirements.txt</span></pre><p id="e9b5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这允许您将生产需求从开发需求中分离出来。仅安装您的生产需求有助于减少生产构建的规模。减少生产中的软件包数量还可以通过减少攻击面来提高安全性。</p><p id="a616" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">不幸的是，您必须维护这个文件，并且您对依赖关系没有什么控制权。每次运行<code class="fe mt mu mv mw b">pip install</code>时，您的依赖项都有被安装不同版本的风险。</p><h1 id="48a0" class="mx my it bd mz na nb nc nd ne nf ng nh ki ni kj nj kl nk km nl ko nm kp nn no bi translated">冻结所有依赖项</h1><p id="84ba" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr nr lt lu lv ns lx ly lz nt mb mc md im bi translated">另一种方法是使用 pip 的更多功能来冻结您的依赖项。运行<code class="fe mt mu mv mw b">pip install</code>，然后运行<code class="fe mt mu mv mw b">pip freeze</code>，会给你一个所有已安装软件包的列表。例如，运行<code class="fe mt mu mv mw b">pip install pandas</code>将导致<code class="fe mt mu mv mw b">pip freeze</code>输出:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="656a" class="ny my it mw b gy nz oa l ob oc">numpy==1.18.1<br/>pandas==1.0.1<br/>python-dateutil==2.8.1<br/>pytz==2019.3<br/>six==1.14.0</span></pre><p id="9c40" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这很好，因为它可以让您将依赖项锁定到特定的版本，从而创建一个可重复的环境。不幸的是，如果你在 pip 运行的环境中安装了任何东西，它都会被添加到这个列表中。例如，您决定安装 numba，看看它是否能加快您的处理速度。这会导致以下冻结的依赖关系:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="c6b1" class="ny my it mw b gy nz oa l ob oc">llvmlite==0.31.0<br/>numba==0.48.0<br/>numpy==1.18.1<br/>pandas==1.0.1<br/>python-dateutil==2.8.1<br/>pytz==2019.3<br/>six==1.14.0</span></pre><p id="8919" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但遗憾的是，numba 并没有你想要的性能提升。当您运行<code class="fe mt mu mv mw b">pip uninstall numba</code>时，它确实会删除 numba，但不一定会删除 numba 安装的所有依赖项:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="55ac" class="ny my it mw b gy nz oa l ob oc">llvmlite==0.31.0<br/>numpy==1.18.1<br/>pandas==1.0.1<br/>python-dateutil==2.8.1<br/>pytz==2019.3<br/>six==1.14.0</span></pre><p id="4ba6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意到你现在有一个额外的<code class="fe mt mu mv mw b">llvmlite</code>包，你可能永远也不会摆脱它了吗？</p><p id="d50d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">值得注意的是，有一些工具可以解决这个问题并消除所有的依赖性。但是还有一点需要考虑。如果您安装了开发依赖项，它们也会导致这个问题。</p><h1 id="93dc" class="mx my it bd mz na nb nc nd ne nf ng nh ki ni kj nj kl nk km nl ko nm kp nn no bi translated">两全其美</h1><p id="1fdc" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr nr lt lu lv ns lx ly lz nt mb mc md im bi translated">诗歌可以通过简单的界面做到以上两点。当您调用<code class="fe mt mu mv mw b">poetry add</code>时，它会将包添加到一个<code class="fe mt mu mv mw b">pyproject.toml</code>文件中，以跟踪顶层依赖关系(包括 Python 本身):</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="4f0e" class="ny my it mw b gy nz oa l ob oc">[tool.poetry.dependencies]<br/>python = "^3.7"<br/>pandas = "^1.0.1"</span></pre><p id="13ce" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这与一个包含所有已安装软件包的<code class="fe mt mu mv mw b">poetry.lock</code>文件成对出现，锁定到一个特定的版本。在本文中嵌入锁文件会占用很多空间，因为默认情况下它包含了散列以确保包的完整性。下面是一个片段:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="7a58" class="ny my it mw b gy nz oa l ob oc">[[package]]<br/>category = "main"<br/>description = "Python 2 and 3 compatibility utilities"<br/>name = "six"<br/>optional = false<br/>python-versions = "&gt;=2.7, !=3.0.*, !=3.1.*, !=3.2.*"<br/>version = "1.14.0"</span><span id="c7e9" class="ny my it mw b gy od oa l ob oc">[metadata]<br/>content-hash = "5889192b2c2bef6b6ceae7457fc90225ba0c38a80ecd15bbbbf5871f91a08825"<br/>python-versions = "^3.7"</span><span id="7d02" class="ny my it mw b gy od oa l ob oc">[metadata.files]<br/>six = [<br/>{file = "six-1.14.0-py2.py3-none-any.whl", hash = "sha256:8f3cd2e254d8f793e7f3d6d9df77b92252b52637291d0f0da013c76ea2724b6c"},<br/>{file = "six-1.14.0.tar.gz", hash = "sha256:236bdbdce46e6e6a3d61a337c0f8b763ca1e8717c03b369e87a7ec7ce1319c0a"},<br/>]</span></pre><p id="4b72" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了用 numba 重复我们的实验，我们使用了<code class="fe mt mu mv mw b">poetry add numba</code>和<code class="fe mt mu mv mw b">poetry remove numba</code>。这些命令还从环境和依赖锁定文件中删除了<code class="fe mt mu mv mw b">llvmlite</code>。通过移除依赖性和清理，poem 使我们能够尝试更多的软件包，以一种简单的方式清理我们的虚拟环境。</p><p id="4580" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后，诗歌拆分出生产依赖和开发依赖。如果我们想写一些测试，我们可以使用<code class="fe mt mu mv mw b">poetry add -D pytest</code>，结果是:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="072d" class="ny my it mw b gy nz oa l ob oc">[tool.poetry.dependencies]<br/>python = "^3.7"<br/>pandas = "^1.0.1"</span><span id="7e23" class="ny my it mw b gy od oa l ob oc">[tool.poetry.dev-dependencies]<br/>pytest = "^5.3.5"</span></pre><p id="2964" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当创建产品包时，您可以使用<code class="fe mt mu mv mw b">poetry install --no-dev</code>忽略任何用于开发的东西。</p><h1 id="5e0f" class="mx my it bd mz na nb nc nd ne nf ng nh ki ni kj nj kl nk km nl ko nm kp nn no bi translated">使用虚拟环境</h1><p id="17d6" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr nr lt lu lv ns lx ly lz nt mb mc md im bi translated">去年<a class="ae me" href="https://medium.com/sainsburys-data-analytics/the-case-for-switching-from-conda-to-virtual-environments-in-python-de3211d8f6f" rel="noopener">我的一位同事写了一篇很棒的文章，讲述了我们为什么在数据科学中使用虚拟环境</a>。诗歌在这里也有一些补充，为你的项目自动管理它们。所以不用跑了:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="71a5" class="ny my it mw b gy nz oa l ob oc">python -m venv .venv<br/>. .venv/bin/activate<br/>super-command</span></pre><p id="7784" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你只需输入:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="61a1" class="ny my it mw b gy nz oa l ob oc">poetry run super-command</span></pre><p id="5c3f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">poems 为您的项目创建一个虚拟环境，它与您指定的 Python 版本相匹配。默认情况下，这保存在项目根目录之外，以免造成混乱。我的团队出于其他原因选择将虚拟环境放回项目目录中，原因很简单:</p><pre class="ks kt ku kv gt nu mw nv nw aw nx bi"><span id="41a7" class="ny my it mw b gy nz oa l ob oc">poetry config --local virtualenvs.in-project true</span></pre><p id="76b3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这在相当标准的<code class="fe mt mu mv mw b">.venv</code>文件夹中创建了虚拟环境。这有点麻烦，它创建了另一个<code class="fe mt mu mv mw b">poetry.toml</code>文件，而不是使用主<code class="fe mt mu mv mw b">pyproject.toml</code>。</p><h1 id="9a24" class="mx my it bd mz na nb nc nd ne nf ng nh ki ni kj nj kl nk km nl ko nm kp nn no bi translated">这种事以前肯定有人做过吧？</h1><p id="8aa7" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr nr lt lu lv ns lx ly lz nt mb mc md im bi translated">还有其他在诗歌之前就已经存在的工具可以满足这些要求。诗歌也利用了很多 Python 自己的增强提议，比如<a class="ae me" href="https://www.python.org/dev/peps/pep-0508/" rel="noopener ugc nofollow" target="_blank"> PEP-508 </a>、<a class="ae me" href="https://www.python.org/dev/peps/pep-0517/" rel="noopener ugc nofollow" target="_blank"> PEP-517 </a>和<a class="ae me" href="https://www.python.org/dev/peps/pep-0518/" rel="noopener ugc nofollow" target="_blank"> PEP-518 </a>。这些 PEP 致力于使用<code class="fe mt mu mv mw b">pyproject.toml</code>作为配置项目的主要位置。当考虑诗歌的寿命时，遵循 pep 给了我们对我们正在使用的特性的未来支持的信心。</p><p id="69ee" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">希望这解释了为什么我对我的团队选择使用诗歌而不是之前的替代品充满信心。如果你正在寻找更详细的历史介绍和更具体的诗歌命令，我会推荐 Todd Birchard 的<a class="ae me" href="https://hackingandslacking.com/package-python-projects-the-proper-way-with-poetry-ca1e94a1727b" rel="noopener ugc nofollow" target="_blank">Package Python Projects the right Way</a>。对于其他与诗歌结合的工具，请看 Simon Hawe 的<a class="ae me" rel="noopener" target="_blank" href="/how-to-setup-an-awesome-python-environment-for-data-science-or-anything-else-35d358cc95d5">如何为数据科学或其他东西建立一个令人敬畏的 Python 环境</a>。</p><p id="ee10" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">工程师和数据科学家合作翻译项目，这是一个非常简单的转变。构建新项目也变得更加简单，使我们能够试验不同的包，并在投入生产时获得特定的确定性构建。</p></div></div>    
</body>
</html>