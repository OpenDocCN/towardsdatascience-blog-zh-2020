<html>
<head>
<title>Getting Started with DynamoDB Streams and AWS Lambda in .NET Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">中的DynamoDB流和AWS Lambda入门。网络核心</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-dynamodb-streams-with-aws-lambda-and-net-core-62db43ae98c1?source=collection_archive---------14-----------------------#2020-02-02">https://towardsdatascience.com/how-to-use-dynamodb-streams-with-aws-lambda-and-net-core-62db43ae98c1?source=collection_archive---------14-----------------------#2020-02-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7511" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用AWS Lambda在C#中使用DynamoDB流的分步教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e7e8204372031f0147c52c8944035cb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E9-aRdJ6NwaiNp8o3tR-Mg.png"/></div></div></figure><p id="1cec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">事件驱动编程在当今的软件世界中非常流行。用松散耦合的、可独立部署的、易于扩展的组件来构建一个系统有很多优点。可以利用无服务器工具来创建其中的一些组件；一个AWS，这通常意味着使用DynamoDB和Lambda。在本文中，我们将构建一个小型的事件驱动系统，其中DynamoDB是我们的事件源，Lambda函数被调用来响应这些事件。为此，我们将使用一个名为DynamoDB Streams的特性。</p><p id="47a5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在一个表上启用DynamoDB流后，对该表的所有修改都会被记录下来，并按顺序推送到流中。AWS没有指定流的内部，但是它们非常类似于Kinesis流(并且可能在幕后使用它们)。)有多种方法来使用流，包括使用Kinesis客户端库(AWS提供的SDK)，但最简单的方法之一是将流配置为Lambda函数的触发器。</p><p id="87c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，让我们浏览启用DynamoDB流的过程，编写一个简短的Lambda函数来使用流中的事件，并将DynamoDB流配置为Lambda函数的触发器。我们将一步一步来，但如果你想跳到最后，检查源代码和Terraform，直接去我的<a class="ae lq" href="https://github.com/matthew-harper/dynamodb_stream_consumer" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>。如果你需要复习DynamoDB的基础知识，可以看看我写的关于<a class="ae lq" href="https://medium.com/trimble-maps-engineering-blog/getting-started-with-dynamodb-and-net-core-how-to-build-a-leaderboard-4335f2bd56a8" rel="noopener">开始使用DynamoDB </a>的文章。</p><h1 id="5647" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">先决条件</h1><p id="72ef" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">为了准确地遵循这个指南，你需要安装Visual Studio 2019和<a class="ae lq" href="https://aws.amazon.com/visualstudio/" rel="noopener ugc nofollow" target="_blank"> AWS工具包</a>。我在这里使用这种设置是因为它与Lambda紧密集成；只需点击一下，即可将您的代码发布到AWS。</p><p id="8c89" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我包含了一个Terraform文件来创建DynamoDB表(包括它的索引和流)。如果你以前没有使用过Terraform，这是一个很棒的工具，可以让你把基础设施写成代码。或者，您可以使用AWS管理控制台手动创建和配置DynamoDB表。</p><h1 id="cf45" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">创建DynamoDB表和流</h1><p id="386d" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">我们先来看一下Terraform文件<a class="ae lq" href="https://github.com/matthew-harper/dynamodb_stream_consumer/blob/master/StreamConsumerLambda/main.tf" rel="noopener ugc nofollow" target="_blank"> main.tf </a>。该文件只包含一个资源(基础设施对象)——我们的DynamoDB表。在这个资源中，定义了表的每个属性和索引(在<a class="ae lq" href="https://medium.com/trimble-maps-engineering-blog/getting-started-with-dynamodb-and-net-core-how-to-build-a-leaderboard-4335f2bd56a8" rel="noopener">的前一篇文章</a>中概述了全局和辅助索引)。)</p><p id="c856" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">启用流所需的两个参数是stream_enabled(布尔)<br/>和stream_view_type(枚举)。steam_view_type允许您选择将多少数据推送到流中。您可以从四个选项中进行选择:</p><ul class=""><li id="0fcd" class="mo mp it kw b kx ky la lb ld mq lh mr ll ms lp mt mu mv mw bi translated">KEYS_ONLY —仅修改记录的分区和排序键</li><li id="9144" class="mo mp it kw b kx mx la my ld mz lh na ll nb lp mt mu mv mw bi translated">NEW _ IMAGE更新记录的所有属性</li><li id="b27c" class="mo mp it kw b kx mx la my ld mz lh na ll nb lp mt mu mv mw bi translated">OLD_IMAGE —修改前记录的所有属性</li><li id="1c1e" class="mo mp it kw b kx mx la my ld mz lh na ll nb lp mt mu mv mw bi translated">新图像和旧图像-修改前后的所有属性</li></ul><p id="33e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的示例中，我们将选择NEW_AND_OLD_IMAGES，这样我们可以获得尽可能多的信息。一般来说，您会希望在使用最少数据量的同时选择满足您需求的选项。</p><p id="71d0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您想使用Terraform在AWS中运行这个数据库，唯一需要的先决条件是您的机器上已经存储了<a class="ae lq" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/create-shared-credentials-file.html" rel="noopener ugc nofollow" target="_blank">共享AWS凭证</a>(如果您曾经使用过AWS CLI，那么您已经准备好了。)<a class="ae lq" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">下载Terraform </a>并添加到你的路径中。编辑main.tf文件，并将“profile”更改为您自己的AWS概要文件的名称。然后在包含。tf文件并运行以下两个命令:</p><p id="2cc9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Terraform将执行生成基础设施所需的所有AWS APIs。如果您对terraform文件进行了更改，您可以再次运行“terraform应用”来执行更新。当你用完后，执行“terraform destroy”将从你的AWS环境中删除你的所有更改。</p><h1 id="d112" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">创建一个Lambda来使用该流</h1><p id="01de" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">有了我们的表，让我们为Lambda函数编写代码来使用它。打开Visual Studio 201并创建一个新的AWS Lambda项目(。NET Core c#)；一旦安装了AWS Toolkit for Visual Studio，就可以使用这个模板。当提示选择蓝图时，选择“空函数”,因为我们要从头开始。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/d7735199617dd7d98883c9226d8beb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAE727_USnZtuDlQ7bPUOg.png"/></div></div></figure><p id="0054" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">看看我们项目的NuGet依赖项。模板已经添加了基本Lambda函数所需的包。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/739be1ff9bea0bfa1e33a20d24e6d668.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*VVqqyH3jurtmlnKUhH-_Bw.png"/></div></figure><p id="a127" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们需要再添加一个依赖项。从管理Nuget包窗口，搜索并安装Amazon.Lambda.DynamoDBEvents。看一看它，然后我们将讨论它:</p><p id="c687" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在顶部附近，我们为Amazon添加了一个using指令。Lambda.DynamoDBEvents命名空间。然后我们转到模板提供的Lambda函数(FunctionHandler)，它接受一个字符串和一个ILambdaContext作为参数。ILambdaContext包含关于Lambda函数的有用信息，比如内存限制、剩余执行时间和日志访问，所以我们将保留这些信息。我们用DynamoDBEvent替换了string参数；此对象包含DynamodbStreamRecord对象的列表。每个DynamodbStreamRecord都是对DynamoDB表的单个数据修改的描述。</p><p id="ee17" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我们配置Lambda来监听DynamoDB流时，我们将选择一个最大批处理大小和一个收集该批处理的时间窗口。因此，我们的函数需要能够在每次被调用时处理多个DynamodbStreamRecord。所以我们添加了一个循环来遍历DynamoDBEvent中的每一项并执行一些操作。在我们的示例中，操作是使用ILambdaContext。Logger将关于事件的信息写入CloudWatch，但是您可以修改函数的内容以适应您的用例。</p><p id="a49d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">代码准备就绪后，我们可以通过在解决方案资源管理器中右键单击项目并选择“发布到AWS Lambda”来将函数发布到AWS。"为您的新Lambda函数选择一个名称和一个AWS区域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/865387deb6112941277180d13a62031d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOzRikIEpV5B8tIwYvbi_g.png"/></div></div></figure><p id="db63" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下一个屏幕将询问关于Lambda的更多细节。我们将对默认值进行的唯一更改是选择一个IAM角色；这指定了Lambda在执行期间必须与其他AWS服务交互的特权。基于AWSLambdaDynamoDBEecutionRole创建一个新角色—这允许对DynamoDB流的列表和读取访问，以及对CloudWatch日志的写入访问。然后继续把你的函数上传到云端。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/793c0992649329755df012f989c04e5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6KsmU8C6AmVPYrOIYto5dA.png"/></div></div></figure><h1 id="1340" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">Lambda配置— AWS控制台</h1><p id="8e5a" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">最后一步，导航到AWS控制台的Lambda部分，选择我们刚刚发布的函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/88f93cc054dfc11d0f0cbd4a9ba80eae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5cXr2Sw56KnlaPjqt2euQ.png"/></div></div></figure><p id="336a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将添加一个触发器，以便每当记录被添加到DynamoDB流中时启动Lambda函数。从功能配置屏幕中选择“添加触发器”并选择DynamodDB。您将看到下面的屏幕，为我们的事件源编写详细信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/85dce7b8dd9c87c8fc5797b4e948aa4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bD2Z9rJGr9pSgThmmNp-Wg.png"/></div></div></figure><p id="9e9b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">确保选择了所需的DynamoDB表，然后查看其他选项。批处理大小是每次执行时发送给我们的函数的DynamodbStreamRecords的最大数量。批处理窗口决定了流从表中读取事件并调用Lambda函数的步调，以秒为单位。对于这个例子，默认的选择就足够了，但是在现实世界中，您会希望根据您的用例来定制这些选择。较短的批处理窗口对于需要接近实时地对更新做出反应的应用程序来说是有意义的，而较长的窗口(和较大的批处理大小)在处理单个项目是快速操作并且可以在批处理过程之间暂停的情况下可能更具成本效益。</p><h1 id="4d22" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">测试和验证</h1><p id="a930" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">是时候试试我们创造的东西了。前往AWS控制台中的DynamoDB表，并开始进行更改。添加一些新记录。修改现有记录。我们如何知道我们的流和Lambda是否在工作？嗯，由于我们的Lambda写入CloudWatch，我们必须检查日志。在AWS控制台中导航到CloudWatch，并从侧栏中选择log groups。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/3ae1e5aa305dbebaaf431078f2766fc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdbJmbvnJ9Exa9IDsjUVVA.png"/></div></div></figure><p id="a095" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您应该会看到一个与Lambda函数同名的组。打开它，你会发现一个日志流列表。Lambda函数的每个执行上下文将创建一个流。作为参考，第一次调用函数时，会创建一个执行上下文(函数的临时运行时环境)。连续调用你的函数会遇到相同的上下文，直到十分钟后你的函数才执行。冷却期过后，再次调用Lambda将导致函数被加载到一个新的执行上下文中(这就是所谓的冷启动。)对函数的多次同时调用也可能导致创建新的执行上下文，因为一个执行上下文一次只能处理一个请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/6515fdbc2eefb61658af85e58fcbf556.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8YulfPPF0AzYlVb2sLCUA.png"/></div></div></figure><p id="c238" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">无论如何，您应该看到至少一个日志流。如果没有，请尝试刷新页面；有时日志需要一段时间来传播。如果你仍然运气不好，检查你为Lambda配置的触发器，确保它被设置到正确的DynamoDB表。此外，如果您的批处理窗口大小被设置为大于零的任何值，那么您必须等到它到期时，流才会收集所有的表修改。当您点击流时，您应该会看到类似如下的日志:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/6653593c683752a2ed273ea829dab47e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZeHdZzTV3wyYaqrZ9dyig.png"/></div></div></figure><p id="97fe" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您还可以进入CloudWatch指标，显示有关您的功能的更多信息。下面你会发现一个令人兴奋的函数调用图；你可以看到我们在2:25从0到1。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/918e92692115edf7adea85fc638f0db5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j-NTZWZIo5GPcylBfw_gTA.png"/></div></div></figure><h1 id="c2b2" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">概述</h1><p id="e181" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">流允许有趣的用例，否则在DynamoDB中很难支持这些用例。每当一个用户超过他当前的最高分，我们就可以给他发电子邮件。我们还可以聚合数据并将其写入另一个表中；也许我们会跟踪某个游戏的高分在某个时间窗口内改变了多少次。流还支持数据复制；这在我们希望在更适合这类活动的数据库(如SQL Server或Redshift)中运行分析查询的情况下非常有用。)花几分钟时间试用它们，看看它们是否适合您未来应用程序中的用例。</p></div></div>    
</body>
</html>