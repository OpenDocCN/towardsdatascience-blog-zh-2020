<html>
<head>
<title>Anomaly Detection in Multivariate Time Series with VAR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于 VAR 的多元时间序列异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/anomaly-detection-in-multivariate-time-series-with-var-2130f276e5e9?source=collection_archive---------11-----------------------#2020-06-17">https://towardsdatascience.com/anomaly-detection-in-multivariate-time-series-with-var-2130f276e5e9?source=collection_archive---------11-----------------------#2020-06-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="93fb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">存在序列相关性时的系统监控</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3527aa89539637cf01e74d13a7aa33e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5RNgtllr_vBPbGSf"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@jannerboy62?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">尼克·费因斯</a>拍摄</p></figure><p id="6131" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">异常检测是机器学习中的一个热门话题。正如我们所猜测的，“异常”的定义是可变的，并且与领域相关。在时间序列应用中，当我们面对这类问题时，我们还必须考虑时间维度。一个系列的历史包含了关于其行为的大量信息，并且可以暗示其未来的变化。这对于不是由随机游走过程产生的序列和表现出循环/周期性模式的序列来说尤其如此。</p><p id="b48c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理时间序列并从过去学习信息的简单已知模型是 ARIMA。ARIMA 模型是开发时间序列预测工具的重要工具。他们学习序列如何演变的能力在异常检测任务中也是有用的。从这个意义上说，经典方法包括将超出容许阈值的观察标记为异常。这种方法仅限于奇异级数；如果我们想考虑一个更复杂的系统，我们需要另一种方法。</p><p id="3a37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们将介绍一种方法来检测由多个相关序列组成的复杂系统中的异常。我们使用 VAR 模型，ARIMA 的多变量扩展，从我们处理的序列中提取相关模式。VAR 学习到的信息随后用于构建阈值机制，以便在我们的指标超过临界值时发出警报。</p><h1 id="b8b4" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据</h1><p id="feca" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们从 Kaggle 那里获取实验数据。<a class="ae ky" href="https://www.kaggle.com/city-of-seattle/seattle-burke-gilman-trail" rel="noopener ugc nofollow" target="_blank">西雅图伯克吉尔曼步道</a>是西雅图市托管的数据集，是其开放数据项目的一部分。数据集存储传感器检测到的每小时计数序列。这些传感器可以计算骑自行车的人和行人。为每种出行模式记录单独的交通量。混凝土中菱形排列的电线探测自行车，安装在木柱上的红外传感器探测行人。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/691cccaad3239cf2926684fcebcde125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLUOyZuwwXktLuPQqQJh0Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">可供我们使用的每日汇总时间序列示例</p></figure><p id="bf60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总共提供 5 个计数系列。2 个与行人计数相关，2 个与自行车计数相关，总计是前面系列的总和。行人和自行车有两个柜台，因为登记了两个行驶方向。</p><p id="854a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据这些数据，我们的异常检测之旅分为两部分。首先，我们提供了一个经典的单变量异常检测方法使用 ARIMA。最后，我们通过一个多变量的方法考虑所有的系列和他们在系统中的相互作用。根据这篇文章的范围，我们决定聚合我们可以处理的数据，从每小时的数据到每天的数据。</p><h1 id="a234" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">单变量异常检测</h1><p id="f84b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在单变量异常方法中，我们计划使用 ARIMA 来检测奇怪模式的存在。我们决定把重点放在总计数系列上。开发 ARIMA 时，首先要处理的是平稳性、爆炸性趋势或季节性。从上面的图和下面的自相关可以很容易地看出，总计数序列呈现出双重季节性:每周和每年。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/4669315a13e6c4eff9e477a6ad588064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kdEZ4Zdd-syCBRhx8ja9Nw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">原始自相关</p></figure><p id="c8c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">长期的季节性会很烦人。为了消除它，我们每天减去根据训练数据计算的相对月平均值。这样，我们只剩下每周的模式，我们的模型可以毫无问题地学习它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/b97507d3c44edd2de3f01e4df16c43f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCbBgSFYony7vuFGqa1eJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">去除长期季节性后的自相关</p></figure><p id="e82f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们拟合了最佳 ARIMA，将搜索限制在 7 自回归阶附近，同时最小化 AIC。最终的模型似乎产生没有任何自相关程度的正常残差。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/e5e9ebe1eb8a746db7bcd89c5e9f155a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cEdijLfUt2bvolX4fOSH3Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ARIMA 拟合数据</p></figure><p id="9431" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装好 ARIMA 后，我们就可以开始寻找异常点了。我们有两种可能性:我们可以将置信区间之外的每个观察值识别为异常，或者我们可以查看残差。每个程序都需要生成迭代预测，并每次用实际值评估我们的预测。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/a22a0925ec23681c3ab70152f8bf35d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VADvvZZccnfMT0P95E_63Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">测试预测</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/aa40654e9b3a77da669fa3b34c2a48c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4m7ErxmapJTWO232trXDgg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">标准化测试残差</p></figure><p id="f976" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以通过 alpha 置信度参数来指定预测间隔深度。残差分析需要标准化操作(必须计算训练残差的平均值和标准偏差)。这样，我们可以使用正态分布的残差和来自正态分布的固定置信阈值进行操作。</p><h1 id="40d2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">多元异常检测</h1><p id="b68b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">前一种方法的多元推广涉及到 VAR 模型的采用。VAR 模型通过捕捉多个变量之间的线性关系，扩展了单变量自回归(AR)模型。对于每个输入序列，进行回归。原始变量根据它们自己的滞后值和其他变量的滞后值进行回归。对于我们的多元任务，我们同时考虑自行车和行人系列。</p><p id="4911" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在存在序列相关性的多变量过程系统中，我们使用 VAR 模型来逼近系统，并将残差作为一个序列独立的序列进行监控。由于过程动力学的物理原理，使用 VAR 来近似线性系统是合适的。</p><p id="890e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">VAR 训练与选择最小化 AIC 的最佳阶数之前一样计算。数据以同样的方式标准化，以消除长期的季节性。毫不奇怪，最好的模型是 VAR(7)。测试残差数据的独立性和正态性后，可以计算霍特林 T 平方统计量来检测异常的早期存在:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/4905e1022d433d21b57f25ef2e3be4e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*lKy-CgCI4qmS9anrp1QdFw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">霍特林·T2 的公式。e 是估计的残差；适马是 e 的协方差矩阵</p></figure><p id="6047" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">T 平方控制图的应用分两个阶段进行:控制界限建立阶段和监控阶段。第一阶段的重点是获得模型残差，以便计算出的控制极限可用于第二阶段，用于监控未来异常的残差过程。T 平方控制图的控制限由下式给出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/5cda6357ccab02e5d9d69e85be1b5e99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*404AbCeKlaRnptda26T5KQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">上限控制统计</p></figure><p id="3196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其中 F 代表具有 p 和 n-p 个自由度和α显著性水平的 F 分布。如果 T2 &gt; UCL，那么停下来调查一下。在阶段 1 结束时获得的估计适马(以及残差均值和标准差)用于计算每个新观测值的 T 平方统计量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/158071cf2966ffc89e79c90505f287d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DcpXqaY4zhEwQB7IyXftzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">列车数据上的 T2 加 UCL</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/2cf616dd6007cb0e973bed439e98cfd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dNzokHqNZtbLjk_0bpPq_g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">测试数据上的 T2 加 UCL</p></figure><h1 id="aba7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">摘要</h1><p id="d01e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这篇文章中，我们介绍了执行异常检测任务的良好工作流。我们开始研究单变量的情况。我们使用一个拟合的 ARIMA 作为判断来检测未来的观察是否异常。我们也意识到现实可能更复杂，可能需要考虑不同变量之间的相互作用。出于这个原因，我们将我们的分析扩展到 VAR 模型的多变量情况。我们收集了 VAR 残差，并使用它们来建立一个阈值警报系统，在出现异常行为时发出警报。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><p id="0555" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/cerlymarco/MEDIUM_NoteBook" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">查看我的 GITHUB 回购</strong> </a></p><p id="133f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保持联系:<a class="ae ky" href="https://www.linkedin.com/in/marco-cerliani-b0bba714b/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a></p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><p id="32f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">参考文献</strong></p><p id="86b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用向量自回归残差在序列相关下监测多元过程</p></div></div>    
</body>
</html>