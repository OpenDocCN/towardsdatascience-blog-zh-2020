<html>
<head>
<title>Using SelectFromModel &amp; SHAP to Create a Better Explainable XGBClassifier Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SelectFromModel &amp; SHAP创建一个更好解释的XGBClassifier模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-selectfrommodel-to-create-a-better-xgbclassifier-model-ddebdf9b68fe?source=collection_archive---------30-----------------------#2020-02-08">https://towardsdatascience.com/using-selectfrommodel-to-create-a-better-xgbclassifier-model-ddebdf9b68fe?source=collection_archive---------30-----------------------#2020-02-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8d56" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何改进你的模型，并将结果传达给你的非技术团队。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/27558a3d3e65ceea232187dab3a1bb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vRz_ALggPGsTjyaq"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com/@araltasher?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aral Tasher </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="388b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理零售数据总是很有趣，尤其是与客户的人口统计数据结合在一起的时候。当我在探索星巴克简化的促销、产品组合和顾客数据时，我知道我想用它做什么。这很简单；练习一些编码、数据工程、特征工程和模型设计。</p><p id="0e5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型将用于更好地预测未来促销的影响，以及谁将从中受益。然而，我在这里的真正目标是探索<em class="lv">【选择来自模型】</em>函数&amp;<em class="lv">【SHAP】</em>库。</p><p id="d0db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们需要一个分类模型，我们有一些很好的选项可以尝试。我们可以尝试集合方法，或者KNN，神经网络，或者任何可以完成这项工作的方法。然而，由于数据是高度分类的，并且神经网络计算量大，我们将使用集成方法。此外，将神经网络用于所有事情会阻止我们扩展我们的技能集和对数据的理解。</p><h1 id="0576" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据探索和清理</h1><p id="2298" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">除了客户的收入和性别。三个数据框中的所有字段都没有丢失任何值。例外的两个字段是不可归入的，因为许多值缺失(各12.79%)，并且由于没有提交此类数据的客户也提供了假的出生年份(他们是118岁，这不太可能)。由于估算是不可能的，而且我不想输入缺少所有人口统计数据的记录，所以这些记录被从数据框中删除了。</p><p id="3ddc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，是ol '常规预处理；更正数据类型，为非二进制分类字段创建虚拟变量，解析字段，并删除不重要的字段。</p><h1 id="24b2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据和特征工程</h1><p id="056d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了利用一些看起来不重要或无用的领域，需要设计新的领域。字段<em class="lv">“time”</em>包含从数据收集开始到一个月之前的小时计数器。我已经创建了字段<em class="lv">“一天中的某个小时”</em>和<em class="lv">“一周中的某天”</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8a196b5991d7d429531baf9b695861d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h1Vl6kvNLiZphYlc"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@isaacmsmith?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Isaac Smith </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="81bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出于探索的目的，我还在字段<em class="lv">【值】</em>之外创建了字段<em class="lv">【关键字】</em>和<em class="lv">【值】</em>。然而，它们没有任何用处，因为<em class="lv">“价值”中的不同值表示不同的概念(</em>一些是花费的金额，另一些是报价标识符)，而<em class="lv">“密钥”</em>只是降级的<em class="lv">“标签”</em>。</p><p id="2267" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我还创建了字段<em class="lv">“任期”</em>来显示每个人注册该应用程序后的天数。</p><p id="9d70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，这三个数据框已准备好合并成一个大数据框。</p><h1 id="e228" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">模型设计和改进</h1><p id="7322" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我决定对购买的状态进行分类，不管是不是已经兑现。我选择分类的一个原因是，数据不包含要约-赎回交易的支付金额。如果所有交易的价值都是可用的，我们可能会得到一个更好的模型，甚至更好，探索每个报价对销售和收入的影响。</p><p id="8823" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有四个标签要分类；a) <em class="lv">【交易】</em>，当没有报价要查看时进行交易，b) <em class="lv">【报价已接收】</em>，报价已发送，但未被查看，c) <em class="lv">【报价已查看】</em>，发送的报价已被用户查看，但未被兑换，最后，d) <em class="lv">【报价已完成】</em>，用户已兑换报价。</p><p id="fcea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在将数据帧合并成一帧并删除所有不需要的列之后。我已经将数据分为训练和测试特征和标签。我手动这样做是为了确保标注的比例与原始数据框的比例相同。</p><p id="585c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个分类器表现不错；其准确率为84.23%。然而，只有少数特征变得重要，其余的对模型的结果几乎没有影响。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/f6d16a467233d05b5904309a8e557ba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*DzK2oSIHjcye4ruHY5DRCQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">初始XGBClassifier的特征重要性</p></figure><p id="12ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所示，一些顶级特性是工程变量。由此可见，深入理解数据是多么重要。我没有进一步探索模型的性能，因为数字功能将大幅减少，模型的参数肯定会变得更好。</p><p id="9861" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对模型的偏差结果有一个奇怪的观察。混淆矩阵显示，该模型能够100%正确地对<em class="lv">“收到的报价”</em>进行分类。然而，它只在44%的情况下正确地分类了<em class="lv">“交易”</em>。</p><p id="88b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在将我们的模型传入<em class="lv"> "SelectFromModel" </em>函数，并迭代各种阈值后，我得到了以下模型，性能达到84.73%的准确率。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="bf88" class="mz lx it mv b gy na nb l nc nd">SelectFromModel(estimator=XGBClassifier(base_score=0.5,<br/>                                       booster='gbtree',<br/>                                       colsample_bylevel=1,<br/>                                       colsample_bynode=1,<br/>                                       colsample_bytree=1, gamma=0,<br/>                                       learning_rate=0.01, <br/>                                       max_delta_step=0,<br/>                                       max_depth=3,  <br/>                                       min_child_weight=1,<br/>                                       missing=None,<br/>                                       n_estimators=100,<br/>                                       n_jobs=1, nthread=None,<br/>                                       objective='multi:softprob',<br/>                                       random_state=1, reg_alpha=0,<br/>                                       reg_lambda=1,<br/>                                       scale_pos_weight=1,<br/>                                       seed=None, silent=None, <br/>                                       subsample=1,<br/>                                       verbosity=1),<br/>                max_features=None, norm_order=1, prefit=True,<br/>                threshold=0.0058939322)</span></pre><h1 id="ac09" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">微调和结果解释</h1><p id="2f52" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">由于人口统计不适合作为特征，我保留了之前删除的记录，然后再次运行改进的模型。这导致模型的准确性略微提高了1.28%(现在为86.01%)。</p><p id="8e38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更好的是，该模型对<em class="lv">“transaction”</em>的偏见大幅减少，59%的时间正确标记了类别。<em class="lv">【报价已完成】</em>和<em class="lv">【报价已查看】</em>偏差略有增加。然而，这个模型现在看起来好多了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/8cd674b519dcdf1c716a8af7f13006bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*iKmFSZ3d5jF9xuf9T0f0kg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">微调后的混淆矩阵</p></figure><p id="cc00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们应该尽可能地解释结果。这将有助于决策者更好地理解数据、模型和输出，从而做出明智的决策。</p><p id="68cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我为此使用了<em class="lv">“SHAP”</em>库(SHapley Additive exPlanations的简称)。这个库将ML模型从黑盒变成了人类可读的图形。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/7bd4aec893563079893095696e6038ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*demBxlFgfZ25bKeSZNFMpg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">特征对标签分类的影响</p></figure><p id="b09f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该图显示了我们选择的每个特征对每个标签的分类的影响。请注意，并非所有功能都对每个标签有影响。</p><p id="e31b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将分别探讨对每个标签的影响，以更好地理解每个特征的值如何影响分类器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/a9c85ec3547e3992c912c3444c257d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*00hpf3P_pWSGDFBcO9L8NA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">特征对交易的影响</p></figure><p id="0bba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们看到了每个标签上的每个功能的影响。我们可以用人类能够理解的方式向决策者解释我们的发现和模型。类似于<em class="lv">“随着报价难度的增加，客户更有可能进行常规交易。”</em>或<em class="lv">更老的</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/000ce427b1c48c0b73f925cab7b00904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*Z-gee9FWsMfIHzGhfK-C0Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">功能对已查看产品的影响</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/7005ff1cc14b37bdcbe8f14007b47813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*MiSSIqAyjUkKI7_keltuwg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">功能对报价的影响已完成</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/1ba5d1b1ace7116fec8fd449190ff92b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*_OzBRLpr0a_RHOn5bD8IvA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">功能对收到的报价的影响</p></figure><p id="f028" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">客户更有可能兑现优惠。然而，这并不意味着年轻客户更喜欢不兑现优惠。</em>听起来比<em class="lv">好多了“年龄对要约兑现有负面影响。”</em>。</p><p id="7b45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，某些特征对某些标签来说比其他标签更重要。如果每个标签上的每个特征的效果被适当地解释，而不是特征的一般意义，这将使行动的计划变得容易得多。</p><p id="a26c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们可以看到，并非所有类别的功能都很重要。在对通信渠道进行处理后，我们可以看到只有<em class="lv">【移动】</em>类别的<em class="lv">【渠道】</em>特征对分类有一定的影响。</p><h1 id="2136" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="be53" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">这是数据分析的一个经典案例，其中包括探索、预处理、建模和微调。这可以通过创建一个端到端的管道来自动化整个过程，或者至少是大部分过程来进一步改进。</p></div></div>    
</body>
</html>