<html>
<head>
<title>How to deploy Apache Airflow with Celery on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 AWS 上部署带芹菜的阿帕奇气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-apache-airflow-with-celery-on-aws-ce2518dbf631?source=collection_archive---------1-----------------------#2020-02-19">https://towardsdatascience.com/how-to-deploy-apache-airflow-with-celery-on-aws-ce2518dbf631?source=collection_archive---------1-----------------------#2020-02-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="25b2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">完全指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://pixabay.com/es/photos/parque-e%C3%B3lico-energ%C3%ADa-verde-1209335/"><div class="gh gi ki"><img src="../Images/422ad4dedcdec089fe57bfe3b1caacf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ilXpu2H4XSN-tpQLtdVsrw.jpeg"/></div></a><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片由<a class="ae ku" href="https://pixabay.com/photos/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1209335" rel="noopener ugc nofollow" target="_blank">在<a class="ae ku" href="https://pixabay.com/es/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1209335" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>上的免费照片</a>提供</p></figure><p id="d963" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><em class="lr">免责声明:本帖假设基本了解</em> <strong class="kx iu"> <em class="lr">气流</em> </strong> <em class="lr">、</em> <strong class="kx iu"> <em class="lr"> AWS ECS、</em> </strong> <em class="lr">(安全组等)和</em><strong class="kx iu"><em class="lr">Docker</em></strong><em class="lr">。我建议一种架构，在您的特定情况下，</em> <strong class="kx iu"> <em class="lr">可能不完美，也可能不是最好的</em> </strong> <em class="lr">。在这种情况下，从这个讲座中得到你想要的。</em></p><h1 id="b484" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">一点背景</h1><p id="4e34" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">在我工作的地方，我们广泛使用<em class="lr">阿帕奇气流</em>。我们大约有 15 个 Dag，看起来可能不多，但其中一些有许多步骤(任务),包括下载大型 SQL 备份、使用 Python 转换一些值并将其重新上传到我们的仓库。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/c5f5f7b4c7fb3ffd7277d8cd4fe3da71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMTSy_HvrnOOS0H9iKhXTA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">我们的气流仪表板截图</p></figure><p id="615b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">起初，我们开始使用顺序执行器(没有并行性，一次只运行一个任务),因为设置简单，而且没有很多 Dag。随着时间的推移，dag 不断增加，其中一些提供了利用并行性的机会，因此对于一些配置，我们开始使用本地执行器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mu"><img src="../Images/92e1755a201f8e32c1b9d4cdad663072.png" data-original-src="https://miro.medium.com/v2/format:webp/0*SJncsbqzgQsKzqyD.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">利用并行设置的 DAG 示例</p></figure><p id="86c0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">你可能会问……为什么整件事不再有用了？</p><p id="1bc4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这两种情况都只在 AWS ECS 中部署了一个容器来做所有的事情:服务于 web UI、调度作业和执行它们的工作进程。这不是<em class="lr">可扩展的</em>，我们唯一的选择是垂直扩展(你知道，添加更多 vCPU、更多 RAM 等等)。没有其他选择。</p><p id="7423" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">此外，如果容器中的某个东西失败了，<strong class="kx iu">整个东西都失败了(没有高可用性)</strong>。同样<strong class="kx iu">，整个服务必须是公共的</strong>，以便通过互联网访问网络服务器。如果你想使某些组件私有(如调度器和工人)<strong class="kx iu">这在这里是不可能的。</strong></p><h1 id="4004" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">为什么要创建这个指南？</h1><p id="c6cb" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">没有任何指南谈论如何在 AWS 中部署气流，或者利用他们广泛提供的服务。使用<code class="fe mv mw mx my b">docker-compose</code>在本地或 EC2 中部署整个系统很容易，但是这真的是您想要的吗？<strong class="kx iu">在同一个 VPC 中，完全隔离的节点如何相互通信？把需要保密的事情保密，把需要公开的事情公开？</strong></p><h1 id="61a7" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">建筑</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mz"><img src="../Images/5ae9ef71d82a2e3d1c76c71ea4607869.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ccZ779-E_Qntab5Dg3oRIQ.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">用<a class="ae ku" href="http://lucidchart.com/" rel="noopener ugc nofollow" target="_blank"> Lucichart </a>制作的建筑图</p></figure><p id="a76c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">乍一看，这整个图表可能很复杂，甚至可能会让<em class="lr">感到害怕</em>，但是不要担心。由此你要了解的大概只是以下几点:</p><ul class=""><li id="da4a" class="na nb it kx b ky kz lb lc le nc li nd lm ne lq nf ng nh ni bi translated">一个人只能通过入口<strong class="kx iu">连接到 Airflow 的 web 服务器或 Flower(我们稍后会谈到 Flower)。<strong class="kx iu">没有从外部</strong>到调度器、工作器、Redis 甚至元数据数据库的访问点。<strong class="kx iu">你不会想从外面连接那里</strong>。</strong></li><li id="6c9f" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">一切都在同一个 VPC 内，让事情变得更简单。每个对象都有自己的<a class="ae ku" href="https://cloudacademy.com/blog/aws-security-groups-instance-level-security/" rel="noopener ugc nofollow" target="_blank">安全组</a>，只允许来自正确服务的连接。</li><li id="0faf" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">一切都是 AWS Fargate 的任务，同样，我们稍后将讨论 Fargate。</li></ul><h1 id="2d69" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">我们将使用什么服务？为什么？</h1><p id="3b8d" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">主要来说，<strong class="kx iu"> AWS ECS 和 Fargate </strong>是其中的明星。</p><blockquote class="no np nq"><p id="bf53" class="kv kw lr kx b ky kz ju la lb lc jx ld nr lf lg lh ns lj lk ll nt ln lo lp lq im bi translated">Amazon Elastic Container Service(Amazon ECS)是一个完全托管的容器编排服务[…]您可以选择使用<a class="ae ku" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> AWS Fargate </a>来运行您的 ECS 集群，这是一个针对容器的无服务器计算。Fargate 消除了供应和管理服务器的需要，允许您为每个应用程序指定和支付资源，并通过设计应用程序隔离来提高安全性。</p></blockquote><p id="dd33" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">关于无服务器计算的一个很好的类比是我在这篇<a class="ae ku" href="https://www.zdnet.com/article/stop-saying-the-cloud-is-just-someone-elses-computer-because-its-not/" rel="noopener ugc nofollow" target="_blank">酷帖</a>中读到的:</p><blockquote class="nu"><p id="f407" class="nv nw it bd nx ny nz oa ob oc od lq dk translated">无服务器计算就像无人驾驶汽车；还有一个司机，只是你看不到。你不需要问司机是饿了、累了、喝醉了还是需要停下来上厕所。如果我们让无人驾驶汽车在我们的道路上行驶，那将是因为我们不必关心司机，只是他们会带我们去我们想去的地方这个事实——<a class="ae ku" href="https://www.zdnet.com/meet-the-team/uk/mary-branscombe/" rel="noopener ugc nofollow" target="_blank">玛丽·布兰斯科姆</a></p></blockquote><p id="80f9" class="pw-post-body-paragraph kv kw it kx b ky oe ju la lb of jx ld le og lg lh li oh lk ll lm oi lo lp lq im bi translated">我喜欢说 ECS 只是一个<em class="lr"> chill </em> Kubernetes，不需要太多的配置，它可以使用 Docker 映像和一些额外的设置来部署您的应用程序，例如您希望您的应用程序能够使用多少 CPU 或 RAM，如果您希望<a class="ae ku" href="https://aws.amazon.com/es/autoscaling/" rel="noopener ugc nofollow" target="_blank">自动扩展</a>，使用开箱即用的负载平衡器等等。</p><p id="247a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们还应该建立一个元数据数据库，为此我们将使用方便的 RDS。</p><h1 id="30c1" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">指南</h1><p id="0de0" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">在做任何事情之前，我们必须设置我们将使用哪个 Docker 图像，并将其设置为基础图像以在其上构建。为此，我使用了<a class="ae ku" href="https://hub.docker.com/r/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank">普克尔的气流</a>。这张 docker 图片为你提供了在 3 个主要执行器中设置气流所需的一切。下载量超过 500 万，可以肯定地说这家伙做得很棒。</p><h2 id="ecea" class="oj lt it bd lu ok ol dn ly om on dp mc le oo op me li oq or mg lm os ot mi ou bi translated">Dockerfile 文件</h2><p id="4324" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">让我们创建我们的自定义 docker 文件。我使用了以下方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="a3cf" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我添加了一个个人的<code class="fe mv mw mx my b">airflow.cfg</code>(包含 s3 日志和 SMTP 服务器凭证的配置)、一个自定义的<code class="fe mv mw mx my b">entrypoint.sh</code>和一个包含我所有 Dag 的<code class="fe mv mw mx my b">dags</code>文件夹。在这种情况下，已经使用指令<code class="fe mv mw mx my b">WORKDIR</code>在基础图像中将<code class="fe mv mw mx my b">.</code>定义为<code class="fe mv mw mx my b">/usr/local/airflow</code>。</p><p id="ff3d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我的切入点如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="3220" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我去掉了基本图像的入口点中的一些行，这些行是为不同的执行者服务的条件，并且只为芹菜做了这些行，还去掉了一个烦人的不工作的<code class="fe mv mw mx my b">wait_for_port</code>函数。</p><p id="baee" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这整个事情首先做的是，设置有用的环境变量，然后，根据<code class="fe mv mw mx my b">docker run</code>中给出的命令，跟随一个执行代码不同部分的开关。比方说，如果您正在启动一个<code class="fe mv mw mx my b">worker</code>，它将安装您的 Python 需求，然后执行 worker 进程。如果是<code class="fe mv mw mx my b">webserver</code>，它也会安装需求，但也会用<code class="fe mv mw mx my b">airflow initdb</code>命令初始化数据库，然后打开 air flow UI 的 web 服务器。</p><h2 id="933e" class="oj lt it bd lu ok ol dn ly om on dp mc le oo op me li oq or mg lm os ot mi ou bi translated">本地测试</h2><p id="0c59" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">如果你想测试整个事情，并确保一切正常，你可以用<a class="ae ku" href="https://github.com/puckel/docker-airflow/blob/master/docker-compose-CeleryExecutor.yml" rel="noopener ugc nofollow" target="_blank"> Puckel 的 docker-compose 芹菜 YAML 文件</a>来做。</p><p id="f8db" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">过一会儿，你应该能够访问<code class="fe mv mw mx my b">localhost:8080</code>并看到气流的仪表板。你还不如访问<code class="fe mv mw mx my b">localhost:5555</code>和看花。从这一点出发，运行一些示例 DAGs 甚至是您的示例——并亲自看看 web 服务器中的触发器是如何处理事情的，调度程序抓取任务并将其发送到队列，最后，工作人员拾取并运行它。</p><h1 id="4caf" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">上传 docker 图像</h1><p id="a3f0" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">对于本教程，我们将保持简单，使用 AWS ECR。ECR 只是一个 Docker 图像库。</p><p id="e656" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">ECR 与 ECS 集成，开箱即用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ox"><img src="../Images/8fabc069ed3415df78faf761bc475a5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r8S9Hsdr-OinLlUr.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来源:<a class="ae ku" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> AWS ECR </a></p></figure><p id="42da" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">要创建存储库，请进入 ECR 控制台，点击<em class="lr">创建存储库</em>，选择您认为合适的名称。提示:您可以有一个用于暂存气流的存储库，一个用于生产。请记住，所有的气流过程都将使用相同的图像，以避免冗余和干燥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oy"><img src="../Images/5993163e4d041d6cc7ed6b9eda4ca3c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XKzjlYtan-wxvCP3FJMWoA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">我的 AWS ECR 截图</p></figure><p id="b692" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在进入新的存储库，点击<em class="lr">查看推送命令</em>。这将引导您将气流图像推向回购。如果在第一步中出现错误，比如<code class="fe mv mw mx my b">unable to locate credentials</code>您可能还没有设置您的<code class="fe mv mw mx my b">awscli</code>凭证，请查看<a class="ae ku" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><p id="e46a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">一旦您推送图像并在 ECR 控制台中看到它，您就为下一步做好了准备！</p><h1 id="452a" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">在 ECS 上部署服务</h1><p id="ee56" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">让我们从创建 ECS 群集开始，转到“Services ”,然后选择“ECS”。</p><p id="dab3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">可能因为这是你第一次，你会看到一个向你展示服务的屏幕和一个简单的第一个集群按钮。这里您需要做的只是创建一个<em class="lr">纯网络</em>集群。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oz"><img src="../Images/9f5b9f8edd8af55c3997cee9f4358d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzVn9BjNaSgESGmrBk4FMg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">AWS ECS 中集群创建的屏幕截图</p></figure><p id="4fc0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">此时，您可能会看到一个类似这样的窗口。这是您自己的选择，是使用与其余实例相同的 VPC，还是专门为该集群创建另一个——我选择了后者。如果您选择这样做，我认为一个子网就足够了。</p><h2 id="e78e" class="oj lt it bd lu ok ol dn ly om on dp mc le oo op me li oq or mg lm os ot mi ou bi translated">设置数据库(如果您还没有)</h2><p id="c4e5" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">我们将建立一个 PostgreSQL 9.6 微实例数据库。如果您熟悉如何做到这一点，请随意操作并跳到下一步。</p><p id="545d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">转到服务-&gt; RDS。转到<em class="lr">数据库</em>部分和<em class="lr">创建数据库</em>。选择 PostgreSQL 徽标，转到版本 9.6.X，任何次要版本都可以。现在，我仍然在考虑是否<em class="lr">我非常便宜</em>或者气流元数据数据库真的不需要<em class="lr">那么</em>健壮，所以我选择了一个<em class="lr">自由层微</em>实例。如果你发现这对你来说还不够，以后很容易升级，所以不要担心。</p><p id="b474" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来的配置由您决定，无论实例名称、用户名、密码是什么，<strong class="kx iu">只要确保它将创建在 ECS 使用的同一个群集中。</strong></p><h2 id="3673" class="oj lt it bd lu ok ol dn ly om on dp mc le oo op me li oq or mg lm os ot mi ou bi translated">创建任务定义</h2><p id="6234" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">太好了，我们现在有空的星团了。让我们创建我们的<em class="lr">任务定义。</em></p><blockquote class="no np nq"><p id="63fa" class="kv kw lr kx b ky kz ju la lb lc jx ld nr lf lg lh ns lj lk ll nt ln lo lp lq im bi translated">任务定义就像蓝图一样，它们定义了您的服务将如何执行——它将使用哪个容器，分配给它多少 CPU 和 RAM，映射哪些端口，它有哪些环境变量，等等。</p></blockquote><p id="560d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">转到左侧面板的任务定义，点击<em class="lr">创建新的任务定义</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pa"><img src="../Images/7f6d2db89476a5778574bd9d0fe695a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C3g7rrxEuaMMpfBtF3QXkg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">AWS ECS 截图</p></figure><p id="3175" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">记住，我们想要 Fargate，所以选择它并点击<em class="lr">下一步</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pb"><img src="../Images/b74065521fbe0f633054369206da430e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ELXgi-CGWCUoXCBen-OwEA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">AWS ECS 截图</p></figure><p id="8ad0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">从现在开始，我们必须为 web 服务器、调度器和工作器创建一个任务定义。</p><p id="83ec" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我将向您介绍您必须为每项任务正确工作提供的所有必要配置。</p><p id="07c6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">任务定义名称:</strong>标识名称。选择一些描述性的东西，如 airflow-webserver、airflow-worker 等。<br/> <strong class="kx iu">任务角色:</strong>任务将要注入到容器中的 IAM 角色。选择一个对你的任务必须做的事情有权限的人——从秘密管理器提取秘密，用<code class="fe mv mw mx my b">awslogs</code>日志驱动程序记录日志，从 S3 查询存储桶。如果你不确定，就使用基本的<code class="fe mv mw mx my b">ecsTaskExecutionRole</code>，如果下拉列表中没有，请在此处检查<a class="ae ku" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" rel="noopener ugc nofollow" target="_blank"/>。<br/> <strong class="kx iu">网络模式:</strong> <code class="fe mv mw mx my b">awsvpc</code>既然我们用的是 Fargate。<br/> <strong class="kx iu">任务执行角色:</strong>能够从 AWS ECR 提取图像并登录 Cloudwatch 的角色。<code class="fe mv mw mx my b">ecsTaskExecutionRole</code>这两种政策都有。<br/> <strong class="kx iu">任务大小:</strong>几乎完全取决于你。你的大部分资源将花在工人身上，因此他们会做所有的脏活。只是提供一个指南，这些是我的配置:</p><pre class="kj kk kl km gt pc my pd pe aw pf bi"><span id="1270" class="oj lt it my b gy pg ph l pi pj">Webserver: 1GB, 0.5vCPU<br/>Scheduler: 2GB, 0.5vCPU<br/>Flower: 512MB, 0,25vCPU<br/>Worker: 3GB, 1vCPU<br/>Redis: 2GB, 1vCPU</span></pre><p id="0154" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在点击<strong class="kx iu">添加容器</strong>。右侧面板将会弹出。<br/> <strong class="kx iu">集装箱名称:</strong>集装箱的标识名。<br/> <strong class="kx iu">图像:</strong>ECR 存储库的 URL。例:<em class="lr">1234567890 . dkr . ECR . us-east-1 . Amazon AWS . com/air flow-celery:最新。</em>对于 Redis，使用:<em class="lr">docker.io/redis:5.0.5<br/>T21<strong class="kx iu">端口映射:</strong>对于 webserver 写 8080。对于花，5555。对于工人，8793-访问日志。对于 Redis，6379。</em></p><p id="89c1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在<strong class="kx iu">环境</strong>部分，在<em class="lr">命令</em>中，根据您正在创建的任务选择<code class="fe mv mw mx my b">webserver</code>、<code class="fe mv mw mx my b">flower</code>、<code class="fe mv mw mx my b">worker</code>或<code class="fe mv mw mx my b">scheduler</code>。</p><p id="1eba" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">你也可以利用环境变量！您可以使用<code class="fe mv mw mx my b">value</code>来硬编码 env，或者使用<code class="fe mv mw mx my b">valueFrom</code>来使用<em class="lr">秘密管理器</em>或<em class="lr"> AWS 参数存储库</em>。<strong class="kx iu">但是请不要在没有安全措施的情况下注入秘密。<em class="lr"> </em> </strong>更多信息<a class="ae ku" href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/specifying-sensitive-data.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="78f3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">对于除 flower 之外的所有服务，您必须设置<code class="fe mv mw mx my b">POSTGRES_</code>变量，记得我们在<code class="fe mv mw mx my b">entrypoint.sh</code>中提到的那些变量吗？如果没有这些，服务在尝试连接到一个不存在的数据库时将会悲惨地失败。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pk"><img src="../Images/68078070a28ec8ac218e6b3165deaa61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3BcGt6-DknXymoDPpNCiQ.png"/></div></div></figure><p id="2d9c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">对于<strong class="kx iu">调度器</strong>和<strong class="kx iu">工作器</strong>的任务定义，需要设置<code class="fe mv mw mx my b">REDIS_HOST</code>。您可以像我在这里一样设置 IP 或内部 DNS。我们没有设置用户和密码认证，我不认为这是必要的，因为服务本身是私人的。尽管如此，请随意。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pl"><img src="../Images/86e2bb86ea3f8250388744477bdd0421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uE0i58a1gudW3ZYAeaWzoQ.png"/></div></div></figure><p id="7c43" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们正式完成了任务定义！坚持住，从现在开始事情会变得更容易。<em class="lr">。</em></p><h2 id="e66b" class="oj lt it bd lu ok ol dn ly om on dp mc le oo op me li oq or mg lm os ot mi ou bi translated">启动服务</h2><p id="6ca6" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">转到您的 ECS 集群，在<em class="lr">服务</em>选项卡中单击<em class="lr">创建</em>。</p><ol class=""><li id="1170" class="na nb it kx b ky kz lb lc le nc li nd lm ne lq pm ng nh ni bi translated">选择相应的任务定义。</li><li id="d80c" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">写服务的名字:<em class="lr"> webserver，scheduler，workers 等。</em></li><li id="b3c5" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">对于 webserver、Redis、flower 和 scheduler，我们应该总是有一个任务。对于工人，我们想要多少就有多少，<strong class="kx iu">还记得横向缩放吗？</strong></li><li id="55b3" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">点击下一步。选取您的群集的 VPC 以及您想要使用的任何子网。</li><li id="544b" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">对于安全组，只需确保将名称更改为更容易识别的名称。比如:<em class="lr">气流-web server-安全-群组。我们稍后会弄乱这些。</em></li><li id="169c" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">公有 IP:还记得第一张架构图吗？嗯，除非你不想使用负载平衡器/入口，否则所有服务都应该是私有的。</li><li id="9775" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">对于 webserver 和 flower，我们可以添加一个<em class="lr">应用负载均衡器</em>，作为<em class="lr">弹性</em> <em class="lr"> IPs </em>的替代。为什么不能用 EIPs？<a class="ae ku" href="https://forums.aws.amazon.com/thread.jspa?messageID=931880" rel="noopener ugc nofollow" target="_blank">目前不可能</a>。要在 AWS 中设置 LB，参考此处的<a class="ae ku" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="5437" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">确认并点击创建！</li><li id="434b" class="na nb it kx b ky nj lb nk le nl li nm lm nn lq pm ng nh ni bi translated">每隔一个服务重复一次。</li></ol><p id="a5d6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">过一会儿，所有的服务都应该是这样的。不要担心，如果一些服务不工作。我们将在下一节整理出它们之间的联系。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pn"><img src="../Images/99ab2c4bcd236c8780a4cec3a88065c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EGjGpJCuda2s6Nie-IemZA.png"/></div></div></figure><h1 id="a933" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">连接—安全组</h1><p id="99da" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">我们现在应该做的是确保每个服务从相应的来源接收信息。我们要设置他们的安全组。</p><blockquote class="no np nq"><p id="fc84" class="kv kw lr kx b ky kz ju la lb lc jx ld nr lf lg lh ns lj lk ll nt ln lo lp lq im bi translated">一个<em class="it">安全组</em>充当您的实例的虚拟防火墙，控制入站和出站流量。在 VPC 中启动实例时，最多可以为该实例分配五个安全组。安全组在实例级起作用，而不是在子网级。因此，可以将 VPC 子网中的每个实例分配给不同的安全组。–<a class="ae ku" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" rel="noopener ugc nofollow" target="_blank">AWS 文档</a></p></blockquote><p id="1784" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">以下是气流芹菜架构的官方文档:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi po"><img src="../Images/0ef89479ce2f9a95491db56295f9489d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/0*2ZoeMLxE7myOzWAl.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><a class="ae ku" href="https://airflow.apache.org/docs/stable/executor/celery.html?highlight=celery" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="19fe" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我将借用 Airflow 文档中的一些语句:</p><pre class="kj kk kl km gt pc my pd pe aw pf bi"><span id="7dbf" class="oj lt it my b gy pg ph l pi pj">Airflow consist of several components:<br/><strong class="my iu">Workers</strong> - Execute the assigned tasks<br/><strong class="my iu">Scheduler</strong> - Responsible for adding the necessary tasks to the queue<br/><strong class="my iu">Web server</strong> - HTTP Server provides access to DAG/task status information<br/><strong class="my iu">Database</strong> - Contains information about the status of tasks, DAGs, Variables, connections, etc.<br/><strong class="my iu">Celery</strong> - Queue mechanism</span><span id="c3cd" class="oj lt it my b gy pp ph l pi pj">The components communicate with each other in many places<br/><strong class="my iu">[1] Web server –&gt; Workers</strong> - Fetches task execution logs<br/><strong class="my iu">[2] Web server –&gt; DAG files</strong> - Reveal the DAG structure<br/><strong class="my iu">[3] Web server –&gt; Database</strong> - Fetch the status of the tasks<br/><strong class="my iu">[4] Workers –&gt; DAG files</strong> - Reveal the DAG structure and execute the tasks<br/><strong class="my iu">[5] Workers –&gt; Database</strong> - Gets and stores information about connection configuration, variables and XCOM.<br/><strong class="my iu">[6] Workers –&gt; Celery’s result backend</strong> - Saves the status of tasks<br/><strong class="my iu">[7] Workers –&gt; Celery’s broker</strong> - Stores commands for execution<br/><strong class="my iu">[8] Scheduler –&gt; Database</strong> - Store a DAG run and related tasks<br/><strong class="my iu">[9] Scheduler –&gt; DAG files</strong> - Reveal the DAG structure and execute the tasks<br/><strong class="my iu">[10] Scheduler –&gt; Celery’s result backend</strong> - Gets information about the status of completed tasks<br/><strong class="my iu">[11] Scheduler –&gt; Celery’s broker</strong> - Put the commands to be executed</span></pre><p id="7466" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">上述内容应在安全组中得到反映。</strong></p><p id="17fc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">进入 AWS 中的 VPC 服务，选择<em class="lr">安全组</em>。在设置所有服务时，我要求您用一个合适的名称来标识它们，这样您可以方便地过滤它们并提供配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pq"><img src="../Images/18aacec6f3468e44146d86ff7005b225.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBlFMsbkEc0YSTiQmNxYAw.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">我的气流安全组的屏幕截图</p></figure><p id="9fb5" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">从这里，选择每个组并设置正确的<strong class="kx iu">入站规则。</strong>以雷迪斯为例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pr"><img src="../Images/fa81427ab225c9043cbf278a059d204d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sa3V0aWNaUeEpQJK5DX3fA.png"/></div></div></figure><p id="f7df" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Redis 服务器运行在端口 6379 上(我们在任务定义中启用的端口)。架构图向我们展示了工作人员和调度人员应该可以访问它。我们还包括 flower 来检查经纪人状态。<strong class="kx iu">因此，我们为那些实例的每个源安全组包含了行</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi po"><img src="../Images/0ef89479ce2f9a95491db56295f9489d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/0*2ZoeMLxE7myOzWAl.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><a class="ae ku" href="https://airflow.apache.org/docs/stable/executor/celery.html?highlight=celery" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="d570" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">请记住，按照图表并相应地设置所有服务的安全组。这确保了应该被允许的服务之间的每个连接。如您所见，数据库应该接受来自每个气流过程的连接。</p><h1 id="5d5e" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">测试整个事情</h1><p id="0c1c" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">测试很容易，只需访问 web 服务器和 flower。启动一个示例 DAG，看看在执行任务时，<em class="lr">活动</em>计数器如何快速增加和减少。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ps"><img src="../Images/f6d769c6330772b6e882d541078f6889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Z9ltaFoANyrFBSYMikJpw.png"/></div></div></figure><p id="4c8f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">不要担心，如果有什么不工作，去检查失败的容器任务的日志并做一些研究，解决方案应该很快出现。</p><p id="9813" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果你仍然失败，很可能是你忘记做什么了(<em class="lr">或者是我忘记告诉你了，哈哈</em>)。欢迎评论，我会尽力帮助你！</p><p id="2dff" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果一切顺利…</p><h1 id="f8b1" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">恭喜你！你成功了！</h1><p id="c006" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">就是这个！你的气流集群准备好了！我知道我知道…这很长，甚至有点混乱，但是嘿！你成功做到了！👏👏😄。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi pt"><img src="../Images/17abd7c416be03ffe39ee44495a2cf54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CandGvUwLcQs9lc_"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">照片由<a class="ae ku" href="https://unsplash.com/@ayahya09?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿里·叶海亚</a>在<a class="ae ku" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="97e6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这对我来说是一次漫长的旅行，我在建立自己的集群时经历了许多问题、错误和异常。我真的希望我的这份指南能让你少一些头疼。</p><p id="6e5f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在那之前，谢谢你，再见！👋👋👋</p></div></div>    
</body>
</html>