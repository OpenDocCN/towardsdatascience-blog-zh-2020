<html>
<head>
<title>Bulk Downloads in Python FAST ⚡️</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python快速⚡️中的批量下载</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bulk-downloads-in-python-fast-%EF%B8%8F-df070451786?source=collection_archive---------37-----------------------#2020-06-15">https://towardsdatascience.com/bulk-downloads-in-python-fast-%EF%B8%8F-df070451786?source=collection_archive---------37-----------------------#2020-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3491" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用AWS Lambda和亚马逊SQS批量下载外部文件</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d5d1f3490bc1ec508c864f883faaae48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ji1uveYBmtaLpKrl"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加布里埃尔·托瓦尔在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="110d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">这篇文章概述了我如何使用AWS Lambda和亚马逊SQS以比我本地机器快350倍的速度将194，204个文件(即CSV格式)下载到亚马逊S3！</strong></p><h1 id="c709" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题是</h1><p id="b24a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">最近，我构建了一个web应用程序来下载加拿大的历史天气数据。作为应用程序结构的一部分，我需要从第三方服务器下载8，324个独立气象站的数据，并将数据存储在数据库中(亚马逊S3)。</p><div class="mp mq gp gr mr ms"><a rel="noopener follow" target="_blank" href="/building-a-dynamic-weather-download-app-1ce64a6c3e61"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd ir gy z fp mx fr fs my fu fw ip bi translated">构建动态天气下载应用程序</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">使用Python、Dash和AWS简化加拿大历史天气数据</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">towardsdatascience.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng kp ms"/></div></div></a></div><p id="2c0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看起来很简单，对吧？只需创建一些代码，执行，瞧，你有数据。<strong class="ky ir">错了</strong>。</p><p id="a420" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个气象站都有多年的天气数据，第三方服务器将下载限制在1年的增量。简而言之，下载所有8324个站点的数据集意味着下载194204个单独的文件(即一个站点每年的数据一个文件)，合并匹配站点的数据，并将数据推送到亚马逊S3。</p><p id="6ca2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下载数据的问题不是文件大小，整个数据集只有4.4 GB，而是下载速度和网络延迟。在我的本地机器上，下载一年的数据并将其推送到亚马逊S3大约需要1.7秒。这意味着使用我的本地机器下载所有194，204个文件并推送到亚马逊S3将花费<strong class="ky ir"> 3.9天</strong>，假设没有网络中断或下载失败。😲</p><p id="5389" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以做得更好！</p><h1 id="69a1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决方案</h1><p id="3f70" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">很明显，在本地机器上下载数据是不切实际的，也是不可靠的，尤其是在云计算如此容易实现的情况下。最终，我决定使用AWS Lambda来执行我的Python代码，使用亚马逊SQS消息队列来触发Lambda事件和传达下载任务。</p><h2 id="4fe3" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">概观</h2><p id="d6cb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这篇文章并不打算深入概述AWS Lambda和SQS，因为已经有了<a class="ae kv" href="https://aws.amazon.com/serverless/use-sqs-as-an-event-source-for-lambda-tutorial/" rel="noopener ugc nofollow" target="_blank">很好的资源</a>，但是我将提供Lambda和SQS的基本概述以及我使用的框架。</p><p id="fab1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Lambda是一种运行代码以响应事件的方式，无需提供或管理服务器。亚马逊SQS是一种在不同软件组件之间发送、存储和接收消息的方式(即两个AWS Lambda函数之间的消息)。</p><p id="1728" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的例子中，我使用一个Lambda函数为8，324个气象站中的每一个生成包含气象站名称和ID等信息的消息。每条消息都被发送并存储在SQS消息队列中。同时，另一个Lambda函数被设计为响应SQS事件(即消息到达队列)而执行。这个Lambda函数从SQS队列中检索消息，使用消息信息下载数据，并将数据推送到亚马逊S3进行存储。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/87577d583c5f82240ab1e334fe51f81e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JTppIaY0yPGBqpkQSoBz5A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Lambda和亚马逊SQS框架概述</p></figure><h2 id="7952" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">为什么拉姆达和SQS很棒</h2><p id="e849" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">以下是Lambda和SQS令人惊叹的几个原因，以及它们如何加快执行时间。</p><ul class=""><li id="9756" class="nu nv iq ky b kz la lc ld lf nw lj nx ln ny lr nz oa ob oc bi translated">Lambda函数一次可以从SQS消息队列中检索多达10条消息。</li><li id="a4e1" class="nu nv iq ky b kz od lc oe lf of lj og ln oh lr nz oa ob oc bi translated">Lambda函数可以并发执行。例如，使用<em class="oi">“for loop”、</em>执行一个任务10X，其中每个循环需要1秒，而完成这个任务需要10秒。使用并发性，您可以“克隆”Lambda函数并同时执行10个相同的函数，只需1秒钟即可完成！</li><li id="c3ee" class="nu nv iq ky b kz od lc oe lf of lj og ln oh lr nz oa ob oc bi translated">Lambda函数可以分配特定数量的内存(即CPU)。这加快了执行时间。</li></ul><p id="0e89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:当增加AWS Lambda函数的并发性和内存时，你应该小心，因为这会很快导致成本增加。</strong></p><h2 id="9d75" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">为什么要做这一切</h2><p id="7411" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">你可能会问<em class="oi">“为什么要通过SQS将相同的信息从一个Lambda函数发送到另一个函数，而不是对所有事情都使用一个Lambda函数？”。</em></p><p id="dc36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">问得好。</p><p id="d87c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Lambda函数的最大执行时间限制为15分钟。如果我尝试执行30个任务，每个任务花费1分钟，我将超过最大执行时间。相反，我需要将30个任务分成块，执行时间少于15分钟。通过使用SQS，我可以触发Lambda并定义我希望Lambda从队列中卸载多少任务(最多10个),以确保总任务时间低于执行时间。</p><h1 id="db46" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">代码</h1><h2 id="ac45" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">第一步:</h2><p id="19f6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用AWS Lamda将消息发送到SQS消息队列。在我的例子中，我为每个气象站发送了一条消息，其中包含气象站ID和数据的开始和结束年份等信息。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Lambda函数将消息发送到SQS消息队列</p></figure><h2 id="4e1a" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">第二步:</h2><p id="335a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">创建一个AWS Lambda函数，当消息在SQS消息队列中可用时触发(即执行)。在我的例子中，Lambda函数卸载SQS消息，使用消息信息下载气象站数据，并将数据推送到亚马逊S3进行存储。</p><p id="35dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将Lambda函数配置为一次从SQS消息队列中读取10条消息。这使得总执行时间低于15分钟的限制。我还为Lambda函数配置了高达1000的并发性(即，如果需要，Lambda可以同时调用1000个执行)和256 MB的内存。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Lambda函数从SQS消息队列卸载消息，并下载和存储数据</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/fab4fc94f387fa203ecc775d6bc4aeb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mgJQytPUZlXOsMnIkJsf1w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在控制台中将SQS设置为AWS Lambda的触发器</p></figure><h1 id="5c6f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结果</h1><p id="4d4f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我的本地机器上，将8，324个气象站的数据下载并推送至亚马逊S3需要3.9天。</p><p id="cf2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用AWS Lambda和亚马逊SQS，我能够在大约16分钟内完成任务，比我的本地机器快350倍！！！💪</p><p id="47ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为SQS消息队列生成消息需要大约8分钟(步骤1)，Lambda同时下载数据并将其推送到亚马逊S3需要另外8分钟(步骤2)。</p><p id="6703" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有AWS免费层的总成本为0.00美元，没有免费层的总成本约为4.30美元。</p><ul class=""><li id="6e83" class="nu nv iq ky b kz la lc ld lf nw lj nx ln ny lr nz oa ob oc bi translated">我可以在本地机器上免费完成这项工作，但这意味着要确保3.9天的持续网络连接。</li><li id="3423" class="nu nv iq ky b kz od lc oe lf of lj og ln oh lr nz oa ob oc bi translated">我可以通过旋转一个EC-2实例并运行一个cronjob来完成它，但是使用AWS Lambda的便利性非常值得这4.30美元。</li></ul><p id="8cba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">总的来说，我很高兴找到了AWS Lambda和亚马逊SQS组合，并将再次使用它！</p></div></div>    
</body>
</html>