<html>
<head>
<title>Cython-A Speed-Up Tool for your Python Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">cy thon——Python 函数的加速工具</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/cython-a-speed-up-tool-for-your-python-function-9bab64364bfd?source=collection_archive---------8-----------------------#2020-02-01">https://towardsdatascience.com/cython-a-speed-up-tool-for-your-python-function-9bab64364bfd?source=collection_archive---------8-----------------------#2020-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fa9b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当调整你的算法得到小的改进时，你可能想用 Cython 获得额外的速度，cyt hon 是 Python 的 C 扩展。</h2></div><h1 id="ac33" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">动机</h1><p id="0714" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果你读了我的文章<a class="ae lw" rel="noopener" target="_blank" href="/how-to-build-a-matrix-module-from-scratch-a4f35ec28b56">如何用 Python </a>从头开始创建你自己的矩阵模块，你可能想用你自己的算法创建你自己的矩阵类。这是一个好主意，因为你可以灵活地创建你喜欢的模块。但是在创建多维数组函数之前，您可能想了解 Numpy 和 Python Matrix 类之间的区别。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/ea42813b307b297722020b1dfe48109d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/0*9s44Iac6o6QYjiMt.png"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">从空闲编码中检索</p></figure><h1 id="7ab0" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">你为一个矩阵创建一个函数。让我们测试一下</h1><p id="7a7c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们从一个例子开始，帮助你理解 Numpy 和你用 Python 创建的模块之间的区别。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="1e2a" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">我们期望使用 Numpy 的矩阵乘法将给出与第一个相同的结果。让我们看看它们是否在相同的矩阵维数上给出相同的结果。</p><p id="a1fe" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">创建多个不同维度的矩阵:</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="a631" class="mv kj it mr b gy mw mx l my mz">nump= []<br/>mult=[]<br/>for i in range(0,500,100):</span><span id="878e" class="mv kj it mr b gy na mx l my mz">  nump.append(calculate(npAB,(i,i)))</span><span id="c920" class="mv kj it mr b gy na mx l my mz">  mult.append(calculate(mulAB,(i,i)))</span></pre><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/36c9f77d21aab1370410e5958c42ba15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZrRdS1RoinMpVZaFI1H_HA.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">Python 实现和 Numpy 之间的性能。在这里找到实现<a class="ae lw" href="https://github.com/khuyentran1401/Cython/blob/master/MatrixEntries/main01.py" rel="noopener ugc nofollow" target="_blank">的</a></p></figure><p id="2f92" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">我们创建了维度为 100x100、200x200、…、500x500 的矩阵。我们可以看到，随着维度的增加，我们的 Python 函数的时间量<strong class="lc iu">呈指数增长</strong>，而 Numpy 可以在几秒钟内完成计算<strong class="lc iu"/>。如果 Numpy 也是一个 Python 库，它的性能怎么会比我们的 Python 实现好这么多呢？</p><h1 id="7523" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">numpy——不完全是 Python 库</h1><p id="420a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Numpy 集成了 C/C++和 Fortran 代码，在处理多维数组而不是使用纯 Python 时提供了高性能。</p><p id="9be0" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">如果你不知道 C 和 Python 的区别，C 是编译语言，Python 是解释语言。虽然变量是在 C 中声明的，但变量不是在 Python 中声明的。这使得 Python 更容易编写，但也带来了成本，Python 需要在每次执行代码时解释变量。因此，对于多维数组，Python 的运行速度比 C 慢得多。</p><p id="b58d" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">如果有一种语言能让你在实现 C 性能的同时使用 Python 语法，那会怎么样？Cython 可以帮助你做到这一点。</p><h1 id="270d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">Cython 简介</h1><p id="05be" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Cython 是一个针对 Python 和扩展的 cy thon(T21)的优化静态编译器。最棒的是，它使得编写 C 扩展<strong class="lc iu">的语法像 Python </strong>本身一样简单。Cython 结合了 Python 和 C 的优势，让您可以高效地与大型数据集进行交互。由于 Cython 将代码降到了机器级别，因此加快了 Python 代码的执行速度。你可以在这里找到 Cython 文档。</p><p id="6725" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">Cython 的编译扩展包含三个文件:</p><ul class=""><li id="7aa5" class="ng nh it lc b ld ml lg mm lj ni ln nj lr nk lv nl nm nn no bi translated">主文件</li><li id="50e4" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">要在<code class="fe nu nv nw mr b">.pyx</code>文件中编译的函数</li><li id="4929" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">一个<code class="fe nu nv nw mr b">setup.py</code>包含制作扩展模块的指令</li></ul><h2 id="63b9" class="mv kj it bd kk nx ny dn ko nz oa dp ks lj ob oc ku ln od oe kw lr of og ky oh bi translated">用 Cython 创建函数文件</h2><p id="9405" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">创建一个名为<code class="fe nu nv nw mr b">mult_fast.pyx</code>的文件。<code class="fe nu nv nw mr b">.pyx</code>扩展名用于 Cython 文件</p><p id="cd29" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">通过在可读的 Python synta <strong class="lc iu"> x </strong>中添加静态类型声明，我们可以很容易地将 Python 代码调成普通的 C 性能。这可以简单地通过<code class="fe nu nv nw mr b">cdef</code> <code class="fe nu nv nw mr b">type</code> <code class="fe nu nv nw mr b">name</code> <code class="fe nu nv nw mr b">=</code> <code class="fe nu nv nw mr b">value</code>来完成。另外，不要忘记在函数的参数中声明变量。</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="ebf1" class="mv kj it mr b gy mw mx l my mz">def mulAB( double[:,:] A , double[:,:] B):<br/> cdef int Am  = A.shape[0]<br/> cdef int An  = A.shape[1]<br/> cdef int Bm  = B.shape[0]<br/> cdef int Bn  = B.shape[1]</span><span id="a778" class="mv kj it mr b gy na mx l my mz"> cdef int i = 0<br/> cdef int j = 0<br/> cdef int k = 0</span><span id="5f90" class="mv kj it mr b gy na mx l my mz"> cdef double temp = 0.0</span><span id="fa05" class="mv kj it mr b gy na mx l my mz"> cdef double[:,:] C = np.empty((Am,Bn), dtype=np.double)</span></pre><p id="fd9c" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">在我们的代码中声明变量之后，我们开始下一行<code class="fe nu nv nw mr b">with nogil.</code>现在你只需要在这里复制并粘贴你之前创建的函数:</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="1e69" class="mv kj it mr b gy mw mx l my mz">with nogil:<br/>  for i in range(Am):<br/>   for j in range(Bn):<br/>    temp=0.0<br/>    for k in range(An):<br/>     temp += A[i,k] * B[k,j] <br/>    C[i,j] = temp<br/> <br/> return np.array(C)</span></pre><p id="fd15" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">将所有东西放在一起:</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="mj mk l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated"><code class="fe nu nv nw mr b">mult_fast.pyx</code>文件</p></figure><h2 id="d23e" class="mv kj it bd kk nx ny dn ko nz oa dp ks lj ob oc ku ln od oe kw lr of og ky oh bi translated">建立</h2><p id="8305" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">将该文件另存为<code class="fe nu nv nw mr b">setup.py</code>。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="mj mk l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated"><code class="fe nu nv nw mr b">setup.py</code></p></figure><p id="9ee1" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">您可以复制并粘贴这个<code class="fe nu nv nw mr b">setup.py</code>文件作为您未来的 Cython 文件。您唯一需要更改的是<code class="fe nu nv nw mr b">extensions</code>和<code class="fe nu nv nw mr b">setup</code> ( <code class="fe nu nv nw mr b">mult_fast</code> &amp; <code class="fe nu nv nw mr b">[“mult_fast.pyx”]</code>)中的文件名。</p><p id="3c78" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">在命令行上，键入:</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="6946" class="mv kj it mr b gy mw mx l my mz">python3 setup.py build_ext --inplace</span></pre><h2 id="27f6" class="mv kj it bd kk nx ny dn ko nz oa dp ks lj ob oc ku ln od oe kw lr of og ky oh bi translated">最后一次接触 Main.py 文件</h2><p id="5fb7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">导入<code class="fe nu nv nw mr b">mult_fast.py</code>并写入<code class="fe nu nv nw mr b">main02.py</code>文件</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h2 id="7c16" class="mv kj it bd kk nx ny dn ko nz oa dp ks lj ob oc ku ln od oe kw lr of og ky oh bi translated">准备好了吗？让我们发射</h2><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/e4f5e3efc861013bde71c4df18d9f71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-2gwo4RnF6bGgTBGFF6bA.png"/></div></div></figure><p id="01cf" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">我们可以看到 Cython 的性能几乎和 Numpy 一样好。您可能不会选择在小数据集中使用 Cython，但是在处理大数据集时，使用 Cython 来快速完成我们的计算是值得的</p><h1 id="3218" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="c617" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">通过在我们的 Python 代码中进行一点点修改来利用 Cython，我们已经使我们的函数运行得更快了。我希望这篇文章能给你一些想法，让你以更有效的方式创建自己的模块。在这个<a class="ae lw" href="https://github.com/khuyentran1401/Cython" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中，您可以随意使用本文的代码。</p><p id="456e" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">我喜欢写一些基本的数据科学概念，并尝试不同的算法和数据科学工具。你可以通过<a class="ae lw" href="https://www.linkedin.com/in/khuyen-tran-1401/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>和<a class="ae lw" href="https://twitter.com/KhuyenTran16" rel="noopener ugc nofollow" target="_blank"> Twitter </a>与我联系。</p><p id="2dfa" class="pw-post-body-paragraph la lb it lc b ld ml ju lf lg mm jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">如果你想查看我写的所有文章的代码，请点击这里。在 Medium 上关注我，了解我的最新数据科学文章，例如:</p><div class="oi oj gp gr ok ol"><a rel="noopener follow" target="_blank" href="/maximize-your-productivity-with-python-6110004b45f7"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd iu gy z fp oq fr fs or fu fw is bi translated">使用 Python 最大化您的生产力</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">你创建了一个待办事项清单来提高效率，但最终却把时间浪费在了不重要的任务上。如果你能创造…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">towardsdatascience.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz md ol"/></div></div></a></div><div class="oi oj gp gr ok ol"><a rel="noopener follow" target="_blank" href="/how-to-build-a-matrix-module-from-scratch-a4f35ec28b56"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd iu gy z fp oq fr fs or fu fw is bi translated">如何从头开始构建矩阵模块</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">如果您一直在为矩阵运算导入 Numpy，但不知道该模块是如何构建的，本文将展示…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">towardsdatascience.com</p></div></div><div class="ou l"><div class="pa l ow ox oy ou oz md ol"/></div></div></a></div><div class="oi oj gp gr ok ol"><a rel="noopener follow" target="_blank" href="/choose-stocks-to-invest-with-python-584892e3ad22"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd iu gy z fp oq fr fs or fu fw is bi translated">用 Python 选择要投资的股票</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">您计划在未来 3 年投资几只股票，每只股票的每一美元都有不同的预期回报…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">towardsdatascience.com</p></div></div><div class="ou l"><div class="pb l ow ox oy ou oz md ol"/></div></div></a></div></div></div>    
</body>
</html>