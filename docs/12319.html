<html>
<head>
<title>How to write ETL operations in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 Python 编写 ETL 操作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-write-etl-operations-in-python-baffbceeadf4?source=collection_archive---------7-----------------------#2020-08-25">https://towardsdatascience.com/how-to-write-etl-operations-in-python-baffbceeadf4?source=collection_archive---------7-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5c4f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Python 清理原始数据并将其转换为可接受的格式</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8af52838dd30ea62037978c85833bc4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yir88eW2U2jqL70L"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://unsplash.com/photos/EySEKaimdKo" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="d3e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，您将学习如何在 Python 环境中处理 Excel/CSV 文件，以清理原始数据并将其转换为更易于接受的格式。这对<strong class="lb iu">数据集成</strong>非常有用。</p><p id="10db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本例将涉及到许多常见的 ETL 操作，如<strong class="lb iu">过滤</strong>、<strong class="lb iu">减少、</strong>、<strong class="lb iu">、</strong>和<strong class="lb iu">展平</strong>。</p><h2 id="c5d1" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">笔记</h2><p id="7a28" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">这些例子的代码可以在 GitHub <a class="ae ky" href="https://github.com/hotgluexyz/recipes" rel="noopener ugc nofollow" target="_blank">这里</a>上公开获得，还有我将带你浏览的镜像信息的描述。</p><p id="fe1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些示例依赖于两个开源 Python 包:</p><ul class=""><li id="92b1" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><strong class="lb iu"> pandas: </strong>一个广泛使用的开源数据分析和操作工具。更多关于他们网站<a class="ae ky" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae ky" href="https://pypi.org/project/pandas/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>的信息。</li><li id="1073" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu"> gluestick: </strong>一个小型开源 Python 包，包含由<a class="ae ky" href="https://hotglue.xyz" rel="noopener ugc nofollow" target="_blank"> hotglue </a>团队维护的用于 ETL 的 util 函数。更多关于<a class="ae ky" href="https://pypi.org/project/gluestick/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>和<a class="ae ky" href="https://github.com/hotgluexyz/gluestick" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的信息。</li></ul><p id="6b54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，我们开始吧！</p><h1 id="e732" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">介绍</h1><p id="85f1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">这个例子利用了来自 Quickbooks 沙盒环境的样本 Quickbooks 数据，并且最初是在一个<a class="ae ky" href="https://hotglue.xyz/" rel="noopener ugc nofollow" target="_blank"> hotglue </a>环境中创建的——一个用于初创公司的轻量级数据集成工具。</p><p id="149d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请随时关注下面 GitHub 上的 Jupyter 笔记本！</p><div class="ns nt gp gr nu nv"><a href="https://github.com/hotgluexyz/recipes/blob/master/src/basic.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">hotgluexyz/食谱</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">用 Python 编写 ETL 转换脚本的简单示例</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div><h1 id="7f24" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">第一步:读取数据</h1><p id="fb19" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们从读取数据开始。</p><p id="ca52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个例子建立在 hotglue 环境上，数据来自 Quickbooks。在 hotglue 中，数据以 CSV 格式放在本地的<code class="fe ok ol om on b">sync-output</code>文件夹中。我们将使用<a class="ae ky" href="https://pypi.org/project/gluestick/" rel="noopener ugc nofollow" target="_blank"> gluestick </a>包通过<code class="fe ok ol om on b">read_csv_folder</code>函数将输入文件夹中的原始数据读入熊猫数据帧字典。</p><p id="ef71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过指定<code class="fe ok ol om on b">index_cols={'Invoice': 'DocNumber'}</code>,<code class="fe ok ol om on b">Invoices</code>数据帧将使用<code class="fe ok ol om on b">DocNumber</code>列作为索引。通过指定转换器，我们可以使用<code class="fe ok ol om on b">ast</code>来解析<code class="fe ok ol om on b">Line</code>和<code class="fe ok ol om on b">CustomField</code>列中的 JSON 数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><h2 id="33a6" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">偷看一眼</h2><p id="f7f5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们看看我们正在处理哪些数据。为了简单起见，我选择了我想要使用的列，并将其保存到<code class="fe ok ol om on b">input_df</code>。通常在 hotglue 中，你可以使用一个字段映射来配置它，但是我在这里是手动完成的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/0b319dc6621f209322bfdc79f17e897d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F9BILL_59qOnsD_4LBVA1A.png"/></div></div></figure><h1 id="0e34" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">步骤 2:重命名列</h1><p id="4a81" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们通过将列重命名为更易读的名称来清理数据。</p><pre class="kj kk kl km gt or on os ot aw ou bi"><span id="c02b" class="lv lw it on b gy ov ow l ox oy">CustomerRef__value -&gt; CustomerId<br/>CustomerRef__name -&gt; Customer<br/>MetaData_LastUpdatedTime -&gt; LastUpdated<br/>MetaData_CreateTime -&gt; CreatedOn<br/>CurrencyRef__name -&gt; Currency<br/>CurrencyRef__value -&gt; CurrencyCode</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/98debc42dc09343a9e64629b98412c12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u4Z5ggxHBYePCYrmcT0vcg.png"/></div></div></figure><h1 id="173b" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">第三步:提取信息</h1><p id="8b5b" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><code class="fe ok ol om on b">Line</code>列实际上是 Quickbooks 提供的一个序列化的 JSON 对象，其中有几个有用的元素。我们需要从<strong class="lb iu">展平</strong>JSON 开始，然后<strong class="lb iu">分解</strong>成唯一的列，这样我们就可以处理数据了。</p><p id="079d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，我们将使用<a class="ae ky" href="https://pypi.org/project/gluestick/" rel="noopener ugc nofollow" target="_blank"> gluestick </a>包来完成这个任务。<code class="fe ok ol om on b">explode_json_to_rows</code>函数在一个步骤中处理展平和分解。为了避免分解这个对象的太多层次，我们将指定<code class="fe ok ol om on b">max_level=1</code></p><p id="4e91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是其中的一个片段，可以让你有所了解。</p><pre class="kj kk kl km gt or on os ot aw ou bi"><span id="936e" class="lv lw it on b gy ov ow l ox oy">[{<br/>    'Id': '1',<br/>    'LineNum': '1',<br/>    'Amount': 275.0,<br/>    'DetailType': 'SalesItemLineDetail',<br/>    'SalesItemLineDetail': {<br/>        'ItemRef': {<br/>            'value': '5',<br/>            'name': 'Rock Fountain'<br/>        },<br/>        'ItemAccountRef': {<br/>            'value': '79',<br/>            'name': 'Sales of Product Income'<br/>        },<br/>        'TaxCodeRef': {<br/>            'value': 'TAX',<br/>            'name': None<br/>        }<br/>    },<br/>    'SubTotalLineDetail': None,<br/>    'DiscountLineDetail': None<br/>}]</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/122300504ff83578c65e34b7ed6cac48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NZIwblnImeqTtoLhtPmbcg.png"/></div></div></figure><h1 id="9a77" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">步骤 4:筛选行</h1><p id="a595" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">出于我们的目的，我们只想处理带有<code class="fe ok ol om on b">Line.DetailType</code>或<code class="fe ok ol om on b">SalesItemLineDetail</code>的行(我们不需要小计行)。这是一个常见的 ETL 操作，称为<strong class="lb iu">过滤</strong>，使用 pandas 很容易完成</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/d5979f8804c1334ee599177c1aed57b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GFGsk6b89-X1zci2yeKkAA.png"/></div></div></figure><h1 id="c1a4" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">第五步:更多爆炸</h1><p id="3235" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">看看我们展开的<code class="fe ok ol om on b">Line</code>列中的一些条目。您会注意到它们是 JSON 中的名称值对。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/d60b42a489adcdad3f13c295b9d57e7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YpIh2eMOobVLwO_SUpaQLw.png"/></div></div></figure><p id="7960" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们再次使用<a class="ae ky" href="https://pypi.org/project/gluestick/" rel="noopener ugc nofollow" target="_blank">胶棒</a>通过<code class="fe ok ol om on b">json_tuple_to_cols</code>功能将这些分解成新的列。我们需要指定<code class="fe ok ol om on b">lookup_keys</code>——在我们的例子中，是<code class="fe ok ol om on b">key_prop=name</code>和<code class="fe ok ol om on b">value_prop=value</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/c0df23d85d50ac60d1fc4a9717abfc4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MB4bTdWOWJxX59dkj9Zc6g.png"/></div></div></figure><h1 id="2500" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">第六步:更多爆炸</h1><p id="61fa" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">看一下<code class="fe ok ol om on b">CustomField</code>栏。下面是一个条目示例</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/72910cd891f6c58ed29726ef1a45c02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ugy9MuvCpInlBfErkXlsBg.png"/></div></div></figure><pre class="kj kk kl km gt or on os ot aw ou bi"><span id="4867" class="lv lw it on b gy ov ow l ox oy">[{'DefinitionId': '1', 'Name': 'Crew #', 'Type': 'StringType', 'StringValue': '102'}]</span></pre><p id="b22f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到这是 JSON 编码的数据，指定了一个定制字段:<code class="fe ok ol om on b">Crew #</code>，值为<code class="fe ok ol om on b">102</code></p><p id="1138" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了分解这个，我们需要<strong class="lb iu">减少</strong>这个，因为我们只关心<code class="fe ok ol om on b">Name</code>和<code class="fe ok ol om on b">StringValue</code>。我们可以使用 gluestick 的<code class="fe ok ol om on b">explode_json_to_cols</code>功能和<code class="fe ok ol om on b">array_to_dict_reducer</code>来完成这个任务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ca"><img src="../Images/c835e40a0260c9bd6d5e9fe3340c5129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z8xIHoHqCVgz5YO0t4hHVQ.png"/></div></div></figure><h1 id="3fcf" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">结论</h1><p id="67b6" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我们的最终数据如下所示。在这个示例中，我们使用一个真实世界的例子，使用基本的 Python 工具完成了几个基本的 ETL 操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/d99ca2e8f05ae5866be0cb053873140b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*niiFSOtbqDmN38vnW7FnvA.png"/></div></div></figure><p id="b96b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将来，你可以随意查看开源的<a class="ae ky" href="https://github.com/hotgluexyz/recipes" rel="noopener ugc nofollow" target="_blank">热熔胶配方</a>以获得更多的样本。感谢阅读！</p></div></div>    
</body>
</html>