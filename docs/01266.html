<html>
<head>
<title>How to build an integration between AutoML and MLFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AutoML和MLFlow之间建立集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-an-integration-between-automl-and-mlflow-6d66d4bdc4d1?source=collection_archive---------30-----------------------#2020-02-04">https://towardsdatascience.com/how-to-build-an-integration-between-automl-and-mlflow-6d66d4bdc4d1?source=collection_archive---------30-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c685" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个关于如何自动运行MLFlow的追踪和H2O的AutoML的教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0dd9de8b1a621f0ccf701e4cc2978d53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XXI-kg18liPn4XcfZmoqQQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">unspash.com</p></figure><p id="bb7c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我们将回顾AutoML的概念，它如何提高您的生产力，以及如何跟踪它的性能指标。</p><p id="67da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用以下技术:</p><ul class=""><li id="3fd3" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">Python 3</li><li id="4da7" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated"><a class="ae mi" href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/automl.html" rel="noopener ugc nofollow" target="_blank"> H2O汽车</a></li><li id="d360" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated"><a class="ae mi" href="https://www.mlflow.org" rel="noopener ugc nofollow" target="_blank"> MLFlow </a></li></ul><h2 id="d5c1" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated">什么是AutoML，我为什么要使用它？</h2><p id="fd03" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">顾名思义，它是自动化机器学习管道的过程。我们可以自动化过程的各个阶段，如数据准备、特征工程、模型选择和超参数选择。在本教程中，我们将主要关注模型选择。</p><p id="a1ee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用这种方法有许多好处，例如:</p><ul class=""><li id="f150" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">通过提高数据科学家的工作效率来降低成本</li><li id="5972" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">减少他们必须做的重复性工作和无聊任务的数量</li><li id="5e11" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">模型选择的性能可用作基准，并确定哪些模型最适合由数据科学家进一步研究</li></ul><p id="15ce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">什么是MLFlow？</strong></p><p id="a384" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">MLFlow是一个开源平台，用于在训练后监控和保存机器学习模型。它的伟大之处在于，它可以与H2O或Spark等其他框架集成，构建一个统一且易于使用的环境。</p><p id="7a8f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们深入到在实践中使用AutoML的步骤。</p><p id="c404" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">TL；DR:代码存储在</strong><a class="ae mi" href="https://github.com/BogdanCojocar/medium-articles/tree/master/mlflow-automl" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">Github</strong></a><strong class="la iu">中。</strong></p><h2 id="ce87" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated"><strong class="ak">第一步:准备好环境</strong></h2><p id="1c09" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">要准备好环境，我们需要安装项目文件夹中的新依赖项:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="c5c9" class="mj mk it ni b gy nm nn l no np">pip install -r requirements.txt</span></pre><p id="28d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还需要通过在终端中键入以下命令来启动MLFlow服务器:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="d7e2" class="mj mk it ni b gy nm nn l no np">mlflow ui</span></pre><p id="e622" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在可以通过在浏览器中运行来查看MlFlow ui了<code class="fe nq nr ns ni b"><a class="ae mi" href="http://127.0.0.1:5000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000</a>:</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/c0ade50548f4602afc86db1e76918c30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hk3aIaze29Vb-OPdEU5c6g.png"/></div></div></figure><p id="85a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们应该能够可视化我们运行的所有实验(训练步骤)。我们还可以启动<code class="fe nq nr ns ni b">Jupyter lab</code>笔记本，这是我们编写代码的环境:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="4846" class="mj mk it ni b gy nm nn l no np">jupyter lab</span></pre><h2 id="eed2" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated"><strong class="ak">第二步:启动AutoML框架</strong></h2><p id="89b8" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">H2O是一个分布式框架，为了在本地使用它，我们需要启动一个服务器。根据您的设置，这可能需要一分钟左右的时间:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="3971" class="mj mk it ni b gy nm nn l no np">h2o.init()</span></pre><h2 id="6b9b" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated"><strong class="ak">第三步:创建MLFlow实验</strong></h2><p id="c426" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">MLFlow使用实验的概念来跟踪机器学习模型的进展。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="1789" class="mj mk it ni b gy nm nn l no np">try:<br/>    experiment = mlflow.create_experiment(experiment_name)<br/>except:<br/>    experiment = client.get_experiment_by_name(experiment_name)<br/>mlflow.set_experiment(experiment_name)</span></pre><p id="12ba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果已经创建了实验，我们就重用它。</p><h2 id="7a63" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated">第四步:进行培训</h2><p id="f937" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">我们已经到了最有趣的部分，使用auto ml来做训练。使用数据的独立子集并行训练和验证多个模型(6重交叉验证)。每次新的训练运行都会保存一些验证指标和表现最好的模型(leader)。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="a11b" class="mj mk it ni b gy nm nn l no np">with mlflow.start_run():<br/>    model = H2OAutoML(max_models=10, max_runtime_secs=300, seed=24, nfolds=6)<br/>    model.train(x=x_cols, y=y_cols, training_frame=train, validation_frame=valid)</span><span id="c94e" class="mj mk it ni b gy nu nn l no np">    mlflow.log_metric("rmse", model.leader.rmse())<br/>    mlflow.log_metric("log_loss", model.leader.logloss())<br/>    mlflow.log_metric("mean_per_class_error", model.leader.mean_per_class_error())</span><span id="0216" class="mj mk it ni b gy nu nn l no np">    mlflow.h2o.log_model(model.leader, "model")<br/>    <br/>    lb = model.leaderboard<br/>    lb = get_leaderboard(model, extra_columns='ALL')<br/>    print(lb.head(rows=lb.nrows))</span></pre><p id="45c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们已经决定运行10个模型。使用<code class="fe nq nr ns ni b">get_leaderboard</code>函数，我们可以看到已经运行了哪些机器学习算法:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f13abd0f177fcabfee9b17f513dc94d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8JfuiyDvhclHi5IMStWy_w.png"/></div></div></figure><p id="7b28" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">训练被记录在MLFlow中，我们可以与未来的实验进行比较:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2b85b94044ec0bc76f3f0e5cd67ac707.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oV-suGf5Bt8Sm7pBNHi3qg.png"/></div></div></figure><h2 id="b2e6" class="mj mk it bd ml mm mn dn mo mp mq dp mr lh ms mt mu ll mv mw mx lp my mz na nb bi translated">第五步:做预测</h2><p id="5d4e" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh ne lj lk ll nf ln lo lp ng lr ls lt im bi translated">最后一步是和新当选的领导人一起实际做预测。出于本教程的目的，我们将只使用验证数据，但实际上我们需要使用新的数据。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="d556" class="mj mk it ni b gy nm nn l no np">all_mlflow_runs = client.list_run_infos(experiment.experiment_id)<br/>if len(all_mlflow_runs) &gt; 0:<br/>    run_info = all_mlflow_runs[-1]<br/>    model = mlflow.h2o.load_model("mlruns/{exp_id}/{run_id}/artifacts/model/".format(exp_id=experiment.experiment_id,run_id=run_info.run_uuid))<br/>    result = model.predict(valid)<br/>else:<br/>    raise Exception('Run the training first')</span></pre><p id="dfae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们再次使用MLFlow读取实验中的最新运行，并加载<code class="fe nq nr ns ni b">GLM</code>模型。如果我们从来没有运行过训练，我们可以抛出一个异常来通知用户他必须先这样做。</p><p id="979f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们已经看到，通过几个简单的步骤，我们可以实现模型选择、跟踪和加载/保存给定数据集的最佳机器学习模型的自动化过程。虽然在Kaggle这样的比赛中，我们可以看到人类仍然可以轻松击败AutoML框架，但我们仍然可以将它们作为我们数据科学工具包中的另一个工具，来提高和改善我们的性能。</p></div></div>    
</body>
</html>