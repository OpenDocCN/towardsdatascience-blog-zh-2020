<html>
<head>
<title>Deploying a Flask App on Heroku and Connecting it to MongoDB’s mLab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Heroku 上部署 Flask 应用程序，并将其连接到 MongoDB 的 mLab</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-a-flask-app-on-heroku-and-connecting-it-to-mongodbs-mlab-e0022c4e6d1e?source=collection_archive---------32-----------------------#2020-07-02">https://towardsdatascience.com/deploying-a-flask-app-on-heroku-and-connecting-it-to-mongodbs-mlab-e0022c4e6d1e?source=collection_archive---------32-----------------------#2020-07-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b9e2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将带有 MongoDB mLab 数据库的 Python 应用程序部署到 Heroku 的简短指南。</h2></div><p id="53b6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le"> By: </em> <a class="ae lf" href="https://www.linkedin.com/in/edkrueger/" rel="noopener ugc nofollow" target="_blank"> <em class="le">爱德华克鲁格</em></a><em class="le"/><a class="ae lf" href="http://linkedin.com/in/edward-haarmann-iv/" rel="noopener ugc nofollow" target="_blank"><em class="le">爱德华</em> <em class="le">哈尔曼四世</em></a><a class="ae lf" href="https://www.linkedin.com/in/douglas-franklin-1a3a2aa3/" rel="noopener ugc nofollow" target="_blank"><em class="le">道格拉斯富兰克林</em> </a> <em class="le">。</em></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/d208b33f5ae0b910747d628a7fe1d98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OB1b1dZ8k95e_XhQSjVwMA.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">美国宇航局在 Unsplash 上拍摄的照片</p></figure><p id="44ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">像我们以前的云部署文章一样，我们将介绍如何使用 Pipfile.lock 将应用程序部署到云，并将应用程序连接到云数据库。有关虚拟环境的更多信息或开始使用环境和包管理器 Pipenv，请查看</em> <a class="ae lf" href="https://medium.com/@edkrueger_16881/virtual-environments-for-data-science-running-python-and-jupyter-with-pipenv-c6cb6c44a405" rel="noopener"> <em class="le">这篇文章</em> </a> <em class="le">！</em></p><h2 id="c679" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">部署问题</h2><p id="c7e2" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">由于缺乏对虚拟环境的了解或经验，新开发人员通常在系统级别安装所有东西。用 pip 安装的 Python 包放在系统级。以这种方式为每个项目检索需求会在您的机器上创建一个无法管理的全局 Python 环境。虚拟环境允许你划分你的软件，同时保持一个依赖清单。</p><p id="6762" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Pipenv 是一个用于环境和包管理的工具，它允许开发人员创建更容易部署、构建和修改的独立软件产品。</p><h2 id="942f" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">Pipenv 是什么？</h2><p id="21e9" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">Pipenv 将包管理和虚拟环境控制结合到一个工具中，用于安装、删除、跟踪和记录您的依赖关系:以及创建、使用和管理您的虚拟环境。Pipenv 本质上是将 pip 和 virtualenv 包装在一个产品中。</p><h2 id="bdc7" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">什么是 Heroku？</h2><p id="bee1" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">Heroku 提供许多软件服务产品。我们将需要 Heroku 云平台服务来托管一个应用程序和 mLab 来使用 MongoDB 数据库。别担心，创建一个帐户并使用这些功能是免费的！</p><p id="7897" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">云平台支持多种编程语言的应用，包括 Python、Node.js、Scala、Ruby、Clojure、Java、PHP 和 Go。我们将使用 Heroku GUI 部署一个数据库和一个 Python 应用程序。</p><h2 id="bff3" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">云数据库的优势</h2><p id="35d9" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">在我们以前的部署中，我们使用 SQLite 和 JawsDB 数据库。当使用 SQLite 数据库时，每次应用程序重新部署都会重置您的数据库。JawsDB 非常适合部署 MySQL 关系数据库，该数据库将通过应用程序更新来保持。这一次，我们想要一个基于文档的数据库系统，以 MongoDB 在 Heroku 的 mLab 插件的形式。</p><h2 id="a34b" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">准备部署</h2><p id="c8bd" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">Heroku 允许我们从 GitHub 分支部署应用程序。一旦我们有了一个 Pipfile 被推送到 GitHub 的工作应用程序，请确保您的 Pipfile 在项目的根目录下，我们准备对存储库进行一些最终的更改，为部署做准备。</p><p id="3420" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:这些变化允许我们的应用程序在 Unix 系统上运行。Gunicorn 与 PC 不兼容，因此您将无法在本地测试这些更改。</p><h2 id="166f" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">安装 gunicorn</h2><p id="34ed" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">Gunicorn 是一个 Python WSGI HTTP 服务器，它将为 Heroku 上的 Flask 应用程序提供服务。通过运行下面的代码行，您将 gunicorn 添加到您的 Pipfile 中。</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="dddb" class="lw lx it mv b gy mz na l nb nc">pipenv install gunicorn</span></pre><h2 id="cb37" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">添加 Procfile</h2><p id="4576" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">在项目根文件夹中创建一个 Procfile，并添加以下行:</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="e7ac" class="lw lx it mv b gy mz na l nb nc">web: gunicorn app.app:app</span></pre><p id="1c26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一个应用程序(在。)表示 repo 中包含运行应用程序所需的所有文件的目录。第二个应用程序(在。)是运行您的应用程序的 python 文件的名称或应用程序所在的模块的名称，即 app.py。最后，第三个应用程序(在:)之后)表示您在 app.py 中的 flask 应用程序。此 Procfile 与 gunicorn 和 Heroku 的 Dynos 一起工作，以远程服务您的应用程序。</p><h2 id="add7" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">Heroku 云数据库的建立和部署</h2><p id="1ea2" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">建立一个 Heroku 帐户如果你还没有，不要担心，我们在这里展示的所有功能都是免费的！</p><p id="1936" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到您在 Heroku.com 上的应用，然后单击资源。然后在 addons 框中输入“mLab MongoDB ”,如下所示。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nd"><img src="../Images/0b055d013c24897600f3e4bb246d6c8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r2Tm7pi1CYofqJPLos8KtQ.png"/></div></div></figure><p id="6325" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从下拉列表中选择“Sandbox-free”并单击“Provision”如果您还没有 mLab 的帐户，Heroku 将引导您创建一个帐户。我们现在已经为我们的应用程序部署了一个 MongoDB 数据库！现在我们需要将这个新数据库集成到我们的应用程序逻辑中。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/6da60176e6921b013419565ddb2e8039.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*oGe0wMtVv-Udf13nQpzMyQ.png"/></div></figure><p id="3c91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要将 py mongo(Python MongoDB 库)添加到我们的 Pipfile 中，如下所示:</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="7571" class="lw lx it mv b gy mz na l nb nc">pipenv install pymongo</span></pre><p id="55bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们得到我们的连接字符串，并为 pymongo 修改它。转到设置，用“显示配置变量”按钮查看配置变量。您会在“MONGODB_URI”旁边找到一个类似于下面的连接字符串:</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="bb25" class="lw lx it mv b gy mz na l nb nc">mongodb://heroku_l148hmql:tpna8npo399tsuuy82s7fgma2c@ds175222.mlab.com:51222/heroku_l148hmql</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nf"><img src="../Images/3921f6955a6b9bcc7c1642a08ee0dc2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x4dkIIFI6TcPifX6KaWPZw.png"/></div></div></figure><p id="5a42" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与我们到 JawsDB 的连接不同，我们不需要通过在前面添加 pymongo 驱动程序来调整这个连接字符串。然而，我们仍然必须改变连接字符串。在文本编辑器中，将<code class="fe ng nh ni mv b">?retryWrites=false</code>添加到字符串的末尾，使其类似于下面的字符串。</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="0f3d" class="lw lx it mv b gy mz na l nb nc">mongodb://heroku_0hk44bz1:vrha0rbf397na30dgigjdtkgnc@ds151993.mlab.com:51993/heroku_0hk44bz1?retryWrites=false</span></pre><p id="9f15" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">单击 Heroku 中配置变量旁边的 edit 按钮，然后复制并粘贴这个更新后的字符串，并单击“Save Changes”</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/48fc9e9acdafebc4f2b95c001d121b36.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*2MlJPIXuD-J0tWGLJSXZHg.png"/></div></figure><h2 id="7ed3" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">隐藏连接字符串。包封/包围（动词 envelop 的简写）</h2><p id="fc0c" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">创建一个名为<code class="fe ng nh ni mv b">.env</code>的新文件，并将云数据库的连接字符串添加为 MONGODB_URI，如下所示。</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="9808" class="lw lx it mv b gy mz na l nb nc">MONGODB_URI=”mongodb://root:PASSWORD@HOSTNAME:3306/db_name” [your connection string]</span></pre><p id="188c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:运行 pipenv shell 可以让我们访问这些环境变量。这种访问在下面一行中实现:</p><pre class="lh li lj lk gt mu mv mw mx aw my bi"><span id="9cae" class="lw lx it mv b gy mz na l nb nc">client = pymongo.MongoClient(os.getenv(“MONGODB_URI”, “mongodb://127.0.0.1:27017/database”))</span></pre><p id="e47c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们在 shell 中时，客户端会寻找 MONGODB_URI 环境变量。如果找不到，默认情况下，客户端连接到我们的本地数据库。</p><h2 id="d455" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">应用部署</h2><p id="6247" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">一旦我们有我们的应用程序测试和工作在本地，我们把所有的代码推到主分支。然后在 Heroku 上，转到部署选项卡。选择包含应用程序的存储库，然后点击连接。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nk"><img src="../Images/2682d37474c8c589aba5160e58cc64bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LKo_nicQoB77jb4-jjBSpQ.png"/></div></div></figure><p id="c764" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一步是点击“部署分支”</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nl"><img src="../Images/cba7cb61ac68f8e197ad152969dc9aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YChigTQRxr4NonHox7o_Vw.png"/></div></div></figure><p id="aca4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">构建日志将开始填充页面上的控制台。注意，Heroku 首先查找 requirements.txt 文件，然后从 Pipenv 的 Pipfile.lock 安装依赖项。</p><p id="16fb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦从 Pipfile.lock 构建了您的环境，并且构建成功，您将会看到下面的消息。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nm"><img src="../Images/a6f0236fb455ad4537ae5b2656b7469c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*inFR2-TcTwaoo2V6DeZSlw.png"/></div></div></figure><p id="3ead" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">呜哇！该应用程序已成功部署！点击查看按钮，查看 Heroku 上部署的应用程序。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nn"><img src="../Images/1e026a8c751069e27d7b65d7adf65e77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9XVpPQt_zAoCsqfYV534nA.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">成功发射！照片由 Tim Mossholder 在 Unsplash 上拍摄</p></figure><h2 id="6ee9" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">最初构建集合</h2><p id="5303" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">最初，您需要在 mLab 中手动创建集合(MongoDB 的基于文档的模拟表)。如果第一个集合不存在，客户端将创建它。</p><p id="bbac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，您可以选择在 mLab 中创建集合。如果你想这样做，请从 Heroku 的资源标签进入 mLab 网站。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi no"><img src="../Images/4438db7f312a8657e2e36c2666d7b922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Z0bhWtiyvk8MPjOTMmr3w.png"/></div></div></figure><p id="56e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“收藏”下面，应该写着[目前没有]。在右边，点击“添加收藏”</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi np"><img src="../Images/b50eecae0ba8073ec510a08abcf35ef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6skLXqnSSFzXWTg1XdMeHA.png"/></div></div></figure><p id="e43d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">重要提示</strong>:确保你给这个收藏起的名字和你在应用程序中的名字一样，否则将无法连接。在这个应用程序中，我们将集合称为“帖子”</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/e22628517a498dfc8c457f0da9df94c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*P1IcyCMhBmoNAcNimGgn-g.png"/></div></figure><h2 id="be4a" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">自动部署</h2><p id="c263" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">我们可以启用自动部署，让 Github master 的更改在推送时显示在 Heroku 上。如果您使用这种方法，您将希望确保始终有一个工作的主分支。</p><h2 id="a98c" class="lw lx it bd ly lz ma dn mb mc md dp me kr mf mg mh kv mi mj mk kz ml mm mn mo bi translated">结论</h2><p id="9279" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">对于希望在生产中部署、构建或使用代码的数据科学家和开发人员来说，实践适当的环境和包管理至关重要。</p><p id="9664" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">拥有一个管理良好的 GitHub 主分支允许 Heroku 的服务器用最少的故障排除来重建我们的应用程序。这使得我们可以在几分钟内将一个项目目录从 GitHub 转移到一个可用的、已发布的应用程序中。</p><p id="a3e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用云服务资源很重要，这样你的应用就可以在你自己的机器之外的机器上运行。如果您正在构建一个应用程序，您必须能够使本地构建环境适应其他人将要与之交互的环境。Heroku 的 MongoDB 插件 mLab 允许我们这样做，除了一个连接字符串之外，不需要改变太多！</p><p id="8193" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们希望本指南对您有所帮助！</p></div></div>    
</body>
</html>