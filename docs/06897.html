<html>
<head>
<title>Forecasting Covid-19 tweeting volume using Prophet and SARIMA model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Prophet和SARIMA模型预测新冠肺炎推文量</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/forecasting-covid-19-tweeting-volume-using-prophet-and-sarima-model-25206ea5b23b?source=collection_archive---------48-----------------------#2020-05-28">https://towardsdatascience.com/forecasting-covid-19-tweeting-volume-using-prophet-and-sarima-model-25206ea5b23b?source=collection_archive---------48-----------------------#2020-05-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/7faaa92fc63a3f482d98e819ecf8d5dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RCovcw4NsFobddHvO4520w.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@ihor_malytskyi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">伊霍尔·马里茨基</a>在<a class="ae jg" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><div class=""/><div class=""><h2 id="8093" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">如何在ARIMA建模中确定twitter数据的最佳季节性</h2></div><p id="7200" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文是关于时间序列预测的季节性自回归区间移动平均法。这包括两个部分:首先是使用脸书先知图书馆，这是一个预测时间序列数据的工具，在第二部分，我们将从头开始建立一个最佳ARIMA模型，并将其扩展到季节性ARIMA(萨里玛)。</p><p id="7b1a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据集和笔记本已经上传到<a class="ae jg" href="https://github.com/Qmoein/Arima-vs-Prophet" rel="noopener ugc nofollow" target="_blank">T5这个 </a> <strong class="la jk"> </strong>资源库中。</p><h1 id="1c48" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated"><strong class="ak">数学:</strong></h1><p id="6b73" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">ARIMA模型的特征在于3项:p，d，q:<br/>p = AR项的阶(自回归)<br/>q = MA项的阶(移动平均)<br/> d =使时间序列平稳所需的差异数</p><p id="5351" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果一个时间序列，有季节性模式，我们必须使用季节性ARIMA或萨里玛，因为增加了季节性。在AR模型中，Yt取决于模型的滞后。因此，它是“Yt滞后”的函数。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/c4b68bb1fdd7ef16d0fb911f7af18d9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*8w6KxxfAxo4A7wSnTKt5hA.png"/></div></figure><p id="5cd9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<strong class="la jk"> MA模型</strong>中，Yt取决于滞后预测误差:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mw"><img src="../Images/f4dd5a8bfdb5134a970bc38cfe1fc029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*BEl6OBivaiFNPYdBe_XFUw.png"/></div></div></figure><p id="6c0f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">误差Et和E(t-1)是来自以下等式的误差:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/e6082ac55cab08135e64404218a217cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*uBgZyLDkeB0SttywR-gDHw.png"/></div></figure><p id="b981" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，如果您将<strong class="la jk"> AR </strong>和<strong class="la jk"> MA </strong>模型结合起来，则等式变为:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi my"><img src="../Images/f8cf886b357bb3bcc3e0fce8d765c87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nrg-J3hOrJdRqKqekmL-Fg.png"/></div></div></figure><p id="7017" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk"> ARIMA模型中的文字:</strong></p><p id="6887" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">预测Yt =常数+Y的线性组合滞后(最多p个滞后)+滞后预测误差的线性组合(最多q个滞后)</strong></p><p id="dce4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这里找到更多关于ARIMA背后的数学知识。</p><h1 id="44cd" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">资料组</h1><p id="542e" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">我们使用了Vakavic记录的Twitter数据集，vaka vic是中东的一个NLP服务。该数据集包含从2020年2月15日到2020年4月18日(64天)发布的1，259，478条带有冠状病毒实体的法语推文。让我们快速浏览一下数据:</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="1408" class="ne lv jj na b gy nf ng l nh ni">import pandas as pd<br/>df = pd.read_json('fr-crona-tweets.json')<br/>df.head()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nj"><img src="../Images/d9a914046670981923ebe88753c651f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCamu0IylV6HWXPQZrBspg.png"/></div></div></figure><p id="a7fc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您在datetime列中看到的，数据是在每秒钟内收集的，因此我们必须按分钟、小时甚至更长时间对它们进行分组。</p><p id="18c9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">准备数据</strong></p><p id="ba94" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们只是复制我们需要的列，然后我们将其四舍五入为1分钟的季节性，并计算每分钟的tweets值。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="9610" class="ne lv jj na b gy nf ng l nh ni">df = df[['datetime']].copy()</span><span id="8e6b" class="ne lv jj na b gy nk ng l nh ni">timeseason = '1min'<br/>dftime = df['datetime'].dt.round(timeseason)<br/>newdf = dftime.value_counts()<br/>df = pd.DataFrame(newdf)<br/>df.head()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nl"><img src="../Images/72fd2fb3064cc66c01ba0d25401388bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wj_TaQR_alSHH3_wo5toAg.png"/></div></div></figure><p id="b2cb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">prophet模型期望数据集具有特定的结构，其中包含时间的列应该命名为“ds”，频率列应该命名为“y”。我们将首先重命名dataframe列。然后我们把它写成“1分钟。CSV”。现在我们可以通过改变“时间季节”变量来创造任何季节性。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="6935" class="ne lv jj na b gy nf ng l nh ni">df.index.name = 'ds'<br/>df = df.rename(columns = {'datetime':'y'})<br/>nameoffile = str(timeseason+'.csv')<br/>df.to_csv(nameoffile)<br/>df.head()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/0f8bcf16dbd3c064ebfbefb01deb1c2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5TxtZ9llZkWpXMTnr3MBg.png"/></div></div></figure><p id="13b4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">导入库</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="ebb6" class="ne lv jj na b gy nf ng l nh ni">import numpy as np<br/>import pandas as pd<br/>from fbprophet import Prophet<br/>import seaborn as sns<br/>import matplotlib.pyplot as plt<br/>from sklearn.metrics import mean_squared_error, mean_absolute_error<br/>plt.style.use('fivethirtyeight')</span></pre><h1 id="838f" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated"><strong class="ak"> FB先知:</strong></h1><p id="a925" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated"><a class="ae jg" href="https://facebook.github.io/prophet/" rel="noopener ugc nofollow" target="_blank"> Prophet </a>是一种基于加法模型预测时间序列数据的程序，其中非线性趋势与每年、每周和每天的季节性以及假日影响相适应。它最适用于具有强烈季节效应的时间序列和几个季节的历史数据。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="264c" class="ne lv jj na b gy nf ng l nh ni">data = pd.read_csv('1min.csv',index_col=[0], parse_dates=[0])</span><span id="f46a" class="ne lv jj na b gy nk ng l nh ni">data.plot(style='.', figsize=(15,5), color=["#1DA1F2"], title='TimeLine')</span><span id="b8a2" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nn"><img src="../Images/acee2b6af394cc343c59b32a0c8f52e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQOFcMNXHJ3tVyVk93m9TA.png"/></div></div></figure><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="7a5e" class="ne lv jj na b gy nf ng l nh ni">#Splinting Data</span><span id="afd1" class="ne lv jj na b gy nk ng l nh ni">split_date = '06-apr-2020'</span><span id="7a53" class="ne lv jj na b gy nk ng l nh ni">data_train = data.loc[data.index &lt;= split_date].copy()</span><span id="5e9e" class="ne lv jj na b gy nk ng l nh ni">data_test = data.loc[data.index &gt; split_date].copy()</span><span id="9778" class="ne lv jj na b gy nk ng l nh ni">#Plot train and test so you can see where we have split the data</span><span id="56f9" class="ne lv jj na b gy nk ng l nh ni">data_test.rename(columns={'y': 'TEST SET'}).join(data_train.rename(columns={'y': 'TRAINING SET'}),how='outer').plot(figsize=(15,5), title='French tweets about Coronavirus', style='.')</span><span id="f425" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nn"><img src="../Images/787afb18cb3acf006641e985eafeeb92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4-iS8ivqzbp4KUGPOyPCKg.png"/></div></div></figure><p id="d407" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过实例化一个新的prophet对象来适应这个模型。预测过程的任何设置都被传递到构造函数中。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="013a" class="ne lv jj na b gy nf ng l nh ni">model.fit(data_train.reset_index())</span><span id="20c0" class="ne lv jj na b gy nk ng l nh ni"># Predict on the training set with model</span><span id="7ef6" class="ne lv jj na b gy nk ng l nh ni">data_test_fcst = model.predict(df=data_test.reset_index())<br/>data_test_fcst.head()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi no"><img src="../Images/f61ebed5b2d1d6a1fe62f101cd31fac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLxgmrqMNkqO8ons3-Lc6A.png"/></div></div></figure><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="31a2" class="ne lv jj na b gy nf ng l nh ni"># Plot the forecast</span><span id="1a25" class="ne lv jj na b gy nk ng l nh ni">f, ax = plt.subplots(1)<br/>f.set_figheight(5)<br/>f.set_figwidth(15)<br/>fig = model.plot(data_test_fcst,ax=ax)</span><span id="64fd" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi np"><img src="../Images/b57039d5e6292c187f24d70c30bd3bb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VW0mOHZuBYoubni9E9RTeA.png"/></div></div></figure><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="7cd5" class="ne lv jj na b gy nf ng l nh ni"># Plot the components of the model</span><span id="09b1" class="ne lv jj na b gy nk ng l nh ni">fig = model.plot_components(data_test_fcst)</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/049dec265e5e25a04e30862785e8a7fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*f8WPfmhLkv--VHw7K71JzQ.png"/></div></figure><p id="6ce1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">定义误差指标</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="f258" class="ne lv jj na b gy nf ng l nh ni">def mean_absolute_percentage_error(y_true, y_pred):<br/>    y_true, y_pred = np.array(y_true), np.array(y_pred)<br/>    return np.mean(np.abs((y_true - y_pred) / y_true)) * 100</span><span id="4da0" class="ne lv jj na b gy nk ng l nh ni">MSE = mean_squared_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst['yhat'])</span><span id="3eb7" class="ne lv jj na b gy nk ng l nh ni">MAE = mean_absolute_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst['yhat'])</span><span id="cb3d" class="ne lv jj na b gy nk ng l nh ni">MAPE = mean_absolute_percentage_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst['yhat'])</span><span id="bc75" class="ne lv jj na b gy nk ng l nh ni">print ('MSE :',MSE)<br/>print ('MAE :',MAE)<br/>print ('MAEP', MAPE, '%')</span></pre><p id="771a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">平均误差:169.3955 <br/>平均误差:9.9056 <br/> MAEP: 167.5118%</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="4aaa" class="ne lv jj na b gy nf ng l nh ni">ax = data_test_fcst.set_index('ds')['yhat'].plot(figsize=(15, 5), lw=0, style='.')<br/>data_test['y'].plot(ax=ax, style='x', lw=3, alpha=0.1)</span><span id="7bee" class="ne lv jj na b gy nk ng l nh ni">plt.legend(['Forecast','Actual'])<br/>plt.title('Forecast vs Actuals')</span><span id="ac3c" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nr"><img src="../Images/c8001ce887bba8d48d43856f41b664c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wfM71yXDg-XqmsHBNoyimQ.png"/></div></div></figure><p id="587e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如你所看到的，167%的MAPE是完全不能接受的，我们必须尝试其他季节。请记住，要将数据更改为新的季节，您必须更改“time eason”变量(即:timeseason = ' 1min ')。其他5个的结果如下所示。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ns"><img src="../Images/2472d28f87921f3945fc1e6c39056355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b2hzKJnva_b2m0kXw2cYgw.png"/></div></div></figure><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nt"><img src="../Images/7113499b3c3853a296c992c0f56ac76d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1BF2U140NELXjgMvdmSkw.png"/></div></div></figure><p id="4839" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们得到了1440分钟时间(1天)的更好的结果，是121%，我们知道这仍然是不可接受的。因此，让我们为此清理数据。</p><h1 id="0144" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated"><strong class="ak">季节性1天的清洁数据</strong></h1><p id="5d37" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">清除突出显示的坏数据(在图中用红点表示)</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="b668" class="ne lv jj na b gy nf ng l nh ni">ax = data_train.plot(style='.', figsize=(15,5), color=['#6387c2'],<br/>title='French tweets dataset with bad data highlighted',<br/>xlim=('03-9-2020','04-6-2020')<br/>)</span><span id="911d" class="ne lv jj na b gy nk ng l nh ni">data_train.query('y &gt; 40000').plot(style='.', figsize=(15,5), color=['#eb6b26'], ax=ax)</span><span id="7b6a" class="ne lv jj na b gy nk ng l nh ni">ax.legend().set_visible(False)<br/>plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nu"><img src="../Images/65a2bedc6d4515671e0e69343bb6857f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UfYo1FaM9yMbZkx5ubnXmQ.png"/></div></div></figure><p id="6de5" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们想要创建新的训练数据，所以我们暂时更改数据索引名称:</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="702c" class="ne lv jj na b gy nf ng l nh ni">data_train = data_train.rename(columns = {'y':'freq'})</span><span id="cdbc" class="ne lv jj na b gy nk ng l nh ni">data_train.index.name = 'Datetime'</span><span id="1277" class="ne lv jj na b gy nk ng l nh ni">data_train.head()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nv"><img src="../Images/beef1fb4d323fcd653b5e201411e34b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POmlKkdAMgK_wvBY1wGaSA.png"/></div></div></figure><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="6db1" class="ne lv jj na b gy nf ng l nh ni"># Clean Data on freq</span><span id="55a3" class="ne lv jj na b gy nk ng l nh ni">import numpy as np</span><span id="3e25" class="ne lv jj na b gy nk ng l nh ni">data_train['data_clean'] = data_train['freq']</span><span id="bdf0" class="ne lv jj na b gy nk ng l nh ni">data_train.loc[data_train['freq'] &gt; 30000, 'data_clean'] = np.nan</span><span id="cb3c" class="ne lv jj na b gy nk ng l nh ni"># Train model on clean data</span><span id="dd7a" class="ne lv jj na b gy nk ng l nh ni">model = Prophet()</span><span id="71fa" class="ne lv jj na b gy nk ng l nh ni">model.fit(data_train.reset_index() \</span><span id="0c15" class="ne lv jj na b gy nk ng l nh ni">.rename(columns={'Datetime':'ds',</span><span id="e43a" class="ne lv jj na b gy nk ng l nh ni">'data_clean':'y'})</span><span id="d0ba" class="ne lv jj na b gy nk ng l nh ni">)</span><span id="a50c" class="ne lv jj na b gy nk ng l nh ni"># Predict on training set with clean model</span><span id="a32f" class="ne lv jj na b gy nk ng l nh ni">data_test_fcst_clean = model.predict(df=data_test.reset_index() \</span><span id="c44d" class="ne lv jj na b gy nk ng l nh ni">.rename(columns={'Datetime':'ds'}))</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nw"><img src="../Images/c671fe5af4974094d414dfc540d322ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DsC3xp-bdgy_0lXMENQeBw.png"/></div></div></figure><p id="0f47" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">定义已清理数据的错误指标</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="c100" class="ne lv jj na b gy nf ng l nh ni">mse_clean = mean_squared_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst_clean['yhat']<br/>)</span><span id="8873" class="ne lv jj na b gy nk ng l nh ni">mae_clean = mean_absolute_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst_clean['yhat']<br/>)</span><span id="099f" class="ne lv jj na b gy nk ng l nh ni">mape_clean = mean_absolute_percentage_error(y_true=data_test['y'],<br/>y_pred=data_test_fcst_clean['yhat'])</span><span id="8572" class="ne lv jj na b gy nk ng l nh ni">print(f'Cleaned data model has MSE {mse_clean:0.4f} - MAE {mae_clean:0.4f} - MAPE {mape_clean:0.4f}')</span></pre><p id="dc98" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">MSE:156554655.1105<br/>MAE:10975.0188<br/>MAEP:63.7044%</p><p id="5296" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们通过清理“1天”时间序列实现了63%。结果比未清洗的好58%,但仍不可接受。清理数据对所有季节的影响并不相同。正如您在下图中看到的，清洁后的某些季节性结果甚至比清洁前的结果更差。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nx"><img src="../Images/6d74b0648d275bd64da8088f96f509ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X06MmVVUrZgaqk06bZn8EA.png"/></div></div></figure><h1 id="da72" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">萨里玛造型:</h1><p id="9cd8" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated"><strong class="la jk">导入库:</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="abe0" class="ne lv jj na b gy nf ng l nh ni">import warnings<br/>import itertools<br/>import numpy as np<br/>from sklearn.metrics import mean_squared_error, mean_absolute_error<br/>import matplotlib.pyplot as plt<br/>warnings.filterwarnings("ignore")<br/>plt.style.use('fivethirtyeight')<br/>import pandas as pd<br/>import statsmodels.api as sm</span><span id="6e26" class="ne lv jj na b gy nk ng l nh ni">import matplotlib<br/>matplotlib.rcParams['axes.labelsize'] = 14<br/>matplotlib.rcParams['xtick.labelsize'] = 12<br/>matplotlib.rcParams['ytick.labelsize'] = 12<br/>matplotlib.rcParams['text.color'] = 'G'</span></pre><p id="65af" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我们在上一节中得到的结果，1天的季节性是最佳的。因此，我们将数据框定义为“1440分钟”。CSV”。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="5771" class="ne lv jj na b gy nf ng l nh ni">df = pd.read_excel("1440min.xlsx")</span><span id="f48f" class="ne lv jj na b gy nk ng l nh ni">y.plot(figsize=(20,5))<br/>plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ny"><img src="../Images/bf7e25424f567f9f2e54f21aa9c8fe78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ctT6zCSZke-6ZM7wDIlo8Q.png"/></div></div></figure><p id="c6ac" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">使用AIC(赤池信息标准):</strong></p><p id="5190" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">AIC比较了一组统计模型的质量，AIC值较低的模型给出了更好的结果。正如我们所说，SARIMA有三个参数，分别代表季节性、趋势和数据中的噪声。</p><p id="bb02" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，我们将检查可能的季节性订单，并获得最低的AIC值。</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="98f3" class="ne lv jj na b gy nf ng l nh ni">p = d = q = range(0, 2)</span><span id="c96c" class="ne lv jj na b gy nk ng l nh ni">pdq = list(itertools.product(p, d, q))</span><span id="073f" class="ne lv jj na b gy nk ng l nh ni">seasonal_pdq = [(x[0], x[1], x[2], 12) for x in list(itertools.product(p, d, q))]</span><span id="93b7" class="ne lv jj na b gy nk ng l nh ni">for param in pdq:</span><span id="5090" class="ne lv jj na b gy nk ng l nh ni">for param_seasonal in seasonal_pdq:</span><span id="884a" class="ne lv jj na b gy nk ng l nh ni">model = sm.tsa.statespace.SARIMAX(y,order=param,seasonal_order=param_seasonal,enforce_stationarity=False,enforce_invertibility=False)</span><span id="d8d9" class="ne lv jj na b gy nk ng l nh ni">results = model.fit()</span></pre><p id="0ecc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">… <br/> ARIMA(1，1，1)x(0，1，1，12)12—AIC:717.3527391232792<br/>ARIMA(1，1，1)x(1，0，0，12)12—AIC:961.0509395792214<br/>ARIMA(1，1，1)x(1，0，1，12)12—AIC:939.8989814</p><p id="f448" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据结果，718.9785是ARIMA模型的最优AIC值，那么我们将我们的季节顺序设置为(1，1，1)x(1，1，1，12):</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="2eb5" class="ne lv jj na b gy nf ng l nh ni">model = sm.tsa.statespace.SARIMAX(y,</span><span id="d34e" class="ne lv jj na b gy nk ng l nh ni">order=(0, 1, 1),</span><span id="e78d" class="ne lv jj na b gy nk ng l nh ni">seasonal_order=(1, 1, 1, 12),</span><span id="88af" class="ne lv jj na b gy nk ng l nh ni">enforce_stationarity=False,</span><span id="b244" class="ne lv jj na b gy nk ng l nh ni">enforce_invertibility=False)</span><span id="fd7d" class="ne lv jj na b gy nk ng l nh ni">results = mod.fit()</span><span id="efb0" class="ne lv jj na b gy nk ng l nh ni">print(results.summary().tables[1])</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nz"><img src="../Images/37ea3ba374ada48df9a2f1537f777c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u_pXw0_NEtzwfA7Z1KNGbQ.png"/></div></div></figure><p id="ee0f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在通过回归诊断图，您可以看到回归模型拟合数据的花费:</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="48fd" class="ne lv jj na b gy nf ng l nh ni">results.plot_diagnostics(figsize=(18, 8))</span><span id="1003" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oa"><img src="../Images/ba5c9dd61f6f8e95008d6b7eec8f1ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nuHigWK03mYrVC4lA6WRMA.png"/></div></div></figure><p id="c02f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在测试集上将实际数据(y)与预测进行比较:</p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="9216" class="ne lv jj na b gy nf ng l nh ni">pred = results.get_prediction(start=pd.to_datetime('2020-3-31'), dynamic=True)</span><span id="d57c" class="ne lv jj na b gy nk ng l nh ni">pred_ci = pred.conf_int()</span><span id="8074" class="ne lv jj na b gy nk ng l nh ni">ax = y['2020':].plot(label='observed')</span><span id="0ab2" class="ne lv jj na b gy nk ng l nh ni">pred.predicted_mean.plot(ax=ax, label='Forecast', alpha=.7, figsize=(14, 4))</span><span id="79b0" class="ne lv jj na b gy nk ng l nh ni">ax.fill_between(pred_ci.index,</span><span id="2424" class="ne lv jj na b gy nk ng l nh ni">pred_ci.iloc[:, 0],</span><span id="11e1" class="ne lv jj na b gy nk ng l nh ni">pred_ci.iloc[:, 1], color='K', alpha=.2)</span><span id="5d9a" class="ne lv jj na b gy nk ng l nh ni">ax.set_xlabel('Date')</span><span id="0ba3" class="ne lv jj na b gy nk ng l nh ni">ax.set_ylabel('Tweets volume per 1 day')</span><span id="25c5" class="ne lv jj na b gy nk ng l nh ni">plt.legend()</span><span id="5756" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ob"><img src="../Images/e4b1fa450516999eb88abd2d756663be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QdWgaB9xQ9_6nUe8LpKeGQ.png"/></div></div></figure><p id="2421" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">定义误差指标</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="1812" class="ne lv jj na b gy nf ng l nh ni">def mean_absolute_percentage_error(y_true, y_pred):</span><span id="f220" class="ne lv jj na b gy nk ng l nh ni">y_true, y_pred = np.array(y_true), np.array(y_pred)</span><span id="9fef" class="ne lv jj na b gy nk ng l nh ni">return np.mean(np.abs((y_true - y_pred) / y_true)) * 100</span><span id="e924" class="ne lv jj na b gy nk ng l nh ni"><br/>MSE = mean_squared_error(y_true=y['2020-3-31':],</span><span id="49bc" class="ne lv jj na b gy nk ng l nh ni">y_pred=pred.predicted_mean)</span><span id="78b9" class="ne lv jj na b gy nk ng l nh ni">MAE = mean_absolute_error(y_true=y['2020-3-31':],</span><span id="703c" class="ne lv jj na b gy nk ng l nh ni">y_pred=pred.predicted_mean)</span><span id="8153" class="ne lv jj na b gy nk ng l nh ni">MAPE = mean_absolute_percentage_error(y_true=y['2020-3-31':],</span><span id="d958" class="ne lv jj na b gy nk ng l nh ni">y_pred=pred.predicted_mean)</span><span id="db65" class="ne lv jj na b gy nk ng l nh ni">print ('MSE :',MSE)</span><span id="1bf0" class="ne lv jj na b gy nk ng l nh ni">print ('MAE :',MAE)</span><span id="b3e1" class="ne lv jj na b gy nk ng l nh ni">print ('MAEP', MAPE, '%')</span><span id="06c1" class="ne lv jj na b gy nk ng l nh ni">y_pred = pred.predicted_mean ;y_true = y['2020-3-31':]</span></pre><p id="c45e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">MSE:28827140.1939<br/>MAE:4145.2211<br/>MAEP:19.6832%</p><p id="2c59" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">恭喜，我们得到了19.68 %的平均绝对误差百分比，这是可以接受的，这是约44%低于先知的最好结果，由清洗数据。</p><p id="08f6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">它对我们的基本面分析有帮助吗？</strong></p><p id="92fd" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">答案是否定的，如果你看看时间线，你会发现在3月16日，频率已经跃升。原因是法国政府已经宣布全面隔离，但我们简单的SARIMA模型无法预测这种类型的时间序列数据变化。可以帮助我们的是使用NLP N-gram模型(未来的工作)。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oc"><img src="../Images/2966913aab67b7e915cbb6b4f462b373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KQFnWd8Bbkq32H7c0AUHKw.png"/></div></div></figure><p id="6366" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">预测未来两周:</strong></p><pre class="ms mt mu mv gt mz na nb nc aw nd bi"><span id="de7b" class="ne lv jj na b gy nf ng l nh ni">pred_uc = results.get_forecast(steps=14)</span><span id="dcc0" class="ne lv jj na b gy nk ng l nh ni">pred_ci = pred_uc.conf_int()</span><span id="9307" class="ne lv jj na b gy nk ng l nh ni">ax = y.plot(label='observed', figsize=(14, 4))</span><span id="5b49" class="ne lv jj na b gy nk ng l nh ni">pred_uc.predicted_mean.plot(ax=ax, label='Forecast')</span><span id="085b" class="ne lv jj na b gy nk ng l nh ni">ax.fill_between(pred_ci.index,</span><span id="d0ee" class="ne lv jj na b gy nk ng l nh ni">pred_ci.iloc[:, 0],</span><span id="a5ed" class="ne lv jj na b gy nk ng l nh ni">pred_ci.iloc[:, 1], color='k', alpha=.25)</span><span id="fb47" class="ne lv jj na b gy nk ng l nh ni">ax.set_xlabel('Date')</span><span id="73f4" class="ne lv jj na b gy nk ng l nh ni">ax.set_ylabel('Sales')</span><span id="b8c0" class="ne lv jj na b gy nk ng l nh ni">plt.legend()</span><span id="c9a6" class="ne lv jj na b gy nk ng l nh ni">plt.show()</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi od"><img src="../Images/ee4b806e8b245107630113df404963a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pqoo4NzhU3_MkvsWiUaLGg.png"/></div></div></figure><h1 id="7f03" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated"><strong class="ak">结论:</strong></h1><p id="cfa2" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">我们想回答“twitter数据上时间序列预测的最佳季节性是什么？”首先，在使用FB-prophet时，假设更多的数据给我们更好的结果，我们选择1分钟的季节性，然后发现最佳的时间序列是1天。我们通过删除坏的亮点来清理数据，并在1天序列中获得更好的结果，并且理解这不会对其他季节产生相同的影响。然后，我们尝试通过使用AIC选择最佳订单来创建一个SARIMA模型，并获得19%的MAPE，这是一个可接受的结果。</p><p id="e7ea" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">未来作品:</strong></p><p id="2d61" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尝试其他清洁方法</p><p id="2e20" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用XG-boost最小化MAPE</p><p id="3bc8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用N-gram模型预测文本内容基本时间序列</p><h1 id="8744" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated"><strong class="ak">参考文献:</strong></h1><p id="0808" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">[1] C.McClellan，M.Ali，R.Mutter，L.Kroutil，J.Landwehr，<a class="ae jg" href="https://academic.oup.com/jamia/article/24/3/496/2907899" rel="noopener ugc nofollow" target="_blank">使用社交媒体监控心理健康讨论——来自Twitter的证据</a> (2017)，美国医学信息学协会杂志</p><p id="2812" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[2] S.Prabhakaran <em class="oe">，</em><a class="ae jg" href="https://www.machinelearningplus.com/time-series/arima-model-time-series-forecasting-python/" rel="noopener ugc nofollow" target="_blank">machinelearningplus.com ARIMA模型Python中时间序列预测完全指南</a></p><p id="5d62" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[3] R.Larrosa，<a class="ae jg" rel="noopener" target="_blank" href="/how-to-forecast-sales-with-python-using-sarima-model-ba600992fa7d">如何使用萨里玛模型使用Python预测销售额【towardsdatascience.com T21】(2019)</a></p><p id="9e82" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[4] R.Mulla，<a class="ae jg" href="https://www.kaggle.com/robikscube/time-series-forecasting-with-prophet" rel="noopener ugc nofollow" target="_blank">利用脸书的预言家进行逐时时间序列预测</a> (2020)，kaggle.com</p></div></div>    
</body>
</html>