<html>
<head>
<title>How to export a BigQuery ML model and deploy it for online prediction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何导出 BigQuery ML 模型并将其部署用于在线预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-export-a-bigquery-ml-model-and-deploy-it-for-online-prediction-a7e4d44c4c93?source=collection_archive---------40-----------------------#2020-05-17">https://towardsdatascience.com/how-to-export-a-bigquery-ml-model-and-deploy-it-for-online-prediction-a7e4d44c4c93?source=collection_archive---------40-----------------------#2020-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1279" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以 TensorFlow SavedModel 格式导出 BigQuery ML 模型并部署到云 AI 平台预测</h2></div><p id="fe33" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将向您展示如何将 BigQuery ML 模型导出为 TensorFlow 的 SavedModel 格式。这将允许您将模型部署到任何支持 TensorFlow 服务的环境中。我将使用云人工智能平台预测来演示这一点，并向您展示如何调用在线预测。</p><h2 id="bb68" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">1.训练 BigQuery ML 模型</h2><p id="fb6c" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">当然，首先我们需要一个 BigQuery ML 模型。为了简单起见，我将在我们的书“<a class="ae lz" href="https://www.amazon.com/Google-BigQuery-Definitive-Warehousing-Analytics/dp/1492044466" rel="noopener ugc nofollow" target="_blank"> BigQuery:权威指南</a>”中使用的同一个伦敦自行车数据集上使用一个简单的线性模型。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/553c24b2263d6a2cbe8cf0913c0c8b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*RLLDTbxQ14iLPdwS6VOd9A.jpeg"/></div></figure><p id="b188" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，在 EU 位置创建一个数据集来保存训练好的模型(可以在 CloudShell 中运行这个命令，也可以从 BigQuery 控制台执行这个操作；请确保选择 EU 作为地点):</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="98d7" class="lb lc iq mj b gy mn mo l mp mq">bq show ch09eu || bq mk --location=EU ch09eu</span></pre><p id="9124" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，在 BigQuery 控制台中运行这个查询:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="b8b0" class="lb lc iq mj b gy mn mo l mp mq">CREATE OR REPLACE MODEL ch09eu.bicycle_model_linear<br/>OPTIONS(input_label_cols=['duration'], model_type='linear_reg')<br/>AS</span><span id="02a1" class="lb lc iq mj b gy mr mo l mp mq">SELECT <br/>  duration<br/>  , start_station_name<br/>  , IF(EXTRACT(dayofweek FROM start_date) BETWEEN 2 and 6, 'weekday', 'weekend') as dayofweek<br/>  , FORMAT('%02d', EXTRACT(HOUR FROM start_date)) AS hourofday<br/>FROM `bigquery-public-data`.london_bicycles.cycle_hire</span></pre><p id="7d2d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将创建一个名为 bicycle_model_linear 的模型，该模型采用 3 个输入(start_station_name、dayofweek、hourofday)来预测以秒为单位的持续时间。</p><h2 id="cb87" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">2.在 SQL 中尝试批量预测</h2><p id="6fc1" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">让我们试着调用 BigQuery 本身的模型。为此，运行以下查询:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="4b53" class="lb lc iq mj b gy mn mo l mp mq">SELECT * FROM ML.PREDICT(MODEL ch09eu.bicycle_model_linear,(<br/>  SELECT<br/>  'Vauxhall Cross, Vauxhall' AS start_station_name<br/>  , 'weekend' as dayofweek<br/>  , '17' AS hourofday)<br/>)</span></pre><p id="5b63" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将返回:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/25504b345f5ad1b8e9d3a7293895fe21.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*dU-Xksy8FE1tBvhP5i3P2Q.png"/></div></figure><p id="cc5e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如你所见，周末下午 5 点在沃克斯豪尔开始的一次骑行的预计持续时间是 1329 秒。</p><h2 id="1081" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">3.将模型导出到 Google 云存储</h2><p id="4bae" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">让我们从 BigQuery 下载这个模型作为 TensorFlow SavedModel。为此，从 CloudShell 运行以下命令:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="e099" class="lb lc iq mj b gy mn mo l mp mq">PROJECT=$(gcloud config get-value project)<br/>BUCKET=${PROJECT}-eu<br/>gsutil mb -l eu gs://${BUCKET}<br/>bq extract -m ch09eu.bicycle_model_linear \<br/>           gs://${BUCKET}/bqml_model_export/bicycle_model_linear</span></pre><p id="c00e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该命令的作用是创建一个名为 xyz-eu 的 bucket，其中 xyz 是您的项目名称。然后，我们调用 bq extract 将模型导出到 GCS。</p><p id="5fa2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">命令完成后，检查导出了哪些文件:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="cf93" class="lb lc iq mj b gy mn mo l mp mq">gsutil ls gs://${BUCKET}/bqml_model_export/bicycle_model_linear/</span></pre><p id="da50" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我这么做的时候，我得到了:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="52bc" class="lb lc iq mj b gy mn mo l mp mq">gs://ai-analytics-solutions-eu/bqml_model_export/bicycle_model_linear/<br/>gs://ai-analytics-solutions-eu/bqml_model_export/bicycle_model_linear/saved_model.pb<br/>gs://ai-analytics-solutions-eu/bqml_model_export/bicycle_model_linear/assets/<br/>gs://ai-analytics-solutions-eu/bqml_model_export/bicycle_model_linear/variables/</span></pre><p id="73d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是 TensorFlow SavedModel 格式。您可以将它部署到任何 TF 服务环境中进行在线预测。在 GCP，TensorFlow/xgboost/PyTorch/etc 的全托管服务环境。models 是云 AI 平台(CAIP)的预测。</p><h2 id="884c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">4.将模型部署到云人工智能平台预测</h2><p id="bd9b" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">为了部署模型，<a class="ae lz" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/bqml_model_export/deploy.sh" rel="noopener ugc nofollow" target="_blank">从 GitHub </a>存储库中下载 deploy.sh 并运行它:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="b6d3" class="lb lc iq mj b gy mn mo l mp mq">./deploy.sh gs://${BUCKET}/bqml_model_export/bicycle_model_linear \<br/>      europe-west1 london_bicycles bqml</span></pre><p id="8e5f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">deploy.sh 的作用是在 CAIP 预测中创建一个模型和模型版本，然后部署到其中。</p><p id="679b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">部署模型可能需要 4-5 分钟，因此在进入下一步之前，请监控<a class="ae lz" href="https://console.cloud.google.com/ai-platform/models/$MODEL_NAME/versions" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/ai-platform/models/London _ bicycles/versions</a>以确保模型已部署。</p><h2 id="f550" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">5.尝试在线预测</h2><p id="9154" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">用我们想要发送给模型的输入创建一个名为 input.json 的文件。您可以通过在 CloudShell 中键入以下内容来实现这一点:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="a919" class="lb lc iq mj b gy mn mo l mp mq">cat &gt; input.json</span></pre><p id="a595" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，在提示符下，键入:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="44b2" class="lb lc iq mj b gy mn mo l mp mq">{"start_station_name": "Vauxhall Cross, Vauxhall", "dayofweek": "weekend", "hourofday": "17"}</span></pre><p id="0483" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，按 Ctrl-D 返回到提示符。</p><p id="0087" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用以下方式将 input.json 发送到 CAIP 预测:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="7d5b" class="lb lc iq mj b gy mn mo l mp mq">gcloud ai-platform predict --model london_bicycles \<br/>       --version bqml --json-instances input.json</span></pre><p id="b843" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我这样做的时候，我回来了:</p><pre class="mb mc md me gt mi mj mk ml aw mm bi"><span id="493b" class="lb lc iq mj b gy mn mo l mp mq">PREDICTED_LABEL<br/>[1329.178180269723]</span></pre><p id="1190" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这与我们在 BigQuery ML 中进行批量预测时获得的持续时间相同。</p><p id="cdc0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CAIP 预测公开了一个采用 JSON 的 REST API，因此可以从任何能够进行 web 服务调用的语言中调用它。</p><p id="6c3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><h2 id="5815" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">后续步骤:</h2><ol class=""><li id="5d27" class="mt mu iq kh b ki lu kl lv ko mv ks mw kw mx la my mz na nb bi translated">在 GitHub 上查看<a class="ae lz" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/tree/master/blogs/bqml_model_export" rel="noopener ugc nofollow" target="_blank">查询和代码</a>。</li><li id="bbf3" class="mt mu iq kh b ki nc kl nd ko ne ks nf kw ng la my mz na nb bi translated">阅读我们关于 BigQuery 的<a class="ae lz" href="https://www.amazon.com/Google-BigQuery-Definitive-Warehousing-Analytics/dp/1492044466" rel="noopener ugc nofollow" target="_blank">书</a></li><li id="333f" class="mt mu iq kh b ki nc kl nd ko ne ks nf kw ng la my mz na nb bi translated">查看关于模型导出的<a class="ae lz" href="https://cloud.google.com/bigquery-ml/docs/exporting-models" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae lz" href="https://cloud.google.com/bigquery-ml/docs/export-model-tutorial" rel="noopener ugc nofollow" target="_blank">教程</a></li></ol></div></div>    
</body>
</html>