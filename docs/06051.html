<html>
<head>
<title>Stream your data changes in MySQL into ElasticSearch using Debezium, Kafka, and Confluent JDBC Sink Connector</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Debezium、Kafka和融合的JDBC Sink Connector将MySQL中的数据更改导入ElasticSearch</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stream-your-data-changes-in-mysql-into-elasticsearch-using-debizium-kafka-and-confluent-jdbc-b93821d4997b?source=collection_archive---------21-----------------------#2020-05-17">https://towardsdatascience.com/stream-your-data-changes-in-mysql-into-elasticsearch-using-debizium-kafka-and-confluent-jdbc-b93821d4997b?source=collection_archive---------21-----------------------#2020-05-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9655" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用Debezium将MySQL中的数据变化一步一步地导入Elasticsearch</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/137a4db217062df8d064d67dea046a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-GrDjHVoV8yoT_z2iJAFIg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杰罗姆·普拉克斯在<a class="ae ky" href="https://unsplash.com/s/photos/water-stream?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6a15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快速搜索能力，实时综合数据，现在是必要的，如果我们想建立像电子目录或电子商务。我们不希望我们的用户生气，因为他们花费大量时间只是为了从我们的门户网站获取信息。我们还希望我们的产品团队在不同的应用程序中输入的产品信息能够立即被我们的用户或客户搜索到。</p><p id="becc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比方说使用MySQL作为主要数据源的产品团队。我们将在门户网站中使用ElasticSearch作为搜索引擎服务。我们需要MySQL的每一个变化都会立即影响到ElasticSearch索引。如何达到那个要求？</p><p id="c074" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的第一篇文章中，我将展示如何使用Debezium、Kafka和融合JDBC Sink Connector将MySQL中的数据更改流式传输到ElasticSearch中，以实现上述用例需求。感谢我的主人<a class="lv lw ep" href="https://medium.com/u/92236fea730d?source=post_page-----b93821d4997b--------------------------------" rel="noopener" target="_blank"> Erfin Feluzy </a>，他把我介绍给Debezium，并给了我写第一篇关于媒介的文章的灵感。</p><h1 id="5b74" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">解决方案高级图表</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/246fe02897b78ae954343a25e860e1fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPYUYyjwyYp2d3UJdQXOFw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">解决方案HLD图</p></figure><h1 id="5c61" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">关于技术的简短介绍</h1><h2 id="00fa" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated">Debezium</h2><p id="8b9f" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Debezium是一个分布式平台，它将您现有的数据库转换成事件流，因此应用程序可以对数据库中的每个行级更改做出快速反应。Debezium构建在Kafka之上，提供Kafka Connect兼容的连接器来监控特定的数据库管理系统。Debezium在Kafka日志中记录数据更改的历史，因此您的应用程序可以在任何时候停止和重新启动，并且可以轻松地消耗它在不运行时错过的所有事件，确保所有事件都得到正确和完整的处理。</p><p id="b39e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Debezium是在Apache许可下的开源软件，版本2.0 </p><h2 id="94f1" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated">卡夫卡</h2><p id="62d6" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Apache Kafka是由<a class="ae ky" href="https://en.wikipedia.org/wiki/LinkedIn" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>开发的<a class="ae ky" href="https://en.wikipedia.org/wiki/Open-source_software" rel="noopener ugc nofollow" target="_blank">开源</a> <a class="ae ky" href="https://en.wikipedia.org/wiki/Stream_processing" rel="noopener ugc nofollow" target="_blank">流处理</a>软件平台，捐赠给<a class="ae ky" href="https://en.wikipedia.org/wiki/Apache_Software_Foundation" rel="noopener ugc nofollow" target="_blank"> Apache软件基金会</a>，用<a class="ae ky" href="https://en.wikipedia.org/wiki/Scala_(programming_language)" rel="noopener ugc nofollow" target="_blank"> Scala </a>和<a class="ae ky" href="https://en.wikipedia.org/wiki/Java_(programming_language)" rel="noopener ugc nofollow" target="_blank"> Java </a>编写。该项目旨在为处理实时数据馈送提供一个统一、高吞吐量、低延迟的平台。</p><h2 id="3d30" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated">汇流JDBC水槽连接器</h2><p id="a3bc" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Kafka Connect Elasticsearch接收器连接器允许将数据从Apache Kafka移动到Elasticsearch。它将Apache Kafka中一个主题的数据写入Elasticsearch中的一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/indices-create-index.html" rel="noopener ugc nofollow" target="_blank">索引</a>中，一个主题的所有数据都是相同的</p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="f57a" class="lx ly it bd lz ma no mc md me np mg mh jz nq ka mj kc nr kd ml kf ns kg mn mo bi translated">让我们开始教程</h1><blockquote class="nt nu nv"><p id="1c7e" class="kz la nw lb b lc ld ju le lf lg jx lh nx lj lk ll ny ln lo lp nz lr ls lt lu im bi translated">在本教程中，我们将为每个服务使用一个单独的容器，不使用持久卷。ZooKeeper和Kafka通常将它们的数据本地存储在容器中，这需要您在主机上将目录挂载为卷。因此，在本教程中，当容器停止时，所有持久化的数据都会丢失</p></blockquote><h2 id="9e22" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">第一步运行Zookeeper </strong></h2><p id="9f87" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">使用debezium/zookeeper映像在容器中启动zookeeper。容器将以名称<strong class="lb iu"> zookeeperdbz </strong>运行</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="2699" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it — name zookeeperdbz -p 2181:2181 -p 2888:2888 -p 3888:3888 debezium/zookeeper:1.1</span></pre><p id="b6ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查运行日志以验证zookeeper运行成功并监听端口<code class="fe oj ok ol ob b">2181</code></p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="40bb" class="mq ly it ob b gy of og l oh oi">Starting up in standalone mode</span><span id="e749" class="mq ly it ob b gy om og l oh oi">ZooKeeper JMX enabled by default</span><span id="1bf1" class="mq ly it ob b gy om og l oh oi">Using config: /zookeeper/conf/zoo.cfg<br/>.<br/>.<br/>.<br/>020-05-13 17:18:28,564 - INFO  [main:NIOServerCnxnFactory@686] - binding to port 0.0.0.0/0.0.0.0:2181</span></pre><h2 id="ec0f" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">第二步运行卡夫卡</strong></h2><p id="5335" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">使用debezium/kafka docker映像在容器中启动Kafka。该容器将以名称<strong class="lb iu"> kafkadbz </strong>运行</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="c583" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it — name kafkadbz -p 9092:9092 --link zookeeperdbz:zookeeperdbz debezium/kafka</span></pre><p id="bf07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证Kafka服务器已启动</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/efd4d20efcd315e90c8c4940f5ae3037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eJp-xSvJ2cZs_aNdrO_hxg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卡夫卡开始了</p></figure><h2 id="1c04" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">第三步运行MySQL </strong></h2><p id="eb88" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在这个演示中，我将使用一个预配置的Docker映像，它也包含Debezium提供的样本数据。</p><p id="c28f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用debezium/example-mysql image在容器中启动MySQL。容器将以名称<strong class="lb iu"> mysqldbz </strong>运行</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="1e30" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it -d --name mysqldbz -p 3306:3306 -e MYSQL_ROOT_PASSWORD=debezium -e MYSQL_USER=mysqluser -e MYSQL_PASSWORD=mysqlpw debezium/example-mysql</span></pre><p id="0344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的命令将创建一个名为<em class="nw"> mysqldbz </em>的容器。</p><p id="7193" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们执行容器，并在容器上输入交互式bash shell。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="862b" class="mq ly it ob b gy of og l oh oi">&gt; docker exec -it mysqldbz /bin/bash</span></pre><p id="4875" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在MySQL上使用capture CDC，Debezium需要在我们的MySQL中启用bin_log配置。多亏了Debezium，因为我们使用的是预配置的MySQL Docker映像，所以我们不再需要配置它了。让我们检查一下配置。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="5713" class="mq ly it ob b gy of og l oh oi"># more /etc/mysql/conf.d/mysql.cnf</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/3667bcf2672e12356a199a59230e1d0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*goY3FGQc1TqzSwgrjm9XiQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MySQL bin_log已启用</p></figure><p id="7e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，bin_log是启用的，默认情况下是禁用的。</p><p id="ebda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查样本数据库</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="197b" class="mq ly it ob b gy of og l oh oi"># mysql -u root -p <br/>Enter password: &lt;enter your password&gt;</span><span id="d993" class="mq ly it ob b gy om og l oh oi">mysql&gt; use inventory<br/>Database changed</span><span id="7dce" class="mq ly it ob b gy om og l oh oi">mysql&gt; show tables;<br/>+---------------------+<br/>| Tables_in_inventory |<br/>+---------------------+<br/>| addresses           |<br/>| customers           |<br/>| geom                |<br/>| orders              |<br/>| products            |<br/>| products_on_hand    |<br/>+---------------------+</span><span id="5cf1" class="mq ly it ob b gy om og l oh oi">6 rows in set (0.00 sec)</span><span id="dffc" class="mq ly it ob b gy om og l oh oi">mysql&gt; select * from customers;</span><span id="a6b4" class="mq ly it ob b gy om og l oh oi">+------+------------+-----------+-----------------------+<br/>| id   | first_name | last_name | email                 |<br/>+------+------------+-----------+-----------------------+<br/>| 1001 | Sally      | Thomas    | sally.thomas@acme.com |<br/>| 1002 | George     | Bailey    | gbailey@foobar.com    |<br/>| 1003 | Edward     | Walker    | ed@walker.com         |<br/>| 1004 | Anne       | Kretchmar | annek@noanswer.org    |<br/>+------+------------+-----------+-----------------------+</span><span id="e73b" class="mq ly it ob b gy om og l oh oi">4 rows in set (0.00 sec)</span></pre><h2 id="99ca" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">步骤4启动弹性搜索服务</strong></h2><p id="facb" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">这里我们将使用单节点弹性和弹性版本7.7。容器将以名称<strong class="lb iu"> elasticdbz </strong>运行。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="8a07" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it --name elasticdbz -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:7.7.0 </span></pre><h2 id="615c" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">步骤5启动Debezium Kafka连接服务</strong></h2><p id="488d" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">该服务公开REST API来管理Debezium MySQL连接器。容器将以名称<strong class="lb iu"> connectdbz </strong>运行。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="e1d7" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it --name connectdbz -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses <strong class="ob iu">--link zookeeperdbz:zookeeperdbz --link kafkadbz:kafkadbz --link mysqldbz:mysqldbz --link elasticdbz:elasticdbz</strong> debezium/connect</span></pre><p id="dcb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要忘记将该容器与kafkadbz <strong class="lb iu">、</strong> zookeeperdbz、elasticdbz链接，因为该服务需要与kafkadbz <strong class="lb iu">、</strong> zookeeperdbz、elasticdbz服务进行通信。</p><p id="ab93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用CURL检查Debezium Kafka Connect服务的状态，从响应中我们会看到我们使用的是2.4.0版本</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="10c1" class="mq ly it ob b gy of og l oh oi">&gt; curl -H "Accept:application/json" localhost:8083/<br/>{"version":"2.4.0","commit":"77a89fcf8d7fa018","kafka_cluster_id":"XcbUOTN_TNG4hCftkY_j3w"}</span></pre><p id="f5b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们注册MySQL连接器来监视库存数据库中的CDC</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="2f23" class="mq ly it ob b gy of og l oh oi">&gt; curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" localhost:8083/connectors/ -d '<br/>{<br/>"name": "inventory-connector",<br/>"config": {<br/>"connector.class": "io.debezium.connector.mysql.MySqlConnector",<br/>"tasks.max": "1",<br/>"database.hostname": "<strong class="ob iu">mysqldbz</strong>",<br/>"database.port": "3306",<br/>"database.user": "debezium",<br/>"database.password": "dbz",<br/>"database.server.id": "184054",<br/>"database.server.name": "dbserver1",<br/>"database.whitelist": "inventory",<br/>"database.history.kafka.bootstrap.servers": "kafkadbz:9092",<br/>"database.history.kafka.topic": "schema-changes.inventory"<br/>}<br/>}'</span></pre><p id="0c86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证连接器是否在连接器列表中注册</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="8bb8" class="mq ly it ob b gy of og l oh oi">&gt; curl -H "Accept:application/json" localhost:8083/connectors/<br/>["inventory-connector"]</span></pre><p id="c12b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，inventory-connector已注册到连接器列表中</p><h2 id="561b" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">步骤6启动Kafka控制台消费者观察数据库上的变化</strong></h2><blockquote class="nt nu nv"><p id="48cd" class="kz la nw lb b lc ld ju le lf lg jx lh nx lj lk ll ny ln lo lp nz lr ls lt lu im bi translated">这一步只是为了观察数据库上的变化，如果你想消费主题，你必须写你的卡夫卡消费</p></blockquote><p id="0e6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署Debezium MySQL连接器后，它开始监控<code class="fe oj ok ol ob b">inventory</code>数据库的数据变更事件。</p><p id="a07f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要观看<code class="fe oj ok ol ob b">dbserver1.inventory.customers</code>主题，我们需要启动Kafka控制台消费者。容器将以名称<strong class="lb iu"> watcher </strong>运行。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="1bb7" class="mq ly it ob b gy of og l oh oi">&gt; docker run -it --rm --name watcher --link zookeeperdbz:zookeeperdbz --link kafkadbz:kafkadbz debezium/kafka watch-topic -a -k dbserver1.inventory.customers</span></pre><p id="3245" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行观察器后，我们可以看到Debezium开始监控库存数据库，并将结果作为<code class="fe oj ok ol ob b">dbserver1.inventory.customers</code>主题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/754467cd3f67b9b14e7edabc762d641d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nwV4YebTOSVeOJlkQEi_Iw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Debezium启动监视器</p></figure><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="b0db" class="mq ly it ob b gy of og l oh oi">"payload":{</span><span id="97c3" class="mq ly it ob b gy om og l oh oi">"before":null,<br/>      "after":{</span><span id="46ac" class="mq ly it ob b gy om og l oh oi">"id":1004,<br/>         "first_name":"Anne",<br/>         "last_name":"Kretchmar",<br/>         "email":"annek@noanswer.org"<br/>},<br/>      "source":{</span><span id="7b28" class="mq ly it ob b gy om og l oh oi">"version":"1.1.1.Final",<br/>         "connector":"mysql",<br/>         "name":"dbserver1",<br/>         "ts_ms":0,<br/>         "snapshot":"true",<br/>         "db":"inventory",<br/>         "table":"customers",<br/>         "server_id":0,<br/>         "gtid":null,<br/>         "file":"mysql-bin.000003",<br/>         "pos":154,<br/>         "row":0,<br/>         "thread":null,<br/>         "query":null<br/>},<br/>      "op":"c",<br/>      "ts_ms":1589504913171,<br/>      "transaction":null</span><span id="ebcd" class="mq ly it ob b gy om og l oh oi">}</span></pre><p id="05a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们与表库存进行比较。客户</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="61af" class="mq ly it ob b gy of og l oh oi">mysql&gt; select * from customers;</span><span id="caaf" class="mq ly it ob b gy om og l oh oi">+------+------------+-----------+-----------------------+<br/>| id   | first_name | last_name | email                 |<br/>+------+------------+-----------+-----------------------+<br/>| 1001 | Sally      | Thomas    | sally.thomas@acme.com |<br/>| 1002 | George     | Bailey    | gbailey@foobar.com    |<br/>| 1003 | Edward     | Walker    | ed@walker.com         |<br/>| <strong class="ob iu">1004 | Anne       | Kretchmar | annek@noanswer.org   </strong> |<br/>+------+------------+-----------+-----------------------+</span></pre><p id="03f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它看起来像是Kafka主题中与客户库存表中的记录相匹配的最后一个事件</p><p id="cfcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们尝试更新客户表。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="7cbd" class="mq ly it ob b gy of og l oh oi">mysql &gt; UPDATE `inventory`.`customers` SET `last_name` = 'Kretchmar Kretchmer' WHERE `id` = 1004;</span></pre><p id="1bcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是观察器中的结果</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="c36f" class="mq ly it ob b gy of og l oh oi">...<br/>"payload":{<br/>"before":{<br/>         "id":1004,<br/>         "first_name":"Anne",<br/>         "last_name":"Kretchmar",<br/>         "email":"annek@noanswer.org"<br/>},<br/>      "after":{<br/>         "id":1004,<br/>         "first_name":"Anne",<br/>         "last_name":"Kretchmar Kretchmer",<br/>         "email":"annek@noanswer.org"<br/>},<br/>...</span></pre><h2 id="fa8a" class="mq ly it bd lz mr ms dn md mt mu dp mh li mv mw mj lm mx my ml lq mz na mn nb bi translated"><strong class="ak">到这一步我们刚刚取得了什么？</strong></h2><p id="5288" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">至此，我们已经实现了MySQL-Debezium-Kafka的集成。当MySQL中有新的或更改的数据时，我们将从Kafka的主题中获得流式数据。</p><p id="2678" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是什么？</p><h1 id="36d8" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">让我们开始与ElasticSearch整合</h1><p id="00d8" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">为了与Elastic Search集成，我们需要在Debezium Kafka connect容器上安装Kafka Connect Elastic Sink连接器。</p><p id="5623" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤7下载Kafka Connect弹性汇连接器</strong><a class="ae ky" href="https://www.confluent.io/hub/confluentinc/kafka-connect-elasticsearch" rel="noopener ugc nofollow" target="_blank">https://www . confluent . io/hub/confluent Inc/Kafka-Connect-Elastic search</a></p><p id="a730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤8提取下载的zip文件</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/0ebd76dd6bc94491cc76a8d9760d5b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-qsaF5TkVnXmg2iCEOWJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">解压缩的zip文件</p></figure><p id="6740" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第九步将lib文件夹重命名为kafka-connect-jdbc </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/bcbba093ac32c7589c5043668c0cdbc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fF9Z9BIvyL_R0m4hFQJAAw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">重命名为kafka-connect-jdbc后的lib文件夹</p></figure><p id="05f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤10将kafka-connect-jdbc复制到kafka-connect的容器debezium中</strong></p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="d15a" class="mq ly it ob b gy of og l oh oi">&gt; docker cp /<strong class="ob iu">path-to-file</strong>/confluentinc-kafka-connect-elasticsearch-5.5.0/kafka-connect-jdbc/* connectdbz:/kafka/connect/</span></pre><p id="7db1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤11验证所有依赖关系都已复制</strong></p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="0892" class="mq ly it ob b gy of og l oh oi">&gt; docker exec -it connectdbz /bin/bash<br/>$ cd connect/kafka-connect-jdbc/<br/>$ ls -all</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/13b415f82b1e56bab40bdd6f4698dfd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hku54xKj0bnjlCpCw8dlUQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ls-所有结果</p></figure><p id="0eb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤12重启Debezium Kafka连接容器</strong></p><p id="8d10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要重新启动Kafka connect服务，使Kafka connect可以检测新安装的连接器插件</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="f16d" class="mq ly it ob b gy of og l oh oi">&gt; docker stop connectdbz<br/>&gt; docker start connectdbz</span></pre><p id="a7b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤13注册ElasticsearchSinkConnector </strong></p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="fde3" class="mq ly it ob b gy of og l oh oi">&gt; curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" localhost:8083/connectors/ -d '<br/>{<br/>"name": "elastic-sink",<br/>"config": {<br/>"connector.class":<br/>"io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",<br/>"tasks.max": "1",<br/>"topics": "<strong class="ob iu">dbserver1.inventory.customers</strong>",<br/>"connection.url": "http://<strong class="ob iu">elasticdbz</strong>:9200",<br/>"transforms": "unwrap,key",<br/>"transforms.unwrap.type": "io.debezium.transforms.UnwrapFromEnvelope",<br/>"transforms.key.type": "org.apache.kafka.connect.transforms.ExtractField$Key",<br/>"transforms.key.field": "id",<br/>"key.ignore": "false",<br/>"type.name": "customer"<br/>}<br/>}'</span></pre><p id="f671" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证ElasticsearchSinkConnector连接器是否已在连接器列表中注册</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="9843" class="mq ly it ob b gy of og l oh oi">&gt; curl -H "Accept:application/json" localhost:8083/connectors/<br/>["elastic-sink","inventory-connector"]</span></pre><p id="8f2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">步骤14检查MySQL ElasticSearch同步</strong></p><p id="9575" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们检查数据库和搜索服务器是否同步。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="dcd0" class="mq ly it ob b gy of og l oh oi">&gt; curl ‘<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/</a>dbserver1.inventory.customers<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">/_search?pretty</a>'</span><span id="a850" class="mq ly it ob b gy om og l oh oi">{<br/>  "took" : 12,<br/>  "timed_out" : false,<br/>  "_shards" : {<br/>    "total" : 1,<br/>    "successful" : 1,<br/>    "skipped" : 0,<br/>    "failed" : 0<br/>  },<br/>  "hits" : {<br/>    "total" : {<br/>      "value" : 4,<br/>      "relation" : "eq"<br/>    },<br/>    "max_score" : 1.0,<br/>    "hits" : [<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1001",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1001,<br/>          "first_name" : "Sally",<br/>          "last_name" : "Thomas",<br/>          "email" : "sally.thomas@acme.com"<br/>        }<br/>      },<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1004",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1004,<br/>          "first_name" : "Anne",<br/>          "last_name" : "Kretchmar Kretchme",<br/>          "email" : "annek@noanswer.org"<br/>        }<br/>      },<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1002",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1002,<br/>          "first_name" : "George",<br/>          "last_name" : "Bailey",<br/>          "email" : "gbailey@foobar.com"<br/>        }<br/>      },<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1003",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1003,<br/>          "first_name" : "Edward",<br/>          "last_name" : "Walker",<br/>          "email" : "ed@walker.com"<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="492b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，现在MySQL中的所有数据都是同步的。MySQL中的所有数据都可以在上面的弹性索引中找到。</p><p id="66b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们将新数据插入到Customers表中，看看弹性索引中会发生什么。</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="508d" class="mq ly it ob b gy of og l oh oi">mysql&gt; insert into customers values(default, 'Rizqi', 'Nugrohon', 'rizqi.nugroho@example.com');<br/>Query OK, 1 row affected (0.05 sec)</span><span id="1e80" class="mq ly it ob b gy om og l oh oi">mysql&gt; select * from customers;<br/>+------+------------+--------------------+------------------------+| id   | first_name | last_name          | email                     |+------+------------+--------------------+-----------------------+|</span><span id="0f4e" class="mq ly it ob b gy om og l oh oi">| 1001 | Sally      | Thomas             | sally.thomas@acme.com  |<br/>| 1002 | George     | Bailey             | gbailey@foobar.com     |<br/>| 1003 | Edward     | Walker             | ed@walker.com          |<br/>| 1004 | Anne       | Kretchmar Kretchme | annek@noanswer.org     |<br/>| 1005 | Rizqi      | Nugrohon           | rizqi.nugroho@example.com |+------+------------+--------------------+---------------------------+</span></pre><p id="eece" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查弹性指数</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="91c9" class="mq ly it ob b gy of og l oh oi">&gt; curl ‘<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/</a>dbserver1.inventory.customers<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">/_search?pretty</a>'</span><span id="14b1" class="mq ly it ob b gy om og l oh oi">{<br/>  "took" : 1476,<br/>  "timed_out" : false,<br/>  "_shards" : {<br/>    "total" : 1,<br/>    "successful" : 1,<br/>    "skipped" : 0,<br/>    "failed" : 0<br/>  },<br/>  "hits" : {<br/>    "total" : {<br/>      "value" : 5,<br/>      "relation" : "eq"<br/>    },<br/>    "max_score" : 1.0,<br/>    "hits" : [<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1001",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1001,<br/>          "first_name" : "Sally",<br/>          "last_name" : "Thomas",<br/>          "email" : "sally.thomas@acme.com"<br/>        }<br/>      },<br/>      ...<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1005",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1005,<br/>          "first_name" : "Rizqi",<br/>          "last_name" : "Nugrohon",<br/>          "email" : "rizqi.nugroho@example.com"<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="2309" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">插入带有名字Rizqi的Viola新数据</p><p id="1519" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新语句怎么样</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="2949" class="mq ly it ob b gy of og l oh oi">mysql&gt; UPDATE `inventory`.`customers` SET `last_name` = 'Adhi Nugroho' WHERE `id` = 1005;<br/>Query OK, 1 row affected (0.05 sec)</span><span id="175f" class="mq ly it ob b gy om og l oh oi">mysql&gt; select * from customers;<br/>+------+------------+--------------------+------------------------+| id   | first_name | last_name          | email                     |+------+------------+--------------------+-----------------------+|</span><span id="f6a6" class="mq ly it ob b gy om og l oh oi">| 1001 | Sally      | Thomas             | sally.thomas@acme.com  |<br/>| 1002 | George     | Bailey             | gbailey@foobar.com     |<br/>| 1003 | Edward     | Walker             | ed@walker.com          |<br/>| 1004 | Anne       | Kretchmar Kretchme | annek@noanswer.org     |<br/>| 1005 | Rizqi      | Adhi Nugroho           | rizqi.nugroho@example.com |+------+------------+--------------------+---------------------------+</span></pre><p id="8217" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次检查弹性指数</p><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="e6cd" class="mq ly it ob b gy of og l oh oi">&gt; curl ‘<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/</a>dbserver1.inventory.customers<a class="ae ky" href="http://localhost:9200/customers/_search?pretty" rel="noopener ugc nofollow" target="_blank">/_search?pretty</a>'</span><span id="edd9" class="mq ly it ob b gy om og l oh oi">...<br/>      {<br/>        "_index" : "dbserver1.inventory.customers",<br/>        "_type" : "customer",<br/>        "_id" : "1005",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "id" : 1005,<br/>          "first_name" : "Rizqi",<br/>          "last_name" : "Adhi Nugroho",<br/>          "email" : "rizqi.nugroho@example.com"<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="dbaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">妈妈咪呀，数据更新！！！</p><h1 id="4334" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">摘要</h1><p id="b552" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">感谢我的师父<a class="lv lw ep" href="https://medium.com/u/92236fea730d?source=post_page-----b93821d4997b--------------------------------" rel="noopener" target="_blank">Erfin Feluzy</a>article<a class="ae ky" href="https://medium.com/@erfin.feluzy/tutorial-streaming-cdc-mysql-ke-kafka-dengan-debezium-3a1ec9150cf8" rel="noopener">https://medium . com/@ Erfin . Feluzy/tutorial-streaming-CDC-MySQL-ke-Kafka-dengan-debezium-3a1ec 9150 cf 8</a>写的文章启发了我创作这篇文章。</p><p id="9ac8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们使用Debezium实现了MySQL和ElasticSearch的集成。我希望这个演示可以帮助您解决MySQL DB和ElasticSearch之间的数据延迟问题。现在MySQL DB中的所有改变都会立即影响到弹性索引。可以试着用另一个DB比如PostgreSQL，Oracle，DB2，MSSQL等。</p><p id="1223" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">参考:</p><p id="434b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">https://medium . com/@ erfin . feluzy/tutorial-streaming-CDC-MySQL-ke-Kafka-dengan-debezium-3a1ec 9150 cf 8</p><p id="15e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://debezium.io/documentation/reference/1.1/tutorial.html" rel="noopener ugc nofollow" target="_blank">https://debezium . io/documentation/reference/1.1/tutorial . html</a></p><p id="abb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://docs.confluent.io/current/connect/kafka-connect-elasticsearch/index.html" rel="noopener ugc nofollow" target="_blank">https://docs . confluent . io/current/connect/Kafka-connect-elastic search/index . html</a></p></div></div>    
</body>
</html>