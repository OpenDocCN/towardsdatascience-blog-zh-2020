<html>
<head>
<title>Pivot Tables and Operations Using Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用熊猫的数据透视表和操作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pivot-tables-and-operations-using-pandas-471646b99cb5?source=collection_archive---------49-----------------------#2020-05-31">https://towardsdatascience.com/pivot-tables-and-operations-using-pandas-471646b99cb5?source=collection_archive---------49-----------------------#2020-05-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/0b600f47eaf9222b41599ee1b087f581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*unoKN8DG4nyZXW7-8aAz-A.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="jg jh ep" href="https://medium.com/u/2053395ac335?source=post_page-----471646b99cb5--------------------------------" rel="noopener" target="_blank"> Unsplash </a></p></figure><div class=""/><div class=""><h2 id="0524" class="pw-subtitle-paragraph kh jj jk bd b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dk translated">数据透视表对于分析来说是不够的，对数据透视表的操作才是关键</h2></div></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="509c" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将学习如何有效地创建数据透视表并执行所需的分析。我们将用一个著名的汽车数据集来做这件事，这个数据集来自加州大学欧文分校。您可以通过以下链接找到数据集。建议您也阅读一些关于数据集的内容。我使用这个数据集作为我参加的数据分析在线课程的一部分。</p><p id="2f20" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><a class="ae mc" href="https://archive.ics.uci.edu/ml/machine-learning-databases/autos/imports-85.data" rel="noopener ugc nofollow" target="_blank">https://archive . ics . UCI . edu/ml/machine-learning-databases/autos/imports-85 . data</a></p><p id="1085" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">因此，让我们先获取库，加载我们的数据，并浏览一下数据。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="1bb0" class="mm mn jk mi b gy mo mp l mq mr">import pandas as pd<br/>import numpy as np</span><span id="aefd" class="mm mn jk mi b gy ms mp l mq mr">path = "Downloads/imports-85.data"<br/>df = pd.read_csv(path, header=None)</span></pre><p id="5f06" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们现在看数据，你什么都不能理解。不过，还是让我们来看一看吧。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="4b64" class="mm mn jk mi b gy mo mp l mq mr">df.head()</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mt"><img src="../Images/e4b10ba73981216eaeb5bea0a3d265f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o5BRmeQIcpUO1t_Q69UO4A.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">初始数据集</p></figure><p id="fe02" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">数据看起来像这样。首先，让我们给数据一些好的标题。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b9b3" class="mm mn jk mi b gy mo mp l mq mr">headers = ["symboling","normalized-losses","make","fuel-type","aspiration", "num-of-doors","body-style",<br/>         "drive-wheels","engine-location","wheel-base", "length","width","height","curb-weight","engine-type",<br/>         "num-of-cylinders", "engine-size","fuel-system","bore","stroke","compression-ratio","horsepower",<br/>         "peak-rpm","city-mpg","highway-mpg","price"]</span><span id="6c4e" class="mm mn jk mi b gy ms mp l mq mr">df.columns = headers</span></pre><p id="c2b2" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">所以现在数据看起来像这样。</p><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/4db1a729d127847efc5a4a06beafaec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5DhzjgiiCAQ6PJ1O7h0gg.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">带标题的数据</p></figure><h1 id="b5e2" class="mv mn jk bd mw mx my mz na nb nc nd ne kq nf kr ng kt nh ku ni kw nj kx nk nl bi translated">数据清理</h1><p id="e42f" class="pw-post-body-paragraph lg lh jk li b lj nm kl ll lm nn ko lo lp no lr ls lt np lv lw lx nq lz ma mb im bi translated">您需要执行一些数据清理步骤。但是，我不会详细谈论它们。因为我们正在讨论数据透视表，所以我假设您可能有一些关于数据清理的基础知识。为此，请使用下面的代码。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="fa9f" class="mm mn jk mi b gy mo mp l mq mr">df.replace("?", np.nan, inplace = True)</span><span id="1a8f" class="mm mn jk mi b gy ms mp l mq mr">df["normalized-losses"].replace(np.nan, df["normalized-losses"].astype("float").mean(axis=0), inplace=True)<br/>df["bore"].replace(np.nan, df['bore'].astype('float').mean(axis=0), inplace=True)<br/>df["stroke"].replace(np.nan, df['stroke'].astype('float').mean(), inplace=True)<br/>df["horsepower"].replace(np.nan, df['horsepower'].astype('float').mean(), inplace=True)<br/>df["peak-rpm"].replace(np.nan, df['peak-rpm'].astype('float').mean(), inplace=True)<br/>df[["price"]] = df[["price"]].astype("float")</span></pre><p id="dffb" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我就简单介绍一下我刚才做的事情。如果您使用<code class="fe nr ns nt mi b">df.dtypes</code>检查每一列的数据类型，您会发现有些列的数据类型不正确，这是您在使用数据透视表时根本不想要的。例如,“价格”列的数据类型为“对象”,这是没有意义的。此外，数据有空值，问号(？)更确切地说。</p><p id="0edd" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了解决这个问题，我们用NAN替换了它。然后，一些数字列的NAN值被该列的平均值所取代。</p><p id="5bd5" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，既然我们有了干净的数据，让我们创建我们的第一个数据透视表。首先，我们必须从数据帧中选择我们想要的数据。</p><h1 id="616c" class="mv mn jk bd mw mx my mz na nb nc nd ne kq nf kr ng kt nh ku ni kw nj kx nk nl bi translated">分组依据和透视表</h1><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="a33c" class="mm mn jk mi b gy mo mp l mq mr">df_selction = df[['fuel-type', 'drive-wheels', 'price']]</span></pre><p id="d3ef" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，我们将按照“燃料类型”和“驱动轮”这两列对数据进行分组。我们将使用汽车价格的平均值。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="6460" class="mm mn jk mi b gy mo mp l mq mr">df_selection_gb = df_selction.groupby(['drive-wheels', 'fuel-type'], as_index=False).mean()</span><span id="f59a" class="mm mn jk mi b gy ms mp l mq mr">df_selection_gb</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/793d8b9f418398d436373b3f983f923a.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*EIFVffo2lh5vDj6E7arrRw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">分类资料</p></figure><p id="8d62" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这可能有点难以阅读或执行任何分析。因此，我们把它转换成一个数据透视表，让我们看看我们得到了什么。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8ab7" class="mm mn jk mi b gy mo mp l mq mr">df_first_pivot = df_selection_gb.pivot(index='drive-wheels', columns='fuel-type')</span><span id="c256" class="mm mn jk mi b gy ms mp l mq mr">df_first_pivot</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/2ec0b9361d507d77b93b4e6028244b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*RL6tgm2lHXapei6OMNVX2g.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">数据透视表</p></figure><p id="e04e" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，您可能会注意到数据透视表中的一些NAN值。但这没关系，因为我们没有任何四轮驱动和柴油驱动汽车的数据。</p><h2 id="c593" class="mm mn jk bd mw nw nx dn na ny nz dp ne lp oa ob ng lt oc od ni lx oe of nk og bi translated">可能的分析</h2><p id="4d7d" class="pw-post-body-paragraph lg lh jk li b lj nm kl ll lm nn ko lo lp no lr ls lt np lv lw lx nq lz ma mb im bi translated">有了上面的数据透视表，你可以回答这样的问题—</p><ul class=""><li id="4670" class="oh oi jk li b lj lk lm ln lp oj lt ok lx ol mb om on oo op bi translated">柴油动力车前轮驱动的均价是多少？</li><li id="463c" class="oh oi jk li b lj oq lm or lp os lt ot lx ou mb om on oo op bi translated">哪种车型最贵？</li></ul><p id="83d6" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">所以你可以得到答案，因为后轮驱动的柴油动力汽车是最贵的。假设我们想回答这样的问题-</p><ul class=""><li id="2196" class="oh oi jk li b lj lk lm ln lp oj lt ok lx ol mb om on oo op bi translated">四轮驱动的燃气汽车总数？</li></ul><p id="0453" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">那么你可以用计数函数来代替均值—</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="bd12" class="mm mn jk mi b gy mo mp l mq mr">df_selection_gb_2 = df_selction.groupby(['drive-wheels', 'fuel-type'], as_index=False).count()</span><span id="cc0f" class="mm mn jk mi b gy ms mp l mq mr">df_count_pivot = df_selection_gb_2.pivot(index='drive-wheels', columns='fuel-type')</span><span id="2993" class="mm mn jk mi b gy ms mp l mq mr">df_count_pivot</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/9bf78c076fcfef55543b03667028c141.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/1*Mb-dr7A245I0B-bF08E0gQ.png"/></div></figure><p id="75c5" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，让我们继续创建另一个组并尝试分析它。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c731" class="mm mn jk mi b gy mo mp l mq mr">df_selection_2 = df[['drive-wheels','body-style','price']]</span><span id="7ba7" class="mm mn jk mi b gy ms mp l mq mr">grouped_df = df_selection_2.groupby(['drive-wheels','body-style'],as_index=False).mean()</span><span id="154c" class="mm mn jk mi b gy ms mp l mq mr">grouped_df</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/9174becf913b520d5d4e32379a73d376.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*778GgMT7_p2CXLvHH50hJw.png"/></div></figure><p id="dd10" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">正如您可以非常清楚地看到的，这种分组数据比第一种数据更难阅读和理解。因此，让我们在数据透视表中转换它，然后再试一次。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="e44e" class="mm mn jk mi b gy mo mp l mq mr">grouped_pt = grouped_df.pivot(index='drive-wheels',columns='body-style')</span><span id="b7dd" class="mm mn jk mi b gy ms mp l mq mr">grouped_pt</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/db0aad5365e2569139942ac14e48282b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*d3MIYKpknaULyjjj0Ew46Q.png"/></div></figure><p id="6a1b" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，这个更容易分析了。如果您想要在这些数据透视表上执行操作，您可以像普通的数据帧一样执行，但是在列命名上稍有不同。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="e117" class="mv mn jk bd mw mx oy mz na nb oz nd ne kq pa kr ng kt pb ku ni kw pc kx nk nl bi translated">透视操作</h1><p id="72be" class="pw-post-body-paragraph lg lh jk li b lj nm kl ll lm nn ko lo lp no lr ls lt np lv lw lx nq lz ma mb im bi translated">让我们看看数据透视表的列。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="1963" class="mm mn jk mi b gy mo mp l mq mr">grouped_pt.columns</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/6380057e843d6dd7ab1f9505c2e74e37.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*U6GCIbbbF6AjfSiPtWMMzg.png"/></div></figure><p id="1f73" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如你所见，它是多索引的。假设我们想得到轿车和旅行车车身风格的汽车的平均价格的差异。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="cc10" class="mm mn jk mi b gy mo mp l mq mr">grouped_pt[('price','sed-wag')] = (grouped_pt[('price', 'sedan')]-grouped_pt[('price', 'wagon')])</span><span id="5b9c" class="mm mn jk mi b gy ms mp l mq mr">grouped_pt</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pe"><img src="../Images/33f83d28cf6c079ca866d96ae1b30499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Ke2PyqmezgswkQZo_qBCQ.png"/></div></div></figure><p id="b13e" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">同样，如果您想要比较一段时间内的值，例如上个月和本月。你可以继续做同样的事情。您可能想要计算销售额的增长或者增长率。由于我们的数据集中没有日期列，我将向您展示一些您可能会发现的更多可能的见解。</p><p id="ed83" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">例如，我们希望根据驱动轮列得到一辆轿车的平均价格。</p><p id="6840" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为此，您可能需要删除我们刚刚创建的“sed-wag”列。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c108" class="mm mn jk mi b gy mo mp l mq mr">del(grouped_pt[('price','sed-wag')])</span></pre><p id="71ec" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在让我们用汽车的数量创建另一个枢纽。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="e885" class="mm mn jk mi b gy mo mp l mq mr">df_selection_3 = df[['drive-wheels','body-style','price']]</span><span id="d528" class="mm mn jk mi b gy ms mp l mq mr">grouped_df_2 = df_selection_3.groupby(['drive-wheels','body-style'],as_index=False).count()</span><span id="c11b" class="mm mn jk mi b gy ms mp l mq mr">grouped_count_pt = grouped_df_2.pivot(index='drive-wheels',columns='body-style')</span><span id="1194" class="mm mn jk mi b gy ms mp l mq mr">grouped_count_pt</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/c99c42691ec83a9d45833953182579d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*-OSLvvq2e3Bi3Lz07aH6Iw.png"/></div></figure><p id="2f19" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们计算一下，以数据图表的形式看看我们的结果。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9d77" class="mm mn jk mi b gy mo mp l mq mr">rate_4wd_sedan = (grouped_pt[('price', 'sedan')]) / (grouped_count_pt[('price', 'sedan')])</span><span id="cd79" class="mm mn jk mi b gy ms mp l mq mr">rate_4wd_sedan.to_frame()</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/1e36888c68d8e0b391b2679ce29f44ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*OaRexmFjg0MUII283O4xkQ.png"/></div></figure><p id="92b5" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">所以，你可以看到，根据驱动轮一栏，我们得到了轿车的平均价格。你可能会多玩一会儿，获得许多像这样有用的见解。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="e8fb" class="pw-post-body-paragraph lg lh jk li b lj lk kl ll lm ln ko lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您有任何疑问，请随时联系我们，我们随时欢迎您提出建议。我希望这篇文章是有用的。</p></div></div>    
</body>
</html>