<html>
<head>
<title>Towards Torrent Science: Data Engineering</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">走向激流科学:数据工程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/towards-torrent-science-data-engineering-d79e774886cb?source=collection_archive---------48-----------------------#2020-07-08">https://towardsdatascience.com/towards-torrent-science-data-engineering-d79e774886cb?source=collection_archive---------48-----------------------#2020-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ef5a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">激流科学</h2><div class=""/><div class=""><h2 id="e900" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">挖掘 BitTorrent 网络</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/b346c766ca805674e1cade2581514d48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uOd_ap2D3Y_luHGu"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">艾莉娜·格鲁布尼亚克在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="cdcd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi me translated">最近，我在综艺节目上偶然发现了一篇名为“网飞如何利用盗版挑选节目”的旧文章。它讲述了网飞如何挖掘 BitTorrent 网络来确定哪些程序必须被选择用于其平台。最近的一篇<a class="ae lh" href="https://torrentfreak.com/torrent-traffic-surpasses-netflix-in-europe-middle-east-and-africa-200508/" rel="noopener ugc nofollow" target="_blank">文章</a>(“Torrent 流量在欧洲、中东和非洲超过网飞”)强调，多年来 BitTorrent 流量已经逐渐下降，但其使用在欧洲、非洲和亚太地区仍然很突出。显然大量流媒体平台的兴起是 BitTorrent 流量复苏的原因(查看这篇<a class="ae lh" href="https://www.vice.com/en_nz/article/d3q45v/bittorrent-usage-increases-netflix-streaming-sites" rel="noopener ugc nofollow" target="_blank">文章</a>)。顺便说一句，必须注意的是，VPN 的广泛使用使得识别流量的来源变得困难，因此必须有保留地分析这些统计数据。</p><blockquote class="mn"><p id="5c56" class="mo mp it bd mq mr ms mt mu mv mw md dk translated">有人为了社会的更大利益而分享他们的带宽，这种想法违背了“公地热”的理论，这是令人惊讶的。</p></blockquote><p id="81c0" class="pw-post-body-paragraph li lj it lk b ll my kd ln lo mz kg lq lr na lt lu lv nb lx ly lz nc mb mc md im bi translated">BitTorrent 网络吸引我有两个主要原因。首先，从创新的角度来看，布拉姆·科恩功不可没。使用我刚刚熟悉的简单 CS 原则，在上传的同时下载和组装单个文件的想法很鼓舞人心。第二点是其运作的经济性。有人会为了社会的更大利益而分享他们的带宽，这种想法违背了公地悲剧的理论，这是令人惊讶的。</p><h2 id="3a23" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">一言以蔽之的 BitTorrent</h2><p id="e4b7" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">简单地说，它是一个对等共享协议，试图解决三个主要问题。首先，它提供了一种算法来将一个大文件分割成块，确定哪个对等体拥有哪个块，以及哪个块应该被发送到哪里，而不会产生很大的开销。第二，它试图解决一旦下载了文件，对等点就会频繁地从网络中流出的问题。最后，公平的问题，处理保持上传和下载率之间的相关性。</p><p id="6f00" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要使用 BitTorrent 网络，需要一个可以将对等点连接到网络的客户端。在网络上共享的每个文件都与包含客户端所需信息的种子文件相关联。共享完整文件的对等点称为种子，下载文件的对等点称为网络上的吸血鬼。为了网络的健康，种子设定者最好能长时间设定文件的种子。</p><p id="6a7e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">该协议的更多技术细节超出了本文的范围。查看维基百科了解更多信息。</p><h2 id="7961" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">挖掘 BitTorrent 网络</h2><p id="d781" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">BitTorrent 网络由与网络中的文件和网络中对等体的特征相关的数据组成。例如，网飞感兴趣的是确定哪些是它的消费者想要观看的受欢迎的节目。BitTorrent 是一个世界范围的网络，确定其同伴的地理位置有助于挖掘许多有趣的模式。比如一个国家的社会政治指标和观影习惯有什么关联？特定国家喜欢的音乐类型是什么？哪个国家的色情消费最高？</p><p id="23e9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">只有当我们有了一个从 BitTorrent 网络获取数据的框架时，这些问题和许多其他问题才能被探索。这是本文的重点。在这个<em class="nd">系列</em>、名为<strong class="lk jd">洪流科学</strong>的后续文章中，我将报告执行这一分析所采用的不同技术，并分享从这一调查中获得的结果。</p><h1 id="125d" class="ob nf it bd ng oc od oe nj of og oh nm ki oi kj np kl oj km ns ko ok kp nv ol bi translated">数据工程</h1><p id="7bd2" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">获取 BitTorrent 数据的过程分为两个部分。首先，抓取种子网站以找到流行的文件(大部分是盗版视频)以及与每个文件相关的对等点(种子和吸血鬼)的数量。许多流行的文件被多次上传，这就需要对文件名进行相似性匹配，并组合属于相同内容的信息。</p><p id="8454" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其次，确定每个文件的对等体的地理位置。请注意，这些信息在 torrent 网站上并不容易获得。这需要对 BitTorrent 协议的工作原理有所了解。</p><p id="9d0d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">整个过程必须定期重复，以收集时序数据。</p><h2 id="0c74" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">擦</h2><p id="fb33" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">让我们从第一部分开始。这需要抓取流行的种子网站，如海盗湾，1337x 等。本文仅关注 1337x.to。该网站定期更新按周和日分组的趋势种子列表，涵盖电视、电影、应用程序、游戏等类别。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi om"><img src="../Images/248c913b9e5ffca22558c2a023c4f67c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*58Fk9O5Z8dQF9yYQbuFM0w.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">种子网站快照:1337x.to</p></figure><p id="9745" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于每个趋势部分，例如趋势纪录片，可以提取种子的名称。查看下面的快照。对于这些种子，我们需要提取种子和水蛭的数量，上传大小，时间等。以及播种者和吸血者的地理位置。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi on"><img src="../Images/9889025b39e9087190df52cd253e23a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qetQg8lsmwm4jyhS1rYBFA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">从 1337 年到 2010 年的趋势纪录片</p></figure><p id="1790" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这相当简单。每个网站都需要一个自定义代码。以下代码片段完成了 1337x.to 的工作</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/b82bd1748c3449deb8a602f2393a687a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*R5T2aLl7RwrYxD1Rh0aLMw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">代码片段— BeautifulSoup</p></figure><p id="de4d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">欲了解更多关于使用美汤的信息，请查看本文。</p><p id="1cbf" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">以下是典型输出的示例。请注意，由于从多个来源上传相同的内容导致多个种子文件，从而出现了重复。以“阿特米斯奇幻历险”为例，它已经上传了两次(输出中的 2 和 3)，可能在文件格式和其他规范上有所不同。但是当涉及到数据挖掘和提取模式时，必须将两者视为同一个文件，因为它们对应于同一个电影。这同样适用于名为“Gulabo Sitabo”的印地语电影(输出中的 1 和 4)。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi op"><img src="../Images/b1df8151881f748a423c677f9ca74d3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*B0B7joSH0G2HkZCx8QDY8Q.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">从网站抓取数据的实例(快照)。</p></figure><p id="4b34" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下一节中，我将讨论如何高精度地找到这些副本。</p><h2 id="d046" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">检测重复项</h2><p id="0ba0" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">这个问题是关于寻找一对文本串之间的相似性。考虑一个函数，它可以返回一个度量或一个分数来表示两者之间的相似性。第一组想法可能围绕着类似 Jaccard 距离或余弦距离的相似性度量(查看这篇<a class="ae lh" rel="noopener" target="_blank" href="/overview-of-text-similarity-metrics-3397c4601f50#:~:text=Differences%20between%20Jaccard%20Similarity%20and,term%20frequency%20or%20tf%2Didf)">文章</a>)。但这实际上是一个简单得多的问题，类似史密斯-沃特曼算法的东西适合于这个目的。</p><p id="ff7c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> Smith-Waterman 算法</strong>执行局部<a class="ae lh" href="https://en.wikipedia.org/wiki/Sequence_alignment" rel="noopener ugc nofollow" target="_blank">序列比对</a>；即，用于确定两串<a class="ae lh" href="https://en.wikipedia.org/wiki/Nucleic_acid_sequence" rel="noopener ugc nofollow" target="_blank">核酸序列</a>或<a class="ae lh" href="https://en.wikipedia.org/wiki/Protein_sequence" rel="noopener ugc nofollow" target="_blank">蛋白质序列</a>之间的相似区域。史密斯-沃特曼算法不是查看<a class="ae lh" href="https://en.wikipedia.org/wiki/Needleman%E2%80%93Wunsch_algorithm" rel="noopener ugc nofollow" target="_blank">整个</a>序列，而是比较所有可能长度的片段，并且<a class="ae lh" href="https://en.wikipedia.org/wiki/Mathematical_optimization" rel="noopener ugc nofollow" target="_blank">优化</a>的<a class="ae lh" href="https://en.wikipedia.org/wiki/Similarity_measure" rel="noopener ugc nofollow" target="_blank">相似性度量</a>。”——维基百科上说的。</p><p id="3cd0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> swalign </strong>是一个 python 包，它实现了这种在幕后使用动态编程的算法。查看下面的代码片段，它展示了运行中的算法。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/fdf9b4e1e7be757e36ba58b439c811cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*2hkj03bYrmT_TcMxKavLVw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">用于检测相同种子内容的代码片段</p></figure><p id="bbae" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">匹配和不匹配值可以改变，以适应当前的应用。通常的值是 2 和-1，这对我们的目的来说也很好。可以看出，当比较 name1 和 name2 时，得分为<strong class="lk jd"> <em class="nd"> 14 </em> </strong>，而 name1 和 name3，属于同一部名为 Gulabo Sitabo 的宝莱坞电影，得分为<strong class="lk jd"> <em class="nd"> 88 </em> </strong>。</p><p id="a9ef" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意，对于同名但不同集或季的电视节目，这种相似性度量将失效。尽管这将取决于一个人希望做什么样的分析。如果有人希望比较一部电视连续剧不同季节或不同集的受欢迎程度，这可能行不通。但是，如果人们希望在电视节目之间进行广泛的比较，那么这仍然是可行的。</p><p id="3929" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过考虑这样的启发，即只有字符串的开头部分与名称相关，而后面部分只是元数据，并删除点、空格和连字符，我们可以获得更准确的分数。这是使用下面的代码片段实现的。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi or"><img src="../Images/34b70cd0cff2bf6cfd6ebaad21292ec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JsiyioG31A7Wg36V-xfD2A.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">代码片段:清理</p></figure><h2 id="2c4a" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">提取对等地理位置</h2><p id="2a47" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">这是一个有趣的部分，因为它需要对 BitTorrent 协议的工作原理有更深入的理解。如前所述，为了使用 BitTorrent 下载文件，需要一个客户端，如洪水。向客户端提供关于所需数据的信息，这是找到拥有需要下载的文件的对等体列表所必需的。该信息以指向存储对等体列表的追踪器网站的指针的形式可用。</p><p id="adfd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过使用分布式哈希表，也可以在没有跟踪器的情况下执行上述任务。这在追踪器网站被来自对等点的请求过载时更有用，因为客户端需要定期刷新对等点列表。在这种情况下，每个节点都维护一个独立的路由表，当该节点与网络中的其他节点通信时，该路由表会更新。注意，即使对于无<em class="nd">跟踪器的</em>种子，至少需要一个节点来引导到网络中。</p><p id="ea39" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果这一切都令人困惑，或者你打算了解更多，检查下面的视频。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="199d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们看一下完成这项工作的代码片段。我使用了 BitTorrent DHT 的 python 实现(<a class="ae lh" href="https://github.com/nitmir/btdht" rel="noopener ugc nofollow" target="_blank"> Github </a>链接)——<strong class="lk jd">Bt DHT。</strong></p><p id="a8a8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们尝试识别正在下载流行的开源图像编辑软件 GIMP 的同行的地理位置。这将需要从网站 1337x.to 获取的<em class="nd"> infohash </em>，如下图所示。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/70a0c2b2085b29816d284ef0840ab454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JfwrV3AuW-T-vBmBO3X_Cw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">从 1337x.to 获得 GIMP 图像编辑器的 Infohash</p></figure><p id="267a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下面的代码使用<strong class="lk jd"> dtdht </strong>包从网络中提取对等体列表。输出显示了网络中当前与该种子相关联的对等体的 IP 地址列表。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ov"><img src="../Images/f896d555ebe92470caa8ca610869d02f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUDjCies1RYoXTwMVdcO7A.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">提取对等 IP 列表的代码片段</p></figure><p id="f871" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一旦获得 IP 列表，我们就可以使用 geoIP2 数据库来确定地理位置。当你安装<a class="ae lh" href="https://github.com/rr2do2/maxminddb-geolite2" rel="noopener ugc nofollow" target="_blank">包</a>，<strong class="lk jd"> maxminddb-geolite2 时，这实际上非常简单。</strong></p><p id="ed16" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">查看下面的代码片段，其中显示了上面显示的 IP 地址所属的国家。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ow"><img src="../Images/e15bbb448c1934de33fdd42520193909.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zcvpvDOav8FIpCG9GPXiRQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Gimp torrent 的对等机所在的国家。</p></figure><p id="8187" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">显然，GIMP 正在被全世界下载，列表中有 145 个对等点。美国有 29 名同行，紧随其后的俄罗斯有 24 名同行。</p><p id="7d99" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下图显示了该特定软件在各个国家的同行频率。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/6737b7ac752c18d04d843d1e1bebfe5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*4yxXjsMB2yLRul81D_QTIg.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">每个国家的同行数量</p></figure><h2 id="3537" class="ne nf it bd ng nh ni dn nj nk nl dp nm lr nn no np lv nq nr ns lz nt nu nv iz bi translated">接下来呢？</h2><p id="5fa4" class="pw-post-body-paragraph li lj it lk b ll nw kd ln lo nx kg lq lr ny lt lu lv nz lx ly lz oa mb mc md im bi translated">我目前运行了一个 cronjob，每 6 小时从 torrent 网站收集一次数据。在接下来的几周/几个月里，我将收集足够的数据来尝试数据挖掘算法，并寻找模式和关系。</p></div></div>    
</body>
</html>