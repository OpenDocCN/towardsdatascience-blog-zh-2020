<html>
<head>
<title>Scraping Coronavirus Death Demographics with Beautiful Soup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用美汤刮去冠状病毒死亡人口统计</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/scraping-coronavirus-death-demographics-with-beautiful-soup-9df7488fe84c?source=collection_archive---------41-----------------------#2020-04-17">https://towardsdatascience.com/scraping-coronavirus-death-demographics-with-beautiful-soup-9df7488fe84c?source=collection_archive---------41-----------------------#2020-04-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0e2d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">网页抓取教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/738d43df6266b98575aaabdf92930c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7s8YeR-zhpm1de3baz6S-Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·斯皮斯克在<a class="ae ky" href="https://unsplash.com/s/photos/scraping-web?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="3d2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着冠状病毒在全球蔓延，详细的数据对于人们了解这种病毒变得至关重要。许多优秀的数据源已经发布了可供研究使用的数据(本文中的<a class="ae ky" rel="noopener" target="_blank" href="/a-short-review-of-covid-19-data-sources-ba7f7aa1c342">综述，以及本文</a>中的<a class="ae ky" rel="noopener" target="_blank" href="/covid-19-gis-resource-summary-debcba2a000b">中与GIS相关的综述)。但是，大部分数据来源集中在不同地点的确诊/死亡/康复计数和检测计数。如果您想要其他信息，例如性别和年龄等死亡人口统计信息，该怎么办？</a></p><p id="40b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将浏览<a class="ae ky" href="https://www.dph.illinois.gov/news/202004" rel="noopener ugc nofollow" target="_blank">伊利诺伊州卫生部每日新闻</a>网页，使用Python和Beautiful Soup library获取冠状病毒死亡人口统计数据。</p><h1 id="c646" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.调查网页的逻辑结构</h1><p id="d184" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">首先，我们知道伊利诺伊州卫生部(IDPH)有每日简报，其中包含死亡人口统计数据。让我们以2020年4月为例，访问以下网页</p><blockquote class="ms mt mu"><p id="bb5d" class="kz la mv lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><a class="ae ky" href="https://www.dph.illinois.gov/news/202004" rel="noopener ugc nofollow" target="_blank">https://www.dph.illinois.gov/news/202004</a></p></blockquote><p id="6992" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快速浏览可以发现以下信息:</p><ul class=""><li id="136a" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">该网址以<yyyymm>的格式按年月组织。</yyyymm></li><li id="0455" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">这个网页包含每月的所有每日报告，最新的报告在最上面。每条每日新闻都可以用相应的日期串来标识，格式为<ddmmyyyy>。</ddmmyyyy></li><li id="d72a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">每日新闻只有一个部分显示在这个网页上。完整的每日报告实际上在右下角的“阅读更多”链接中。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/4d54d6ea8e5c84e3a215c9275adc2d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3QBtr1_5tIHMoGX_5VaR_A.png"/></div></div></figure><h1 id="6d77" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.准备汤品</h1><p id="a22d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">因为我们知道HTTP地址，所以我们可以很容易地用漂亮的soup构造一个Soup对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="c23d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.查找相关信息</h1><h2 id="c943" class="nq lw it bd lx nr ns dn mb nt nu dp mf li nv nw mh lm nx ny mj lq nz oa ml ob bi translated">3.1确定切入点</h2><p id="569c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">大多数现代网络浏览器都提供了查看网页源代码的基本工具。以Chrome为例，可以使用<f12>键调出侧面的DevTools控制台，如下图:</f12></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/3b2b96482e6a86f2372c43439b9f2681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGe_5tHVSd7xw47l2l1gBw.png"/></div></div></figure><p id="131f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">乍一看，右边的内容让人望而生畏，尤其是对于不熟悉HTML的人来说。怎么才能在这一大堆乱七八糟的东西中找到相关的信息呢？</p><p id="8512" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好消息是，在大多数情况下，我们不必知道网页的完整结构。例如，由于在步骤#1中我们已经确定日期字符串指定了新闻的位置，我们可以使用Ctrl-F搜索日期字符串“15th Apr ”,以快速定位感兴趣的部分:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/9ba2e526a5fb83041a4007621ab62455.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*xyILB20ApfK4fW0BgAE5pg.png"/></div></figure><p id="1d57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您将鼠标悬停在“4月15日”上，左侧网页上的相应部分将会高亮显示。这确认了代码位置。</p><p id="3c9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在确认了逻辑位置之后，我们可以使用<code class="fe oe of og oh b">find_all</code>函数在soup对象中复制它，以找到所有的<strong class="lb iu"> div </strong>，并使用其<strong class="lb iu"> span </strong>具有正确字符串的那个。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="ed2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行上面的代码后，我们可以打印target_elm来确认它是否是包含“2020年4月15日”的元素:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/f2e896cec94417edf036d6ff621c96db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yPVep0xLAh_szKbWTmF1kQ.png"/></div></div></figure><h2 id="9086" class="nq lw it bd lx nr ns dn mb nt nu dp mf li nv nw mh lm nx ny mj lq nz oa ml ob bi translated">3.2找到从入口点到兴趣点的相对路径</h2><p id="a081" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">正如我们在#1中讨论的，详细的每日报告实际上在另一个位置，在“阅读更多”链接下。我们可以使用相同的技巧找到相对路径，即在DevTools控制台中搜索“Read more ”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/608860ef0b36787e066db6325ddc2898.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*Ho3LMkwshDhcIE8j-sUWmA.png"/></div></figure><p id="d0e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">方便的是，包含“Read more”链接的元素和包含“15th Apr”字符串的元素属于同一个<code class="fe oe of og oh b">parent</code>。因此，我们可以使用soup元素的<code class="fe oe of og oh b">parent</code>属性来导航结构，然后使用<code class="fe oe of og oh b">.a.get('href')</code>来获得超链接。</p><p id="8d4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在获得日期的详细报告的超链接之后，我们可以请求新的网页，并相应地创建新的soup对象:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="e0a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以打开实际的每日报告页面，并使用相同的技巧，搜索“Cook County”来定位代码的相关部分。正如我们所看到的，详细的分解是在一个无序列表中(<ul> </ul>标签)，在一个<strong class="lb iu"> div </strong>类“field-item even”下。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/df950815366add5f2814baf502826b93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SQwPEoj_6Zv_8krI80GnbA.png"/></div></div></figure><h1 id="1641" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">4.提取信息</h1><p id="626a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">找到列表后，我们可以通过使用<code class="fe oe of og oh b">find_all</code>函数搜索&lt; li &gt;标签来迭代列表，然后使用<code class="fe oe of og oh b">.text</code>属性获取相应的文本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="61d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们得到诸如“1男30”这样的字符串，我们就可以从字符串中提取计数/性别/年龄信息。然后我们可以将它们放入熊猫数据框中进行进一步分析。</p><p id="5512" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面代码中的核心分析是我们必须实现的<code class="fe oe of og oh b">extract()</code>函数。基本思想很简单——我们可以将字符串分成三个子字符串，然后相应地提取计数、性别和年龄。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="9af3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，现实要复杂得多，也容易出错，就像任何网页抓取一样。因为新闻文本是由人类生成的，尽管格式相对稳定，但仍有许多细微差别可能会发生变化。仅举几个例子:</p><ul class=""><li id="14b1" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">在2020年3月22日之前，死亡人口统计日报的格式不太结构化。</li><li id="991a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">有时“年龄”部分不以“s”结尾。比如“1男100+”。更糟糕的是，有时它使用“青少年”或“婴儿”这样的词来指定年龄。</li><li id="7592" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">有“未知”和“不完整”的条目。</li><li id="1382" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">有时死亡计数“1”会被忽略。</li><li id="dcf9" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi">……</li></ul><p id="c397" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">毕竟，完整的实现可以在这个<a class="ae ky" href="https://github.com/jianxu305/nCov2019_analysis" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中的<code class="fe oe of og oh b">utils.parse_IL_death_demographic()</code>中找到。作为一条支持信息，我在输出数据框中添加了新闻页面的链接，以便在必要时可以快速验证结果。最终的输出数据帧如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/7eae8ce40dc9a44e831fad88b6995795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*fQc5sJV8zY3MLrqSWZUyjg.png"/></div></figure><h1 id="b960" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">5.绘制死亡人口统计图</h1><p id="ebd3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">经过以上努力，我们从《IDPH日报》中获得了死亡人口统计数据框架。这样网页抓取就完成了。但是在宣布胜利之前检查结果总是一个好主意。Pandas <code class="fe oe of og oh b">pivot_table()</code>提供了聚集数据的灵活方式。例如，我们可以看看每日死亡人数时间序列:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/eb6bc92f89a83e97bd3f22ab1babced4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*DU6-g1TFNOMFt_1Qv5T_3w.png"/></div></figure><p id="5782" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述情节很容易被新闻来源所证实，这使我们对我们的结果有了一些信心。</p><p id="5b1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以看看死亡人口统计。按年龄和性别划分的堆积条形图是一个很好的表示。这可以通过将数据框旋转到另一个方向来轻松实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/43634f5251158ad6ce21ba7220877a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*9Bw-_vUSUirx4IEmJHV3uA.png"/></div></figure><h1 id="ece1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">最后注意:</h1><p id="e3a4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">一般来说，网页抓取并不健壮，因为网页会在你不知道的情况下改变。因此，我们总是更喜欢更健壮的API。但是当这不可用时，网络搜集可以作为另一个获取数据的途径。</p></div><div class="ab cl oo op hx oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="im in io ip iq"><h1 id="f945" class="lv lw it bd lx ly ov ma mb mc ow me mf jz ox ka mh kc oy kd mj kf oz kg ml mm bi translated">承认</h1><p id="1bfc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我要感谢我的朋友David Tian，他是一名机器学习工程师，他对本文提出了宝贵的建议。看看他有趣的自驾* <a class="ae ky" rel="noopener" target="_blank" href="/deeppicar-part-1-102e03c83f2c"> DeepPiCar </a> *博客。</p></div></div>    
</body>
</html>