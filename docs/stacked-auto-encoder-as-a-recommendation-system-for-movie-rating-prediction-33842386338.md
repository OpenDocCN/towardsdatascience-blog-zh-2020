# å¯¹å †å å¼è‡ªåŠ¨ç¼–ç å™¨çš„ç›´è§‚ä»‹ç»å’Œä½œä¸ºç”µå½±åˆ†çº§ç³»ç»Ÿçš„åˆ›å»º

> åŸæ–‡ï¼š<https://towardsdatascience.com/stacked-auto-encoder-as-a-recommendation-system-for-movie-rating-prediction-33842386338?source=collection_archive---------40----------------------->

## å †å å¼è‡ªåŠ¨ç¼–ç å™¨ç®€ä»‹å’Œä½¿ç”¨ Pytorch åˆ›å»ºæ¨¡å‹çš„æŠ€æœ¯æ¼”ç»ƒ

![](img/134c8f948092a58ace42bf34eb88d040.png)

é€šè¿‡[é“¾æ¥](https://unsplash.com/photos/CiUR8zISX60)æ”¹ç¼–è‡ª unsplash çš„ Img

åœ¨ä¹‹å‰çš„[æ–‡ç« ](https://medium.com/@vistaxjtu/restricted-boltzmann-machine-how-to-create-a-recommendation-system-for-movie-review-45599a406deb)ä¸­ï¼Œæˆ‘ä»¬ä¸ºç”µå½±è¯„è®ºé¢„æµ‹åˆ›å»ºäº†ä¸€ä¸ªå—é™çš„æ³¢å°”å…¹æ›¼æœºå™¨æ¨¡å‹:å–œæ¬¢è¿˜æ˜¯ä¸å–œæ¬¢ã€‚ç°åœ¨ï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•æ„å»ºä¸€ä¸ªè‡ªåŠ¨ç¼–ç å™¨æ¨¡å‹ï¼Œç”¨äºä» 0 åˆ° 5 çš„ç”µå½±åˆ†çº§é¢„æµ‹ã€‚å®ƒåˆ†ä¸º 6 ä¸ªéƒ¨åˆ†ã€‚

1.  è‡ªåŠ¨ç¼–ç å™¨ç®€ä»‹
2.  å•†ä¸šæŒ‘æˆ˜
3.  æ•°æ®å¤„ç†
4.  æ¨¡å‹ç»“æ„
5.  æ¨¡ç‰¹åŸ¹è®­
6.  æ¨¡å‹æ£€éªŒ

ğŸ“£ğŸ“£è¿™æ˜¯ä¸€ç¯‡æŠ€æœ¯é©±åŠ¨çš„æ–‡ç« ã€‚ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹æ—…ç¨‹ğŸƒâ€â™€ï¸ğŸƒâ€â™‚ï¸.

1.  **è‡ªåŠ¨ç¼–ç å™¨ä»‹ç»**

> è‡ªåŠ¨ç¼–ç å™¨æ˜¯ä¸€ç§å®šå‘ç¥ç»ç½‘ç»œï¼Œæ—¨åœ¨ç”Ÿæˆä¸è¾“å…¥ç›¸åŒçš„è¾“å‡ºã€‚å¦‚å›¾ 1 æ‰€ç¤ºï¼Œè¾“å…¥é€šè¿‡éšè—å±‚è¿›è¡Œç¼–ç å’Œè§£ç ï¼Œäº§ç”Ÿè¾“å‡ºï¼Œç„¶åä¸è¾“å…¥è¿›è¡Œæ¯”è¾ƒã€‚ä¹‹åï¼Œæ‰§è¡Œåå‘ä¼ æ’­æ¥æ›´æ–°æƒé‡ã€‚å‡ºäºè®­ç»ƒç›®çš„ï¼Œé‡å¤è¿™ä¸ªè¿­ä»£ã€‚

![](img/2169f9396b7a98e481e66ea82c743d7e.png)

å›¾ 1 è‡ªåŠ¨ç¼–ç å™¨æ¨¡å‹å›¾(ä½œè€…åˆ›å»ºçš„ Img)

æœ‰ä¸åŒç±»å‹çš„è‡ªåŠ¨ç¼–ç å™¨ï¼ŒåŒ…æ‹¬å †å è‡ªåŠ¨ç¼–ç å™¨ã€ç¨€ç–è‡ªåŠ¨ç¼–ç å™¨ã€å»å™ªè‡ªåŠ¨ç¼–ç å™¨å’Œæ·±åº¦è‡ªåŠ¨ç¼–ç å™¨ã€‚å¯¹äºè¿™é‡Œå°†è¦æ„å»ºçš„å †å å¼è‡ªåŠ¨ç¼–ç å™¨ï¼Œå®ƒåœ¨ä¸­é—´åŒ…å«å¤šä¸ªç¼–ç æˆ–è§£ç å±‚ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºï¼Œè€ŒåŸºæœ¬çš„è‡ªåŠ¨ç¼–ç å™¨æ¡†æ¶åªæœ‰ä¸€ä¸ªéšè—å±‚ã€‚

![](img/580d1475d5f90e7c5a43c41f7644b064.png)

å›¾ 2 å †å å¼è‡ªåŠ¨ç¼–ç å™¨æ¨¡å‹å›¾(ä½œè€…åˆ›å»ºçš„ Img)

2.**å•†ä¸šæŒ‘æˆ˜**

ä¸€å®¶çŸ¥åè§†é¢‘æµåª’ä½“å…¬å¸å§”æ‰˜æˆ‘ä»¬é¢„æµ‹å…¶ç”¨æˆ·å¯¹ç”µå½±çš„å–œå¥½ï¼Œè¯„åˆ†ä» 0 åˆ° 5ã€‚

3.**æ•°æ®å¤„ç†**

æ•°æ® *MovieLens 100K ç”µå½±è¯„åˆ†*æ¥è‡ª *GroupLens Research* [è¿™é‡Œ](https://grouplens.org/datasets/movielens/)ã€‚ç®€å•çœ‹ä¸€ä¸‹å›¾ 3 ä¸­çš„æ•°æ®ï¼Œ**ç”µå½±**æ•°æ®åŒ…å«ç”µå½±çš„åç§°å’Œç±»å‹ï¼Œ**è¯„çº§**æ•°æ®åŒ…å«ç”¨æˆ· IDã€ç”µå½± IDã€ä» 0 åˆ° 5 çš„ç”¨æˆ·è¯„çº§å’Œæ—¶é—´æˆ³ï¼Œ**ç”¨æˆ·**æ•°æ®åŒ…å«ç”¨æˆ· IDã€æ€§åˆ«ã€å¹´é¾„ã€å·¥ä½œä»£ç å’Œé‚®æ”¿ç¼–ç ã€‚

![](img/6e56beaf66fb0dca0154471e3b75870c.png)

å›¾ 3 æºæ•°æ®ç‰‡æ®µ

3.1 å¯¼å…¥æ•°æ®

æ•°æ®é›†åŒ…å« 80ï¼Œ000 è¡Œè®­ç»ƒé›†å’Œ 20ï¼Œ000 è¡Œæµ‹è¯•é›†ã€‚è®©æˆ‘ä»¬è¯»ä¸€è¯»ã€‚å…·ä½“æ¥è¯´ï¼Œ

```
training_set = pd.read_csv(â€˜ml-100k/u1.baseâ€™, delimiter = â€˜\tâ€™)
training_set = np.array(training_set, dtype = â€˜intâ€™)
test_set = pd.read_csv(â€˜ml-100k/u1.testâ€™, delimiter = â€˜\tâ€™)
test_set = np.array(test_set, dtype = â€˜intâ€™)
```

**æ³¨æ„ï¼Œæˆ‘ä»¬å°† Dataframe è½¬æ¢ä¸º Numpy æ•°ç»„ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ Pytorch å¼ é‡ï¼Œå®ƒéœ€è¦æ•°ç»„ä½œä¸ºè¾“å…¥ã€‚**å›¾ 4 æ˜¾ç¤ºäº†è®­ç»ƒ/æµ‹è¯•é›†ï¼ŒåŒ…æ‹¬ç”¨æˆ· IDã€ç”µå½± IDã€è¯„çº§å’Œæ—¶é—´æˆ³(å¯¹äºæ¨¡å‹è®­ç»ƒæ˜¯ä¸å¯é€†çš„)ã€‚

![](img/f0fb657d015a91ab43ffcb0c0f67e148.png)

å›¾ 4 è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„ç‰‡æ®µ

3.2 æ•°æ®ç»“æ„åˆ›å»º

> ä¸ºäº†å‡†å¤‡è®­ç»ƒ/æµ‹è¯•æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æ•°ç»„æ ¼å¼åˆ›å»ºè®­ç»ƒ/æµ‹è¯•é›†ï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼Œè¡Œä¸­çš„æ¯ä¸ªå•å…ƒæ ¼ä»£è¡¨æ¯éƒ¨ç”µå½±çš„è¯„çº§ã€‚è¿™æ˜¯è‡ªåŠ¨ç¼–ç å™¨çš„é¢„æœŸè¾“å…¥ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·æ€»æ•°ä½œä¸ºè¡Œå·ï¼Œå°†ç”µå½±æ€»æ•°ä½œä¸ºåˆ—å·ã€‚

```
nb_users = int(max(max(training_set[:, 0]), max(test_set[:, 0])))
nb_movies = int(max(max(training_set[:, 1]), max(test_set[:, 1])))
```

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®è½¬æ¢å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªåˆ—è¡¨åˆ—è¡¨ã€‚æ¯ä¸ªå­åˆ—è¡¨ä»£è¡¨ä¸€ä¸ªç”¨æˆ·å¯¹æ‰€æœ‰ç”µå½±çš„è¯„çº§ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰å¯¹ç”µå½±è¿›è¡Œåˆ†çº§ï¼Œåˆ™å°†åˆ†çº§åˆå§‹åŒ–ä¸º 0ã€‚è¿™åœ¨è®­ç»ƒæ¨¡å‹æ—¶éå¸¸é‡è¦ã€‚

```
def convert(data):
    new_data = []
    for id_users in range(1, nb_users + 1):
        id_movies = data[:,1][data[:,0] == id_users]
        id_ratings = data[:,2][data[:,0] == id_users]
        ratings = np.zeros(nb_movies)
        ratings[id_movies â€” 1] = id_ratings
        new_data.append(list(ratings))
    return new_data
```

åˆ©ç”¨ä¸Šé¢çš„è½¬æ¢å‡½æ•°ï¼Œæˆ‘ä»¬å¯¹è®­ç»ƒé›†å’Œæµ‹è¯•é›†è¿›è¡Œè½¬æ¢ã€‚

```
training_set = convert(training_set)
test_set = convert(test_set)
```

å›¾ 5 æ˜¾ç¤ºäº†æœ€ç»ˆçš„è®­ç»ƒé›†ã€‚åŒæ ·ï¼Œæ¯è¡ŒåŒ…å«ç”¨æˆ·å¯¹æ‰€æœ‰ç”µå½±çš„è¯„çº§ã€‚

![](img/037662beb29acaa89f49fac7020c2e18.png)

å›¾ 5 æœ€ç»ˆè®­ç»ƒé›†ç‰‡æ®µ

æœ€åï¼Œæˆ‘ä»¬å°† list ç±»å‹çš„**åˆ—è¡¨è½¬æ¢ä¸º**å¼ é‡**ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ Pytorch æ¥æ„å»ºè‡ªåŠ¨ç¼–ç å™¨ã€‚**

```
training_set = torch.FloatTensor(training_set)
test_set = torch.FloatTensor(test_set)
```

4.**æ¨¡å‹å»ºç­‘**

å¦‚ä½•æ„å»ºè‡ªåŠ¨ç¼–ç å™¨çš„ä½“ç³»ç»“æ„ğŸ¤”ï¼Ÿä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åˆ›å»ºä¸€ä¸ªåŒ…å«è‡ªåŠ¨ç¼–ç å™¨çš„å˜é‡å’Œæ–¹æ³•çš„ç±»ã€‚

è¿™é‡Œæˆ‘ä»¬å°†ä» Pytorch ç»§æ‰¿ä¸€ä¸ªåä¸º*æ¨¡å—*çš„çˆ¶ç±»ã€‚å¥½å¤„æ˜¯ç»§æ‰¿å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå­ç±»æ¥è½»æ¾æ„å»ºæˆ‘ä»¬çš„å †æ ˆå¼è‡ªåŠ¨ç¼–ç å™¨ã€‚

ç°åœ¨è®©æˆ‘ä»¬åœ¨ç±»ä¸­åˆ›å»ºå‡½æ•°ã€‚

4.1 *__init__* å‡½æ•°

> **é¦–å…ˆï¼Œä»çˆ¶ç±»*æ¨¡å—*ç»§æ‰¿æ‰€æœ‰çš„ç±»å’Œå‡½æ•°ã€‚**
> 
> **æ¥ä¸‹æ¥ï¼Œ**ä½¿ç”¨ç»§æ‰¿ç±» *nn åˆ›å»ºç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚ *fc1* ã€‚çº¿æ€§()*ï¼Œè¿æ¥ç¬¬ä¸€ä¸ªè¾“å…¥çŸ¢é‡ç‰¹å¾å’Œç¬¬ä¸€ä¸ªç¼–ç çŸ¢é‡ã€‚

ç¬¬ä¸€ä¸ªè®ºç‚¹ä¸º *nnã€‚Linear()* æ˜¯ç‰¹å¾æ•°ï¼Œä¹Ÿå°±æ˜¯ç”µå½±æ•°ï¼Œ *nb_movies* ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªéšè—å±‚ä¸­çš„èŠ‚ç‚¹æ•°ã€‚åŸºäºå®éªŒï¼Œæˆ‘ä»¬é€‰æ‹© 20ï¼Œè¿™æ„å‘³ç€ç¬¬ä¸€ä¸ªç¼–ç å‘é‡æ˜¯ 20 ä¸ªå…ƒç´ çš„å‘é‡ã€‚è¿™ 20 ä¸ªç‰¹å¾ä»£è¡¨äº†ç›¸ä¼¼ç”¨æˆ·å–œæ¬¢çš„ç”µå½±çš„ç‰¹å¾ã€‚

> ç¬¬ä¸‰ï¼Œæ·»åŠ ç¬¬äºŒä¸ªéšè—å±‚ *fc2* ï¼Œ20 ä¸ªç‰¹å¾ä½œä¸ºè¾“å…¥ï¼Œ10 ä¸ªç¼–ç ç‰¹å¾ä½œä¸ºè¾“å‡ºã€‚

ä»¥ä¸Šæ˜¯ç¼–ç éƒ¨åˆ†ã€‚ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ è§£ç å±‚ *fc3* å’Œ *fc4* ï¼Œå®ƒä»¬å°†ä¸ç¼–ç å¯¹ç§°ã€‚è¯·è®°ä½ï¼Œè‡ªåŠ¨ç¼–ç å™¨æ—¨åœ¨é‡å»ºè¾“å…¥å‘é‡ï¼Œå› æ­¤è¾“å‡ºå‘é‡éœ€è¦ä¸è¾“å…¥å‘é‡å…·æœ‰ç›¸åŒçš„ç»´æ•°ã€‚

> æœ€åï¼ŒæŒ‡å®šæ¨¡å‹çš„æ¿€æ´»å‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ Sigmoid å‡½æ•°ã€‚è¿™æ˜¯å¯è°ƒçš„ï¼Œæ‚¨å¯ä»¥éšæ„å°è¯•å…¶ä»–åŠŸèƒ½ã€‚

```
def __init__(self, ):
    super(SAE, self).__init__()
    self.fc1 = nn.Linear(nb_movies, 20)
    self.fc2 = nn.Linear(20, 10)
    self.fc3 = nn.Linear(10, 20)
    self.fc4 = nn.Linear(20, nb_movies)
    self.activation = nn.Sigmoid()
```

4.2 å‰è¿›åŠŸèƒ½

> **åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ *__init__* å‡½æ•°å†…å»ºçš„æ¶æ„æ¥åº”ç”¨ç¼–ç å’Œè§£ç ã€‚**è¿™æ˜¯é€šè¿‡å¯¹ç¼–ç å’Œè§£ç å±‚åº”ç”¨æ¿€æ´»å‡½æ•°æ¥å®ç°çš„ã€‚æœ€åï¼Œå®ƒè¿”å›ä¸€ä¸ªé¢„æµ‹æ”¶è§†ç‡çš„å‘é‡ï¼Œè¯¥å‘é‡å°†ä¸å®é™…æ”¶è§†ç‡è¿›è¡Œæ¯”è¾ƒã€‚

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªè‡ªå˜é‡ï¼Œè¾“å…¥å‘é‡ *x* ï¼Œå®ƒå°†è¢«è¿ç»­ç¼–ç ä¸¤æ¬¡å’Œè§£ç ä¸¤æ¬¡ï¼Œäº§ç”Ÿé‡æ„å‘é‡ã€‚ç¬¬ä¸€ä¸ªæ¿€æ´»å‡½æ•°æ¿€æ´»æ¥å—è¾“å…¥å‘é‡ *x* çš„ç¬¬ä¸€ä¸ªéšè—å±‚ *fc1* çš„ 20 ä¸ªç¥ç»å…ƒã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ï¼Œæ¿€æ´» *fc2* å’Œ *fc3* ã€‚æ³¨æ„ *fc4* åœ¨è¾“å‡ºå±‚é‡æ„è§£ç çŸ¢é‡æ—¶ä¸éœ€è¦åº”ç”¨æ¿€æ´»å‡½æ•°ã€‚æœ€åï¼Œè¿”å›é¢„æµ‹è¯„çº§çš„å‘é‡ã€‚

```
def forward(self, x):
    x = self.activation(self.fc1(x))
    x = self.activation(self.fc2(x))
    x = self.activation(self.fc3(x))
    x = self.fc4(x)
    return x
```

5.**æ¨¡ç‰¹åŸ¹è®­**

ç¥è´ºä½ é€šè¿‡äº†ç¬¬ 4 éƒ¨åˆ†ï¼Œå› ä¸ºè¿™æ˜¯æœ€éš¾çš„éƒ¨åˆ†ğŸ‘ğŸ‘ã€‚ç°åœ¨æˆ‘ä»¬æ¥è®­ç»ƒ SAE æ¨¡å‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä» *nn ä¸­é€‰æ‹©**å‡æ–¹è¯¯å·®**ã€‚ms loss()*å¯¹äºæŸå¤±å‡½æ•°ï¼ŒRMSprop æ¥è‡ª *optimã€‚RMSprop()* åˆ†åˆ«ä¸ºä¼˜åŒ–å™¨ã€‚åŸºäºå®éªŒï¼Œæˆ‘ä»¬é€‰æ‹©å­¦ä¹ ç‡ä¸º 0.01ï¼Œæƒé‡è¡°å‡ä¸º 0.5ã€‚æ³¨æ„ï¼Œæƒé‡è¡°å‡ç”¨äºåœ¨æ¯å‡ ä¸ªæ—¶æœŸåé™ä½å­¦ä¹ é€Ÿç‡ï¼Œä»¥è°ƒèŠ‚æ”¶æ•›ã€‚æˆ‘ä»¬åœ¨ 200 ä¸ªå†å…ƒä¸Šè®­ç»ƒæ¨¡å‹ã€‚è¿™äº›å‚æ•°æ˜¯å¯è°ƒçš„ï¼Œæ‚¨å¯ä»¥éšæ„å°è¯•ã€‚

```
sae = SAE()
criterion = nn.MSELoss()
nb_epoch = 200
optimizer = optim.RMSprop(sae.parameters(), lr = 0.01, 
                          weight_decay = 0.5)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºå¾ªç¯åˆ›å»º 2 ä¸ªï¼Œä¸€ä¸ªç”¨äºå†å…ƒè¿­ä»£ï¼Œä¸€ä¸ªç”¨äºè§‚æµ‹è¿­ä»£ã€‚åœ¨ epoch å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ– *train_loss* å’Œè‡³å°‘è¯„ä»·ä¸€éƒ¨ç”µå½±çš„ç”¨æˆ·æ•°é‡ã€‚ä¸ºäº†ä¼˜åŒ–è®¡ç®—ï¼Œè¯¥æ¨¡å‹ä¸ä¼šåœ¨æ²¡æœ‰å¯¹ä»»ä½•ç”µå½±è¿›è¡Œè¯„çº§çš„ç”¨æˆ·èº«ä¸Šè¿›è¡Œè®­ç»ƒã€‚

åœ¨è§‚å¯Ÿè¿­ä»£ä¸­ï¼Œæ¯ä¸ªè§‚å¯Ÿè¢«ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°åé¦ˆï¼Œä»¥ä½¿ç”¨ SAE ç±»å’Œ *sae* å¯¹è±¡æ¥é¢„æµ‹æ¯ä¸ªç”¨æˆ·çš„è¯„çº§ã€‚è®¡ç®—æ¯ä¸ªè§‚å¯Ÿçš„æŸå¤±ï¼Œå¹¶ä¸”åº”ç”¨ä¼˜åŒ–å™¨æ¥ä¼˜åŒ–æŸå¤±ã€‚åŒæ—¶ï¼ŒæŸå¤±åœ¨æ¯ä¸ªæ—¶æœŸä¹‹åç´¯ç§¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å›é¡¾è®­ç»ƒæŸå¤±å¦‚ä½•åœ¨æ¯ä¸ªæ—¶æœŸä¸Šæ¼”å˜ã€‚

å…·ä½“æ¥è¯´ï¼Œä¸º Pytorch ç½‘ç»œè®­ç»ƒé›†ä¸­çš„è¾“å…¥å‘é‡æ·»åŠ äº†ä¸€ä¸ªæ‰¹æ¬¡ç»´åº¦ã€‚æˆ‘ä»¬ä½¿ç”¨*å˜é‡()*å’Œ *unsqueeze()* å‡½æ•°å°†æ‰¹å¤„ç†ç»´åº¦æ”¾åœ¨ç´¢å¼• 0 å¤„ã€‚ç„¶åï¼Œä½¿ç”¨ *clone()* å‡½æ•°å…‹éš†è¾“å…¥ä»¥åˆ›å»ºç›®æ ‡ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œè¯¥æ¨¡å‹æ˜¯å¯¹æ²¡æœ‰å¯¹ä»»ä½•ç”µå½±è¿›è¡Œè¯„çº§çš„ç”¨æˆ·è¿›è¡Œè®­ç»ƒçš„ï¼Œè¿™æ˜¯é€šè¿‡ä¸€ä¸ª *if* æ¡ä»¶æ¥å®ç°çš„ã€‚åœ¨ *if* æ¡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å…ˆåšé¢„æµ‹ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ *sae(input)* è¿›è¡Œé¢„æµ‹ï¼Œè€Œä¸æ˜¯ *sae.forward(input)* ã€‚è¿™æ˜¯å› ä¸º *forward* å‡½æ•°æ˜¯ä» *nn* ç±»åˆ›å»ºçš„ä»»ä½•å¯¹è±¡çš„åŸºæœ¬å‡½æ•°ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬çš„ SAE ç±»å·²ç»è¦†ç›–äº†çˆ¶ *forward* å‡½æ•°ã€‚æ›´å¤šä¿¡æ¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¾ç½® *target.require_grad Falseï¼Œ*ï¼Œå› ä¸º *target* ä»*è¾“å…¥*ä¸­å¤åˆ¶äº†ç›¸åŒçš„ *require_grad* å­—æ®µã€‚è¿™æ˜¯å› ä¸ºåªéœ€è¦è®¡ç®—ç›¸å¯¹äº*è¾“å…¥*çš„æ¢¯åº¦ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äº*ç›®æ ‡*çš„æ¢¯åº¦ã€‚æ›´å¤šä¿¡æ¯å¯åœ¨[è¿™é‡Œ](https://discuss.pytorch.org/t/clone-and-detach-in-v0-4-0/16861)æ‰¾åˆ°ã€‚ç„¶åï¼Œåœ¨è¾“å…¥è¯„çº§ä¸º 0 çš„ç´¢å¼•å¤„å°†é¢„æµ‹é‡ç½®ä¸º 0ï¼Œå› ä¸º 0 è¯„çº§ä¸ä¼šå½±å“æŸå¤±è®¡ç®—ã€‚å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨*æ ‡å‡†*å¯¹è±¡æœ‰æ•ˆåœ°è®¡ç®—æŸå¤±ã€‚æˆ‘ä»¬å¿…é¡»å¯¹æ‰€æœ‰ç”µå½±çš„æŸå¤±è¿›è¡Œå¹³å‡ï¼ŒåŒ…æ‹¬é‚£äº›æ²¡æœ‰è¯„çº§çš„ç”µå½±ï¼Œä»¥ä½¿æŸå¤±åœ¨æ•°å­¦ä¸Šä¸æ‰€æœ‰è§‚å¯Ÿç›¸å…³ã€‚ *backward()* æ–¹æ³•ç”¨äºå†³å®šå‘å“ªä¸ªæ–¹å‘æ›´æ–°æƒé‡ï¼Œå¢åŠ è¿˜æ˜¯å‡å°‘ã€‚æœ€åï¼Œä½¿ç”¨ *optimizer.step()* æ›´æ–°æƒé‡ã€‚ä¸åŒäº*ã€å‘å()ã€‘çš„æ–¹æ³•ï¼Œè¿™æ˜¯å†³å®šè¦æ›´æ–°çš„æƒé‡çš„æ•°é‡ã€‚*

```
*for epoch in range(1, nb_epoch + 1):
    train_loss = 0
    s = 0.
    for id_user in range(nb_users):
        input = Variable(training_set[id_user]).unsqueeze(0)
        target = input.clone()
        if torch.sum(target.data > 0) > 0:
            output = sae(input)
            target.require_grad = False
            output[target == 0] = 0
            loss = criterion(output, target)
            mean_corrector = nb_movies/float(torch.sum(target.data >
                                                       0) + 1e-10)
            loss.backward()
            train_loss += np.sqrt(loss.data*mean_corrector)
            s += 1.
            optimizer.step()
    print(â€˜epoch: â€˜+str(epoch)+â€™ loss: â€˜+str(train_loss/s))*
```

*æœ‰äº†ä»¥ä¸Šè¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œæ¨¡å‹è®­ç»ƒäº†ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬åœ¨ç¬¬ 1 ä¸ªçºªå…ƒæ—¶æŸå¤±äº† *1.77* ï¼Œåœ¨ç¬¬ 100 ä¸ªçºªå…ƒæ—¶æŸå¤±äº† *0.934* ï¼Œåœ¨ç¬¬ 200 ä¸ªçºªå…ƒæ—¶æŸå¤±äº† *0.914* ã€‚*

*å¤ªå¥½äº†ã€‚æ¨¡å‹å»ºç«‹å’Œè®­ç»ƒåˆ°æ­¤ä¸ºæ­¢ã€‚ç›¸å½“ä¸“ä¸šï¼Œå¸Œæœ›æˆ‘è¯´æ¸…æ¥šäº†ğŸ˜‡ğŸ˜‡ã€‚*

*6.**æ¨¡å‹æµ‹è¯•***

*ä¸è®­ç»ƒå¾ªç¯ç›¸æ¯”ï¼Œæˆ‘ä»¬å»é™¤äº†å†å…ƒè¿­ä»£ã€‚æ³¨æ„ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨*è®­ç»ƒé›†*ä½œä¸º*è¾“å…¥*è¿›è¡Œé¢„æµ‹ï¼Œä½¿ç”¨*æµ‹è¯•é›†*ä½œä¸º*ç›®æ ‡*è¿›è¡ŒæŸå¤±è®¡ç®—ã€‚ç„¶åï¼Œåœ¨ç›®æ ‡è¯„çº§ä¸º 0 çš„ç´¢å¼•å¤„å°†é¢„æµ‹é‡ç½®ä¸º 0ï¼Œå› ä¸ºè¿™äº› 0 æ„å‘³ç€ç”¨æˆ·æ²¡æœ‰å¯¹ç”µå½±è¿›è¡Œè¯„çº§ï¼Œå› æ­¤åº”è¯¥æ²¡æœ‰é¢„æµ‹ã€‚æˆ‘ä»¬åªè®¡ç®—ç”¨æˆ·åœ¨ *test_set* ä¸­è¯„ä»·çš„ç”µå½±çš„æµ‹è¯•æŸå¤±ã€‚*

```
*test_loss = 0
s = 0.
for id_user in range(nb_users):
    input = Variable(training_set[id_user]).unsqueeze(0)
    target = Variable(test_set[id_user]).unsqueeze(0)
    if torch.sum(target.data > 0) > 0:
        output = sae(input)
        target.require_grad = False
        output[target == 0] = 0
        loss = criterion(output, target)
        mean_corrector = nb_movies/float(torch.sum(target.data > 0) + 1e-10)
        test_loss += np.sqrt(loss.data*mean_corrector)
        s += 1.
print('test loss: '+str(test_loss/s))*
```

*æœ‰äº†ä»¥ä¸Šæ‰€æœ‰çš„ï¼Œæˆ‘ä»¬æ‰§è¡Œæµ‹è¯•ã€‚æœ€åæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª *0.95* çš„æµ‹è¯•æŸè€—ã€‚è¿™è¡¨æ˜æ¨¡å‹æœ‰è½»å¾®çš„è¿‡åº¦æ‹Ÿåˆã€‚*

*æœ€åä¸€ç‚¹ï¼Œå¦‚æœä½ æƒ³æ¯”è¾ƒå®é™…è¯„åˆ†å’Œé¢„æµ‹è¯„åˆ†ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç ã€‚*

```
*user_id = 0
movie_title = movies.iloc[:nb_movies, 1:2]
user_rating = training_set.data.numpy()[user_id, :].reshape(-1,1)user_target = test_set.data.numpy()[user_id, :].reshape(-1,1)
user_input = Variable(training_set[user_id]).unsqueeze(0)predicted = sae(user_input)
predicted = predicted.data.numpy().reshape(-1,1)result_array = np.hstack([movie_title, user_target, predicted])
result_array = result_array[result_array[:, 1] > 0]result_df = pd.DataFrame(data=result_array, columns=[â€˜Movieâ€™, â€˜Target Ratingâ€™, â€˜Predictedâ€™])*
```

*ç°åœ¨ï¼Œæœ€åä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ç”¨æ¨¡å‹åšå‡ºçœŸå®çš„é¢„æµ‹ï¼Ÿç®€å•ï¼Œåªè¦è¯•è¯•:*

```
*prediction = sae(test_value)*
```

***å¤ªå¥½äº†ï¼è¿™æ˜¯æ‰€æœ‰çš„æ—…ç¨‹ã€‚å¦‚æœéœ€è¦æºä»£ç ï¼Œè¯·è®¿é—®æˆ‘çš„**[**Github**](https://github.com/luke4u/Movie-Rating-Prediction)**é¡µé¢ğŸ’•ğŸ’•ã€‚***