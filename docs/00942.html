<html>
<head>
<title>Predicting Bad Housing Loans using Public Freddie Mac Data — a tutorial on working with imbalanced data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用公共房地美数据预测不良住房贷款——使用不平衡数据的教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-bad-housing-loans-using-public-freddie-mac-data-a-tutorial-on-working-with-imbalanced-d2852c003996?source=collection_archive---------26-----------------------#2020-01-27">https://towardsdatascience.com/predicting-bad-housing-loans-using-public-freddie-mac-data-a-tutorial-on-working-with-imbalanced-d2852c003996?source=collection_archive---------26-----------------------#2020-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4c2c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">机器学习能阻止下一次次贷危机吗？</h2></div><p id="a4a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">房地美(Freddie Mac)是一家美国政府支持的企业，购买单户住房贷款，并将其打包作为抵押贷款支持证券出售。二级抵押贷款市场增加了新住房贷款的资金供应。然而，如果大量贷款违约，这将对经济产生连锁反应，就像我们在2008年金融危机中看到的那样。因此，迫切需要开发一种机器学习管道来预测贷款发放时贷款是否会违约。</p><p id="e8d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个分析中，我使用了来自房地美单户贷款级别数据集的数据。数据集由两部分组成:(1)贷款发放数据，包含贷款开始时的所有信息；以及(2)贷款偿还数据，记录贷款的每次支付以及任何不利事件，如延迟支付甚至抛售。我主要使用还款数据来跟踪贷款的最终结果，使用原始数据来预测结果。原始数据包含以下几类字段:</p><ol class=""><li id="939c" class="lc ld iq kh b ki kj kl km ko le ks lf kw lg la lh li lj lk bi translated"><strong class="kh ir">唯一标识符</strong>:贷款_序列号</li><li id="5a23" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">借款人财务信息:</strong>信用评分、首次购房者标志、原始债务收入比(DTI)、借款人数、居住状况(主要住所、投资或第二套住房)</li><li id="d939" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">贷款信息:</strong> First_Payment (date)，Maturity_Date，MI_pert (%抵押担保)，原始LTV(贷款与价值)比率，原始组合LTV比率，原始利率，原始未付余额，PPM(提前还款罚金抵押)标志，贷款目的(购买与再贷款)，原始贷款期限，超符合标志</li><li id="9149" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">房产信息:</strong>单元数量，房产类型(公寓，独栋住宅等。)</li><li id="edbc" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">位置:</strong> MSA_Code(大都市统计区)，属性_州，邮政编码</li><li id="4b2f" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">卖家/服务商信息:</strong>渠道(零售、经纪等。)、卖家名称、服务商名称</li></ol><p id="6f53" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">传统上，次级贷款被定义为信用分数为600或650的任意分界点。但这种方法是有问题的，即600的临界值仅占不良贷款的约10 %, 650仅占不良贷款的约40%。我的希望是，原始数据的附加特征会比信用评分的硬性限制表现得更好。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/253039d936a1c39acd6a3945c8c696cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpFddRUl1I6qI1cj7c3Luw.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">按好贷款与坏贷款分组的信用评分累积直方图</p></figure><blockquote class="mg mh mi"><p id="a399" class="kf kg mj kh b ki kj jr kk kl km ju kn mk kp kq kr ml kt ku kv mm kx ky kz la ij bi translated"><strong class="kh ir">因此，该模型的目标是根据贷款发放数据预测贷款是否为坏账。</strong> <em class="iq">在这里，我定义“好”贷款是指已经全部还清的贷款，“坏”贷款是指因任何其他原因而终止的贷款。</em>为简单起见，我只检查1999年至2003年间产生的贷款，这些贷款已经终止，因此我们不必处理中间状态的持续贷款。其中，我将使用1999-2002年的贷款作为训练集和验证集；以2003年的数据作为测试集。</p></blockquote><p id="c06f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个数据集的最大挑战是结果有多不平衡，因为不良贷款仅占所有终止贷款的大约2%。在这里，我将展示解决这个问题的四种方法:</p><ol class=""><li id="ca2e" class="lc ld iq kh b ki kj kl km ko le ks lf kw lg la lh li lj lk bi translated"><strong class="kh ir">欠采样</strong></li><li id="254b" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">过采样</strong></li><li id="3c7e" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">把它变成一个异常检测问题</strong></li><li id="417e" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><strong class="kh ir">使用不平衡集成分类器</strong></li></ol><p id="e1bb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们开始吧:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/6267e6cb985dfbca9a931086ece7371a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*9NSPFh_5BLb3HO6J7DgN4Q.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">过度/欠采样前后的不良贷款计数</p></figure><p id="380d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1。</strong> <strong class="kh ir">欠采样</strong></p><p id="db06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此处的方法是对多数类进行子采样，使其数量大致与少数类相匹配，从而使新数据集达到平衡。在测试的分类器(*)列表下，这种方法似乎在70–75%的F1分数下工作正常。欠采样的优势在于，您现在处理的数据集更小，这使得训练速度更快。另一方面，由于我们只是从良好贷款中抽取了一部分数据，我们可能会遗漏一些可以定义良好贷款的特征。</p><p id="cee2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(*)使用的分类器:SGD、随机森林、AdaBoost、梯度增强、来自上述所有分类器的硬投票分类器以及LightGBM</p><p id="23d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2。过采样</strong></p><p id="cfb9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与欠采样类似，过采样意味着对少数群体(在我们的例子中是不良贷款)进行重采样，以匹配多数群体的数量。这样做的好处是，您可以生成更多的数据，因此您可以训练模型，使其比原始数据集更适合。然而，缺点是由于较大的数据集而降低了训练速度，以及由于更同质的不良贷款类别的过度表现而导致的过度拟合。对于房地美数据集，许多分类器在训练集上显示出85-99%的高F1分数，但在测试集上测试时崩溃到70%以下。唯一的例外是<a class="ae lb" href="https://lightgbm.readthedocs.io/en/latest/Parameters.html#objective-parameters" rel="noopener ugc nofollow" target="_blank"> LightGBM </a>，其在所有训练、验证和测试集上的F1分数都超过了98%。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mo"><img src="../Images/1a4fe672542a0acbe31fba3c4718a5a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JxMtOnjy55eDVhuXG6pmvQ.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">欠采样/过采样后分类器的性能</p></figure><p id="30e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">欠采样/过采样</strong>的问题在于，对于现实应用来说，这不是一个现实的策略。不可能在贷款开始时预测贷款是否是不良贷款。因此，我们不能使用上述两种方法。作为旁注，当用于评估不平衡数据时，准确性或F1分数会偏向多数类。因此，我们将不得不使用一种叫做<a class="ae lb" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.balanced_accuracy_score.html" rel="noopener ugc nofollow" target="_blank">平衡准确度得分</a>的新指标来代替。虽然我们知道准确度分数是(TP+TN)/(TP+FP+TN+FN)，但是平衡的准确度分数对于类的真实身份是平衡的，使得(TP/(TP+FN)+TN/(TN+FP))/2。</p><p id="dd63" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3。将其转化为异常检测问题</strong></p><p id="62f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在很多时候，不平衡数据集的分类实际上与异常检测问题没有什么不同。“阳性”案例非常罕见，因此在训练数据中没有得到很好的代表。如果我们可以使用无监督学习技术将它们作为离群值来捕捉，这可能会提供一种潜在的解决方法。对于房地美的数据集，我使用隔离森林来检测异常值，并查看它们与不良贷款的匹配程度。不幸的是，平衡准确度分数仅略高于50%。也许这并不奇怪，因为数据集中的所有贷款都是批准的贷款。机器故障、停电或欺诈性信用卡交易等情况可能更适合这种方法。</p><p id="6d34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 4。使用不平衡集成分类器</strong></p><p id="62c3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以这是银弹。因为我们无论如何都在使用集成分类器，所以我们实际上可以使用那些被设计来处理不平衡数据的分类器的版本。对于房地美的数据，我使用了平衡的bagging分类器、平衡的随机森林分类器和来自包<a class="ae lb" href="https://pypi.org/project/imbalanced-learn/" rel="noopener ugc nofollow" target="_blank">不平衡学习</a>的简单集成分类器；以及参数为is_unbalanced = True的<a class="ae lb" href="https://lightgbm.readthedocs.io/en/latest/Parameters.html#objective-parameters" rel="noopener ugc nofollow" target="_blank"> LightGBM </a>分类器。在大约70%的平衡准确度分数下，性能有所下降。有了LightGBM的最佳模型，我可以标记75%的不良贷款，代价是将25%的良好贷款标记为误报。如果我严格根据信用评分截止值标记不良贷款，为了实现75%的召回率，我将截止值设置为720，我们将有47%的误报率。<strong class="kh ir">因此，与严格的截止方法相比，我将假阳性率降低了将近一半。</strong>尽管当前的假阳性率仍有改进的空间，测试数据集中有130万笔贷款(相当于一年的贷款)，贷款规模中值为152，000美元，但潜在的好处可能是巨大的，值得为此带来的不便。被标记为有希望的借款人将在金融知识和预算方面获得额外的支持，以改善他们的贷款结果。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/a2daa94f72ba5d4d97d6c75aaa4fe714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W8xFFxFD_-DzTa0XO-rBzQ.png"/></div></div></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mp"><img src="../Images/03d32affa20939eb350dfb36b9bdf68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oKxTxMEJajv4LyxDPfzc9A.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">无过采样/欠采样的不平衡分类器的性能</p></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mq"><img src="../Images/5a0426fbf5e88c76d5ad47d6de84ada4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SeOF8MaZ43lf82Rw0Rzv3A.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">轻GBM对所有原始数据的混淆矩阵</p></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/6e435f7e5eb64021dc3f6f1a29efd3d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:484/format:webp/1*-4qggKWWFdrxSz6jEv-Kyw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">包含所有要素的原始数据集上的轻型GBM模型的要素重要性表</p></figure><p id="d88f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在开头问的另一个问题是，除了信用评分之外的特征对我们的模型有多大贡献？让我们关注用所有原始数据训练的不平衡光GBM模型的特征重要性。虽然信用评分仍然是最重要的特征之一，但它的相对重要性并不是压倒性的。当它从模型中删除时，它对模型的影响是最小的，性能下降1-2个百分点。地理信息是另一个最重要的特性。但考虑到我国中产阶级化的历史，我测试了如果我删除房产的地理空间信息，模型的性能是否会下降。我在这一点上相当激进，我不仅去掉了显而易见的内容，如邮政编码和财产状态；还包括与位置信息稍微相关的特征，例如服务者姓名。这导致了大约3%点相当显著的性能下降。由于房地美本身并不决定贷款审批，我认为最好保留模型中的所有功能。</p><p id="8663" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总之，我演示了四种不同的方法来处理不平衡的数据集。未来的几个方向包括优化一些分类器以提高性能，建立一个管道来训练和测试每年贷款数据的连续流，以及尝试不良贷款的不同定义，如超过3个月的逾期付款。如果你对这个作品的细节和我在媒体、<em class="mj">上的其他作品感兴趣，请在</em>、<a class="ae lb" href="http://www.github.com/tsofoon/" rel="noopener ugc nofollow" target="_blank">和<em class="mj"> Github </em>、</a>、<em class="mj">上找到我的笔记本。也可以在</em><a class="ae lb" href="https://www.linkedin.com/in/matttso/" rel="noopener ugc nofollow" target="_blank"><em class="mj">LinkedIn</em></a><em class="mj">上联系我。</em></p></div></div>    
</body>
</html>