# 用 GCP 的预言家预测空气污染

> 原文：<https://towardsdatascience.com/predicting-air-pollution-with-prophet-on-gcp-42ceb1625818?source=collection_archive---------52----------------------->

## 使用 EPA 的公共数据进行时间序列预测

GCP 提供了一套云技术和全面管理的无服务器解决方案，使处理，存储和分析数据变得容易。该分析将利用 [BigQuery](https://cloud.google.com/bigquery) 、 [Geo Viz](https://bigquerygeoviz.appspot.com/) 和 [AI 平台](https://cloud.google.com/ai-platform)。

GCP 向新用户提供 300 美元的试用积分。此外，BigQuery 每月提供 1TB 的免费处理。本演示使用了这些配额的一部分。

BigQuery 是一个无服务器的数据仓库和分析工具，具有熟悉的 SQL 接口。它具有地理空间分析的地理信息系统能力，这使它成为任何环境评估的理想工具。此外，BigQuery 提供了许多公开可用的数据集，包括 EPA 的历史数据。

美国环保署维持着一个全面的监测网络，监测许多有害的空气污染物，包括臭氧(O₃)、氮氧化物和颗粒物。该网络确保空气质量符合国家空气质量标准，并协助分析和模拟空气污染模式。

我们将把重点放在每日臭氧摘要上，这在 BigQuery 上很容易获得。这个数据集可能很难处理，因为来自全国各地监视器的大量信息包含每日记录。

# 抽取、转换、加载至目的端（extract-transform-load 的缩写）

第一件事是在 BigQuery 中创建一个数据集来保存我们将在表中处理的数据，将数据集命名为 *EPAO3* 。

接下来，我们查询 EPA 的每日臭氧，并按县、州和月对每日最大臭氧进行最大聚合。我们将这些数据与 2016 年美国人口普查中的县几何数据相结合，以使这些数据在 Geo Viz 中可见。查询结果作为一个新表存储在我们的数据集中，名为 *o3monthlymax* 。

按县汇总的月最大臭氧量表的创建

这个查询运行了 37 秒，处理了 627.8 mb 的数据。消耗的槽时间，总 CPU 时间，是 9 分 37 秒。与传统的单一处理数据库相比，BigQuery 能够显著提高查询速度。创建的新表有 2.26gb 的数据和 33K 行。

健康影响与[急性接触](https://www.onlinejacc.org/content/62/9/816.abstract)相关联，使得每日最大一小时臭氧值成为健康影响的合理替代值。

# 数据可视化

既然我们已经处理了数据，我们可以在 BigQuery Geo Viz 中检查它。让我们做一个时间跨度上的最大聚合，以使 Geo Viz 中的可视化更容易。

o3max_v 视图用于 Geo Viz

我们将把它保存为一个新视图，而不是运行查询。调用视图 *o3max_v* 。在 *EPAO3* 数据集中找到新视图，突出显示**导出**，并选择**使用 Geo Viz** 进行探索。您需要授权 Geo Viz 访问您的数据。我们可以使用默认的查询 Geo Viz 来访问我们的数据

地理 Viz 查询

*几何图形*应自动选择为几何图形列。移动到**样式和填充颜色**。选择**数据驱动**选项，并在字段选择器中滚动到 *O3* 。这里选择线性作为函数，但是间隔也可以工作。添加一些领域的限制，并发挥范围内的颜色，直到你满意的结果。

![](img/7878f38504f7ff7a455fbf3285594fc6.png)

按县划分的最大 1 小时臭氧 Geo Viz 地图

请注意，一些县在监测网络中有很好的代表性，而另一些县则没有监测员。例如，内布拉斯加州和堪萨斯州很少有臭氧监测器。

# 时间数列预测法

接下来我们将使用 [Prophet](https://facebook.github.io/prophet/) 进行空气污染预测。Prophet 是由脸书开发的开源时间序列预测工具。它基于一个附加模型，其中非线性趋势适用于各种时间窗口和假期趋势。

我们将使用 GCP 的人工智能平台创建一个虚拟机来运行 Prophet，该平台具有适合机器学习的虚拟机。在 AI 平台中创建一个新的笔记本实例，这里使用的是定制的 n1-standard-1 机器类型，这有助于最小化成本。AI 平台上的 Notebook 实例已经过身份验证，可以访问同一个项目中的 BigQuery。

一旦虚拟机被配置好，你就可以直接从 GCP 控制台打开 **jupyterlab** 。从那里创建一个 Python 3 笔记本或者上传到 github repo 中。

人工智能平台 Jupyter 笔记本使用 BigQuery 上的数据预测未来的臭氧

BigQuery 客户端库提供了 cell magic，它可以运行 SQL 查询并以 Pandas DataFrame 的形式返回结果，从而使 python 查询变得容易。

![](img/e43f8023a8a5ace1fa0b37976b9fb0e2.png)

洛杉矶县臭氧预测。监控值以黑点显示。预测用蓝线显示。

臭氧往往在夏季达到峰值，因为它依赖于温度。Prophet 在捕捉臭氧的季节性变化方面做了合理的工作，并提供了现成的参数。

# 摘要

我们能够使用 GCP 平台和开源软件上包含的工具，在几个步骤中完成复杂的地理空间时间序列分析。

# 感谢

感谢[爱德华·克鲁格](https://www.linkedin.com/in/edkrueger/)和[道格拉斯·富兰克林](https://www.linkedin.com/in/douglas-franklin-1a3a2aa3/)审阅本文。