# 使用 SAP HANA 预测出租车目的地

> 原文：<https://towardsdatascience.com/predicting-taxi-destinations-with-sap-hana-4125a62e2f5?source=collection_archive---------53----------------------->

## 基于真实实例展示多模型数据处理的优势

![](img/c6989d1a0ae98f75de4979e5aeaca034.png)

埃里克·诺帕宁在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

在我最近的[故事](/spatial-data-science-powered-by-sap-hana-9d1153afa577)中，我使用 SAP HANA 空间引擎和 SAP HANA 自动预测库，根据历史乘坐数据预测了在波尔图市乘坐出租车需要多长时间。在技术上，我利用 Jupyter 笔记本电脑和免费的 SAP HANA Express Edition 将所有操作(地理空间+机器学习)下推到数据库级别，而不是将数据(和计算)移动到客户端。

今天，我想更进一步，甚至**根据起点、一天中的时间和轨迹**的前几个点来预测出租车的目的地。在现实生活中，这种模型可以支持出租车运营，使后勤运营商能够预测某个区域内的可用出租车数量，甚至在这些出租车到达之前。

**完整 Jupyter 笔记本** [**可在 GitHub**](https://github.com/mkemeter/public/blob/master/TaxiTrajectories.ipynb#) **上查看。**

让我们从代码开始——我不会详细介绍上传数据和六边形参考网格背后的概念，因为这已经在[之前的博客](/spatial-data-science-powered-by-sap-hana-9d1153afa577)中讨论过了。简单回顾一下:我们不是基于精确的坐标来预测结果，而是基于出租车出发的区域(即六边形单元)来预测出租车的目的地。

当查看出租车目的地区域的六边形单元时，我们最终处理[多类分类问题](https://en.wikipedia.org/wiki/Multiclass_classification)，其中每个六边形单元(即其 ID 值)是一个目标类。HANA 的自动预测库提供了一个[GradientBoostingClassifier](https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/hana_ml.algorithms.apl.html#apl-gb-classification-label)，它能够进行多类分类。

# 数据准备和增强

然而，我们必须处理 GradientBoostingClassifier 的一个限制:它最多支持 100 个目标类。我们可以很容易地发现，我们的参考网格包含超过 1300 个潜在的目标区域。

那么，我们该如何处理呢？出租车经常去同一个地区。在前面的分析中，我们已经确定了波尔图的出租车接送热点。我们已经看到，在许多地区，抵达或出发的航班数量非常少。

*只预测前 100 个目的地会有什么影响？*我们可以使用下面的嵌套语句来检查到达前 100 个单元的总行程的百分比:

![](img/2f582bc6379af7cbb7284d0b9a302683.png)

因此，我们看到只有不到 10%的行程到达其他地点。这意味着预测前 100 个目的地的模型将适用于超过 90%的旅行。当然，对于剩下的 10%，我们总是预测不正确的目的地。但是由于这些目的地很少，无论如何预测都很难。

**好，我们来预测 100 个最常去的目的地。**

为了使预测更有趣，我们将进一步包括滑行轨迹的前 10 个坐标。这可以让我们知道出租车朝哪个方向行驶。对于我们现实世界场景中的运营商来说，这对于不是超短的行程来说仍然是足够的提醒。

基于行程的前 10 个坐标，我们希望将以下特征添加到我们的训练数据集中:

*   ***罗盘* =滑行前进的方向(N，NE，E，SE，S，SW，W，NW)**
    我们将假设轨迹的第一个点在一个圆的中心，第十个点在其边缘。基于此，我们计算出指南针的方向。请注意，“ACOS(0)”的用法只是一种获取圆周率的黑客手段。

*   ***罗盘 _DIST* =出租车在轨迹的前 10 个点内行驶的直线距离。** 想法是检测出租车是否快速进入一条主干道或者沿着一些小巷子行驶。

为了将这些特征添加到我们的数据集中，我们可以发出下面的语句，该语句也根据上面计算的值对指南针方向进行分类。

# 训练梯度增强模型

好吧，让我们用 75000 个样本轨迹构建一个数据集，分为训练数据集(80%)和测试数据集(20%)。为此，我们将使用 HANA 内置的窗口函数 [RANDOM_PARTITION](https://help.sap.com/viewer/7c78579ce9b14a669c1f3295b0d8ca16/Cloud/en-US/abf3dd7576464c30a7897a05d1ef8cb2.html) 。在选择前 100 个目的地时，我们已经看到了嵌套 SQL 语句的第二部分。

随机化的双重使用可能首先看起来令人困惑。我们使用“order by rand()”和“top 75000”来随机选取 75000 个样本。然后，我们使用“random_partition()”将这些样本随机分为训练和测试数据集。

结果数据集如下所示，其中 END_HEXID 是我们模型的目标变量，SET_NUM 确定记录是属于定型数据集(SET_NUM = 1)还是测试数据集(SET_NUM = 3)。

![](img/be2ffb2c826a4459606275042716f4a7.png)

最后，我们准备好训练我们的梯度推进模型。在我装有 HANA Express 的笔记本电脑上，培训持续几分钟。所以，慢慢来，喝杯咖啡…..或者浓缩咖啡，最好拿一杯浓缩咖啡。

使用 Python 的 hana_ml 客户端时，将从 Python 内部触发模型训练。但是，所有计算都在后台下推到数据库，数据不会传输到客户端。

喝完加了很多糖的浓缩咖啡后，我们观察分类模型的贡献特征。

![](img/435fc1e390f9045f4a557e5c1a386095.png)

决定出租车目的地的三个最重要的影响因素是:

1.  出租车前往的**方向**，
2.  **提货区**和
3.  一天中的**时刻**。

这是有道理的——特别是白天的影响是可以预期的，因为晚上 8 点左右的旅行更有可能在酒吧或餐馆结束，午夜后的旅行更有可能在人们居住的郊区结束。

# 评估模型性能

当然，我们可以通过发出以下命令从 APL 中检索我们模型的统计度量:

![](img/a338bfe914b22aa6dd1d889ea0c1aca1.png)

但是，这次我们要评估的模型略有不同。因为我们通过六边形来聚集我们的位置，所以我们可能在六边形的边缘有一些“接近失误”。上述性能测量仅反映了我们是否准确预测了正确的目标六边形，它不包括地理空间邻近性测量。

为了获得一些数据，我们将基于 15000 条记录的测试数据集进行预测。

对于每个预测的记录，我们现在有正确的目标六边形以及预测的目标六边形的 id。为了评估地理空间的接近程度，我们需要将参考格网中的几何数据连接回结果表。

生成的数据帧如下所示，其中 TRUE_CENTROID 和 PREDICTED_CENTROID 是相应六边形单元/区域的质心点。我们可以看到，APL 甚至在输出中添加了一个概率场，通过它我们可以根据模型确定预测位置的可能性。

![](img/0c4d8200ee9df1a5bffc5a87a095421e.png)

基于此，我们可以计算出预测质心和真实质心之间的平均距离。

![](img/bd92f732d47d176f9ccb6c1a60b468c6.png)

所以平均来说，我们预测的范围是 2.6 公里。为了建立这种关系，我们需要知道我们的六角形细胞的直径。

![](img/e0f2c026b34d4d1aa5ca0c94ef1c8fbd.png)

这意味着由于我们的空间宁滨，我们无论如何只能在 1 公里的范围内进行预测。那么，我们的预测有多少是在正确的目标细胞中，或者是在它的一个相邻细胞中呢？根据直径，我们可以查询 1.1 公里范围内的质心。

我们可以看到，基于这个测量值**，我们正确预测了三分之一(在我的例子中是 33.9%)的行程**。

这听起来不错，但是我们应该将这个结果与适当的基线进行比较。*如果我们简单地总是预测具有最多整体滑行活动的六边形单元，会发生什么？*如果我们只有一个猜测，这个可能会很好。

我们可以确定最频繁访问的小区，并如下进行“预测”。

那么，我们的模型与作为基线的“多数票”相比如何呢？

使用我们的模型，我们的**仍然比基线好 10%**。我们的**模型正确预测了 15000 次出行中的 5085 次**，而**基线多数投票只正确预测了 15000 次出行中的 3568 次**。

最后，我们可以将 APL 配置为也输出所有其他六边形簇的概率，这些簇没有被预测为目的地。

我们可以用这些数据来想象一个场景:

*   在左侧，我们可以看到概率分布以及预测的目的地单元，以防我们在早上 8 点从 Campanha 火车站开始向西乘坐出租车。
*   在右图中，我们看到同样的旅程只是在晚上 8 点开始，然后向东北方向行驶。

![](img/27723e4fe63578579216f06d2e83e06c.png)

同一起始位置的预测行程目标。

查看概率分布，我们可以知道，在任何情况下，城市中心都是一个可能的目的地(与时间和方向无关)。然而，对于向西的变量，我们在城市的东部没有看到任何高概率，而前往机场的概率明显更高。对于向东北方向的旅行，我们看到目的地在东北方向的概率较高，而机场和目的地在海边的概率较低。

作为一个附带收获，我们还可以在可视化中很好地看到，我们的前 100 个目的地地区基本上覆盖了波尔图的城市核心。

# 摘要

老实说，我不确定这是否是向出租车运营商推销解决方案的商业案例。但这仍然是一个有趣的例子，展示了如何将地理空间维度融入到机器学习模型中！

我们已经在这个([和我最近的](https://blogs.sap.com/2020/02/08/spatial-data-science-powered-by-sap-hana/))博客帖子中看到，如何将地理空间数据无缝地合并到一个简单的机器学习模型中。我们使用 SAP HANA 作为统一平台来处理空间数据和训练我们的模型。此外，我们还使用了 [hana_ml Python 客户端](https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/index.html)来实现 Jupyter 笔记本的所有功能。

![](img/d3217592b2e1e54e942ae44613a49892.png)

【https://blogs.sap.com】最初发表于[](https://blogs.sap.com/2020/03/25/predicting-taxi-destinations-with-sap-hana/)**。关注作者上*[*LinkedIn*](https://linkedin.com/in/mathiaskemeter)*或*[*Twitter*](https://twitter.com/math1ask)*。**