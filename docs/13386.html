<html>
<head>
<title>Geostatistics in practice using R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 R 的地质统计学实践</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geostatistics-in-practice-using-r-4b7d32b7840d?source=collection_archive---------24-----------------------#2020-09-14">https://towardsdatascience.com/geostatistics-in-practice-using-r-4b7d32b7840d?source=collection_archive---------24-----------------------#2020-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/b0257239d2502a8757d35acfed912315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8goPKUzujvsRUJZL"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@dead____artist?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">捕捉人心。</a> on <a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><div class=""/><div class=""><h2 id="a853" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">如何使用带有 R 的地理定位数据进行估计</h2></div><h1 id="5973" class="ky kz jj bd la lb lc ld le lf lg lh li kp lj kq lk ks ll kt lm kv ln kw lo lp bi translated">介绍</h1><p id="5b5a" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在本文中，您将了解什么是<strong class="ls jk">地质统计学</strong>，以及如何使用<strong class="ls jk">克里金法</strong>(一种插值方法)利用地理位置数据进行估算。在我们的示例中，我们将获取纽约的房地产销售价格，并创建一个模型，为我们提供城市中任何位置的价格估计。</p><p id="e5cd" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">开始之前，让我们先了解一下如何将<strong class="ls jk">地统计数据</strong>插入到<strong class="ls jk">空间统计数据的字段中。</strong></p><h1 id="58c7" class="ky kz jj bd la lb lc ld le lf lg lh li kp lj kq lk ks ll kt lm kv ln kw lo lp bi translated">空间统计</h1><p id="73a9" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">空间统计学是统计学中一个相对较新的领域，它基于数据之间的<strong class="ls jk">空间相关性</strong>的思想:两个观测值在空间上越接近，它们的相关性就越强。<strong class="ls jk">时间相关性</strong>已经研究了很长时间，但是不可能将时间序列模型直接应用于空间数据，因为时间相关性假设通常使用<strong class="ls jk">序列相关性</strong>结构，而空间相关性发生在<strong class="ls jk">二维或三维</strong>。然而，有<strong class="ls jk">时空模型</strong>同时结合了两者。</p><p id="afd0" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在空间统计中，有四类数据:<strong class="ls jk">地统计</strong>、<strong class="ls jk">格网</strong>、<strong class="ls jk">点</strong>和<strong class="ls jk">流</strong>。我们在这里只讨论地质统计学，但是知道其他的有助于我们理解什么是地质统计学。</p><p id="43d2" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在<strong class="ls jk">地统计数据</strong>中，随机变量可以在集合中的任意无限点(例如，一个城市或一个国家)进行测量，尽管实际上，它只在某些点进行测量。这就是我们将使用的例子的情况:你可以在纽约的任何一点(我们的集合)有房地产价格(我们的随机变量)，我们只在其中的一些点(销售实际发生的点)测量它。然后我们的兴趣将是为没有发生销售的点估计相同的变量。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mr"><img src="../Images/4c6f974aa9871a2c8363effcc1ddddaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ILwpACywXtyfw6nV0aVx4w.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">地统计数据示例-按作者分类的影像</p></figure><p id="2e89" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在<strong class="ls jk">点阵数据</strong>中，一个随机变量在一个有限集中被度量，用一个矩阵表示，可以是正则的，也可以不是。一个例子是，当我们把一个国家分成几个州，然后测量每个州的平均收入。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mw"><img src="../Images/c8365b0f72adc1e7fe6e689fc9615b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJ-xJQ9w0yyefPPLj_t0_w.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">晶格数据的例子。如果你想探索这张地图，<a class="ae jg" href="https://arthurmello.github.io/geomarketing-tool/index.html" rel="noopener ugc nofollow" target="_blank">这里是它的链接</a>——作者图片</p></figure><p id="93a5" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在<strong class="ls jk">点数据</strong>中，随机性不一定来自变量，而是来自它的位置。例如，如果我们想要了解或预测城市中的犯罪地点:我们会有一系列犯罪地点，并对寻找高密度的聚类(危险区域)感兴趣。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mx"><img src="../Images/1e76573af1d6b215ac2e127643ecf385.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TgAyyrf_SFcR4qYJK-LeMA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">点数据示例-按作者分类的图像</p></figure><p id="ea47" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在<strong class="ls jk">流数据</strong>中，我们有一个随机变量，它不仅与一个位置相关，而且与两个位置相关。迁移数据就是一个例子:对于任意两两组合的地点，我们知道从一个地点到另一个地点的人数。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi my"><img src="../Images/1ee9fce4d86dec80c7f21a8a50831761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-FrQg-Nib6kQ_iqVKfTOkw.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">流量数据示例—按作者分类的图像</p></figure><p id="38c7" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在我们知道什么是地质统计学(什么不是)。在了解克里金法之前，我们还有最后一个话题要讲:变异函数。</p><h2 id="a7ad" class="mz kz jj bd la na nb dn le nc nd dp li lz ne nf lk md ng nh lm mh ni nj lo nk bi translated">变异函数</h2><p id="36b5" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">如果空间统计基于“两个观测值在空间上的距离越近，它们的相关性就越强”这一思想，则变异函数会根据这些观测值之间的距离显示相关性的表现。</p><p id="616a" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">变异函数被定义为“给定两次观测之间的距离，返回这两次观测之间差异的方差的函数”。</p><p id="5174" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">以下是纽约房地产价格的经验变异函数示例。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/7eba1d0c6614fb1f505b9895b9c5b6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*6u100Ip2pTTMGpndguUEgw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="0c75" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">正如我们所见，两栋建筑离得越远，它们的价格差异就越大，相关性就越低。</p><p id="913a" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">基于这些点，我们可以估计一个非常适合它们的函数，然后将它用于克里金法。</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/6101be97f7d01caf9654e7c14fe5afd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*6Sko5hlu7e85vwlTYlmtYQ.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><h1 id="3ff2" class="ky kz jj bd la lb lc ld le lf lg lh li kp lj kq lk ks ll kt lm kv ln kw lo lp bi translated">克里金法</h1><p id="48cb" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">克里金法是一种插值方法:给定一些数据点，它试图找到一个穿过这些点的函数，这样就可以对中间值进行估计。</p><p id="12dc" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">虽然<a class="ae jg" rel="noopener" target="_blank" href="/linear-regression-the-basics-4daad1aeb845">线性回归</a>和反距离加权插值法基于假设的预定义模型，但克里金法基本上是根据经验构建的。它的优势之一是它不是一个确定性的模型，而是一个概率性的模型，这意味着它不仅给你一个估计，它还告诉你你对这些估计有多确定。</p><p id="ce95" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">进行这些估计的公式如下:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/d8f8f47699c26c0416e73cc46708ae5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*7NKq1mSjFaPIKjuwAE40Sg.png"/></div></figure><p id="f4e0" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">权重是根据变异函数估算的，并且完全取决于观测值之间的距离。</p><h1 id="3c50" class="ky kz jj bd la lb lc ld le lf lg lh li kp lj kq lk ks ll kt lm kv ln kw lo lp bi translated">用 R 怎么做</h1><h2 id="3595" class="mz kz jj bd la na nb dn le nc nd dp li lz ne nf lk md ng nh lm mh ni nj lo nk bi translated">数据</h2><p id="d982" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我们将使用在<a class="ae jg" href="https://www.kaggle.com/new-york-city/nyc-property-sales" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>上提供的数据集，其中包含 2016 年纽约市的房产销售数据:位置、价格、面积、税收等级等。鉴于我们在这里的目标，我们将忽略除了它的位置，价格和面积的财产的所有信息。我们使用面积的原因是我们想计算每平方英尺的价格，而不仅仅是销售价格。从现在起，我们将只谈每平方英尺的价格，并把它称为“价格”。</p><h2 id="7ee4" class="mz kz jj bd la na nb dn le nc nd dp li lz ne nf lk md ng nh lm mh ni nj lo nk bi translated">代码</h2><p id="b0b3" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">完整的代码可以在<a class="ae jg" href="https://github.com/arthurmello/kriging" rel="noopener ugc nofollow" target="_blank">这里</a>找到。在本文中，我们将只浏览它的主要部分。</p><p id="e60c" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在进行了一些数据清理之后，我们首先来看看价格在地图上的表现:</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="35fb" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Plotting prices<br/>mapnyc &lt;- data.frame(latitude = db$lat,<br/>                     longitude = db$lon,<br/>                     price = db$PRICE.SQUARE.FEET)</span><span id="62d1" class="mz kz jj no b gy nw nt l nu nv">Token_map_box = #&lt;mapbox API token&gt;</span><span id="e82a" class="mz kz jj no b gy nw nt l nu nv">palette_rev &lt;- rev(brewer.pal(10, "RdYlBu"))</span><span id="3375" class="mz kz jj no b gy nw nt l nu nv">pal &lt;- colorNumeric(palette = palette_rev, domain = c(max(mapnyc$price):min(mapnyc$price)))<br/>leaflet() %&gt;%  addTiles(urlTemplate = Token_map_box) %&gt;%<br/>  addCircleMarkers(data = mapnyc, color = ~pal(price), radius = 2)</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mr"><img src="../Images/4c6f974aa9871a2c8363effcc1ddddaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ILwpACywXtyfw6nV0aVx4w.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">是的，这和我们在开头看到的情节是一样的——作者的图片</p></figure><p id="56ff" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">正如我们所看到的，曼哈顿的销售少了很多，尤其是在较低的部分。此外，那里的价格似乎比皇后区(东部)要高很多。此外，我们可以看到，紧挨着水的房产也更贵，这是有道理的，因为他们可能有很好的风景。</p><p id="335c" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在，让我们看看价格是否遵循正态分布:</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="d0c3" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/>hist(db$PRICE.SQUARE.FEET)</span><span id="e4cb" class="mz kz jj no b gy nw nt l nu nv"><strong class="no jk">OUT:</strong></span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/40cb2630ced4ebaedffe259b09f2c44c.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*LMIAxi15S4LeO6OODuU66g.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="e236" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">正如我们所看到的，我们的数据不是正态分布的，所以让我们使用它的日志来代替。请注意，这一步并非绝对必要:遵循正态分布的数据不是克里金法的假设之一。然而，在这种情况下，预测能力有所提高。</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="2937" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/>db$PRICE.SQUARE.FEET.log = log(db$PRICE.SQUARE.FEET)<br/>hist(db$PRICE.SQUARE.FEET.log)</span><span id="ca16" class="mz kz jj no b gy nw nt l nu nv"><strong class="no jk">OUT:</strong></span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/c0180527c8882bc15f25764342eabdbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*5KeF8U6_QIjolF4cD1bDbA.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="dab0" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">目前，我们所做的只是使用一个常规的数据帧。然而，空间数据在 r 中的行为方式完全不同。我们可以将我们的数据框架转换为 SpatialPointsDataFrame，它将点数据存储为位置，以及关于它们的附加信息(如价格)。在此之前，我们还将把数据帧分成训练集和测试集，以便在最后计算一些误差指标。</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="9307" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Train/test split<br/>smp_size &lt;- floor(0.75 * nrow(db))</span><span id="d847" class="mz kz jj no b gy nw nt l nu nv">set.seed(123)<br/>train_ind &lt;- sample(seq_len(nrow(db)), size = smp_size)</span><span id="02f1" class="mz kz jj no b gy nw nt l nu nv">train &lt;- db[train_ind, ]<br/>test &lt;- db[-train_ind, ]</span><span id="80f7" class="mz kz jj no b gy nw nt l nu nv"># Converting to spatialpointsdataframe<br/>projection = "+proj=longlat +ellps=WGS84 +no_defs"</span><span id="8acc" class="mz kz jj no b gy nw nt l nu nv">train_spdf = SpatialPointsDataFrame(train[28:29], train[-c(28,29)], proj4string = CRS(projection))<br/>test_spdf = SpatialPointsDataFrame(test[28:29], test[-c(28,29)], proj4string = CRS(projection))<br/>db_spdf = SpatialPointsDataFrame(db[28:29], db[-c(28,29)], proj4string = CRS(projection))</span></pre><p id="fdb4" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">请注意“sp”包中的函数 SpatialPointsDataFrame。它将位置列作为第一个参数，其余数据作为第二个参数，投影作为第三个参数。<strong class="ls jk">投影</strong>是将球面坐标转换成平面坐标的函数。有许多不同的方法可以做到这一点，我们使用了<strong class="ls jk"> WGS84 </strong>系统。</p><p id="120d" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后我们移除所有重复的位置，因为克里金法在每个位置只取一个值(价格)。</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="b7c1" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Removing duplicate locations<br/>train_spdf = train_spdf[-zerodist(train_spdf)[,1],]<br/>test_spdf = test_spdf[-zerodist(test_spdf)[,1],]<br/>db_spdf = db_spdf[-zerodist(db_spdf)[,1],]</span></pre><p id="a865" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在，让我们通过查看一般经验变异函数来看看是否存在任何<strong class="ls jk">空间相关性</strong>。同时，我们还可以找到变差函数的最佳拟合，并将两者一起绘制。</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="755c" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Choosing the best variogram<br/>vario.fit = autofitVariogram(PRICE.SQUARE.FEET.log~1,<br/>                             train_spdf,<br/>                             model = c("Exp", "Sph"),<br/>                             kappa = c(0, 0.01, 0.05, seq(0.2, 2, 0.1), 5, 10),<br/>                             fix.values = c(NA),<br/>                             start_vals = c(NA),<br/>                             verbose = T)</span><span id="b05e" class="mz kz jj no b gy nw nt l nu nv">fit.v = vario.fit$var_model</span><span id="99fe" class="mz kz jj no b gy nw nt l nu nv">lzn.vgm &lt;- variogram(PRICE.SQUARE.FEET.log~1, train_spdf) # calculates sample variogram values <br/>lzn.fit &lt;- fit.variogram(lzn.vgm, model=fit.v, fit.kappa = TRUE) # fit model</span><span id="4820" class="mz kz jj no b gy nw nt l nu nv">plot(lzn.vgm, lzn.fit) # plot the sample values, along with the fit model</span><span id="a574" class="mz kz jj no b gy nw nt l nu nv"><strong class="no jk">OUT:</strong></span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/4418000b4180f8a191ee71797b49ed0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*I5FKINfnSFKsOhQ89FE9Gw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="7785" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">这里的<strong class="ls jk">经验变异函数</strong>用圆圈表示，而我们的<strong class="ls jk">拟合</strong>用直线表示。“automap”软件包有一个名为“autofitVariogram”的功能，它从用户给定的参数组合(如函数的形状)中找出经验变异函数的最佳拟合。空间相关性似乎很明显，我们的线与数据相当吻合，所以我们继续。</p><p id="18a0" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在我们已经从可用数据中获得了变差函数，我们希望绘制新数据的估计值，以便创建纽约的价格热图。要做到这一点，我们需要一个 NY 网格，它实际上是城市边界内的一组小方块。这也许是讨论 r 中不同类型的空间数据的好时机。空间坐标可以给你<strong class="ls jk">点</strong>、<strong class="ls jk">线</strong>或<strong class="ls jk">多边形</strong>。我们的价格数据是以点数给出的，纽约市的边界是以多边形给出的，可以在这里<a class="ae jg" href="https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm" rel="noopener ugc nofollow" target="_blank">下载</a>作为 shapefile(。shp)。</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="cbcd" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Getting NY polygon<br/>ny_polygon = st_read('data/borough_boundaries/geo_export_a88ff5b0-7fb1-479d-a22b-224328f6d976.shp')<br/>ny_polygon = st_transform(ny_polygon, projection)</span><span id="c84f" class="mz kz jj no b gy nw nt l nu nv">spd &lt;- sf::as_Spatial(st_geometry(ny_polygon), IDs = as.character(1:nrow(ny_polygon)))<br/>spd_data = ny_polygon<br/>spd_data$geometry = NULL<br/>spd_data &lt;- as.data.frame(spd_data)<br/>spd &lt;- sp::SpatialPolygonsDataFrame(spd, data = spd_data)</span><span id="9ea2" class="mz kz jj no b gy nw nt l nu nv">grid &lt;- makegrid(spd, cellsize = 0.001)<br/>grid &lt;- SpatialPoints(grid, proj4string = CRS(projection))<br/>grid &lt;- grid[spd, ]</span></pre><p id="6f16" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们在这里做的是使用与原始数据相同的投影获得 NY 多边形，将其转换为 SpatialPolygonsDataFrame，然后使用它来制作网格，其中每个单元格的大小等于变量“cellsize”。该数值越小，地图就越详细(或像素化程度越低)，但构建地图的时间就越长。</p><p id="6eeb" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后，我们转到克里金法部分本身，将它应用到网格中:</p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="a87c" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/># Kriging<br/>heat = krige(PRICE.SQUARE.FEET.log ~ 1, locations = train_spdf, newdata = grid, model = fit.v)</span><span id="174d" class="mz kz jj no b gy nw nt l nu nv">heat %&gt;% as.data.frame %&gt;%<br/>  ggplot(aes(x=x1, y=x2)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +<br/>  scale_fill_gradient(low = "yellow", high="red") +<br/>  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +<br/>  theme_bw()</span><span id="6f25" class="mz kz jj no b gy nw nt l nu nv"><strong class="no jk">OUT:</strong></span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nx"><img src="../Images/b13600c9bd1169d5d862078ff8c53f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X4NIsR33cgGCAZuBHuS1UQ.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="6e63" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">这里，我们使用函数“克里格”，告诉它使用什么模型(“fit.v”是我们拟合变差函数的地方)，“newdata”是我们的网格。然后我们将其绘制成热图，我们可以清楚地看到曼哈顿下城周围的高价格区域为红色区域，尽管我们在那里没有太多的数据。</p><p id="8196" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后，让我们评估我们的模型在测试数据中的性能，将其与另一个更简单的方法进行比较:<strong class="ls jk">K-最近邻</strong> (KNN)。简而言之，KNN 要做的是，对于测试集上的每一栋建筑，取最近的 K 栋建筑的价格(在我们的例子中，K 的最佳值是 14)，并用它们的平均值来估算价格。我不会在这里讨论我们的 KNN 模型的细节，因为这不是本文的范围，但是您可以在 GitHub 上的<a class="ae jg" href="https://github.com/arthurmello/kriging" rel="noopener ugc nofollow" target="_blank">完整代码中找到它。</a></p><pre class="ms mt mu mv gt nn no np nq aw nr bi"><span id="93d4" class="mz kz jj no b gy ns nt l nu nv"><strong class="no jk">IN:</strong><br/>kriging_error = rmse(test_spdf$PRICE.SQUARE.FEET, exp(kriging_test_prediction$var1.pred))</span><span id="d801" class="mz kz jj no b gy nw nt l nu nv">knn_error = rmse(test$PRICE.SQUARE.FEET, exp(knn_model$pred))</span><span id="d304" class="mz kz jj no b gy nw nt l nu nv"># final results<br/>cat(paste('Kriging error:', kriging_error, '\nKNN error:', knn_error))</span><span id="3267" class="mz kz jj no b gy nw nt l nu nv"><strong class="no jk">OUT:</strong><br/>Kriging error: 159.360604969667 <br/>KNN error: 162.557634288862</span></pre><p id="72bd" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">这里，我们使用了<strong class="ls jk">均方根误差</strong> (RMSE)来比较这两个模型，它取预测值和实际值之间的平均平方差的平方根。正如我们所见，克里金法误差略小，但幅度非常小。根据应用的不同，选择 KNN 可能会更好，因为它计算起来更快更容易。然而，这里的目标是展示克里金法的工作原理以及如何使用 r。</p><h1 id="e33a" class="ky kz jj bd la lb lc ld le lf lg lh li kp lj kq lk ks ll kt lm kv ln kw lo lp bi translated">更进一步</h1><p id="09cd" class="pw-post-body-paragraph lq lr jj ls b lt lu kk lv lw lx kn ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">如果您想使用这些数据尝试更高级的方法，那么查看<strong class="ls jk">克里金回归</strong>可能会很有意思，它使用其他解释变量(例如建筑物的建造年份)将克里金与回归结合起来。</p><p id="f693" class="pw-post-body-paragraph lq lr jj ls b lt mm kk lv lw mn kn ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">此外，如果您喜欢这篇文章，您可能也会对另外两篇文章感兴趣:</p><div class="is it gp gr iu nz"><a rel="noopener follow" target="_blank" href="/sampling-methods-for-data-science-ddfeb5b3c8ed"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd jk gy z fp oe fr fs of fu fw ji bi translated">数据科学的抽样方法</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">从人群中获取样本的最好方法是什么？</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on ja nz"/></div></div></a></div><div class="is it gp gr iu nz"><a rel="noopener follow" target="_blank" href="/how-can-you-improve-your-machine-learning-model-quality-b22737d4fe5f"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd jk gy z fp oe fr fs of fu fw ji bi translated">如何提高你的机器学习模型质量？</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">数据科学家减少分类 ML 模型错误的逐步方法</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oo l ok ol om oi on ja nz"/></div></div></a></div><blockquote class="op oq or"><p id="53e3" class="lq lr ny ls b lt mm kk lv lw mn kn ly os mo mb mc ot mp mf mg ou mq mj mk ml im bi translated">如果你想进一步讨论，请随时通过<a class="ae jg" href="https://www.linkedin.com/in/melloarthur/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我，这将是我的荣幸(老实说)。</p></blockquote></div></div>    
</body>
</html>