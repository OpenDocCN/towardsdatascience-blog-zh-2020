<html>
<head>
<title>Training a recommendation model for Google Analytics data using BigQuery ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery ML为Google Analytics数据训练推荐模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/training-a-recommendation-model-for-google-analytics-data-using-bigquery-ml-2327f9a2e8e9?source=collection_archive---------27-----------------------#2020-04-21">https://towardsdatascience.com/training-a-recommendation-model-for-google-analytics-data-using-bigquery-ml-2327f9a2e8e9?source=collection_archive---------27-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="10a4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">协同过滤推荐报纸文章</h2></div><p id="3f89" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章演示了如何实现一个WALS(矩阵分解)模型来进行协同过滤。对于协同过滤，我们不需要知道任何关于用户或内容的信息。本质上，我们需要知道的只是userId、itemId和特定用户对特定项目的评价。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/2531d2e3a3eb00adb288c05d80585a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HgAeKyKqxf-dRyO3wFNbAw.jpeg"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图片由<a class="ae lr" href="https://pixabay.com/illustrations/news-newspaper-globe-read-paper-1074604/" rel="noopener ugc nofollow" target="_blank"> geralt </a> (cc0)提供</p></figure><h2 id="d1da" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">使用花费在页面上的时间作为评级</h2><p id="061d" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">在这种情况下，我们正在处理报纸文章。该公司不会要求用户给文章打分。然而，我们可以用花在网页上的时间来代替评分。</p><p id="3dec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是获取每个用户在每篇报纸文章上花费的持续时间的查询(通常，我们还会添加一个时间过滤器(“最近7天”)，但我们的数据集本身仅限于几天。):</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="4073" class="ls lt iq mr b gy mv mw l mx my">WITH CTE_visitor_page_content AS (<br/>    SELECT<br/>        # Schema: <a class="ae lr" href="https://support.google.com/analytics/answer/3437719?hl=en" rel="noopener ugc nofollow" target="_blank">https://support.google.com/analytics/answer/3437719?hl=en</a><br/>        # For a completely unique visit-session ID, we combine combination of fullVisitorId and visitNumber:<br/>        CONCAT(fullVisitorID,'-',CAST(visitNumber AS STRING)) AS visitorId,<br/>        (SELECT MAX(IF(index=10, value, NULL)) FROM UNNEST(hits.customDimensions)) AS latestContentId,  <br/>        (LEAD(hits.time, 1) OVER (PARTITION BY fullVisitorId ORDER BY hits.time ASC) - hits.time) AS session_duration <br/>    FROM<br/>        `cloud-training-demos.GA360_test.ga_sessions_sample`,   <br/>        UNNEST(hits) AS hits<br/>    WHERE <br/>        # only include hits on pages<br/>        hits.type = "PAGE"<br/>GROUP BY   <br/>        fullVisitorId,<br/>        visitNumber,<br/>        latestContentId,<br/>        hits.time )<br/>      <br/>-- Aggregate web stats<br/>SELECT   <br/>    visitorId,<br/>    latestContentId as contentId,<br/>    SUM(session_duration) AS session_duration<br/>FROM<br/>    CTE_visitor_page_content<br/>WHERE<br/>    latestContentId IS NOT NULL <br/>GROUP BY<br/>    visitorId, <br/>    latestContentId<br/>HAVING <br/>    session_duration &gt; 0<br/>LIMIT 10</span></pre><p id="f7af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果看起来像这样:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/92242bf6dcc55b9f9b8a72c2ac81e308.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*lxTfZeY2h6u8KmycHFZbSw.png"/></div></figure><h2 id="bcc0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">将评级字段缩放至[0，1]</h2><p id="c674" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们希望花更多时间看一篇文章的访问者会更喜欢它。然而，会话持续时间可能有点可笑。注意第3行显示的55440秒(15小时)。我们可以绘制数据集中会话持续时间的直方图:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi na"><img src="../Images/1bc673e4c8e4f68e5b0dca15b3e06d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*eI9Ws02ala8ndE3VckyWvw.png"/></div></figure><p id="8c0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，让我们按会话持续时间的中位数(平均持续时间将受到异常值的显著影响)来缩放和裁剪它的值:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="caeb" class="ls lt iq mr b gy mv mw l mx my">...</span><span id="daed" class="ls lt iq mr b gy nb mw l mx my">normalized_session_duration AS (<br/>    SELECT APPROX_QUANTILES(session_duration,100)[OFFSET(50)] AS median_duration<br/>    FROM aggregate_web_stats<br/>)<br/>SELECT<br/>   * EXCEPT(session_duration, median_duration),<br/>   CLIP(0.3 * session_duration / median_duration, 0, 1.0) AS normalized_session_duration<br/>FROM<br/>   aggregate_web_stats, normalized_session_duration</span></pre><p id="2b84" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中剪辑定义如下:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="675d" class="ls lt iq mr b gy mv mw l mx my">CREATE TEMPORARY FUNCTION CLIP_LESS(x FLOAT64, a FLOAT64) AS (<br/>  IF (x &lt; a, a, x)<br/>);<br/>CREATE TEMPORARY FUNCTION CLIP_GT(x FLOAT64, b FLOAT64) AS (<br/>  IF (x &gt; b, b, x)<br/>);<br/>CREATE TEMPORARY FUNCTION CLIP(x FLOAT64, a FLOAT64, b FLOAT64) AS (<br/>  CLIP_GT(CLIP_LESS(x, a), b)<br/>);</span></pre><p id="5e58" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，会话持续时间已调整，并在正确的范围内:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/14a825ecb48131dd6aef1261f4c2b850.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*fASfeoTMHNUDGCioE1knUg.png"/></div></figure><p id="d1b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将所有东西放在一起，并将其具体化为表格:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="5707" class="ls lt iq mr b gy mv mw l mx my">CREATE TEMPORARY FUNCTION CLIP_LESS(x FLOAT64, a FLOAT64) AS (<br/>  IF (x &lt; a, a, x)<br/>);<br/>CREATE TEMPORARY FUNCTION CLIP_GT(x FLOAT64, b FLOAT64) AS (<br/>  IF (x &gt; b, b, x)<br/>);<br/>CREATE TEMPORARY FUNCTION CLIP(x FLOAT64, a FLOAT64, b FLOAT64) AS (<br/>  CLIP_GT(CLIP_LESS(x, a), b)<br/>);<br/>    <br/>CREATE OR REPLACE TABLE advdata.ga360_recommendations_data<br/>AS<br/>WITH CTE_visitor_page_content AS (<br/>    SELECT<br/>        # Schema: <a class="ae lr" href="https://support.google.com/analytics/answer/3437719?hl=en" rel="noopener ugc nofollow" target="_blank">https://support.google.com/analytics/answer/3437719?hl=en</a><br/>        # For a completely unique visit-session ID, we combine combination of fullVisitorId and visitNumber:<br/>        CONCAT(fullVisitorID,'-',CAST(visitNumber AS STRING)) AS visitorId,<br/>        (SELECT MAX(IF(index=10, value, NULL)) FROM UNNEST(hits.customDimensions)) AS latestContentId,  <br/>        (LEAD(hits.time, 1) OVER (PARTITION BY fullVisitorId ORDER BY hits.time ASC) - hits.time) AS session_duration <br/>    FROM<br/>        `cloud-training-demos.GA360_test.ga_sessions_sample`,   <br/>        UNNEST(hits) AS hits<br/>    WHERE <br/>        # only include hits on pages<br/>        hits.type = "PAGE"<br/>GROUP BY   <br/>        fullVisitorId,<br/>        visitNumber,<br/>        latestContentId,<br/>        hits.time ),<br/>aggregate_web_stats AS (      <br/>-- Aggregate web stats<br/>SELECT   <br/>    visitorId,<br/>    latestContentId as contentId,<br/>    SUM(session_duration) AS session_duration<br/>FROM<br/>    CTE_visitor_page_content<br/>WHERE<br/>    latestContentId IS NOT NULL <br/>GROUP BY<br/>    visitorId, <br/>    latestContentId<br/>HAVING <br/>    session_duration &gt; 0<br/>),<br/>normalized_session_duration AS (<br/>    SELECT APPROX_QUANTILES(session_duration,100)[OFFSET(50)] AS median_duration<br/>    FROM aggregate_web_stats<br/>)<br/>SELECT<br/>   * EXCEPT(session_duration, median_duration),<br/>   CLIP(0.3 * session_duration / median_duration, 0, 1.0) AS normalized_session_duration<br/>FROM<br/>   aggregate_web_stats, normalized_session_duration</span></pre><h2 id="a928" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">培训推荐模型</h2><p id="0848" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">表格数据现在看起来像这样:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/d0151c9421c19db9470c5852adc4e16e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*feuqKsxH1GCewKpeG2K9fw.png"/></div></figure><p id="6bf3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以按如下方式训练模型:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="c475" class="ls lt iq mr b gy mv mw l mx my">CREATE OR REPLACE MODEL advdata.ga360_recommendations_model<br/>OPTIONS(model_type='matrix_factorization', <br/>        user_col='visitorId', item_col='contentId',<br/>        rating_col='normalized_session_duration',<br/>        l2_reg=10)<br/>AS<br/>SELECT * from advdata.ga360_recommendations_data</span></pre><p id="b58d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ne">注意:如果您正在使用按需定价计划，您将会收到一条错误消息“训练矩阵分解模型不可用于按需使用。Totrain，请根据BigQuery公共文档中的说明设置预订(弹性或常规)。”。这是因为当基于数据定价时，矩阵分解往往变得昂贵。灵活插槽基于计算进行定价，而且便宜得多。所以，</em> <a class="ae lr" href="https://medium.com/google-cloud/using-bigquery-flex-slots-to-run-machine-learning-workloads-more-efficiently-7fc7f400f7a7" rel="noopener"> <em class="ne">设置</em> <strong class="kh ir"> <em class="ne"> flex </em> </strong> <em class="ne">槽位</em></a><em class="ne">——你可以使用它们少至60秒。</em></p><p id="6d32" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将使用l2_reg的值，它会为您的数据集产生合理的误差。你怎么知道合理？检查评估选项卡:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/3194bae9e0ce28e36da3f9f9cef8394e.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*eV_3tBDrJ3kzWdeuemGuyw.png"/></div></figure><p id="56e8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您希望平均值和中位数绝对误差相似，并且比0.5小得多(随机概率将是0.5)。</p><h2 id="4f02" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">做预测</h2><p id="158e" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">以下是如何为每个用户找到前3条建议:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="276f" class="ls lt iq mr b gy mv mw l mx my">SELECT <br/>  visitorId, <br/>  ARRAY_AGG(STRUCT(contentId, predicted_normalized_session_duration)<br/>            ORDER BY predicted_normalized_session_duration DESC<br/>            LIMIT 3)<br/>FROM ML.RECOMMEND(MODEL advdata.ga360_recommendations_model)<br/>WHERE predicted_normalized_session_duration &lt; 1<br/>GROUP BY visitorId</span></pre><p id="3d2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这会产生:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ng"><img src="../Images/bd4c68ff48a24bde8755c956bf496bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_2lzWInX6jP0fwA9ujl4Q.png"/></div></div></figure><p id="b51e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><p id="33cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ne">非常感谢卢卡·塞姆普雷和伊万·琼斯帮助弄清楚谷歌分析数据。</em></p></div></div>    
</body>
</html>