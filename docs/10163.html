<html>
<head>
<title>Build with PyCaret : Deploy on Microsoft Azure Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PyCaret 构建:在 Microsoft Azure 平台上部署</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-azure-7835678c7c86?source=collection_archive---------41-----------------------#2020-07-17">https://towardsdatascience.com/deploy-azure-7835678c7c86?source=collection_archive---------41-----------------------#2020-07-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="436e" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">实用教程</h2><div class=""/><div class=""><h2 id="199c" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">将机器学习模型部署到 Microsoft Azure 平台</h2></div><p id="afda" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在这个故事中，我开发了一个工作教程，在微软的 Azure 云平台上部署一个用<code class="fe ln lo lp lq b">pycaret</code>库训练的模型。在我之前的文章<a class="ae lr" rel="noopener" target="_blank" href="/build-pycaret-deploy-gcp-521415a6c330">用 PyCaret 构建:在 Google 云平台</a>上部署中，我们已经学习了如何在 Google 云上部署模型。我们将在本教程中使用相同的示例，并在 Microsoft Azure 平台上部署该模型。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/ec18d27921da3cece591297cbb99d833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QIcMMOv5OSujb5z0wyBwIg.png"/></div></div></figure><p id="3b98" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们学习把用<code class="fe ln lo lp lq b">pycaret</code>训练的模型部署到微软 Azure 平台上。<code class="fe ln lo lp lq b">pycaret</code>支持在 AWS 上部署训练有素的模型，但目前不支持 GCP 或 Azure。我遵循了类似于 library 中使用的代码实践，用<a class="ae lr" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS </a>部署和加载模型，在微软的 Azure 平台上部署模型。</p><p id="6c4e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">PyCaret 是 Python 中的一个开源、低代码机器学习库，允许您在几秒钟内从准备数据到在您选择的笔记本环境中部署模型。<a class="ae lr" href="https://www.pycaret.org" rel="noopener ugc nofollow" target="_blank">来源</a></p><p id="f0aa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">PyCaret 是公民数据科学家的 autoML 框架，在其官方文档和主页中使用。这是一个相对较新的库，几个月前发布供公众使用，目前仍在积极开发中。在浏览了一些源代码后，我意识到当前的公开版本缺乏对 Google 和 Azure 云平台的训练/最终模型部署的支持。不过，它支持在 Amazon web services 上部署。</p><p id="f899" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">微软 Azure 是另一个非常受欢迎的云服务框架，目标市场不同于谷歌和 AWS。Azure 已经拥有庞大的客户群，并获得了合理的市场份额。在我看来，对于公民数据科学家来说，大概微软 Azure 是最好的起点。让我们学习如何在 Microsoft Azure 上部署模型。</p><p id="76f8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于本教程，我们将使用<a class="ae lr" href="https://pycaret.org/reg101/" rel="noopener ugc nofollow" target="_blank">回归教程(REG101) —初级初学者</a>进行模型训练。</p><h2 id="e405" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">正在安装 pycaret</h2><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="5adf" class="me mf it lq b gy na nb l nc nd">!pip install pycaret</span></pre><h2 id="2a86" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">安装 Gdrive</h2><p id="20a3" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">我们需要安装 google drive 来读取 colab 环境中的数据。下面是最简单的安装方法。您将被要求输入访问过程生成的令牌。这里是关于<a class="ae lr" href="https://medium.com/@prajwal.prashanth22/google-colab-drive-as-persistent-storage-for-long-training-runs-cb82bc1d5b71" rel="noopener">安装 gdrive </a>的文章的链接</p><p id="f5ce" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在本教程中，我们将在 Google drive 上本地保存模型。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="2d46" class="me mf it lq b gy na nb l nc nd">from google.colab import drive<br/>drive.mount('/content/drive')</span><span id="99a4" class="me mf it lq b gy nj nb l nc nd">Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount("/content/drive", force_remount=True).</span></pre><p id="bd48" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们创建一个目录来本地保存模型。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="f2a6" class="me mf it lq b gy na nb l nc nd"># Create directory on google drive to save models locally. You can use temp paths.<br/>import os<br/>model_dir = '/content/drive/My Drive/azure_deploy_model/'<br/>os.makedirs(model_dir, exist_ok=True)</span></pre><h1 id="a207" class="nk mf it bd mg nl nm nn mj no np nq mm ki nr kj mp kl ns km ms ko nt kp mv nu bi translated">获取数据</h1><p id="00b7" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">您可以从这里找到的原始源<a class="ae lr" href="https://github.com/DardenDSC/sarah-gets-a-diamond" rel="noopener ugc nofollow" target="_blank"><strong class="kt jd"/></a>下载数据，并使用 pandas <a class="ae lr" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kt jd">(了解如何使用)</strong> </a>加载数据，或者您可以使用 PyCaret 的数据存储库，使用<code class="fe ln lo lp lq b">get_data()</code>函数加载数据(这将需要互联网连接)。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="dabf" class="me mf it lq b gy na nb l nc nd">from pycaret.datasets import get_data<br/>dataset = get_data('diamond')</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/66446cbf687a18a102c1fe15260841ce.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0zsEfrfrCHDKqXlN04hFjA.png"/></div></figure><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="a8e6" class="me mf it lq b gy na nb l nc nd">#check the shape of data<br/>dataset.shape</span><span id="2f4c" class="me mf it lq b gy nj nb l nc nd">(6000, 8)</span><span id="e920" class="me mf it lq b gy nj nb l nc nd">data = dataset.sample(frac=0.9, random_state=786).reset_index(drop=True)<br/>data_unseen = dataset.drop(data.index).reset_index(drop=True)<br/><br/>print('Data for Modeling: ' + str(data.shape))<br/>print('Unseen Data For Predictions: ' + str(data_unseen.shape))</span><span id="0128" class="me mf it lq b gy nj nb l nc nd">Data for Modeling: (5400, 8)<br/>Unseen Data For Predictions: (600, 8)</span></pre><h1 id="e534" class="nk mf it bd mg nl nm nn mj no np nq mm ki nr kj mp kl ns km ms ko nt kp mv nu bi translated">在 PyCaret 中设置环境</h1><p id="e536" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">让我们使用 pycaret 的设置模块设置建模管道。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="7c7c" class="me mf it lq b gy na nb l nc nd">from pycaret.regression import *</span><span id="4b46" class="me mf it lq b gy nj nb l nc nd">exp_reg101 = setup(data = data, target = 'Price', session_id=123)</span><span id="e170" class="me mf it lq b gy nj nb l nc nd">Setup Successfully Completed!</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/cd48414f2699aa99836c8cc2d473ced7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZYEDD5gQbj9U7twC93g5LQ.png"/></div></figure><h2 id="88a4" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">创建一个轻型 GBM 模型</h2><p id="58fe" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">对于本教程，我们使用 pycaret 中实现的许多选项中的轻量级 GBM 对数据进行建模。您可以选择任何您喜欢的模型，但这不是本教程的重点。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="d6b0" class="me mf it lq b gy na nb l nc nd">lightgbm = create_model('lightgbm')</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/c81f1f42e47cda2b366ac5b8174515d0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8tBv6VUE5oNRZf1APwhAhg.png"/></div></figure><h2 id="d1ce" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">调谐光梯度增强机</h2><p id="59ac" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">让我们来训练这个模型，用 pycaret 的术语来说，这个模型也被称为调整模型。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="608a" class="me mf it lq b gy na nb l nc nd">tuned_lightgbm = tune_model('lightgbm')</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/f1e4fa9d3365c331cd2c323310fd1350.png" data-original-src="https://miro.medium.com/v2/format:webp/1*d286OlD7mjiE6GaBudIhpw.png"/></div></figure><h2 id="b4be" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">残差图</h2><p id="8748" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">下图显示了模型的残差</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="6a22" class="me mf it lq b gy na nb l nc nd">plot_model(tuned_lightgbm)</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/354daee46e7b0e89bb33865a2d8af5ca.png" data-original-src="https://miro.medium.com/v2/format:webp/1*XMJ-ftbPicwpxkl4csGvaw.png"/></div></figure><p id="ac13" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">预测误差图用于绘制目标的预测误差与真实值。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="a8c9" class="me mf it lq b gy na nb l nc nd">plot_model(tuned_lightgbm, plot = 'error')</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/932b7845482aa0aaaaebf3d9a8730c93.png" data-original-src="https://miro.medium.com/v2/format:webp/1*K6vDHlh-33TDBGpSg4xJfg.png"/></div></figure><h2 id="663f" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">特征重要性图</h2><p id="e2b9" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">特征重要性是非常有用的图，可以看到模型中每个特征的贡献。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="8b7e" class="me mf it lq b gy na nb l nc nd">plot_model(tuned_lightgbm, plot='feature')</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/871225bde4dc4b05464bc176a48ad62c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*N4wWX3DhJDvek9IDZLh1gw.png"/></div></figure><p id="8f3a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><em class="nw">分析模型性能的另一种</em>方法是使用<code class="fe ln lo lp lq b">evaluate_model()</code>功能，该功能显示给定模型所有可用图的用户界面。它在内部使用<code class="fe ln lo lp lq b">plot_model()</code>功能。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="b956" class="me mf it lq b gy na nb l nc nd">evaluate_model(tuned_lightgbm)</span><span id="34e0" class="me mf it lq b gy nj nb l nc nd">interactive(children=(ToggleButtons(description='Plot Type:', icons=('',), options=(('Hyperparameters', 'param…</span></pre><h2 id="b4d3" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">根据测试/保留样本进行预测</h2><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="9767" class="me mf it lq b gy na nb l nc nd">predict_model(tuned_lightgbm);</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/94c6d10cb3df4ac900dfa5f455540763.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_oQ7cXKxMZiJTp3Gh0PQUg.png"/></div></figure><h2 id="801e" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">最终确定用于部署的模型</h2><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="8b88" class="me mf it lq b gy na nb l nc nd">final_lightgbm = finalize_model(tuned_lightgbm)</span><span id="459e" class="me mf it lq b gy nj nb l nc nd">#Final Light Gradient Boosting Machine parameters for deployment<br/>print(final_lightgbm)</span><span id="9a43" class="me mf it lq b gy nj nb l nc nd">LGBMRegressor(boosting_type='gbdt', class_weight=None, colsample_bytree=1.0,<br/>              importance_type='split', learning_rate=0.4, max_depth=10,<br/>              min_child_samples=20, min_child_weight=0.001, min_split_gain=0.9,<br/>              n_estimators=90, n_jobs=-1, num_leaves=10, objective=None,<br/>              random_state=123, reg_alpha=0.9, reg_lambda=0.2, silent=True,<br/>              subsample=1.0, subsample_for_bin=200000, subsample_freq=0)</span><span id="ecdf" class="me mf it lq b gy nj nb l nc nd">predict_model(final_lightgbm)</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/0f461a17603a143160ec0e877fe366f0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cvr3tDKItHh_ukc83zIBPA.png"/></div></figure><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/f6b4e90e43e4a3ee4acf637346bb32da.png" data-original-src="https://miro.medium.com/v2/format:webp/1*fBtRYBD96IAcc4ZzouL72g.png"/></div></figure><h2 id="5852" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">根据看不见的数据预测</h2><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="a87b" class="me mf it lq b gy na nb l nc nd">unseen_predictions = predict_model(final_lightgbm, data=data_unseen)<br/>unseen_predictions.head()</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><p id="06af" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><code class="fe ln lo lp lq b">Label</code>列被添加到<code class="fe ln lo lp lq b">data_unseen</code>集合中。标签是使用<code class="fe ln lo lp lq b">final_lightgbm</code>模型的预测值。如果您想对预测进行四舍五入，您可以在<code class="fe ln lo lp lq b">predict_model()</code>中使用<code class="fe ln lo lp lq b">round</code>参数。</p><h2 id="d4b0" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">保存模型</h2><p id="0f4f" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">让我们首先在本地保存模型</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="b568" class="me mf it lq b gy na nb l nc nd">model_dir<br/>model_name = 'Final_lightgbm_model'</span><span id="7f42" class="me mf it lq b gy nj nb l nc nd">'/content/drive/My Drive/azure_deploy_model/'</span><span id="4076" class="me mf it lq b gy nj nb l nc nd"># Saving model to google drive<br/><br/>save_model(final_lightgbm, model_dir + model_name)</span><span id="4c27" class="me mf it lq b gy nj nb l nc nd">Transformation Pipeline and Model Successfully Saved</span></pre><h2 id="ab54" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">加载保存的模型</h2><p id="366a" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">为了在将来的某一天在相同或不同的环境中加载已保存的模型，我们将使用 PyCaret 的<code class="fe ln lo lp lq b">load_model()</code>函数，然后轻松地将已保存的模型应用于新的未知数据进行预测。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="92b7" class="me mf it lq b gy na nb l nc nd">saved_final_lightgbm = load_model(model_dir + model_name)</span><span id="4253" class="me mf it lq b gy nj nb l nc nd">Transformation Pipeline and Model Successfully Loaded</span></pre><p id="4ed8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一旦模型加载到环境中，您就可以使用相同的<code class="fe ln lo lp lq b">predict_model()</code>函数简单地使用它来预测任何新数据。下面我们应用了加载模型来预测我们在上面第 13 节中使用的相同的<code class="fe ln lo lp lq b">data_unseen</code>。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="7876" class="me mf it lq b gy na nb l nc nd">new_prediction = predict_model(saved_final_lightgbm, data=data_unseen)</span><span id="254b" class="me mf it lq b gy nj nb l nc nd">new_prediction.head()</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><p id="085d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">注意<code class="fe ln lo lp lq b">unseen_predictions</code>和<code class="fe ln lo lp lq b">new_prediction</code>的结果是相同的。</p><h1 id="72b5" class="nk mf it bd mg nl nm nn mj no np nq mm ki nr kj mp kl ns km ms ko nt kp mv nu bi translated">在 Microsoft Azure 上部署训练模型</h1><p id="b14d" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">微软 Azure 是最大的云提供商之一，在云即服务上提供机器学习。在我之前的文章中，我已经介绍了将模型部署到 Google 云平台。图书馆已经支持亚马逊网络服务部署。</p><p id="c17e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一旦我们有了训练好的模型，下一个任务就是部署它来为客户服务。有各种可用的部署选项，但是在本节中，我将重点关注在 Microsoft Azure 平台上部署它。我尝试使用类似于<code class="fe ln lo lp lq b">pycaret</code>库中的方法在 AWS 上部署。</p><h2 id="9368" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">先决条件</h2><p id="315c" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">在 Azure cloud 上部署 ml 模型的先决条件是</p><ul class=""><li id="1fa1" class="nx ny it kt b ku kv kx ky la nz le oa li ob lm oc od oe of bi translated">熟悉微软 Azure 平台</li><li id="110c" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">Microsoft Azure 帐户</li><li id="9c0e" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">基本了解存储容器及其命令行工具</li><li id="f0ef" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">使用 pycaret 的最终训练模型</li></ul><blockquote class="ol om on"><p id="2a6e" class="kr ks nw kt b ku kv kd kw kx ky kg kz oo lb lc ld op lf lg lh oq lj lk ll lm im bi translated"><a class="ae lr" href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-python?toc=%2Fpython%2Fazure%2FTOC.json" rel="noopener ugc nofollow" target="_blank">阅读快速入门指南:使用 Python v12 SDK 管理 blobs】</a></p></blockquote><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="c662" class="me mf it lq b gy na nb l nc nd">import os, uuid<br/>from azure.storage.blob import BlobServiceClient, BlobClient, ContainerClient</span></pre><p id="22d4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><strong class="kt jd"><em class="nw">AZURE _ STORAGE _ CONNECTION _ STRING</em></strong>是连接到 AZURE 存储 blob 的身份验证字符串。您可以在您的环境中设置该字符串，并且可以随时使用。另一种选择是，只要需要连接，就输入字符串。</p><blockquote class="ol om on"><p id="d0ee" class="kr ks nw kt b ku kv kd kw kx ky kg kz oo lb lc ld op lf lg lh oq lj lk ll lm im bi translated">微软 Azure 存储容器相当于谷歌云存储桶</p></blockquote><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="7b6a" class="me mf it lq b gy na nb l nc nd"># add the connection string in environment<br/><br/># Linux<br/>! export AZURE_STORAGE_CONNECTION_STRING="&lt;yourconnectionstring&gt;"<br/><br/># After you add the environment variable, restart any running programs that will need to read the environment variable. For example, restart your development environment or editor before continuing.<br/><br/># Retrieve the connection string for use with the application. The storage<br/># connection string is stored in an environment variable on the machine<br/># running the application called AZURE_STORAGE_CONNECTION_STRING. If the environment variable is<br/># created after the application is launched in a console or with Visual Studio,<br/># the shell or application needs to be closed and reloaded to take the<br/># environment variable into account.<br/>connect_str_env = os.getenv('AZURE_STORAGE_CONNECTION_STRING')</span></pre><p id="4eae" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">您可以使用下面的表单在 google colab 中输入您的连接字符串</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="aff1" class="me mf it lq b gy na nb l nc nd">## Enter connection string when running in google colab<br/>connect_str = 'Enter Connection String Here' #@param {type:"string"}<br/>print(connect_str)</span></pre><p id="1446" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">若要创建到 blob 容器的连接，请使用下面的命令创建服务客户端对象。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="b219" class="me mf it lq b gy na nb l nc nd"># Create the BlobServiceClient object which will be used to create a container client<br/>blob_service_client = BlobServiceClient.from_connection_string(connect_str)</span></pre><p id="62dd" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我写了/收集了下面的实用程序来从 blobs 上传/下载数据。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="f6bb" class="me mf it lq b gy na nb l nc nd">def create_container(container_name):<br/><br/>  # Create the container<br/>  container_client = blob_service_client.create_container(container_name)<br/><br/>  return container_client<br/><br/>def upload_blob(container_name, source_file_name, destination_blob_name):<br/><br/>  # Create a blob client using the local file name as the name for the blob<br/>  blob_client = blob_service_client.get_blob_client(container=container_name, blob=destination_blob_name)<br/><br/>  print("\nUploading to Azure Storage as blob:\n\t" + source_file_name)<br/><br/>  # Upload the created file<br/>  with open(source_file_name, "rb") as data:<br/>      blob_client.upload_blob(data)<br/><br/>def download_blob(container_name, source_blob_name, destination_file_name):<br/>  # Download the blob to a local file<br/>  print("\nDownloading blob to \n\t" + destination_file_name)<br/><br/>  # Create a blob client using the local file name as the name for the blob<br/>  blob_client = blob_service_client.get_blob_client(container=container_name, blob=source_blob_name)<br/><br/>  if destination_file_name is not None: <br/>        with open(destination_file_name, "wb") as download_file:<br/>          download_file.write(blob_client.download_blob().readall())<br/><br/>        print(<br/>            "Blob {} downloaded to {}.".format(<br/>                source_blob_name, destination_file_name<br/>            )<br/>        )</span></pre><h2 id="2b89" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">将模型保存到 Azure 容器</h2><p id="aaa8" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">使用上面的工具，使用下面的代码将模型上传到 Azure-container。在上传之前，我们创建容器，如果以前没有这样做。</p><blockquote class="ol om on"><p id="ba44" class="kr ks nw kt b ku kv kd kw kx ky kg kz oo lb lc ld op lf lg lh oq lj lk ll lm im bi translated">也可以使用 GUI 创建容器。</p></blockquote><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="9093" class="me mf it lq b gy na nb l nc nd"># Create a unique name for the container<br/>container_name = "pycaret" + str(uuid.uuid4())<br/>container_client = create_container(container_name)<br/><br/># Save Model Local/google drive and upload to Azure<br/>model_name_azure = 'lightgbm-reg101-azure'<br/>save_model(final_lightgbm, model_name= model_dir + model_name_azure, verbose=False)<br/>model_src = model_dir + model_name_azure +'.pkl'<br/>model_dst = str(model_name)+'.pkl'</span><span id="0a8b" class="me mf it lq b gy nj nb l nc nd">upload_blob(CLOUD_PROJECT, bucket_name, model_src, model_dst)</span><span id="db6c" class="me mf it lq b gy nj nb l nc nd">File /content/drive/My Drive/azure_deploy_model/lightgbm-reg101-azure.pkl uploaded to Final_lightgbm_model.pkl.</span></pre><h2 id="262a" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">从 Azure 下载预测模型</h2><p id="c660" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">一旦你的模型上传到 Azure，你可以随时下载来执行预测。我遵循一个简单的流程，首先在本地或 google drive 中下载模型，然后使用<code class="fe ln lo lp lq b">load_model</code>函数加载模型。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="5f5e" class="me mf it lq b gy na nb l nc nd">print("\nListing blobs...")<br/><br/># List the blobs in the container<br/>blob_list = container_client.list_blobs()<br/>for blob in blob_list:<br/>    print("\t" + blob.name)<br/><br/>outfile_name = model_dir + 'lightgbm-reg101-azure-downloaded'<br/>model_azure_src = str(model_name)+'.pkl'<br/>download_blob(container_name, model_azure_src, outfile_name + '.pkl')</span></pre><p id="b2ba" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">使用最近从 Azure 下载的模型来执行预测。</p><pre class="lt lu lv lw gt mw lq mx my aw mz bi"><span id="f059" class="me mf it lq b gy na nb l nc nd"># Loading the model for predictions<br/>azure_final_lightgbm = load_model(outfile_name)</span><span id="04da" class="me mf it lq b gy nj nb l nc nd">Transformation Pipeline and Model Successfully Loaded</span><span id="2c2b" class="me mf it lq b gy nj nb l nc nd"># Predictions from deployed model<br/>new_prediction_azure = predict_model(azure_final_lightgbm, data=data_unseen)</span><span id="8bf7" class="me mf it lq b gy nj nb l nc nd">new_prediction_azure.head()</span></pre><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="ab gu cl nv"><img src="../Images/f0270049870c71f90045df1b8db81f1f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ChAOkXcHqIwE__f04HfQ7w.png"/></div></figure><h1 id="7170" class="nk mf it bd mg nl nm nn mj no np nq mm ki nr kj mp kl ns km ms ko nt kp mv nu bi translated">谷歌 Colab 笔记本</h1><p id="86eb" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">按照下面的谷歌合作笔记本来复制和实践这个指南。</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="or os l"/></div></figure><h1 id="b8d4" class="nk mf it bd mg nl nm nn mj no np nq mm ki nr kj mp kl ns km ms ko nt kp mv nu bi translated">结论</h1><p id="9f2d" class="pw-post-body-paragraph kr ks it kt b ku ne kd kw kx nf kg kz la ng lc ld le nh lg lh li ni lk ll lm im bi translated">在本教程中，我们学习了如何在使用<code class="fe ln lo lp lq b">pycaret</code>库进行培训时将模型部署到 Microsoft Azure。</p><p id="f7b0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">主要目标是使用<code class="fe ln lo lp lq b"><a class="ae lr" href="https://github.com/pycaret/pycaret" rel="noopener ugc nofollow" target="_blank">pycaret</a></code>的内置实用程序从 Azure 部署和加载模型。以下是一些亮点</p><ul class=""><li id="8503" class="nx ny it kt b ku kv kx ky la nz le oa li ob lm oc od oe of bi translated">安装 google drive 以保存模型</li><li id="415f" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">用<code class="fe ln lo lp lq b">pycaret</code>训练回归模型</li><li id="ee88" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">保存和加载经过培训/最终确定的模型 Microsoft Azure</li><li id="4f1a" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">将经过培训/最终确定的模型部署到微软的 Azure 容器</li><li id="870b" class="nx ny it kt b ku og kx oh la oi le oj li ok lm oc od oe of bi translated">使用 Azure 部署的模型来执行预测</li></ul></div></div>    
</body>
</html>