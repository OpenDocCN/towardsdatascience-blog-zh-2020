<html>
<head>
<title>How to: Automate live data to your website with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:使用 Python 将实时数据自动化到您的网站</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-automate-live-data-to-your-website-with-python-f22b76699674?source=collection_archive---------12-----------------------#2020-08-19">https://towardsdatascience.com/how-to-automate-live-data-to-your-website-with-python-f22b76699674?source=collection_archive---------12-----------------------#2020-08-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0d46ea614e679c951310e8cc73d882bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">图片来自 Unsplash</p></figure><p id="4599" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本教程将有助于那些拥有一个在云服务上托管实时数据的网站，但不确定如何完全自动更新实时数据以使网站变得无障碍的人。例如:我托管了一个<a class="ae la" href="http://tsbloxsom.pythonanywhere.com/" rel="noopener ugc nofollow" target="_blank">网站</a>，它在一个交互式仪表板中显示了德克萨斯州 COVID 县的病例数，但我每天都必须运行一个脚本来从德克萨斯州 COVID 网站下载 excel 文件，清理数据，更新用于创建仪表板的 pandas 数据框，将更新的数据上传到我正在使用的云服务，并重新加载我的网站。这很烦人，所以我使用本教程中的步骤来展示我的实时数据网站现在是如何完全自动化的。</p><p id="13a8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我将只介绍如何使用云服务 pythonanywhere 来实现这一点，但是这些步骤可以转移到其他云服务。另一件要注意的事情是，我是网站建设和维护的新手，所以请随时纠正我或给我建设性的反馈。我将假设你对 python、selenium for web scraping、bash 命令有基本的了解，并且你有自己的网站。让我们来看一下将实时数据自动化到您的网站的步骤:</p><ol class=""><li id="6c25" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">使用云服务的 selenium 网络抓取</li><li id="09b0" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">将. part 文件中的下载数据转换为。xlsx 文件</li><li id="5d84" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">使用操作系统 python 包重新加载您的网站</li><li id="e62f" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">安排 python 脚本在 pythonanywhere 中每天运行</li></ol><p id="701d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我将不会浏览我将要展示的一些代码，因为我使用了上一篇教程中的许多相同的代码，这些代码是关于如何使用 python 创建和自动化交互式仪表盘的。我们开始吧！</p><ol class=""><li id="a974" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated"><strong class="ke ir">使用云服务使用 selenium 进行网页抓取</strong></li></ol><p id="af2a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以在你选择的云服务中(我的是 pythonanywhere)，打开一个 python3.7 控制台。我将展示代码块，但所有的代码可以合并成一个脚本，这就是我所做的。此外，代码中的所有文件路径都必须更改为您自己的路径，代码才能正常工作。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="0878" class="ly lz iq lu b gy ma mb l mc md">from pyvirtualdisplay import Display<br/>from selenium import webdriver<br/>import time<br/>from selenium.webdriver.chrome.options import Options</span><span id="0498" class="ly lz iq lu b gy me mb l mc md">with Display():<br/>    # we can now start Firefox and it will run inside the virtual display<br/>    browser = webdriver.Firefox()</span><span id="9a1c" class="ly lz iq lu b gy me mb l mc md"># these options allow selenium to download files<br/>    options = Options()<br/>    options.add_experimental_option("browser.download.folderList",2)<br/>    options.add_experimental_option("browser.download.manager.showWhenStarting", False)<br/>    options.add_experimental_option("browser.helperApps.neverAsk.saveToDisk", "application/octet-stream,application/vnd.ms-excel")</span><span id="6855" class="ly lz iq lu b gy me mb l mc md"># put the rest of our selenium code in a try/finally<br/>    # to make sure we always clean up at the end<br/>    try:<br/>        browser.get('<a class="ae la" href="https://www.dshs.texas.gov/coronavirus/additionaldata/'" rel="noopener ugc nofollow" target="_blank">https://www.dshs.texas.gov/coronavirus/additionaldata/'</a>)</span><span id="3803" class="ly lz iq lu b gy me mb l mc md"># initialize an object to the location on the html page and click on it to download<br/>        link = browser.find_element_by_xpath('/html/body/form/div[4]/div/div[3]/div[2]/div/div/ul[1]/li[1]/a')<br/>        link.click()</span><span id="d4ce" class="ly lz iq lu b gy me mb l mc md"># Wait for 30 seconds to allow chrome to download file<br/>        time.sleep(30)</span><span id="d1c0" class="ly lz iq lu b gy me mb l mc md">print(browser.title)<br/>    finally:<br/>        browser.quit()</span></pre><p id="3ee2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的代码块中，我使用 pyvirtualdisplay 库在 pythonanywhere 中打开了一个 Firefox 浏览器。没有新的浏览器会在你的电脑上弹出，因为它运行在云上。这意味着您应该在没有 display()函数的情况下在您自己的计算机上测试这个脚本，因为在云服务器中很难进行错误处理。然后我下载了一个。xlsx 文件，并将其保存在 pythonanywhere 中的 my /tmp 文件中。要访问/tmp 文件，只需单击“文件”选项卡上的第一个“/”，然后点击“主页文件”按钮。这些都是在 try/finally 块中完成的，所以在脚本运行之后，我们关闭浏览器，这样我们就不会再使用服务器上的任何 cpu 时间。另外需要注意的是，pythonanywhere 只支持一个版本的 selenium: <em class="mf"> 2.53.6。</em>您可以使用下面的 bash 命令降级到 selenium 的这个版本:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="2a90" class="ly lz iq lu b gy ma mb l mc md">pip3.7 install <em class="mf">--user selenium==2.53.6</em></span></pre><p id="e74b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 2。</strong> <strong class="ke ir">将. part 文件中的下载数据转换为。xlsx 文件</strong></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8f4b" class="ly lz iq lu b gy ma mb l mc md">import shutil<br/>import glob<br/>import os</span><span id="4a64" class="ly lz iq lu b gy me mb l mc md"># locating most recent .xlsx downloaded file<br/>list_of_files = glob.glob('/tmp/*.xlsx.part')<br/>latest_file = max(list_of_files, key=os.path.getmtime)<br/>print(latest_file)</span><span id="59ac" class="ly lz iq lu b gy me mb l mc md"># we need to locate the old .xlsx file(s) in the dir we want to store the new xlsx file in<br/>list_of_files = glob.glob('/home/tsbloxsom/mysite/get_data/*.xlsx')<br/>print(list_of_files)</span><span id="15f0" class="ly lz iq lu b gy me mb l mc md"># need to delete old xlsx file(s) so if we download new xlsx file with same name we do not get an error while moving it<br/>for file in list_of_files:<br/>    print("deleting old xlsx file:", file)<br/>    os.remove(file)</span><span id="4943" class="ly lz iq lu b gy me mb l mc md"># move new data into data dir<br/>shutil.move("{}".format(latest_file), "/home/tsbloxsom/mysite/get_data/covid_dirty_data.xlsx")</span></pre><p id="253c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当你下载时。在 pythonanywhere 中，xlsx 文件存储为. xlsx.part 文件。经过一些研究，这些。当您停止完成下载时，会产生零件文件。这些。零件文件不能用典型的工具打开，但是有一个简单的技巧可以解决这个问题。在上面的代码中，我在云目录中自动移动新数据和删除旧数据。需要注意的是，当我移动. xlsx.part 文件时，我将其保存为. xlsx 文件。这会神奇地转换它，当你打开这个新的。xlsx 文件，它有所有的实时数据，这意味着我的脚本下载完成。xlsx 文件，但是 pythonanywhere 在文件中添加了一个. part，这很奇怪，但是很有效。</p><p id="81de" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 3。使用操作系统 python 包重新加载你的网站</strong></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="9013" class="ly lz iq lu b gy ma mb l mc md">import pandas as pd<br/>import re</span><span id="b88b" class="ly lz iq lu b gy me mb l mc md">list_of_files = glob.glob('/home/tsbloxsom/mysite/get_data/*.xlsx')<br/>latest_file = max(list_of_files, key=os.path.getctime)<br/>print(latest_file)</span><span id="51a5" class="ly lz iq lu b gy me mb l mc md">df = pd.read_excel("{}".format(latest_file),header=None)</span><span id="0710" class="ly lz iq lu b gy me mb l mc md"># print out latest COVID data datetime and notes<br/>date = re.findall("- [0-9]+/[0-9]+/[0-9]+ .+", df.iloc[0, 0])<br/>print("COVID cases latest update:", date[0][2:])<br/>print(df.iloc[1, 0])<br/>#print(str(df.iloc[262:266, 0]).lstrip().rstrip())</span><span id="60de" class="ly lz iq lu b gy me mb l mc md">#drop non-data rows<br/>df2 = df.drop([0, 1, 258, 260, 261, 262, 263, 264, 265, 266, 267])</span><span id="055e" class="ly lz iq lu b gy me mb l mc md"># clean column names<br/>df2.iloc[0,:] = df2.iloc[0,:].apply(lambda x: x.replace("\r", ""))<br/>df2.iloc[0,:] = df2.iloc[0,:].apply(lambda x: x.replace("\n", ""))<br/>df2.columns = df2.iloc[0]<br/>clean_df = df2.drop(df2.index[0])<br/>clean_df = clean_df.set_index("County Name")</span><span id="0f27" class="ly lz iq lu b gy me mb l mc md">clean_df.to_csv("/home/tsbloxsom/mysite/get_data/Texas county COVID cases data clean.csv")</span><span id="4e98" class="ly lz iq lu b gy me mb l mc md">df = pd.read_csv("Texas county COVID cases data clean.csv")</span><span id="7970" class="ly lz iq lu b gy me mb l mc md"># convert df into time series where rows are each date and clean up<br/>df_t = df.T<br/>df_t.columns = df_t.iloc[0]<br/>df_t = df_t.iloc[1:]<br/>df_t = df_t.iloc[:,:-2]</span><span id="9a8d" class="ly lz iq lu b gy me mb l mc md"># next lets convert the index to a date time, must clean up dates first<br/>def clean_index(s):<br/>    s = s.replace("*","")<br/>    s = s[-5:]<br/>    s = s + "-2020"<br/>    #print(s)<br/>    return s</span><span id="30ac" class="ly lz iq lu b gy me mb l mc md">df_t.index = df_t.index.map(clean_index)</span><span id="dd0b" class="ly lz iq lu b gy me mb l mc md">df_t.index = pd.to_datetime(df_t.index)</span><span id="dd41" class="ly lz iq lu b gy me mb l mc md"># initalize df with three columns: Date, Case Count, and County<br/>anderson = df_t.T.iloc[0,:]</span><span id="12c2" class="ly lz iq lu b gy me mb l mc md">ts = anderson.to_frame().reset_index()</span><span id="bce6" class="ly lz iq lu b gy me mb l mc md">ts["County"] = "Anderson"<br/>ts = ts.rename(columns = {"Anderson": "Case Count", "index": "Date"})</span><span id="9c57" class="ly lz iq lu b gy me mb l mc md"># This while loop adds all counties to the above ts so we can input it into plotly<br/>x = 1<br/>while x &lt; 254:<br/>    new_ts = df_t.T.iloc[x,:]<br/>    new_ts = new_ts.to_frame().reset_index()<br/>    new_ts["County"] = new_ts.columns[1]<br/>    new_ts = new_ts.rename(columns = {new_ts.columns[1]: "Case Count", "index": "Date"})<br/>    ts = pd.concat([ts, new_ts])<br/>    x += 1</span><span id="4ed6" class="ly lz iq lu b gy me mb l mc md">ts.to_csv("/home/tsbloxsom/mysite/data/time_series_plotly.csv")</span><span id="ce1a" class="ly lz iq lu b gy me mb l mc md">time.sleep(5)</span><span id="dfd2" class="ly lz iq lu b gy me mb l mc md">#reload website with updated data<br/>os.utime('/var/www/tsbloxsom_pythonanywhere_com_wsgi.py')</span></pre><p id="a9b1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我在上一篇<a class="ae la" rel="noopener" target="_blank" href="/creating-and-automating-an-interactive-dashboard-using-python-5d9dfa170206">帖子</a>中解释了上面的大部分代码，这些代码使用熊猫来清理 excel 文件，以便输入到 plotly 仪表板中。本教程最重要的一行是最后一行。os.utime 函数显示文件或 python 脚本的访问和修改时间。但是当你调用 Web 服务器网关接口(WSGI)文件上的函数时，它会重新加载你的网站！</p><p id="a532" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 4。在 pythonanywhere 中安排 python 脚本每天运行</strong></p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/4b100566fcf0d2457431a18eba163085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9tHW7zLTpqJbg-sdh44CpA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><p id="cc2d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在是最简单的部分！将上述代码合并成一个代码后。py 文件，您可以使用 pythonanywhere 的 Task 选项卡让它每天或每小时运行。您所要做的就是复制并粘贴 bash 命令，以及运行。py 文件到上面图片的栏中，点击创建按钮！现在您应该测试。py 文件，看看它是否正确运行。但是现在你有了一个完全自动化的数据抓取脚本，你的网站可以用它来显示每日或每小时更新的数据，而无需你按一个按钮！</p><p id="3e87" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你有任何问题或批评，请在评论中畅所欲言，如果你想在 LinkedIn 上关注我，你可以！</p></div></div>    
</body>
</html>