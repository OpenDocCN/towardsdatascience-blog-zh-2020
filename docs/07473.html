<html>
<head>
<title>Analyzing K-Pop Using Machine Learning | Part 4 —Productionizing the Model (Model Deployment)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用机器学习分析 K-Pop |第 4 部分—生产模型(模型部署)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/analyzing-k-pop-using-machine-learning-part-4-productionizing-the-model-model-deployment-a9fc2e703d95?source=collection_archive---------58-----------------------#2020-06-05">https://towardsdatascience.com/analyzing-k-pop-using-machine-learning-part-4-productionizing-the-model-model-deployment-a9fc2e703d95?source=collection_archive---------58-----------------------#2020-06-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2e65" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/kpop-ml-tutorial" rel="noopener" target="_blank"> K-POP 机器学习教程系列</a></h2><div class=""/><div class=""><h2 id="0e9c" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">这是教程的第 4 部分，我使用 FLASK 将预测模型投入生产。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/dfb9b63022e4a26d9bd501d272c90030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PLwlTCkHrpFNHRBY.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae lh" href="https://unsplash.com/@dandycolor?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">萨维里·博博夫</a>在<a class="ae lh" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d17c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">可以在这里 找到之前的教程<a class="ae lh" href="https://towardsdatascience.com/tagged/kpop-ml-tutorial" rel="noopener" target="_blank"> <strong class="lk jd">。</strong></a></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="me mf l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">视频版本</p></figure><p id="3c53" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="mg">注意:你可以在这篇文章的底部找到整个 GitHub 库的链接。</em></p><p id="ee60" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在本教程中，我将向您展示如何将一个模型投入生产(又名。模型部署)。</p><p id="33a0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">什么是模型部署？模型部署是将机器学习模型集成到现有的生产环境中，以根据数据做出实际的业务决策。</p><p id="d95b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将使用 Python web API 和 FLASK 来部署模型。因此，我们的最终目标是创建一个网站，一旦用户输入了输入值，它就会向您提供预测结果。</p><h1 id="c884" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">从 GitHub 下载我的文件</h1><p id="b60b" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">首先，去我的 GitHub 页面上的 K-Pop 库下载<a class="ae lh" href="https://github.com/importdata/kpop-analysis/tree/master/K-Pop%20Model%20Deployment" rel="noopener ugc nofollow" target="_blank">模型部署文件夹</a>。</p><p id="4338" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将使用名为<a class="ae lh" href="https://kinolien.github.io/gitzip/" rel="noopener ugc nofollow" target="_blank"> GitZip </a>的网站，该网站允许您下载回购中的特定文件夹。您所需要做的就是将链接复制并粘贴到我的模型部署文件夹中。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/6805787a7ad446044d216cf7ec0bc113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*5p97CsymzZLmUPs75N54Sw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">在这里复制并粘贴我的文件夹链接</p></figure><p id="dcce" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以随意命名文件夹。我将把我的命名为“K-Pop 模型部署”</p><h1 id="1f8d" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">使用 Spyder IDE</h1><p id="38f5" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">在本教程中，我们将使用 Spyder IDE。</p><p id="a41b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你还没有安装，你可以从<a class="ae lh" href="https://www.anaconda.com/products/individual" rel="noopener ugc nofollow" target="_blank">这里</a>下载(你需要从 Anaconda 网站下载)。请务必下载 3.7 版本，因为这是最新版本。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nf"><img src="../Images/49500601746ebe71d6acf08957096328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4o3xs_w8mI6sKHnZ0BLdxg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">安装 Anaconda (Python 3.7)</p></figure><p id="8e38" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">安装后，打开 Spyder IDE，导航到“文件资源管理器”并选择您刚刚下载的文件夹。</p><p id="677d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">打开模板文件夹下的 app.py、k_pop_model_building.py 和 index.html。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/9dcbed169085ef3ecdc6189e704627fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*D4VeedcnASWArJC08DRlVg.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Spyder 的文件浏览器</p></figure><h1 id="0e18" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">仅选择连续变量</h1><p id="3cc0" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">在上一篇教程中，我们使用. pd.get_dummies(df_model)将分类变量转换为虚拟/指示变量。我意识到这产生了太多额外的变量，我认为这不是很用户友好(我们不想让用户输入 73 个答案)。因此，我们将只选择连续变量—这样用户只需输入五个变量(“yr_listened”、“daily_MV_hr”、“yr _ merch _ spent”、“age”、“num_gr_like”)来预测“daily _ music _ HR”—他们每天听 K-pop 的小时数。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="aa42" class="nm mi it ni b gy nn no l np nq">df_real = df[[“yr_listened”, “daily_music_hr”, “daily_MV_hr”, <br/>              “yr_merch_spent”, “age”, “num_gr_like”]]</span></pre><p id="da58" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，运行列车并再次测试分离。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="e2c0" class="nm mi it ni b gy nn no l np nq">from sklearn.model_selection import train_test_split</span><span id="dc33" class="nm mi it ni b gy nr no l np nq">X = df_real.drop('daily_music_hr', axis = 1)<br/>y = df_real.daily_music_hr.values</span><span id="aaa8" class="nm mi it ni b gy nr no l np nq">X_train, X_test, y_train, y_test = train_test_split(X, y, <br/>                                   test_size = 0.2, <br/>                                   random_state = 1)</span></pre><h1 id="4692" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">运行 XGBoost 模型</h1><p id="1c0d" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">从上一个教程中，我们看到 XGBoost 模型是最好的一个。因此，我们将部署这种模式。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="68f9" class="nm mi it ni b gy nn no l np nq">import xgboost as xgb</span><span id="a169" class="nm mi it ni b gy nr no l np nq"># initialize the linear regression model<br/>xgb_clf = xgb.sklearn.XGBClassifier(nthread = -1, seed = 1)</span><span id="bca8" class="nm mi it ni b gy nr no l np nq"># train the model<br/>xgb_clf.fit(X_train, y_train)</span><span id="56d0" class="nm mi it ni b gy nr no l np nq"># Tune XGBoost using GridSearchCV</span><span id="f5dd" class="nm mi it ni b gy nr no l np nq">from sklearn.model_selection import GridSearchCV</span><span id="4af9" class="nm mi it ni b gy nr no l np nq">params = {'min_child_weight': [5], 'gamma': [1], <br/>          'subsample': [0.8, 1.0],<br/>          'colsample_bytree': [0.6, 0.8], <br/>          'max_depth': [1,2]}</span><span id="fd71" class="nm mi it ni b gy nr no l np nq">gs_xgb = GridSearchCV(xgb_clf, params ,<br/>                      scoring = 'neg_mean_absolute_error', <br/>                      cv = 10)</span><span id="768d" class="nm mi it ni b gy nr no l np nq">gs_xgb.fit(X_train, y_train)</span><span id="0870" class="nm mi it ni b gy nr no l np nq">gs_xgb.best_score_</span><span id="1cb7" class="nm mi it ni b gy nr no l np nq">xgb_best = gs_xgb.best_estimator_<br/>xgb_best</span><span id="80d1" class="nm mi it ni b gy nr no l np nq">xgb_best.fit(X_train, y_train)</span></pre><h1 id="8e6f" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">保存已训练的模型</h1><p id="4ba3" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">我们可以使用 pickle 将训练好的模型保存到磁盘上。它可以在以后重新加载，就像我们训练过的一样使用。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="b7ba" class="nm mi it ni b gy nn no l np nq"># save the model to disk<br/>with open('model.pkl', 'wb') as file:<br/>    pickle.dump(xgb_best, file)</span></pre><h1 id="c640" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">使用 FLASK 创建 Web 应用程序</h1><p id="4159" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">首先，我们需要这两样东西来创建一个 web 应用程序。</p><ol class=""><li id="16e3" class="ns nt it lk b ll lm lo lp lr nu lv nv lz nw md nx ny nz oa bi translated">Python 脚本将加载训练好的模型，要求用户将输入值放在网站上，执行预测，并返回结果。</li><li id="7592" class="ns nt it lk b ll ob lo oc lr od lv oe lz of md nx ny nz oa bi translated">HTML 模板是网站的格式。这将允许用户输入他们的数据，并将呈现结果。</li></ol><p id="6bde" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其结构如下所示:</p><p id="5a82" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">web app/<br/>index.html├──model/<br/>│└──model . pkl—训练好的模型<br/> ├──模板/<br/>│└──—网站格式<br/> └── app.py —托管模型</p><h1 id="706f" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">创建 app.py 来托管模型</h1><p id="7246" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">app.py 将成为网络应用的主干。它会发送网页，从用户那里获取数据来进行预测。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="0850" class="nm mi it ni b gy nn no l np nq"># use flask to host the model</span><span id="e56b" class="nm mi it ni b gy nr no l np nq">import flask<br/>import pickle<br/>import pandas as pd</span><span id="f344" class="nm mi it ni b gy nr no l np nq"># Use pickle to load in the pre-trained model<br/>with open(f'model.pkl', 'rb') as f:<br/>    model = pickle.load(f)</span><span id="61dd" class="nm mi it ni b gy nr no l np nq"># initialize the flask app<br/>app = flask.Flask(__name__, template_folder='templates')</span><span id="ca96" class="nm mi it ni b gy nr no l np nq"># set up the main route<br/><a class="ae lh" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods=['GET', 'POST'])<br/>def main():<br/>    if flask.request.method == 'GET':<br/>        # rendering the initial form, to get input<br/>        return(flask.render_template('index.html'))<br/>    <br/>    if flask.request.method == 'POST':<br/>        # extracting the input values<br/>        yr_listened = flask.request.form['yr_listened']<br/>        daily_MV_hr = flask.request.form['daily_MV_hr']<br/>        yr_merch_spent = flask.request.form['yr_merch_spent']<br/>        age = flask.request.form['age']<br/>        num_gr_like = flask.request.form['num_gr_like']<br/>        <br/>        # making dataframe for model<br/>        input_variables = pd.DataFrame([[yr_listened, daily_MV_hr, yr_merch_spent, age, num_gr_like]],<br/>                                       columns=['yr_listened', 'daily_MV_hr', 'yr_merch_spent', 'age', 'num_gr_like'],<br/>                                       dtype=float,<br/>                                       index=['input'])<br/>        <br/>        # get the model's prediction<br/>        prediction = model.predict(input_variables)[0]<br/>        output = float(round(prediction, 2))<br/>        <br/>        # render the form again, but add in the prediction and remind user of the values they input before<br/>        return flask.render_template('index.html',<br/>                                     original_input={'yr_listened':yr_listened,<br/>                                                     'daily_MV_hr':daily_MV_hr,<br/>                                                     'yr_merch_spent':yr_merch_spent,<br/>                                                     'age':age,<br/>                                                     'num_gr_like':num_gr_like},<br/>                                     result=float(output)<br/>                                     )<br/>        <br/>if __name__ == "__main__":<br/>    app.run(debug=True)</span></pre><h1 id="3a44" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">创建 index.html 来格式化我们的网站</h1><p id="6212" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">这是这个项目的前端部分。它将要求用户输入值，执行预测，并给我们输出。这是很基础的风格。我试着玩 CSS，但无法真正让它工作。如果你了解 CSS 或者想尝试一下样式，请随意！</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="e314" class="nm mi it ni b gy nn no l np nq">&lt;!doctype html&gt;<br/>&lt;html&gt;<br/>&lt;style&gt;<br/>form {<br/>    margin: auto;<br/>    width: 35%;<br/>}</span><span id="5f3f" class="nm mi it ni b gy nr no l np nq">.result {<br/>    margin: auto;<br/>    width: 35%;<br/>    border: 1px solid #ccc;<br/>}<br/>&lt;/style&gt;</span><span id="00c4" class="nm mi it ni b gy nr no l np nq">&lt;head&gt;<br/>    &lt;title&gt;Predicting Daily K-Pop Listening Hours&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;form action="{{ url_for('main') }}" method="POST"&gt;<br/>    &lt;fieldset&gt;<br/>        &lt;legend&gt;Input values:&lt;/legend&gt;<br/>        Number of years you listened to K-Pop:<br/>        &lt;input name="yr_listened" type="number" step=".01" required&gt;<br/>        &lt;br&gt;<br/>        &lt;br&gt; Number of hours you watch K-Pop MV per day:<br/>        &lt;input name="daily_MV_hr" type="number" step=".01" required&gt;<br/>        &lt;br&gt;<br/>        &lt;br&gt; How much money you spend on K-Pop merchandise a year:<br/>        &lt;input name="yr_merch_spent" type="number" step=".01" required&gt;<br/>        &lt;br&gt;<br/>        &lt;br&gt; Your age:<br/>        &lt;input name="age" type="number" step=".01" required&gt;<br/>        &lt;br&gt;<br/>        &lt;br&gt; Number of groups you like:<br/>        &lt;input name="num_gr_like" type="number" step=".01" required&gt;<br/>        &lt;button type="submit" class="btn btn-primary btn-block btn-large"&gt;Predict!&lt;/button&gt;<br/>    &lt;/fieldset&gt;<br/>&lt;/form&gt;<br/>&lt;br&gt;<br/>&lt;div class="result" align="center"&gt;<br/>    {% if result %}<br/>     {% for variable, value in original_input.items() %}<br/>      &lt;b&gt;{{ variable }}&lt;/b&gt; : {{ value }}<br/>     {% endfor %}<br/>  &lt;br&gt;<br/>     &lt;br&gt; Predicted Daily K-Pop Listening Hours:<br/>     &lt;p style="font-size:50px" step=".01"&gt;{{ result }}&lt;/p&gt;<br/>    {% endif %}<br/>&lt;/div&gt;</span><span id="eb36" class="nm mi it ni b gy nr no l np nq">&lt;/html&gt;</span></pre><h1 id="54d6" class="mh mi it bd mj mk ml mm mn mo mp mq mr ki ms kj mt kl mu km mv ko mw kp mx my bi translated">运行 Web 应用程序</h1><p id="c4a2" class="pw-post-body-paragraph li lj it lk b ll mz kd ln lo na kg lq lr nb lt lu lv nc lx ly lz nd mb mc md im bi translated">现在我们终于可以测试看看是否一切都按照我们想要的方式工作了！</p><ol class=""><li id="374d" class="ns nt it lk b ll lm lo lp lr nu lv nv lz nw md nx ny nz oa bi translated">转到 Anaconda 提示符</li><li id="35b7" class="ns nt it lk b ll ob lo oc lr od lv oe lz of md nx ny nz oa bi translated">将目录更改为您的工作文件夹(即 cd 桌面-&gt; cd K-Pop 模型部署)</li><li id="1d36" class="ns nt it lk b ll ob lo oc lr od lv oe lz of md nx ny nz oa bi translated">运行 app.py(即 python app.py)</li><li id="a7c9" class="ns nt it lk b ll ob lo oc lr od lv oe lz of md nx ny nz oa bi translated">将你得到的链接复制并粘贴到浏览器上</li><li id="536d" class="ns nt it lk b ll ob lo oc lr od lv oe lz of md nx ny nz oa bi translated">输入值，检查它是否给出了预测</li></ol><p id="cff2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Anaconda 提示符命令示例</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="4aa2" class="nm mi it ni b gy nn no l np nq">cd Desktop<br/>cd K-Pop Model Deployment<br/>python app.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi og"><img src="../Images/83e85821a6497312131265bd7c60293c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*R7jGBCIOBBZfPMBvsm7EDw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">工作 Web 应用程序</p></figure><p id="90dd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们完了。希望你觉得这个教程有用！</p><p id="566b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下一个教程中，我将向你展示如何通过创建一个作品集网站来记录这个项目！敬请关注。</p><p id="3d75" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我的<strong class="lk jd"> GitHub 库</strong>就是这里的<a class="ae lh" href="https://github.com/importdata/kpop-analysis" rel="noopener ugc nofollow" target="_blank"><strong class="lk jd"/></a>。</p></div></div>    
</body>
</html>