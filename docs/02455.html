<html>
<head>
<title>Classifier calibration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分类器校准</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/classifier-calibration-7d0be1e05452?source=collection_archive---------2-----------------------#2020-03-09">https://towardsdatascience.com/classifier-calibration-7d0be1e05452?source=collection_archive---------2-----------------------#2020-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5778" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">分类任务模型校准的原因、时间和方式。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/80eab3c0c3ac96663bdcc01f11d4365a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K1dsFIe0wXs58dVqYU3u8A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Christophe Hautier 在<a class="ae ky" href="https://unsplash.com/s/photos/balance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="c17b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">当处理分类问题时，仅收集测试集上的预测是远远不够的；我们通常会带着某种程度的自信来赞美他们。为此，我们利用关联概率，即由分类器计算的可能性，它指定了每个样本的类别。但这总是反映现实吗？如果不是，我们怎么知道？</p><blockquote class="mc md me"><p id="4539" class="lg lh mf li b lj lk ju ll lm ln jx lo mg lq lr ls mh lu lv lw mi ly lz ma mb im bi translated"><a class="ae ky" href="https://www.dimpo.me/newsletter" rel="noopener ugc nofollow" target="_blank">学习率</a>是我每周给那些对 AI 和 MLOps 世界好奇的人发的简讯。你会在每周五收到我关于最新人工智能新闻、研究、回购和书籍的更新和想法。在这里订阅<a class="ae ky" href="https://www.dimpo.me/newsletter" rel="noopener ugc nofollow" target="_blank"/>！</p></blockquote><h1 id="27ff" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">介绍</h1><p id="f415" class="pw-post-body-paragraph lg lh it li b lj nb ju ll lm nc jx lo lp nd lr ls lt ne lv lw lx nf lz ma mb im bi translated">假设我们有两个二元分类器；型号<code class="fe ng nh ni nj b">A</code>和型号<code class="fe ng nh ni nj b">B</code>。模型<code class="fe ng nh ni nj b">A</code>的每一次预测都有 85%的准确率和 0.86 的置信度。另一方面，模型<code class="fe ng nh ni nj b">B</code>也有 85%的准确性，但对其每个预测的置信度为 0.99。你觉得哪个型号比较好？</p><p id="fb40" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这个故事中，我会试着让你相信<code class="fe ng nh ni nj b">A</code>模式更好。模型<code class="fe ng nh ni nj b">A</code>认为自己在 86%的时间里都是精确的，事实上，差不多就是这样。相反，model <code class="fe ng nh ni nj b">B</code>对自己的预测过于自信。这个玩具示例展示了概率和模型校准背后的直觉。</p><p id="ef16" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">模型校准指的是这样一个过程，其中我们采用一个已经训练好的模型，并应用一个后处理操作，这改进了它的概率估计。<strong class="li iu">因此，如果我们以 0.85 的概率检查估计为阳性的样本，我们预计其中 85%实际上是阳性的。</strong></p><blockquote class="nk"><p id="63a8" class="nl nm it bd nn no np nq nr ns nt mb dk translated">从形式上来说，如果对于任何概率值<code class="fe ng nh ni nj b">p</code>，一个类的预测有信心<code class="fe ng nh ni nj b">p</code>在 90%的时间里是正确的<code class="fe ng nh ni nj b">100*p</code>，那么这个模型就是完美校准的。</p></blockquote><p id="ebfd" class="pw-post-body-paragraph lg lh it li b lj nu ju ll lm nv jx lo lp nw lr ls lt nx lv lw lx ny lz ma mb im bi translated">现在，因为如果你试图将一幅图像可视化并绘制出<code class="fe ng nh ni nj b">p</code>的每一个值，那么在从<code class="fe ng nh ni nj b">0</code>到<code class="fe ng nh ni nj b">1</code>的时间间隔内，一幅图像就抵得上千言万语，所以我们期望在计算出的概率和阳性分数之间得到一个完美的线性关系。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/f49b09be0621ef5082454a0b5b3f506b.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*FGkwE_F3IqHu5sO3F6vB0Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">校准完美的分类器</p></figure><p id="56f1" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在接下来的章节中，我们将了解校准分类器的原因、时间和方法。</p><h1 id="31b8" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">为什么模型校准很重要？</h1><p id="9346" class="pw-post-body-paragraph lg lh it li b lj nb ju ll lm nc jx lo lp nd lr ls lt ne lv lw lx nf lz ma mb im bi translated">只有当您关心模型计算的概率时，模型校准才是重要的。例如，假设您正在构建一个推荐引擎，它根据用户偏好对产品进行排序。如果您的模型估计用户<code class="fe ng nh ni nj b">u</code>将以 0.9 的概率购买产品<code class="fe ng nh ni nj b">a</code>，以 0.7 的概率购买商品<code class="fe ng nh ni nj b">b</code>，那么您可以先提供产品<code class="fe ng nh ni nj b">a</code>。不需要校准那个模型。</p><p id="d57a" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">然而，如果您正在构建一个计算一个人生病的概率的关键任务应用程序，那么实际的概率值是非常重要的。例如，如果你的模型对一个特定的病人不那么有信心，人类医生当然应该知道这一点并采取相应的行动。</p><p id="3694" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">模型校准还有其他有用的情况:</p><ul class=""><li id="a3ae" class="oa ob it li b lj lk lm ln lp oc lt od lx oe mb of og oh oi bi translated"><em class="mf">调试:</em>我们想知道什么时候我们的模型是高置信度错误的，或者把低概率分配给正确的类</li><li id="c6a3" class="oa ob it li b lj oj lm ok lp ol lt om lx on mb of og oh oi bi translated"><em class="mf">集合:</em>如果我们想要组合许多概率模型，拥有准确的预测是很重要的</li></ul><h1 id="b4d4" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">如何检查你的模型</h1><p id="2ff8" class="pw-post-body-paragraph lg lh it li b lj nb ju ll lm nc jx lo lp nd lr ls lt ne lv lw lx nf lz ma mb im bi translated">到目前为止，我们已经了解了什么是模型校准，以及为什么它在某些情况下很重要。但是我们如何检查我们的分类器是否被校准了呢？</p><p id="7627" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最好的方法是用我们自己的眼睛去看。在这个实验中，我们使用 scikit-learn 提供的“make_classification”辅助方法创建了一个用于分类的随机数据集。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="259d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，我们实例化两个分类器进行比较；一个简单的逻辑回归模型和一个由 scikit-learn 提供的支持向量机实现。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="afde" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后，我们将分类器拟合到我们的训练数据，并计算我们对测试数据集的预测。特别是对于 SVM，要获得正类的概率，我们需要知道决策函数如何分离测试样本，并将结果归一化为介于“0”和“1”之间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="4ccb" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在让我们为两个分类器绘制<code class="fe ng nh ni nj b">Kernel Density Estimation</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/cbf8d3365e155dcaa697f0b0aabee956.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*iohP7_27dbTob8JCk1CRaA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">逻辑回归 Vs SVM KDE 图</p></figure><p id="29bd" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">正如我们所料，我们从逻辑回归得到的结果是从<code class="fe ng nh ni nj b">0</code>扩散到<code class="fe ng nh ni nj b">1</code>，而 SVM 预测正好是<code class="fe ng nh ni nj b">0</code>或<code class="fe ng nh ni nj b">1</code>。接下来，让我们检查两个二元分类器的 AUC-ROC 曲线，但是这次使用我们为 SVM 计算的概率。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/ba8c2e761f27f77baf70e5fc2956decb.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*doltjESCnb1YsFE-b5sRfQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">逻辑回归与 SVM 曲线</p></figure><p id="ddab" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以看到，SVM 在这个数据集上几乎是完美的。但是精度和校准完全是两码事。我们可以有一个完全精确的模型，根本没有校准，另一方面，一个不比随机模型好的模型，尽管如此，也是完全校准的。那么，我们如何检查呢？</p><p id="f12c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">第一步是获取所有预测并将它们分组到箱中。我们将根据模型做出的概率估计对它们进行分组。接下来，我们计算每个箱的阳性分数，最后计算每个箱的平均置信度，这就是属于该箱的样本的概率估计的平均值。如果我们将平均值与每个箱中阳性部分相对照，我们就得到可靠性图。我们希望该图类似于我们在开始时看到的线性图。</p><p id="8f98" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了绘制每个分类器的校准曲线，我们定义了如下所示的效用函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="035b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们现在准备绘制每个模型的校准曲线。让我们从逻辑回归开始。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/6147b4d6981fca2744aadf918564f8c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*VG9LdPl7sBsdX1GXcGn5-A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">逻辑回归的校准图</p></figure><p id="e1da" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">看起来相当不错。我们为 SVM 做同样的事情。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/b8e7214932d4e8e09a7df6d050f8212a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*I408767g5Nwp10l9tQytKA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SVM 校准图</p></figure><p id="d932" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">很明显，SVM 模型远未校准。当它预测样本不属于正类时，我们可以说它是信心不足，否则就是过于自信。那么，我们该如何解决这个问题呢？</p><h1 id="7d81" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">校准模型</h1><p id="3aeb" class="pw-post-body-paragraph lg lh it li b lj nb ju ll lm nc jx lo lp nd lr ls lt ne lv lw lx nf lz ma mb im bi translated">校准机器学习模型的两种最流行的方法是<code class="fe ng nh ni nj b">isotonic</code>和<code class="fe ng nh ni nj b">Platt's</code>方法。</p><p id="5453" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><code class="fe ng nh ni nj b">Scikit-learn</code>通过<code class="fe ng nh ni nj b">CalibratedClassifierCV</code>类提供校准模型的基本估计器。对于这个例子，我们将使用<code class="fe ng nh ni nj b">Platt's</code>方法，这相当于将类的构造函数中的<code class="fe ng nh ni nj b">method</code>参数设置为<code class="fe ng nh ni nj b">sigmoid</code>。如果你想使用<code class="fe ng nh ni nj b">isotonic</code>方法，你可以传递它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/0ee713e721947e38ebff4d97a66a8a63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*4QgZzzVOfM91n6oGnXhvcw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">校准的 SVM 分类器</p></figure><p id="633c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">SVM 分类器的结果令人印象深刻地不同。现在我们有一个校准的 SVM 分类器。请注意，如果您在 SVM 分类器上调用<code class="fe ng nh ni nj b">predict_proba</code>方法，结果已经通过<code class="fe ng nh ni nj b">Platt's</code>方法进行了校准(参见此处的<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.svm.SVC.html" rel="noopener ugc nofollow" target="_blank"/>)。你可以自己试试。</p><p id="1e24" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">此外，请记住，校准后模型的准确性可能会降低。例如，AUC-ROC 曲线现在是 0.963。因此，我们可以看到，在某些情况下，我们可能需要在精度和校准之间进行权衡。您也可以随时检查其他指标(如精确度、召回率、F1 分数等。).</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/cadab86964dbfde1333fd483462bc5dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*7xnH8NNIMdH_iZmY83J-9g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">校准后的 AUC-ROC 曲线</p></figure><h1 id="a005" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="2335" class="pw-post-body-paragraph lg lh it li b lj nb ju ll lm nc jx lo lp nd lr ls lt ne lv lw lx nf lz ma mb im bi translated">在这个故事中，我们研究了什么是模型校准，为什么以及何时使用它，如何检查您的分类器是否校准，以及如果没有校准，如何潜在地修复它。</p><p id="5ab9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后，我想给出一个经验法则，关于是否使用<em class="mf">普氏标度</em>的<em class="mf">等张回归</em>。等张<em class="mf"> </em>回归不做 sigmoid 假设，因此，它可能更适合大量情况。另一方面，它更容易过度拟合。因此，如果我们有一个小数据集，<em class="mf"> Platt 的缩放</em>可能会更好。</p><blockquote class="mc md me"><p id="7013" class="lg lh mf li b lj lk ju ll lm ln jx lo mg lq lr ls mh lu lv lw mi ly lz ma mb im bi translated"><strong class="li iu">我叫 Dimitris Poulopoulos，是希腊比雷埃夫斯大学<em class="it"/></strong><a class="ae ky" href="https://bigdatastack.eu/" rel="noopener ugc nofollow" target="_blank"><strong class="li iu">BigDataStack</strong></a><strong class="li iu"><em class="it"/>的机器学习研究员和博士(c)。我曾为欧洲委员会、欧盟统计局、国际货币基金组织、欧洲中央银行、经合组织和宜家等主要客户设计和实施人工智能和软件解决方案。如果你有兴趣看更多关于机器学习、深度学习、数据科学的帖子，在 twitter 上关注我</strong> <a class="ae ky" href="https://medium.com/@dpoulopoulos" rel="noopener"> <strong class="li iu">中</strong> </a> <strong class="li iu">、</strong><a class="ae ky" href="https://www.linkedin.com/in/dpoulopoulos/" rel="noopener ugc nofollow" target="_blank"><strong class="li iu">LinkedIn</strong></a><strong class="li iu">或</strong><a class="ae ky" href="https://twitter.com/james2pl" rel="noopener ugc nofollow" target="_blank"><strong class="li iu">@ james2pl</strong></a><strong class="li iu">。</strong></p></blockquote></div></div>    
</body>
</html>