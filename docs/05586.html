<html>
<head>
<title>Different Colorspaces as Inputs to CNNs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不同的色彩空间作为CNN的输入</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/different-colorspaces-as-inputs-to-cnns-406ae62d1bd6?source=collection_archive---------28-----------------------#2020-05-10">https://towardsdatascience.com/different-colorspaces-as-inputs-to-cnns-406ae62d1bd6?source=collection_archive---------28-----------------------#2020-05-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a114" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过自定义数据生成器找出在CNN中使用不同的色彩空间是否会导致更好的结果，并最终创建一个集合模型。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a03f5d601efb14f2fec16cac26d9b1ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8u3q_dmFi4_PmjAO"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@ruvimnogaphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">鲁维姆·诺加</a>拍摄的照片</p></figure><p id="890d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我刚刚在另一篇文章中发完一篇牢骚，我忘记了OpenCV使用BGR格式，CNN的输出是以RGB格式检查的，这浪费了我很多时间，当我有了一个想法，如果将不同色彩空间的图像传递给CNN会怎么样，它会如何影响模型？这就是我们要在这篇文章中发现的。</p><h1 id="2ef7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">目录</h1><ol class=""><li id="1fb3" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">要求</li></ol><p id="b7e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.使用的色彩空间</p><p id="6057" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.代码和结果</p><ul class=""><li id="d84d" class="mn mo it lb b lc ld lf lg li my lm mz lq na lu nb mv mw mx bi translated">导入和加载数据集</li><li id="0050" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">创建图像数据生成器</li><li id="d78f" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">正常CNN的结果</li><li id="08b3" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">迁移学习的结果</li><li id="7f4c" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">创建集合模型</li></ul><p id="b525" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你对这个过程不感兴趣，只想知道结果，你可以直接跳到正常的CNN部分的结果。</p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="814c" class="lv lw it bd lx ly no ma mb mc np me mf jz nq ka mh kc nr kd mj kf ns kg ml mm bi translated">要求</h1><p id="a865" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">如果你想编码，那么你需要Tensorflow和OpenCV。你可以使用下面显示的代码进行pip安装，或者像我一样使用Google Colab，不需要安装免费的GPU。</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="1671" class="ob lw it nx b gy oc od l oe of">pip install tensorflow<br/>pip install opencv-python</span></pre><h1 id="0b09" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用的色彩空间</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/46f08f502ecbd7c3f4056b2dddf7483d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d2cxcXH-fY2yR7On"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@efekurnaz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">埃菲社</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="6a7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">决定使用哪种色彩空间是一项相当简单的任务。我只是打开了OpenCV的文档，并选择了所有可以转换的独特文档。我会把它们列出来，并提供额外的阅读链接，如果有人有兴趣了解更多的话。</p><ul class=""><li id="7044" class="mn mo it lb b lc ld lf lg li my lm mz lq na lu nb mv mw mx bi translated">RGB或BGR — <a class="ae ky" href="https://en.wikipedia.org/wiki/Color_spaces_with_RGB_primaries" rel="noopener ugc nofollow" target="_blank">附加阅读</a></li><li id="1cb5" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">HSV — <a class="ae ky" href="https://en.wikipedia.org/wiki/HSL_and_HSV" rel="noopener ugc nofollow" target="_blank">附加阅读</a></li><li id="9d5f" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">YCbCr — <a class="ae ky" href="https://en.wikipedia.org/wiki/YCbCr" rel="noopener ugc nofollow" target="_blank">补充阅读</a></li><li id="14de" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">实验室— <a class="ae ky" href="https://www.xrite.com/blog/lab-color-space" rel="noopener ugc nofollow" target="_blank">附加阅读</a></li><li id="690a" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">LUV — <a class="ae ky" href="https://en.wikipedia.org/wiki/CIELUV" rel="noopener ugc nofollow" target="_blank">附加阅读</a></li><li id="7b3d" class="mn mo it lb b lc nc lf nd li ne lm nf lq ng lu nb mv mw mx bi translated">XYZ — <a class="ae ky" href="https://en.wikipedia.org/wiki/CIE_1931_color_space" rel="noopener ugc nofollow" target="_blank">补充阅读</a></li></ul><h1 id="a8d3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">代码和结果</h1><p id="0e9c" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">在开始之前，我想澄清一下，我的目的不是创造一个非常高科技的CNN架构来获得最好的准确性，而是比较所有的色彩空间。</p><h2 id="61c3" class="ob lw it bd lx oh oi dn mb oj ok dp mf li ol om mh lm on oo mj lq op oq ml or bi translated">导入和加载数据集</h2><p id="3539" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">选择的数据集是猫对狗的数据集。首先，我们开始导入所有需要的库。</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="0c05" class="ob lw it nx b gy oc od l oe of">import tensorflow as tf<br/>from tensorflow.keras.models import Sequential<br/>from tensorflow.keras.layers import Conv2D, MaxPooling2D, Dropout, Flatten, Dense, Activation, BatchNormalization<br/>import os<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import re<br/>import random<br/>import cv2</span></pre><p id="0d5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是加载数据集并存储所有文件名，然后将这些文件名传递给图像数据生成器，并定义将使用的所有常数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><h2 id="0068" class="ob lw it bd lx oh oi dn mb oj ok dp mf li ol om mh lm on oo mj lq op oq ml or bi translated">创建图像数据生成器</h2><p id="9301" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">创建一个普通的定制数据生成器，带有一个额外的colorspace参数，它定义了要转换到哪个colorspace。<code class="fe ou ov ow nx b">cv2.cvtColor</code>用于那个目的。除了HSV的色调矩阵被除以180之外，所有的图像都被调整到它们需要的尺寸，并通过除以255进行归一化。为图像和标签创建NumPy数组，并生成它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="30e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Conv2D、max pooling、batch normalization和dropout层创建基本的CNN，这些层最终被展平，密集层给出具有sigmoid激活函数的输出。该模型是使用Adam编译的。如果你想创建更好的CNN，你可以参考我之前的<a class="ae ky" rel="noopener" target="_blank" href="/beyond-the-standard-cnn-in-tensorflow-2-a7562d25ca2d?source=friends_link&amp;sk=ed5924d636edd0ebde712b9f22d534b0">文章</a>。只要用所需的值来拟合模型，我们就完成了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/a21cc5e51ee666c7c616b9a6fc0c2b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BpjJh21ViN3XqP0PL3tILA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">正常CNN的结果</p></figure><p id="4500" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们观察训练精度和损失，除HSV之外的所有色彩空间给出了非常相似的更好的结果。然而，也可以观察到我们的模型是过度拟合的，所以HSV不能直接被怀疑。此外，对于验证集，HSV中的图像可以比它们的对应图像学习得更快，但是对于大量的时期，结果是均匀的，并且选择特定的一个是非常困难的。</p><h2 id="6fbd" class="ob lw it bd lx oh oi dn mb oj ok dp mf li ol om mh lm on oo mj lq op oq ml or bi translated">迁移学习的结果</h2><p id="b8f1" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">如上所述，迁移学习模型非常简单。使用预训练的MobileNetV2，其层被设置为不可训练的，并且全局平均池层之后是用于输出的密集层。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/17f6c724fc0e5fe25ace3d32689c58b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*75CZbalCPInlfsOOQzMeJw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">迁移学习中不可训练层的结果</p></figure><p id="5e6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有BGR和XYZ色彩空间给出了好的结果，而HSV给出了最差的结果。但是为什么会这样呢？我们使用预先训练好的层，这些层习惯于看到RGB风格的输入，XYZ与RGB非常相似，所以只有它们给出了好的结果，而HSV是一个圆柱形系统，在相似性方面离RGB最远，因此给出了最差的结果。</p><p id="e0c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们通过改变<code class="fe ou ov ow nx b">base_model.trainable = True</code>使整个预训练网络可训练，让我们看看现在会发生什么。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/e703039bb4a9b9c07e00bbc3de2de139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0HBgCDrc_ccAlnWNYIyCgw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">所有可训练层的迁移学习的结果。</p></figure><p id="f1dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使现在BGR和XYZ色彩空间从一开始就表现很好，然而，他们被所有其他色彩空间赶上了，除了HSV，它再次表现最差。除了HSV之外，几乎没有太多颜色空间可供选择，所以让我们创建一个集合模型，看看它是否能提高性能。</p><h2 id="1a2f" class="ob lw it bd lx oh oi dn mb oj ok dp mf li ol om mh lm on oo mj lq op oq ml or bi translated">创建集合模型</h2><p id="c50c" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">如果我们可以实现性能的提高，那么我们也将知道不同的色彩空间得到不同的分类为正确或错误的图像，这将意味着改变色彩空间对模型有一些影响。我们将创建一个非常简单的集合模型，取所有模型的预测概率的平均值，将其转换为整数，并根据真实标签对其进行评估。</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="cf7c" class="ob lw it nx b gy oc od l oe of">accuracy for bgr  : 0.9596773982048035<br/>accuracy for ycrcb  : 0.9536290168762207<br/>accuracy for lab  : 0.9415322542190552<br/>accuracy for luv  : 0.9546371102333069<br/>accuracy for xyz  : 0.9546371102333069<br/>Ensemble accuracy: 0.966</span></pre></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><p id="f2f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，可以说，改变色彩空间可能会也可能不会提高准确性，特别是如果你是随机检查，并且没有分配随机种子来重复结果，因为有很多起伏。然而，如果你想要更精确一点，你可以尝试其他色彩空间，甚至是整体模型。</p><p id="274a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想玩的话，你可以在这里和这里找到gist链接到colab文件<a class="ae ky" href="https://gist.github.com/vardanagarwal/d1c957ee1ff7b370b6135684392e10a3" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae ky" href="https://gist.github.com/vardanagarwal/918cdaa53a331051007c4dda6fd843f0" rel="noopener ugc nofollow" target="_blank">的链接。</a></p></div></div>    
</body>
</html>