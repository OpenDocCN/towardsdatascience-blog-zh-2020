<html>
<head>
<title>Automated Stock Trading with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动股票交易与R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automated-stock-trading-with-r-part-1-5a1020831096?source=collection_archive---------25-----------------------#2020-05-31">https://towardsdatascience.com/automated-stock-trading-with-r-part-1-5a1020831096?source=collection_archive---------25-----------------------#2020-05-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/52160fb1d00c8814e69a926ab0d598d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4w0C9YbEkMeelCuYFnMBhw.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">杰森·布里斯科在<a class="ae kf" href="https://unsplash.com/s/photos/stocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e62a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文解释了如何使用r创建一个交易管道</p><ul class=""><li id="a32f" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">连接Google API并加载当前持有数据</li><li id="0526" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">连接Robinhood API并获取当前股票价格</li><li id="1d6d" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">使用Yahoo API获取历史市场数据</li><li id="bbf6" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">决策算法和执行订单</li></ul><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ls"><img src="../Images/9487e0946d8162c103857db5591f87f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKaFDYq5FPeCS28GFWLsWA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图1:交易渠道</p></figure><p id="cc8a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我使用以下API</p><ul class=""><li id="6b49" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">谷歌云平台</li><li id="765b" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">罗宾汉</li><li id="4484" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">雅虎财经</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="ae5c" class="me mf it bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">1.设置</h1><p id="1f0c" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">为了创建管道，我使用了R Markdown文档。我使用这些库来处理金融数据。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="4344" class="nm mf it ni b gy nn no l np nq">library(dplyr)<br/>library(purrr)<br/>library(dbplyr)</span></pre><p id="b7c8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nr">罗宾汉</em>图书馆与罗宾汉账号互动。Quantmod 库允许与雅虎金融数据交互，并包括用于技术分析的有用库。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="44ab" class="nm mf it ni b gy nn no l np nq">library(RobinHood)<br/>library(quantmod)</span></pre><p id="052c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我使用googlesheets4、big query和DBI与基于谷歌云服务的数据库进行交互。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="207d" class="nm mf it ni b gy nn no l np nq">library(googlesheets4)<br/>library(bigrquery)<br/>library(DBI)</span></pre><p id="0358" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里的<em class="nr">库</em>是用来访问带有定义函数的本地R脚本的。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="32d2" class="nm mf it ni b gy nn no l np nq">library(here)<br/>source(here("src", "R", "data_functions.R"))<br/>source(here("src", "R", "trading_models.R"))</span></pre><h1 id="f72d" class="me mf it bd mg mh ns mj mk ml nt mn mo mp nu mr ms mt nv mv mw mx nw mz na nb bi translated">2.连接API</h1><p id="4791" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">我为我的项目设置了账单，并使用。json文件。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="44a6" class="nm mf it ni b gy nn no l np nq">gs4_auth(<br/>path = "google_auth.json",<br/>cache = FALSE<br/>)</span></pre><p id="8d08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在里面。Rprofile我为sys环境设置了以下变量。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="38f4" class="nm mf it ni b gy nn no l np nq"># Put that inside .Rprofile system file<br/>Sys.setenv("username" = "adam")<br/>Sys.setenv("password" = "test")</span></pre><p id="b762" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后与RobinHood API建立连接。。Rprofile文件传递上面定义的相关凭据。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="915c" class="nm mf it ni b gy nn no l np nq">robinhood_connection = RobinHood(<br/>username = Sys.getenv("username"),<br/>password = Sys.getenv("password")<br/>)</span></pre><h1 id="f7d7" class="me mf it bd mg mh ns mj mk ml nt mn mo mp nu mr ms mt nv mv mw mx nw mz na nb bi translated">3.收集数据并做出决策</h1><p id="2f67" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">然后，我使用雅虎财经API收集所有相关数据。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="1fc2" class="nm mf it ni b gy nn no l np nq"># This function is located in data_functions.R script<br/>get_market_data &lt;- function() {<br/> # Load data into the workspace<br/> getSymbols("AAPL", src="yahoo")<br/> return(AAPL)<br/>}</span><span id="19cb" class="nm mf it ni b gy nx no l np nq">data &lt;- get_market_data()</span></pre><p id="19cc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于本文来说，这个函数收集APPL股票的历史数据。这将有助于交易算法做出决定。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/3f5144fe5a190db8493b9d06111b7e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_YdODHRV-kKkpPlIr8HLQ.png"/></div></div></figure><p id="9608" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我将数据和输入参数传递给一个算法，该算法决定是买入还是卖出给定的股票。我将在另一篇文章中解释算法<strong class="ki iu">，它检查当前持有量并决定卖出、买入或持有给定的股票。这就是算法的输出。</strong></p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="006c" class="nm mf it ni b gy nn no l np nq">stock_decision &lt;- moving_average_model(<br/> data = data,<br/> trend_deviation = -4<br/>)</span></pre><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/ce40f733df8706bac3905b9a1f1024ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-n-rPFgv1H_XwII7w2TVZA.png"/></div></div></figure><h1 id="4cc7" class="me mf it bd mg mh ns mj mk ml nt mn mo mp nu mr ms mt nv mv mw mx nw mz na nb bi translated">4.执行订单</h1><p id="240a" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">然后，我从RobinHood API请求最新的APPL股票价格。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="528f" class="nm mf it ni b gy nn no l np nq">market_price &lt;- get_quote(<br/>robinhood_connection,<br/>ticker = c("AAPL"),<br/>limit_output = TRUE<br/>)$last_trade_price</span></pre><p id="2609" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，程序根据函数的输出执行购买。下订单应该会生成一封电子邮件。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="c5f8" class="nm mf it ni b gy nn no l np nq">if(purchase_stock$decision_buy) {<br/>x = place_order(<br/>RH = robinhood_connection,<br/>symbol = "AAPL",<br/>type = "market",<br/>time_in_force = "gfd",<br/>trigger = "immediate",<br/>price = market_price,<br/>quantity = n,<br/>side = "buy"<br/> )<br/>} else if (purchase_stock$decision_sell) {<br/>x = place_order(<br/>RH = robinhood_connection,<br/>symbol = "AAPL",<br/>type = "market",<br/>time_in_force = "gfd",<br/>trigger = "immediate",<br/>price = market_price,<br/>quantity = n,<br/>side = "sell"<br/> )<br/>}</span></pre><p id="5549" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，管道将输出写入Google sheets，并在股票被买卖时更新持股表。</p><pre class="lt lu lv lw gt nh ni nj nk aw nl bi"><span id="4b27" class="nm mf it ni b gy nn no l np nq">write_output_sheets(<br/>data = stock_decision,<br/>sheet = "records")</span><span id="71b7" class="nm mf it ni b gy nx no l np nq">if (purchase_stock$decision_buy | purchase_stock$decision_sell) {<br/>update_current_holdings(purchase_stock)<br/>}</span></pre><h1 id="c626" class="me mf it bd mg mh ns mj mk ml nt mn mo mp nu mr ms mt nv mv mw mx nw mz na nb bi translated"><strong class="ak">总结</strong></h1><p id="17de" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">用r执行库存订单是可能的，而且相对容易。下一步是编排工作流。我尝试过用气流和云合成器来做这件事。Cloud Composer比airflow更容易设置。也挺贵的。局部设置气流可能是一个更好的选择，但是，它需要更多的工程知识。</p><p id="6847" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一篇文章中，我将讨论一个简单的移动平均线交易算法。</p><p id="313f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> <em class="nr">注来自《走向数据科学》的编辑:</em> </strong> <em class="nr">虽然我们允许独立作者根据我们的</em> <a class="ae kf" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="nr">规则和指导方针</em> </a> <em class="nr">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae kf" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="nr">读者术语</em> </a> <em class="nr">。</em></p><h1 id="7481" class="me mf it bd mg mh ns mj mk ml nt mn mo mp nu mr ms mt nv mv mw mx nw mz na nb bi translated">参考</h1><p id="e9b1" class="pw-post-body-paragraph kg kh it ki b kj nc kl km kn nd kp kq kr ne kt ku kv nf kx ky kz ng lb lc ld im bi translated">[1] RobinHood cran包文档，<a class="ae kf" href="https://cran.r-project.org/web/packages/RobinHood/RobinHood.pdf" rel="noopener ugc nofollow" target="_blank">https://cran . r-project . org/web/packages/robin hood/robin hood . pdf</a></p><p id="073a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[2] Quantmode cran包文档<a class="ae kf" href="https://cran.r-project.org/web/packages/quantmod/quantmod.pdf" rel="noopener ugc nofollow" target="_blank">https://cran . r-project . org/web/packages/quant mod/quant mod . pdf</a></p><p id="e336" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[3]为Google sheets设置Google API<a class="ae kf" href="https://googlesheets4.tidyverse.org" rel="noopener ugc nofollow" target="_blank">https://googlesheets4.tidyverse.org</a></p><p id="db7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[4]云作曲<a class="ae kf" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/composer</a></p></div></div>    
</body>
</html>