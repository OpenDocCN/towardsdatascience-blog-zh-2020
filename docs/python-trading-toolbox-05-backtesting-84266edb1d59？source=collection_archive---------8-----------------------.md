# Python äº¤æ˜“å·¥å…·ç®±:å›žæº¯æµ‹è¯•çš„æ¸©å’Œä»‹ç»

> åŽŸæ–‡ï¼š<https://towardsdatascience.com/python-trading-toolbox-05-backtesting-84266edb1d59?source=collection_archive---------8----------------------->

## [äº¤æ˜“å·¥å…·ç®±](https://towardsdatascience.com/tag/trading-toolbox)

## ä»Žå¤´å¼€å§‹æµ‹è¯•äº¤æ˜“ç­–ç•¥

![](img/bd8b376fcab18c806cfcbc1c6274a2e1.png)

ç…§ç‰‡ç”±[ç±³å¡Â·é²æ¢…æ–¯ç‰¹](https://unsplash.com/@mbaumi?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

æˆ‘ä»¬é€šè¿‡å¼•å…¥ä¸€äº›åŸºäºŽä»·æ ¼çš„æŒ‡æ ‡å¼€å§‹äº†è¿™ä¸ªç³»åˆ—ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä½¿ç”¨æŒ‡æ ‡ã€ä»·æ ¼å’Œäº¤æ˜“é‡æ¥åšå‡ºæŠ•èµ„å†³ç­–:é€‰æ‹©ä½•æ—¶ä¹°å…¥æˆ–å–å‡ºé‡‘èžèµ„äº§ã€‚åœ¨æˆ‘ä»¬çš„æŠ•èµ„å†³ç­–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸åŒçš„æ–¹æ³•æ¥æ•´åˆä»·æ ¼ã€äº¤æ˜“é‡å’ŒæŒ‡æ ‡ã€‚ç¬¬ä¸€ç§ï¼Œä¹Ÿæ˜¯æœ€ä¼ ç»Ÿçš„ä¸€ç§ï¼Œæ˜¯ä»¥ä»»æ„çš„æ–¹å¼è§£é‡Šä»–ä»¬çš„æ¨¡å¼ï¼Œå°±åƒæŠ€æœ¯åˆ†æžçš„è¿½éšè€…æ‰€åšçš„é‚£æ ·ã€‚æŒ‡æ ‡ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªæ›´é‡åŒ–çš„æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œä½œä¸ºäº¤æ˜“ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†ï¼Œæ¶ˆé™¤æŠ•èµ„è¿‡ç¨‹ä¸­çš„äººä¸ºåˆ¤æ–­ã€‚[ç®—æ³•äº¤æ˜“](https://en.wikipedia.org/wiki/Algorithmic_trading)å°¤å…¶æ˜¯ä¸€ç§åŸºäºŽäº¤æ˜“ç­–ç•¥çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•åœ¨æ²¡æœ‰äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹è‡ªè¡Œå»ºç«‹é‡‘èžå·¥å…·çš„å¤´å¯¸ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä»·æ ¼ã€äº¤æ˜“é‡å’ŒæŒ‡æ ‡ä½œä¸ºæ›´å¤æ‚çš„æœºå™¨å­¦ä¹ æ¨¡åž‹çš„ä¸€éƒ¨åˆ†æ¥è¿›è¡ŒæŠ•èµ„å†³ç­–ã€‚

> ä¸€ä¸ªæ˜Žæ˜¾çš„å…è´£å£°æ˜Ž:è¿™ä¸ªå¸–å­çš„å†…å®¹ä»…ç”¨äºŽæ•™è‚²ç›®çš„ã€‚è¿™é‡Œçš„æ‰€æœ‰ä¾‹å­éƒ½æ˜¯ä½œä¸ºå­¦ä¹ ç»ƒä¹ æå‡ºçš„ï¼Œå®ƒä»¬ç»ä¸åº”è¯¥ä½œä¸ºæŠ•èµ„å»ºè®®ã€‚

æ— è®ºæˆ‘ä»¬é€‰æ‹©ä»¥ä½•ç§æ–¹å¼ä½¿ç”¨æˆ‘ä»¬çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å›žç­”ä¸€ä¸ªé‡è¦çš„é—®é¢˜:æˆ‘ä»¬çš„æŒ‡æ ‡æˆ–æŒ‡æ ‡ç»„åˆå¯¹æˆ‘ä»¬çš„æŠ•èµ„å†³ç­–æœ‰å¤šå¥½ï¼Ÿæ¢å¥è¯è¯´ï¼Œä½¿ç”¨ä»»ä½•æŒ‡æ ‡ä¼šæ¯”æ ¹æœ¬ä¸ä½¿ç”¨å®ƒä»¬äº§ç”Ÿæ›´å¥½çš„ç»“æžœå—ï¼Ÿ

å¯ä»¥å¸®åŠ©æˆ‘ä»¬å›žç­”è¿™ä¸ªé—®é¢˜çš„è¿‡ç¨‹è¢«ç§°ä¸º [**å›žæº¯æµ‹è¯•**](https://www.investopedia.com/terms/b/backtesting.asp) ã€‚é€šè¿‡å›žæº¯æµ‹è¯•ï¼Œæˆ‘ä»¬å°†äº¤æ˜“æˆ–æŠ•èµ„ç­–ç•¥åº”ç”¨äºŽåŽ†å²æ•°æ®ï¼Œä»¥ç”Ÿæˆå‡è®¾çš„ç»“æžœã€‚ç„¶åŽï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æžè¿™äº›ç»“æžœï¼Œä»¥è¯„ä¼°æˆ‘ä»¬æˆ˜ç•¥çš„ç›ˆåˆ©èƒ½åŠ›å’Œé£Žé™©ã€‚

è¿™ä¸ªè¿‡ç¨‹æœ‰å…¶è‡ªèº«çš„ç¼ºé™·:ä¸èƒ½ä¿è¯åœ¨åŽ†å²æ•°æ®ä¸Šè¡¨çŽ°è‰¯å¥½çš„ç­–ç•¥åœ¨çŽ°å®žäº¤æ˜“ä¸­ä¹Ÿä¼šè¡¨çŽ°è‰¯å¥½ã€‚çœŸå®žçš„äº¤æ˜“æ¶‰åŠå¾ˆå¤šå› ç´ ï¼Œè¿™äº›å› ç´ æ— æ³•ç”¨åŽ†å²æ•°æ®æ¥æ¨¡æ‹Ÿæˆ–æµ‹è¯•ã€‚æ­¤å¤–ï¼Œç”±äºŽé‡‘èžå¸‚åœºæŒç»­å¿«é€Ÿå‘å±•ï¼Œæœªæ¥å¯èƒ½ä¼šå‡ºçŽ°åŽ†å²æ•°æ®ä¸­æ²¡æœ‰çš„æ¨¡å¼ã€‚ç„¶è€Œï¼Œå¦‚æžœä¸€ä¸ªç­–ç•¥ä¸èƒ½åœ¨å›žæº¯æµ‹è¯•ä¸­è¯æ˜Žè‡ªå·±æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒå¾ˆå¯èƒ½æ°¸è¿œä¸ä¼šåœ¨çœŸå®žäº¤æ˜“ä¸­å‘æŒ¥ä½œç”¨ã€‚å›žæº¯æµ‹è¯•è‡³å°‘å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‰”é™¤é‚£äº›æ²¡æœ‰ä»·å€¼çš„ç­–ç•¥ã€‚

å‡ ä¸ªæ¡†æž¶ä½¿å¾—ä½¿ç”¨ Python å›žæº¯æµ‹è¯•äº¤æ˜“ç­–ç•¥å˜å¾—å¾ˆå®¹æ˜“ã€‚ä¸¤ä¸ªæµè¡Œçš„ä¾‹å­æ˜¯[](https://www.zipline.io/)**å’Œ [**Backtrader**](https://www.backtrader.com/) ã€‚åƒ *Zipline* å’Œ *Backtrader* è¿™æ ·çš„æ¡†æž¶åŒ…å«äº†è®¾è®¡ã€æµ‹è¯•å’Œå®žçŽ°ç®—æ³•äº¤æ˜“ç­–ç•¥æ‰€éœ€çš„æ‰€æœ‰å·¥å…·ã€‚ä»–ä»¬ç”šè‡³å¯ä»¥è‡ªåŠ¨å°†çœŸå®žè®¢å•æäº¤ç»™æ‰§è¡Œç»çºªäººã€‚**

**åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ç§ä¸åŒçš„æ–¹æ³•:æˆ‘ä»¬æƒ³ç ”ç©¶å¦‚ä½•ä½¿ç”¨ Pythonã€ *pandasã€*å’Œ NumPy ä½œä¸ºæˆ‘ä»¬ä»…æœ‰çš„å·¥å…·ï¼Œä»Žå¤´å¼€å§‹æž„å»ºå’Œæµ‹è¯•ä¸€ä¸ªäº¤æ˜“ç³»ç»Ÿã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿé¦–å…ˆï¼Œä»Žå¤´å¼€å§‹æž„å»ºå›žæº¯æµ‹è¯•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç»ƒä¹ ï¼Œæœ‰åŠ©äºŽè¯¦ç»†ç†è§£ç­–ç•¥æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå‘çŽ°è‡ªå·±éœ€è¦å®žçŽ°çŽ°æœ‰æ¡†æž¶ä¸­æ²¡æœ‰çš„è§£å†³æ–¹æ¡ˆã€‚æˆ–è€…ï¼Œæ‚¨å¯èƒ½æƒ³è¦å¼€å§‹åˆ›å»ºè‡ªå·±çš„å›žæº¯æµ‹è¯•æ¡†æž¶çš„æ—…ç¨‹ï¼**

# **å›žæº¯æµ‹è¯•æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç³»ç»Ÿ**

**æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python å’Œ NumPy ä»¥åŠ *pandas* åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„å›žæº¯æµ‹è¯•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åœ¨çº½çº¦è¯åˆ¸äº¤æ˜“æ‰€äº¤æ˜“çš„é‡‘å®æ±¤å…¬å¸è‚¡ç¥¨çš„ä»·æ ¼ã€‚æˆ‘ä»Žé›…è™Žä¸‹è½½äº†äº”å¹´çš„äº¤æ˜“åŽ†å²ã€‚è´¢åŠ¡:æ–‡ä»¶åœ¨[è¿™é‡Œ](https://raw.githubusercontent.com/stebas101/TradingToolbox/master/data/CPB.csv)æœ‰ã€‚**

**æˆ‘ä»¬é¦–å…ˆè®¾ç½®æˆ‘ä»¬çš„çŽ¯å¢ƒï¼Œå¹¶å°†ä»·æ ¼ç³»åˆ—åŠ è½½åˆ°æ•°æ®æ¡†ä¸­:**

```
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
pd.plotting.register_matplotlib_converters()# This is needed if you're using Jupyter to visualize charts:
%matplotlib inlinedatafile = 'data/CPB.csv'
data = pd.read_csv(datafile, index_col = 'Date')
# Converting the dates from string to datetime format:
data.index = pd.to_datetime(data.index)data
```

**![](img/3827331399ed7a35f70070c6ad6b6b2a.png)**

**åŽŸå§‹æ•°æ®å¸§**

## **åŸºæœ¬ç­–ç•¥**

**åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æµ‹è¯•ä¸€ä¸ªåŸºæœ¬çš„**ç§»åŠ¨å¹³å‡çº¿äº¤å‰ç³»ç»Ÿ**ï¼Œè¯¥ç³»ç»ŸåŸºäºŽæ¯æ—¥æ”¶ç›˜ä»·çš„ 20 å¤©æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿(EMA)å’Œ 200 å¤©ç®€å•ç§»åŠ¨å¹³å‡çº¿(SMA)(åœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨*è°ƒæ•´æ”¶ç›˜ä»·*)ã€‚åªè¦ 20 æ—¥å‡çº¿ä»Žä¸‹æ–¹ç©¿è¿‡ 200 æ—¥å‡çº¿ï¼Œæˆ‘ä»¬å°±ä¼šä¹°å…¥è¯¥è‚¡(æŒæœ‰*å¤šå¤´ä»“ä½*)ã€‚**

**æˆ‘ä»¬å°†å¸¦æœ‰ç§»åŠ¨å¹³å‡çº¿çš„åˆ—æ·»åŠ åˆ°æ•°æ®æ¡†ä¸­:**

```
df = data.copy()sma_span = 200
ema_span = 20df['sma200'] = df['Adj Close'].rolling(sma_span).mean()
df['ema20'] = df['Adj Close'].ewm(span=ema_span).mean()df.round(3)
```

**![](img/5c967888701c97ff688474a3ad82462e.png)**

**å¢žåŠ äº† sma200 å’Œ ema20**

**æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œé€šè¿‡ä½¿ç”¨ 200 å¤©çš„ SMAï¼Œæˆ‘ä»¬åœ¨ç›¸åº”åˆ—çš„å‰ 199 è¡Œä¸­èŽ·å¾—äº† **NaN** å€¼ã€‚è¿™åªæ˜¯ä¸€ä¸ªç»ƒä¹ ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤è¿™äº›è¡Œæ¥æ‰§è¡Œå›žæº¯æµ‹è¯•ã€‚åœ¨å®žé™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸åŒçš„æŒ‡æ ‡æ¥é¿å…ä¸¢å¤±å¤§é‡æ•°æ®ã€‚æ¸…é™¤ *NaN* å€¼:**

```
df.dropna(inplace=True)df.round(3)
```

**![](img/5362762f3738939023cac9b94cf4a76a.png)**

**ç§»é™¤äº† NaN è¡Œ**

**è®©æˆ‘ä»¬çœ‹çœ‹å›¾è¡¨ä¸­çš„æ•°æ®:**

```
plot_system1(df)
```

**![](img/4dfba673c1250cf6053e180505fda6d4.png)**

**ç§»åŠ¨å¹³å‡ä»·æ ¼**

**ä¸ºäº†è·Ÿè¸ªæˆ‘ä»¬åœ¨æ•°æ®æ¡†ä¸­çš„å¤´å¯¸ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€åˆ—ï¼Œæ¯ä¸€è¡Œéƒ½åŒ…å«æœ‰å¤šå¤´å¤´å¯¸æ—¶çš„æ•°å­— **1** å’Œæ²¡æœ‰å¤´å¯¸æ—¶çš„æ•°å­— **0** :**

```
# Our trading condition:
long_positions = np.where(df['ema20'] > df['sma200'], 1, 0)
df['Position'] = long_positionsdf.round(3)
```

**![](img/e6b062bec9cf7572e96dcd72392656f2.png)**

**æ·»åŠ äº†ä½ç½®åˆ—**

**æ— è®ºæˆ‘ä»¬è¯•å›¾å®žçŽ°ä»€ä¹ˆè§„åˆ™ï¼Œæ£€æŸ¥æˆ‘ä»¬çš„ä¿¡å·**æ˜¯ä¸€ä¸ªå¥½ä¸»æ„**ä»¥ç¡®ä¿ä¸€åˆ‡æŒ‰é¢„æœŸå·¥ä½œã€‚è®¨åŽŒçš„é”™è¯¯å–œæ¬¢éšè—åœ¨è¿™ç§è®¡ç®—ä¸­:å¼€å§‹æµ‹è¯•ä¸€ä¸ªç³»ç»Ÿï¼Œç„¶åŽå‘çŽ°æˆ‘ä»¬æ²¡æœ‰æ­£ç¡®åœ°å®žçŽ°æˆ‘ä»¬çš„è§„åˆ™ï¼Œè¿™å¤ªå®¹æ˜“äº†ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è­¦æƒ•å¼•å…¥ä»»ä½•å½¢å¼çš„**å‰çž»åå·®**:å½“æˆ‘ä»¬åœ¨äº¤æ˜“è§„åˆ™ä¸­åŒ…å«åœ¨è§„åˆ™è¯„ä¼°æ—¶å®žé™…ä¸å¯ç”¨çš„æ•°æ®æ—¶ï¼Œå°±ä¼šå‡ºçŽ°è¿™ç§æƒ…å†µã€‚å¦‚æžœç³»ç»Ÿå›žæº¯æµ‹è¯•äº§ç”Ÿçš„ç»“æžœå¥½å¾—ä»¤äººéš¾ä»¥ç½®ä¿¡ï¼Œé‚£ä¹ˆå‰çž»åå·®æ˜¯æœ€æœ‰å¯èƒ½çš„ç½ªé­ç¥¸é¦–ã€‚**

**æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥æ•°æ®æ¡†ä¸­çš„æ•°å­—å˜é‡å¹¶åœ¨å›¾è¡¨ä¸Šç»˜åˆ¶ä¿¡å·æ¥æ£€æŸ¥ä¿¡å·ã€‚**

**è¦é€‰æ‹©è§¦å‘äº¤æ˜“ä¿¡å·çš„æ—¥æœŸ:**

```
buy_signals = (df['Position'] == 1) & (df['Position'].shift(1) == 0)df.loc[buy_signals].round(3)
```

**![](img/4d7fadfd1b3c5bbb2d384f2ba81648b8.png)**

**ä¿¡å·è¢«è§¦å‘æ—¶çš„è¡Œ**

**åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæœ‰ä¸‰ä¸ªä¿¡å·ã€‚ä¸ºäº†ç¡®ä¿æˆ‘ä»¬æ­£ç¡®åº”ç”¨äº¤å‰äº¤æ˜“è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€‰æ‹©ä¸­åŒ…æ‹¬ä¿¡å·ä¹‹å‰çš„æ—¥å­:**

```
buy_signals_prev = (df['Position'].shift(-1) == 1) & (df['Position'] == 0)df.loc[buy_signals | buy_signals_prev].round(3)
```

**![](img/fc4dbd4bc4732dc0720f092c5b2b964f.png)**

**åŒ…æ‹¬ä¿¡å·è§¦å‘å‰çš„å‡ å¤©**

**åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½:åœ¨ä¿¡å·å‡ºçŽ°ä¹‹å‰çš„æ—¥å­é‡Œï¼Œ`ema20`åœ¨`sma200`ä¸‹æ–¹ï¼Œåœ¨ä¿¡å·å‡ºçŽ°çš„æ—¥å­é‡Œï¼Œå®ƒåœ¨ä¸Šæ–¹äº¤å‰ã€‚æˆ‘ä»¬å¯ä»¥å¯¹é€€å‡ºæˆ‘ä»¬å¤´å¯¸çš„ä¿¡å·è¿›è¡Œç±»ä¼¼çš„æ£€æŸ¥:æˆ‘æŠŠè¿™ä¸ªç»ƒä¹ ç•™ç»™ä½ ã€‚**

**æˆ‘ä»¬å¯ä»¥åœ¨å›¾è¡¨ä¸Šæ ‡å‡ºä¿¡å·çš„æ ‡è®°:**

```
plot_system1_sig(df)
```

**![](img/652ba65f43e185fe852ce5ced4a53f88.png)**

**å¸¦ä¿¡å·æ ‡è®°çš„å›¾è¡¨**

**ä»Žå›¾è¡¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¹°å’Œå–çš„ä¿¡å·æ˜¯ä¸åŒ¹é…çš„ã€‚ç¬¬ä¸€ä¸ªä¿¡å·æ˜¯å–å‡º(æ²¡æœ‰ä¹°å…¥),å› ä¸ºæˆ‘ä»¬ä»Žç³»åˆ—å¼€å§‹æ—¶çš„å¤šå¤´å¤´å¯¸å¼€å§‹ã€‚æœ€åŽä¸€ä¸ªä¿¡å·æ˜¯ä¹°å…¥(æ²¡æœ‰å–å‡º)ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç³»åˆ—ç»“æŸæ—¶ä¿æŒå¤šå¤´å¤´å¯¸ã€‚**

## **æˆ˜ç•¥å›žæŠ¥**

**æˆ‘ä»¬çŽ°åœ¨å¯ä»¥ç”¨åˆå§‹æŠ•èµ„çš„ç™¾åˆ†æ¯”æ¥è®¡ç®—æˆ‘ä»¬ç­–ç•¥çš„å›žæŠ¥ï¼Œå¹¶å°†å…¶ä¸Ž*ä¹°å…¥å¹¶æŒæœ‰*ç­–ç•¥çš„å›žæŠ¥è¿›è¡Œæ¯”è¾ƒï¼ŒåŽè€…åªæ˜¯åœ¨æœŸåˆä¹°å…¥æˆ‘ä»¬çš„è‚¡ç¥¨ï¼Œå¹¶ä¸€ç›´æŒæœ‰åˆ°æœŸæœ«ã€‚**

**æˆ‘ä»¬å°†ç”¨æ¥è®¡ç®—å›žæŠ¥çš„ä»·æ ¼åºåˆ—æ˜¯**è°ƒæ•´æ”¶ç›˜ä»·æ ¼**:é€šè¿‡ä½¿ç”¨è°ƒæ•´åŽçš„ä»·æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿åœ¨æˆ‘ä»¬çš„è®¡ç®—ä¸­è€ƒè™‘åˆ°è‚¡æ¯ã€è‚¡ç¥¨åˆ†å‰²å’Œå…¶ä»–[å…¬å¸è¡Œä¸º](https://www.investopedia.com/articles/03/081303.asp)å¯¹å›žæŠ¥çš„å½±å“ã€‚**

```
# The returns of the Buy and Hold strategy:
df['Hold'] = np.log(df['Adj Close'] / df['Adj Close'].shift(1))# The returns of the Moving Average strategy:
df['Strategy'] = df['Position'].shift(1) * df['Hold']# We need to get rid of the NaN generated in the first row:
df.dropna(inplace=True)df
```

**![](img/9473da717aca2f5e8e65e227b5d9f02a.png)**

**æ·»åŠ äº†è¿”å›žåˆ—**

**æ•´ä¸ªå‘¨æœŸçš„å›žæŠ¥åªæ˜¯æ¯æ—¥å¯¹æ•°å›žæŠ¥çš„æ€»å’Œ(æˆ‘å°†åœ¨åŽé¢è§£é‡Šæ•°å­¦åŽŸç†):**

```
returns = np.exp(df[['Hold', 'Strategy']].sum()) - 1print(f"Buy and hold return: {round(returns['Hold']*100,2)}%")
print(f"Strategy return: {round(returns['Strategy']*100,2)}%")
```

**è¾“å‡º:**

```
Buy and hold return: -5.83%
Strategy return: 10.3%
```

**è¿™äº›å›žæŠ¥æ¶‰åŠ 1060 å¤©çš„æ—¶é—´ã€‚å¦‚æžœæˆ‘ä»¬æƒ³å°†å®ƒä»¬ä¸Žå…¶ä»–æ—¶æœŸçš„å›žæŠ¥è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘ä»¬éœ€è¦**å°†å®ƒä»¬æŒ‰å¹´è®¡ç®—**:**

```
n_days = len(df)# Assuming 252 trading days in a year:
ann_returns = 252 / n_days * returnsprint(f"Buy and hold annualized return: {round(ann_returns['Hold']*100,2)}%")print(f"Strategy annualized return:{round(ann_returns['Strategy']*100,2)}%")
```

**è¾“å‡º:**

```
Buy and hold annualized return: -1.39%
Strategy annualized return: 2.45%
```

**é™¤éžä½ ç†Ÿæ‚‰å¯¹æ•°å›žæŠ¥ï¼Œå¦åˆ™ä½ å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•åœ¨å›žæŠ¥è®¡ç®—ä¸­ä½¿ç”¨**å¯¹æ•°**ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹æ•°å­¦æ¥è§£é‡Šè¿™ä¸€ç‚¹ï¼Œå¦‚æžœä½ å¬èµ·æ¥å¾ˆé™Œç”Ÿçš„è¯ã€‚å¦åˆ™ï¼Œè¯·éšæ„è·³åˆ°ä¸‹ä¸€éƒ¨åˆ†ã€‚**

**åœ¨å®šé‡é‡‘èžå­¦ä¸­ï¼Œä½¿ç”¨å¯¹æ•°æ¥è®¡ç®—å›žæŠ¥æ˜¯å¾ˆå¸¸è§çš„:å®ƒä»¬ä½¿å¾—ä¸€äº›è®¡ç®—æ›´å®¹æ˜“å¤„ç†ã€‚å¦‚æžœæ—¥æ”¶ç›ŠçŽ‡ *R_t* å®šä¹‰ä¸º:**

**![](img/4f0f1977bdaa93c96f25a05b404d8560.png)**

**å…¶ä¸­ *P_t* æ˜¯ð‘¡æ—¥çš„ä»·æ ¼ï¼Œå¯¹æ•°æ”¶ç›Šð‘Ÿ_ð‘¡å®šä¹‰ä¸º:**

**![](img/635f99df5cc4c7d9b47a8396d72cc0a6.png)**

**é€šè¿‡åº”ç”¨ä¸€äº›åŸºæœ¬ä»£æ•°ï¼Œå¯ä»¥å°†æ¯æ—¥æ—¥å¿—å›žæŠ¥è®¡ç®—ä¸º:**

**![](img/36f039948d1314a0a1521e0e25e75ed4.png)**

**ä¸ºä»€ä¹ˆå¯¹æ•°å›žå½’å¦‚æ­¤æ–¹ä¾¿ï¼Ÿå¦‚æžœæˆ‘ä»¬æœ‰ä¸€ç³»åˆ—çš„æ—¥æ”¶ç›Šï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æ•´ä¸ªå‘¨æœŸçš„æ”¶ç›Šï¼Œç”¨å¯¹æ•°æ”¶ç›Šæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬åŠ èµ·æ¥ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¯¹äºŽå®šæœŸå›žæŠ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¹˜æ³•:**

**![](img/96c4e688011e5b8a580da1915e34abf7.png)**

**å…¶ä¸­ *T* æ˜¯æˆ‘ä»¬è€ƒè™‘çš„æ—¶é—´æ®µçš„å¤©æ•°ã€‚è®¡ç®—å¹´åŒ–å›žæŠ¥çŽ‡ä¹Ÿå˜å¾—æ›´åŠ å®¹æ˜“ã€‚**

# **æ›´å¤æ‚çš„ç­–ç•¥**

**æˆ‘ä»¬åˆšåˆšæµ‹è¯•çš„ç­–ç•¥åªæœ‰ä¸¤ç§å¯èƒ½çš„å¤´å¯¸:æˆ‘ä»¬è¦ä¹ˆ*å¤šå¤´*(æŒæœ‰è‚¡ç¥¨)è¦ä¹ˆ*ç©ºå¤´*(ä»…æŒæœ‰çŽ°é‡‘)ã€‚å°è¯•å’Œæµ‹è¯•ä¸€ç§å¢žåŠ ç©ºå¤´å¤´å¯¸å¯èƒ½æ€§çš„ç­–ç•¥(å–å‡ºå€Ÿå…¥çš„è‚¡ç¥¨ï¼Œå¹¶åœ¨é€€å‡ºå¤´å¯¸æ—¶ä¹°å›ž)ä¼šå¾ˆæœ‰è¶£ã€‚ä¸ºäº†å»ºç«‹è¿™ä¸ªç­–ç•¥çš„ä¾‹å­ï¼Œæˆ‘ä»¬åŒ…æ‹¬ä¸¤ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿ï¼Œä¸€ä¸ªæ˜¯æ—¥é«˜ç‚¹ï¼Œä¸€ä¸ªæ˜¯æ—¥ä½Žç‚¹ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº† 15 å¤©æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ã€‚æˆ‘ä»¬æ ¹æ®ä»¥ä¸‹è§„åˆ™å»ºç«‹å¤´å¯¸:**

*   **å½“å‡çº¿é«˜äºŽè¾ƒé«˜çš„å‡çº¿æ—¶(åŠ ä¸Š 2%çš„åç§»)ï¼Œæˆ‘ä»¬åšå¤š(ä¹°å…¥)**
*   **å½“å‡çº¿ä½ŽäºŽè¾ƒä½Žçš„å‡çº¿æ—¶(å‡åŽ» 2%çš„åç§»)ï¼Œæˆ‘ä»¬åšç©º(å–ç©º)**
*   **åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹(å‡çº¿å’Œå‡çº¿ä¹‹é—´)ï¼Œæˆ‘ä»¬ä¸å‚ä¸Žå¸‚åœº**

**æˆ‘å°†å¤±è°ƒæ·»åŠ åˆ° SMAs ä¸­ï¼Œä»¥å‡å°‘é”™è¯¯ä¿¡å·çš„æ•°é‡ã€‚è®©æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªæ–°çš„æ•°æ®æ¡†:**

```
df2 = data.copy()sma_span = 40
ema_span = 15df2['H_sma'] = df2['High'].rolling(sma_span).mean()
df2['L_sma'] = df2['Low'].rolling(sma_span).mean()
df2['C_ema'] = df2['Close'].ewm(span=ema_span).mean()df2.dropna(inplace=True)df2.round(3)
```

**![](img/e3b9818ff5059dccb6caf028268e19e6.png)**

**æ·»åŠ ç§»åŠ¨å¹³å‡çº¿**

**åœ¨è¿™é‡Œï¼Œé™¤äº†æ”¶ç›˜ä»·ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜åˆ©ç”¨äº†æœ€é«˜ä»·å’Œæœ€ä½Žä»·ã€‚ä¸ºäº†åœ¨å›¾è¡¨ä¸Šç»˜åˆ¶è¿™äº›å€¼ï¼Œä½¿ç”¨[**æˆ–**çƒ›å°****](/trading-toolbox-03-ohlc-charts-95b48bb9d748) **æ˜¯ä¸ªå¥½ä¸»æ„ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ **mplfinance** åº“ã€‚å¦‚æžœæ‚¨è¿˜æ²¡æœ‰è¿™æ ·åšï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è½»æ¾å®‰è£… *mplfinance* :****

****`pip install --upgrade mplfinance`****

****ä¸ºäº†å°†çƒ›å°å›¾è¡¨ä¸Žæˆ‘ä»¬çŽ°æœ‰çš„æ ·å¼ç›¸ç»“åˆï¼Œæˆ‘å°†åº”ç”¨ [*å¤–éƒ¨è½´æ–¹æ³•*](https://github.com/matplotlib/mplfinance/blob/master/markdown/subplots.md#external-axes-method) çš„ *mplfinance* :****

```
**plot_system2(df2)**
```

****![](img/8db4591ed0da52104a8172a910a85f50.png)****

****å¸¦ç§»åŠ¨å¹³å‡çº¿çš„èœ¡çƒ›å›¾****

****æˆ‘ä»¬å¯ä»¥æ›´è¯¦ç»†åœ°æ£€æŸ¥ä»»ä½•ç‰¹å®šçš„æ—¥æœŸèŒƒå›´:****

```
**plot_system2(df2['2019-07-01':'2019-12-31'])**
```

****![](img/a4f5c74e2f3834a3506ef18c46698a74.png)****

****æ—¥æœŸèŒƒå›´è¯¦ç»†ä¿¡æ¯****

****ç„¶åŽï¼Œæˆ‘ä»¬åº”ç”¨æˆ‘ä»¬çš„äº¤æ˜“è§„åˆ™å¹¶æ·»åŠ å¤´å¯¸åˆ—:****

```
**offset = 0.02
long_positions = np.where(df2['C_ema'] > df2['H_sma']*(1+offset), 1, 0)
short_positions = np.where(df2['C_ema'] < df2['L_sma']*(1-offset), -1, 0)
df2['Position'] = long_positions + short_positionsdf2.round(3)**
```

****![](img/02bb0ef18c3770edb8371c0bcd8abbbb.png)****

****æ·»åŠ äº†ä½ç½®åˆ—****

****æˆ‘ä»¬å¯ä»¥åœ¨å›¾è¡¨ä¸Šæ ‡å‡ºæˆ‘ä»¬çš„ä¿¡å·:****

```
**plot_system2_sig(df2)**
```

****![](img/1d917b9c3a4ba90749b59bfba70d052d.png)****

****å¸¦ä¿¡å·æ ‡è®°çš„å›¾è¡¨****

****è¿™ä¸ªç³»ç»Ÿæ¯”å‰ä¸€ä¸ªç³»ç»Ÿæœ‰æ›´å¤šçš„ä¿¡å·ï¼Œå›¾è¡¨çœ‹èµ·æ¥å¾ˆæ‹¥æŒ¤ã€‚æˆ‘ä»¬å¯ä»¥è¯¦ç»†æŸ¥çœ‹ä»»ä½•æ—¥æœŸèŒƒå›´:****

```
**plot_system2_sig(df2['2018-12-01':'2019-05-30'])**
```

****![](img/d9114cbb04db7210be08887ecdc0dce3.png)****

****æ—¥æœŸèŒƒå›´è¯¦ç»†ä¿¡æ¯****

****æˆ‘ä»¬åº”ç”¨ä¸Žä¹‹å‰ç›¸åŒçš„è®¡ç®—æ¥èŽ·å¾—ç­–ç•¥çš„å›žæŠ¥:****

```
**# The returns of the Buy and Hold strategy:
df2['Hold'] = np.log(df2['Adj Close'] / df2['Adj Close'].shift(1))# The returns of the Moving Average strategy:
df2['Strategy'] = df2['Position'].shift(1) * df2['Hold']# We need to get rid again of the NaN generated in the first row:
df2.dropna(inplace=True)returns2 = np.exp(df2[['Hold', 'Strategy']].sum()) -1print(f"Buy and hold return: {round(returns2['Hold']*100,2)}%")
print(f"Strategy return: {round(returns2['Strategy']*100,2)}%")**
```

****è¾“å‡º:****

```
**Buy and hold return: 17.04%
Strategy return: -5.25%**
```

****å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å¹´è®¡ç®—å›žæŠ¥çŽ‡:****

```
**n_days2 = len(df2)# Assuming 252 trading days in a year:
ann_returns2 = 252 / n_days2 * returns2print(f"Buy and hold annualized return: {round(ann_returns2['Hold']*100,2)}%")
print(f"Strategy annualized return: {round(ann_returns2['Strategy']*100,2)}%")**
```

****è¾“å‡º:****

```
**Buy and hold annualized return: 3.52%
Strategy annualized return: -1.09%**
```

****åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ç­–ç•¥å®žé™…ä¸Šä¸å¦‚*ä¹°å…¥å¹¶æŒæœ‰*ç­–ç•¥ã€‚****

****ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæˆ‘ä½¿ç”¨**æœªè°ƒæ•´çš„ä»·æ ¼åºåˆ—**æ¥è¯„ä¼°ä¿¡å·ï¼Œè€Œæˆ‘ä¸€ç›´ä½¿ç”¨è°ƒæ•´åŽçš„ä»·æ ¼æ¥è®¡ç®—å›žæŠ¥ã€‚æ¯å½“è‚¡æ¯ã€æ‹†åˆ†æˆ–å…¶ä»–å…¬å¸è¡Œä¸ºé€ æˆä»·æ ¼ç¼ºå£æ—¶ï¼Œä½¿ç”¨æœªç»è°ƒæ•´çš„ä»·æ ¼è¯„ä¼°ä¿¡å·æœ‰å¼•å…¥é”™è¯¯è§¦å‘çš„é£Žé™©ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åªæ˜¯ç”¨äº†ä¸€ä¸ªä»·æ ¼ç³»åˆ—ï¼Œè¿™ä¸ªä»·æ ¼ç³»åˆ—å¾ˆå¸¸è§ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å…è´¹ä¸‹è½½ã€‚å¦‚æžœæˆ‘ä»¬åªæœ‰æœªè°ƒæ•´çš„ä»·æ ¼ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨æ‰€æœ‰å…³äºŽå…¬å¸è¡Œä¸ºçš„ä¿¡æ¯æ¥ä¿®æ­£æˆ‘ä»¬çš„å›žæº¯æµ‹è¯•ã€‚****

# ****ç»“è®º****

****è¿™å°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå›žæº¯æµ‹è¯•å’Œé€‰æ‹©å¯ä»¥ä¾èµ–çš„ç­–ç•¥æ‰€éœ€è¦çš„å—ï¼Ÿè‚¯å®šä¸æ˜¯:åœ¨æˆ‘ä»¬çš„å›žæº¯æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬åšäº†(å°½ç®¡æ˜¯éšå«çš„)ä¸€äº›å‡è®¾å’Œç®€åŒ–ï¼Œè¿™äº›å‡è®¾å’Œç®€åŒ–ä¼šæžå¤§åœ°å½±å“æˆ‘ä»¬çš„ç»“æžœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾ä¸€åªè‚¡ç¥¨å¯ä»¥åœ¨ä¿¡å·è§¦å‘å½“å¤©çš„æ”¶ç›˜ä»·ä¹°å…¥ã€‚å®žé™…ä¸Šï¼Œè¿™æ˜¯ä¸èƒ½ä¿è¯çš„:å®žé™…ä»·æ ¼å°†åœ¨ä¿¡å·å‘ç”ŸåŽä¸€å¤©çš„èŒƒå›´å†…ã€‚é‚£ä¹ˆï¼Œ**äº¤æ˜“æˆæœ¬**å°±ä¸å¾—ä¸åŒ…æ‹¬åœ¨å†…äº†ã€‚ä¾‹å¦‚:****

*   ****æ”¯ä»˜ç»çºªè´¹æ˜¯ä¸ºäº†æ‰§è¡Œå’Œæ¸…ç®—æˆ‘ä»¬çš„è®¢å•ã€‚****
*   ****ä¹°ä»·å’Œå–ä»·ä¹‹é—´çš„ä»·å·®æ˜¯æˆæœ¬çš„ä¸€éƒ¨åˆ†ã€‚****
*   ****å¦‚æžœæˆ‘ä»¬åˆ©ç”¨æ æ†ä¹°å…¥ï¼Œæˆ‘ä»¬éœ€è¦æ”¯ä»˜åˆ©æ¯ã€‚åŒæ ·ï¼Œå¦‚æžœæˆ‘ä»¬å€Ÿå…¥è‚¡ç¥¨å–ç©ºï¼Œæˆ‘ä»¬éœ€è¦æ”¯ä»˜è´·æ¬¾åˆ©æ¯ã€‚****

****å…¶ä¸­ä¸€äº›å› ç´ æ¯”å…¶ä»–å› ç´ æ›´å®¹æ˜“ç†è§£å¹¶åŒ…å«åœ¨æ¨¡åž‹ä¸­ã€‚****

****å½“æˆ‘ä»¬æƒ³è¦è¯„ä¼°ä¸€ä¸ªç³»ç»Ÿçš„æ€§èƒ½å¹¶å°†å…¶ä¸Žå…¶ä»–ç³»ç»Ÿçš„æ€§èƒ½è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œç»™å®šæœŸé—´çš„å›žæŠ¥åªæ˜¯æˆ‘ä»¬æƒ³è¦è€ƒè™‘çš„ä¼—å¤š**æ€§èƒ½å’Œé£Žé™©æŒ‡æ ‡**ä¸­çš„ä¸€ä¸ªã€‚ä¸€äº›ä¾‹å­æ˜¯:****

*   *****æˆåŠŸäº¤æ˜“ä¸Žå¤±è´¥äº¤æ˜“çš„ç™¾åˆ†æ¯”*ã€‚****
*   ****æœ€å¤§[ææ¬¾](https://www.investopedia.com/terms/d/drawdown.asp):æˆ‘ä»¬ç´¯ç§¯åˆ©æ¶¦çš„æœ€é«˜ç‚¹å’Œæœ€ä½Žç‚¹ä¹‹é—´çš„å·®é¢ã€‚****
*   ****æ”¶ç›Šçš„*æ ‡å‡†å·®*å’Œ*å¤æ™®æ¯”çŽ‡*ã€‚****
*   ****[é£Žé™©/å›žæŠ¥æ¯”](https://www.investopedia.com/terms/r/riskrewardratio.asp)ï¼Œè¿™æ˜¯æˆ‘ä»¬æ¯æŠ•èµ„ä¸€ç¾Žå…ƒï¼Œä»Žä¸€ç¬”äº¤æ˜“ä¸­å¯ä»¥èŽ·å¾—çš„é¢„æœŸå›žæŠ¥ã€‚****

****æˆ‘ä»¬åˆšåˆšä»‹ç»çš„å‡†ç³»ç»Ÿå›žæº¯æµ‹è¯•ä¸ºè®¡ç®—æ‰€æœ‰è¿™äº›æŒ‡æ ‡å’Œæž„å»ºæ›´çŽ°å®žçš„ç³»ç»Ÿæä¾›äº†èµ·ç‚¹ã€‚****

****å‡ºäºŽæ‰€æœ‰è¿™äº›åŽŸå› ï¼Œé™¤éžæˆ‘ä»¬æƒ³ä»Žé›¶å¼€å§‹å»ºç«‹ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œå¦‚æžœæˆ‘ä»¬éœ€è¦å®žé™…åœ°å›žæº¯æµ‹è¯•ä¸€ä¸ªç­–ç•¥ï¼Œæœ€å¥½çš„é€‰æ‹©å¾ˆå¯èƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ *Zipline* æˆ– *Backtrader* ã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»Žå¤´å¼€å§‹ç¼–å†™å›žæº¯æµ‹è¯•æ—¶ï¼Œæˆ‘ä»ç„¶ä¸æ–­åœ°å­¦ä¹ å¾ˆå¤šå…³äºŽæŒ‡æ ‡å’Œç­–ç•¥çš„çŸ¥è¯†ï¼Œè¿™æ˜¯æˆ‘ç»å¯¹æŽ¨èçš„ç»ƒä¹ ã€‚****