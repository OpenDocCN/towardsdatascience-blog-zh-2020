# 在 Python 中使用当前人口调查

> 原文：<https://towardsdatascience.com/using-the-current-population-survey-in-python-354f938e6e3e?source=collection_archive---------58----------------------->

![](img/8bf46e4e5658499bcb078dcb08a2cb21.png)

克里斯里德在 [Unsplash](https://unsplash.com/) 上的照片

我花了长周末的大部分时间浏览所有公开的关于消费者金融和劳动力的数据。这是一个长期项目的一部分，但我现在必须分享我遇到的一些困难，这些困难无法通过堆栈溢出或其他资源来解决。

教训很明显:用 Python 处理 [CPS 数据](https://www.census.gov/programs-surveys/cps.html)很难。我依靠了一些资源，比如 Brian Dew 的经济学博客和 Tom Augspurger 的工具，它们在缺少 API 的情况下帮助很大。但是因为我主要是想导入尽可能多的数据，并把它读入熊猫数据框，所以我不得不利用他们的技术来做一些符合我的目的的东西。我想出的一般方法如下。

# 该方法

我遇到的第一个障碍是，我找到的大多数资源都在 CPS 中寻找数据子集，无论是按时间框架还是按变量。你可能会认为，不用担心子集，我所要做的就是处理 CPS 数据本身的古怪，但是唉。

总的来说，CPS 数据的古怪相对简单地分解了方法。

对于一年中的任何给定月份，CPS 提供:

1.  。存储在 zip 文件夹中的 dat 文件
2.  答。当年使用的 txt 数据字典

虽然 CPS 没有以更容易阅读的方式提供。csv 或。dta 的步骤还是很容易理解的。一般的方法是(1)使用数据字典查找变量及其位置的解析参数，以及(2)从。dat 文件转换成数据帧。

同样，你会认为给定资源，我发现实现我的目标会很容易。对我发现的代码进行一些调整，应该可以让我轻松地获得给定月份的每个变量的数据，并在 CPS 中这样做很多年。然而，这第一步是最困难的，需要最多的变通办法。我希望提供一个更完整的解决方案，但我会在这里检查几个问题和解决方案。

# 问题 1:检索并解析出相关的数据字典

我不确定我是否有先见之明，或者只是固执地记录我从网上检索数据的确切位置，但第一个挑战涉及实际检索和解析数据字典。

首先，正如您在下面看到的，存储字典的地方没有一致的 URL 样式。第二，有时数据字典适用多年或仅适用几个月。最后，数据字典有多种组织相关数据的方式。

# 第一课:如果其他方法都失败了，那就放弃吧

如果你快速浏览一下自 1998 年以来所有可用的数据字典，你会发现它们所在的 URL 并不一致。并且没有明确的模式来决定一个字典何时退役或者更新到足够多的异常。

真正让我明白如何解析每个 URL 的是编写一长串 if-elif 语句。正如您在下面的片段中所看到的，2020 年大大改变了他们的 URL，数据字典在 2012 年进行了更新，在 2012 年之前，URL 格式似乎有所改变。使用下面的 if-elif 代码可以更容易地识别和归纳这些模式，但是显然需要归纳成可读性更好的东西。

URL 的变化是最不重要的问题。数据字典本身在 2002 年发生了巨大的变化，用一种完全不同的模式来描述 CPS 变量。下面你可以看到另一个 if-elif 链，显示了这些年来的变化。尽管它们已经相对一般化了，但是这个 if-elif 链还有一个额外的好处，那就是显示主要变化发生的时间。

# 问题 2:准备用于熊猫数据框的数据

如果你看一个. dat 文件，人眼完全看不懂。所以要把它变成类似桌子的东西需要一点准备。这里的主要问题是获得。dat 文件转换成稍微更有组织的形式，就像一个元组列表，其中每个元组都是数据帧中的一行。

之前的资源提供了一个很棒的[例子【2017 年 4 月数据:](https://www.bd-econ.com/cps.html)

然而，当我查看前几年的数据时，你开始遇到问题。dat 文件，如包含杂散*字符或字母。你可以在代码中看到这一点。dat 数据将被转换成 int。

# 第二课:垂直阅读而不是水平阅读

为了解决这个问题，我必须创建一个助手函数来识别哪里的数据不能作为 int 读取，并提供一个估算值。在这种情况下，估算值将为“-1”，因为它经常在 CPS 数据中用作“不适用”值，但肯定需要对变量进行双重检查。

鉴于上面的代码缺乏可读性和代码嵌套，调整它来执行这样的操作有点困难。一般来说，水平阅读代码比垂直阅读代码更难，即使垂直阅读一开始看起来有点奇怪。

您可以看到下面的转换示例有一些好处。首先，更容易理解列表理解是如何工作的，以及每行代码是如何分组的。

其次，它读起来几乎完全像一步一步的指导，而不是文学的一句俏皮话。每行都有一个括号，读起来就像它自己的步骤，就像“开始组”或“结束列表”。

下面的代码仍然不漂亮，需要更多的 Python 禅宗，但它的工作。

# 问题 3:我想要更多的数据！！

这是更严重的问题之一。因为我的主要目标是尽可能多地收集数据，所以我倾向于让我的代码把所有东西放在一个整洁的包里。当然，在我的笔记本电脑上这样做肯定会导致一些内核重启。

# 第三课:概括，但不要太多

解决方法很简单:保持简单。在这种情况下，我不得不限制自己编写能够一次获得一个月 CPS 数据的代码。我还不得不阻止自己制作额外的助手功能，通过互联网存档对数据源进行存档，但我认为这将是我的下一个项目。

# 最后的想法

真的没有什么可以代替你自己去尝试。因为我真的对获取尽可能多的数据感兴趣，如果你真的只是对特定的数据集感兴趣，你可能会遇到较少的问题。但是你和我一样，希望这些课程能对你的 CPS 工作有所帮助。