<html>
<head>
<title>Applying Artificial Intelligence techniques in the development of a web-app for the detection of Covid-19 in X-ray images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将人工智能技术应用于在X射线图像中检测新冠肺炎的网络应用程序的开发</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/applying-artificial-intelligence-techniques-in-the-development-of-a-web-app-for-the-detection-of-9225f0225b4?source=collection_archive---------48-----------------------#2020-05-18">https://towardsdatascience.com/applying-artificial-intelligence-techniques-in-the-development-of-a-web-app-for-the-detection-of-9225f0225b4?source=collection_archive---------48-----------------------#2020-05-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a8cb19e27392eb8a98f581f471f1816e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IX5P1Ffj9N_Hld33UnX4Iw.png"/></div></div></figure><h2 id="d18a" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">放弃</h2><p id="1c85" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">此处开发的自动检测X射线图像中新冠肺炎的研究严格用于教育目的。最终应用并不旨在成为用于诊断人类新冠肺炎的可靠和准确的诊断系统，因为它还没有经过专业或学术评估。</p><h2 id="08b2" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">介绍</h2><p id="7020" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">新冠肺炎是一种由病毒(新型冠状病毒冠状病毒)引起的疫情病，这种病毒已经感染了数百万人，在几个月内导致数十万人死亡。</p><p id="fdd8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">根据世界卫生组织(世卫组织)，大多数新冠肺炎患者(约80%)可能无症状，约20%的病例可能需要医院护理，因为他们呼吸困难。在这些病例中，大约5%可能需要呼吸衰竭治疗的支持(通气支持)，这种情况可能会使重症监护设施崩溃。快速检测病毒携带者的方法是抗击疫情的关键。</p><p id="18a7" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><strong class="kz iu">什么是冠状病毒？</strong></p><p id="d868" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">冠状病毒是导致呼吸道感染的病毒家族。这种新型冠状病毒制剂是1919年底在中国发现病例后发现的。它会导致一种叫做冠状病毒(新冠肺炎)的疾病。</p><p id="7032" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">1937年首次分离出人类冠状病毒。然而，直到1965年，这种病毒才被描述为冠状病毒，因为它在显微镜下看起来像一个皇冠。在下面的视频中，您可以看到新型冠状病毒病毒的原子级3D模型:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><a href="https://youtu.be/y6VC9UqAXHA"><div class="gh gi lx"><img src="../Images/34bf4d069d9ae9150496ea234a67d5f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpzRis7So8bmkhYcr-UJdA.png"/></div></a><p class="mc md gj gh gi me mf bd b be z dk translated">点击图片查看YouTube视频</p></figure><p id="2d2e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><strong class="kz iu">为什么是x光？</strong></p><p id="24f9" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">最近，在应用机器学习来辅助基于计算机断层扫描(CT)的新冠肺炎诊断方面已经观察到了一些有前途的努力。尽管这些方法取得了成功，但事实仍然是，新冠肺炎是一种正在各种规模的社区中大力传播的传染病，尤其是最需要帮助的人。</p><p id="dce3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">x光机更便宜、更简单、操作速度更快，因此对于在更贫困或更偏远地区工作的医疗专业人员来说，比CT更容易获得。</p><h2 id="d7e8" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">目标</h2><p id="1db2" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">抗击新冠肺炎的重大挑战之一是检测病毒在人群中的存在。因此，该项目的目标是使用扫描的胸部X射线图像，自动检测肺炎患者(甚至无症状或未患病的人)中导致新冠肺炎的病毒。这些图像经过预处理，用于训练卷积神经网络(CNN)模型。</p><p id="94e1" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">CNN类型的网络通常需要大量数据集才能运行。尽管如此，在这个项目中，应用了一种称为“迁移学习”的技术，这在数据集很小的情况下非常有用(确诊的新冠肺炎患者的图像)。</p><p id="750f" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">开发了两种分类模型:</p><ol class=""><li id="4edb" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">检测新冠肺炎与诊断具有正常胸部X线结果的患者</li><li id="ec64" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">新冠肺炎与肺炎患者的检测</li></ol><p id="9db3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">正如论文<a class="ae mu" href="https://arxiv.org/abs/2003.11597" rel="noopener ugc nofollow" target="_blank">新冠肺炎图像数据收集</a>中所定义的，所有类型的肺炎(除了由新冠肺炎病毒引起的)都被认为是“肺炎”(并以肺炎标签分类)。</p><p id="6207" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对于模型的训练，使用了<a class="ae mu" href="https://www.tensorflow.org" rel="noopener ugc nofollow" target="_blank"> <em class="mv">的工具、库、资源，TensorFlow </em> </a> <em class="mv"> 2.0 </em>(带Keras)，这是一个开源的平台，用于机器学习，或者更准确的说，深度学习。最终的模型是在Flask中开发的web应用程序(web-app)的基础，用于在接近现实的情况下进行测试。</p><p id="2b17" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">下图为我们提供了最终应用程序如何工作的基本概念:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/a21b867131ede514632e9b3ed69f7170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OAK7PITl6mM_0jXYddz4gQ.png"/></div></div></figure><p id="8d7f" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从存储在web-app用户计算机上的胸部x光扫描图像(User_A.png)中，该应用程序决定该图像是否属于被病毒污染的人(模型预测:[阳性]或[阴性])。在这两种情况下，应用程序都会告知预测的准确性(模型准确性:X%)。为了避免两者的错误，原始文件的名称和它的图像被显示给用户。图像的新副本存储在本地，其名称被添加到预测标签加上准确度值。</p><p id="6c33" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">这项工作分为4个部分:</p><ol class=""><li id="daa8" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">环境设置、数据采集、清洁和准备</li><li id="c824" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">模型1培训(Covid/正常)</li><li id="d77c" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">模式2培训(Covid/Pneumo)</li><li id="4e75" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">用于在X射线图像中检测新冠肺炎的Web应用程序的开发和测试</li></ol><h2 id="184f" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">灵感</h2><p id="686d" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">该项目的灵感来自于UFRRJ(巴西里约热内卢联邦农村大学)开发的<a class="ae mu" href="http://tools.atislabs.com.br/covid" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> XRayCovid-19 </em> </a>项目的概念验证。UFRRJ XRayCovid-19是一个正在进行的项目，该项目将人工智能用于新冠肺炎医疗系统的诊断过程。该工具的特点是易于使用，响应时间效率高，结果有效，我希望将这些特点扩展到本教程第4部分中开发的Web应用程序。下面是一个诊断结果的打印屏幕(使用了新冠肺炎数据集1的一幅图像):</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/da4c08b3a2486b2a3c3a8b68a702149e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*pLrIFFHJBI0jXCiNJ7aaHA.png"/></div></figure><p id="aebc" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">该大学所开展工作的科学基础可以在Chowdhury等人的论文中看到2020，<a class="ae mu" href="https://arxiv.org/abs/2003.13145" rel="noopener ugc nofollow" target="_blank"><em class="mv">AI能否帮助筛查病毒性和新冠肺炎肺炎？</em>T15】</a></p><p id="13a5" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">除了用于比较模型的结果之外，另一项激动人心的工作也启发了这个项目，这就是Chester应用程序<a class="ae mu" href="https://arxiv.org/pdf/1901.11210.pdf" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> Chester:由蒙特利尔大学的研究人员开发的一个Web交付的本地计算胸部X射线疾病预测系统</em></a><em class="mv"/>。Chester是一个免费的简单原型，可以由医疗专业人员用来了解深度学习工具的现实，以帮助诊断胸部的X射线。该系统被设计为第二意见，其中用户可以处理图像以确认或帮助诊断。</p><p id="24f1" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">当前版本的Chester (2.0)使用DenseNet-121型卷积网络对超过106，000幅图像进行了训练。这款网络应用没有检测到新冠肺炎，这是研究人员未来版本应用的目标之一。下面是一个诊断结果的打印屏幕(使用了新冠肺炎数据集1的一幅图像)</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/69db9d17b74cadd13a4ec51309771b46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FNq7aC_SVB2h57sII_ZTTA.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">人工智能放射学助理切斯特</p></figure><p id="a9a5" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">在下面的链接中，你可以访问<a class="ae mu" href="https://mlmed.org/tools/xray/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">切斯特</em> </a>甚至下载app离线使用。</p><h2 id="fed5" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">谢谢</h2><p id="5c3b" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">这部作品最初是基于Adrian Rosebrock博士发表的优秀教程开发的，我强烈推荐深入阅读。此外，我要感谢Nell Trevor，他在Rosebrock博士工作的基础上，进一步提供了如何测试最终模型的想法。在下面的链接中，Nell通过PythonAnyware.com网站提供了一个在X射线图像中对新冠肺炎进行真实测试的网络应用:<a class="ae mu" href="http://coviddetector.pythonanywhere.com/" rel="noopener ugc nofollow" target="_blank">新冠肺炎预测API </a>。</p><h1 id="5548" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">第1部分—环境设置和数据准备</h1><h2 id="4b5f" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据集</h2><p id="3783" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">训练模型以从图像中检测任何类型的信息的第一个挑战是要使用的数据(或图像)的数量。原则上，图像的数量越多，最终的模型就越好，这与新冠肺炎探测项目的情况不同，一旦公开的图像不多(记住，这个疫情只有几个月大)。然而，像Hall等人<a class="ae mu" href="https://arxiv.org/pdf/2004.02060.pdf" rel="noopener ugc nofollow" target="_blank"> <em class="mv">使用小数据集</em> </a> <em class="mv">，</em>上的深度学习从胸部X射线中发现新冠肺炎的研究证明，使用迁移学习技术仅用几百张图像就可以获得有希望的结果。</p><p id="aec4" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">如介绍中所解释的，训练两个模型；因此，需要3组数据:</p><ol class=""><li id="38e3" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">新冠肺炎确认了一组x光图像</li><li id="ba24" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">常规(“正常”)患者(无疾病)的一组X射线图像</li><li id="2940" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">一组x光图像显示肺炎，但不是由新冠肺炎引起的</li></ol><p id="821f" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">为此，下载了两个数据集:</p><p id="1082" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">数据集1:新冠肺炎 <br/>约瑟夫·保罗·寇恩和保罗·莫里森与蓝岛·新冠肺炎影像数据集，arXiv: 2003.11597，2020</p><p id="ce11" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">新冠肺炎或其他病毒性和细菌性肺炎(MERS、SARS和ARDS)阳性或疑似患者的X射线和计算机断层扫描图像的公开数据集。).数据从公共来源收集，以及通过医院和医生间接收集(蒙特利尔大学伦理委员会批准的项目# CERSES-20–058-D)。所有的图像和数据都可以在下面的<a class="ae mu" href="https://github.com/ieee8023/covid-chestxray-dataset" rel="noopener ugc nofollow" target="_blank"> GitHub </a>库中找到。</p><p id="0cb8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><strong class="kz iu">数据集2:肺炎和正常人的胸部x光图像</strong> <br/> Kermany，Daniel张、康；Goldbaum，Michael (2018)，“用于分类的标记光学相干断层扫描(OCT)和胸部X射线图像”，Mendeley Data，v2。</p><p id="3943" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">通过深度学习过程，一组经过验证的图像(OCT和胸部放射摄影)被分类为正常和某种类型的肺炎。图像被分成训练集和独立的患者测试集。数据可在网站上获得:<a class="ae mu" href="https://data.mendeley.com/datasets/rscbjbr9sj/2" rel="noopener ugc nofollow" target="_blank">https://data.mendeley.com/datasets/rscbjbr9sj/2</a></p><p id="6bbb" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><strong class="kz iu">胸部x光的种类</strong></p><p id="32bb" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从数据集中，可以找到三种类型的图像，PA、AP和侧位(L)。左侧图像(L)很明显，但是X线AP和PA视图之间有什么区别？简单地说，在拍摄X射线的过程中，当X射线从身体的后部穿过到前部时，它被称为PA(后部——前部)视图。而在AP视图中，方向是相反的。</p><p id="427a" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">通常，X射线是在身体任何部位的AP视图中拍摄的。这里一个重要的例外恰恰是胸部x光。在这种情况下，最好通过AP查看PA。但是如果病人病得很重，不能保持他的姿势，可以对胸部进行AP型x光检查。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/601d4e460f09c3337ad44bd090953605.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*HxVo4JP6CwVXMA1UupRNoQ.jpeg"/></div></figure><p id="6f57" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">由于绝大多数胸部X射线是PA型视图，这是用于训练模型的视图选择类型。</p><h2 id="8d2f" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">定义培训DL模型的环境</h2><p id="2de2" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">理想的情况是从新的Python环境开始。为此，使用终端，定义一个工作目录(例如:X-Ray_Covid_development ),然后在那里用Python创建一个环境(例如:TF_2_Py_3_7 ):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="5dae" class="kb kc it ns b gy nw nx l ny nz">mkdir X-Ray_Covid_development<br/>cd X-Ray_Covid_development<br/>conda create — name TF_2_Py_3_7 python=3.7 -y<br/>conda activate TF_2_Py_3_7</span></pre><p id="9af9" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">进入环境后，安装TensorFlow 2.0:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6f54" class="kb kc it ns b gy nw nx l ny nz">pip install — upgrade pip<br/>pip install tensorflow</span></pre><p id="7f53" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从现在开始，安装训练模型所需的其他库。例如:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="8d4f" class="kb kc it ns b gy nw nx l ny nz">conda install -c anaconda numpy<br/>conda install -c anaconda pandas<br/>conda install -c anaconda scikit-learn<br/>conda install -c conda-forge matplotlib<br/>conda install -c anaconda pillow<br/>conda install -c conda-forge opencv<br/>conda install -c conda-forge imutils</span></pre><p id="f6fd" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">创建必要的子目录:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="9f3d" class="kb kc it ns b gy nw nx l ny nz">notebooks<br/>10_dataset — <br/>           |_ covid  [here goes the dataset for training model 1]<br/>           |_ normal [here goes the dataset for training model 1]<br/>20_dataset — <br/>           |_ covid  [here goes the dataset for training model 2]<br/>           |_ pneumo [here goes the dataset for training model 2]<br/>input - <br/>      |_ 10_Covid_Imagens _ <br/>      |                   |_ [<em class="mv">metadata.csv goes here</em>]<br/>      |                   |_ images [<em class="mv">Covid-19 images go here</em>]<br/>      |_ 20_Chest_Xray -<br/>                       |_ test _<br/>                               |_ NORMAL    [<em class="mv">images go here</em>]<br/>                               |_ PNEUMONIA [<em class="mv">images go here</em>]<br/>                       |_ train _<br/>                                |_ NORMAL    [<em class="mv">images go here</em>]<br/>                                |_ PNEUMONIA [<em class="mv">images go here</em>]<br/>model<br/>dataset_validation _<br/>                   |_ covid_validation          [<em class="mv">images go here</em>]<br/>                   |_ non_covidcovid_validation [<em class="mv">images go here</em>]<br/>                   |_ normal_validation         [<em class="mv">images go here</em>]</span></pre><h2 id="03aa" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据下载</h2><p id="db8e" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">下载数据集1(新冠肺炎)，并将文件metadata.csv保存在:/input /10_Covid_Images/下，并将图像保存在/input/10_Covid_Images/images/下。</p><p id="453d" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">下载数据集2(pneumono和Normal)，将图像保存在/input/20_Chest_Xray/(保持原来的测试和训练结构)下。</p><h1 id="45e2" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">第2部分—模型1—Covid/正常</h1><h2 id="915a" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据准备</h2><ul class=""><li id="ba45" class="mg mh it kz b la lb le lf kk oa ko ob ks oc lr od mm mn mo bi translated">从我的GitHub下载笔记本:<a class="ae mu" href="https://github.com/Mjrovai/covid19Xray/blob/master/10_X-Ray_Covid_development/notebooks/10_Xray_Normal_Covid19_Model_1_Training_Tests.ipynb" rel="noopener ugc nofollow" target="_blank"><em class="mv">10 _ Xray _ Normal _ covid 19 _ Model _ 1 _ Training _ tests . ipynb</em></a>保存在子目录/notebooks中。</li><li id="da6d" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr od mm mn mo bi translated">进入笔记本后，导入库并运行支持功能。</li></ul><p id="9be0" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><strong class="kz iu">构建Covid标签数据集</strong></p><p id="7006" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从输入数据集(/input/10_Covid_Images/)中，创建将用于训练模型1的数据集，该数据集将用于要用Covid和normal标签定义的图像的分类。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="b002" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = ‘../input/10_Covid_images’</span></pre><p id="33b8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">metadata.csv文件将提供有关/images/文件中图像的信息</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="b67b" class="kb kc it ns b gy nw nx l ny nz">csvPath = os.path.sep.join([input_dataset_path, “metadata.csv”])<br/>df = pd.read_csv(csvPath)<br/>df.shape</span></pre><p id="9c84" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">metadat.csv文件有354行和28列，这意味着在子目录/images/中有354个X射线图像。让我们分析它的一些列，以了解这些图像的更多细节。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/d9cd10e1151fa9f6d5206576f71639ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*rCqPOQ73IoIs-Ml6G__7gQ.png"/></div></figure><p id="4171" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">通过df.modality，有310个X射线图像和44个CT(断层摄影)图像。CT图像被丢弃，并且df.findings列显示310个X射线图像被细分为:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="dcae" class="kb kc it ns b gy nw nx l ny nz">COVID-19          235<br/>Streptococcus      17<br/>SARS               16<br/>Pneumocystis       15<br/>COVID-19, ARDS     12<br/>E.Coli              4<br/>ARDS                4<br/>No Finding          2<br/>Chlamydophila       2<br/>Legionella          2<br/>Klebsiella          1</span></pre><p id="2903" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从可视化的角度来看235张确认的新冠肺炎图像，我们有:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="e09d" class="kb kc it ns b gy nw nx l ny nz">PA               142<br/>AP                39<br/>AP Supine         33<br/>L                 20<br/>AP semi erect      1</span></pre><p id="a463" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">如引言中所述，只有142个PA型图像(后-前)用于模型训练，因为它们是胸片中最常见的图像(最终数据帧:xray_cv)。</p><blockquote class="of og oh"><p id="f9fa" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">xray _ cv.patiendid列显示，这142幅图像属于96名不同的患者，这意味着在某些情况下，同一患者拍摄了不止一张x光照片。由于所有图像都用于训练(我们对图像的内容感兴趣)，因此不考虑这些信息。</p></blockquote><p id="b528" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">到x射线cv.date，观察到有8张最近的图像拍摄于2020年3月。这些图像在要从模型训练中移除的列表中被分离。从而在以后用作最终模型的验证。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="8860" class="kb kc it ns b gy nw nx l ny nz">imgs_march = [<br/> ‘2966893D-5DDF-4B68–9E2B-4979D5956C8E.jpeg’,<br/> ‘6C94A287-C059–46A0–8600-AFB95F4727B7.jpeg’,<br/> ‘F2DE909F-E19C-4900–92F5–8F435B031AC6.jpeg’,<br/> ‘F4341CE7–73C9–45C6–99C8–8567A5484B63.jpeg’,<br/> ‘E63574A7–4188–4C8D-8D17–9D67A18A1AFA.jpeg’,<br/> ‘31BA3780–2323–493F-8AED-62081B9C383B.jpeg’,<br/> ‘7C69C012–7479–493F-8722-ABC29C60A2DD.jpeg’,<br/> ‘B2D20576–00B7–4519-A415–72DE29C90C34.jpeg’<br/>]</span></pre><p id="1787" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">下一步将构建指向训练数据集(xray_cv_train)的数据帧，该数据帧应引用134幅图像(所有输入图像均来自Covid，除了用于稍后验证的单独图像):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6246" class="kb kc it ns b gy nw nx l ny nz">xray_cv_train = xray_cv[~xray_cv.filename.isin(imgs_march)]<br/>xray_cv_train.reset_index(drop=True, inplace=True)</span></pre><p id="d577" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">而最终验证(x射线_cv_val)有8幅图像:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="e9bc" class="kb kc it ns b gy nw nx l ny nz">xray_cv_val = xray_cv[xray_cv.filename.isin(imgs_march)]<br/>xray_cv_val.reset_index(drop=True, inplace=True)</span></pre><h2 id="2796" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">为COVID训练图像和后续验证创建文件</h2><p id="de2b" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">请务必记住，在前面的项目中，仅使用从原始文件metada.csv中获取的信息创建了数据帧。我们知道要将哪些图像存储在最终文件中用于训练，现在我们需要将实际图像(以数字化格式)“物理”分离到正确的子目录(文件夹)中。</p><p id="7127" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">为此，我们将使用load_image_folder support()函数，该函数从一个元数据文件中将其中引用的图像从一个文件复制到另一个文件:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1834" class="kb kc it ns b gy nw nx l ny nz">def load_image_folder(df_metadata, <br/>                      col_img_name, <br/>                      input_dataset_path,<br/>                      output_dataset_path):<br/>    <br/>    img_number = 0<br/>    # loop over the rows of the COVID-19 data frame<br/>    for (i, row) in df_metadata.iterrows():<br/>        imagePath = os.path.sep.join([input_dataset_path, row[col_img_name]])</span><span id="462a" class="kb kc it ns b gy ol nx l ny nz">        if not os.path.exists(imagePath):<br/>            print('image not found')<br/>            continue</span><span id="9716" class="kb kc it ns b gy ol nx l ny nz">        filename = row[col_img_name].split(os.path.sep)[-1]<br/>        outputPath = os.path.sep.join([f"{output_dataset_path}", filename])<br/>        shutil.copy2(imagePath, outputPath)<br/>        img_number += 1<br/>    print('{} selected Images on folder {}:'.format(img_number, output_dataset_path))</span></pre><p id="3e5c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">按照下面的说明，134幅选定的图像将被复制到文件夹中../10_dataset/covid/。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="8f58" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = '../input/10_Covid_images/images'<br/>output_dataset_path = '../dataset/covid'<br/>dataset = xray_cv_train<br/>col_img_name = 'filename'</span><span id="9319" class="kb kc it ns b gy ol nx l ny nz">load_image_folder(dataset, col_img_name,<br/>                  input_dataset_path, output_dataset_path)</span></pre><h2 id="b704" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">为普通图像创建文件夹(验证和培训)</h2><p id="da0d" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">在数据集2(正常和肺炎图像)的情况下，不提供具有元数据的文件。因此，您只需将图像从输入文件复制到末尾。为此，我们将使用load_image_folder_direct()支持函数，该函数将大量图像(随机选择)从一个文件夹复制到另一个文件夹:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="227f" class="kb kc it ns b gy nw nx l ny nz">def load_image_folder_direct(input_dataset_path,<br/>                             output_dataset_path,<br/>                             img_num_select):<br/>    img_number = 0<br/>    pathlist = Path(input_dataset_path).glob('**/*.*')<br/>    nof_samples = img_num_select<br/>    rc = []<br/>    for k, path in enumerate(pathlist):<br/>        if k &lt; nof_samples:<br/>            rc.append(str(path))  # because path is not string<br/>            shutil.copy2(path, output_dataset_path)<br/>            img_number += 1<br/>        else:<br/>            i = random.randint(0, k)<br/>            if i &lt; nof_samples:<br/>                rc[i] = str(path)</span><span id="e9f1" class="kb kc it ns b gy ol nx l ny nz">    print('{} selected Images on folder {}:'.format(img_number,  output_dataset_path))</span></pre><p id="d0af" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对文件夹中的图像重复相同的过程../input/20 _ Chest _ Xray/train/NORMAL，我们将为训练随机复制与之前用于Covid图像相同数量的图像(len (xray_cv_train))或134幅图像。这样，用于训练模型的数据集就平衡了。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="18e7" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = '../input/20_Chest_Xray/train/NORMAL'<br/>output_dataset_path = '../dataset/normal'<br/>img_num_select = len(xray_cv_train)</span><span id="ba30" class="kb kc it ns b gy ol nx l ny nz">load_image_folder_direct(input_dataset_path, output_dataset_path,<br/>                         img_num_select)</span></pre><p id="320a" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">以同样的方式，我们分离20个随机图像，供以后在模型验证中使用。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="bdd1" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = '../input/20_Chest_Xray/train/NORMAL'<br/>output_dataset_path = '../dataset_validation/normal_validation'</span><span id="8ddd" class="kb kc it ns b gy ol nx l ny nz">img_num_select = 20<br/>load_image_folder_direct(input_dataset_path, output_dataset_path,<br/>                         img_num_select)</span></pre><p id="21d0" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">虽然我们不是用显示肺炎症状的图像来训练模型(新冠肺炎除外)，但看看最终的模型对它们的反应是很有趣的。因此，我们还分离了其中的20幅图像，以供以后验证。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1d58" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = '../input/20_Chest_Xray/train/PNEUMONIA'<br/>output_dataset_path = '../dataset_validation/non_covid_pneumonia_validation'</span><span id="df93" class="kb kc it ns b gy ol nx l ny nz">img_num_select = 20<br/>load_image_folder_direct(input_dataset_path, output_dataset_path,<br/>                         img_num_select)</span></pre><p id="8f57" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">下面的图片显示了在这一步结束时应该如何配置文件夹(反正是在我的Mac上)。此外，标有红色的数字表示文件夹中包含的x射线图像的数量。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi om"><img src="../Images/a5ff6b3e7a42026bfbaca410602f4794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2-GqgaHyqdbOdmdc2zz0Ew.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">包含模型1培训和验证数据集的文件夹</p></figure><h2 id="dc35" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">绘制数据集以进行快速视觉验证</h2><p id="7730" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">由于文件夹中的图像数量不多，因此可以对它们进行目视检查。为此，使用支持函数plots_from_files():</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="b327" class="kb kc it ns b gy nw nx l ny nz">def plots_from_files(imspaths,<br/>                     figsize=(10, 5),<br/>                     rows=1,<br/>                     titles=None,<br/>                     maintitle=None):<br/>    """Plot the images in a grid"""<br/>    f = plt.figure(figsize=figsize)<br/>    if maintitle is not None:<br/>        plt.suptitle(maintitle, fontsize=10)<br/>    for i in range(len(imspaths)):<br/>        sp = f.add_subplot(rows, ceildiv(len(imspaths), rows), i + 1)<br/>        sp.axis('Off')<br/>        if titles is not None:<br/>            sp.set_title(titles[i], fontsize=16)<br/>        img = plt.imread(imspaths[i])<br/>        plt.imshow(img)</span><span id="9d9c" class="kb kc it ns b gy ol nx l ny nz">def ceildiv(a, b):<br/>    return -(-a // b)</span></pre><p id="3b30" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">然后，定义将在训练中使用的数据集的路径(dataset_path)以及具有要查看的图像名称的列表:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="c919" class="kb kc it ns b gy nw nx l ny nz">dataset_path = '../10_dataset'</span><span id="91a9" class="kb kc it ns b gy ol nx l ny nz">normal_images = list(paths.list_images(f"{dataset_path}/normal"))<br/>covid_images = list(paths.list_images(f"{dataset_path}/covid"))</span></pre><p id="faec" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">这样，调用可视化的支持函数，图像显示如下:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="cfa0" class="kb kc it ns b gy nw nx l ny nz">plots_from_files(covid_images, rows=10, maintitle="Covid-19 X-ray images")</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/190890d56ba8c8ef206aa3895825ea82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*O79DezraF-MAN5feqJrT_Q.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">Covid图像可视化</p></figure><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="79dd" class="kb kc it ns b gy nw nx l ny nz">plots_from_files(normal_images, rows=10, maintitle="Normal X-ray images")</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/d27b22ad51fa8ce7bcca3844e65469ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*rzKVYk33k_ObQifey3ChWw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">正常图像可视化</p></figure><p id="d833" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">总的来说，图像看起来不错。</p><h2 id="1240" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">预训练卷积神经网络模型的选择</h2><p id="f947" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">使用先前定义的图像来执行模型的训练，但是在已经从TF / Keras库中预先训练的模型上，应用被称为“迁移学习”的技术。</p><blockquote class="of og oh"><p id="bc18" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">迁移学习是一种机器学习方法，其中为一个任务开发的模型被重新用作第二个任务中模型的起点。有关更多信息，请参见Jason Brownlee的优秀文章<a class="ae mu" href="https://machinelearningmastery.com/transfer-learning-for-deep-learning/" rel="noopener ugc nofollow" target="_blank">深度学习迁移学习的温和介绍</a></p></blockquote><p id="1ff3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">Keras应用程序是Keras的深度学习库模块，它为VGG16、ResNet50v2、ResNet101v2、Xception、MobileNet等几种流行的架构提供模型定义和预训练的权重。以下链接显示了这些选项:<a class="ae mu" href="https://github.com/keras-team/keras-applications" rel="noopener ugc nofollow" target="_blank"> Keras应用</a>。</p><p id="e7ae" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">要使用的预训练模型是VGG16，由牛津大学的视觉图形组(VGG)开发，并在论文“<a class="ae mu" href="https://arxiv.org/abs/1409.1556" rel="noopener ugc nofollow" target="_blank">用于大规模图像识别的非常深的卷积网络</a>”中描述。除了在开发公开可用权重的图像分类模型时非常流行之外，这也是Adrian博士在他的教程中建议的模型。</p><blockquote class="of og oh"><p id="1635" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">理想的情况是使用几个模型(例如，ResNet50v2、ResNet101v2)进行测试(基准测试)，或者甚至创建一个特定的模型(如Zhang等人的论文中建议的模型，【使用基于深度学习的异常检测对胸部X射线图像进行筛查】)。但由于这项工作的最终目标只是概念验证，我们只是在探索<a class="ae mu" href="https://arxiv.org/abs/1409.1556" rel="noopener ugc nofollow" target="_blank"> VGG16 </a>。</p></blockquote><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/e7a2fda1f14441b536385824d80eef83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*7asNUelE7oTxdRUuBl5Snw.png"/></div></figure><p id="c7de" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">VGG16是一种卷积神经网络(CNN)架构，尽管它是在2014年开发的，但今天仍被认为是处理图像分类的最佳架构之一。</p><p id="ad8c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">VGG16架构的一个特点是，它们没有大量的超参数，而是专注于一次通过一个3×3滤波器(内核)的卷积层，然后是一个2×2最大池层。在整个架构中，此过程之后是一组一致的卷积层和最大池层。最终，该架构具有2个FC(全连接层)，随后是针对输出的softmax类型激活。</p><p id="72f4" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">VGG16中的16是指架构有16层，权重为(w)。这个网络是广泛的，在使用所有原始的16层的情况下，具有几乎1 . 4亿个训练参数。在我们的例子中，最后两层(FC1和2)是本地训练的，参数总数刚好超过1500万，其中大约590，000个参数是本地训练的(而其余的是“冻结的”)。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/10b27a73dd644fea92b14c308a63405d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gyu5ULp9HJQNyD3C5y1NTg.png"/></div></div></figure><p id="6126" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">要注意的第一点是，VNN16架构的第一层处理224x224x3像素的图像，因此我们必须确保要训练的X射线图像也具有这些维度，因为它们是卷积网络“第一层”的一部分。因此，当使用原始权重加载模型时(weights = "imagenet ")，我们还应该忽略模型的顶层(include_top = False)，它由我们的层(headModel)替换。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="30dd" class="kb kc it ns b gy nw nx l ny nz">baseModel = VGG16(weights="imagenet", include_top=False, input_tensor=Input(shape=(224, 224, 3)))</span></pre><p id="ca6c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">接下来，我们必须定义用于训练的超参数(在下面的评论中，将测试一些可能的值以提高模型的“准确性”):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="c5c8" class="kb kc it ns b gy nw nx l ny nz">INIT_LR = 1e-3         # [0.0001]<br/>EPOCHS = 10            # [20]<br/>BS = 8                 # [16, 32]<br/>NODES_DENSE0 = 64      # [128]<br/>DROPOUT = 0.5          # [0.0, 0.1, 0.2, 0.3, 0.4, 0.5]<br/>MAXPOOL_SIZE = (4, 4)  # [(2,2) , (3,3)]<br/>ROTATION_DEG = 15      # [10]<br/>SPLIT = 0.2            # [0.1]</span></pre><p id="248e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">然后构建我们的模型，它被添加到基本模型中:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6d34" class="kb kc it ns b gy nw nx l ny nz">headModel = baseModel.output<br/>headModel = AveragePooling2D(pool_size=MAXPOOL_SIZE)(headModel)<br/>headModel = Flatten(name="flatten")(headModel)<br/>headModel = Dense(NODES_DENSE0, activation="relu")(headModel)<br/>headModel = Dropout(DROPOUT)(headModel)<br/>headModel = Dense(2, activation="softmax")(headModel)</span></pre><p id="a379" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">头模型模型放置在基础模型之上，成为实际训练的模型的一部分(确定最佳权重)。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="8383" class="kb kc it ns b gy nw nx l ny nz">model = Model(inputs=baseModel.input, outputs=headModel)</span></pre><p id="e5fa" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">重要的是要记住，预先训练的CNN模型，如VGG16，是用成千上万的图像训练的，以对普通图像进行分类(如狗、猫、汽车和人)。我们现在要做的是根据我们的需求对其进行定制(对x光图像进行分类)。理论上，模型的第一层简化了图像的部分，识别出其中的形状。这些初始标签非常通用(比如直线、圆、正方形)，所以我们不想再训练它们了。我们只想训练网络的最后几层，以及新加入的几层。</p><p id="a078" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对基础模型中的所有层执行的以下循环“冻结”它们，使得它们在第一次训练过程中不被更新。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="3c82" class="kb kc it ns b gy nw nx l ny nz">for layer in baseModel.layers:<br/>    layer.trainable = False</span></pre><p id="78e4" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">而此时，模型已经可以接受训练了，但首先，我们必须为模型的训练准备好数据(图像)。</p><h2 id="04a8" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据预处理</h2><p id="a2d7" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">让我们首先创建一个包含存储图像的名称(和路径)的列表:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="32d3" class="kb kc it ns b gy nw nx l ny nz">imagePaths = list(paths.list_images(dataset_path))</span></pre><p id="1f5b" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">然后，对于列表中的每个图像，我们必须:</p><ol class=""><li id="2a91" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">提取图像标签(在本例中，是covid或normal)</li><li id="430e" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">将图像通道从BGR (CV2默认)设置为RGB</li><li id="e50b" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">将图像大小调整为224 x 224(默认为VGG16)</li></ol><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="4cab" class="kb kc it ns b gy nw nx l ny nz">data = []<br/>labels = []</span><span id="afe2" class="kb kc it ns b gy ol nx l ny nz">for imagePath in imagePaths:<br/>    label = imagePath.split(os.path.sep)[-2]<br/>    image = cv2.imread(imagePath)<br/>    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)<br/>    image = cv2.resize(image, (224, 224))</span><span id="1860" class="kb kc it ns b gy ol nx l ny nz">    data.append(image)<br/>    labels.append(label)</span></pre><p id="bacd" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">数据和标签被转换为数组，即每个像素的强度值，范围从0到255，从0到1缩放，便于训练。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="be2e" class="kb kc it ns b gy nw nx l ny nz">data = np.array(data) / 255.0<br/>labels = np.array(labels)</span></pre><p id="4725" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">标签将使用一键编码技术进行数字编码。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="c14c" class="kb kc it ns b gy nw nx l ny nz">lb = LabelBinarizer()<br/>labels = lb.fit_transform(labels)<br/>labels = to_categorical(labels)</span></pre><p id="c37a" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此时，训练数据集分为训练和测试(80%用于训练，20%用于测试):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="0e18" class="kb kc it ns b gy nw nx l ny nz">(trainX, testX, trainY, testY) = train_test_split(data,<br/>                                                  labels,<br/>                                                  test_size=SPLIT,<br/>                                                  stratify=labels,<br/>                                                  random_state=42)</span></pre><p id="4072" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">最后但同样重要的是，我们应该应用“上升”数据或“增强”技术。</p><h2 id="d4cf" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">增大</h2><p id="ae0e" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">正如Chowdhury等人在他们的<a class="ae mu" href="https://arxiv.org/pdf/2003.13145.pdf" rel="noopener ugc nofollow" target="_blank">论文</a>中所建议的，三种增强策略(旋转、调度和平移)可用于为新冠肺炎生成额外的训练图像，有助于防止“过拟合”。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oq"><img src="../Images/0af265e3e9048dda204802105eb64606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qCIaYuz9JGDp8iEyGYE3Bw.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated"><strong class="bd or">原始胸部x光图像(A)，逆时针旋转45度后的图像(B)，顺时针旋转45度后的图像，水平和垂直平移20%后的图像(D)，以及缩放10%后的图像(E)。</strong></p></figure><p id="76c4" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">使用TS/Keras图像预处理库(ImageDataGenerator)，可以更改几个图像参数，例如:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1e84" class="kb kc it ns b gy nw nx l ny nz">trainAug = ImageDataGenerator(<br/>        rotation_range=15,<br/>        width_shift_range=0.2,<br/>        height_shift_range=0.2,<br/>        rescale=1./255,<br/>        shear_range=0.2,<br/>        zoom_range=0.2,<br/>        horizontal_flip=True,<br/>        fill_mode='nearest')</span></pre><p id="d066" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">最初，仅应用15度的图像最大旋转来评估结果。</p><blockquote class="of og oh"><p id="ff06" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">据观察，X射线图像通常在旋转变化很小的情况下对齐。</p></blockquote><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="7a02" class="kb kc it ns b gy nw nx l ny nz">trainAug = ImageDataGenerator(rotation_range=ROTATION_DEG, fill_mode="nearest")</span></pre><p id="a5ba" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此时，我们已经定义了模型和数据，并准备好进行编译和训练。</p><h2 id="deea" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">模型构建和培训</h2><p id="8233" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">编译允许实际构建我们之前实现的模型，但是增加了一些额外的特性，比如损失率函数、优化器和指标。</p><p id="4110" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对于网络训练，我们使用损失函数来计算网络预测值和训练数据实际值之间的差异。伴随着优化算法(例如Adam)的损失值促进了对网络内的权重进行的改变的数量。这些超参数有助于网络训练的收敛，获得尽可能接近零的损失值。</p><p id="4086" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我们还指定了优化器的学习率(lr)。在这种情况下，lr被定义为1e-3(大约。0.05).如果在训练期间，注意到“跳动”的增加，这意味着模型不能收敛，我们应该降低学习速率，以便我们可以达到全局最小值。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1396" class="kb kc it ns b gy nw nx l ny nz">opt = Adam(lr=INIT_LR, decay=INIT_LR / EPOCHS)<br/>model.compile(loss="binary_crossentropy", optimizer=opt, metrics=["accuracy"])</span></pre><p id="005c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">让我们训练模型:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="0e3e" class="kb kc it ns b gy nw nx l ny nz">H = model.fit(<br/>    trainAug.flow(trainX, trainY, batch_size=BS),<br/>    steps_per_epoch=len(trainX) // BS,<br/>    validation_data=(testX, testY),<br/>    validation_steps=len(testX) // BS,<br/>    epochs=EPOCHS)</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi os"><img src="../Images/f19952554ed11d87611ad5712735ba97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HWvZa_tCERcGCmqbYUff0A.png"/></div></div></figure><p id="da62" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果看起来已经很有趣了，在验证数据中达到了92%的精确度！让我们绘制精确图表:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/11394cd4e7a658d76eb23598937feae7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*E033nonrNReLpUDv-eEIlw.png"/></div></figure><p id="7418" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">评估已训练的模型:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/298e3fde0704c9761492b0b9ddad3ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/format:webp/1*5a97YN8JDYEPPNZrkzwl0g.png"/></div></figure><p id="d7f8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">看看混淆矩阵:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="169f" class="kb kc it ns b gy nw nx l ny nz">[[27  0]<br/> [ 4 23]]<br/>acc: 0.9259<br/>sensitivity: 1.0000<br/>specificity: 0.8519</span></pre><p id="3d09" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">根据用最初选择的超参数训练的模型，我们获得:</p><ol class=""><li id="fcff" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">100%的灵敏度，这意味着对于患有新冠肺炎(即真阳性)的患者，我们可以在100%的时间内准确地将他们识别为“新冠肺炎阳性”。</li><li id="3991" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">85%的特异性意味着，对于没有新冠肺炎(即真正阴性)的患者，我们只能在85%的时间内准确地将他们识别为“新冠肺炎阴性”。</li></ol><p id="96f2" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果并不令人满意，因为15%没有Covid的患者会被误诊。让我们首先尝试微调模型，更改一些超参数:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="cf24" class="kb kc it ns b gy nw nx l ny nz">INIT_LR = 0.0001       # was 1e-3  <br/>EPOCHS = 20            # was 10       <br/>BS = 16                # was 8 <br/>NODES_DENSE0 = 128     # was 64<br/>DROPOUT = 0.5          <br/>MAXPOOL_SIZE = (2, 2)  # was (4, 4)<br/>ROTATION_DEG = 15     <br/>SPLIT = 0.2</span></pre><p id="f359" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">因此，我们有:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/7388ff751ce7899642f5e390ff16c1b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*Hd-bHwGYmpM6G3lx0KpEvw.png"/></div></figure><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="94f2" class="kb kc it ns b gy nw nx l ny nz">precision    recall  f1-score   support</span><span id="306d" class="kb kc it ns b gy ol nx l ny nz">       covid       0.93      1.00      0.96        27<br/>      normal       1.00      0.93      0.96        27</span><span id="79fb" class="kb kc it ns b gy ol nx l ny nz">    accuracy                           0.96        54<br/>   macro avg       0.97      0.96      0.96        54<br/>weighted avg       0.97      0.96      0.96        54</span></pre><p id="c470" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">和混淆矩阵:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="4df1" class="kb kc it ns b gy nw nx l ny nz">[[27  0]<br/> [ 2 25]]</span><span id="f2da" class="kb kc it ns b gy ol nx l ny nz">acc: 0.9630<br/>sensitivity: 1.0000<br/>specificity: 0.9259</span></pre><p id="90d6" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">好得多的结果！现在有了93%的特异性，这意味着在没有新冠肺炎(即真阴性)的患者中，我们可以在93%的时间内准确地将他们识别为“新冠肺炎阴性”,而在识别真阳性时为100%。</p><p id="1a81" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">目前，结果看起来很有希望。让我们保存该模式，对那些在验证训练中遗漏的图像进行测试(2020年3月新冠肺炎的8幅图像和从输入数据集中随机选择的20幅图像)。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6433" class="kb kc it ns b gy nw nx l ny nz">model.save("../model/covid_normal_model.h5")</span></pre><h2 id="c670" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">在真实图像中测试模型(验证)</h2><p id="925e" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">首先，让我们检索模型并展示最终的架构，以检查一切是否正常:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="d855" class="kb kc it ns b gy nw nx l ny nz">new_model = load_model('../model/covid_normal_model.h5')</span><span id="61fa" class="kb kc it ns b gy ol nx l ny nz"># Show the model architecture<br/>new_model.summary()</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/e68ee0a82276b21cfb9bf9baeea9eaa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*_q51pvSQ3E3mFBk4xqnsPQ.png"/></div></figure><p id="221e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">模型看起来不错，是VGG16的16层结构。注意可训练参数为590，210，是最后两层(dense_2和dense_3)的和，加入到预训练模型中，参数为14.7M。</p><p id="c5b7" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">让我们验证测试数据集中加载的模型:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6da8" class="kb kc it ns b gy nw nx l ny nz">[INFO] evaluating network...<br/>              precision    recall  f1-score   support</span><span id="1b59" class="kb kc it ns b gy ol nx l ny nz">       covid       0.93      1.00      0.96        27<br/>      normal       1.00      0.93      0.96        27</span><span id="cd81" class="kb kc it ns b gy ol nx l ny nz">    accuracy                           0.96        54<br/>   macro avg       0.97      0.96      0.96        54<br/>weighted avg       0.97      0.96      0.96        54</span></pre><p id="80d4" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">完美，我们得到了和以前一样的结果，这意味着训练好的模型被正确地保存和加载。现在让我们用之前保存的8幅Covid图像来验证模型。为此，我们使用另一个为单独图像测试开发的支持函数test_rx_image_for_Covid19():</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="01c5" class="kb kc it ns b gy nw nx l ny nz">def test_rx_image_for_Covid19(imagePath):<br/>    img = cv2.imread(imagePath)<br/>    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<br/>    img = cv2.resize(img, (224, 224))<br/>    img = np.expand_dims(img, axis=0)</span><span id="b711" class="kb kc it ns b gy ol nx l ny nz">    img = np.array(img) / 255.0</span><span id="c021" class="kb kc it ns b gy ol nx l ny nz">    pred = new_model.predict(img)<br/>    pred_neg = round(pred[0][1]*100)<br/>    pred_pos = round(pred[0][0]*100)</span><span id="37b2" class="kb kc it ns b gy ol nx l ny nz">    print('\n X-Ray Covid-19 Detection using AI - MJRovai')<br/>    print('    [WARNING] - Only for didactic purposes')<br/>    if np.argmax(pred, axis=1)[0] == 1:<br/>        plt.title('\nPrediction: [NEGATIVE] with prob: {}% \nNo Covid-19\n'.format(<br/>            pred_neg), fontsize=12)<br/>    else:<br/>        plt.title('\nPrediction: [POSITIVE] with prob: {}% \nPneumonia by Covid-19 Detected\n'.format(<br/>            pred_pos), fontsize=12)</span><span id="6cd6" class="kb kc it ns b gy ol nx l ny nz">    img_out = plt.imread(imagePath)<br/>    plt.imshow(img_out)<br/>    plt.savefig('../Image_Prediction/Image_Prediction.png')<br/>    return pred_pos</span></pre><p id="e0bb" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">在笔记本电脑上，该功能将显示以下结果:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ox"><img src="../Images/84497ba060e0100e795e79c97c6cd984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MJt3QuA5BcI_WTTHnvW-sg.png"/></div></div></figure><p id="9c36" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">通过更改剩余7个图像的imagePath值，我们获得了以下结果:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oy"><img src="../Images/396e36ea4d59f2689c87fb9ee96b2797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMBZ4t6f6OqTuqeXGvF62g.png"/></div></div></figure><p id="8526" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">所有图像都呈阳性，证实了100%的灵敏度。</p><p id="2f91" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">现在让我们测试标记为正常的20个单独的验证图像。笔记本上的第一个应该是这样的:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/235b15db1362f950e101a7b68625dbba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*yjkwnCeYqyYj_ZcwjjaYAw.png"/></div></figure><p id="e46f" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">逐个测试，有可能证实预测，但由于我们有更多的图像，让我们使用另一个函数来测试一组图像，一次完成:test _ rx _ image _ for _ covid 19 _ batch(img _ lst)。</p><h2 id="f414" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">批量测试图像</h2><p id="85c6" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">让我们创建包含在验证文件夹中的图像列表:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="611d" class="kb kc it ns b gy nw nx l ny nz">validation_path = '../dataset_validation'</span><span id="c236" class="kb kc it ns b gy ol nx l ny nz">normal_val_images = list(paths.list_images(<br/>    f"{validation_path}/normal_validation"))<br/>non_covid_pneumonia_validation_images = list(paths.list_images(<br/>    f"{validation_path}/non_covid_pneumonia_validation"))<br/>covid_val_images = list(paths.list_images(<br/>    f"{validation_path}/covid_validation"))</span></pre><p id="0eac" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">test _ rx _ image _ for _ covid 19 _ batch(img _ lst)函数如下所示:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="2b38" class="kb kc it ns b gy nw nx l ny nz">def test_rx_image_for_Covid19_batch(img_lst):<br/>    neg_cnt = 0<br/>    pos_cnt = 0<br/>    predictions_score = []<br/>    for img in img_lst:<br/>        pred, neg_cnt, pos_cnt = test_rx_image_for_Covid19_2(img, neg_cnt, pos_cnt)<br/>        predictions_score.append(pred)<br/>    print ('{} positive detected in a total of {} images'.format(pos_cnt, (pos_cnt+neg_cnt)))<br/>    return  predictions_score, neg_cnt, pos_cnt</span></pre><p id="0d1e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">将该函数应用于我们之前分离的20幅图像:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="f14c" class="kb kc it ns b gy nw nx l ny nz">img_lst = normal_val_images<br/>normal_predictions_score, normal_neg_cnt, normal_pos_cnt = test_rx_image_for_Covid19_batch(img_lst)<br/>normal_predictions_score</span></pre><p id="4a2b" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我们观察到，所有20人都被诊断为阴性，得分如下(记住，模型将返回接近“1”的“阳性”):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="249d" class="kb kc it ns b gy nw nx l ny nz">0.25851375,<br/> 0.025379542,<br/> 0.005824779,<br/> 0.0047603976,<br/> 0.042225637,<br/> 0.025087152,<br/> 0.035508618,<br/> 0.009078974,<br/> 0.014746706,<br/> 0.06489486,<br/> 0.003134642,<br/> 0.004970203,<br/> 0.15801577,<br/> 0.006775451,<br/> 0.0032735346,<br/> 0.007105667,<br/> 0.001369465,<br/> 0.005155371,<br/> 0.029973848,<br/> 0.014993184</span></pre><p id="e2f6" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">仅在2个案例中，图像的a值(1-精度)低于90% (0.26和0.16)。</p><p id="7f39" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">由于我们有一个函数来批量应用模型，请记住输入数据集/input /20_Chest_Xray/有两个组/train和/test。只有包含在/train中的图像组的一部分用于训练，并且所有/test图像从未被模型看到:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="5b91" class="kb kc it ns b gy nw nx l ny nz">input - <br/>      |_ 10_Covid_Imagens _ <br/>      |                   |_ <em class="mv">metadata.csv</em><br/>      |                   |_ images [used train model 1]<br/>      |_ 20_Chest_Xray -<br/>                       |_ test _<br/>                               |_ NORMAL<br/>                               |_ PNEUMONIA <br/>                       |_ train _<br/>                                |_ NORMAL   [used train model 1]<br/>                                |_ PNEUMONIA</span></pre><p id="6e8d" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">然后，我们可以利用并测试该文件夹中的所有新图像。首先，我们创建了图像列表:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="7b11" class="kb kc it ns b gy nw nx l ny nz">validation_path = '../input/20_Chest_Xray/test'</span><span id="afb5" class="kb kc it ns b gy ol nx l ny nz">normal_test_val_images = list(paths.list_images(f"{validation_path}/NORMAL"))<br/>print("Normal Xray Images: ", len(normal_test_val_images))</span><span id="183b" class="kb kc it ns b gy ol nx l ny nz">pneumo_test_val_images = list(paths.list_images(f"{validation_path}/PNEUMONIA"))<br/>print("Pneumo Xray Images: ", len(pneumo_test_val_images))</span></pre><p id="8b98" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我们观察了234张被诊断为正常的“未发表的”图像(还有390多张被诊断为非新冠肺炎引起的肺炎)。应用批量测试的功能，我们观察到在总共234个图像中有24个图像呈现假阳性(大约10%)。让我们看看模型输出值是如何分布的，记住函数返回的值是这样计算的:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="fdc9" class="kb kc it ns b gy nw nx l ny nz">pred = new_model.predict(image)<br/>pred_pos = round(pred[0][0] * 100)</span></pre><p id="7c37" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我们观察到预测的精确谷值的平均值为0.15，并且非常集中在接近于零的值中(中值仅为0.043)。有趣的是，大多数假阳性接近0.5，少数异常值在0.6以上。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pa"><img src="../Images/5f4a4c784b4b672b1a01fa9e35fdc04e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oa0UAuQ0QKaXiaYdeTcBjw.png"/></div></div></figure><p id="66da" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">除了改进模型之外，研究产生假阳性的图像也是值得的，因为这可能是获取数据的方式的技术特征。</p><h2 id="d2b0" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">肺炎的图像检测</h2><p id="2a59" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">因为输入数据集也有肺炎患者的X射线图像，但不是由Covid引起的，所以让我们应用模型1 (Covid / Normal)来看看结果是什么:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pb"><img src="../Images/d3f5c58c76ea4bea6ebb6bde7041526c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aK8c2bW9DJJwLrAmPYY8AQ.png"/></div></div></figure><p id="4bb3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果非常糟糕，因为在390张图像中，有185张是假阳性。而观察结果的分布，观察到有一个接近80%的峰值，就是错得很离谱！</p><blockquote class="of og oh"><p id="ca64" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">回想一下，这个结果在技术上并不令人惊讶，因为该模型没有用肺炎患者的图像进行训练。</p></blockquote><p id="634e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">无论如何，这是一个大问题，因为我想象一个专家可以用肉眼区分一个病人是否患有肺炎。尽管如此，要区分这场肺炎是由新冠肺炎病毒(新型冠状病毒)、任何其他病毒，甚至是细菌引起的，可能会更加困难。</p><p id="f289" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">该模型应该更有用，能够区分由新冠肺炎病毒引起的肺炎患者和其他类型的病毒或细菌。为此，训练了另一个模型，现在有了感染新冠肺炎病毒的病人和感染肺炎但不是由新冠肺炎病毒引起的病人的图像。</p><h1 id="5c1b" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">第3部分—模型2 — Covid/Pneumo</h1><h2 id="e8b0" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据准备</h2><ul class=""><li id="4d81" class="mg mh it kz b la lb le lf kk oa ko ob ks oc lr od mm mn mo bi translated">从我的GitHub下载笔记本:<a class="ae mu" href="https://github.com/Mjrovai/covid19Xray/blob/master/10_X-Ray_Covid_development/notebooks/20_Xray_Pneumo_Covid19_Model_2_Training_Tests.ipynb" rel="noopener ugc nofollow" target="_blank"><em class="mv">20 _ Xray _ pno _ covid 19 _ Model _ 2 _ Training _ tests . ipynb</em></a>保存在子目录/notebooks中。</li><li id="5f64" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr od mm mn mo bi translated">导入使用的库并运行支持函数。</li></ul><p id="040b" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">模型2中使用的Covid图像数据集与模型1中使用的相同，只是现在它存储在不同的文件夹中。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="3cc9" class="kb kc it ns b gy nw nx l ny nz">dataset_path = '../20_dataset'</span></pre><p id="80e9" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">肺炎图像将从文件夹/input/20 _ Chest _ x ray/train/Pneumonia/下载，并存储在/20 _ dataset/pneumono/中。要使用的功能与之前相同:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="09a0" class="kb kc it ns b gy nw nx l ny nz">input_dataset_path = '../input/20_Chest_Xray/train/PNEUMONIA'<br/>output_dataset_path = '../20_dataset/pneumo'</span><span id="223c" class="kb kc it ns b gy ol nx l ny nz">img_num_select = len(xray_cv_train) # Same number of samples as Covid data</span></pre><p id="531b" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">这样，我们调用可视化的支持函数，检查获得的结果:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="adb7" class="kb kc it ns b gy nw nx l ny nz">pneumo_images = list(paths.list_images(f"{dataset_path}/pneumo"))<br/>covid_images = list(paths.list_images(f"{dataset_path}/covid"))</span><span id="97a7" class="kb kc it ns b gy ol nx l ny nz">plots_from_files(covid_images, rows=10, maintitle="Covid-19 X-ray images")</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/190890d56ba8c8ef206aa3895825ea82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*O79DezraF-MAN5feqJrT_Q.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">Covid图像可视化</p></figure><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="870a" class="kb kc it ns b gy nw nx l ny nz">plots_from_files(pneumo_images, rows=10, maintitle="Pneumony X-ray images"</span></pre><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/bf10868f48699db6c0adcef9cb9848b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*szt14r6F3vxaM65IaLd5Aw.png"/></div></figure><p id="63e2" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">总的来说，图像看起来不错。</p><h2 id="3fc9" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">预训练CNN模型及其超参数的选择</h2><p id="abfb" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">要使用的预训练模型是VGG16，与用于模型1训练的模型相同</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="6907" class="kb kc it ns b gy nw nx l ny nz">baseModel = VGG16(weights="imagenet", include_top=False, input_tensor=Input(shape=(224, 224, 3)))</span></pre><p id="76bf" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">接下来，我们必须定义用于训练的超参数。我们从模型1的最终训练调整后使用的相同参数开始:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="85e6" class="kb kc it ns b gy nw nx l ny nz">INIT_LR = 0.0001         <br/>EPOCHS = 20            <br/>BS = 16                 <br/>NODES_DENSE0 = 128      <br/>DROPOUT = 0.5          <br/>MAXPOOL_SIZE = (2, 2)  <br/>ROTATION_DEG = 15      <br/>SPLIT = 0.2</span></pre><p id="ec17" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">然后，构建我们的模型，该模型将被添加到基本模型中:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1b9c" class="kb kc it ns b gy nw nx l ny nz">headModel = baseModel.output<br/>headModel = AveragePooling2D(pool_size=MAXPOOL_SIZE)(headModel)<br/>headModel = Flatten(name="flatten")(headModel)<br/>headModel = Dense(NODES_DENSE0, activation="relu")(headModel)<br/>headModel = Dropout(DROPOUT)(headModel)<br/>headModel = Dense(2, activation="softmax")(headModel)</span></pre><p id="12d0" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">headModel模型被放置在基本模型之上，成为用于训练的真实模型。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="7934" class="kb kc it ns b gy nw nx l ny nz">model = Model(inputs=baseModel.input, outputs=headModel)</span></pre><p id="4fb0" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对基础模型中的所有层执行的以下循环将“冻结”它们，使得它们在第一次训练过程中不被更新。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="faa8" class="kb kc it ns b gy nw nx l ny nz">for layer in baseModel.layers:<br/>    layer.trainable = False</span></pre><p id="aa11" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此时，模型已经可以进行训练了，但是我们首先要准备好模型的数据(图像)。</p><h2 id="3f97" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">数据预处理</h2><p id="23d4" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">让我们首先创建一个包含存储图像的名称(和路径)的列表，并执行与模型1相同的预处理:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="c26f" class="kb kc it ns b gy nw nx l ny nz">imagePaths = list(paths.list_images(dataset_path))</span><span id="d70c" class="kb kc it ns b gy ol nx l ny nz">data = []<br/>labels = []</span><span id="dd33" class="kb kc it ns b gy ol nx l ny nz">for imagePath in imagePaths:<br/>    label = imagePath.split(os.path.sep)[-2]<br/>    image = cv2.imread(imagePath)<br/>    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)<br/>    image = cv2.resize(image, (224, 224))</span><span id="4d10" class="kb kc it ns b gy ol nx l ny nz">    data.append(image)<br/>    labels.append(label)</span><span id="c5db" class="kb kc it ns b gy ol nx l ny nz">data = np.array(data) / 255.0<br/>labels = np.array(labels)</span></pre><p id="ea04" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">标签使用一键编码技术进行数字编码。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="3604" class="kb kc it ns b gy nw nx l ny nz">lb = LabelBinarizer()<br/>labels = lb.fit_transform(labels)<br/>labels = to_categorical(labels)</span></pre><p id="dc51" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此时，我们将把训练数据集分为训练数据集和测试数据集(80%用于训练，20%用于测试):</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="77c4" class="kb kc it ns b gy nw nx l ny nz">(trainX, testX, trainY, testY) = train_test_split(data,<br/>                                                  labels,<br/>                                                  test_size=SPLIT,<br/>                                                  stratify=labels,<br/>                                                  random_state=42)</span></pre><p id="3f8e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">最后但同样重要的是，我们将应用数据扩充技术。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="5f65" class="kb kc it ns b gy nw nx l ny nz">trainAug = ImageDataGenerator(rotation_range=ROTATION_DEG, fill_mode="nearest")</span></pre><p id="5154" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此时，我们已经定义了模型和数据，并准备好进行编译和训练。</p><h2 id="4504" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">模型2的编译和训练</h2><p id="fd5c" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">编译:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="a3d7" class="kb kc it ns b gy nw nx l ny nz">opt = Adam(lr=INIT_LR, decay=INIT_LR / EPOCHS)<br/>model.compile(loss="binary_crossentropy", optimizer=opt, metrics=["accuracy"])</span></pre><p id="d1a2" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">培训:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="4370" class="kb kc it ns b gy nw nx l ny nz">H = model.fit(<br/>    trainAug.flow(trainX, trainY, batch_size=BS),<br/>    steps_per_epoch=len(trainX) // BS,<br/>    validation_data=(testX, testY),<br/>    validation_steps=len(testX) // BS,<br/>    epochs=EPOCHS)</span></pre><p id="1f00" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">通过20个时期和初始参数，结果看起来非常有趣，在验证数据中达到100%的精度！让我们绘制精度图表，评估训练好的模型，并查看混淆矩阵:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/5bee1d1ff6cea01cc88c0321ff06cb5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*hihTwZhO3_kv9C9jC31Zug.png"/></div></figure><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="46bb" class="kb kc it ns b gy nw nx l ny nz">precision    recall  f1-score   support</span><span id="6dba" class="kb kc it ns b gy ol nx l ny nz">       covid       0.96      1.00      0.98        27<br/>      pneumo       1.00      0.96      0.98        27</span><span id="9bdf" class="kb kc it ns b gy ol nx l ny nz">    accuracy                           0.98        54<br/>   macro avg       0.98      0.98      0.98        54<br/>weighted avg       0.98      0.98      0.98        54</span></pre><p id="f6f6" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">混淆矩阵:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="813b" class="kb kc it ns b gy nw nx l ny nz">[[27  0]<br/> [ 1 26]]<br/>acc: 0.9815<br/>sensitivity: 1.0000<br/>specificity: 0.9630</span></pre><p id="9cde" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">利用训练的模型(利用最初选择的超参数)，我们获得:</p><ul class=""><li id="88d2" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr od mm mn mo bi translated">100%的灵敏度，这意味着对于患有新冠肺炎(即，真阳性)的患者，我们可以在100%的时间内准确地将他们识别为“新冠肺炎阳性”。</li><li id="74e7" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr od mm mn mo bi translated">96%的特异性，这意味着对于没有新冠肺炎(即，真阴性)的患者，我们可以在96%的时间内准确地将他们识别为“新冠肺炎阴性”。</li></ul><p id="86ed" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果完全令人满意，因为只有4%没有Covid的患者会被误诊。但在这种情况下，肺炎患者和新冠肺炎患者之间的正确分类是最有益的；我们至少应该对超参数进行一些调整，重新进行训练。</p><blockquote class="of og oh"><p id="bf58" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">首先，我试图降低初始lr一点，这是一场灾难。我回到了原来的值。</p></blockquote><p id="a3d1" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我还减少了数据的分割，增加了一点Covid图像，并将最大旋转角度更改为10度，这是与原始数据集相关的论文中建议的:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="66a8" class="kb kc it ns b gy nw nx l ny nz">INIT_LR = 0.0001         <br/>EPOCHS = 20            <br/>BS = 16                 <br/>NODES_DENSE0 = 128      <br/>DROPOUT = 0.5          <br/>MAXPOOL_SIZE = (2, 2)  <br/>ROTATION_DEG = 10      <br/>SPLIT = 0.1</span></pre><p id="614c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">因此，我们有:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/c457c0442cabd31bc1df6d6ee053ff15.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*iI_pMeqqksL_lKDVbbnxRg.png"/></div></figure><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="cc6a" class="kb kc it ns b gy nw nx l ny nz">precision    recall  f1-score   support</span><span id="2022" class="kb kc it ns b gy ol nx l ny nz">       covid       1.00      1.00      1.00        13<br/>      pneumo       1.00      1.00      1.00        14</span><span id="739e" class="kb kc it ns b gy ol nx l ny nz">    accuracy                           1.00        27<br/>   macro avg       1.00      1.00      1.00        27<br/>weighted avg       1.00      1.00      1.00        27</span></pre><p id="17a3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">和混淆矩阵:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="d5e0" class="kb kc it ns b gy nw nx l ny nz">[[13  0]<br/> [ 0 14]]</span><span id="23e0" class="kb kc it ns b gy ol nx l ny nz">acc: 1.0000<br/>sensitivity: 1.0000<br/>specificity: 1.0000</span></pre><p id="8483" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果看起来比他们以前更好，但我们使用的测试数据很少！让我们保存这个模型，像以前一样用大量的图片进行测试。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="5cf2" class="kb kc it ns b gy nw nx l ny nz">model.save("../model/covid_pneumo_model.h5")</span></pre><p id="4255" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我们观察到有390张图片被标记为非新冠肺炎病毒引起的肺炎。应用批量测试功能，我们观察到在总共390个图像中只有3个图像呈现假阳性(大约0.8%)。此外，预测精度值的平均值为0.04，并且非常集中在接近于零的值中(中值仅为0.02)。</p><p id="d749" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">总体结果甚至比以前的模型观察到的更好。有趣的是，几乎所有结果都在前3个四分位数内，只有极少数异常值的误差超过20%。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pb"><img src="../Images/4282389ce3b8c6c639d9bb0c761aea2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Cac6W6RMI2OOnunIfv6MQ.png"/></div></div></figure><blockquote class="of og oh"><p id="a5c4" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">在这种情况下，也值得研究产生假阳性(只有3个)的图像，因为它们也可能是捕获数据的方式的技术特征。</p></blockquote><h2 id="8e24" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">使用被认为正常(健康)的患者图像进行测试</h2><p id="c4da" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">由于输入数据集也有正常患者(未训练)的X射线图像，让我们应用模型2 (Covid/Pneumo)来看看结果是什么</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pb"><img src="../Images/e7684cbfa11700ef250459f80b3db783.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_44-xnxBhDOvxa3RGnlGg.png"/></div></div></figure><p id="bc41" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">在这种情况下，结果并不像在模型1测试中看到的那样糟糕，因为在234幅图像中，有45幅呈现假阳性(19%)。</p><p id="de3e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">理想的情况是对每种情况使用正确的模型，但是如果只使用一种，模型2是正确的选择。</p><blockquote class="of og oh"><p id="2f05" class="kx ky mv kz b la ls lc ld le lt lg lh oi lu lj lk oj lv lm ln ok lw lp lq lr im bi translated">注意:在最后一次测试备选方案的尝试中，做了一次基准测试，我试图改变增强参数，正如Chowdhury等人所建议的那样，但令我惊讶的是，结果并没有更好(结果在笔记本的末尾)。</p></blockquote><h1 id="32ce" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">第4部分—用于X射线图像中新冠肺炎检测的Web应用程序</h1><h2 id="8915" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">测试Python独立脚本</h2><p id="5f88" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">对于web-app的开发，我们使用Flask，这是一个用Python编写的web微框架。它被归类为微结构，因为它不需要特定的工具或库来运行。</p><p id="b674" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">此外，我们只需要几个库和与单独测试图像相关的函数。因此，让我们首先在一个“干净”的笔记本上工作，在那里使用已经训练和保存的模型2进行测试。</p><ul class=""><li id="9bd8" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr od mm mn mo bi translated">从我的GitHub加载，笔记本:<a class="ae mu" href="https://github.com/Mjrovai/covid19Xray/blob/master/10_X-Ray_Covid_development/notebooks/30_AI_Xray_Covid19_Pneumo_Detection_Application.ipynb" rel="noopener ugc nofollow" target="_blank"><em class="mv">30 _ AI _ Xray _ covid 19 _ pno _ Detection _ application . ipynb</em></a></li><li id="8928" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr od mm mn mo bi translated">现在只导入测试在前一个笔记本中创建的模型所需的库。</li></ul><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="ad62" class="kb kc it ns b gy nw nx l ny nz">import numpy as np<br/>import cv2<br/>from tensorflow.keras.models import load_model</span></pre><ul class=""><li id="7f4b" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr od mm mn mo bi translated">然后执行加载和测试映像的支持功能:</li></ul><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="bd9a" class="kb kc it ns b gy nw nx l ny nz">def test_rx_image_for_Covid19_2(model, imagePath):<br/>    img = cv2.imread(imagePath)<br/>    img_out = img<br/>    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<br/>    img = cv2.resize(img, (224, 224))<br/>    img = np.expand_dims(img, axis=0)</span><span id="197f" class="kb kc it ns b gy ol nx l ny nz">    img = np.array(img) / 255.0</span><span id="e909" class="kb kc it ns b gy ol nx l ny nz">    pred = model.predict(img)<br/>    pred_neg = round(pred[0][1]*100)<br/>    pred_pos = round(pred[0][0]*100)<br/>    <br/>    if np.argmax(pred, axis=1)[0] == 1:<br/>        prediction = 'NEGATIVE'<br/>        prob = pred_neg<br/>    else:<br/>        prediction = 'POSITIVE'<br/>        prob = pred_pos</span><span id="89a8" class="kb kc it ns b gy ol nx l ny nz">    cv2.imwrite('../Image_Prediction/Image_Prediction.png', img_out)<br/>    return prediction, prob</span></pre><ul class=""><li id="901e" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr od mm mn mo bi translated">下载训练好的模型</li></ul><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="b0b8" class="kb kc it ns b gy nw nx l ny nz">covid_pneumo_model = load_model('../model/covid_pneumo_model.h5')</span></pre><ul class=""><li id="753b" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr od mm mn mo bi translated">然后，从验证子目录上传一些图像，并确认一切正常:</li></ul><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="7602" class="kb kc it ns b gy nw nx l ny nz">imagePath = '../dataset_validation/covid_validation/6C94A287-C059-46A0-8600-AFB95F4727B7.jpeg'<br/>test_rx_image_for_Covid19_2(covid_pneumo_model, imagePath)</span></pre><p id="4f86" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果应该是:('阳性'，96.0)</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="c53a" class="kb kc it ns b gy nw nx l ny nz">imagePath = ‘../dataset_validation/normal_validation/IM-0177–0001.jpeg’<br/>test_rx_image_for_Covid19_2(covid_pneumo_model, imagePath)</span></pre><p id="2125" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果应该是:('负'，99.0)</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="1e90" class="kb kc it ns b gy nw nx l ny nz">imagePath = '../dataset_validation/non_covid_pneumonia_validation/person63_bacteria_306.jpeg'<br/>test_rx_image_for_Covid19_2(covid_pneumo_model, imagePath)</span></pre><p id="b737" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">结果应该是:('负'，98.0)</p><p id="76c7" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">到目前为止，所有的开发都是在Jupyter笔记本上完成的，我们应该做一个最终测试，让代码作为python脚本运行在最初创建的开发目录中，例如，使用名称:covidXrayApp_test.py。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="2049" class="kb kc it ns b gy nw nx l ny nz"># Import Libraries and Setup</span><span id="0640" class="kb kc it ns b gy ol nx l ny nz">import numpy as np<br/>import cv2<br/>from tensorflow.keras.models import load_model</span><span id="415d" class="kb kc it ns b gy ol nx l ny nz"># Turn-off Info and warnings<br/>import os<br/>os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'</span><span id="1315" class="kb kc it ns b gy ol nx l ny nz"># Support Functions</span><span id="67b5" class="kb kc it ns b gy ol nx l ny nz">def test_rx_image_for_Covid19_2(model, imagePath):<br/>    img = cv2.imread(imagePath)<br/>    img_out = img<br/>    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<br/>    img = cv2.resize(img, (224, 224))<br/>    img = np.expand_dims(img, axis=0)</span><span id="2e34" class="kb kc it ns b gy ol nx l ny nz">    img = np.array(img) / 255.0</span><span id="39c6" class="kb kc it ns b gy ol nx l ny nz">    pred = model.predict(img)<br/>    pred_neg = round(pred[0][1]*100)<br/>    pred_pos = round(pred[0][0]*100)<br/>    <br/>    if np.argmax(pred, axis=1)[0] == 1:<br/>        prediction = 'NEGATIVE'<br/>        prob = pred_neg<br/>    else:<br/>        prediction = 'POSITIVE'<br/>        prob = pred_pos</span><span id="7946" class="kb kc it ns b gy ol nx l ny nz">    cv2.imwrite('./Image_Prediction/Image_Prediction.png', img_out)<br/>    return prediction, prob</span><span id="abf5" class="kb kc it ns b gy ol nx l ny nz"># load model<br/>covid_pneumo_model = load_model('./model/covid_pneumo_model.h5')</span><span id="7600" class="kb kc it ns b gy ol nx l ny nz"># ---------------------------------------------------------------<br/># Execute test</span><span id="1bb7" class="kb kc it ns b gy ol nx l ny nz">imagePath = './dataset_validation/covid_validation/6C94A287-C059-46A0-8600-AFB95F4727B7.jpeg'</span><span id="38ca" class="kb kc it ns b gy ol nx l ny nz">prediction, prob = test_rx_image_for_Covid19_2(covid_pneumo_model, imagePath)</span><span id="379a" class="kb kc it ns b gy ol nx l ny nz">print (prediction, prob)</span></pre><p id="1bd3" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">让我们直接在终端上测试这个脚本:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/7942883f191496284c2d43df769c4e70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*y8sfHHMG2wrPAmRZ-cj1sQ.png"/></div></figure><p id="af23" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">完美一切工作完美和“独立”，在笔记本之外。</p><h2 id="f5b6" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">在Flask中创建运行应用程序的环境</h2><p id="b825" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">第一步是从新的Python环境开始。为此，使用终端定义一个工作目录(例如covid19XrayWebApp ),然后在那里用Python创建一个环境(例如:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="0aa5" class="kb kc it ns b gy nw nx l ny nz">mkdir covid19XrayWebApp<br/>cd covid19XrayWebApp<br/>conda create --name covid19xraywebapp python=3.7.6 -y<br/>conda activate covid19xraywebapp</span></pre><p id="6943" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">进入环境后，安装Flask和运行应用程序所需的所有库:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="2fc8" class="kb kc it ns b gy nw nx l ny nz">conda install -c anaconda flask<br/>conda install -c anaconda requests<br/>conda install -c anaconda numpy<br/>conda install -c conda-forge matplotlib<br/>conda install -c anaconda pillow<br/>conda install -c conda-forge opencv<br/>pip install --upgrade pip<br/>pip install tensorflow<br/>pip install gunicorn</span></pre><p id="6e1e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">创建必要的子目录:</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="ba87" class="kb kc it ns b gy nw nx l ny nz">[here the app.py]<br/>model [here the trained and saved model]<br/>templates [here the .html file]<br/>static _ [here the .css file and static images]<br/>       |_ xray_analysis [here the output image after analysis]<br/>       |_ xray_img [here the input x-ray image]</span></pre><p id="603b" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">从我的<a class="ae mu" href="https://github.com/Mjrovai/covid19Xray/tree/master/20_covid19XrayWebApp" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中复制文件，并存储在新创建的目录中，如下所示:</p><ol class=""><li id="f0ae" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">服务器上负责“后端”执行的python应用程序称为app.py，必须位于主目录的根目录下</li><li id="2fa2" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">在/template中，应该存储index.html文件，它将是应用程序的“面孔”，或者说是“前端”</li><li id="153c" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">在/static中将是style.css文件，负责格式化前端(template.html)以及静态图片如logo，icon等。</li><li id="be85" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">在/static下还有子目录，这些子目录将接收要分析的图像以及分析结果(实际上，相同的图像以新名称保存，其中包含:其原始名称加上诊断和准确率)。</li></ol><p id="fd4d" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">一旦所有文件都安装到了正确的位置，工作目录看起来就像这样:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pe"><img src="../Images/f6851d2dc0dedcdfd542a46de0653bd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FciAw2c-K3tunvTNk-GGDA.png"/></div></div></figure><h2 id="f5ad" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">在本地网络上启动Web应用程序</h2><p id="8530" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">一旦你将文件安装到你的文件夹中，运行app.py，它是我们web应用程序的“引擎”,负责接收存储在用户计算机某处的图像(无论在哪里)。</p><pre class="ly lz ma mb gt nr ns nt nu aw nv bi"><span id="28e9" class="kb kc it ns b gy nw nx l ny nz">python app.py</span></pre><p id="de36" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">在终端，我们可以观察到:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pa"><img src="../Images/f610fb1a93316d867af65cff3624355c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mbhnfsPSsJTev5g3eGN6hQ.png"/></div></div></figure><p id="8f5c" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">在您的浏览器上，输入方向:</p><p id="0018" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated"><a class="ae mu" href="http://127.0.0.1:5000/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:</a></p><p id="b7ee" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">该应用将在您的本地网络中运行:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/29632796ae7faaada7f70766ed3b3fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*XU_MwB_nXdcHKzTyIGDrgQ.png"/></div></figure><h2 id="4af3" class="kb kc it bd kd ke kf dn kg kh ki dp kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">用真实图像测试网络应用</h2><p id="0bca" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">我们可以选择开始显示Covid的X射线图像之一，它已经在开发过程中用于验证。</p><ol class=""><li id="6310" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">按下应用程序中的[浏览]按钮，打开您电脑的文件管理器</li><li id="48cd" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">选择图像，然后选择[打开](在我的Mac的Finder窗口中)</li><li id="a180" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">文件名显示为在应用程序中选择的文件名。</li><li id="42dc" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">在app中按【提交查询】。</li><li id="ccba" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">图像显示在应用程序的底部，同时显示图像诊断及其准确度值。</li><li id="ad4d" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">图像存储在文件夹:/static/Xray _ Analysys中，结构如下:[Result]_ Prob _[XX]_ Name _[FILENAME]。png</li></ol><p id="c72e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">以下是一系列步骤:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pg"><img src="../Images/16b46ab97787570928d0249bed3be494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o9vq25sipYrVYkXUYBBWxg.png"/></div></div></figure><p id="294e" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">对有肺炎但没有新冠肺炎的图像之一重复测试:</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/f60b84d5fa381ec894a196a9aa176d8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*t1ZhbdYhhmbqZZf6pOrGNQ.png"/></div></figure><h1 id="7e7a" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">后续步骤</h1><p id="a8f6" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">正如导言中所讨论的，该项目是一个概念验证，以证明在X射线图像中检测导致新冠肺炎的病毒的可行性。对于要在实际案例中使用的项目，还必须完成几个步骤。以下是一些建议:</p><ol class=""><li id="5d17" class="mg mh it kz b la ls le lt kk mi ko mj ks mk lr ml mm mn mo bi translated">与卫生领域的专业人员一起验证整个项目</li><li id="f208" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">开发一个基准来寻找最佳的预训练模型</li><li id="2ec5" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">使用从患者处获得的图像来训练该模型，最好是来自将使用该应用的相同区域。</li><li id="2b93" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">使用新冠肺炎获得更广泛的患者图像</li><li id="79d9" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">改变模型的模型超参数</li><li id="35a0" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">测试用3个类别(正常、Covid和肺炎)训练模型的可行性</li><li id="2bd0" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">对应用程序要测试的图像应用与训练图像相同的捕获和数字化程序</li><li id="5e8b" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">更改应用程序，允许选择更适合使用的型号(型号1或2)</li><li id="6cb0" class="mg mh it kz b la mp le mq kk mr ko ms ks mt lr ml mm mn mo bi translated">在Heroku.com或pythonanywhere.com等平台上将网络应用投入生产</li></ol><h1 id="a075" class="mz kc it bd kd na nb nc kg nd ne nf kj ng nh ni kn nj nk nl kr nm nn no kv np bi translated">结论</h1><p id="d019" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh kk li lj lk ko ll lm ln ks lo lp lq lr im bi translated">一如既往，我希望这篇文章能够帮助其他人在数据科学的美好世界中找到自己的路！我比以往任何时候都更希望这篇文章能够激励深度学习和健康领域的专业人士共同努力，投入生产模型，帮助抗击疫情。</p><p id="3fe8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">本文使用的所有代码都可以在我的GitHub上下载:<a class="ae mu" href="https://github.com/Mjrovai/covid19Xray" rel="noopener ugc nofollow" target="_blank"> covid19Xray </a>。</p><p id="78bb" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">来自世界南方的问候！</p><p id="48ba" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">我的下一篇文章再见！</p><p id="b5a8" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">谢谢你</p><p id="bbf6" class="pw-post-body-paragraph kx ky it kz b la ls lc ld le lt lg lh kk lu lj lk ko lv lm ln ks lw lp lq lr im bi translated">马塞洛</p></div></div>    
</body>
</html>