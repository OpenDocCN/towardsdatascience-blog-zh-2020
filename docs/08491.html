<html>
<head>
<title>Manipulating Data With MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MongoDB操作数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/manipulating-data-with-mongodb-bd561f09d76a?source=collection_archive---------22-----------------------#2020-06-20">https://towardsdatascience.com/manipulating-data-with-mongodb-bd561f09d76a?source=collection_archive---------22-----------------------#2020-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="db7a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用PyMongo学习CRUD的基础知识</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ca53d1c2ee456e22fe99c3eefd4895e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nJdTxluGiCPjE8o2"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="e0f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">访问第1部分<a class="ae kv" rel="noopener" target="_blank" href="/lets-get-you-started-with-mongodb-part-1-85c64828c815">这里</a>来设置你的MongoDB。</p><h1 id="0843" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍</h1><p id="28e3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在上一篇文章中，我们设法了解了为什么MongoDB如此强大，以及如何设置它和导入我们的数据。</p><p id="88c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">设置好一切之后，我们现在可以用PyMongo学习MongoDB的基础知识了。我将带您了解CRUD操作，它代表:</p><ul class=""><li id="06b6" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">c——创建:创建数据并将其插入到数据库中</li><li id="bc03" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">r-Read:从数据库中读取数据</li><li id="2c02" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">U —更新:选择并更新数据库中的数据</li><li id="8e1a" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">d-删除:删除数据库中的数据</li></ul></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="ca94" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">用Pymongo连接到Python</h1><p id="f56c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">下面的代码显示了我们如何连接到我们的客户端:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="9299" class="nu lt iq nq b gy nv nw l nx ny">import pymongo<br/>from pymongo import MongoClient<br/>import pprint</span><span id="9e6a" class="nu lt iq nq b gy nz nw l nx ny">client = MongoClient("&lt;CONNECTION STRING&gt;")</span></pre><p id="6d7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用自己的字符串替换<code class="fe oa ob oc nq b">&lt;CONNECTION STIRNG&gt;</code>。如果您不确定它是什么，请参考本系列的第1部分！它应该是这样的:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="198f" class="nu lt iq nq b gy nv nw l nx ny">mongodb+srv://analytics:<a class="ae kv" href="mailto:analytics-pw@mflix-b23yi.mongodb.net" rel="noopener ugc nofollow" target="_blank">analytics-pw@mflix-b23yi.mongodb.net</a></span></pre></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="5735" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">创造</h1><p id="4c9a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">只需使用<code class="fe oa ob oc nq b">insert_one()</code>功能即可插入数据:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="3f85" class="nu lt iq nq b gy nv nw l nx ny">from datetime import datetime</span><span id="bb5a" class="nu lt iq nq b gy nz nw l nx ny">new_data = {<br/>    "_id": "unique_id_here",<br/>    "name": "random_name",<br/>    "email": "<a class="ae kv" href="mailto:random_email@email.com" rel="noopener ugc nofollow" target="_blank">random_email@email.com</a>",<br/>    "text": "This is a random text!",<br/>    "date": datetime.utcnow()<br/>}</span><span id="9387" class="nu lt iq nq b gy nz nw l nx ny">insert_result = client.sample_mflix.movies.insert_one(new_data)<br/>pprint.pprint(insert_result.acknowledged)<br/>pprint.pprint(insert_result.inserted_id)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/daca94ff2cdf7a2543680ef46212e51a.png" data-original-src="https://miro.medium.com/v2/resize:fit:434/format:webp/1*zVUDQu-tTl_Wol2ITstwpA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">输出</p></figure><p id="85fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码中，我们将新数据定义为一个字典。您可以包含任意数量的字段(记住，MongoDB是灵活的，您不需要有一组固定的键)。请注意我们是如何用<code class="fe oa ob oc nq b">client.sample_mflix.movies</code>来引用我们的数据库的。它遵循<code class="fe oa ob oc nq b">client.database.collections</code>的层次结构。</p><p id="a033" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最重要的领域是<code class="fe oa ob oc nq b">_id</code>。MongoDB中的每个文档都由一个惟一的标识符标识。如果您要插入两个具有相同标识符的数据，您将会遇到一个错误。</p><p id="28d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用Compass验证新数据是否已插入:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/38a43f8b4e53da8e99605a80745782e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*bMqNILI8MP3FguH8xyAjSw.png"/></div></figure><p id="2b54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当你想在Compass中搜索某个东西时，你必须用下面的格式<code class="fe oa ob oc nq b">{'&lt;KEY&gt;':'&lt;VALUE'}</code>来指定它。</p><p id="1b74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oa ob oc nq b">insert_one()</code>返回我们两个输出:</p><ol class=""><li id="1eb9" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr of mv mw mx bi translated">已确认:如果插入成功，则为真，否则为假</li><li id="8c3d" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr of mv mw mx bi translated">inserted_id:文档的唯一id。您可以使用这个ID在Compass中搜索新数据</li></ol><p id="3e9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="og">但是如果我想插入很多数据呢？</em></p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="00af" class="nu lt iq nq b gy nv nw l nx ny">from datetime import datetime</span><span id="c5e7" class="nu lt iq nq b gy nz nw l nx ny">new_data_1 = {<br/>    "_id": "unique_id_here_1",<br/>    "name": "random_name",<br/>    "email": "<a class="ae kv" href="mailto:random_email@email.com" rel="noopener ugc nofollow" target="_blank">random_email@email.com</a>",<br/>    "text": "This is a random text!",<br/>    "date": datetime.utcnow()<br/>}</span><span id="e764" class="nu lt iq nq b gy nz nw l nx ny">new_data_2 = {<br/>    "_id": "unique_id_here_2",<br/>    "name": "random_name",<br/>    "email": "<a class="ae kv" href="mailto:random_email@email.com" rel="noopener ugc nofollow" target="_blank">random_email@email.com</a>",<br/>    "text": "This is a random text!",<br/>    "date": datetime.utcnow()<br/>}</span><span id="af9f" class="nu lt iq nq b gy nz nw l nx ny">final_data = [new_data_1,new_data_2]</span><span id="b73b" class="nu lt iq nq b gy nz nw l nx ny">insert_result = client.sample_mflix.movies.insert_many(final_data)</span></pre><p id="c079" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你只需要把<code class="fe oa ob oc nq b">insert_one</code>改成<code class="fe oa ob oc nq b">insert_many</code>。就这么简单！</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="b152" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">阅读</h1><p id="1043" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有很多方法可以读取你的数据。您可以使用MongoDB提供的许多其他功能进行过滤、分组、排序、限制、计数、求和。我将介绍一些基础知识。</p><h2 id="7b8b" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">find_one()</h2><p id="7c3e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><code class="fe oa ob oc nq b">find_one()</code>允许我们检索数据库中的第一批数据</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="b608" class="nu lt iq nq b gy nv nw l nx ny">client.sample_mflix.movies.find_one()</span></pre><h2 id="790d" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">投影取景器</h2><p id="d23c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><code class="fe oa ob oc nq b">finder</code>允许我们指定想要过滤的关键字和值。<code class="fe oa ob oc nq b">projection</code>允许我们指定我们想要返回的内容。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="8a85" class="nu lt iq nq b gy nv nw l nx ny">finder = {<br/>    'countries': {'$all': ['USA', 'Italy']}<br/>}<br/>projection={<br/>    'title':1,<br/>    'countries':1,<br/>    'rated': 1<br/>}<br/>pprint.pprint(list(client.sample_mflix.movies.find(finder,projection)))</span></pre><ul class=""><li id="93fc" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">'$all'</code>表示<code class="fe oa ob oc nq b">'countries'</code>字段必须包含所有指定的内容。在我们的例子中，我们想要检索在美国和意大利制作的电影。请注意，这种语法非常类似于您在Compass的搜索栏中键入的内容。</li><li id="2386" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">在<code class="fe oa ob oc nq b">projection</code>下，我们指定想要返回的键。如果要返回，请将值设置为1；如果不想返回该键，请将值设置为0。如果您忽略该键，它将被视为您不想返回该键。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/5c2edd21f3411fcff97ac998729ac906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*nyTmYIJp5N82k_FRtrpU-Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">结果子集</p></figure><h2 id="3c30" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">总计</h2><p id="a906" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">PyMongo中的大部分数据读写都可以使用一个<a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" rel="noopener ugc nofollow" target="_blank">聚合</a>框架来完成。聚合是一种集合类方法。这意味着它只能应用于集合/表。聚合框架需要管道或“模板”:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="9a14" class="nu lt iq nq b gy nv nw l nx ny">pipeline = [<br/>    {<br/>        '$group': {<br/>            '_id': {"rated": "$rated"},<br/>            'count': {"$sum": 1}<br/>        }<br/>    },<br/>    {<br/>        '$sort': {'count': -1}<br/>    }<br/>]</span><span id="90dd" class="nu lt iq nq b gy nz nw l nx ny">pprint.pprint(list(client.sample_mflix.movies.aggregate(pipeline)))</span></pre><ul class=""><li id="f811" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">'$group</code> stage允许我们通过指定的键对输出进行分组。</li><li id="d28c" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">'_id':{"rated":"$rated"}</code>是我们指定想要分组的关键字的地方。在这种情况下，我想按惟一的<code class="fe oa ob oc nq b">rated</code>分组。美元符号($)是字段路径标识符。它允许我们从数据库中检索精确的值。</li><li id="aff1" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">'count': {"$sum": 1}</code>将自动为每个唯一的<code class="fe oa ob oc nq b">rated</code>增加1。</li><li id="c608" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">'$sort':{'count': -1}</code>告诉我们的管道按照计数的降序(-1)对结果进行排序。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/6ffb50dffc6ab55cbedb566276e83ba9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*9Y2U3y1pz9bqN_YCn4czWw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">结果</p></figure><h2 id="bad3" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">方面</h2><p id="a785" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Facet允许我们很好地对数据进行分组。它类似于<code class="fe oa ob oc nq b">$group </code>，但它允许我们定制我们想要的数据分组方式。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="e036" class="nu lt iq nq b gy nv nw l nx ny">pipeline = [<br/>    {<br/>        '$sortByCount': '$countries'<br/>    },<br/>    {<br/>        '$facet':{<br/>            'top country combinations': [{'$limit': 10}],<br/>            'unusual combinations shared by' : [{<br/>                '$skip' : 10<br/>        },<br/>        {<br/>                '$bucketAuto': {<br/>                    'groupBy': "$count",<br/>                    'buckets': 5,<br/>                    'output': {<br/>                        'country combinations': {"$sum":1}<br/>                    }<br/>                }<br/>            }<br/>            ]<br/>        }<br/>    }<br/>]</span><span id="a2ef" class="nu lt iq nq b gy nz nw l nx ny">pprint.pprint(list(client.sample_mflix.movies.aggregate(pipeline)))</span></pre><ul class=""><li id="0ea8" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">‘top country combinations’: [{‘$limit’: 10}]</code>告诉我们的渠道产生前10个国家及其各自的数量</li><li id="43fa" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">‘$skip’ : 10</code>允许我们跳过前10个结果，因为它已经被归类到<code class="fe oa ob oc nq b">'top country combinations'</code>下</li><li id="6d51" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">‘$bucketAuto’: {</code>是一种根据特定指标将剩余结果分组到指定最大数量的桶/箱中的方法。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/243f84d3bdb766c2a2bc728ff74da742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UehQicUqKls6ibVohhr5aw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">结果</p></figure><p id="441d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在结果中，我们首先受到电影数量排名前10位的国家的欢迎。继续，我们有3个桶。对于MongoDB，<code class="fe oa ob oc nq b">min</code>是包含性的，<code class="fe oa ob oc nq b">max</code>是排他性的。这意味着有些电影的国家组合与最少2部其他电影和最多6部其他电影相似。这类电影的数量是469部。另一方面，我们还有<code class="fe oa ob oc nq b">min: 1</code>和<code class="fe oa ob oc nq b">max: 1</code>。这意味着有1695部电影拥有独特的国家组合。</p><h2 id="8425" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">清理、过滤和修改数据到另一个集合中</h2><p id="b250" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对于这一节，我将参考原来的<code class="fe oa ob oc nq b">movies_initial.csv</code>，因为它是不干净的。在将数据导出到另一个名为<code class="fe oa ob oc nq b">movies_subset</code>的集合之前，我们将清理一部分数据。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="8bf4" class="nu lt iq nq b gy nv nw l nx ny">pipeline = [<br/>    {<br/>        '$limit': 100<br/>    },<br/>    {<br/>        '$project': {<br/>            'title': 1,<br/>            'directors': {'$split': ["$director", ", "]},<br/>            'released': {<br/>                '$cond': {<br/>                    'if': {'$ne': ["$released", ""]},<br/>                    'then': {<br/>                        '$dateFromString': {<br/>                            'dateString': "$released"<br/>                        }<br/>                    },<br/>                    'else': ""}},<br/>            'imdb': {<br/>                'id': "$imdbID",<br/>                'rating': "$imdbRating",<br/>                'votes': "$imdbVotes"<br/>                }<br/>        }<br/>    },<br/>    {<br/>        '$out': "movies_subset"<br/>    }<br/>]</span><span id="e6da" class="nu lt iq nq b gy nz nw l nx ny">pprint.pprint(list(client.mflix.movies_initial.aggregate(pipeline)))</span></pre><ul class=""><li id="13b0" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">我们首先将要检索的数据数量限制为100</li><li id="3770" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">我们想要标题字段</li><li id="bb45" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">目录字段被拆分成一个数组。例如，<code class="fe oa ob oc nq b">"Mike, Tom, Harry"</code>将被分割成<code class="fe oa ob oc nq b">["Mike", "Tom", "Harry"]</code></li><li id="3249" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">在released字段中，如果字段不为空，我们实际上是将日期和时间字符串转换为DateTime对象。如果字段为空，我们将返回一个空字符串。</li><li id="dedd" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">‘if’: {‘$ne’: [“$released”, “”]}</code>指定如果我们的released字段不等于空字符串，我们将继续使用子句中的内容。</li><li id="40a8" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">最后<code class="fe oa ob oc nq b">$out</code>允许我们将最终数据导出到一个新的集合中</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/09cecc8d075cc738923413a42cd171b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOuENRJyAw2SO1VjTlJreg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们现在有了新的系列！</p></figure><h2 id="0e23" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">过滤器</h2><p id="f492" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有三种方法可以过滤你的结果。</p><ol class=""><li id="624c" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr of mv mw mx bi translated">$匹配</li></ol><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="405c" class="nu lt iq nq b gy nv nw l nx ny">pipeline = [<br/>    {<br/>        '$match': {'countries': ['USA', 'Italy']}<br/>    }<br/>]<br/>pprint.pprint(list(client.sample_mflix.movies.aggregate(pipeline)))</span></pre><p id="a826" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.探测器</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="f3d8" class="nu lt iq nq b gy nv nw l nx ny">finder = {'countries': ['USA', 'Italy']}<br/>pprint.pprint(list(client.sample_mflix.movies.find(finder)))</span></pre><p id="3d8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.指南针</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="24d0" class="nu lt iq nq b gy nv nw l nx ny">{'countries': ['USA', 'Italy'], 'rated' : "UNRATED"}</span></pre><p id="8853" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以上3个都一样。嗯……不完全一样，我在第三点里面偷偷加了一个滤镜。但是您可以看到如何在一行中输入多个过滤器！</p><p id="9f10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="og">注意，</em> <code class="fe oa ob oc nq b"><em class="og">$all</em></code> <em class="og">和</em> <code class="fe oa ob oc nq b"><em class="og">$match</em></code> <em class="og">非常不同。</em> <code class="fe oa ob oc nq b"><em class="og">$match</em></code> <em class="og">要求完全匹配。</em> <code class="fe oa ob oc nq b"><em class="og">$all</em></code> <em class="og">只要找到指定的值就会返回结果。</em></p><h2 id="5183" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">经营者</h2><p id="ffaf" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您可以在过滤器或搜索中包含某些比较运算符。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="0322" class="nu lt iq nq b gy nv nw l nx ny"># find all movies except the ones which are of adult genre<br/>filters = {<br/>    'year': {'$gte': 1989, '$lt': 2000},<br/>    'genre': { '$not' : {'$eq': 'Adult'} }<br/>}</span><span id="5064" class="nu lt iq nq b gy nz nw l nx ny">pprint.pprint(list(client.sample_mflix.movies.find(filters)))</span></pre><ul class=""><li id="0a2e" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">$gte</code>代表“大于或等于”</li><li id="4912" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">$lt</code>代表“小于”</li><li id="e19d" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">{ ‘$not’ : {‘$eq’: ‘Adult’} }</code>表示我们需要不等于“成人”的值</li></ul><p id="36be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有20多个操作员。我强烈建议您查看<a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/query/" rel="noopener ugc nofollow" target="_blank">文档</a>！</p><h2 id="df3c" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">排序和限制</h2><p id="a1d6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">排序和限制非常简单。我们经常把它们结合起来，使我们的输出可读。您不仅可以将它们输入到聚合框架中，还可以将其用作Python方法。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="41b2" class="nu lt iq nq b gy nv nw l nx ny">from pymongo import DESCENDING<br/>sort_key = "imdb.rating"</span><span id="798d" class="nu lt iq nq b gy nz nw l nx ny">movies = client.sample_mflix.movies.find({}) \<br/>                  .sort(sort_key, DESCENDING).limit(100)</span><span id="c60c" class="nu lt iq nq b gy nz nw l nx ny">list(movies)</span></pre><p id="12fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们指定我们想要排序值的关键字。注意，我们键入<code class="fe oa ob oc nq b">imdb.rating</code>是因为<code class="fe oa ob oc nq b">rating</code>(一个标量)嵌套在<code class="fe oa ob oc nq b">imdb</code>(一个数组)中。</p><p id="272a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，在我们的<code class="fe oa ob oc nq b">.find()</code>方法中，我们输入了一个空字典。这告诉我们的查找器搜索整个集合。</p><p id="4cca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们按降序对结果进行排序，只返回前100个结果。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="5f49" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">更新</h1><p id="10f0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">之前，我们学习了如何将数据修改到新的集合中。现在，我们将看看如何就地修改我们的数据。</p><h2 id="792b" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">逐文档更新一个文档</h2><p id="3f46" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们在代码中所做的是，首先，遍历标题为“泰坦尼克号”的所有电影。接下来，我添加了两个字段，<code class="fe oa ob oc nq b">comments</code>和<code class="fe oa ob oc nq b">num_mflix_comments</code>，并实例化了它们。最后，我删除了<code class="fe oa ob oc nq b">poster</code>字段，因为我不再需要它们了。</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="c98e" class="nu lt iq nq b gy nv nw l nx ny">titanic_filter = {'title': "Titanic"}</span><span id="cabc" class="nu lt iq nq b gy nz nw l nx ny">for movie in client.sample_mflix.movies.find(titanic_filter):<br/>    update_doc = {<br/>        "$set": {<br/>            "comments": [],<br/>            "num_mflix_comments": 0<br/>        },<br/>        "$unset": {<br/>            "poster": ""<br/>        }<br/>    }<br/>    client.sample_mflix.movies.update_one({'_id': movie['_id']}, update_doc)</span></pre><ul class=""><li id="60f6" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">$set</code>用指定的值替换字段的值</li><li id="5486" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><code class="fe oa ob oc nq b">$unset</code>仅删除存在的特定字段</li></ul><p id="2d7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用Compass验证代码是否有效:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/79826479efb43d0af1d9f93eca7dfff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O0Jw3RbsJM4fXLAYdRLZvA.png"/></div></div></figure><p id="aaf6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oa ob oc nq b">update_one</code>一次更新一个文档。如果是一个小数据集，这不是问题。然而，如果我们有一个大的数据集，我们会想要批量更新我们的数据</p><h2 id="a942" class="nu lt iq bd lu oh oi dn ly oj ok dp mc lf ol om me lj on oo mg ln op oq mi or bi translated">批量更新文档</h2><p id="bc45" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">批量更新集合与逐个更新非常相似。不同之处在于，每次迭代，我们将更新保存在一个数组中，而不是更新。同时，我们跟踪我们所处的迭代次数。当我们达到批量时，我们将使用<code class="fe oa ob oc nq b">bulk_write</code>将所有更新写入我们的数据库</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="3dfb" class="nu lt iq nq b gy nv nw l nx ny">from pymongo import UpdateOne</span><span id="437c" class="nu lt iq nq b gy nz nw l nx ny">titanic_filter = {'title': "Titanic"}<br/>batch_size = 10<br/>updates = []<br/>count = 0</span><span id="fac3" class="nu lt iq nq b gy nz nw l nx ny">for movie in client.sample_mflix.movies.find(titanic_filter):<br/>    update_doc = {<br/>        "$set": {<br/>            "comments": [],<br/>            "num_mflix_comments": 0<br/>        },<br/>        "$unset": {<br/>            "poster": ""<br/>        }<br/>    }<br/>    <br/>    updates.append(UpdateOne({'_id': movie['_id']}, update_doc))</span><span id="2fa9" class="nu lt iq nq b gy nz nw l nx ny">count += 1<br/>    if count == batch_size:<br/>        client.sampel_mflix.movies.bulk_write(updates)<br/>        updates = []<br/>        count = 0</span><span id="da51" class="nu lt iq nq b gy nz nw l nx ny">if updates:         <br/>    client.sampel_mflix.movies.bulk_write(updates)</span></pre><p id="2e94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一定要记住用最后两行代码来捕捉最后一批代码！</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="774d" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">删除</h1><p id="7247" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们只需要两个方法<code class="fe oa ob oc nq b">delete_one()</code>和<code class="fe oa ob oc nq b">delete_many()</code>。</p><p id="420c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们来看看收视率低于3.5的电影有多少</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="b1eb" class="nu lt iq nq b gy nv nw l nx ny">filter = {"imdb.rating": {'$lte':3.5}}</span><span id="f35a" class="nu lt iq nq b gy nz nw l nx ny">before = list(client.sample_mflix.movies.find(filter))<br/>len(before)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/0ba7c4ea9554075d471746df04d6afa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*GQuFmcHtXs6g8mD7G0o6fQ.png"/></div></figure><p id="f333" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们注意到有178部电影。我们删除其中一个:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="aad5" class="nu lt iq nq b gy nv nw l nx ny">client.sample_mflix.movies.delete_one(filter)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/6df725f9113299add35b54a2eda59228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*pxlQAfg-0yneW-Y2V7LDMQ.png"/></div></figure><p id="d561" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在只剩下177个，因为我们删除了其中一个。</p><p id="519e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们删除所有评分低于3.5的电影</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="3772" class="nu lt iq nq b gy nv nw l nx ny">client.sample_mflix.movies.delete_many(filter)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/c2ef035d41088c6ffa42646c6858cae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*M_GTktQlVdJtJn8KctUnbw.png"/></div></figure><p id="9964" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功！</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="e980" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">结论</h1><p id="b6c4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">恭喜你！您现在可以在MongoDB中操作数据了。我强烈建议您查看文档。我只能解释这么多功能。然而，文档包含了完成项目所需的每一种方法。我非常相信学会如何阅读文档是成为一名软件工程师/数据科学家的重要部分。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="914f" class="ls lt iq bd lu lv nk lx ly lz nl mb mc jw nm jx me jz nn ka mg kc no kd mi mj bi translated">参考</h1><ol class=""><li id="7cea" class="mp mq iq ky b kz mk lc ml lf pa lj pb ln pc lr of mv mw mx bi translated">【https://www.coursera.org/learn/introduction-mongodb T4】</li><li id="e4df" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr of mv mw mx bi translated"><a class="ae kv" href="https://docs.mongodb.com/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/</a></li><li id="eddb" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr of mv mw mx bi translated">代号:<a class="ae kv" href="https://github.com/bensjx/MongoDB_Demo/upload" rel="noopener ugc nofollow" target="_blank">https://github.com/bensjx/MongoDB_Demo/</a></li></ol></div></div>    
</body>
</html>