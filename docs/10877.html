<html>
<head>
<title>How I built a Scalable Web-Scraper with AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用 AWS 构建一个可伸缩的 Web Scraper</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/get-your-own-data-building-a-scalable-web-scraper-with-aws-654feb9fdad7?source=collection_archive---------10-----------------------#2020-07-29">https://towardsdatascience.com/get-your-own-data-building-a-scalable-web-scraper-with-aws-654feb9fdad7?source=collection_archive---------10-----------------------#2020-07-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a16f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我对完全托管的基于云的 Python scraper 的提议</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d7903d020586add174a751d527f0bf91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xOvdhYEVL9XjJOc5"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我如何想象我的 AWS 控制台…(照片由<a class="ae kv" href="https://unsplash.com/@patrykgradyscom?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">帕特里克·grądys</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><p id="813c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">去年年初，我在 Craigslist 上发现了一个疯狂的二手车交易。经过反复检查，证明这不是一个骗局(事实并非如此)。我很自然地直接去了《凯利蓝皮书》,以了解我的新车的“真正价值”——但这让我想到:</p><blockquote class="ls lt lu"><p id="f0fb" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">凯利蓝皮书是如何计算私人汽车价值的？我凭什么相信他们？</p></blockquote><p id="79c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">似乎他们必须使用的第一个资源是 Craigslist——因为这是最受欢迎的点对点二手车列表平台(直到最近，也是<em class="lv">唯一的</em>主要平台)。如果是这种情况，凯利蓝皮书必须以某种方式访问 Craigslist 的数据。然而，Craigslist 不提供 API，也不向公众开放他们的数据集(假设他们有)。这让我想到，也许像 KBB 这样的公司正在搜集他们的一些数据(这可能是一个安全的猜测)。</p><p id="228e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我决定收集数据来建立我自己的凯利蓝皮书式的平台。为此，我需要构建一个满足以下要求的刮刀:</p><ol class=""><li id="0721" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">易于扩展和动态的刮板，以适应许多 Craigslist 城市，上市，和上市类型。</li><li id="1e39" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">每天管理数百个作业的处理——交错并仔细安排，以避免 DDoS Craigslist 服务器(或被它们阻塞)。</li><li id="80da" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">监控每个作业，以便在出现任何运行时故障时立即通知我。</li><li id="4312" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">最后，CI/CD 用于管理所有相关服务的快速部署。</li></ol><p id="6a4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我的解决方案的高级示意图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mn"><img src="../Images/26e1650e99d7c54eafdca586c5dff8ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m4PJPeC3ppzMPgS5t0h1Gg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="b9eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本质上，我需要构建一个 ETL 管道来每天收集 Craigslist 数据，以便记录每个汽车列表的生命周期和事件(价格变化、除名)。本文重点介绍这些数据的提取过程。在接下来的几周里，我会写更多关于我如何转换/加载和处理数据的内容(稍后先看一些结果——继续阅读！).</p><p id="b135" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">免责声明</strong>:请理解这个项目只是为了研究而建。虽然它有能力在很短的时间内点击 Craigslist 上千个请求(或者让你的电脑崩溃)，但我一直很小心地限制给定时间内的请求数量，通过战略性地间隔作业，以免垃圾邮件/DDoS Craigslist 服务器。<strong class="ky ir">如果你在 Craigslist(或任何这方面的网站)，一定要阅读并遵守</strong><a class="ae kv" href="https://craigslist.org/robots.txt" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">robots . txt</strong></a><strong class="ky ir">。</strong></p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h1 id="fb65" class="mv mw iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">让我们开始吧…</h1><p id="0707" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">虽然我不会像教程那样一步一步地讲解整个过程；我想给你一个刮刀本身如何工作的概念。</p><p id="8606" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">scraper 在 Docker 容器中运行——代码本身非常简单，你可以在这里找到整个项目。它是用 Python 构建的，并使用了<a class="ae kv" href="https://www.crummy.com/software/BeautifulSoup/" rel="noopener ugc nofollow" target="_blank"> BeautifulSoup </a>库。</p><p id="2441" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有几个环境变量被传递给 scraper。这些变量定义了每个作业的搜索参数。本质上，容器的生命周期遵循以下三个步骤:</p><ol class=""><li id="db57" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">向容器传递几个变量，主要是城市/搜索区域和车辆制造商。</li><li id="3ef4" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">容器根据给定的参数搜索 Craigslist，并从 HTML 生成结构化结果。</li><li id="026f" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">容器将这些结果以 CSV 格式发送给 S3。</li></ol><h1 id="685b" class="mv mw iq bd mx my ns na nb nc nt ne nf jw nu jx nh jz nv ka nj kc nw kd nl nm bi translated">流程和基础设施</h1><p id="b0be" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">这是最酷的部分…</p><p id="4604" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们详细回顾一下提取/调度流程。</p><ol class=""><li id="7137" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">每天，我的 AWS <strong class="ky ir"> CloudWatch </strong>事件规则触发 lambdas 为不同的州和汽车制造商分派刮擦工作。</li><li id="73db" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">调度程序将每个城市的任务提交给 AWS 批处理。</li><li id="c39e" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">AWS <strong class="ky ir"> Batch </strong>加速计算环境(<strong class="ky ir"> ECS </strong>)并根据环境的配置运行作业(计算环境决定作业并发性——点击阅读更多关于 AWS Batch <a class="ae kv" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank">的信息)。</a></li><li id="aba5" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated"><strong class="ky ir"> CloudWatch </strong>在批处理发送状态更新时处理并通知故障。</li><li id="6e6f" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">在每个批处理作业结束时，scraper 将发送一个新生成的搜索结果 CSV 到我的<strong class="ky ir"> S3 </strong>桶，命名约定为:search type _ make _ city _ timestamp . CSV。我选择将“品牌”放在“城市”之前，因为品牌对车辆列表的价格和寿命更重要。</li></ol><p id="aff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是刮擦过程的高级示意图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/1b5ce170154cae5a33026695aa8872be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CxDVP9138M_iB4Rnnwd9tw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="fd5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从图中可以看出，我用的是 CloudWatch，Lambda，Batch，S3。我还将 SNS 用于由“批处理-作业-监视器”触发的通知</p><p id="548c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是我选择服务的理由:</p><p id="882c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> CloudWatch </strong>拥有“规则”,其行为类似于 Cron 作业，可以将 JSON 有效负载传递给 lambda 函数。这使我能够提交多个带有 JSON 格式的作业参数的 CloudFormation 模板，以便根据预先确定的 Cron 表达式执行。</p><p id="6a02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Lambda 对于较小的任务(分派和通知)来说非常棒，并且可以很容易地与几乎所有的亚马逊服务集成。</p><p id="9942" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> AWS 批次</strong>非常适合我的刮刀容器。我决定以每个城市为基础运行作业，这意味着在相对较短的时间内会有数千个请求。为了提高每项工作的速度，我决定在 python scraper 中对请求进行多线程处理。这意味着我需要一个允许长运行时间和高 I/O 速率的服务。由于这些条件，Lambda 是不可能的(并且 Lambda 不支持 Python 的多线程包)。我发现 AWS Batch 是完美的——我能够配置计算环境以满足我的需求(和预算),同时在按使用付费的服务中拥有易于维护的 Dockerized scraper。另一个主要的好处是，AWS Batch 使用 ECS 来运行作业，因此，每次处理新队列时，AWS Batch 都会启动新的 EC2 实例— <strong class="ky ir">和新的 IP 地址</strong>(实质上是轮换 IP)。</p><p id="631b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> S3… </strong>好吧，S3 是一个快速又便宜的方法，可以把我的半结构化刮刀暂时存放在一个容易接近的位置。我确实必须考虑我的对象命名标准。如果不考虑命名标准，S3 桶可能会对成千上万的对象造成混乱 AWS SDK 不提供健壮的对象搜索功能。很快，我将把我的数据从 S3 迁移到一个结构化的关系数据库中。</p><p id="b28d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于我需要自己发送的少量文本通知来说，SNS 非常棒——并且很容易与 CloudWatch 和 Lambda 集成。</p><h1 id="e56e" class="mv mw iq bd mx my ns na nb nc nt ne nf jw nu jx nh jz nv ka nj kc nw kd nl nm bi translated">CI/CD 概述</h1><p id="55ad" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">这一部分对我来说很重要，主要是因为我的铲运机有许多移动部件 AWS 控制台可能很乏味。</p><p id="bde7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于提交触发的构建/部署，我使用了<strong class="ky ir">代码管道</strong>和<strong class="ky ir"> TravisCI </strong>。这主要是为了我自己的实验。我发现 TravisCI 能够做我需要的一切，所以我将把我的代码管道项目转移到 TravisCI，每月节省额外的 1 美元😉</p><p id="e841" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用了<a class="ae kv" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">无服务器框架</strong> </a> <strong class="ky ir"> </strong>通过 TravisCI 的构建脚本来处理 Lambda 部署。</p><p id="a200" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">python scraper 被打包并部署到 Amazon 的<strong class="ky ir"> ECR </strong>中，AWS Batch 根据需要引用/启动图像。</p><p id="0914" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我承认，我对我的 Cron 事件规则采取了一种黑客式的方法:我编写了<strong class="ky ir"> CloudFormation </strong>模板，将事件有效负载嵌入为 JSON。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="a5b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转义的“jsonInput”有点混乱，但是我可以通过这些模板轻松地添加或删除作业。例如，如果我想添加另一个抓取作业，我只需添加带有新的“jsonInput”和“cronExpression”值的“group2a”。</p><p id="0828" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我应该注意到“TemplateURL”路由到指向单个 Lambda 函数的事件规则 CloudFormation 模板，该函数被配置为接收“jsonInput”并相应地将作业分派给 AWS 批处理。</p><p id="f7a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当需要更改时，模板被修改并提交给 Github。一旦 pull-request 被合并到我的主分支，TravisCI 就用最新的更改更新 CloudFormation 堆栈。这个过程让我可以非常简单地放大或缩小我的可伸缩刮刀。</p><h1 id="13dc" class="mv mw iq bd mx my ns na nb nc nt ne nf jw nu jx nh jz nv ka nj kc nw kd nl nm bi translated">现在整个事情</h1><p id="8cf3" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">…这是我的整个解决方案—从 CI/CD 到文本提醒:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/3b18ff2f4d28ebec2cc04bf4d056cbae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qI3tB2kGzExew3i3JOtQLw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="e10d" class="mv mw iq bd mx my ns na nb nc nt ne nf jw nu jx nh jz nv ka nj kc nw kd nl nm bi translated">敬请期待！</h1><p id="eadf" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">你想知道如何在这样一个美女身上得到一笔好交易(你不会相信它的价格)吗？或者你可能对项目本身更感兴趣…</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/41f6cf4346f7608ab5e94626deb45498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5teXuSAF4yk89o3yY7cfg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">1998 年奔驰 SLK 230(机械增压)，50k 英里，硬顶敞篷车(一切工作完美)。是的，它是我的。(<em class="oc">图片作者)</em></p></figure><p id="c3c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如上所述，我将很快写关于我的数据集的后处理。作为先睹为快，我对来自加利福尼亚-梅赛德斯-奔驰两个月的数据的样本数据集进行了一些分析(我现在有大约 6 个月的数据！).猜猜我发现了什么？</p><p id="93be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据这个(小)数据集，我的 SLK 是 Craigslist 上所有梅赛德斯-奔驰房源中销售率最高的！</p><p id="36bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看看这个:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/fa29cd48aafdae2666b9511b4ce386d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Sj13Fts-XGYRGzqqExNcA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">有一款 SLK，销售率约为 38%。作者创建的图表。</p></figure><p id="398d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一些很酷的数据，对不对？</p><p id="d8da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我很想听听你对这个解决方案的想法——剥猫皮的方法不止一种。在下面留下评论！</p><p id="2355" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们上<a class="ae kv" href="https://www.linkedin.com/in/aaron-langley/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>连线吧！</p><p id="f207" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">干杯！</p><p id="22f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">—亚伦·兰利</p></div></div>    
</body>
</html>