<html>
<head>
<title>Load and Query CSV File in S3 with Presto</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Presto 在 S3 加载和查询 CSV 文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/load-and-query-csv-file-in-s3-with-presto-b0d50bc773c9?source=collection_archive---------12-----------------------#2020-07-08">https://towardsdatascience.com/load-and-query-csv-file-in-s3-with-presto-b0d50bc773c9?source=collection_archive---------12-----------------------#2020-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c670" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在 S3 用 Presto 加载和查询 CSV 文件</h2></div><p id="788e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在大数据领域，这是一项如此简单而常见的任务，我想人们肯定已经做过一千次了，所以当一位客户问我这个问题时，我直接上网，试图找到一些好的例子与客户分享。你猜怎么着？我找不到！所以我决定自己写一个。</p><p id="e509" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用 Presto 和 S3 的典型数据 ETL 流程如下所示:</p><ol class=""><li id="3521" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">上传 CSV 文件到 S3。</li><li id="d8ce" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">把 S3 的 CSV 文件加载到 Presto。</li><li id="07e7" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">(可选)转换为 Parquet 或 ORC 中的分析优化格式。</li><li id="c398" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">对 Parquet 或 ORC 表运行复杂的查询。</li></ol><p id="eb50" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客中，我使用了<a class="ae ls" href="https://data.cityofnewyork.us/Transportation/2018-Yellow-Taxi-Trip-Data/t29m-gskq" rel="noopener ugc nofollow" target="_blank">纽约市 2018 黄色出租车旅行数据集</a>。数据集有 1.12 亿行，每行 17 列，采用 CSV 格式。总大小为 9.8GB。</p><p id="ad12" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是一些示例数据:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="8808" class="mc md it ly b gy me mf l mg mh">head -n 3 tlc_yellow_trips_2018.csv</span><span id="2a0b" class="mc md it ly b gy mi mf l mg mh">VendorID,tpep_pickup_datetime,tpep_dropoff_datetime,passenger_count,trip_distance,RatecodeID,store_and_fwd_flag,PULocationID,DOLocationID,payment_type,fare_amount,extra,mta_tax,tip_amount,tolls_amount,improvement_surcharge,total_amount<br/>2,05/19/2018 11:51:48 PM,05/20/2018 12:07:31 AM,1,2.01,1,N,48,158,2,11.5,0.5,0.5,0,0,0.3,12.8<br/>1,05/19/2018 11:22:53 PM,05/19/2018 11:35:14 PM,1,1.3,1,N,142,164,2,9,0.5,0.5,0,0,0.3,10.3<br/>1,05/19/2018 11:37:02 PM,05/19/2018 11:52:41 PM,1,2.2,1,N,164,114,1,11,0.5,0.5,3.05,0,0.3,15.35</span></pre><p id="1152" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我假设你已经完成了一个基本的普雷斯托和 S3 设置。您还需要在 Presto 中设置 Hive 目录，以便它查询 S3 的数据。如果你还没有，请看看我的博客<a class="ae ls" href="https://medium.com/swlh/presto-with-kubernetes-and-s3-deployment-4e262849244a" rel="noopener">与 Kubernetes 和 S3-部署</a>。</p><h1 id="3d08" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">上传 CSV 文件到 S3</h1><p id="cb9d" class="pw-post-body-paragraph ki kj it kk b kl na ju kn ko nb jx kq kr nc kt ku kv nd kx ky kz ne lb lc ld im bi translated">在 S3 创建一个目录来存储 CSV 文件。我们可以使用任何 S3 客户端来创建 S3 目录，这里我简单地使用了<code class="fe nf ng nh ly b">hdfs</code>命令，因为它在 Hive Metastore 节点上是可用的，是上述博客中 Hive 目录设置的一部分。</p><p id="62ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从配置单元 Metastore 节点运行以下命令。更改存储桶名称以匹配您的环境。注意，我将<code class="fe nf ng nh ly b">s3a://</code>指定为目录路径模式，以便<code class="fe nf ng nh ly b">hdfs</code>命令在 S3 而不是 HDFS 上创建目录。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0020" class="mc md it ly b gy me mf l mg mh">hdfs dfs -mkdir -p s3a://deephub/warehouse/nyc_text.db/tlc_yellow_trips_2018</span></pre><p id="2f43" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将 CSV 文件上传到我们刚刚创建的目录下的 S3。任何 S3 客户端都可以工作，我使用<a class="ae ls" href="https://github.com/peak/s5cmd" rel="noopener ugc nofollow" target="_blank"> s5cmd </a>，一个非常快的 S3 客户端，上传 CSV 文件到我的 S3 目录。这里我使用<a class="ae ls" href="https://www.purestorage.com/products/flashblade.html" rel="noopener ugc nofollow" target="_blank"> FlashBlade </a> S3，所以我将<code class="fe nf ng nh ly b">endpoint-url</code>指定给我的 FlashBlade 数据 VIP。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="9dc4" class="mc md it ly b gy me mf l mg mh">s5cmd --endpoint-url=<a class="ae ls" href="http://192.168.170.12:80" rel="noopener ugc nofollow" target="_blank">http://192.168.170.12:80</a> cp tlc_yellow_trips_2018.csv s3://deephub/warehouse/nyc_text.db/tlc_yellow_trips_2018/tlc_yellow_trips_2018.csv</span></pre><h1 id="90e7" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">将 CSV 文件加载到 Presto</h1><p id="775b" class="pw-post-body-paragraph ki kj it kk b kl na ju kn ko nb jx kq kr nc kt ku kv nd kx ky kz ne lb lc ld im bi translated">为了在 S3 查询数据，我需要在 Presto 中创建一个表，并将其模式和位置映射到 CSV 文件。</p><p id="9a4b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">启动 Presto CLI:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="4f3b" class="mc md it ly b gy me mf l mg mh">presto-cli --server &lt;coordinate_node:port&gt; --catalog hive</span></pre><p id="71e0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用 Presto CLI 为文本数据创建新的模式。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="9963" class="mc md it ly b gy me mf l mg mh">presto&gt; CREATE SCHEMA nyc_text WITH (LOCATION = 's3a://deephub/warehouse/nyc_text.db');</span></pre><p id="6689" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为 CSV 数据创建外部表。您可以在一个模式下创建多个表。注意事项:</p><ul class=""><li id="93b9" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld ni lk ll lm bi translated">CSV 格式的表格目前只支持<code class="fe nf ng nh ly b">VARCHAR</code>数据类型。</li><li id="324a" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld ni lk ll lm bi translated">我将<code class="fe nf ng nh ly b">skip_header_line_count = 1</code>设置为 table 属性，以便跳过 CSV 文件中的第一行标题。如果您的 CSV 文件不包含标题，请删除此属性。</li><li id="d4ac" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld ni lk ll lm bi translated">Presto 的 CSV 格式支持需要<code class="fe nf ng nh ly b">metastore-site.xml</code> Hive Metastore 配置文件中的<code class="fe nf ng nh ly b">metastore.storage.schema.reader.impl=org.apache.hadoop.hive.metastore.SerDeStorageSchemaReader</code>。</li></ul><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="4ad3" class="mc md it ly b gy me mf l mg mh">presto&gt; CREATE TABLE hive.nyc_text.tlc_yellow_trips_2018 (<br/>    vendorid VARCHAR,<br/>    tpep_pickup_datetime VARCHAR,<br/>    tpep_dropoff_datetime VARCHAR,<br/>    passenger_count VARCHAR,<br/>    trip_distance VARCHAR,<br/>    ratecodeid VARCHAR,<br/>    store_and_fwd_flag VARCHAR,<br/>    pulocationid VARCHAR,<br/>    dolocationid VARCHAR,<br/>    payment_type VARCHAR,<br/>    fare_amount VARCHAR,<br/>    extra VARCHAR,<br/>    mta_tax VARCHAR,<br/>    tip_amount VARCHAR,<br/>    tolls_amount VARCHAR,<br/>    improvement_surcharge VARCHAR,<br/>    total_amount VARCHAR)<br/>WITH (FORMAT = 'CSV',<br/>    skip_header_line_count = 1,<br/>    EXTERNAL_LOCATION = 's3a://deephub/warehouse/nyc_text.db/tlc_yellow_trips_2018')<br/>;</span></pre><p id="b8ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我可以查询 CSV 数据了。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0782" class="mc md it ly b gy me mf l mg mh">presto&gt; SELECT * FROM nyc_text.tlc_yellow_trips_2018 LIMIT 10;</span></pre><p id="0203" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此时，我可以将 Tableau 连接到<a class="ae ls" href="https://help.tableau.com/current/pro/desktop/en-us/examples_presto.htm" rel="noopener ugc nofollow" target="_blank">并可视化 Presto 表中的</a>数据。但由于 CSV 格式表只支持<code class="fe nf ng nh ly b">VARCHAR</code>数据类型，可能会暴露对 Tableau 的限制。如果是这种情况，请将 CSV 转换为拼花或 ORC 格式(见下文)。拼花或 ORC 表通常比文本/CSV 表具有更好的性能。</p><h1 id="08cb" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">(可选)将 CSV 转换为拼花格式</h1><p id="c78f" class="pw-post-body-paragraph ki kj it kk b kl na ju kn ko nb jx kq kr nc kt ku kv nd kx ky kz ne lb lc ld im bi translated">这是一个<strong class="kk iu">可选的</strong>任务，但是如果数据将被多次查询，则建议使用<strong class="kk iu">任务</strong>。通过在 Parquet 或 ORC 中将文本数据转换为分析优化格式，它不仅提高了查询性能，还减少了服务器和存储资源消耗。</p><p id="79a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Presto 适用于可以在 SQL 中完成的简单转换。对于那些使用 SQL 无法轻松完成的复杂业务逻辑(例如，需要 Java/Python 编程)，最好使用 Apache Spark。在这个例子中，我只是将文本转换成 Parquet 格式，而没有引入任何复杂的业务逻辑，所以我将使用 Presto 进行转换。</p><p id="a096" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 Presto 中管理数据的一个常见做法是对原始文本(CSV/TSV)表和优化的(Parquet/ORC)表使用不同的模式。所以我将为镶木地板桌子创建一个新的模式<code class="fe nf ng nh ly b">nyc_parq</code>。</p><p id="a56c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为新模式创建一个 S3 目录。更改存储桶名称以匹配您的环境。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="a8c3" class="mc md it ly b gy me mf l mg mh">hdfs dfs -mkdir -p s3a://deephub/warehouse/nyc_parq.db</span></pre><p id="89a0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 Presto CLI 中创建<code class="fe nf ng nh ly b">nyc_parq</code>模式。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="8eb3" class="mc md it ly b gy me mf l mg mh">presto&gt; CREATE SCHEMA nyc_parq WITH (LOCATION = 's3a://deephub/warehouse/nyc_parq.db');</span></pre><p id="eb8d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建镶木地板表，将 CSV 数据转换为镶木地板格式。您可以更改<code class="fe nf ng nh ly b">SELECT</code>原因来添加简单的业务和转换逻辑。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="ec4d" class="mc md it ly b gy me mf l mg mh">presto&gt; CREATE TABLE hive.nyc_parq.tlc_yellow_trips_2018<br/>COMMENT '2018 Newyork City taxi data'<br/>WITH (FORMAT = 'PARQUET')<br/>AS<br/>SELECT <br/>    cast(vendorid as INTEGER) as vendorid,<br/>    date_parse(tpep_pickup_datetime, '%m/%d/%Y %h:%i:%s %p') as tpep_pickup_datetime,<br/>    date_parse(tpep_dropoff_datetime, '%m/%d/%Y %h:%i:%s %p') as tpep_dropoff_datetime,<br/>    cast(passenger_count as SMALLINT) as passenger_count,<br/>    cast(trip_distance as DECIMAL(8, 2)) as trip_distance,<br/>    cast(ratecodeid as INTEGER) as ratecodeid,<br/>    cast(store_and_fwd_flag as CHAR(1)) as store_and_fwd_flag,<br/>    cast(pulocationid as INTEGER) as pulocationid,<br/>    cast(dolocationid as INTEGER) as dolocationid,<br/>    cast(payment_type as SMALLINT) as payment_type,<br/>    cast(fare_amount as DECIMAL(8, 2)) as fare_amount,<br/>    cast(extra as DECIMAL(8, 2)) as extra,<br/>    cast(mta_tax as DECIMAL(8, 2)) as mta_tax,<br/>    cast(tip_amount as DECIMAL(8, 2)) as tip_amount,<br/>    cast(tolls_amount as DECIMAL(8, 2)) as tolls_amount,<br/>    cast(improvement_surcharge as DECIMAL(8, 2)) as improvement_surcharge,<br/>    cast(total_amount as DECIMAL(8, 2)) as total_amount<br/>FROM hive.nyc_text.tlc_yellow_trips_2018<br/>;</span></pre><p id="de02" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据数据大小，此转换可能需要一些时间。一旦完成，我就可以查询拼花地板数据。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="3258" class="mc md it ly b gy me mf l mg mh">presto&gt; SELECT * FROM nyc_parq.tlc_yellow_trips_2018 LIMIT 10;</span></pre><p id="afcc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确认拼花桌的模式。注意此表中的列具有所需的类型。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="3df9" class="mc md it ly b gy me mf l mg mh">presto&gt; describe nyc_parq.tlc_yellow_trips_2018;<br/>        Column         |     Type     | Extra | Comment<br/>-----------------------+--------------+-------+---------<br/> vendorid              | integer      |       |<br/> tpep_pickup_datetime  | timestamp    |       |<br/> tpep_dropoff_datetime | timestamp    |       |<br/> passenger_count       | smallint     |       |<br/> trip_distance         | decimal(8,2) |       |<br/> ratecodeid            | integer      |       |<br/> store_and_fwd_flag    | char(1)      |       |<br/> pulocationid          | integer      |       |<br/> dolocationid          | integer      |       |<br/> payment_type          | smallint     |       |<br/> fare_amount           | decimal(8,2) |       |<br/> extra                 | decimal(8,2) |       |<br/> mta_tax               | decimal(8,2) |       |<br/> tip_amount            | decimal(8,2) |       |<br/> tolls_amount          | decimal(8,2) |       |<br/> improvement_surcharge | decimal(8,2) |       |<br/> total_amount          | decimal(8,2) |       |<br/>(17 rows)</span></pre><p id="6de2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我配置我的分析应用程序/ Tableau 来使用优化的<code class="fe nf ng nh ly b">nyc_parq</code>模式和拼花表。</p><h1 id="525c" class="mj md it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">高级主题</h1><p id="d24f" class="pw-post-body-paragraph ki kj it kk b kl na ju kn ko nb jx kq kr nc kt ku kv nd kx ky kz ne lb lc ld im bi translated">随着数据变得越来越大(例如超过 TB)，以对查询性能最佳的方式组织数据变得越来越重要。使用拼花地板或 ORC 共振峰是一种优化，还有其他优化，例如:</p><ul class=""><li id="9e65" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld ni lk ll lm bi translated">谓词下推。</li><li id="2eef" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld ni lk ll lm bi translated">分区表。</li><li id="dbf3" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld ni lk ll lm bi translated">拼花地板和 ORC 中的数据排序。</li><li id="e9c8" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld ni lk ll lm bi translated">加入战略和基于成本的优化。</li></ul><p id="f752" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些主题不是 Presto 特定的，它们适用于大多数存储和查询引擎，包括 S3 和 Presto。这些话题的细节超出了本博客的范围。请继续关注我的博客。</p></div></div>    
</body>
</html>