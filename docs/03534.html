<html>
<head>
<title>Publish your models with a standard based REST API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用基于标准的REST API发布您的模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/publish-your-models-with-a-standard-rest-api-94de1e1da682?source=collection_archive---------21-----------------------#2020-04-03">https://towardsdatascience.com/publish-your-models-with-a-standard-rest-api-94de1e1da682?source=collection_archive---------21-----------------------#2020-04-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7de9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用DEEPaaS API公开您的模型的逐步指南</h2></div><p id="7274" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无论您是在开发一个成熟的应用程序，还是只想与您的同事共享模型，您都可能面临这样的情况:您需要与其他人共享您新开发的模型。在这个简短的分步教程中，我们将展示如何使用REST API轻松共享您的模型，而无需从头开始开发。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/0012043a5c8b40a56cc250b5a5c37d4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ITAM5XywWmIV0Lrqf9JkXw.png"/></div></div></figure></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><p id="1d60" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">构建机器学习模型的数据科学家没有一种简单而通用的方法来与他们的同事或任何有兴趣使用他们的人共享他们开发的应用程序。整个模型(即代码和任何需要的配置资产)可以共享，但是这要求模型的接收者需要有足够的知识来执行它。在大多数情况下，我们只是想分享模型以展示其功能(向其他同事或对我们的预测模型感兴趣的公司)，因此没有必要分享整个实验。</p><p id="04df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们工作的互联世界中，最直接的方法是通过HTTP端点公开模型，以便潜在用户可以通过网络远程访问它。这听起来可能很简单，但是开发一个合适且正确的REST API并不是一件容易的事情。首先，正如<a class="ae lu" rel="noopener" target="_blank" href="/search?q=rest%20api">在其他帖子</a>中所展示的，数据科学家需要从头开始开发API，这项任务需要API编程、网络、REST语义、安全性等方面的知识。第二(可能是一个不太明显的问题)，如果每个科学家都提出一个实现，我们最终会有无数不同的、不可互操作的API做或多或少相同的工作，导致一个支离破碎的生态系统，我们需要知道如何与所有这些端点交互。</p><h1 id="3c86" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">DEEPaaS API:一个公开机器学习模型的REST API</h1><p id="7f1f" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">进入<a class="ae lu" href="https://deepaas.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> DEEPaaS API </a>:使用<a class="ae lu" href="https://docs.aiohttp.org/" rel="noopener ugc nofollow" target="_blank"> aiohttp </a>搭建的机器学习、深度学习和人工智能REST API框架。DEEPaaS是一个软件组件，它允许通过HTTP端点公开Python模型(使用您选择的框架实现)的功能。它不需要对原始代码进行修改，并有方法根据科学家的选择(输入参数、预期输出等)对其进行定制。)</p><p id="a4e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DEEPaaS API遵循<a class="ae lu" href="https://www.openapis.org/" rel="noopener ugc nofollow" target="_blank"> OpenAPI规范(OAS) </a>，因此它允许人类和计算机发现并理解底层模型的功能、其输入参数和输出值，而无需检查模型的源代码。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ms"><img src="../Images/e47d63e3e3e8ca0c384e609cc852131a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eChliA-fJiQv5mSfV6k_1Q.png"/></div></div><p class="mt mu gj gh gi mv mw bd b be z dk translated">使用DEEPaaS API公开的测试模型的Swagger web用户界面。</p></figure><p id="b7d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过一个走过的例子来看看它是如何工作的。</p><h1 id="e666" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">使用DEEPaaS逐步发布模型</h1><h2 id="468d" class="mx lw iq bd lx my mz dn mb na nb dp mf ko nc nd mh ks ne nf mj kw ng nh ml ni bi translated">将模型插入API</h2><p id="18d3" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">为了更好地说明如何将模型与DEEPaaS集成，我们将使用来自<a class="ae lu" href="https://scikit-learn.org/" rel="noopener ugc nofollow" target="_blank"> scikit-learn </a>的一个最著名的例子:一个针对<a class="ae lu" href="https://scikit-learn.org/stable/auto_examples/datasets/plot_iris_dataset.html#sphx-glr-auto-examples-datasets-plot-iris-dataset-py" rel="noopener ugc nofollow" target="_blank"> IRIS数据集</a>训练的<a class="ae lu" href="https://scikit-learn.org/stable/modules/svm.html" rel="noopener ugc nofollow" target="_blank">支持向量机</a>。在这个简单的例子中，我们定义了两个不同的函数，一个用于训练，一个用于执行预测，如下所示:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="adba" class="mx lw iq nk b gy no np l nq nr">from joblib import dump, load                                                      <br/>import numpy                                                                       <br/>from sklearn import svm                                                            <br/>from sklearn import datasets                                                       <br/>                                                                                                                                                                   <br/>def train():                                                                       <br/>    clf = svm.SVC()                                                                <br/>    X, y = datasets.load_iris(return_X_y=True)                                     <br/>    clf.fit(X, y)                                                                  <br/>    dump(clf, 'iris.joblib')                                                                                                                                          <br/>                                                                                   <br/>def predict(data):                                                                 <br/>    clf = load('iris.joblib')                                                      <br/>    data = numpy.array(data).reshape(1, -1)                                        <br/>    prediction = clf.predict(data)                                                 <br/>    return {"labels": prediction.tolist()}</span></pre><p id="8973" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，按照<a class="ae lu" href="https://scikit-learn.org/stable/tutorial/basic/tutorial.html#model-persistence" rel="noopener ugc nofollow" target="_blank"> scikit-learn的教程</a>，训练函数将训练好的模型保存到磁盘中。下一步是为您的培训和预测呼叫定义输入参数。因为这个例子非常简单，所以我们只为预测调用定义输入参数。通常你需要把它放在一个不同的文件中，这样它就不会干扰你的代码，但是为了简单起见，我们在IRIS SVM旁边添加了这个特殊的函数:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="b9ec" class="mx lw iq nk b gy no np l nq nr">from joblib import dump, load                                                      <br/>import numpy                                                                       <br/>from sklearn import svm                                                            <br/>from sklearn import datasets                                                       <br/>from webargs import fields, validate                                                                                                                                 <br/>                                                                                   <br/>def train():                                                                       <br/>    clf = svm.SVC()                                                                <br/>    X, y = datasets.load_iris(return_X_y=True)                                     <br/>    clf.fit(X, y)                                                                  <br/>    dump(clf, 'iris.joblib')                                                                                                                                     <br/>                                                                                   <br/>def predict(data):                                                              <br/>    clf = load('iris.joblib')                                                   <br/>    data = numpy.array(data).reshape(1, -1)                                     <br/>    prediction = clf.predict(data)                                              <br/>    return {"labels": prediction.tolist()}                                      <br/>                                                                                                                                                             <br/>def get_predict_args():                                                         <br/>    args = {                                                                    <br/>        "data": fields.List(                                                    <br/>            fields.Float(),                                                     <br/>            required=True,                                                      <br/>            description="Data to make a prediction. "<br/>                        "The IRIS dataset expects "  <br/>                        "four values containing the "<br/>                        "Sepal Length, Sepal Width, " <br/>                        "Petal Length and Petal Width.",                        <br/>            validate=validate.Length(equal=4),                                  <br/>        ),                                                                      <br/>    }                                                                           <br/>    return args</span></pre><p id="88d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一步，为了将它与DEEPaaS API集成，你需要使它可安装(你应该这样做)，并使用<a class="ae lu" href="https://docs.python.org/3.8/distutils/setupscript.html" rel="noopener ugc nofollow" target="_blank"> Python的setuptools </a>定义一个入口点。DEEPaaS将使用这个入口点来了解如何加载以及如何将不同的函数插入到已定义的端点。我们目前使用的是<code class="fe ns nt nu nk b">deepaas.model.v2</code>入口点名称空间，因此我们可以如下创建<code class="fe ns nt nu nk b">setup.py</code>文件:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="0433" class="mx lw iq nk b gy no np l nq nr">from distutils.core import setup                                                   <br/>                                                                                   <br/>setup(                                                                             <br/>    name='test-iris-with-deepaas',                                                 <br/>    version='1.0',                                                                 <br/>    description='This is an SVM trained with the IRIS dataset',                    <br/>    author='Álvaro López',                                                         <br/>    author_email='aloga@ifca.unican.es',                                           <br/>    py_modules="iris-deepaas.py",                                                          <br/>    dependencies=['joblib', 'scikit-learn'],                                       <br/>    entry_points={                                                                 <br/>        'deepaas.v2.model': ['iris=iris-deepaas'],                                 <br/>    }                                                                              <br/>)</span></pre><h2 id="6094" class="mx lw iq bd lx my mz dn mb na nb dp mf ko nc nd mh ks ne nf mj kw ng nh ml ni bi translated">安装、运行DEEPaaS并展示您的模型</h2><p id="2d02" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">一旦您准备好代码，您只需要安装您的模块和DEEPaaS API，这样它就可以检测到它并通过API公开它的功能。为了以一种简单的方式做到这一点，让我们创建一个virtualenv并在其中安装所有内容:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="8375" class="mx lw iq nk b gy no np l nq nr">$ virtualenv env --python=python3<br/>    (...)<br/>$ source env/bin/activate<br/>(env) $ pip3 install .<br/>    (...)<br/>(env) $ pip3 install deepaas<br/>    (...)<br/>(env) $ deepaas-run<br/><br/>         ##         ###<br/>         ##       ######  ##<br/>     .#####   #####   #######.  .#####.<br/>    ##   ## ## //   ##  //  ##  ##   ##<br/>    ##. .##  ###  ###   // ###  ##   ##<br/>      ## ##    ####     ####    #####.<br/>              Hybrid-DataCloud  ##<br/><br/><br/>Welcome to the DEEPaaS API API endpoint. You can directly browse to the<br/>API documentation endpoint to check the API using the builtint Swagger UI<br/>or you can use any of our endpoints.<br/><br/>    API documentation: http://127.0.0.1:5000/ui<br/>    API specification: http://127.0.0.1:5000/swagger.json<br/>          V2 endpoint: http://127.0.0.1:5000/v2<br/><br/>-------------------------------------------------------------------------<br/><br/>2020-02-04 13:10:50.027 21186 INFO deepaas [-] Starting DEEPaaS version 1.0.0<br/>2020-02-04 13:10:50.231 21186 INFO deepaas.api [-] Serving loaded V2 models: ['iris-deepaas']</span></pre><h2 id="a0c6" class="mx lw iq bd lx my mz dn mb na nb dp mf ko nc nd mh ks ne nf mj kw ng nh ml ni bi translated">访问API，触发训练和预测</h2><p id="caa8" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">如果一切正常，现在你应该能够将你的浏览器指向控制台中打印的URL(<code class="fe ns nt nu nk b">http://127.0.0.1:5000/ui</code>)并得到一个好看的<a class="ae lu" href="https://swagger.io/tools/swagger-ui/" rel="noopener ugc nofollow" target="_blank"> Swagger UI </a>，这将允许你与你的模型进行交互。</p><p id="a670" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为这是一个简单的例子，我们还没有提供一个经过训练的模型，所以首先要做的是进行一次训练。这将调用<code class="fe ns nt nu nk b">train()</code>函数并保存训练好的SVM以备后用。您可以通过用户界面或命令行来完成:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="37da" class="mx lw iq nk b gy no np l nq nr">curl -s -X POST "http://127.0.0.1:5000/v2/models/iris-deepaas/train/" -H  "accept: application/json" | python -mjson.tool<br/>{<br/>    "date": "2020-02-04 13:14:49.655061",<br/>    "uuid": "16a3141af5674a45b61cba124443c18f",<br/>    "status": "running"<br/>}</span></pre><p id="5390" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">训练将异步完成，这样API就不会阻塞。您可以从UI中检查其状态，或者使用以下调用:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="fed9" class="mx lw iq nk b gy no np l nq nr">curl -s -X GET "http://127.0.0.1:5000/v2/models/iris-deepaas/train/" | python -mjson.tool<br/>[<br/>    {<br/>        "date": "2020-02-04 13:14:49.655061",<br/>        "uuid": "16a3141af5674a45b61cba124443c18f",<br/>        "status": "done"<br/>    }<br/>]</span></pre><p id="945d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然模型已经定型，我们就可以进行预测了。鸢尾数据集由3种不同类型的鸢尾(Setosa、Versicolour和Virginica)花瓣和萼片长度组成。样本有四列，分别对应于萼片长度、萼片宽度、花瓣长度和花瓣宽度。在我们的示例中，让我们尝试获取<code class="fe ns nt nu nk b">[5.1. 3.5, 1.4, 0.2]</code>观察的结果，并获取结果。同样，您可以从UI或命令行进行设置，如下所示:</p><pre class="lc ld le lf gt nj nk nl nm aw nn bi"><span id="a1df" class="mx lw iq nk b gy no np l nq nr">curl -s -X POST "http://127.0.0.1:5000/v2/models/iris-deepaas/predict/?data=5.1&amp;data=3.5&amp;data=1.4&amp;data=0.2" -H  "accept: application/json" | python -mjson.tool<br/>{<br/>    "predictions": {<br/>        "labels": [<br/>            0<br/>        ]<br/>    },<br/>    "status": "OK"<br/>}</span></pre><p id="f530" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，结果包含了我们的SVM执行的预测。在这种情况下，输入数据的标签是<code class="fe ns nt nu nk b">0</code>，这确实是正确的。</p><p id="b9ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">整个代码示例可以在这个<a class="ae lu" href="https://gist.github.com/alvarolopez/850160d4681794d5292222d4ebbaf938" rel="noopener ugc nofollow" target="_blank">要点</a>中找到。</p><h1 id="29e7" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">结论</h1><p id="8b8e" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在这个简单的例子中，我们展示了机器学习实践者如何通过依赖于DEEPaaS API的REST API来公开任何基于Python的模型，而不是开发他们自己的自制API。通过这样做，数据科学家可以专注于他们的工作，而不用担心编写和开发复杂的REST应用程序。此外，通过使用一个通用的API，不同的模块将共享相同的接口，这使得它更容易在生产中部署和被不同的程序员使用。</p><h2 id="5bd2" class="mx lw iq bd lx my mz dn mb na nb dp mf ko nc nd mh ks ne nf mj kw ng nh ml ni bi translated">承认</h2><p id="5017" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated"><em class="nv">DEEPaaS API已在</em><a class="ae lu" href="https://deep-hybrid-datacloud.eu/" rel="noopener ugc nofollow" target="_blank"><em class="nv">DEEP-Hybrid-data cloud</em></a><em class="nv">h 2020项目(授权协议号777435)中开发，该项目旨在为欧洲分布式电子基础设施上的机器学习和深度学习构建一个平台。</em></p><p id="7821" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nv">注:本帖原帖于</em><a class="ae lu" href="https://www.kdnuggets.com/2020/02/sharing-machine-learning-models-common-api.html" rel="noopener ugc nofollow" target="_blank"><em class="nv">KD nuggets</em></a><em class="nv">。</em></p></div></div>    
</body>
</html>