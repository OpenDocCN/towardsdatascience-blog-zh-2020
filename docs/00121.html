<html>
<head>
<title>A Simple Way of Automating and Scheduling SQL Server Database Replication between Different Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种在不同服务器之间自动化和安排 SQL Server 数据库复制的简单方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-simple-way-of-automating-and-scheduling-sql-server-database-replication-between-different-servers-fa53fe22b856?source=collection_archive---------13-----------------------#2020-01-04">https://towardsdatascience.com/a-simple-way-of-automating-and-scheduling-sql-server-database-replication-between-different-servers-fa53fe22b856?source=collection_archive---------13-----------------------#2020-01-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/4c459b1149966b4cee392ff300e70593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*26JDHuoMD1kbU6edvufz1A.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片提供:<a class="ae jg" href="https://www.spiria.com/site/assets/files/2398/2016-sql-server-logo.-large.jpg" rel="noopener ugc nofollow" target="_blank">https://www . spiria . com/site/assets/files/2398/2016-SQL-server-logo。-large.jpg </a></p></figure><div class=""/><p id="9db4" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">微软 SQL Server 提供了<code class="fe le lf lg lh b">SQL Server Replication</code>功能，我们可以利用这些功能将一个数据库设置为<code class="fe le lf lg lh b">Publisher</code>和另一个数据库为<code class="fe le lf lg lh b">Subscriber</code>，这样我们就可以在脚本中通过定制来复制数据库。但是，有时需求可能没有那么复杂，因此 SQL Server 复制可能有点过头了。</p><p id="a7d8" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，最近我的一个客户想要启动一个概念验证项目来构建一个数据仓库。他们担心他们赖以保持业务运行的生产数据库。因此，在我们从数据库中提取数据来构建数据仓库之前，我们需要复制数据库，以便所有的开发工作都可以在这些副本上进行。</p><p id="89b1" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种情况下，没有必要在复制过程中包括任何定制，这只是简单地镜像数据库。在本文中，我将介绍一种在不同服务器之间自动复制 SQL Server 数据库的非常简单的方法。</p><h1 id="0098" class="li lj jj bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">在 Azure 中创建 SQL 服务器</h1><p id="1c51" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">让我们首先为这个实验创建两个 SQL 服务器。强烈建议使用 Azure，否则，您需要准备两台不同的机器，获得适当的 SQL Server 许可证并安装 SQL Server 软件，这可能需要一整天的时间。</p><p id="b5f2" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你是 Azure 的新用户，当你注册 Azure 为新用户时，你将获得 200 美元的积分(一个月内)。</p><p id="927a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到您的 Azure 订阅，首先创建一个资源组，这将是 SQL 服务器的容器。然后，去 marketplace 搜索“sql server”，如截图所示选择 Windows Server 2016 上的 SQL Server 2017。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/f1efe1c16c6dfe078d70d53c78cad1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*XTPbdirMcThqWBw4Yq-a4g.png"/></div></figure><p id="ae73" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下拉手册中，选择标准版以拥有所有标准功能。然后，单击“从预设配置开始”以节省时间。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mq"><img src="../Images/4ab1d57133befde517bdf3e684e97c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X4FTttSTp9UtD6yrWfm-RQ.png"/></div></div></figure><p id="30dc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我们可以选择开发/测试环境和 D 系列虚拟机(都是最小的)来节省成本，特别是如果您已经用完了所有的免费积分。然后，单击“创建虚拟机”</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mr"><img src="../Images/8c6f65fba05c7116063eff61df8a9c9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGyTZ3LT70YuhPz9gK_vag.png"/></div></div></figure><p id="d190" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保您选择了为此创建的资源组。然后，单击下一步。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/a9bb968bb71cc23db7a3223e4e341d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLTyEXLqpdox0gpNJ-7ymw.png"/></div></div></figure><p id="c0bc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">填写管理员凭据。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mt"><img src="../Images/9cb13bf11e05ad36a9027af76d0a483e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TI2dxXqB2EnwODxbKMPmkA.png"/></div></div></figure><p id="01e5" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">磁盘对这个实验不重要，所以我们可以跳过。然而，虚拟网络非常重要。确保您创建了一个新的虚拟网络和子网，更重要的是，如果您不想在这个实验中产生一些可访问性问题，那么稍后创建的另一个 SQL Server 必须在同一个虚拟网络和子网中。另外，为了方便起见，打开 RDP 端口 3389。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/33d578c75bdb23153a8a6d7ec71f8c59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7bJfo_wEUeBWNyamgNG6-g.png"/></div></div></figure><p id="7e08" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要更改默认端口号并创建 SQL 身份验证。之后，我们已经完成了配置。点击创建按钮在 Azure 中创建资源。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mv"><img src="../Images/3ce4086a7a334a62665fb1ca10b5e9d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hHMW959gd4kSYEDgTlbpyA.png"/></div></div></figure><p id="ce5f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在等待部署资源的同时，我们可以创建另一个 SQL Server。我就叫它<code class="fe le lf lg lh b">SQL-Server-Test</code>。</p><h1 id="2020" class="li lj jj bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">准备“生产”SQL Server</h1><p id="d6da" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">在部署了第一个 SQL Server 之后，转到资源组并找到用于<code class="fe le lf lg lh b">SQL-Server-Prod</code>的 Windows VM。因为我们已经为该机器打开了 RDP 端口，所以我们可以使用它的公共 IP 地址来远程控制该虚拟机。</p><p id="1cc3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请记录私有 IP 地址，稍后测试机器将使用该地址连接到该产品机器</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mw"><img src="../Images/539fc1c85ad46f3d98666ace0139769a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5EtKC2sH_1xPsfaOnLohQQ.png"/></div></div></figure><h2 id="ebab" class="mx lj jj bd lk my mz dn lo na nb dp ls kr nc nd lw kv ne nf ma kz ng nh me ni bi translated">下载一个示例数据库</h2><p id="624e" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">让我们安装一个来自微软的示例数据库。在生产机器上，下载数据库备份:<a class="ae jg" href="https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorks2017.bak" rel="noopener ugc nofollow" target="_blank">https://github . com/Microsoft/SQL-server-samples/releases/download/adventureworks/adventureworks 2017 . bak</a></p><p id="bc2c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 SSMS，使用默认的 Windows 管理员帐户登录数据库实例。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nj"><img src="../Images/294b6b05450495a5a675e2f2ceb232c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JdW1YfPgztxInssnwP790Q.png"/></div></div></figure><h2 id="de5f" class="mx lj jj bd lk my mz dn lo na nb dp ls kr nc nd lw kv ne nf ma kz ng nh me ni bi translated">恢复示例数据库</h2><p id="e96c" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">右键单击“数据库”并选择“恢复数据库”。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/40735fa2ac568b06c6a68a833d91155d.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*v12uxOL33KPTjlRs23adtg.png"/></div></figure><p id="e1e0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在弹出窗口中，单击“设备”单选按钮右侧的浏览按钮-&gt;添加-&gt;浏览您刚刚下载的 bak 文件-&gt;确定-&gt;确定-&gt;确定。恢复整个数据库可能需要大约 1 分钟。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nl"><img src="../Images/32d7cbc02a5be9cf764b7110db5e0331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-cjUJAYR8B_2oOlR_cdZg.png"/></div></div></figure><h2 id="6800" class="mx lj jj bd lk my mz dn lo na nb dp ls kr nc nd lw kv ne nf ma kz ng nh me ni bi translated">准备备份路径</h2><p id="a780" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">接下来，我们需要创建一个文件夹来存放备份文件。此外，我们需要在网络中共享这个文件夹，以便测试机器可以访问备份文件并恢复它。</p><p id="53e0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我创建了目录<code class="fe le lf lg lh b">C:\backup\</code>。然后，将该文件夹共享到另一台机器上的同一个管理员帐户。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/ae7d2bc37ff8bc49a30ead5e9fdabc93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GlVPXJXA8P9pGnjo7l6Arg.png"/></div></div></figure><p id="1154" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，将<code class="fe le lf lg lh b">MSSQLSERVER</code>用户添加到共享中很重要。否则，共享后 SQL Server 可能无法将备份文件写入此文件夹。只需输入<code class="fe le lf lg lh b">MSSQLSERVER</code>用户名并点击添加按钮，然后确保授予它读/写权限。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/b99ea70ca5af08eb7d59f0dbfef979c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*mVi1_Nc-xt4RXI9dxACuLg.png"/></div></figure><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi no"><img src="../Images/94f0b229c625bf88ec9ee2a628cae6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*l5Y_ZxAOGOM8schyz9db_Q.png"/></div></figure><p id="cb2f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在测试机器上，我们现在将能够访问<code class="fe le lf lg lh b">backup</code>目录。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi np"><img src="../Images/ff58f3d71fed4b1f4487467f5dc78b87.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*QZNvy2iTd-P5LBtQwhiYqw.png"/></div></figure><h1 id="b344" class="li lj jj bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">在 SQL-Server-Production 上创建备份</h1><p id="d303" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">因为 SQL Server 代理在默认情况下是禁用的，所以我们需要再次远程控制生产机器来启用它。右键点击<code class="fe le lf lg lh b">SQL-Server-Agent</code> - &gt;开始。然后，在弹出的确认窗口中点击<code class="fe le lf lg lh b">Yes</code>。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/33849e7becda66a1168d5a35b4999b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*rO361VGxJE8dBe68ut484w.png"/></div></figure><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/bc2a01a34329cf9ee24df955162926d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*IVFRQ7fnVnjqy5izNq4Zjw.png"/></div></figure><p id="4ff1" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">等到 SQL Server 代理启动后，返回测试计算机。您需要重新连接生产 SQL Server 才能看到 SQL 代理的启用。</p><p id="e698" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">右键<code class="fe le lf lg lh b">Jobs</code>-&gt;-<code class="fe le lf lg lh b">New Job...</code>。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/051072b370455c5d5e6df8586ed7ab33.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*dUyISzzkraGuCN1Xjzt6fg.png"/></div></figure><p id="e213" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe le lf lg lh b">New Job</code>窗口中，输入名称并转到<code class="fe le lf lg lh b">Steps</code>选项卡。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/86165a23a96f7575369d67f60093df91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*5VNAPsxwPquDOiHD2_8B3g.png"/></div></figure><p id="12c5" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe le lf lg lh b">Steps</code>页签中，点击<code class="fe le lf lg lh b">New</code>按钮。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/6925699475f5a104e35a18bd45c4fdec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*xWJszOeJhzEPP0vwbHhK6A.png"/></div></figure><p id="deb3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe le lf lg lh b">New Job Step</code>窗口中，输入步骤名称和脚本如下:</p><pre class="mm mn mo mp gt nv lh nw nx aw ny bi"><span id="d137" class="mx lj jj lh b gy nz oa l ob oc">USE AdventureWorks2017<br/>GO</span><span id="1256" class="mx lj jj lh b gy od oa l ob oc">DECLARE <a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a> varchar(255)<br/>DECLARE <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a> datetime</span><span id="881a" class="mx lj jj lh b gy od oa l ob oc">SELECT <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>=getdate()<br/>SELECT <a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a>='C:\backup\AdventureWorks2017-' + CAST(DATEPART(yyyy, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '-' + CAST(DATEPART(mm, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '-' +  CAST(DATEPART(dd, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '.bak'</span><span id="ac78" class="mx lj jj lh b gy od oa l ob oc">BACKUP DATABASE AdventureWorks2017 TO DISK=<a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a> WITH INIT<br/>GO</span></pre><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/749dc1b61f8612a4290d520abb46a5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*tH4LBGZcME-H0z4Link42g.png"/></div></figure><p id="45d7" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，进入<code class="fe le lf lg lh b">Advanced</code>选项卡，配置成功和失败行为。这里，你需要考虑你的情况，比如你的数据库有多大等等。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi of"><img src="../Images/4f96efe163906a7556212354b88c391e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDf1m40Ukb8iLC7CW3NbLA.png"/></div></div></figure><p id="f96d" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击确定确认应用作业步骤，然后转到<code class="fe le lf lg lh b">Schedule</code>选项卡并点击新建按钮。您可以根据自己的需求配置时间表。在本例中，我将让备份在每天凌晨 1:00 进行。然后，单击“确定”按钮确认该计划。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/71488d0156ecbccfbeddcf70b840af0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LdjVXGzDfJlYal5EwLrc0g.png"/></div></div></figure><p id="a57f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可能还希望创建警报或通知，例如在作业失败时发送电子邮件。在这个实验中，我们将跳过这一步，因为并不总是需要。</p><p id="d5ef" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，与其等到明天凌晨 1 点，我想测试一下这个作业。我们可以右键单击我们创建的作业，然后选择“在第…步启动作业”来测试该作业。由于我们在此作业中只有 1 个步骤，它将直接启动并运行备份步骤。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/d19ce1c1fed7774da185a1a3e32c5795.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*1OldrCihLJP8gPiqIuln4Q.png"/></div></figure><p id="1127" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">过一会儿，作业就成功了，您也可以在备份目录中找到备份文件。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/8896a191779d956c50ba814b9750d42b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A6BMecYR-BZnTvPBEdA52g.png"/></div></div></figure><h1 id="988e" class="li lj jj bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">在 SQL-Server-Test 上还原备份</h1><p id="1f59" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">首先，我们通过 access <code class="fe le lf lg lh b">\\SQL-Server-Prod\backup\&lt;backup-file&gt;</code>来检查一下测试机上备份文件的可访问性。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/ccc94494ea5aca8dd0bdc445d62d8e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*8AxGPPv531I0iiBUCsafwA.png"/></div></figure><p id="58fc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个关键步骤是将远程备份文件夹装载到本地驱动器。这是因为 SQL Server Windows 服务通常是作为无权使用网络/远程资源的服务帐户运行的，因此远程资源对它是不可见的。</p><p id="8278" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">只需右键单击备份文件夹并选择“映射网络驱动器…”。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/dbae73c8b3977915a9da43c7a235e230.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*Mx7LFojSbgW8d1hTO7YsdA.png"/></div></figure><p id="2a1b" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们将它安装到测试机上的 Z: drive。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/0ed1c26be8270f409b95cafa4fe21e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*KiENzliQhmbRy7PNtXKgww.png"/></div></figure><p id="c2db" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们需要让 SQL Server 使用<code class="fe le lf lg lh b">xp_cmdshell</code>命令识别网络驱动器。默认情况下，这个命令是不启用的，所以我们需要启用它。打开一个新的查询表，并运行以下脚本来启用它。</p><pre class="mm mn mo mp gt nv lh nw nx aw ny bi"><span id="b411" class="mx lj jj lh b gy nz oa l ob oc">EXEC sp_configure 'show advanced options', 1;<br/>GO<br/>RECONFIGURE;<br/>GO<br/><br/>EXEC sp_configure 'xp_cmdshell',1<br/>GO<br/>RECONFIGURE<br/>GO</span></pre><p id="976c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，使用<code class="fe le lf lg lh b">xp_cmdshell</code>定义网络驱动器。您可以使用任何可以访问该网络驱动器的 Windows 用户。注意，您只需要运行这个命令一次，所以密码不会以明文格式保存在任何地方。</p><pre class="mm mn mo mp gt nv lh nw nx aw ny bi"><span id="2fb1" class="mx lj jj lh b gy nz oa l ob oc">EXEC XP_CMDSHELL 'net use Z: \\SQL-Server-Prod\backup &lt;password&gt; /USER:&lt;username&gt;'</span></pre><p id="4b51" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 result 面板中，您应该会看到输出，表明它是成功的。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/fd403b9ac01d3fdf513d62119b1b1a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*0Pw7uaiESy2NA7RZhhgJqQ.png"/></div></figure><p id="e424" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们也可以通过下面的脚本来测试它是否有效。</p><pre class="mm mn mo mp gt nv lh nw nx aw ny bi"><span id="cf75" class="mx lj jj lh b gy nz oa l ob oc">EXEC XP_CMDSHELL 'dir Z:'</span></pre><p id="bc11" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果可以，您应该会看到包含备份文件的文件列表。</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/daa787efef949252d7e444ceff4f8fa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*TZlIpEvMTeHaJJH1cSbbjA.png"/></div></figure><p id="0683" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，我们只需要创建另一个 SQL Server 代理作业，其中包含从所标识的网络驱动器还原数据库的步骤。该步骤的脚本如下:</p><pre class="mm mn mo mp gt nv lh nw nx aw ny bi"><span id="b64f" class="mx lj jj lh b gy nz oa l ob oc">DECLARE <a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a> varchar(255)<br/>DECLARE <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a> datetime</span><span id="f921" class="mx lj jj lh b gy od oa l ob oc">SELECT <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>=getdate()<br/>SELECT <a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a>='Z:\AdventureWorks2017-' + CAST(DATEPART(yyyy, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '-' + CAST(DATEPART(mm, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '-' +  CAST(DATEPART(dd, <a class="ae jg" href="http://twitter.com/date" rel="noopener ugc nofollow" target="_blank">@date</a>) as varchar) + '.bak'</span><span id="dede" class="mx lj jj lh b gy od oa l ob oc">RESTORE DATABASE AdventureWorks2017<br/>FROM DISK=<a class="ae jg" href="http://twitter.com/filename" rel="noopener ugc nofollow" target="_blank">@filename</a><br/>WITH REPLACE</span><span id="8804" class="mx lj jj lh b gy od oa l ob oc">GO</span></pre><p id="5d14" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，重复我们之前在生产计算机中所做的操作，右键单击代理作业并选择“在步骤启动作业”来测试作业。等待一段时间，直到恢复完成，右键单击“数据库”刷新数据库列表，你会看到恢复的数据库！</p><figure class="mm mn mo mp gt iv gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/4d790227664e950914645f1161312558.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/1*ro33-WZpUVx2qz01ddBgbA.png"/></div></figure><div class="is it gp gr iu op"><a href="https://medium.com/@qiuyujx/membership" rel="noopener follow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd jk gy z fp ou fr fs ov fu fw ji bi translated">通过我的推荐链接加入灵媒-陶</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">medium.com</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd ja op"/></div></div></a></div><p id="5da6" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你觉得我的文章有帮助，请考虑加入 Medium 会员来支持我和成千上万的其他作者！(点击上面的链接)</p><h1 id="62fd" class="li lj jj bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">资源</h1><p id="e07e" class="pw-post-body-paragraph kg kh jj ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">使网络路径对 SSMS 的 SQL Server 备份和恢复可见:<br/>T3】https://www . MSSQL tips . com/SQL Server tip/3499/make-Network-Path-Visible-For-SQL-Server-Backup-and-Restore-in-ssms/</p><p id="e78c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">BACKUP 语句(Transact-SQL，微软官方文档):<br/><a class="ae jg" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/backup-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">https://Docs . Microsoft . com/en-us/SQL/t-SQL/Statements/BACKUP-Transact-SQL？view=sql-server-ver15 </a></p><p id="bb7b" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">RESTORE 语句(Transact-SQL，微软官方文档):<br/><a class="ae jg" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/restore-statements-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">https://Docs . Microsoft . com/en-us/SQL/t-SQL/Statements/RESTORE-Statements-Transact-SQL？view=sql-server-ver15 </a></p></div></div>    
</body>
</html>