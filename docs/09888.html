<html>
<head>
<title>Deploy a Dockerized Flask App to Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Dockerized Flask 应用程序部署到 Google 云平台</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-a-dockerized-flask-app-to-google-cloud-platform-71d91b39b25e?source=collection_archive---------23-----------------------#2020-07-13">https://towardsdatascience.com/deploy-a-dockerized-flask-app-to-google-cloud-platform-71d91b39b25e?source=collection_archive---------23-----------------------#2020-07-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2b65" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">云部署</h2><div class=""/><div class=""><h2 id="b5a0" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用 Cloud Run 和 SQL 实例将 Dockerized Python 应用程序部署到 Google 云平台的简短指南。</h2></div><p id="d307" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">作者:<a class="ae ln" href="https://www.linkedin.com/in/edkrueger/" rel="noopener ugc nofollow" target="_blank">爱德华·克鲁格</a>和<a class="ae ln" href="https://www.linkedin.com/in/douglas-franklin-1a3a2aa3/" rel="noopener ugc nofollow" target="_blank">道格拉斯·富兰克林</a>。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/e58d9a55f26f9efc6d167027d3827f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hB_wxzyx4MWpUt1lhYyqCw.jpeg"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">照片由安德里亚斯·韦兰在 Unsplash 上拍摄</p></figure><p id="bca7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><em class="me">在本文中，我们将介绍如何使用 Pipfile.lock 将应用程序部署到云，并将应用程序连接到云数据库。有关虚拟环境的更多信息或开始使用环境和包管理器 Pipenv，请查看本文</em>  <em class="me">！</em></p><h2 id="a2a8" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">部署问题</h2><p id="03fe" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">由于缺乏对虚拟环境的了解或经验，新开发人员通常在系统级别安装所有东西。用 pip 安装的 Python 包放在系统级。以这种方式为每个项目检索需求会在您的机器上创建一个无法管理的全局 Python 环境。虚拟环境允许你划分你的软件，同时保持一个依赖清单。</p><p id="1a1d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">Pipenv 是一个用于虚拟环境和包管理的工具，它允许开发人员创建更容易部署、构建和修改的独立软件产品。</p><h2 id="81cd" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">Pipenv 是什么？</h2><p id="e37a" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">Pipenv 将软件包管理和虚拟环境控制结合到一个工具中，用于安装、删除、跟踪和记录您的依赖关系；以及创建、使用和管理您的虚拟环境。Pipenv 本质上是将 pip 和 virtualenv 包装在一个产品中。</p><p id="f09b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于应用程序部署，GCP 可以从 Pipfile 构建环境。当我们添加和删除依赖项时，Pipenv 将自动更新我们的 Pipfile。</p><h1 id="c848" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">Docker 和 docker 文件</h1><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nn"><img src="../Images/cc4d3f1c9b734fae82eb7bf8ecd25c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xjowdlr2ZUvz8gIY9c8MeQ.jpeg"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">卡梅伦·文蒂在 Unsplash 上拍摄的照片</p></figure><p id="f9a4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">Docker 是将应用程序投入生产的最佳方式。Docker 使用 docker 文件来构建容器。构建的容器存储在 Google Container Registry 中，在那里可以部署它。Docker 容器可以在本地构建，并将在任何运行 Docker <strong class="kt jd">的系统上运行。</strong></p><p id="d431" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">GCP 云构建允许您使用 docker 文件中包含的指令远程构建容器。远程构建很容易集成到 CI/CD 管道中。由于 Docker 使用大量 RAM，它们还节省了本地计算时间和能量。</p><p id="7126" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这是我们在这个项目中使用的 docker 文件:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="no np l"/></div><p class="ma mb gj gh gi mc md bd b be z dk translated">示例 Dockerfile 文件</p></figure><p id="1f96" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">每个 docker 文件的第一行都以<code class="fe nq nr ns nt b">FROM.</code>开始，这是我们导入操作系统或编程语言的地方。下一行以 ENV 开始，将我们的环境变量 ENV 设置为<code class="fe nq nr ns nt b">APP_HOME / app.</code></p><p id="ef4a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这些行是 Python 云平台结构的一部分，你可以在<a class="ae ln" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy#python" rel="noopener ugc nofollow" target="_blank"> <em class="me">文档</em> </a>中读到更多关于它们的内容。</p><p id="f893" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><code class="fe nq nr ns nt b">WORKDIR</code>行将我们的工作目录设置为<code class="fe nq nr ns nt b">/app</code>。然后，复制行使本地文件在 docker 容器中可用。</p><p id="a9cf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">接下来的三行涉及设置环境并在服务器上执行它。<code class="fe nq nr ns nt b">RUN</code>命令可以跟随着您想要执行的任何 bash 代码。我们使用<code class="fe nq nr ns nt b">RUN</code>来安装 pipenv。然后使用 pipenv 安装我们的依赖项。最后，<code class="fe nq nr ns nt b">CMD</code>行执行我们的 HTTP 服务器 gunicorn，将我们的容器绑定到<code class="fe nq nr ns nt b"> $PORT</code>，为端口分配一个 worker，指定该端口使用的线程数量，最后将应用程序的路径声明为<code class="fe nq nr ns nt b">app.main:app</code>。</p><p id="bd4c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">您可以添加一个<code class="fe nq nr ns nt b">.dockerignore</code>文件来从您的容器映像中排除文件。<code class="fe nq nr ns nt b">.dockerignore</code>用于将文件保存在容器之外。例如，您可能不希望在您的容器中包含您的测试套件。</p><p id="c70d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">要排除上传到云构建的文件，添加一个<code class="fe nq nr ns nt b">.gcloudignore </code>文件。由于 Cloud Build 将您的文件复制到云中，您可能希望忽略图像或数据以降低存储成本。</p><p id="ffbc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果你想使用这些，一定要查看<code class="fe nq nr ns nt b"><a class="ae ln" href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" rel="noopener ugc nofollow" target="_blank">.dockerignore</a></code>和<code class="fe nq nr ns nt b"><a class="ae ln" href="https://cloud.google.com/sdk/gcloud/reference/topic/gcloudignore" rel="noopener ugc nofollow" target="_blank"><strong class="kt jd">.gcloudignore</strong></a></code>文件的文档，但是，要知道模式和<code class="fe nq nr ns nt b">.gitignore</code>是一样的！</p><h1 id="f605" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">应用部署</h1><p id="2d8c" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">我们需要对我们的项目文件做一些最后的修改，为部署做准备。</p><p id="c27e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们需要将 gunicorn 和 Pymysql 添加到 Pipfile 中，如下所示。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="64e8" class="mf mg it nt b gy ny nz l oa ob">pipenv install gunicorn pymysql</span></pre><p id="a7dd" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">Git 将您之前创建的 Pipfile、Pipfile.lock 和 Dockerfile 添加到您的存储库中。</p><h2 id="5575" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">Docker 图像和 Google 容器注册表</h2><p id="7eb6" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">现在，一旦我们准备好 docker 文件，通过从包含 docker 文件的目录运行以下命令，使用云构建来构建您的容器映像:</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="4aee" class="mf mg it nt b gy ny nz l oa ob">gcloud builds submit --tag gcr.io/<strong class="nt jd">PROJECT-ID</strong>/<strong class="nt jd">container-name</strong></span></pre><p id="e719" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">注意:用您的 GCP 项目 ID 替换项目 ID，用您的容器名称替换容器名称。您可以通过运行命令<code class="fe nq nr ns nt b">gcloud config get-value project</code>查看您的项目 ID。</p><p id="4c7f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该 Docker 图像现在可在 GCP 集装箱注册处或 GCR 访问，并可通过云运行的 URL 访问。</p><h1 id="303c" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">使用 CLI 部署容器映像</h1><ol class=""><li id="c592" class="oc od it kt b ku mx kx my la oe le of li og lm oh oi oj ok bi translated">使用以下命令进行部署:</li></ol><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="9887" class="mf mg it nt b gy ny nz l oa ob">gcloud run deploy --image gcr.io/<strong class="nt jd">PROJECT-ID</strong>/<strong class="nt jd">container-name </strong>--platform managed</span></pre><p id="bb58" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">注意:用您的 GCP 项目 ID 替换项目 ID，用您的容器名称替换容器名称。您可以通过运行命令<code class="fe nq nr ns nt b">gcloud config get-value project</code>来查看您的项目 ID。</p><p id="8fac" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">2.将提示您输入服务名称和区域:选择您所选择的服务名称和区域。</p><p id="cd93" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">3.您将被提示<strong class="kt jd">允许未认证的调用</strong>:如果您想要公共访问，响应<code class="fe nq nr ns nt b">y</code>，并且<code class="fe nq nr ns nt b">n </code>限制对同一 google 项目中的资源的 IP 访问。</p><p id="3c3b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">4.稍等片刻，直到部署完成。如果成功，命令行会显示服务 URL。</p><p id="65b1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">5.通过在 web 浏览器中打开服务 URL 来访问您部署的容器。</p><h1 id="813c" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">使用 GUI 部署容器映像</h1><p id="fd16" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">现在我们已经在 GCR 存储了一个容器映像，我们已经准备好部署我们的应用程序了。访问<a class="ae ln" href="https://console.cloud.google.com/run?_ga=2.112811590.313737761.1591368161-572251819.1590763098&amp;amp;_gac=1.61558494.1591368161.CjwKCAjw2uf2BRBpEiwA31VZj5hm5tgEHH-Ldim6HaH954LjVPoeEdbL9XkMUnSw3yKCOv1UYdvGdRoCzasQAvD_BwE" rel="noopener ugc nofollow" target="_blank"> GCP 云运行</a>并点击创建服务，确保按要求设置计费。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ol"><img src="../Images/f8492c02ad7b5029ed1efa3b8741d2f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QDUw1jq6uEXHpwrPMfx46g.png"/></div></div></figure><p id="bd0c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">选择您想服务的地区，并指定一个唯一的服务名称。然后通过分别选择未经身份验证或经过身份验证，在对应用程序的公共访问和私有访问之间进行选择。</p><p id="4fec" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在我们使用上面的 GCR 容器图像 URL。将 URL 粘贴到空白处，或单击“选择”并使用下拉列表查找。检查高级设置以指定服务器硬件、容器端口和附加命令、最大请求数和扩展行为。</p><p id="334b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当您准备好构建和部署时，请单击创建！</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi om"><img src="../Images/312ea5a121f8d3576d3f1ae47a7bfe52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t35EDuM5CYDV08juWROsEQ.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">从 GCR 选择一个容器图像</p></figure><p id="4b52" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">您将进入 GCP 云运行服务详细信息页面，在此您可以管理服务、查看指标和构建日志。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi on"><img src="../Images/14000eeedc6498283335dc216927f5b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1-aORDbSdoze6qkxY4vDbg.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">服务详情</p></figure><p id="c0ca" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">单击 URL 查看您部署的应用程序！</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi oo"><img src="../Images/ca25c22fded8781105a20d3deba15d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Q16ceMGqg1OQgaUKZ4nPA.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">呜哇！</p></figure><p id="d640" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">恭喜你！您刚刚将打包在容器映像中的应用程序部署到云运行。Cloud Run 自动并水平地扩展您的容器映像以处理收到的请求，然后在需求减少时缩小规模。您只需为请求处理过程中消耗的 CPU、内存和网络资源付费。</p><p id="9ece" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">也就是说，当你不想付费时，一定要关闭你的服务！</p><h1 id="7c9a" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">GCP 数据库的建立和部署</h1><p id="b3ae" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">转到<a class="ae ln" href="https://console.cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">云控制台</a>并设置计费(如果您还没有设置的话)。现在您可以创建一个 SQL 实例。</p><p id="c4e3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">选择您想要使用的 SQL 方言，我们正在使用 MySQL。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi op"><img src="../Images/d3b2d52873a43aa2c76689731a7a289b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hr5djT-voforOm1WoFSwdQ.png"/></div></div></figure><p id="2bac" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">设置实例 ID、密码和位置。</p><h2 id="aea0" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">将 MySQL 实例连接到您的云运行服务</h2><p id="4592" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">与任何配置更改一样，设置新的云 SQL 连接会导致创建新的云运行版本。要将云服务连接到云数据库实例:</p><ol class=""><li id="d965" class="oc od it kt b ku kv kx ky la oq le or li os lm oh oi oj ok bi translated"><a class="ae ln" href="https://console.cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">去云茹</a> n</li><li id="45d1" class="oc od it kt b ku ot kx ou la ov le ow li ox lm oh oi oj ok bi translated">配置服务:</li></ol><p id="0e06" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果您正在<strong class="kt jd">向新服务</strong>添加云 SQL 连接:</p><ul class=""><li id="9dde" class="oc od it kt b ku kv kx ky la oq le or li os lm oy oi oj ok bi translated">您需要将您的服务容器化并上传到容器注册中心。</li><li id="be39" class="oc od it kt b ku ot kx ou la ov le ow li ox lm oy oi oj ok bi translated">点击<strong class="kt jd">创建服务</strong>。</li></ul><p id="d276" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果您正在<strong class="kt jd">向现有服务添加云 SQL 连接</strong>:</p><ul class=""><li id="cfc8" class="oc od it kt b ku kv kx ky la oq le or li os lm oy oi oj ok bi translated">单击服务名称。</li><li id="d715" class="oc od it kt b ku ot kx ou la ov le ow li ox lm oy oi oj ok bi translated">点击<strong class="kt jd">部署新版本</strong>。</li></ul><p id="04f2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">3.启用连接到云 SQL:</p><ul class=""><li id="95e0" class="oc od it kt b ku kv kx ky la oq le or li os lm oy oi oj ok bi translated">点击<strong class="kt jd">显示可选设置</strong>:</li></ul><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/731320672b3928c5d6b2ee642d3b705e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*QRBv8O62FhRBzAT_.png"/></div></figure><ul class=""><li id="f8bd" class="oc od it kt b ku kv kx ky la oq le or li os lm oy oi oj ok bi translated">如果要在项目中添加云 SQL 实例的连接，单击<strong class="kt jd">添加连接</strong>后，从下拉菜单中选择所需的云 SQL 实例。</li><li id="819a" class="oc od it kt b ku ot kx ou la ov le ow li ox lm oy oi oj ok bi translated">如果您正在使用来自另一个项目的云 SQL 实例，请在下拉列表中选择<strong class="kt jd">连接字符串</strong>，然后以 PROJECT-ID:REGION:INSTANCE-ID 格式输入完整的实例连接名称。</li></ul><p id="2211" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">4.点击<strong class="kt jd">创建</strong>或<strong class="kt jd">部署</strong>。</p><p id="6fcb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">无论哪种情况，我们都希望我们的连接字符串看起来像下面这样。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="4405" class="mf mg it nt b gy ny nz l oa ob">mysql://ael7qci22z1qwer:nn9keetiyertrwdf@c584asdfgjnm02sk.cbetxkdfhwsb.us-east-1.rds.gcp.com:3306/fq14casdf1rb3y3n</span></pre><p id="5c29" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们需要对 DB 连接字符串进行更改，以便它使用 Pymysql 驱动程序。</p><p id="f5d0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在文本编辑器中，删除<code class="fe nq nr ns nt b">mysql</code>并在它的位置添加<code class="fe nq nr ns nt b">mysql+pymysql</code>，然后将更新后的字符串保存为您的 SQL 连接。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="0acd" class="mf mg it nt b gy ny nz l oa ob">mysql+pymysql<!-- -->://ael7qci22z1qwer:nn9keetiyertrwdf@c584asdfgjnm02sk.cbetxkdfhwsb.us-east-1.rds.gcp.com:3306/fq14casdf1rb3y3n</span></pre><p id="972b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请注意，您不必使用 GCP 的 SQL。如果使用的是第三方数据库，可以将连接字符串作为 VAR 而不是 Cloud SQL 添加，并输入您的连接字符串。</p><h2 id="893a" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">隐藏连接字符串。包封/包围（动词 envelop 的简写）</h2><p id="3b84" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">在本地创建一个名为<code class="fe nq nr ns nt b">.env</code>的新文件，并为您的云数据库添加如下所示的<code class="fe nq nr ns nt b">DB_CONN,</code>连接字符串。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="d996" class="mf mg it nt b gy ny nz l oa ob">DB_CONN=”mysql+pymysql://root:PASSWORD@HOSTNAME:3306/records_db”</span></pre><p id="6640" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">注意:运行<code class="fe nq nr ns nt b">pipenv shell</code>可以让我们接触到这些隐藏的环境变量。同样，我们可以用 os 访问 Python 中的隐藏变量。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="c251" class="mf mg it nt b gy ny nz l oa ob">MySQL_DB_CONN = os.getenv(“DB_CONN”)</span></pre><p id="2696" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">确保将上面的行添加到您的 database.py 文件中，以便它准备好连接到云！</p><p id="a0ac" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这个。env 文件现在包含敏感信息，应该被添加到您的<code class="fe nq nr ns nt b">.gitignore</code>中，这样它就不会出现在公开可见的地方。</p><p id="4805" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">既然我们的应用程序和数据库都在云中，让我们确保我们的系统正常工作。</p><h2 id="c001" class="mf mg it bd mh mi mj dn mk ml mm dp mn la mo mp mq le mr ms mt li mu mv mw iz bi translated">正在加载数据库</h2><p id="816e" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">一旦可以看到 GCP 上列出的数据库，就可以用加载脚本加载数据库了。以下要点包括我们的 load.py 脚本。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="no np l"/></div><p class="ma mb gj gh gi mc md bd b be z dk translated">load.py</p></figure><p id="36d0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们运行这个加载脚本，看看我们是否可以发送到我们的数据库。</p><p id="ff35" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，运行以下代码进入您的虚拟环境。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="0eba" class="mf mg it nt b gy ny nz l oa ob">pipenv shell</span></pre><p id="3ef7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">然后运行 load.py 脚本。</p><pre class="lp lq lr ls gt nu nt nv nw aw nx bi"><span id="ee87" class="mf mg it nt b gy ny nz l oa ob">python load.py</span></pre><p id="13cc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">访问远程应用程序地址，查看您的数据是否已添加到云数据库。如果您遇到任何问题，请务必检查您的构建日志以查找回溯！</p><p id="799a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">关于这个加载过程或以模块化方式设置你的应用程序的更多说明，请访问我们的<a class="ae ln" rel="noopener" target="_blank" href="/fastapi-cloud-database-loading-with-python-1f531f1d438a">Medium guide to building a data API</a>！那篇文章详细解释了上面的代码。</p><h1 id="4019" class="nc mg it bd mh nd ne nf mk ng nh ni mn ki nj kj mq kl nk km mt ko nl kp mw nm bi translated">结论</h1><p id="6819" class="pw-post-body-paragraph kr ks it kt b ku mx kd kw kx my kg kz la mz lc ld le na lg lh li nb lk ll lm im bi translated">在本文中，我们学习了一些关于使用 pipenv 进行环境管理以及如何对应用程序进行 Dockerize 的知识。然后，我们介绍了如何在 Google 容器注册表中存储 Docker 容器，并使用云构建 CLI 和 GUI 部署容器。接下来，我们建立了一个云 SQL 数据库，并将其连接到我们的应用程序。最后，我们讨论了一种装载数据库的方法，在本地运行 load.py。请注意，如果您的应用程序本身收集数据，您只需要部署应用程序和数据库，然后部署的应用程序将在收集数据时填充数据库。</p><p id="fd47" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这里有一个到<a class="ae ln" href="https://github.com/edkrueger/sars-fastapi" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>的链接，里面有我们这个项目的代码。请务必查看这段代码，看看我们是如何设置整个代码库的！</p></div></div>    
</body>
</html>