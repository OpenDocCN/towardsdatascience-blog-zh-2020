<html>
<head>
<title>Are Your AWS S3 Buckets Secure ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的 AWS S3 铲斗安全吗？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/are-your-aws-s3-buckets-secure-5cc07f63788?source=collection_archive---------50-----------------------#2020-05-22">https://towardsdatascience.com/are-your-aws-s3-buckets-secure-5cc07f63788?source=collection_archive---------50-----------------------#2020-05-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="6539" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">自动警报系统</h2><div class=""/><div class=""><h2 id="4b1f" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">学习释放 IAM 政策的全部潜力，并开始利用'<em class="kr">条件'</em>政策元素</h2></div><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/52660434fadc3beddd5f044ba38e809a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3MxP2HBeglCk--kbnyBXpQ.jpeg"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">由<a class="ae li" href="https://unsplash.com/@chrispanas?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">克里斯·帕纳斯</a>在<a class="ae li" href="https://unsplash.com/s/photos/security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="6cec" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi mf translated"><span class="l mg mh mi bm mj mk ml mm mn di"/>定义 IAM 安全策略的一个重要方面是减少爆炸半径，这是人们经常忽略的，这实际上意味着，在访问泄漏的情况下，如何进一步减少/消除损害。从这个角度来看安全定义通常可以帮助您考虑其他因素，以便在发生安全违规时限制损害。</p><p id="7cf3" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">安全性通常归结为两件事:身份验证和授权。认证定义<em class="mo">你是谁</em>，授权定义<em class="mo">你能做什么(认证后)。</em>在使用 AWS 云时，IAM(身份和访问管理)扮演把关者的角色，从而负责我们讨论的两个方面。<em class="mo"> IAM 策略</em>管理<em class="mo">授权</em>部分，对于限制用户可以/不可以做什么非常重要。</p></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><p id="0634" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在这篇文章中，我想讨论当你给别人访问你的 AWS 资源时，你应该考虑的最基本的步骤。让我们用最常用的 AWS 服务 S3 来定义一个示例问题陈述</p><blockquote class="mw mx my"><p id="8a5e" class="lj lk mo ll b lm ln kd lo lp lq kg lr mz lt lu lv na lx ly lz nb mb mc md me im bi translated">在 EC2 实例中运行某些工作流的不同 AWS 帐户的用户需要在特定的日期和时间间隔内访问您的 S3 对象。访问被进一步限制为列出具有特定前缀的文件，并且只下载具有相关联的特定标签的文件。流量也应该来自白名单网络</p></blockquote><p id="08e5" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">首先，将 S3 桶和与对象相关的权限分离到不同的部分通常是一个好的做法。AWS 在政策文件中将它们称为<strong class="ll jd">声明</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nc"><img src="../Images/0ac42ef866646d0bcab4855668180701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VYhLQFAExiyGaTfRJ_WG5A.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">基本 IAM 策略框架</p></figure><h1 id="7b1f" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">谁需要访问权限？</h1><p id="6743" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">或者用 AWS 的术语来说，谁是<strong class="ll jd"><em class="mo"/></strong><em class="mo">的主要负责人。</em>作为最佳实践，让我们假设没有访问键被提供和注入到消费者 EC2 实例中。相反，有一个 IAM 角色将被<em class="mo">承担</em>以访问 S3 资源。要定义主体，您可以扩展策略模板，如下所示:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/ba73cfa9a10f6fc89f83ac05bf961b82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AqPyypmyZrKOt_AV-ehSKQ.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—具有主体(请求资源的实体)</p></figure><p id="292e" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">此时，像 EC2 这样映射到 IAM 角色<code class="fe ob oc od oe b">arn:aws:iam::&lt;requester_account_id&gt;:roleaccess-s3-objects</code>的服务可以从位于<a class="ae li" href="http://169.254.169.254." rel="noopener ugc nofollow" target="_blank"> http://169.254.169.254 的实例元数据端点获取动态临时凭证。这是由官方 SDK 和 CLI 自动处理的，所以用户不必担心。</a></p><h1 id="aace" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated"><strong class="ak">需要访问什么？</strong></h1><p id="45e9" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">上面的问题陈述提到了需要从不同的帐户访问的 S3 存储桶。这成为 IAM 策略中的<strong class="ll jd">资源</strong>元素。让我们假设私有桶的名称为<code class="fe ob oc od oe b">my-test-bucket</code></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/c68ff2fc59039139f6d81046498c4bb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s8uWOx0YVEL39MkZFqu6IQ.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—需要访问的资源</p></figure><p id="5c91" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">对于不同的部分，您可以适当地定义资源元素。首先指整个桶，其次指桶内的物体</p><h1 id="d3bc" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">在 S3 存储桶上应该允许哪些操作？</h1><p id="bf80" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">这由 IAM 策略结构中的<strong class="ll jd">动作</strong>元素定义。在这里遵循最小特权原则非常重要，要不惜一切代价避免类似<code class="fe ob oc od oe b">s3:*</code>的事情发生。此外，可以使用<a class="ae li" href="https://policysim.aws.amazon.com/home/index.jsp?#" rel="noopener ugc nofollow" target="_blank"> AWS 策略模拟器</a>进行简单的测试，以满足模拟/调试需求。</p><p id="6de2" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">对于这个场景，用户只需要拥有<code class="fe ob oc od oe b">s3:List ucketVersions</code>、<code class="fe ob oc od oe b">s3:ListBucket</code>和<code class="fe ob oc od oe b">s3:GetObject</code>三个基本权限</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/1f7e5e544291e531d76b68e1b783133d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HspQs5fO5N3jYXGM2pudlA.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—允许其他 AWS 帐户执行的操作</p></figure><h1 id="d1a2" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">应该在哪个日期间隔内允许访问？</h1><p id="b8ab" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">输入<a class="ae li" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ll jd">条件</strong> </a></p><p id="1bc6" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">条件给 IAM 政策注入了兴奋剂。您现在可以开始使用他们允许您实施的粒度控制。在这个例子中，假设您只想允许<code class="fe ob oc od oe b">2020-04-01T00:00:00Z</code>和<code class="fe ob oc od oe b">2020-05-30T23:59:59Z</code>之间的请求。你可以使用任何 ISO 8601 格式来定义这些时间线。条件键有两种风格:全局的和特定于服务的。介绍完这些之后，IAM 策略看起来像:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/b63ecc91985d7bc219064643e3d125cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TnWScluHOlWe3cCDuO7aEQ.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—允许在特定时间间隔内进行访问</p></figure><p id="71f4" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">如果您希望允许临时访问在预定义时间自动过期的外部实体，这将非常有用。</p><h1 id="a2b0" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">不仅仅是日期，您还希望只允许来自特定网络流量</h1><p id="af79" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">让我们假设输出 NAT 网关，或实例公共 IP 是<code class="fe ob oc od oe b">13.126.87.165</code>。您可以限制仅来自此来源的流量。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/3df5a4fbf1230d4b4ac4dfe778c7a621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qB9Vi5qZ_8NmCIx7Z4FAGA.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—仅允许来自特定网络的入口</p></figure><h1 id="c6d2" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">限制对数据子集的访问</h1><p id="5eb0" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">如问题陈述中所述，您还希望控制资源访问，这应该仅限于 bucket 中的一些前缀。使用这种方法，您可以限制不同用户看到的内容，以及他们可以从该集中进一步下载的内容。假设您只想限制列出带有前缀<code class="fe ob oc od oe b">test/</code>和<code class="fe ob oc od oe b">test/sample-folder</code>的文件夹的能力</p><p id="3e67" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">此外，用户应该只能下载带有标签<code class="fe ob oc od oe b">available:yes</code>的对象</p><p id="025a" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这可以通过其他有趣的条件键来实现:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oa"><img src="../Images/e9a17b746dc79e6eb8ee8c12a4ad6450.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y4yBdMibg96UiL9Vb8oK0A.png"/></div></div><p class="le lf gj gh gi lg lh bd b be z dk translated">IAM 策略—标签和文件夹前缀条件</p></figure><p id="1874" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这里需要注意的是，web 控制台中的 S3 看起来像一个典型的目录结构。然而，在内部，它只是名称前缀，您可以使用它来引用单个对象。</p><p id="0b81" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">完整的 IAM 政策要点可以在<a class="ae li" href="https://gist.github.com/akskap/3ccdae007c2c4c9de063c422aa61d96f" rel="noopener ugc nofollow" target="_blank">这里</a>找到，如果你想复制或编辑的话。</p><h1 id="1d13" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">结论和进一步阅读</h1><p id="db8a" class="pw-post-body-paragraph lj lk it ll b lm nv kd lo lp nw kg lr ls nx lu lv lw ny ly lz ma nz mc md me im bi translated">在这一点上，我相信即使您丢失了访问密钥，您也不会感到害怕，因为粒度策略定义的深度使得黑客在访问您的机密数据之前很难勾选所有的框。</p><h2 id="a32d" class="of ne it bd nf og oh dn nj oi oj dp nn ls ok ol np lw om on nr ma oo op nt iz bi translated">注意事项</h2><ul class=""><li id="d013" class="oq or it ll b lm nv lp nw ls os lw ot ma ou me ov ow ox oy bi translated">无论是全局的还是特定于服务的，并不是所有的条件关键字都会一直存在。记得检查哪些 S3 选项支持哪些条件键。</li><li id="b35f" class="oq or it ll b lm oz lp pa ls pb lw pc ma pd me ov ow ox oy bi translated">当涉及到安全性时，考虑使用策略边界。它们定义了最大权限区域，您自己帐户中的用户可以将其权限提升到。</li><li id="7321" class="oq or it ll b lm oz lp pa ls pb lw pc ma pd me ov ow ox oy bi translated">为了更加清晰，将对象和存储桶级别的权限分开</li><li id="d1b5" class="oq or it ll b lm oz lp pa ls pb lw pc ma pd me ov ow ox oy bi translated">如果你也对 EC2 使用的其他安全实践感兴趣，或者有效地管理你的密码，请随意查看我的其他帖子</li></ul><p id="ad79" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我希望这篇文章能帮助你下次定义更安全的 IAM 策略。如果能听到您的评论和您已经完成的其他用例，那就太好了。</p><p id="30ca" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">下次见，<em class="mo"> tschüss </em>！</p></div></div>    
</body>
</html>