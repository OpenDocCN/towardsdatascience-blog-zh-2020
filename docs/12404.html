<html>
<head>
<title>How to: Build an Immersive Geo Bubble Map with Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:使用 Plotly 构建身临其境的地理气泡图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-an-immersive-geo-bubble-map-with-plotly-bb20eb70414f?source=collection_archive---------24-----------------------#2020-08-26">https://towardsdatascience.com/how-to-build-an-immersive-geo-bubble-map-with-plotly-bb20eb70414f?source=collection_archive---------24-----------------------#2020-08-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bb2b2080226ff312d89f071b721d952c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*n6GaAZB1lbiFJpDSxO9eUQ.gif"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">gif 由你真诚地</p></figure><p id="ce33" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本教程中，我将使用 Plotly 创建得克萨斯州新冠肺炎案例的县级地理气泡图。以上 gif 中的情节可以在我的<a class="ae la" href="http://tsbloxsom.pythonanywhere.com/" rel="noopener ugc nofollow" target="_blank">网站</a>底部找到。我的网站最好用笔记本电脑而不是移动设备访问。我还制作了另一个教程，讲述我如何使用 dash <a class="ae la" rel="noopener" target="_blank" href="/creating-and-automating-an-interactive-dashboard-using-python-5d9dfa170206">在这里</a>创建另一个交互式 plotly 图形和网站。我用来创建这张地图的所有代码和数据都可以在我的<a class="ae la" href="https://github.com/tsbloxsom/Texas-census-county-data-project/tree/master/county%20map%20notebooks%20and%20data" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。<a class="ae la" href="https://github.com/tsbloxsom/Texas-census-county-data-project/blob/master/county%20map%20notebooks%20and%20data/medium_tutorial_for_geo_map.ipynb" rel="noopener ugc nofollow" target="_blank">。ipynb </a>文件包含了所有的代码和图形，但是您必须拥有所有的。csv 和。下载 xlsx 文件，自行创建图形以及相关的 plotly 库。我将假设你有一些关于 python、熊猫和 plotly 的知识。让我们回顾一下我创建这张漂亮地图的步骤:</p><ol class=""><li id="c256" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">加载数据并用熊猫清理数据</li><li id="fca4" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">将相关数据框合并在一起并清理</li><li id="3dfd" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">用 groupby()格式化要输入到 plotly 图形中的数据</li><li id="cbea" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">使用 plotly.express.chorograph()和 plotly.graph_objects 创建图形。散点图()</li></ol><p id="a9cc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">关于代码片段需要注意的一点是，在运行代码之前，您可能需要更改数据文件所在的目录。好了，我们开始吧！</p><ol class=""><li id="fc82" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated"><strong class="ke ir">加载数据，并使用熊猫清理数据</strong></li></ol><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="02d3" class="ly lz iq lu b gy ma mb l mc md">import pandas as pd<br/>import plotly.express as px<br/>from urllib.request import urlopen<br/>import json<br/>import plotly.graph_objects as go</span><span id="bda8" class="ly lz iq lu b gy me mb l mc md"># read in data<br/>fips_data = pd.read_excel("PHR_MSA_County_masterlist.xlsx", dtype={'FIPS #': str}) #need this to plot counties on map, source: <a class="ae la" href="https://www.dshs.texas.gov/chs/info/info_txco.shtm" rel="noopener ugc nofollow" target="_blank">https://www.dshs.texas.gov/chs/info/info_txco.shtm</a><br/>fips_df = fips_data[["County Name", "FIPS #"]]</span><span id="02f5" class="ly lz iq lu b gy me mb l mc md">#add 48 to end of each county fips so it can be input into plotly to geo graph data<br/>def add_48(s):<br/>    return "48" + str(s)<br/>fips_df["FIPS #"] = fips_df["FIPS #"].map(add_48)</span><span id="102e" class="ly lz iq lu b gy me mb l mc md">cities_df = pd.read_csv("uscities.csv") #need for plotting texas cities, source: <a class="ae la" href="https://simplemaps.com/data/us-cities" rel="noopener ugc nofollow" target="_blank">https://simplemaps.com/data/us-cities</a></span><span id="0379" class="ly lz iq lu b gy me mb l mc md"># for plotting major texas cities<br/>mask = cities_df["state_id"] == "TX"<br/>texas_cities = cities_df[mask]<br/>mask2 = texas_cities["population"] &gt; 200000<br/>big_texas_cities = texas_cities[mask2]<br/>cities_for_map = big_texas_cities[["city", "lat", "lng"]]</span><span id="9021" class="ly lz iq lu b gy me mb l mc md"># load in additional data with long and lat of each county as well as covid-19 case counts for new bubble graph<br/>ts_df = pd.read_csv("time_series_plotly.csv").drop("Unnamed: 0", axis = 1) # I created this data from a previous medium post<br/>county_loc = pd.read_csv("Texas_Counties_Centroid_Map.csv") #source: <a class="ae la" href="https://data.texas.gov/dataset/Texas-Counties-Centroid-Map/ups3-9e8m/data" rel="noopener ugc nofollow" target="_blank">https://data.texas.gov/dataset/Texas-Counties-Centroid-Map/ups3-9e8m/data</a></span></pre><p id="5d53" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第 1 步非常简单明了，但如果能看到我加载的所有 4 个数据框是什么样子就更好了。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/4a0650cc9e93f0d674eb51451a391cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vQCmc4SMyU_2_Q5A8zKKpQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/54aade498a51d3daff25c2df1c1335b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MXGtDkCmKh1-vV1io8DIiw.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/10af1dcb5342e3da59dfa280257f228a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0C6NRPa3Iyh6lazQd-4uw.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><p id="313e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">fips_df 仅包含德克萨斯州每个县的所有 fips 代码，可以使用 plotly 绘制每个县的图形。ts_df 是一个长格式的数据帧，包含自 3 月以来每个县每天的所有新冠肺炎病例计数。county_loc 具有每个县的经度和纬度，但是它们是颠倒的:Y (Long)列具有纬度而不是县的经度，这在绘图时很容易解决。city _ for _ map 具有德克萨斯州人口超过 200，000 的城市的经度和纬度数据。</p><p id="2a1e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 2。将相关数据帧合并在一起并清理</strong></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="d858" class="ly lz iq lu b gy ma mb l mc md">#merge covid-19 case counts with county longitude and latitude data<br/>ts_df2 = ts_df.merge(county_loc, how = "left", left_on = "County", right_on = "CNTY_NM")</span><span id="8fec" class="ly lz iq lu b gy me mb l mc md">#merge above df with fips data<br/>ts_df3 = ts_df2.merge(fips_df,how = "left", left_on = "County", right_on = "County Name")<br/>def extract_month(s):<br/>    return s[5:7]<br/>ts_df3["month"] = ts_df3["Date"].map(extract_month)</span><span id="6014" class="ly lz iq lu b gy me mb l mc md"># only extract last 4 months of data<br/>mask = ts_df3["month"].astype(int) &gt; 4<br/>ts_df4 = ts_df3[mask]</span></pre><p id="84e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">关于上面的代码，需要注意一些事情:</p><ol class=""><li id="9920" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">我使用县名作为主键/外键来合并所有三个数据框</li><li id="fd0b" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">我也不必合并 fips_df，但是在使用 county_loc 数据框 fips 列来绘制图表时遇到了问题。</li><li id="35c4" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">我将只使用最近 4 个月的数据，因为这是最重要的</li></ol><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/6b52916656e81deb1b6f83f3070a4c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZNoSLPdW0lEjU_SfW1lHEQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><p id="6b73" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，现在数据中每天都有一行，得克萨斯州每个县在过去 4 个月都有新冠肺炎病例计数。</p><p id="7949" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 3。用 groupby() </strong>格式化要输入到 plotly 图形中的数据</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e997" class="ly lz iq lu b gy ma mb l mc md">df = (ts_df4.groupby(["month", "County", "X (Lat)", "Y (Long)", "FIPS #"])["Case Count"].max()).reset_index()</span><span id="d62a" class="ly lz iq lu b gy me mb l mc md">df["month"] = df["month"].astype(int)</span></pre><p id="2052" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">好了，这就是事情变得有点复杂的地方。我需要按月、县、经度、纬度和 FIPS 分组，然后获得最大案例数。这将为我提供一个数据框，其中包含每个县每个月的总病例数。数据框如下所示。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/b472a68066ea034b78adbfc22fb625f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V0Y1jshvYBBX_zrLLDzkpA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><p id="b4ef" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 4。使用 plotly.express.chorograph()和 plotly.graph_objects 创建图形。散射地理()</strong></p><p id="f01b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个图表的绘制需要大量的编码和理解，所以我将分块进行。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="5178" class="ly lz iq lu b gy ma mb l mc md">with urlopen('<a class="ae la" href="https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'</a>) as response:<br/>    counties = json.load(response)</span><span id="81f8" class="ly lz iq lu b gy me mb l mc md">fig = px.choropleth(df, geojson=counties, locations='FIPS #',<br/>                           hover_name = "County",<br/>                           scope = "usa",<br/>                           title = "Total Cases"<br/>                          )</span></pre><p id="8756" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">首先，我们将从绘制德克萨斯州所有县地图的基础数据开始。为此，我们使用 plotly.express.chorograph()函数并输入我们刚刚创建的数据框。然后指定我们希望使用 geojson 库来映射使用 df 中的 FIPS #列的县。Plotly 有关于这个<a class="ae la" href="https://plotly.com/python/choropleth-maps/" rel="noopener ugc nofollow" target="_blank">的很棒的文档。如果我们只是用 fig.show()绘制它，它看起来会像下面的图像。</a></p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/3e2143dbcf8f8a1911667f7d4bd1e6f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQx1YfSztSf4W0c7_FHygw.png"/></div></div></figure><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c0db" class="ly lz iq lu b gy ma mb l mc md">colors = ['rgb(189,215,231)','rgb(107,174,214)','rgb(33,113,181)','rgb(239,243,255)']<br/>months = {5: 'May', 6:'June',7:'July',8:'Aug'}<br/></span><span id="38cf" class="ly lz iq lu b gy me mb l mc md">#plot the bubble cases for each month and each county<br/>for i in range(5,9)[::-1]:<br/>    mask = df["month"] == i<br/>    df_month = df[mask]<br/>    #print(df_month)<br/>    fig.add_trace(go.Scattergeo(<br/>            locationmode = 'USA-states',<br/>            lon = df_month['X (Lat)'],<br/>            lat = df_month['Y (Long)'],<br/>            text = df_month[['County','Case Count']],<br/>            name = months[i],<br/>            mode = 'markers',<br/>            marker = dict(<br/>                size = df_month['Case Count'],<br/>                color = colors[i-6],<br/>                line_width = 0,<br/>                sizeref = 9,<br/>                sizemode = "area",<br/>                reversescale = True<br/>            )))</span></pre><p id="dc56" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">好了，最难的部分来了。首先，我们创建一个颜色列表，其中包含每个月要使用的颜色。我们还为图表的图例创建了一个月份字典。</p><p id="69ef" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来是 for 循环，每个月循环 4 次。对于每个月，它使用 plotly.graph_objects 根据位置为每个县绘制一个气泡图。Scattergeo()函数。您会注意到 lon 和 lat 变量被交换了，但那是因为我导入的数据有这个问题。我使用变量 sizeref 来归一化气泡点，因为有些县的案例数非常大，如果不进行归一化，这些案例数将在地图上占主导地位。Plotly 建议使用 sizeref:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="04b3" class="ly lz iq lu b gy ma mb l mc md">sizeref = 2. * max(array of size values) / (desired maximum marker size ** 2)</span></pre><p id="f300" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">但是我发现这个函数并不好用，他们甚至没有在他们的文档示例中使用它。我发现 9 最适合我，但数字非常敏感，我尝试了 0-10 的范围，在选择 9 之前，许多数字使图不可读。以下是当前形式的图:</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/66ed91cdf1d6e1fbb7f362ffcee2b2e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bxnh34Pmep_GOx49alkdFQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">真实的你的形象</p></figure><p id="2307" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以我们离最终产品越来越近了，但是我们还需要一些东西。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="3c71" class="ly lz iq lu b gy ma mb l mc md"># to show texas cities on map<br/>fig.add_trace(go.Scattergeo(<br/>    locationmode = 'USA-states',<br/>    lon = cities_for_map['lng'],<br/>    lat = cities_for_map['lat'],<br/>    hoverinfo = 'text',<br/>    text = cities_for_map['city'],<br/>    name = "Major Cities",<br/>    mode = 'markers',<br/>    marker = dict(<br/>        size = 4,<br/>        color = 'rgb(102,102,102)',<br/>        line = dict(<br/>            width = 3,<br/>            color = 'rgba(68, 68, 68, 0)'<br/>        )<br/>    )))</span><span id="c39e" class="ly lz iq lu b gy me mb l mc md">fig.update_geos(fitbounds="locations")<br/>fig.update_layout(title_text='Total Cases per month for last 4 months', title_x=0.5)<br/>fig.show()</span></pre><p id="084f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的代码块中，我们使用经度/纬度数据和 plotly.graph_objects 绘制了德克萨斯州的主要城市。Scattergeo()函数，但没有 for 循环。然后我们更新图表的方向，这样德克萨斯州就很好地适合图表的框架。然后我们更新图表的标题并使其居中。最后，我们可以可视化它的完整形式！</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/0110041ef703f883645edbb520cd8a5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knZz68PKYBrmqfG9SC3MVA.png"/></div></div></figure><p id="1e7a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">感谢阅读并可能跟随我的教程！如果你想在 medium 或 LinkedIn 上关注我，请随意。我也一直在寻找对我的帖子和编码的反馈，所以如果你有任何给我，我会非常感谢。</p></div></div>    
</body>
</html>