<html>
<head>
<title>Customizable correlation heatmaps in R using purrr and ggplot2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 purrr 和 ggplot2 可定制 R 中的关联热图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/customizable-correlation-plots-in-r-b1d2856a4b05?source=collection_archive---------6-----------------------#2020-03-15">https://towardsdatascience.com/customizable-correlation-plots-in-r-b1d2856a4b05?source=collection_archive---------6-----------------------#2020-03-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5b6c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">不用任何相关绘图包制作高质量的相关图</em></h2></div><p id="4e9c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果你曾经觉得被<code class="fe lc ld le lf b">R</code>中的关联热图包所限制，这篇文章将向你展示如何编写你自己的函数来将众多的关联整理成一个<code class="fe lc ld le lf b">ggplot2</code>友好的绘图形式。</p><p id="6ece" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最后，您将能够运行一个函数来获得一个整理好的相关性数据框架。然后，您可以在这个数据框上运行<code class="fe lc ld le lf b">ggplot2</code>代码来制作您自己的关联热图。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/9a8cf5723350a751c0be95bed4a5c9e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7Z6v50krMb8kcyLg.png"/></div></div></figure><p id="1ec2" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果你只是想要代码，你可以跳到最后。你也可以在我的网站上阅读我的其他博客文章，<a class="ae ls" href="http://www.khstats.com/blog" rel="noopener ugc nofollow" target="_blank"> KHstats </a>。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="142d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我真的很感激一些允许我使用<code class="fe lc ld le lf b">R</code>超快速地制作相关图的包和函数。这里有几个例子:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="c249" class="me mf iq lf b gy mg mh l mi mj">corrplot::corrplot(cor(mtcars))</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/c9336c4ca446b35bd0371e041070a2e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rjEZwxb_adRNgzFv.png"/></div></div></figure><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="b0c9" class="me mf iq lf b gy mg mh l mi mj">corrgram::corrgram(mtcars)</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/cc60209cff87014cd4d169343baa15de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lo1AwfSY1W8xlV9U.png"/></div></div></figure><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="3f82" class="me mf iq lf b gy mg mh l mi mj">ggcorrplot::ggcorrplot(cor(mtcars))</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/8ecd89725937818c084315ecbd3746da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sgNi-g9RWNk_H-cR.png"/></div></div></figure><p id="ac02" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">所有这些都很好，但没有一个最终能像我需要的那样可定制。接下来我将展示如何绕过使用其他人的函数约束，以一种<code class="fe lc ld le lf b">ggplot2</code>友好的格式在数据中准备相关性。</p><p id="26ca" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以使用基本的<code class="fe lc ld le lf b">R</code>函数<code class="fe lc ld le lf b">cor()</code>来得到我们的相关性，但是我不喜欢缺省的数据。相反，我使用 Frank Harrell 的<code class="fe lc ld le lf b">Hmisc::rcorr()</code>函数有两个原因:</p><ol class=""><li id="aef0" class="mk ml iq ki b kj kk km kn kp mm kt mn kx mo lb mp mq mr ms bi translated">默认情况下，它会丢弃丢失的对</li><li id="6e73" class="mk ml iq ki b kj mt km mu kp mv kt mw kx mx lb mp mq mr ms bi translated">它返回 p 值，因此只需要一个函数就可以获得相关系数和匹配的 p 值</li></ol><p id="9601" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们加载我们为此需要的库，它们是使用<code class="fe lc ld le lf b">kable</code>显示表格的<code class="fe lc ld le lf b">knitr</code>和<code class="fe lc ld le lf b">tidyverse</code>(我们将具体使用<code class="fe lc ld le lf b">tidyr</code>、<code class="fe lc ld le lf b">dplyr</code>、<code class="fe lc ld le lf b">ggplot2</code>、<code class="fe lc ld le lf b">tibble</code>和<code class="fe lc ld le lf b">purrr</code>)。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="4a64" class="me mf iq lf b gy mg mh l mi mj">library(knitr) library(tidyverse, warn.conflict=F)</span></pre><p id="0611" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">首先，让我们看看我们将使用的相关函数的输出，<code class="fe lc ld le lf b">Hmisc::rcorr()</code>。它要求输入是一个矩阵，并输出三个矩阵的列表。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="fa93" class="me mf iq lf b gy mg mh l mi mj">mtcars_cor &lt;- Hmisc::rcorr(as.matrix(mtcars))</span></pre><p id="dbd9" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这三个矩阵包括相关系数(默认为皮尔逊系数)、<code class="fe lc ld le lf b">r</code>、p 值、<code class="fe lc ld le lf b">P</code>以及用于每个相关的观察值数量<code class="fe lc ld le lf b">n</code>。让我们把每个矩阵变成一个<code class="fe lc ld le lf b">data frame</code>，用<code class="fe lc ld le lf b">head</code>和<code class="fe lc ld le lf b">kable</code>来看前六行。</p><p id="21de" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">相关系数，<code class="fe lc ld le lf b">r</code>:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="9ff3" class="me mf iq lf b gy mg mh l mi mj">data.frame(mtcars_cor$r) %&gt;% head() %&gt;% kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi my"><img src="../Images/6c14ceec72bb0f6d6987edd98827f8ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Z8qAGRjnXfWlnRG6IXYJw.png"/></div></div></figure><p id="794f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe lc ld le lf b">P</code>p 值:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="c560" class="me mf iq lf b gy mg mh l mi mj">data.frame(mtcars_cor$P) %&gt;% head() %&gt;% kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mz"><img src="../Images/7d69f297247e16228f898a7c5620d9d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zVr3n85rAg09cIl9jlzV3Q.png"/></div></div></figure><p id="dc1a" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">观察次数，<code class="fe lc ld le lf b">n</code>。在<code class="fe lc ld le lf b">mtcars</code>数据集中没有缺失数据，因此有 32 对用于所有相关。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="2ede" class="me mf iq lf b gy mg mh l mi mj">data.frame(mtcars_cor$n) %&gt;% head(n=3) %&gt;% kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi na"><img src="../Images/1626dbcb46ca9ec04b4ebfa3f9bb07f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K8R76HPUwpPkwM3i7qCO0g.png"/></div></div></figure><p id="2b40" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">接下来，我们可以编写一个函数，为<code class="fe lc ld le lf b">Hmisc::rcorr()</code>正确格式化一个<code class="fe lc ld le lf b">data frame</code>，然后依次处理列表中的三个元素(<code class="fe lc ld le lf b">r</code>、<code class="fe lc ld le lf b">n</code>和<code class="fe lc ld le lf b">P</code>)</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="7101" class="me mf iq lf b gy mg mh l mi mj">cors &lt;- function(df) { <br/>   # turn all three matrices (r, n, and P into a data frame)<br/>   M &lt;- Hmisc::rcorr(as.matrix(df))<br/>   # return the three data frames in a list return(Mdf)<br/>   Mdf &lt;- map(M, ~data.frame(.x))<br/>  }</span></pre><p id="d1a6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这个函数中没有发生太疯狂的事情。现在我们只有三个数据帧的列表。我们可以使用<code class="fe lc ld le lf b">first()</code>查看列表的第一个元素，它显示了所有变量之间的相关性:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="428e" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;% first() %&gt;% head() %&gt;% kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nb"><img src="../Images/0a3e08679e51b175a21c4e3b79dccc5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rN7DzY13sU7tGaBrWe6qlw.png"/></div></div></figure><p id="0e2d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">下一步是准备好用<code class="fe lc ld le lf b">ggplot2</code>绘图的数据。我们现在可以将数据保存在一个列表中，并使用来自<code class="fe lc ld le lf b">purrr</code>的<code class="fe lc ld le lf b">map()</code>函数。</p><p id="8242" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">首先，我们需要使用<code class="fe lc ld le lf b">tibble::rownames_to_column()</code>将行名移动到它们自己的列中。的输出如下所示:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="ce9d" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;% <br/>   map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/>   # look at the first element of the list (r)<br/>   first() %&gt;%<br/>   head() %&gt;%<br/>   kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nc"><img src="../Images/413fa750476529b717219eb166a712c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Dm0ENYIVjiqEMJGi-5dmA.png"/></div></div></figure><p id="0f84" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">接下来，我们可以使用<code class="fe lc ld le lf b">tidyr::pivot_longer()</code>将列移动到名为<code class="fe lc ld le lf b">measure2</code>的单个列</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="9022" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> # format each data set (r,P,n) long<br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;%<br/> # look at the first element of the list (r)<br/> first() %&gt;%<br/> head() %&gt;%<br/> kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nc"><img src="../Images/413fa750476529b717219eb166a712c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Dm0ENYIVjiqEMJGi-5dmA.png"/></div></div></figure><p id="4579" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">现在，我们准备使用<code class="fe lc ld le lf b">bind_rows()</code>取消数据列表。这将把我们的相关性变成一个很长的数据帧，所有的行从<code class="fe lc ld le lf b">r</code>开始，然后是<code class="fe lc ld le lf b">n</code>，然后是<code class="fe lc ld le lf b">P</code>。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="d1e3" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> # format each data set (r,P,n) long <br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;%<br/> # merge our three list elements by binding the rows<br/> bind_rows(.id = "id") %&gt;%<br/> head() %&gt;%<br/> kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nd"><img src="../Images/c400938b9b84b08a8c4d6bdeedf82c59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*moAKm2DpYiDclaeS-VnObg.png"/></div></div></figure><p id="063c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于<code class="fe lc ld le lf b">ggplot2</code>，我们需要将<code class="fe lc ld le lf b">r</code>、<code class="fe lc ld le lf b">n</code>和<code class="fe lc ld le lf b">P</code>作为它们自己的列。我们可以用<code class="fe lc ld le lf b">pivot_longer()</code>来做到这一点。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="e19b" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> # format each data set (r,P,n) long <br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;%<br/> # merge our three list elements by binding the rows<br/> bind_rows(.id = "id") %&gt;%<br/> pivot_wider(names_from = id, values_from = value) %&gt;%<br/> head() %&gt;%<br/> kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ne"><img src="../Images/9bcc0d74b5bddf423bd942ce74b1d364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SeVLst5X_HGQ-1A-TMyovw.png"/></div></div></figure><p id="e78f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最后，我们可以添加一些列，这些列在以后可能会对我们的相关图提供更多信息非常有用。让我们添加告诉我们 p 值是否小于 0.05 的列，如果是，返回 1)p 值和 2)相关系数，以防我们想要用这些值标记我们的图。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="d9cf" class="me mf iq lf b gy mg mh l mi mj">cors(mtcars) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> # format each data set (r,P,n) long <br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;%<br/> # merge our three list elements by binding the rows<br/> bind_rows(.id = "id") %&gt;%<br/> pivot_wider(names_from = id, values_from = value) %&gt;%<br/> mutate(sig_p = ifelse(P &lt; .05, T, F), p_if_sig = ifelse(P &lt;.05, P, NA), r_if_sig = ifelse(r &lt;.05, r, NA)) %&gt;% <br/> head() %&gt;%<br/> kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nf"><img src="../Images/f946fd735cfb6c7779e85660e561923e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s8skhkO8zazMRG4xVhR9cg.png"/></div></div></figure><p id="2ee6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这似乎是我想画的所有东西。当然，你可以添加更多。在这一点上，我将我的格式化相关性转换成一个函数:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="7f80" class="me mf iq lf b gy mg mh l mi mj">formatted_cors &lt;- function(df){<br/> cors(df) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;% <br/> bind_rows(.id = "id") %&gt;%<br/> pivot_wider(names_from = id, values_from = value) %&gt;%<br/> mutate(sig_p = ifelse(P &lt; .05, T, F), p_if_sig = ifelse(P &lt;.05, P, NA), r_if_sig = ifelse(P &lt;.05, r, NA)) <br/>}</span></pre><p id="2911" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以测试该功能是否如预期的那样工作:</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="71fb" class="me mf iq lf b gy mg mh l mi mj">formatted_cors(mtcars) %&gt;% head() %&gt;% kable()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ng"><img src="../Images/3d343e9f48c22c2e5249243a0cfbbb22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RoIfT6FTOYQVuIvLnE2okA.png"/></div></div></figure><p id="5c07" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们终于准备好在<code class="fe lc ld le lf b">ggplot2</code>中绘制我们的关联热图了。</p><p id="fb33" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">该图最简单的形式只需要我们分别在<code class="fe lc ld le lf b">x</code>和<code class="fe lc ld le lf b">y</code>轴上指定<code class="fe lc ld le lf b">measure1</code>和<code class="fe lc ld le lf b">measure2</code>。然后，我们可以将相关性<code class="fe lc ld le lf b">r</code>映射到<code class="fe lc ld le lf b">fill</code> <code class="fe lc ld le lf b">aes</code>合成，并添加一个图块作为<code class="fe lc ld le lf b">geom</code>合成。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="d837" class="me mf iq lf b gy mg mh l mi mj">formatted_cors(mtcars) %&gt;%<br/> ggplot(aes(x = measure1, y = measure2, fill = r)) +<br/> geom_tile()</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/c43e1f927e0523c27978af2d5424c95f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vxjVNYZmY_5om0xr.png"/></div></div></figure><p id="0390" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以做一些小的美学上的改变，比如填充颜色比例、标题和字体系列。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="9553" class="me mf iq lf b gy mg mh l mi mj">formatted_cors(mtcars) %&gt;%<br/> ggplot(aes(x = measure1, y = measure2, fill = r)) +<br/> geom_tile() +<br/> labs(x = NULL, y = NULL, fill = "Pearson's\nCorrelation", title="Correlations in Mtcars") +<br/> # map a red, white and blue color scale to correspond to -1:1 sequential gradient scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +<br/> theme_classic() +<br/> # remove excess space on x and y axes<br/> scale_x_discrete(expand=c(0,0)) +<br/> scale_y_discrete(expand=c(0,0)) +<br/> # change global font to roboto<br/> theme(text=element_text(family="Roboto"))</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/41a8006d1036909e3e9756969b5dc68e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LeG10-W2PCxI7pTj.png"/></div></div></figure><p id="691d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以添加额外信息的相关性。对于这个特殊的图，我只添加了显著的(p 值小于 0.05)相关性，使用从<code class="fe lc ld le lf b">formatted_cors()</code>输出的列<code class="fe lc ld le lf b">r_if_sig</code>。</p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="ec6d" class="me mf iq lf b gy mg mh l mi mj">formatted_cors(mtcars) %&gt;% <br/> ggplot(aes(measure1, measure2, fill=r, label=round(r_if_sig,2))) +<br/> geom_tile() +<br/> labs(x = NULL, y = NULL, fill = "Pearson's\nCorrelation", title="Correlations in Mtcars", subtitle="Only significant Pearson's correlation coefficients shown") + scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +<br/> geom_text() +<br/> theme_classic() +<br/> scale_x_discrete(expand=c(0,0)) +<br/> scale_y_discrete(expand=c(0,0)) +<br/> theme(text=element_text(family="Roboto"))</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/0519afdb0ed91cf02f5e920e9b00db2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m77FPxWCFdQvDsO1.png"/></div></div></figure><p id="1341" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">另一个版本可以包括不同大小的正方形，以使用<code class="fe lc ld le lf b">geom_point</code>来表示相关性的强度，其中<code class="fe lc ld le lf b">shape</code>被设置为来自这些可用的 <code class="fe lc ld le lf b"><a class="ae ls" href="http://www.sthda.com/english/wiki/ggplot2-point-shapes" rel="noopener ugc nofollow" target="_blank">geom_shape</a></code> <a class="ae ls" href="http://www.sthda.com/english/wiki/ggplot2-point-shapes" rel="noopener ugc nofollow" target="_blank"> s </a>的<a class="ae ls" href="http://www.sthda.com/english/wiki/ggplot2-point-shapes" rel="noopener ugc nofollow" target="_blank">值。一定要取相关的绝对值，这样强的负相关也可以表示得更大。</a></p><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="432a" class="me mf iq lf b gy mg mh l mi mj">formatted_cors(mtcars) %&gt;%<br/> ggplot(aes(measure1, measure2, col=r)) +<br/> ## to get the rect filled geom_tile(col="black", fill="white") + geom_point(aes(size = abs(r)), shape=15) + labs(x = NULL, y = NULL, col = "Pearson's\nCorrelation", title="Correlations in Mtcars") + theme_classic() +<br/> scale_color_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +<br/> scale_x_discrete(expand=c(0,0)) +<br/> scale_y_discrete(expand=c(0,0)) +<br/> theme(text=element_text(family="Roboto")) +<br/> scale_size(range=c(1,11), guide=NULL)</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nh"><img src="../Images/3ae9f7cfc6ac4063bb582bc1d495c6c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BKXEyOthXJgrCtlQ.png"/></div></div></figure><pre class="lh li lj lk gt ma lf mb mc aw md bi"><span id="73a6" class="me mf iq lf b gy mg mh l mi mj">cors &lt;- function(df) {<br/> M &lt;- Hmisc::rcorr(as.matrix(df)) <br/> Mdf &lt;- map(M, ~data.frame(.x)) return(Mdf) }</span><span id="bc65" class="me mf iq lf b gy ni mh l mi mj">formatted_cors &lt;- function(df){<br/> cors(df) %&gt;%<br/> map(~rownames_to_column(.x, var="measure1")) %&gt;%<br/> map(~pivot_longer(.x, -measure1, "measure2")) %&gt;% <br/> bind_rows(.id = "id") %&gt;%<br/> pivot_wider(names_from = id, values_from = value) %&gt;%<br/> mutate(sig_p = ifelse(P &lt; .05, T, F), p_if_sig = ifelse(P &lt;.05, P, NA), r_if_sig = ifelse(P &lt;.05, r, NA)) }</span><span id="2327" class="me mf iq lf b gy ni mh l mi mj">formatted_cors(mtcars) %&gt;% <br/> ggplot(aes(measure1, measure2, fill=r, label=round(r_if_sig,2))) +<br/> geom_tile() + <br/> labs(x = NULL, y = NULL, fill = "Pearson's\nCorrelation", title="Correlations in Mtcars", subtitle="Only significant Pearson's correlation coefficients shown") + <br/> scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +<br/> geom_text() +<br/> theme_classic() +<br/> scale_x_discrete(expand=c(0,0)) + <br/> scale_y_discrete(expand=c(0,0)) +<br/> theme(text=element_text(family="Roboto"))</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/155f51f0b4136b6b5b1c015a834e17b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U9FL8rGKLDukXMAL.png"/></div></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="847e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="nj">原载于 2020 年 3 月 15 日</em><a class="ae ls" href="https://www.khstats.com/blog/corr-plots/corr-plots/" rel="noopener ugc nofollow" target="_blank"><em class="nj">https://www.khstats.com</em></a><em class="nj">。</em></p></div></div>    
</body>
</html>