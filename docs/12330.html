<html>
<head>
<title>CI/CD Pipeline with Azure DevOps for Data Science project.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过 Azure DevOps 为数据科学项目提供 CI/CD 管道。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ci-cd-pipeline-with-azure-devops-for-data-science-project-f263586c266e?source=collection_archive---------18-----------------------#2020-08-25">https://towardsdatascience.com/ci-cd-pipeline-with-azure-devops-for-data-science-project-f263586c266e?source=collection_archive---------18-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="738e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">CI/CD 管道实施，或数据科学的持续集成/持续部署。</h2></div><p id="cc50" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将展示如何使用 Azure DevOps 为机器学习项目构建持续集成和持续交付管道。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/7ab657e148d42fabd84bb543f1a163dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qg4U3h6ylL6Lp6qS3DWO8Q.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae lv" href="https://www.clipartkey.com/view/iRihwiw_ci-cd/" rel="noopener ugc nofollow" target="_blank"> CI/CD 管道</a></p></figure><p id="eceb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们来定义一下 CI/CD。正如<a class="ae lv" href="https://en.wikipedia.org/wiki/CI/CD" rel="noopener ugc nofollow" target="_blank"> Wiki </a>所说,“CI/CD 通过在应用程序的构建、测试和部署中实施自动化，在开发和运营活动以及团队之间架起了一座桥梁。现代的 DevOps 实践涉及软件应用程序在其整个开发生命周期中的持续开发、持续测试、持续集成、持续部署和持续监控。<strong class="kk iu"> CI/CD </strong>实践或<strong class="kk iu"> CI/CD 管道</strong>构成了现代开发运营的支柱。”</p><p id="dc16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好，让我们分别找出 CI 和 CD。</p><p id="2005" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lv" href="https://www.infoworld.com/article/3271126/what-is-cicd-continuous-integration-and-continuous-delivery-explained.html" rel="noopener ugc nofollow" target="_blank"> <em class="le">持续集成</em> </a>是一种编码哲学和一套实践，驱动开发团队实现小的变更，并频繁地将代码签入版本控制库。因为大多数现代应用程序需要在不同的平台和工具上开发代码，所以团队需要一种机制来集成和验证它的更改。</p><p id="aa24" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lv" href="https://www.infoworld.com/article/3271126/what-is-cicd-continuous-integration-and-continuous-delivery-explained.html" rel="noopener ugc nofollow" target="_blank"> <em class="le">连续交货</em> </a> <em class="le"> </em>在连续积分结束的地方拾取。CD 自动向选定的基础架构环境交付应用程序。大多数团队使用除生产环境之外的多种环境，例如开发和测试环境，CD 确保有一种自动的方式将代码变更推给他们。</p><p id="cf8d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么，它为什么重要呢？机器学习应用程序在我们的行业中变得越来越流行，但是，与更传统的软件(如 web 服务或移动应用程序)相比，开发、部署和持续改进它们的过程更加复杂。</p><p id="f31d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好，让我们试着为我的项目建立一个简单的管道。该项目是关于以下 Azure 服务的预测分析:Azure SQL，Azure 数据工厂，Azure 存储帐户 V2，Azure 数据砖。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lw"><img src="../Images/493396880816b38125f6ab72b91855ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rwS6kavUmfwHIwqNMLlyiA.jpeg"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">解决方案架构</p></figure><p id="5129" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个解决方案包括三个步骤。第一步—运行 data ADF 数据流以从 SQL DB 获取数据，转换并从表中选择几个列格式，然后将这些结果保存到 Azure Data Lake 中的 Stage 文件夹。第二步—使用关于存储帐户的指定参数从 ADF 运行 Azure Databriks notebook，以准备历史数据集并运行训练模型。在这一步，我们可以使用 MLflow rack 实验来记录和比较参数和结果。最后一步——从 ADF 运行 Azure Databriks notebook，并使用关于存储帐户的指定参数对我们的模型进行评分，并将结果保存到 Azure Data Lake。</p><p id="cde2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了启动这个项目，我需要在 Azure 门户网站中创建 3 个资源组。这些资源组将负责不同的环境—开发、试运行和生产。在这些环境中，我创建了以下服务——Azure SQL、Azure Data Factory、Azure 存储帐户 V2、Azure Data Bricks 和 Azure Key Vault。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/1d0e9240c30143a0c897014741a61e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ub6u_g_Aktr-_sH2QZdeww.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure 资源组和服务</p></figure><p id="9e97" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在所有 Azure SQL 中，我上传了两个表——历史数据和分数数据。这个数据的描述你可以通过这个<a class="ae lv" href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques/data" rel="noopener ugc nofollow" target="_blank"> <em class="le">链接</em> </a>找到。在 Azure 存储帐户中，我创建了一个包含三个文件夹的容器——RawData、PreprocData 和 Results。下一步是在 Azure 密钥库中创建秘密。我需要一个 Azure 存储帐户的秘密，在那里我为我的 Azure SQL DB 使用了访问密钥和连接字符串。重要的是，要从 Azure Data Factory 访问您的秘密，您需要在 Azure 存储帐户的访问策略中进行一些配置</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/32735a6266738a4dcdec2640f3dcbf64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QC8-hqRg6t5cHxQBwwmLOQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">访问策略配置</p></figure><p id="66ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如你所看到的，我添加了一个带有适当的 Azure 数据工厂服务和 Azure 数据块的访问策略，这是我早期创建的，允许获取一个秘密。</p><p id="80a6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是配置 Azure 数据块。为了引用 Azure Key Vault 中存储的秘密，我创建了一个由 Azure Key Vault 支持的秘密范围。要创建它，请转到<code class="fe ly lz ma mb b">https://&lt;databricks-instance&gt;#secrets/createScope</code>。此 URL 区分大小写；<code class="fe ly lz ma mb b">createScope</code>中的作用域必须大写，并填写下表:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/245143a0fc1ef08791593fca40ebb6af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/0*eaNbVMGxnqs4BRSj.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae lv" href="https://docs.microsoft.com/en-us/azure/databricks/security/secrets/secret-scopes" rel="noopener ugc nofollow" target="_blank">创建 Azure 密钥库支持的秘密范围</a></p></figure><p id="3707" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Azure Databricks 配置的下一步是—将我的笔记本连接到 Azure DevOps 存储库。要做到这一点，只需打开你的笔记本，按下同步，并填写关于你的 Azure DevOps 存储库的信息表单。这样，您可以将笔记本中的更新提交到存储库中。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/073fd1d31192ac9661fac2eb7238a4c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3LRUkVwZtWgf2tEaNBQvA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure Databricks 笔记本连接到 Azure DevOps 存储库。</p></figure><p id="1a0c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Azure 服务的基本配置已经完成，让我们开始在 Azure 数据工厂中创建管道。第一步是将 ADF 连接到 Azure DevOps 存储库。我可以通过两种方式连接它——在服务创建期间和在 ADF 配置中。我只需要为开发环境配置这个连接。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi md"><img src="../Images/5faf69d07d12bd15129802acab351102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-e0yXZoz3XAqUOFQB4K0OQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure 数据工厂连接到 Azure DevOps 存储库。</p></figure><p id="060d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，现在我们可以选择我们想要发展管道的分支。下一步——创建所有 Azure 服务的链接服务。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi me"><img src="../Images/fb671b10fbb2ce32ea8d1dd3226439b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TC2xaleKnapbPQNzIo8MdQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">列表链接的服务</p></figure><p id="917d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了创建 Azure Databricks 链接服务，我填写了下一个表单:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/4c55dba316f82920f58a80e6c18fbcfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*oSc9K7LRLHoQRBhDloZsdA.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure Databricks 链接服务配置</p></figure><p id="1e30" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了创建 Azure SQL DB 链接服务，我填写了下一个表单:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/008500e6937ba55e904b84629ac2f955.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*vqGASAGYR6WlD6IctAzQLQ.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure SQL 链接服务配置</p></figure><p id="5fef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了创建 Azure 存储帐户关联服务，我填写了下一个表单:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/e9d9f15c915148f3daebce0cc4f4f760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*_erKOJlgTY6y5rZYJcYm5g.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure 存储帐户链接服务配置</p></figure><p id="1afd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了创建 Azure Key Vault 链接服务，我填写了下一个表单:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/47e6c71c3bb2b2c82c61b5943d1eb4eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*zfqJ8OE1oo1v-6P_Pgn4Jg.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">为了创建 Azure Key Vault 链接服务，我填写了下一个表单:</p></figure><p id="bf4a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了控制不同环境之间的链接服务名称，我在 ADF 中使用了全局参数，创建了三个参数— dev、stg、prd。</p><p id="021b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们创建一个管道:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mj"><img src="../Images/f95723f3e7654b1e2af3be4965cd4306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHuYvCiFnOQUX5VxT8X4tQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">ADF 管道</p></figure><p id="6b3a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的管道的第一步是数据流:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mk"><img src="../Images/d73217dc9940d81b83121cff21371396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvkgTJ-YhmfWzVx1Hl4npA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">ADF 数据流</p></figure><p id="e4d4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个数据流中，我从 Azure SQL DB 获取数据，转换数据格式，从表中选择一些列，并将结果上传到 Azure Data Lake 的适当文件夹中。此流程是为历史记录和分数(新数据)表创建的。</p><p id="612f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">管道的下一步是运行 data_preparation_model_train 和 score_new_data 脚本。为此，我们需要:</p><ol class=""><li id="f102" class="ml mm it kk b kl km ko kp kr mn kv mo kz mp ld mq mr ms mt bi translated">选择合适的链接服务</li><li id="27f6" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld mq mr ms mt bi translated">选择笔记本的目的地</li><li id="ebad" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld mq mr ms mt bi translated">添加带有存储名称的参数</li></ol><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/8804d623828f5271a79c3d933b5aa377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uF-vc7rTQZPJGBzZcOFxdQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">配置 Azure Databricks 笔记本从 ADF 运行</p></figure><p id="c79f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与 score_new_data 脚本相同。</p><p id="2181" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是我的 ADF 管道的所有阶段，接下来的步骤是验证，创建 pull 请求以将我的分支与 master 连接，然后将所有更新从 ADF 发布到 master 分支。结果是:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mz"><img src="../Images/93fb27b2d7e33a3bca7330f7aaeb7a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GFdPa76R1KIpzEL4syTDHw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Azure DevOps 存储库结构</p></figure><p id="ed91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们开始在 Azure DevOps 中配置 CI/CD。</p><p id="11f9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步——创建新的发布管道(在 Azure DevOps 门户中，导航至“管道”-&gt;“发布”并点击新管道)</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/80dee1f9a8aa6c418d9521d55c8688ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p6GEc89EmQA9sMzDhFSmpw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">创建新的发布渠道(步骤 1)</p></figure><p id="7e4e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择显示各种预配置模板的<strong class="kk iu">模板</strong>窗口。在数据工厂的情况下，选择是创建一个<strong class="kk iu">空作业</strong>，并将其命名为<strong class="kk iu">—</strong><em class="le">ADF-devo PS 2020-CICD:</em></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/d250fe955b033dbf89911dd5fa6b219b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mNWfvKxfH3Pz6Cl_lyxxrA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">创建新的发布渠道(步骤 2)</p></figure><p id="c7b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建一个新的阶段“登台”(测试环境):</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi na"><img src="../Images/5fee0e670c400578b168dca7c7035ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aubbkSP6rZmb5Vbe"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">空白释放管道</p></figure><p id="d9d0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经创建了一个空白的发布管道。下一步是创建任务将使用的变量组和变量。为此，我们需要导航到 Pipelines -&gt; Library 并创建一个新的变量组。在新表单中填写下一个信息，然后克隆它，为生产阶段创建相同的信息。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nb"><img src="../Images/a7a4cb89d08dc8f0a17388bc528c12bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hev8NR3DUCGutmuELeqVfw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">变量组创建</p></figure><p id="9e27" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果，我得到了两个变量组。稍后我将被映射到相应的阶段。</p><p id="a42a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步—创建发布管道变量。由于变量组值的继承，变量将包含与环境无关的值。因此，变量值将被调整到使用它的阶段。为了创建它，返回到<strong class="kk iu">管道- &gt;释放</strong>，然后打开标签<strong class="kk iu">变量</strong>。我创建了下一个变量:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nc"><img src="../Images/6b847f6101b8c31dc1d245fc8cb14f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-b6bKjKisKarCqWI6_2bNg.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">管道变量</p></figure><p id="d4cf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是时候创建和配置开发阶段了。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nd"><img src="../Images/f0c667758f3ea7d2077e61747d3d7d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6vK1JL2CJJ2cre4cUGdz8g.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">配置开发阶段。</p></figure><p id="2328" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些行动将创造一个发展阶段。每次我们更新我们的<code class="fe ly lz ma mb b">master</code>分支时，它都会触发持续交付管道，将更新后的 ARM 模板交付给其他环境，如试运行和生产。我们还可以自动完成创建触发器的过程:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ne"><img src="../Images/9e76a819b019ff1b27fcea2cbea8334f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhakkkkIJt60jhg63tor1g.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">连续部署触发器</p></figure><p id="083e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在是时候配置试运行或测试阶段了。是时候为这个阶段创建几个任务了。对于我的第一个管道，我创建了两个工作——在 Azure Data Factory 中部署管道和将 Python 笔记本复制到 Azure Databricks。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nf"><img src="../Images/a13ec2ffe50a837736ab168feb7c4281.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j_sqjNah1oFFiV1veqInmw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">测试阶段的工作</p></figure><p id="299c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们更详细地了解任务臂模板部署。我想描述的主要内容是-</p><ul class=""><li id="7db7" class="ml mm it kk b kl km ko kp kr mn kv mo kz mp ld ng mr ms mt bi translated">在资源组字段中填入一个变量:<code class="fe ly lz ma mb b">$(resourceGroup)</code>。</li><li id="1074" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld ng mr ms mt bi translated">选择模板位置:“链接工件”</li><li id="f1d1" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld ng mr ms mt bi translated">选择 ARM 模板和模板参数文件</li></ul><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nh"><img src="../Images/1f34b7075bbf834278e7aa26e7ad4b7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VzRjSaTQ0giwozSmFKMmig.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">ARM 模板和模板参数文件位置</p></figure><ul class=""><li id="88a0" class="ml mm it kk b kl km ko kp kr mn kv mo kz mp ld ng mr ms mt bi translated">用先前创建的变量覆盖默认模板参数</li></ul><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ni"><img src="../Images/623be2b0a5ee853a4989fc42eb699784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*rMwk7-J690G5006t4CVprA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">模板参数</p></figure><p id="01ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在结果中，我们得到了下一种形式:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/de03ecf18d205ab1402bad9a7c94df27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*pmQQRbTwpSzoZqAEQ39SgA.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">部署 ADF 任务</p></figure><p id="643e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的下一个任务是部署笔记本电脑。让我们更详细地了解一下。我们需要填充:</p><ol class=""><li id="b30d" class="ml mm it kk b kl km ko kp kr mn kv mo kz mp ld mq mr ms mt bi translated">我要将 Azure Databricks 中的笔记本复制到的文件夹。app id，我之前创建的。(如何创建— <a class="ae lv" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app" rel="noopener ugc nofollow" target="_blank"> <em class="le">链接</em> </a>)。)</li><li id="ec77" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld mq mr ms mt bi translated">相同的应用程序 id</li><li id="3ce8" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld mq mr ms mt bi translated">订阅 id</li><li id="4509" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld mq mr ms mt bi translated">租户 id</li></ol><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/71dddcb9756fdd43c46c54806658d0b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*coZc8zqhYUkkOZy7-ynwMQ.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">复制数据块笔记本任务</p></figure><p id="501a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我在这个阶段有两个任务:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/8cade9ea919764c166f9c7df18142f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWYeHwNZjRN7BcL8YesG6A.png"/></div></div></figure><p id="9e88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我还需要<strong class="kk iu">制作</strong>阶段。点击克隆<strong class="kk iu">暂存</strong>环境到<strong class="kk iu">生产</strong>:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nm"><img src="../Images/5c6d16e36f24499e20aa49aa4038e677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9MmCDZwn2AdsmBnYehWrwQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">克隆测试阶段</p></figure><p id="5a44" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">生产阶段是通过克隆一个阶段创建的，没有额外的调整或添加。这是因为底层作业是由变量配置的，这些变量包含指向所有外部引用的指针，如资源组、密钥库、存储帐户。此外，对于此阶段，建议创建“预部署”批准。因此，当分段部署结束时，执行流将等待分配的批准者的操作。我可以通过电子邮件通知或使用 DevOps 门户 UI 直接做出反应。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/2e9ef53d8a2138d371e4f9346cbd7414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mcban-pYmQbxS3ljLm-byQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">配置“预部署”批准</p></figure><p id="bb91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有配置的最后一步是将变量组映射到阶段。这一步对于将特定于阶段的变量值映射到特定阶段是必要的。例如，如果流水线在生产阶段处理作业，则变量$(环境)具有值“prd ”,并且如果作业在暂存阶段被触发，则将该值设置为“stg”。要使它打开标签变量-&gt;变量组并点击“链接变量组”。将变量组“生产”映射到阶段“生产”，并选择范围“阶段生产”而不是“发布”，然后对“阶段”重复相同的操作。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi no"><img src="../Images/d565036b6c24d8551c7925db0e1f5579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMwncAg6lNnkB4ARngWN8A.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">将变量组映射到阶段</p></figure><p id="c6c7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是时候运行并检查这个简单的管道了。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi np"><img src="../Images/304d0b4c585b51c47f27e954b28b1696.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gB0H0Cl9xDObVZ_rGAqI3A.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">创建并运行发布</p></figure><p id="fbbf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果，我在 Stage and Production Resource 组的适当服务上找到了 ADF pipeline 和 Azure Databricks 笔记本。我还可以分析每个阶段所有任务的细节，例如:</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi np"><img src="../Images/d1afb702d0679a96242658bc394262a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IWGw_ZYShbzG3DnCEKu1Gw.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">在测试阶段分析部署 ADG 任务</p></figure><p id="b034" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了使这个管道更加完整，我还可以在测试阶段添加一些测试任务。例如，这些测试可以运行 ADF 管道并分析其结果 Azure Data Lake 中的一个又一个副本表、MLflow 日志以及得分后表中的结果。通过所有这些测试后，我们可以批准<strong class="kk iu">生产</strong>阶段。</p><p id="fc5b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个故事中，我将一步一步地详细说明如何创建和配置发布管道，以在 Azure 数据工厂环境中实现 CI/CD 实践。它显示了 Azure DevOps、Azure Data Factory、Azure SQL DB、Azure Data Lake 和 Azure Databricks 在一起使用时可能带来的限制和可能性。</p><p id="88c9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读。</p><p id="19a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有用的链接:</p><ul class=""><li id="4f00" class="ml mm it kk b kl km ko kp kr mn kv mo kz mp ld ng mr ms mt bi translated"><a class="ae lv" href="https://docs.microsoft.com/en-us/azure/devops/?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> <em class="le">蔚蓝 DevOps 文档</em> </a></li><li id="bf6b" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld ng mr ms mt bi translated"><a class="ae lv" href="https://docs.microsoft.com/en-us/azure/data-factory/introduction" rel="noopener ugc nofollow" target="_blank"> <em class="le"> Azure 数据工厂</em> </a></li><li id="42fd" class="ml mm it kk b kl mu ko mv kr mw kv mx kz my ld ng mr ms mt bi translated"><a class="ae lv" href="https://docs.microsoft.com/en-us/azure/databricks/applications/mlflow/" rel="noopener ugc nofollow" target="_blank"><em class="le">Azure data bricks ml flow</em></a></li></ul></div></div>    
</body>
</html>