<html>
<head>
<title>How to Split a Pickled Model File to Bypass Upload Limits on PythonAnywhere</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何分割一个 Pickled 模型文件以绕过 PythonAnywhere 上的上传限制</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-spit-a-pickled-model-file-to-bypass-upload-limits-on-pythonanywhere-e051ea1cec2d?source=collection_archive---------38-----------------------#2020-07-25">https://towardsdatascience.com/how-to-spit-a-pickled-model-file-to-bypass-upload-limits-on-pythonanywhere-e051ea1cec2d?source=collection_archive---------38-----------------------#2020-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5fcc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在这篇短文中，我将分享如何使用 python 和 os 库分割和连接一个 pickled 模型文件，以绕过 PythonAnywhere 上的上传限制。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/625cee305a8460cb8fe888d7142ee90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6_AEU9ZgqS2G5mt9AM7epA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">凯文·Ku 拍摄的图片</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="7134" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我的上一篇文章“建立一个卷积神经网络来识别剃过脸和没剃过脸的人”中，我分享了我用 Pickle 保存最终训练好的模型的方法。</p><blockquote class="lz ma mb"><p id="e0ed" class="ld le mc lf b lg lh jr li lj lk ju ll md ln lo lp me lr ls lt mf lv lw lx ly ij bi translated">“pickle”是将 Python 对象层次结构转换成字节流的过程，“unpickling”是相反的操作，将字节流(来自二进制文件或类似字节的对象)转换回对象层次结构。— <strong class="lf ir">源代码:</strong> <a class="ae kv" href="https://github.com/python/cpython/tree/3.8/Lib/pickle.py" rel="noopener ugc nofollow" target="_blank"> Lib/pickle.py </a></p></blockquote><p id="de57" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">作为一个复习，这里有一行代码来处理你的最终模型，保存所有的权重，没有将结构保存为。json 文件，并作为. h5 文件单独加权。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="447a" class="ml mm iq mh b gy mn mo l mp mq">import pickle</span><span id="9332" class="ml mm iq mh b gy mr mo l mp mq">pickle.dump(model, open(“Your_Saved_Model.p”, ‘wb’))</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="baa7" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">因为我有一个模型，所以我的目标是构建一个 Flask 应用程序，并部署它供公众使用。我选择<a class="ae kv" href="https://www.pythonanywhere.com/?affiliate_id=0077ae73" rel="noopener ugc nofollow" target="_blank"> PythonAnywhere </a>来托管<a class="ae kv" href="http://jtadesse.pythonanywhere.com/" rel="noopener ugc nofollow" target="_blank">我的应用程序</a>，因为我需要访问 Bash 控制台，还需要设置一个虚拟环境，但是我意识到文件上传是有限制的，我的模型比允许的大了三倍。</p><p id="effb" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我做了一些研究，发现了一篇非常有帮助的<a class="ae kv" href="https://stonesoupprogramming.com/2017/09/16/python-split-and-join-file/" rel="noopener ugc nofollow" target="_blank">文章</a>，在理解如何用 Python 拆分和合并文件方面。使用<code class="fe ms mt mu mh b">os</code>库和下面的函数，我能够将 pickled 模型文件分割成三个更小的文件:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="bb1a" class="ml mm iq mh b gy mn mo l mp mq">def split(source, dest_folder, write_size):<br/>    # Make a destination folder if it doesn't exist yet<br/>    if not os.path.exists(dest_folder):<br/>        os.mkdir(dest_folder)<br/>    else:<br/>        # Otherwise clean out all files in the destination folder<br/>        for file in os.listdir(dest_folder):<br/>            os.remove(os.path.join(dest_folder, file))</span><span id="b5de" class="ml mm iq mh b gy mr mo l mp mq">    partnum = 0<br/>    <br/>    # Open the source file in binary mode<br/>    input_file = open(source, 'rb')</span><span id="bccb" class="ml mm iq mh b gy mr mo l mp mq">    while True:<br/>        # Read a portion of the input file<br/>        chunk = input_file.read(write_size)<br/>        <br/>        # End the loop if we have hit EOF<br/>        if not chunk:<br/>            break<br/>        <br/>        # Increment partnum<br/>        partnum += 1<br/>        <br/>        # Create a new file name<br/>        filename = '/Model_Files/final_model' + str(partnum)<br/>        <br/>        # Create a destination file<br/>        dest_file = open(filename, 'wb')<br/>        <br/>        # Write to this portion of the destination file<br/>        dest_file.write(chunk)</span><span id="5ecc" class="ml mm iq mh b gy mr mo l mp mq">        # Explicitly close <br/>        dest_file.close()</span><span id="f3f8" class="ml mm iq mh b gy mr mo l mp mq">    # Explicitly close<br/>    input_file.close()</span><span id="79fd" class="ml mm iq mh b gy mr mo l mp mq">    # Return the number of files created by the split<br/>    return partnum</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="cba5" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该函数需要 source、write_size 和 dest_folder。source 是保存整个模型的位置，write_size 是每个文件的字节数，dest_folder 是保存每个分割文件的目标文件夹。</p><p id="9e02" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这里有一个例子:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="1020" class="ml mm iq mh b gy mn mo l mp mq">split(source='Your_Saved_Model.p', write_size=20000000, dest_folder='/Model_Files/')</span></pre><p id="c590" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">因为我现在有三个可接受的上传文件，所以一旦应用程序在浏览器中启动，我需要更新我的 flask 应用程序来处理服务器上的文件连接。这里有一个到我的<a class="ae kv" href="https://github.com/cousinskeeta" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>的链接，可以在部署到<a class="ae kv" href="https://www.pythonanywhere.com/?affiliate_id=0077ae73" rel="noopener ugc nofollow" target="_blank"> PythonAnywhere </a>之前查看完整的代码。</p><p id="b1eb" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我使用下面的函数来连接文件，并将合并后的模型保存在应用程序的服务器上:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="0f3d" class="ml mm iq mh b gy mn mo l mp mq">def join(source_dir, dest_file, read_size):<br/>    # Create a new destination file<br/>    output_file = open(dest_file, 'wb')<br/>     <br/>    # Get a list of the file parts<br/>    parts = ['final_model1','final_model2','final_model3']<br/> <br/>    # Go through each portion one by one<br/>    for file in parts:<br/>         <br/>        # Assemble the full path to the file<br/>        path = file<br/>         <br/>        # Open the part<br/>        input_file = open(path, 'rb')<br/>         <br/>        while True:<br/>            # Read all bytes of the part<br/>            bytes = input_file.read(read_size)<br/>             <br/>            # Break out of loop if we are at end of file<br/>            if not bytes:<br/>                break<br/>                 <br/>            # Write the bytes to the output file<br/>            output_file.write(bytes)<br/>             <br/>        # Close the input file<br/>        input_file.close()<br/>         <br/>    # Close the output file<br/>    output_file.close()</span><span id="d92b" class="ml mm iq mh b gy mr mo l mp mq">join(source_dir='', dest_file="Combined_Model.p", read_size = 50000000)</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="e923" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这个函数将单个文件字节合并成一个单独的 pickled 对象。看看我如何使用 jQuery 让用户以一种交互的方式上传图像，并通过向后端发送请求来进行预测，使用新的组合模型来服务于预测。查看我的<a class="ae kv" href="https://github.com/cousinskeeta" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>应用程序。</p><p id="0d40" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="lf ir"> <em class="mc">资源</em> </strong>:</p><div class="mv mw gp gr mx my"><a href="https://stonesoupprogramming.com/2017/09/16/python-split-and-join-file/" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">Python 拆分和连接文件</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">《编程 Python:强大的面向对象编程》这本书有一个示例程序，展示了如何拆分和…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">stonesoupprogramming.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm kp my"/></div></div></a></div></div></div>    
</body>
</html>