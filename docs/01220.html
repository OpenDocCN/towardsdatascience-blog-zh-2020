<html>
<head>
<title>Importing DynamoDB Data Using Apache Hive on Amazon EMR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon EMR上的Apache Hive导入DynamoDB数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/importing-dynamodb-data-using-apache-hive-on-amazon-emr-651d468898c6?source=collection_archive---------28-----------------------#2020-02-03">https://towardsdatascience.com/importing-dynamodb-data-using-apache-hive-on-amazon-emr-651d468898c6?source=collection_archive---------28-----------------------#2020-02-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3890" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Amazon EMR和Hive，您可以快速高效地处理大量数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d35c0b9db0944cb3a2ce6f795541030e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lh254a2z23RRwQU32MwBig.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@clesulie" rel="noopener ugc nofollow" target="_blank">科林斯·莱苏里</a>在<a class="ae ky" href="https://unsplash.com/photos/-OZcGk5lD7U" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="6117" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文描述了将数据导入AWS DynamoDB数据库的多种方法之一。这里解释的选项使用Amazon EMR和Hive。使用Amazon EMR和Hive，您可以快速有效地处理大量数据，例如将数据从Amazon S3导入DynamoDB表。</p><h1 id="963b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">这个例子实现了什么？</h1><ol class=""><li id="222c" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">每天，一个外部数据源都会向S3·巴特发送一个包含大约1000条记录的csv文件。</li><li id="ebb2" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">将csv对象放入S3存储桶时将被触发的lambda函数。</li><li id="a8c1" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">Lambda函数将启动EMR作业，步骤包括:</li></ol><ul class=""><li id="28ba" class="mn mo it lb b lc ld lf lg li nd lm ne lq nf lu ng mv mw mx bi translated">创建一个引用DynamoDB中存储的数据的配置单元表。</li><li id="ebfe" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu ng mv mw mx bi translated">创建一个引用亚马逊S3的位置的配置单元表。</li><li id="b212" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu ng mv mw mx bi translated">将数据从S3表加载到DynamoDB表。</li></ul><p id="76b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了该流程的架构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/2d1286061adbc521da243e7553e38e61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouYa4y5nbo1ibPvODtfN-g.png"/></div></div></figure><h1 id="8710" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">先决条件</h1><ul class=""><li id="e687" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu ng mv mw mx bi translated">对云形成的基本了解。</li><li id="1060" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu ng mv mw mx bi translated">对电子病历的基本理解。</li><li id="eab1" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu ng mv mw mx bi translated">设置AWS帐户。</li><li id="e249" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu ng mv mw mx bi translated">安装<a class="ae ky" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>。</li></ul><h1 id="5cef" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">现在，我们开始吧</h1><p id="28bc" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在开始之前，安装<a class="ae ky" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">无服务器框架</strong> </a>。打开一个终端，输入<code class="fe nl nm nn no b">npm install -g serverless</code>。</p><p id="1a4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">项目目录下有一个<code class="fe nl nm nn no b">yml</code>文件(<code class="fe nl nm nn no b">serverless.yml)</code>)。让我们开始在模板文件中定义一组对象，如下所示:</p><h2 id="0bb0" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">S3水桶</h2><p id="6324" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">有两个S3桶，<strong class="lb iu"> LogBucket </strong>用于EMR日志，<strong class="lb iu"> S3BucketCsvimport </strong>用于存储csv文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="2359" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">DynamoDB表</h2><p id="26e7" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">从S3加载csv数据的DynamoDB表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="f467" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">λ函数配置</h2><p id="b656" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">向<code class="fe nl nm nn no b">serverless.yml</code>添加lambda功能配置。它将由S3新创建的对象事件触发，lambda函数将启动一个EMR作业流来处理数据导入。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="37a6" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">IAM角色</h2><p id="c868" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">我们还需要为lambda函数创建IAM角色，这样我们的lambda函数就有权限启动EMR作业流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="9877" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">添加lambda函数</h2><p id="f349" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们添加一个lambda函数来创建一个AWS EMR集群，并添加步骤细节，如配置单元脚本的位置、参数等。我们可以为EMR使用boto3库，以便创建一个集群，并从lambda函数动态提交作业。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h1 id="e6de" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">配置单元脚本</h1><p id="e770" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">Ad最后…让我们添加Hive脚本。</p><h2 id="d678" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">第一步。创建配置单元和S3之间的映射</h2><p id="0da0" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">我们将创建一个映射到csv数据文件的外部配置单元表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="f1cb" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">第二步。正在创建配置单元和DynamoDB之间的映射</h2><p id="f3f7" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在配置单元和DynamoDB中的Features表之间建立映射。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="655d" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">第三步。用S3的数据加载表</h2><p id="554a" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">将当前日期添加为分区，并在S3加载包含csv数据的表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="da45" class="np lw it bd lx nq nr dn mb ns nt dp mf li nu nv mh lm nw nx mj lq ny nz ml oa bi translated">第四步。<strong class="ak">从亚马逊S3导入一个表格到DynamoDB </strong></h2><p id="228a" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">使用下面的配置单元脚本将数据从亚马逊S3写到DynamoDB。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="1573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，DynamoDB表上的Amazon EMR操作算作读/写操作，并且受表的调配吞吐量设置的限制。更多详情请访问<a class="ae ky" href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/EMR_Hive_Optimizing.html" rel="noopener ugc nofollow" target="_blank">电子病历文件</a>。</p><h1 id="8bb3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">现在让我们部署服务并进行测试！</h1><pre class="kj kk kl km gt od no oe of aw og bi"><span id="823a" class="np lw it no b gy oh oi l oj ok">$sls deploy --stage dev</span></pre><p id="a108" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在脚本部署后，将一个csv文件复制到带有<code class="fe nl nm nn no b">created_date={CURRENT_DATE}</code>前缀的S3存储桶，例如</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="4ac0" class="np lw it no b gy oh oi l oj ok">$aws s3 cp csv/contacts.csv s3://myemr.csv.import.dev/uploads/created_date=2020-02-03/contacts.csv</span></pre><p id="8b0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以转到AWS EMR控制台，检查EMR步骤的进度。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/330ce1d334301cfda0fb7250213d55ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvVKAndS3UioDkrMZy1pnQ.png"/></div></div></figure><p id="5e3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成所有步骤需要几分钟时间，运行上述步骤后，群集将自动终止。</p><p id="ff45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们可以转到AWS DynamoDB控制台，验证数据是否已经加载到DynamoDB中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/5debf988cb7d33a9f3eb12ae1554de01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uSWDw9XFb7_nEgQe3LMkzg.png"/></div></div></figure><p id="82e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终，导入过程花费了大约6分钟的时间，将1000条总共76kb的记录加载到DynamoDB表中，写入容量单位为10，没有启用自动缩放。</p><p id="ff53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大概就这些，感谢阅读！</p><p id="4757" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望你觉得这篇文章有用，你可以在我的<a class="ae ky" href="https://github.com/yai333/emr-dynamodb-import" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> GitHub repo </strong> </a>中找到完整的项目。</p></div></div>    
</body>
</html>