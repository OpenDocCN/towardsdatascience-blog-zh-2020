# 管理数据科学项目的软件依赖性

> 原文：<https://towardsdatascience.com/managing-software-dependencies-for-data-science-projects-523e70af82d4?source=collection_archive---------47----------------------->

## 保持项目依赖关系清晰和可重复的分步指南。

![](img/5f1804fac48b7fc2dcb20353283ec025.png)

Emile Perron 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

开发软件项目时，虚拟环境是*的必备条件。它们允许您创建独立的 Python 安装，防止您的项目相互冲突，并让其他人复制您的设置。*

然而，使用虚拟环境只是开发可重复数据项目的第一步。这篇文章讨论了另一个重要的主题:依赖性管理，它涉及到正确地记录虚拟环境，以简化可再现性，并使它们在部署到生产环境时变得可靠。

关于 Python 环境的更深入的描述，[参见另一篇文章](https://ploomber.io/posts/python-envs/)。

# **依赖性管理器如何工作**

*TL；dr；软件包管理器使用试探法来安装相互兼容的软件包版本。大量的依赖项和版本约束可能会导致解析环境时失败。*

当您安装一个软件包时，您的软件包管理器(pip，conda)必须安装所请求的软件包的依赖项以及这些依赖项的依赖项，直到所有要求都得到满足。

包通常有版本约束。例如，在编写[时，scikit-learn](https://github.com/scikit-learn/scikit-learn/blob/master/sklearn/_build_utils/min_dependencies.py) 需要 numpy 1.13.3 或更高版本。当包共享依赖关系时，包管理器必须找到满足所有约束的版本(这个过程被称为依赖关系解析)，这样做在计算上是很昂贵的，当前的包管理器使用试探法在合理的时间内找到解决方案。

对于大量的依赖项，规划求解可能无法找到解决方案。一些包管理器会抛出一个错误，但是其他的可能只是打印一个警告消息。为了避免这些问题，了解项目的依赖性是很重要的。

# **开发和生产依赖关系**

*TL；dr；对开发(即训练模型所需的包)和生产(即进行预测所需的包)中的依赖项进行分组。*

在从事数据科学项目时，可能会有一些只在开发时需要的包，但在生产环境中并不需要。例如，如果您正在开发一个模型，您可能会使用 matplotlib 在 jupyter 笔记本中生成一些评估图表，但是对于通过 API 提供预测，您不需要这些。

这使您有机会简化生产环境中的依赖关系。下一节将讨论如何做到这一点。

# **维护依赖文件**

*TL；dr；为开发/生产依赖项保留单独的文件。手动添加/删除包，并尽可能保持它们的灵活性(通过不固定特定版本)，以简化依赖关系解析，并根据可用的最新兼容版本测试您的项目。*

`pip`和`conda`是 Python 使用最广泛的包管理器；两者都可以从文本文件中设置依赖关系。我推荐使用`conda`(通过 [miniconda](https://docs.conda.io/en/latest/miniconda.html) )，因为它可以处理比`pip`更多的依赖。你甚至可以安装非 Python 包，比如 [R](https://ploomber.readthedocs.io/en/stable/user-guide/r-support.html#configuring-r-environment) 。如果有你不能使用`conda install`安装的包，你仍然可以在 conda 环境中使用`pip install`。

在`conda`中，您可以在 YAML 文件中记录您的依赖关系，如下所示:

虽然您可以自动生成这些文件，但最好手动维护它们。一个很好的做法就是加上一个简短的评论，让其他人知道(甚至是你未来的自己！)为什么需要套餐。在开发过程中，我们可能会试验一些包，但很快就将其丢弃，最好的方法是将其从环境文件中删除，但如果您忘记这样做，注释将有助于您将来决定丢弃哪些依赖项。

保持依赖关系的灵活性，并在必要时只固定特定的版本，添加到环境中的版本约束越多，遇到求解程序无法满足所有约束的可能性就越大。

# **安装依赖关系**

*TL；dr；在设置环境时总是寻找错误，有时您可能需要固定版本来解决问题。*

一旦指定创建环境文件，就可以使用以下命令创建 conda 虚拟环境:

如果您有一组合理的依赖项，您的环境应该安装得很好，但是有一些因素可能会给出错误/警告。始终检查命令输出是否有问题。根据求解程序的配置，该命令可能会拒绝创建环境或打印警告消息。

我提到解决者试图找到满足所有包需求的解决方案，但这是在假设包维护者拥有最新需求的情况下。假设包 X 依赖于包 Y，但 X 没有为 Y 设置任何版本约束。新版本的 Y 发布后会破坏 X。下一次安装 X 时，如果求解器安装了不兼容版本的 Y，则会导致安装失败(从求解器的角度来看，这不是问题，因为 X 没有为 Y 设置任何约束)。这些情况很难调试，因为您必须通过反复试验找到一个工作版本，然后将正确的版本固定在依赖文件中。

不从头测试环境设置的时间越长，破坏环境设置的风险就越大。因此，持续测试依赖文件是很重要的。

# **测试您的开发环境**

*TL；dr；在最近创建的环境中连续运行您的项目测试，以检测由于包更新引起的中断。*

因为你的开发包没有固定到一个特定的版本，包管理器将尝试安装最新的兼容版本，这从开发的角度来看是好的，因为包得到了改进:新的特性，错误修复和/或安全补丁，保持你的依赖关系更新是一个好主意；但它们也可能带来突破性的变化。要检测它们，请确保您在一个新的、最近安装的环境中运行项目的测试。流程如下:

1.  从干净的虚拟环境开始
2.  安装依赖关系文件的依赖关系
3.  配置您的项目
4.  运行测试

最好是，在每次修改源代码时自动运行这个过程(这被称为持续集成)。如果这不是一个选项，定期手动运行上述步骤。

# **自动化项目设置和测试**

*TL；dr；使用 nox 和 pytest 在一个全新的环境中运行您的测试，打包您的项目，这样您就可以轻松地在您的测试中导入项目的模块*

我发现的自动化环境设置和测试执行的最佳工具是 [nox](https://nox.thea.codes) 和 [pytest](https://pytest.org) 。

Nox 是一个 Python 包，可以自动创建 conda 环境，然后在该环境中运行您的测试:

*注意:在撰写本文时，nox(版本 2020.8.22)并不正式支持从 environment.yml 文件安装，但这种变通方法可以做到这一点，* [*单击此处*](https://github.com/theacodes/nox/issues/260) *了解更多信息。*

一旦您的环境准备好了，就包含启动测试套件的命令。我建议您使用 pytest，下面是一个测试文件的样子:

要执行上面文件中的测试，您只需在 nox 中运行`pytest`，这转化为添加:`session.run('pytest')`

到目前为止，我们已经完成了步骤 1、2 和 4。但是跳过了 3(配置项目)。正如您在前面的代码片段中看到的，为了测试您的代码，您必须使它可导入，最干净的方法是打包您的项目(要查看我们关于项目打包的帖子，[单击此处](https://ploomber.io/posts/packaging/))。

一旦你打包了你的项目，你就可以用`pip install path/to/project`来设置它。

# **测试您的开发和生产环境**

*TL；dr；开发单独的测试套件，您可以在一个具有开发依赖关系的环境中测试您的开发管道，并为 API 提供生产依赖关系。*

您可以使用 nox 分别测试您的开发和生产环境。下面是一些示例代码:

要运行您的测试，只需在终端中执行`nox`。

# **锁定文件**

*TL；dr；提供自动生成的锁文件，其中包含带有固定版本的开发/生产依赖项列表，以避免将来由于 API 更改而中断您的项目。*

如果不固定特定的版本，就无法知道求解器将安装的确切版本集，这对于开发目的来说很好，因为它给了您尝试新版本并检查是否可以升级它们的机会，但是您不希望在生产环境中出现这种不确定性。

解决这个问题的方法是提供另一个文件，该文件列出了所有的依赖项，但包括特定的版本，这被称为*锁文件*。这样，您的环境将始终解析为同一组版本。

您可以使用以下命令生成具有固定依赖关系的文件:

输出文件如下所示:

锁文件对于保证生产中的确定性环境非常重要，请确保从您已经测试过的环境中生成它们。例如，您可以在测试会话结束时添加`conda env export`命令:

除了固定版本之外，锁文件通常还提供其他功能，例如对每个包进行哈希处理，并将其与下载版本进行比较，以防止安装被篡改的软件。在撰写本文时，有一个名为 [conda-lock](https://github.com/conda-incubator/conda-lock) 的新项目，旨在改进对 conda 锁文件的支持。

# **闭幕词**

在你的项目中使用虚拟环境是开发更健壮的管道的第一步，但这并不是结束。将依赖项安装作为测试过程的一部分，保持较小的依赖项，将生产依赖项与开发依赖项分开，并提供锁文件，这些都是确保您的项目具有健壮设置的必要步骤。

*最初发布于*[*http://ploomber . io*](https://ploomber.io/posts/dependencies/)