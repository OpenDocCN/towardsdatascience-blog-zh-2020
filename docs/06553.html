<html>
<head>
<title>Introducing 3D ggplots with Rayshader (R)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Rayshader (R)介绍 3D ggplots</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introducing-3d-ggplots-with-rayshader-r-c61e27c6f0e9?source=collection_archive---------25-----------------------#2020-05-24">https://towardsdatascience.com/introducing-3d-ggplots-with-rayshader-r-c61e27c6f0e9?source=collection_archive---------25-----------------------#2020-05-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="41b9" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/video-tutorial" rel="noopener" target="_blank">视频教程</a></h2><div class=""/><div class=""><h2 id="8eb9" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在 3D 绘图中显示香港房价</h2></div><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="kw kx l"/></div></figure><p id="122d" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Rayshader 是一个强大的 R 包，支持 2D 和 3D 数据可视化。让我惊讶的是它显示 3D 图的细节，它提供了很多定制。最重要的是，它允许您直接将 ggplot2 对象转换为 3D 绘图。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lu"><img src="../Images/9e4da0aaf3ab7b334d7b359aca51de8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3PYu9j-Pz-pPvoSKmBGKrA.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">照片由<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank"> cyda </a></p></figure><p id="235f" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本演示中，使用了香港人口和房价数据。预处理数据和 R 脚本上传到<a class="ae mf" href="https://github.com/cydalytics/HK_Properties_Price_Distribution" rel="noopener ugc nofollow" target="_blank">我的 Github repo </a>。请随意下载并试玩。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/09f476bf48dc0c708fc8ad952b456376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*oDmf2l-Cbwm5_0CtLXcRPw.gif"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">照片由<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank"> cyda </a></p></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="baa9" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">包裹</h1><p id="9fe0" class="pw-post-body-paragraph ky kz it la b lb ng kd ld le nh kg lg lh ni lj lk ll nj ln lo lp nk lr ls lt im bi translated">光线着色器</p><h1 id="5e31" class="mo mp it bd mq mr nl mt mu mv nm mx my ki nn kj na kl no km nc ko np kp ne nf bi translated">功能</h1><p id="011d" class="pw-post-body-paragraph ky kz it la b lb ng kd ld le nh kg lg lh ni lj lk ll nj ln lo lp nk lr ls lt im bi translated"><code class="fe nq nr ns nt b">rayshader</code>是一个用于在 R 中生成 2D 和 3D 数据可视化的开源包。<code class="fe nq nr ns nt b">rayshader</code>使用基本 R 矩阵中的高程数据以及光线跟踪、球形纹理映射、叠加和环境遮挡的组合来生成美丽的地形 2D 和 3D 地图。除了地图，<code class="fe nq nr ns nt b">rayshader</code>还允许用户将<code class="fe nq nr ns nt b">ggplot2</code>物体翻译成漂亮的 3D 数据可视化。</p><p id="09ca" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">模型可以旋转并交互检查，或者可以编写摄像机移动脚本来创建动画。也可以使用高质量的路径跟踪器<code class="fe nq nr ns nt b">rayrender</code>来渲染场景。用户还可以创建电影景深后处理效果，将用户的注意力引导到图中的重要区域。3D 模型也可以通过内置的 STL 导出功能导出为 3D 可打印格式。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="8c78" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">示范</h1><ol class=""><li id="e278" class="nu nv it la b lb ng le nh lh nw ll nx lp ny lt nz oa ob oc bi translated">用<code class="fe nq nr ns nt b">ggplot2</code>生成 2D 地图</li><li id="3c0a" class="nu nv it la b lb od le oe lh of ll og lp oh lt nz oa ob oc bi translated">用<code class="fe nq nr ns nt b">rayshader</code>将 2D 图转换成 3D 图</li></ol><h1 id="07e0" class="mo mp it bd mq mr nl mt mu mv nm mx my ki nn kj na kl no km nc ko np kp ne nf bi translated">数据</h1><p id="caba" class="pw-post-body-paragraph ky kz it la b lb ng kd ld le nh kg lg lh ni lj lk ll nj ln lo lp nk lr ls lt im bi translated">人口数据. xlsx</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/24ff61d8fe15215dce132ea496489d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*Kv4lazJb4deB7prs6rbBLA.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">照片由<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank"> cyda </a></p></figure><p id="587c" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">real_estate_master_df.csv</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oj"><img src="../Images/305332fe7cefb2ae548ed0820a5efddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lyYOlQ_qlQ7hclANQJTCtA.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">照片由<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank"> cyda </a></p></figure><p id="c940" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jd">任务一:用</strong> <code class="fe nq nr ns nt b"><strong class="la jd">ggplot2</strong></code>生成 2D 地图</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="c94b" class="oo mp it nt b gy op oq l or os">library(sp)<br/>hkmap = readRDS("HKG_adm1.rds") # geo data of HK map</span><span id="dc03" class="oo mp it nt b gy ot oq l or os"># Preprocessing<br/>map_data = data.frame(id=hkmap$ID_1, Code=hkmap$HASC_1, Eng_name=hkmap$NAME_1)<br/>map_data$Code = gsub('HK.', '', as.character(map_data$Code))<br/>map_data = merge(map_data, district_name, by = 'Eng_name')<br/>hkmapdf = fortify(hkmap)<br/>map_data = merge(hkmapdf, map_data, by="id")<br/>map_data = merge(map_data, population, by = "Chi_name")<br/>map_data$Population = as.numeric(map_data$Population)</span><span id="7c8c" class="oo mp it nt b gy ot oq l or os">library(ggplot2)<br/># Map<br/>map_bg = ggplot(map_data, aes(long, lat, group=group, fill = Population)) +<br/>  geom_polygon() + # Shape<br/>  scale_fill_gradient(limits=range(map_data$Population), <br/>                      low="#FFF3B0", high="#E09F3E") + <br/>  layer(geom="path", stat="identity", position="identity", <br/>       mapping=aes(x=long, y=lat, group=group, <br/>                   color=I('#FFFFFF'))) + <br/>  theme(legend.position = "none", <br/>        axis.line=element_blank(), <br/>        axis.text.x=element_blank(), axis.title.x=element_blank(),<br/>        axis.text.y=element_blank(), axis.title.y=element_blank(),<br/>        axis.ticks=element_blank(), <br/>        panel.background = element_blank()) # Clean Everything<br/>map_bg</span><span id="4edd" class="oo mp it nt b gy ot oq l or os"># Save as PNG<br/>xlim = ggplot_build(map_bg)$layout$panel_scales_x[[1]]$range$range<br/>ylim = ggplot_build(map_bg)$layout$panel_scales_y[[1]]$range$range<br/>ggsave('map_bg1.png', width = diff(xlim)*100, height = diff(ylim)*100, units = "cm")</span></pre><p id="7340" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">逐步解释:</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="ef22" class="oo mp it nt b gy op oq l or os">hkmap = readRDS("HKG_adm1.rds") # geo data of HK map</span></pre><p id="4b3c" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要绘制任何地区的地图，您需要手头有位置数据。请先从<a class="ae mf" href="https://github.com/cydalytics/HK_Properties_Price_Distribution" rel="noopener ugc nofollow" target="_blank"> Github repo </a>下载 rds 文件。</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="94b1" class="oo mp it nt b gy op oq l or os">library(ggplot2)<br/># Map<br/>map_bg = ggplot(map_data, aes(long, lat, group=group, fill = Population)) +<br/>  geom_polygon() + # Shape<br/>  scale_fill_gradient(limits=range(map_data$Population), <br/>                      low="#FFF3B0", high="#E09F3E") + <br/>  layer(geom="path", stat="identity", position="identity", <br/>       mapping=aes(x=long, y=lat, group=group, <br/>                   color=I('#FFFFFF')))</span></pre><p id="c33d" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">ggplot2 是另一个很棒的 R 包，它提供了很多种类的图表，像条形图、饼状图、热图…你能想到的。在上面显示的脚本中，主要做了两件事。在线<em class="ou"> scale_fill_gradient </em>上，地图中显示的多边形根据人口数据用颜色填充。颜色较深的地区意味着人口较多。然后，<em class="ou">层</em>给每个区域一条边界线，就是显示的白线。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ov"><img src="../Images/14742115cb7e7f6090378facc552a318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LC99Vz5GyL5sxWXQLjKEsA.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">照片由<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank"> cyda </a></p></figure><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="1a89" class="oo mp it nt b gy op oq l or os">map_bg + <br/>  theme(legend.position = "none", <br/>        axis.line=element_blank(), <br/>        axis.text.x=element_blank(), axis.title.x=element_blank(),<br/>        axis.text.y=element_blank(), axis.title.y=element_blank(),<br/>        axis.ticks=element_blank(), <br/>        panel.background = element_blank()) # Clean Everything<br/>map_bg</span></pre><p id="f1fd" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建此图的原因是为我们将在任务 2 中完成的 3D 图准备背景图像。因此，我用<em class="ou">主题</em>去掉了所有的网格线，x 轴和 y 轴。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ow"><img src="../Images/abd3dddec0e2f9366a2860420b3f7838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-lJE4dIiNAGdJXDYAmIGw.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">输出:map_bg.png</p></figure><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="2ae2" class="oo mp it nt b gy op oq l or os"># Save as PNG<br/>xlim = ggplot_build(map_bg)$layout$panel_scales_x[[1]]$range$range<br/>ylim = ggplot_build(map_bg)$layout$panel_scales_y[[1]]$range$range<br/>ggsave(‘map_bg.png’, width = diff(xlim)*40, height = diff(ylim)*40, units = “cm”)</span></pre><p id="e95f" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，<em class="ou"> ggsave </em>用于导出 map_bg，其比例与绘图坐标一致。</p><p id="28b5" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jd">任务 2:用</strong> <code class="fe nq nr ns nt b"><strong class="la jd">rayshader</strong></code>将 2D 图转换成 3D 图</p><p id="a71d" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">real _ estate _ master _ df.csv 的数据是从<a class="ae mf" href="https://app2.hkp.com.hk/tx/default.jsp?lang=zh%27" rel="noopener ugc nofollow" target="_blank">香港房产</a>刮来的。</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="f372" class="oo mp it nt b gy op oq l or os"># 2D Plot<br/>library(ggplot2)<br/>library(grid)<br/>estate_price = ggplot(estate_df) + <br/>  annotation_custom(rasterGrob(hk_map_bg, width=unit(1,"npc"), <br/>                               height=unit(1,"npc")), <br/>                    -Inf, Inf, -Inf, Inf) + <br/>  xlim(xlim[1],xlim[2]) + # x-axis Mapping<br/>  ylim(ylim[1],ylim[2]) + # y-axis Mapping<br/>  geom_point(aes(x=Longitude, y=Latitude, color=apr_price),size=2) + <br/>  scale_colour_gradient(name = '成交呎價(實)\n(HKD)', <br/>                        limits=range(estate_df$apr_price), <br/>                        low="#FCB9B2", high="#B23A48") + <br/>  theme(axis.line=element_blank(), <br/>        axis.text.x=element_blank(), axis.title.x=element_blank(),<br/>        axis.text.y=element_blank(), axis.title.y=element_blank(),<br/>        axis.ticks=element_blank(), <br/>        panel.background = element_blank()) # Clean Everything<br/>estate_price</span></pre><p id="b8b3" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">逐步解释:</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="ace8" class="oo mp it nt b gy op oq l or os">  annotation_custom(rasterGrob(hk_map_bg, width=unit(1,"npc"), <br/>                               height=unit(1,"npc")), <br/>                    -Inf, Inf, -Inf, Inf) + <br/>  xlim(xlim[1],xlim[2]) + # x-axis Mapping<br/>  ylim(ylim[1],ylim[2]) + # y-axis Mapping</span></pre><p id="2038" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ou"> annotation_custom </em>用于将准备好的地图背景图像导入到绘图中。<em class="ou"> xlim(xlim[1]，xlim[2]) </em>和<em class="ou"> ylim(ylim[1]，ylim[2]) </em>固定地块的 x 轴和 y 轴，使其与 map_bg 相同。</p><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="0eca" class="oo mp it nt b gy op oq l or os">geom_point(aes(x=Longitude, y=Latitude, color=apr_price),size=2) + <br/>  scale_colour_gradient(name = '成交呎價(實)\n(HKD)', <br/>                        limits=range(estate_df$apr_price), <br/>                        low="#FCB9B2", high="#B23A48") +</span></pre><p id="ff76" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ou"> geom_point </em>将房地产价格的数据点添加到绘图中。</p><p id="eed2" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ou"> scale_colour_gradient </em>根据变量“apr_price”用颜色填充数据点，请注意这里使用的函数与任务 1 中使用的不同。(<em class="ou">几何点的比例颜色渐变</em>，几何多边形的比例填充渐变<em class="ou"/></p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ov"><img src="../Images/7135e968b75e2bd1b9433733a27815cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHvRBAaHjkji78ikzJ6EVA.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">cyda 拍摄的照片</p></figure><pre class="kr ks kt ku gt ok nt ol om aw on bi"><span id="e5b0" class="oo mp it nt b gy op oq l or os"># 3D Plot<br/>library(rayshader)<br/>plot_gg(estate_price, multicore = TRUE, width = diff(xlim)*10 ,height=diff(ylim)*10, fov = 70, scale = 300)</span><span id="a583" class="oo mp it nt b gy ot oq l or os"># Close Windows<br/>rgl.close()</span></pre><p id="1ae8" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将 2D 图转换为 3D 图的脚本非常简单。3D 绘图显示在 rgl 窗口中。不过，看完剧情记得关窗。由于 rgl 窗口的输出不会被删除，所以下一个图将与前一个图重叠。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/74e75cee2a1c433c8bea9e2919330d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*IL5B_a_CV1ZQpvSu8-pmgw.gif"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">cyda 拍摄的照片</p></figure><p id="3bec" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望你喜欢我的文章=)</p><p id="643a" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想了解更多使用 rayshader 的方法，请到 rayshader 的<a class="ae mf" href="https://www.rayshader.com" rel="noopener ugc nofollow" target="_blank">官网。</a></p><p id="1c41" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你觉得我的文章有用，请在<a class="ae mf" href="https://www.linkedin.com/in/carrielsc/" rel="noopener ugc nofollow" target="_blank">我的 linkedIn 页面</a>上为我的技能背书，鼓励我写更多的文章。</p><p id="2d96" class="pw-post-body-paragraph ky kz it la b lb lc kd ld le lf kg lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最初发表于<a class="ae mf" href="https://cydalytics.blogspot.com" rel="noopener ugc nofollow" target="_blank">cydalytics.blogspot.com</a></p></div></div>    
</body>
</html>