<html>
<head>
<title>Python Stock Analysis — Income Statement Waterfall chart</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python股票分析-损益表瀑布图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-stock-analysis-income-statement-waterfall-chart-ffb7f9a4687f?source=collection_archive---------13-----------------------#2020-01-25">https://towardsdatascience.com/python-stock-analysis-income-statement-waterfall-chart-ffb7f9a4687f?source=collection_archive---------13-----------------------#2020-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="784d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在这篇文章中，我展示了如何使用Python、Pandas和Plotly以瀑布图的形式显示损益表。</h2></div><p id="1771" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我将向你展示如何使用Python、Pandas和Plotly以瀑布图的形式显示损益表。</p><blockquote class="lb lc ld"><p id="8af1" class="kf kg le kh b ki kj jr kk kl km ju kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="iq">一个</em> <strong class="kh ir"> <em class="iq">瀑布图</em> </strong> <em class="iq">是一种表示数据的方式，以便可视化不同项目的累积效果。在我们的例子中，我们将能够看到每一个收益表行从收入到净收入的影响。</em></p></blockquote><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/91eec4e1679594fbfe7136d8f50c7eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wnBNicunZCx3-WKxJwndig.jpeg"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">照片由<a class="ae ly" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lz"> Pixabay </strong> </a>来自<a class="ae ly" href="https://www.pexels.com/photo/cascade-cliff-clouds-dawn-356831/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lz">像素</strong> </a></p></figure><p id="48d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将文章分为两部分，在第一部分，我们将从免费的财务API<a class="ae ly" href="https://financialmodelingprep.com/" rel="noopener ugc nofollow" target="_blank">Financialmodelingprep</a>中检索我们感兴趣的任何公司的损益表数据。然后，我们将使用Pandas来清理数据并执行一些基本操作。</p><p id="f90c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在文章的第二部分，我们将使用Plotly将损益表转换成一个<strong class="kh ir">漂亮的瀑布图</strong>表示。</p><p id="36f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你跟随这篇文章并和我一起编码，你将能够为你感兴趣的任何上市公司建立瀑布图。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ma"><img src="../Images/cb68f5dfdf1bb26a70e1ce2407f98368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aR8jO8zIRkmXY2TS"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">瀑布图形式的损益表— Python for Finance</p></figure><p id="bd0e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，让我们开始编码第一部分。我们需要导入<em class="le"> json </em>和<em class="le">请求</em>库，以便向API端点发出<em class="le"> GET </em>请求。我们还导入<em class="le"> Pandas </em>来将请求的数据转换成<em class="le"> Pandas DataFrame </em>，最后，我们将导入<em class="le"> Ploty </em>，这是我们将用来创建图表的库。</p><p id="4e92" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于所有不熟悉<a class="ae ly" href="https://plot.ly/python/" rel="noopener ugc nofollow" target="_blank"> Plotly </a>的人来说，这是一个免费的Python图形库，它提供了创建非常有吸引力的交互式图表的可能性。</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="04b6" class="mg mh iq mc b gy mi mj l mk ml">import plotly.express as px<br/>import plotly.graph_objects as go<br/>import pandas as pd<br/>import requests<br/>import json</span></pre><p id="0601" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导入所需的包后，我们开始创建我们的函数<em class="le"> selectquote </em>，我们将在其中添加将我们的数据转换成Pandas数据帧的逻辑。我们发出一个<em class="le"> http </em>请求，并将数据转换成<em class="le"> Json </em>，这样我们就可以用<em class="le"> Python </em>和<em class="le"> Pandas </em>轻松处理它。</p><p id="9cdc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，从通过API检索的信息中，我们将关键字<em class="le"> financials </em>的值存储到<em class="le"> stock </em>变量中。Financials包含一个字典列表，其中每个字典代表一个季度的损益表。</p><p id="d7ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们从<em class="le">股票</em>字典中创建一个Pandas数据框架，并对其进行转置，以便将损益表项目作为行，将日期作为标题。</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="72cc" class="mg mh iq mc b gy mi mj l mk ml">def selectquote(quote): <br/>   r= requests.get(f"https://financialmodelingprep.com/api/v3/financials/income-statement/{quote}?period=quarter") </span><span id="8304" class="mg mh iq mc b gy mm mj l mk ml">   r = r.json() <br/>   stock = r['financials']</span><span id="79a9" class="mg mh iq mc b gy mm mj l mk ml">   stock = pd.DataFrame.from_dict(stock) <br/>   stock = stock.T   <br/>   stock.columns = stock.iloc[0]<br/>   stock.reset_index(inplace=True) <br/>   return  stock </span><span id="e2c2" class="mg mh iq mc b gy mm mj l mk ml">selectquote('AAPL')</span></pre><p id="caea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，如果我们打印出我们的库存熊猫数据帧，我们会得到类似于下面的<em class="le">苹果</em>的结果，因为我们已经将<em class="le"> AAPL </em>传递给了我们的<em class="le">选择报价</em>函数。<strong class="kh ir">请注意，我们需要作为参数传递股票的代码，而不是全名</strong>。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ma"><img src="../Images/b78ebb5bb11a852129ee3a0b1f525621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2ci27RCvn8qioL0j"/></div></div></figure><p id="485e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们创建图表之前，还有一些东西需要清理。</p><p id="c27c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们将<em class="le">熊猫数据框</em>切片，只保留上一季度的损益表。然后，我们将列名重命名为股票名称，而不是日期。最后，我们将损益表信息(即列)转换成一个数字。</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="61fa" class="mg mh iq mc b gy mi mj l mk ml">stock = stock.iloc[:,0:2]</span><span id="1438" class="mg mh iq mc b gy mm mj l mk ml">stock.rename(columns={ stock.columns[1]: quote }, inplace = True)</span><span id="b39b" class="mg mh iq mc b gy mm mj l mk ml">cols = stock.columns.drop('index')</span><span id="0c74" class="mg mh iq mc b gy mm mj l mk ml">stock[cols] = stock[cols].apply(pd.to_numeric, errors='coerce')</span><span id="227d" class="mg mh iq mc b gy mm mj l mk ml">stock = stock.iloc[1:,]</span></pre><p id="9cd9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重新运行我们的代码后，我们可以看到苹果公司最新的季度收入报表:</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="5c21" class="mg mh iq mc b gy mi mj l mk ml">incomeStatement = selectquote('AAPL')<br/>print(incomeStatement)</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/ee4111ef99cb930c243e2399095eeb05.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/0*6ZWbVV2OVQfE9kI_"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">Python for Finance —损益表</p></figure><p id="1633" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">我们还需要提取</strong><strong class="kh ir"/><strong class="kh ir">收入、销货成本等的价值。从我们的库存熊猫数据框架</strong>以便在瀑布图中使用。我们可以很容易地用iloc找到损益表项目的价值。我们将费用乘以<em class="le"> -1 </em>，使其符合负号约定:</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="c57f" class="mg mh iq mc b gy mi mj l mk ml">Revenue = incomeStatement[incomeStatement['index'] == 'Revenue'].iloc[0][1]</span><span id="2927" class="mg mh iq mc b gy mm mj l mk ml">COGS = incomeStatement[incomeStatement['index'] == 'Cost of Revenue'].iloc[0][1]*-1</span><span id="0100" class="mg mh iq mc b gy mm mj l mk ml">grossProfit = incomeStatement[incomeStatement['index'] == '<!-- -->Gross Profit<!-- -->'].iloc[0][1]</span><span id="920b" class="mg mh iq mc b gy mm mj l mk ml">RD = incomeStatement[incomeStatement['index'] == 'R&amp;D Expenses'].iloc[0][1]*<em class="le">-1</em></span><span id="1d6a" class="mg mh iq mc b gy mm mj l mk ml"><em class="le">GA = </em>incomeStatement<em class="le">[</em>incomeStatement<em class="le">['index'] == 'SG&amp;A Expense'].iloc[0][1]</em>*-1</span><span id="53ac" class="mg mh iq mc b gy mm mj l mk ml">operatingExpenses = incomeStatement[incomeStatement['index'] == 'Operating Expenses'].iloc[0][1]*<em class="le">-1</em></span><span id="bcf1" class="mg mh iq mc b gy mm mj l mk ml"><em class="le">interest = </em>incomeStatement<em class="le">[</em>incomeStatement<em class="le">['index'] == 'Interest Expense'].iloc[0][1]</em>*-1</span><span id="b4ad" class="mg mh iq mc b gy mm mj l mk ml">EBT = incomeStatement[incomeStatement['index'] == 'Earnings before Tax'].iloc[0][1]</span><span id="abf5" class="mg mh iq mc b gy mm mj l mk ml">incTax = incomeStatement[incomeStatement['index'] == 'Income Tax Expense'].iloc[0][1]*-1</span><span id="08eb" class="mg mh iq mc b gy mm mj l mk ml">netIncome = incomeStatement[incomeStatement['index'] == 'Net Income'].iloc[0][1]</span></pre><p id="a6cc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了，我们已经完成了代码的第一部分。现在，<strong class="kh ir">让我们进入有趣的部分，我们将创建一个瀑布图</strong>。</p><p id="3651" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们将创建一个<em class="le">图</em> <em class="le">对象</em>，它将包含构建图表所需的数据点。<strong class="kh ir">对于瀑布图</strong>，我们将需要一个度量列表，其中我们将指出每个变量是相对<em class="le">度量还是总<em class="le">度量。这将影响图表的构建方式。例如，毛利将是一个总的衡量标准，它将从图表的底部开始。</em></em></p><p id="8fa5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们将有我们的<strong class="kh ir"> <em class="le"> x </em> </strong>轴，它将包含损益表项目的名称，最后，我们的<em class="le"> y </em>将包含与每个x相关联的值。此外，我们将有一个文本列表，其中包含我们希望在图表中显示的每个项目的值。</p><p id="ffe4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将文本除以100，000来表示以百万计的数字。</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="d7f7" class="mg mh iq mc b gy mi mj l mk ml">fig = go.Figure(go.Waterfall(</span><span id="02d7" class="mg mh iq mc b gy mm mj l mk ml">name = "20", orientation = "v",</span><span id="6ffd" class="mg mh iq mc b gy mm mj l mk ml">measure = ["relative", "relative", "total", "relative", "relative", "total","relative","total","relative","total"],</span><span id="75a8" class="mg mh iq mc b gy mm mj l mk ml">x = ["Revenue", "COGS", "Gross Profit", "RD", "G&amp;A", "Operating Expenses","Interest Expense", "Earn Before Tax","Income Tax","Net Income"],</span><span id="9c49" class="mg mh iq mc b gy mm mj l mk ml">textposition = "outside",</span><span id="4ea3" class="mg mh iq mc b gy mm mj l mk ml">text = [Revenue/100000, COGS/100000, <!-- -->grossProfit/100000<!-- -->, RD/100000, GA/1000000, <!-- -->operatingExpenses/1000000,Interest/100000, EBT/100000,incTax/100000, NetIncome/100000<!-- -->],</span><span id="6aca" class="mg mh iq mc b gy mm mj l mk ml">y = [Revenue, COGS, <!-- -->grossProfit<!-- -->, RD, GA, <!-- -->operatingExpenses, Interest,EBT, incTax, NetIncome<!-- -->], </span><span id="1d8b" class="mg mh iq mc b gy mm mj l mk ml">connector = {"line":{"color":"rgb(63, 63, 63)"}}, )) </span><span id="196e" class="mg mh iq mc b gy mm mj l mk ml">fig.update_layout( <br/>title = "Profit and loss statement",<br/>showlegend = <strong class="mc ir">True</strong> ) </span><span id="1230" class="mg mh iq mc b gy mm mj l mk ml">fig.show()</span></pre><p id="509f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果我们运行代码，我们可以看到苹果公司的收益表是一个瀑布图:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ma"><img src="../Images/b786b73ac357bc0a5afcbf29865e1833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OVz2C8B9gCjjTqz1"/></div></div></figure><p id="98ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自己尝试使用不同的股票，只需将所需公司的股票代码作为参数传递给<em class="le"> selectquote </em>函数。</p><p id="719e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面看到完整的代码供你参考。请注意，您需要安装教程中使用的所有库。否则，代码将不起作用。</p><pre class="lj lk ll lm gt mb mc md me aw mf bi"><span id="991d" class="mg mh iq mc b gy mi mj l mk ml">import plotly.express as px<br/>import plotly.graph_objects as go<br/>import pandas as pd<br/>import requests<br/>import json<br/><br/>def selectquote(quote):<br/>     r= requests.get(f"https://financialmodelingprep.com/api/v3/financials/income-statement/{quote}?period=quarter")<br/>     r = r.json()<br/>    stock = r['financials']<br/>    stock = pd.DataFrame.from_dict(stock)<br/>    stock = stock.T<br/>    stock.columns = stock.iloc[0]<br/>    stock.reset_index(inplace=True)<br/>    stock = stock.iloc[:,0:2]<br/>    stock.rename(columns={ stock.columns[1]: quote }, inplace = True)<br/>    cols = stock.columns.drop('index')<br/>    stock[cols] = stock[cols].apply(pd.to_numeric, errors='coerce')<br/>    stock = stock.iloc[1:,]<br/>    return stock<br/><br/>incomeStatement = selectquote('AAPL')</span><span id="4d79" class="mg mh iq mc b gy mm mj l mk ml">Revenue = incomeStatement[incomeStatement['index'] == 'Revenue'].iloc[0][1]</span><span id="6a84" class="mg mh iq mc b gy mm mj l mk ml">COGS = incomeStatement[incomeStatement['index'] == 'Cost of Revenue'].iloc[0][1]*-1</span><span id="6ca2" class="mg mh iq mc b gy mm mj l mk ml">grossProfit = incomeStatement[incomeStatement['index'] == 'Gross Profit'].iloc[0][1] </span><span id="2179" class="mg mh iq mc b gy mm mj l mk ml">RD = incomeStatement[incomeStatement['index'] == 'R&amp;D Expenses'].iloc[0][1]*-1 </span><span id="bcb2" class="mg mh iq mc b gy mm mj l mk ml">GA = incomeStatement[incomeStatement['index'] == 'SG&amp;A Expense'].iloc[0][1]*-1</span><span id="b8c1" class="mg mh iq mc b gy mm mj l mk ml">operatingExpenses = incomeStatement[incomeStatement['index'] == 'Operating Expenses'].iloc[0][1]*-1 </span><span id="2493" class="mg mh iq mc b gy mm mj l mk ml">interest = incomeStatement[incomeStatement['index'] == 'Interest Expense'].iloc[0][1]*-1</span><span id="1f6d" class="mg mh iq mc b gy mm mj l mk ml">EBT = incomeStatement[incomeStatement['index'] == 'Earnings before Tax'].iloc[0][1]</span><span id="ee62" class="mg mh iq mc b gy mm mj l mk ml">incTax = incomeStatement[incomeStatement['index'] == 'Income Tax Expense'].iloc[0][1]*-1</span><span id="cdf0" class="mg mh iq mc b gy mm mj l mk ml">netIncome = incomeStatement[incomeStatement['index'] == 'Net Income'].iloc[0][1] <br/><br/>fig = go.Figure(go.Waterfall(<br/>    name = "20", orientation = "v",</span><span id="fd56" class="mg mh iq mc b gy mm mj l mk ml">    measure = ["relative", "relative", "total", "relative", "relative", "total","relative","total","relative","total"],<br/><br/>    x = ["Revenue", "COGS", "Gross Profit", "RD", "G&amp;A", "Operating Expenses","Interest Expense", "Earn Before Tax","Income Tax","Net Income"],</span><span id="992d" class="mg mh iq mc b gy mm mj l mk ml">    textposition = "outside",<br/><br/>    text = [Revenue/100000, COGS/100000, grossProfit/100000, RD/100000, GA/1000000, operatingExpenses/1000000,Interest/100000, EBT/100000,incTax/100000, NetIncome/100000],<br/><br/>     y = [Revenue, COGS, grossProfit, RD, GA, operatingExpenses, Interest,EBT,incTax,NetIncome],<br/><br/>    connector = {"line":{"color":"rgb(63, 63, 63)"}},<br/>     <br/>fig.update_layout(<br/>         title = "Profit and loss statement",<br/>         showlegend = True<br/> )))<br/><br/>fig.show()</span></pre><p id="64b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我创建了下面的Youtube视频，我一步一步地建立瀑布图。如果您在理解本文中的代码时遇到困难，这是值得一查的。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="mo mp l"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">损益表的瀑布图— Python for Finance</p></figure><p id="ff80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="le">原载于</em>【https://codingandfun.com】<em class="le"/></p></div></div>    
</body>
</html>