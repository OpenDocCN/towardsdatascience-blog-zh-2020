<html>
<head>
<title>Implementing a Contactless On-Demand Trigger for the Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为云实施非接触式按需触发</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/implementing-a-contactless-on-demand-trigger-for-the-cloud-656bcb6495eb?source=collection_archive---------75-----------------------#2020-06-29">https://towardsdatascience.com/implementing-a-contactless-on-demand-trigger-for-the-cloud-656bcb6495eb?source=collection_archive---------75-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/ec2a3e10cbc73218e81acbaccd4d741e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HXJw_wshWiQB41B4"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@lyvjaan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">lÿv·贾恩</a>在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><div class=""/><div class=""><h2 id="6fb7" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">使用电子邮件让人们远离你的基础设施</h2></div><p id="2b5e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博文中，我将向您展示 AWS 上按需触发器的一种可能实现。为了让你能够修补架构，我在 GitHub 上公布了代码来重现例子<a class="ae jg" href="https://github.com/timo-boehm/email-trigger-for-aws" rel="noopener ugc nofollow" target="_blank">。我还在整篇文章中包含了代码片段，以帮助您了解实现细节。</a></p><blockquote class="lu lv lw"><p id="2db9" class="ky kz lx la b lb lc kk ld le lf kn lg ly li lj lk lz lm ln lo ma lq lr ls lt im bi translated"><strong class="la jk">注意:</strong>这种方法并不是蓝图，更不是最佳实践架构。相反，它旨在提供一些关于云的可能性以及实际实现情况的见解。建造它也很有趣。</p></blockquote></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="9adc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">即将到来的模式涵盖了两个主要的功能需求:</p><ol class=""><li id="4cd0" class="mi mj jj la b lb lc le lf lh mk ll ml lp mm lt mn mo mp mq bi translated">我们的<strong class="la jk">客户</strong> <strong class="la jk">希望在他们认为有必要时触发计算</strong>。然而，他们拒绝等待人工支持，既不是联系人的形式，也不是售票系统。另一方面，我们绝对无意让他们直接访问我们宝贵的云。因此，我们需要实现一种允许自动触发而无需访问实际基础设施的机制。</li><li id="7b54" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt mn mo mp mq bi translated">此外，<strong class="la jk">我们希望每次客户触发计算时都能得到通知</strong>。根据经验，当人们使用我们的产品时，问题往往会出现，如果有必要，我们希望做好灭火的准备。</li></ol><p id="ec19" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博文中，我展示了一个使用电子邮件端点来满足这两种需求的解决方案。客户可以向 AWS 管理的地址写一条消息，然后触发计算。让我给你看看细节。</p><blockquote class="lu lv lw"><p id="c2f5" class="ky kz lx la b lb lc kk ld le lf kn lg ly li lj lk lz lm ln lo ma lq lr ls lt im bi translated"><strong class="la jk">注意:</strong>在 AWS 中验证一个域超出了本文的范围，但是需要使用 AWS 电子邮件服务。有关如何操作的信息，请参见此处的<a class="ae jg" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/receiving-email-getting-started.html" rel="noopener ugc nofollow" target="_blank">和此处的</a>和<a class="ae jg" href="https://medium.com/trlogic/email-forwarding-with-aws-ses-simple-email-service-fea7b242f4b3" rel="noopener"/>。</p></blockquote></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="ce73" class="mw mx jj bd my mz na nb nc nd ne nf ng kp nh kq ni ks nj kt nk kv nl kw nm nn bi translated">整体架构</h1><p id="c6aa" class="pw-post-body-paragraph ky kz jj la b lb no kk ld le np kn lg lh nq lj lk ll nr ln lo lp ns lr ls lt im bi translated">为了满足需求，我们需要实现三个功能:</p><ol class=""><li id="6be7" class="mi mj jj la b lb lc le lf lh mk ll ml lp mm lt mn mo mp mq bi translated">我们需要实现一个接收邮件的<strong class="la jk">电子邮件地址</strong>。</li><li id="0987" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt mn mo mp mq bi translated">我们需要一个<strong class="la jk">协调机制</strong>，它对收到的邮件做出反应，并触发所需的计算。我们使用相同的机制来满足监控需求。</li><li id="4838" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt mn mo mp mq bi translated">我们需要一个实际的<strong class="la jk">计算</strong>发生的地方。</li></ol><p id="f9eb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些功能都转化为 AWS 生态系统中的一项服务:</p><ul class=""><li id="d199" class="mi mj jj la b lb lc le lf lh mk ll ml lp mm lt nt mo mp mq bi translated"><strong class="la jk">简单电子邮件服务(SES) </strong>接收并转发来自外部的邮件。为此，我们需要实现一个合适的<strong class="la jk">规则</strong>。</li><li id="5840" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated"><strong class="la jk">简单通知服务(SNS)主题</strong>接受转发的邮件并继续传递。由于 SNS 向所有订阅者推送消息，我们不需要实现轮询机制。</li><li id="65d1" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated"><strong class="la jk"> Lambda 的无服务器函数</strong>处理我们想要用我们的架构触发的任何事情。</li></ul><p id="8905" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是这种简单架构的图形概述:</p><figure class="nv nw nx ny gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nu"><img src="../Images/9e21a8900526d4318b8ef7dc3ae02b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3-gsR9ZddFqSdbTAwjw5eg.png"/></div></div></figure><p id="296b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接收端和处理逻辑通过 SNS 主题连接。SNS 主题通过发布/订阅模式工作。即 SES 将收到的邮件发布到 SNS 主题；Lambda 函数通过订阅自动接收它们。</p><p id="a27c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博文中，我展示了在<strong class="la jk"> Terraform </strong>中的实现，但是你也可以通过 web 接口或者 CloudFormation 来实现这个架构。如果您以前没有使用 Terraform 的经验，请查看<a class="ae jg" href="https://learn.hashicorp.com/terraform" rel="noopener ugc nofollow" target="_blank">他们的介绍材料，</a>或者忽略细节。请注意，当您使用 web 界面时，AWS 会在后台配置一些细节。这很方便，但是一旦需要调试基础设施，可能会有问题。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="4814" class="mw mx jj bd my mz na nb nc nd ne nf ng kp nh kq ni ks nj kt nk kv nl kw nm nn bi translated">实施细节</h1><p id="5b13" class="pw-post-body-paragraph ky kz jj la b lb no kk ld le np kn lg lh nq lj lk ll nr ln lo lp ns lr ls lt im bi translated">在开始定义资源之前，我们需要向 Terraform 提供提供者的详细信息。也就是说，我们需要定义一个<em class="lx">轮廓</em>和一个<em class="lx">区域</em>。在撰写本文时，只有三个地区允许通过 SES 接收电子邮件。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="e67e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我还为这个脚本定义了<em class="lx"> </em>两个局部变量:<em class="lx"> common_tags </em>和<em class="lx"> open_email </em>。<em class="lx"> open_email </em>是稍后可用于触发计算的那个。这些主要是为了方便和清晰。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="d4f1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们深入研究我们架构的三个服务。</p><h2 id="f7b3" class="ob mx jj bd my oc od dn nc oe of dp ng lh og oh ni ll oi oj nk lp ok ol nm om bi translated">简单电子邮件服务</h2><p id="6776" class="pw-post-body-paragraph ky kz jj la b lb no kk ld le np kn lg lh nq lj lk ll nr ln lo lp ns lr ls lt im bi translated">让 SES 工作的两个必要组件是一个<strong class="la jk">规则集</strong>和一个<strong class="la jk">规则</strong>。请将规则集视为系统使用的所有规则的总称。作为旁注，确保规则集是活动的。根据您的设置，可能已经有了默认的规则集。Terraform 有两个不同的资源，所以请确保使用正确的资源，即名称中带有<em class="lx">活动</em>的资源。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="bbd9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">规则</strong>定义接收电子邮件地址、它所属的规则集以及它触发的操作类型。在我们的例子中，我们使用一个<strong class="la jk"> SNS 动作</strong>，它将邮件转发给一个<strong class="la jk"> SNS 主题</strong>。</p><p id="fdcc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还有 Lambda 操作，我们可以用它来创建一个直接链接，而不需要使用 SNS。然而，这些动作<a class="ae jg" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/receiving-email-action-lambda-event.html" rel="noopener ugc nofollow" target="_blank">不接收消息体，只接收消息头</a>。如果你需要身体，或者如果你预计在某个时候你需要它，SNS 行动是正确的选择。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="2012" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您可以从<em class="lx">位置</em>参数中推断出的，在一个规则中应用几个不同的动作是可能的。</p><h2 id="d543" class="ob mx jj bd my oc od dn nc oe of dp ng lh og oh ni ll oi oj nk lp ok ol nm om bi translated">简单通知服务(SNS)</h2><p id="8d0a" class="pw-post-body-paragraph ky kz jj la b lb no kk ld le np kn lg lh nq lj lk ll nr ln lo lp ns lr ls lt im bi translated">我们的设计使用两个<strong class="la jk"> SNS 主题</strong>。SES 使用第一个来发布收到的电子邮件。第二个通知产品团队谁触发了新的计算。创建它们的唯一必要参数是主题的名称:</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="c447" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SNS 在设计上是非常轻量级的。也就是说，配置工作主要发生在发布或订阅其主题的服务上。</p><blockquote class="lu lv lw"><p id="fe92" class="ky kz lx la b lb lc kk ld le lf kn lg ly li lj lk lz lm ln lo ma lq lr ls lt im bi translated"><strong class="la jk">注意</strong>:您不能使用 Terraform 订阅 SNS 主题的电子邮件地址，因为它们必须经过验证(<a class="ae jg" href="https://www.terraform.io/docs/providers/aws/r/sns_topic_subscription.html" rel="noopener ugc nofollow" target="_blank">详情</a>)。</p></blockquote><h2 id="0d7b" class="ob mx jj bd my oc od dn nc oe of dp ng lh og oh ni ll oi oj nk lp ok ol nm om bi translated">希腊字母的第 11 个</h2><p id="c47b" class="pw-post-body-paragraph ky kz jj la b lb no kk ld le np kn lg lh nq lj lk ll nr ln lo lp ns lr ls lt im bi translated">对于我们的目的，单个<strong class="la jk">λ函数</strong>就足够了。无服务器功能在计算能力方面有限制，所以您可以考虑切换到其他选项。但是，使用它们作为工作流的入口点通常是一种好的做法。考虑到这一点，让我们来看看启动和运行该功能的不同部分。</p><p id="09f6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们以 ZIP 文件的形式为该功能提供了<strong class="la jk">代码</strong>。幸运的是，Terraform 有一个<em class="lx">数据</em>类型来涵盖这一点。我们所要做的就是定义源文件和目标文件。我在 GitHub repo 中提供了一个基本函数。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="deca" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该功能还需要一个<strong class="la jk">角色</strong>和一个<strong class="la jk">附属策略</strong>才能工作。在这个例子中，我们希望它向<strong class="la jk"> CloudWatch </strong>写入日志，并向一个<strong class="la jk"> SNS 主题</strong>发布信息，以通知产品团队。正如您在代码中看到的，将策略附加到角色是一个单独的资源。该策略需要涵盖 Lambda 函数完成工作所需的一切。例如，如果您想将信息写入 S3 存储桶，您需要扩展策略。</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="6493" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">函数资源的<strong class="la jk">规范</strong>看起来相当吓人。让我依次向您介绍每个参数:</p><ul class=""><li id="2988" class="mi mj jj la b lb lc le lf lh mk ll ml lp mm lt nt mo mp mq bi translated"><strong class="la jk">文件名</strong>指向包含代码的 ZIP 文件。</li><li id="63ae" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated">Terraform 比较<strong class="la jk">源代码散列</strong>来检测代码库的变化。幸运的是，<em class="lx">数据</em>资源自动提供了这个散列。</li><li id="7534" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated"><strong class="la jk">处理程序</strong>是 Lambda 函数在被触发时执行的代码中的函数名。<a class="ae jg" href="https://docs.aws.amazon.com/lambda/latest/dg/python-handler.html" rel="noopener ugc nofollow" target="_blank">这里的</a>是关于 Python 的信息，但是文档也涵盖了 Node.js、Ruby、Java 等等。</li><li id="4fe0" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated">角色是我们上面定义的执行角色。</li><li id="563d" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated"><strong class="la jk">运行时</strong>告诉 AWS 你的代码想要使用哪种编程语言和版本<em class="lx">标识符</em>所有可用的运行时都在官方文档中列出<a class="ae jg" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="303f" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated"><strong class="la jk">环境变量</strong>为你的函数代码提供额外的信息。在我们的示例中，我们使用这样一个变量来传递 SNS 主题的 ARN 进行监控。</li></ul><p id="54da" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有这些参数的组合如下所示:</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="f88d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">剩下的就是触发 SNS 主题和 Lambda 函数之间的连接。要建立这个链接，我们需要实现两个资源:<strong class="la jk">SNS 执行 Lambda 的权限</strong>和对 SNS 主题的 Lambda 函数的一个<strong class="la jk">订阅</strong>。权限是允许 Lambda 订阅 SNS 主题的先决条件。请将许可视为一种特殊类型的策略。</p><p id="dd7a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">权限</strong>是一个独特的资源，在 Terraform 中是这样的:</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="cefe" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一方面，<strong class="la jk">订阅</strong>是一个通用资源，我们定义它应用于 Lambda。也就是说，我们将 Lambda 函数配置为其<em class="lx">端点</em> <strong class="la jk"> <em class="lx"> </em> </strong>，并相应地调整<em class="lx">协议</em>:</p><figure class="nv nw nx ny gt iv"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="edf8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些资源涵盖了整个架构。你可以从这里克隆必要的代码<a class="ae jg" href="https://github.com/timo-boehm/email-trigger-for-aws" rel="noopener ugc nofollow" target="_blank">。如果你已经在 AWS 注册了一个域名，启动一切需要几秒钟。现在，您可以通过向指定地址发送电子邮件来开始触发流程。确保事后拆除所有东西以避免成本。</a></p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="e140" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您正在寻找如何在 AWS 上实现架构的其他示例，您可能会对我以前关于无服务器 Fargate 架构的博客文章感兴趣:</p><ul class=""><li id="11a9" class="mi mj jj la b lb lc le lf lh mk ll ml lp mm lt nt mo mp mq bi translated">全面了解<a class="ae jg" href="https://blog.codecentric.de/en/2020/06/cost-effective-batch-jobs-on-aws-serverless-infrastructure/" rel="noopener ugc nofollow" target="_blank">提议的架构及其动机</a>。</li><li id="d757" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated">详细看看它的<a class="ae jg" rel="noopener" target="_blank" href="/network-configurations-for-fargate-tasks-6333314c4001">联网方面</a>。</li><li id="b40c" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated">详细了解<a class="ae jg" href="http://how-to-configure-iam-roles-for-fargate-tasks-on-aws-76ad54f11314" rel="noopener ugc nofollow" target="_blank"> IAM 角色和涉及的策略</a>。</li><li id="90dd" class="mi mj jj la b lb mr le ms lh mt ll mu lp mv lt nt mo mp mq bi translated">详细看看<a class="ae jg" rel="noopener" target="_blank" href="/how-to-implement-a-serverless-batch-job-architecture-on-aws-b3358cd33428">实现的服务</a>。</li></ul><p id="2379" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请在评论中告诉我你的想法和经历。我也很乐意在<a class="ae jg" href="https://twitter.com/timo_data" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae jg" href="https://www.linkedin.com/in/timo-boehm-datascience/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系。感谢您的阅读！</p></div></div>    
</body>
</html>