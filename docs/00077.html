<html>
<head>
<title>BERT in computing the 2019 Cities Happiness Index</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">伯特在计算2019年城市幸福指数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/kigali-the-2019-happiness-capital-a0085dc1efc4?source=collection_archive---------48-----------------------#2020-01-02">https://towardsdatascience.com/kigali-the-2019-happiness-capital-a0085dc1efc4?source=collection_archive---------48-----------------------#2020-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f026" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着时间的推移，非洲充满了负面含义。我没有立场来捍卫或支持这样的主张，因为在大多数情况下，我认为这样的观点只是支持者的观点。除此之外，我选择从数据的角度来看待非洲大陆的积极因素，更多的是整体公民的幸福感。在此之前，我深入分析了一下，请花点时间通读一下根据<a class="ae kl" href="https://www.bbc.com/news/world-africa-50782677" rel="noopener ugc nofollow" target="_blank"> BBC </a>报道的2019年非洲大陆五大正面故事。老师<a class="ae kl" href="https://www.globalteacherprize.org/person?id=7486" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">塔比奇</strong> </a>必须在那里，可能是我太肯尼亚化了。如果我不提我最喜欢的合唱团在AGT的表演，恩德洛武青年合唱团以及跳羚队获得世界橄榄球冠军，非洲众神会不高兴的。</p><p id="b36c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解开这个幸福理论，我写下了几个“研究问题”，我相信这些问题会引导我找到最终结果</p><p id="d617" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km"> 1。有可能获得关于非洲国家的重要数据来确定他们的幸福吗？<br/> 2。对于同样的问题，最好的计算方法是什么？<br/> 3。这些结果可以通过任何方式验证吗？有验证集吗？</em></p><p id="7512" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大多数国家都有关于幸福指数的数据，但通常涉及几个指标的组合，我不愿意走这条路，至少目前是这样。但愿这将在未来形成验证集，但愿如此。我训练过许多分析模型，所以使用正确的数据，这种方法并不难。</p><p id="f6f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">按人口统计的最大城市的数据</strong></p><p id="fd32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最终收到了来自非洲不同城市的随机推文，这些推文是基于这些城市的人口数量和个人喜好。因此，预计数据和个人偏好会有一点偏差，但是结果仍然是确定的。这里列出了人口最多的城市<a class="ae kl" href="https://www.worldatlas.com/articles/15-biggest-cities-in-africa.html" rel="noopener ugc nofollow" target="_blank"/>。我最终融入了几个东非城市，尽管它们的人口规模很大。<em class="km">阿比让、亚的斯亚贝巴、布琼布拉、开罗、达累斯萨拉姆、约翰内斯堡、坎帕拉、基加利、金沙萨、拉各斯、罗安达、摩加迪沙</em>和<em class="km">内罗毕</em>在分析中受到关注。</p><p id="641f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">推文收藏</strong></p><p id="ce8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">地理定位在收集从这些城市传播的推文中至关重要。Twitter有一个高级搜索功能，因此这个集合可以使用关键字“附近”。看看杰斐逊的GetOldTweets <a class="ae kl" href="https://github.com/Jefferson-Henrique/GetOldTweets-python" rel="noopener ugc nofollow" target="_blank"> repo </a>来深入搜索和收集过去的推文。你以后会感谢我的。收集来自内罗毕的推文就像下面的Python命令一样简单。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="cf17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过上面的命令，你将能够收集来自/靠近肯尼亚内罗毕的2019年<strong class="jp ir">传播的多达<strong class="jp ir">1000万条推文</strong>。</strong></p><p id="e771" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我感兴趣的是来自城市的一小部分推文，因此最终收集了16942条随机和独特的推文。挑战在于推文使用不同的语言，这与我的训练数据和选择的方法的要求相反。</p><p id="badb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">推文预处理和翻译</strong></p><p id="deb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与传统的英语文本不同，推特是独特的，因为它们被缩短以适应字符限制，并且在大多数情况下表达的语言是非传统的。因此，预处理同样是不同的。我用Pandas将CSV转换成数据帧，以便于操作。</p><p id="1667" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">令人感兴趣的是推文本身的<strong class="jp ir">“text”</strong>栏。因此，我删除了所有其他的专栏，删除了重复的，停用的词以及空的推文。这在推特上经常发生。下面的代码将处理所有这些过程。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="e675" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，这个过程将再次留下几条短推，如下所示。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ku"><img src="../Images/ce611af07ad69260c92dfcd7568e3e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*vK_bJgu39NbPnNtnB9cR8w.png"/></div></figure><p id="af52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决方法是再次删除空值，如下所示，因为在空字段上训练模型是浪费资源。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="8143" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述过程的输出如下。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/d9b3b5e65e7f4d751c113abd23bbc0e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*w9x8sDzh-AiZlPdqUF5oCw.png"/></div></figure><p id="caa9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是有道理的。不幸的是，我们的模型是在英语文本上训练的，因此需要将这些推文翻译成英语，尤其是来自阿比让和金沙萨等法语城市的推文。我使用了GoogleTranslate API键<a class="ae kl" href="https://translatepress.com/docs/automatic-translation/generate-google-api-key/" rel="noopener ugc nofollow" target="_blank">将所有推文翻译成英语。这需要一些时间，但将使用下面的代码完成工作:</a></p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="d4ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与城市字段连接后的输出如下。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/fd46a1a72bb4c88287859b19eeea83df.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*rKC6vaFOzFYaDyZKCZ8Zzw.png"/></div></figure><p id="00c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">伯特在训练我们的模特</strong></p><p id="3656" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">来自变形金刚的双向编码器表示(BERT) </strong>是Google基于变形金刚开发的自然语言处理(NLP)技术。来自谷歌<a class="ae kl" href="https://www.blog.google/products/search/search-language-understanding-bert/" rel="noopener ugc nofollow" target="_blank">博客</a>、<em class="km">的消息称，这一突破是谷歌对变形金刚研究的结果:模型将单词与句子中的所有其他单词联系起来处理，而不是一个接一个地按顺序处理。因此，BERT模型可以通过查看单词前后的单词来考虑单词的完整上下文，这对理解搜索查询背后的意图特别有用。”</em> <br/> <br/>由于<a class="ae kl" rel="noopener" target="_blank" href="/a-review-of-bert-based-models-4ffdc0f15d58"> BERT模型</a>已经在数百万个句子和特征上被训练过，它们在许多开箱即用的NLP任务上表现得相当好。我使用了<a class="ae kl" href="https://github.com/kaushaltrivedi/fast-bert" rel="noopener ugc nofollow" target="_blank"> Fast-Bert </a>，这是PyTorch BERT模块的一个优秀的简单包装器，用于在tweets的<a class="ae kl" href="https://www.kaggle.com/kazanova/sentiment140" rel="noopener ugc nofollow" target="_blank">数据集</a>上训练模型，以文本作为特征，以情感类别(0到4)作为标签。该模型随后在我们翻译的推文中进行了测试。</p><p id="db88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">先决条件</strong></p><p id="82b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，BERT模型非常庞大，有数百万个特征，因此运行模型的计算能力对我来说是个大问题。我选择了几个云选项，下面是我对我尝试过的几个选项的想法。</p><ol class=""><li id="e13f" class="kz la iq jp b jq jr ju jv jy lb kc lc kg ld kk le lf lg lh bi translated"><strong class="jp ir"> Kaggle </strong> —有GPU支持的免费平台，但内存分配对我不利。由于内存相关问题，培训过程被终止。</li><li id="ab4d" class="kz la iq jp b jq li ju lj jy lk kc ll kg lm kk le lf lg lh bi translated">谷歌的Colab——运行良好，但在经过数小时的训练后，它也分别关闭了，尽管与Kaggle的平台相比，它更适合这项任务。没有尝试TPU功能，因为Pytorch还不被支持。</li><li id="a20a" class="kz la iq jp b jq li ju lj jy lk kc ll kg lm kk le lf lg lh bi translated">谷歌云平台——我最终选择了这个平台，因为我可以使用他们提供的300美元免费积分。我使用了相同的一小部分，所以这是任何有兴趣训练这样一个模型的人的最佳平台。首先，不要为GCP买单。因为您将使用虚拟机(VM ),所以只要满足于CPU和内存高的虚拟机就可以了。不要用付费的GPU。我试过这个，结果除了支付68美元之外，什么也没训练。只需按照这篇文章在GCP上设置你的笔记本。你会节省很多时间。</li></ol><p id="e9f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">附加工具:</strong></p><p id="fa25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Python 3 <br/> Fast-Bert </strong>如果使用CPU，请忽略此选项。<br/>T10】Ubuntu</p><p id="1c7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我选择了<a class="ae kl" href="https://medium.com/huggingface/distilbert-8cf3380435b5" rel="noopener"> <strong class="jp ir"> DistilBERT </strong> </a>，一个更小、更快、更便宜的模型来训练和设置CPU版本，因为我无法使用谷歌积分访问GPU。下面的代码除了对训练集和验证集进行分段之外，还导入了模型训练所需的所有包。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="7936" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">数据束</strong></p><p id="eca1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">建模的第一步是创建<em class="km">数据束</em>。这只是一个对象，它接受训练、验证和测试CSV文件，并将它们转换为BERT及其变体(如DistilBERT)的内部表示。它还根据<strong class="jp ir">设备配置文件、batch_size </strong>和<strong class="jp ir"> max_sequence_length </strong>实例化正确的数据加载器。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="4111" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">学习者</strong></p><p id="6a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">学习步骤以数据分组和相关参数作为输入。下面是Python中相同内容的表示，其中学习者封装了模型生命周期的关键逻辑，如训练、验证和推理。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="7c70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后模型被训练如下。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="10e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到训练时间和资源，我只是将<strong class="jp ir">纪元的数量</strong>设置为1。如果您有足够的资源，您可以更改这个数字以获得更好的准确性(不保证)。使用16个vCPUs和64GB内存，培训需要大约19个小时。建议保存模型，这样就不会进行重新训练。下面的预测器对象将模型和标签作为输入。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="c4c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">对测试集进行情感分析</strong></p><p id="3d50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用下面的代码可以选择批量情绪预测。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="dee8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如下所示的输出将是该推文属于情感类别的标签和概率。每条推文情感输出的概率总和应该等于1。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/c55666d0a033dbc82dcc0f34b6ecb0cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*W303BMneBMsut21HINzzZA.png"/></div></figure><p id="2200" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，具有最高概率的标签是选择的预测标签。根据上面的输出，第一个tweet情感预测标签是0，概率为25%。为了选择列表中概率最高的标签，下面代码中的第一行起作用了。然后，输出被转换成第二行中的数据帧。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="1dce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">原始测试集和每条tweet的预测的串联产生了以下结果:-</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/523d7734b167acf550c4c4da2b7b45eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*lgFUz9PqFFMDCUO1lzGqRg.png"/></div></figure><p id="a9e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">酸甜苦辣的时刻</strong></p><p id="9d5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到现在为止，你一定已经对快乐在输出中意味着什么有了一个概念。与其余的相比，情绪标签4显示了更大程度的满足。另一方面，标签0表示不满，因此被解释为悲伤的感觉。因此，获得情绪得分的平均值，按城市分组，是计算一个城市总体幸福感的一个简单但似乎合理的答案。下面的代码表明。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="79c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="km">卢旺达基加利</em> </strong>摘得13个最幸福城市的桂冠。令人惊讶的是，<strong class="jp ir"> <em class="km">摩加迪沙，索马里</em> </strong>位居第二，尽管我们读到过关于索马里这个国家的负面报道。<strong class="jp ir"> <em class="km">肯尼亚内罗毕</em> </strong>我的首都是继<strong class="jp ir"> <em class="km">乌干达坎帕拉</em> </strong>之后东非第二不快乐的城市。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ks kt l"/></div></figure><p id="ce02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="00c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当使用数据驱动的解决方案来获得某些国家或城市的人们的幸福时，上述结果在某种程度上令人大开眼界。几点作为我的结论:—</p><ol class=""><li id="eb98" class="kz la iq jp b jq jr ju jv jy lb kc lc kg ld kk le lf lg lh bi translated">城市的选择纯粹是基于人口和个人喜好，特别是东非城市的选择。这是我讲述非洲故事的最好/唯一方式。随着时间和更多的资源，我将能够从非洲大多数国家的首都获得更多的推文，并进行更好的比较。</li><li id="edbd" class="kz la iq jp b jq li ju lj jy lk kc ll kg lm kk le lf lg lh bi translated">20万条随机推文的训练集(虽然在类中是平衡的)有点偏低。DistilBERT模型也具有较少的特征(<strong class="jp ir"> 66M </strong>)，这在很小程度上损害了准确性。我计划用一个多语言的完整模型(<strong class="jp ir">110万</strong>功能)和整个160万tweets训练集实现同样的功能。希望会有一些显著的不同。</li><li id="10c7" class="kz la iq jp b jq li ju lj jy lk kc ll kg lm kk le lf lg lh bi translated">翻译是一项挑战，尤其是对推文中的缩写词和有语境挑战的词。原始上下文可能会丢失，但翻译者在人类评估者查看的几个样本上工作得相当好。</li><li id="85a3" class="kz la iq jp b jq li ju lj jy lk kc ll kg lm kk le lf lg lh bi translated">验证我们的结果。这是一个棘手的部分。我们的数据基于社交数据，尤其是推特。推文描述了各个城市的日常聊天，因此最适合衡量传播者的总体幸福感。然而，目前使用的方法考虑了其他几个决定幸福感的因素。例如,<a class="ae kl" href="https://s3.amazonaws.com/happiness-report/2019/WHR19.pdf" rel="noopener ugc nofollow" target="_blank">联合国世界幸福报告</a>就是其中之一，因此如果模型中包含其他因素，将其作为基础事实将是有效的。这是可以讨论的。</li></ol></div></div>    
</body>
</html>