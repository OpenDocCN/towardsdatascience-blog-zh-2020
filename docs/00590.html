<html>
<head>
<title>Web scraping for machine learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于机器学习的网页抓取</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-for-machine-learning-5fffb7047f70?source=collection_archive---------14-----------------------#2020-01-17">https://towardsdatascience.com/web-scraping-for-machine-learning-5fffb7047f70?source=collection_archive---------14-----------------------#2020-01-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/630005b0af506d5589698df67dcf19e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*XCnRyTjQv4A7gz_72bDqrw.jpeg"/></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">图片作者贝蒂·隆巴顿/ <em class="kb">阿奇博尔德汽车商店——教堂街</em> / <a class="ae kc" href="https://creativecommons.org/licenses/by-sa/2.0/" rel="noopener ugc nofollow" target="_blank"> CC BY-SA 2.0 </a></p></figure><p id="adbd" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">买东西有个普遍规律，<em class="lb">“少花钱不如多花钱”</em>。出于个人原因，我需要买一辆二手车，但我并不着急，我有时间考虑并找到最好的交易。</p><p id="f871" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">在检查当地的二手车商店时，他们向我展示了价格在7，000至10，000欧元之间的汽车。这是一大笔钱，所以我想我应该利用我的数据科学技能来找到最好的交易。</p><h1 id="d497" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">数据采集</h1><p id="3028" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">机器学习项目首先需要的是数据。你可以猜到，西班牙市场上没有二手车数据的数据集，即使有，也会因为价格不断变化而每个月都过时。</p><p id="0111" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我从西班牙最受欢迎的二手车分类广告页面获得数据。出于隐私原因，我将对我使用的页面名称保密。用于搜索的限制如下:</p><ul class=""><li id="92c4" class="mf mg it kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated"><strong class="kf iu">距离我:</strong>不到100公里</li><li id="819d" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated"><strong class="kf iu">车龄:</strong>10年以下</li><li id="09d0" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated"><strong class="kf iu">价格:</strong>低于10.000欧元</li></ul><p id="d34c" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">让我们检查一下用于从这些网站收集数据的工具:</p><ul class=""><li id="9948" class="mf mg it kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated"><strong class="kf iu"> urllib.request: </strong>使用Python标准库中的这个模块来下载网站的html代码。</li><li id="2f08" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated"><strong class="kf iu"> BeautifulSoup4: </strong>用这个模块解析html代码，找到相关信息。</li></ul><p id="037a" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我们需要下载两件东西，一个页面包含我们限制的可用汽车列表，另一个页面包含汽车的所有信息。</p><p id="f859" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">对于汽车列表，一些示例URL可能是:</p><p id="a62a" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated"><a class="ae kc" href="https://www.adspage/cars/?location=Barcelona&amp;uptoprice=10000&amp;yearfrom=2010" rel="noopener ugc nofollow" target="_blank"><em class="lb">https://www.adspage/cars-search/?location=Barcelona&amp;最高价格=10000 &amp;年起=2010 </em> </a></p><p id="811c" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">对于某辆汽车，URL可能是这样的:</p><p id="230d" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated"><a class="ae kc" href="https://www.adspage/cars/?location=Barcelona&amp;uptoprice=10000&amp;yearfrom=2010" rel="noopener ugc nofollow" target="_blank">【https://www.adspage/cars/?carid】</a><em class="lb">= 141238</em></p><p id="bc03" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我们使用urllib下载并保存这些页面:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="fbee" class="nc ld it my b gy nd ne l nf ng">from urllib.request import urlopen</span><span id="ef41" class="nc ld it my b gy nh ne l nf ng">def download_and_save_page(url, file):<br/>    html_code = urlopen(url).read()#.decode('utf-8')<br/>    f = open(file, 'wb')<br/>    f.write(html_code)<br/>    f.close()<br/>    return html_code</span></pre><p id="1f38" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">首先，我们删除包含汽车列表的页面，找到所有可用汽车的链接并下载它们。这很容易用BeautifulSoup的<strong class="kf iu"> find_all </strong>方法完成</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="5e47" class="nc ld it my b gy nd ne l nf ng">links = soup.find_all('a', href=True, class_='car-link')<br/>for link in links:<br/>    print(link['href'])</span></pre><p id="74ae" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">请记住，分类广告页面通常遵循分页系统，因此在每个页面中，我们都会列出一定数量的汽车(例如20辆)，为了让所有汽车可用，我们需要了解分页系统是如何工作的。通常我们只需在URL上添加一个页码，例如:</p><p id="3d85" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated"><a class="ae kc" href="https://www.adspage/cars/?location=Barcelona&amp;uptoprice=10000&amp;yearfrom=2010" rel="noopener ugc nofollow" target="_blank"><em class="lb">https://www.adspage/cars-search/?location=Barcelona&amp;up price = 10000&amp;year from = 2010&amp;page</em></a><em class="lb">= 7</em></p><p id="01ae" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">使用此代码，我们可以创建一个汽车链接数据库，并将它们提供给下载功能，以使我们的scraper运行并下载包含所有可用汽车信息的页面。</p><p id="2cf6" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">下一步是处理所有下载的页面并提取汽车的相关信息。所有信息都保存在一个CSS文件中。我决定保存的数据是:</p><ul class=""><li id="3189" class="mf mg it kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">广告网址(以便以后我发现有趣的东西时手动检查)</li><li id="20b7" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">汽车品牌</li><li id="ded4" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">汽车模型</li><li id="735e" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">卖家类型(私人/专业)</li><li id="1aab" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">价格</li><li id="ebcd" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">描述</li><li id="b6c2" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">年</li><li id="f7e7" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">Kms</li><li id="7ab9" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">出版日期</li><li id="79c2" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">带图片的URL列表</li></ul><p id="e469" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我最终没有使用一些字段(描述和图片),因为它们增加了很多复杂性，但是它们可以包含相关信息，你可以通过查看图片来了解汽车的状况，描述多次谈到汽车的额外功能，可以提供相关信息(发动机损坏的部分)</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="1648" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">提取数据主要是通过BeautifulSoup的<em class="lb"> find </em>和<em class="lb"> find_all </em>方法完成的，搜索页面上的相关字段。</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="d590" class="nc ld it my b gy nd ne l nf ng">soup.find('div', class_='car-price').get_text()</span></pre><p id="4c47" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">找到正确的类名很重要，我用Firefox的开发工具做到了这一点(用Ctrl+Shift+C打开检查器)。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/3dd88487be2d697735069ab4e58ba972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xDeVn2SQKb6HAuyEw7nmCA.png"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">使用检查器选择网站栏</p></figure><p id="0efe" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">使用检查器，我们选择页面上的所有相关字段，并记录它们的信息。</p><ul class=""><li id="3fcc" class="mf mg it kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">是<div>元素、<p>元素还是什么样的元素？</p></div></li><li id="c751" class="mf mg it kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">如何从所有同类元素中识别它们(惟一id或惟一类名)</li></ul><p id="506c" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">连接所有这些元素，我们可以创建一个包含所有汽车数据的CSV文件。在我的例子中，CSV文件是5 MB，包含3487辆汽车的数据。该数据仅适用于2019年12月销售的汽车，并且符合我之前描述的搜索标准。获得更老的数据会很有趣，但在网上无法获得。</p><h1 id="2df4" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">数据分析</h1><p id="1769" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">现在到了有趣的部分，我们打开我们的Jupyter笔记本，开始分析数据。</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="361b" class="nc ld it my b gy nd ne l nf ng">#Load data<br/>df = pd.read_csv('data/car_data.csv')</span></pre><p id="0b61" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">让我给你介绍一下<a class="ae kc" href="https://github.com/pandas-profiling/pandas-profiling" rel="noopener ugc nofollow" target="_blank"> Pandas Profiling </a>，这是一个python模块，可以从Pandas数据帧生成报告。该报告为我们提供了数据集中所有变量的统计数据的快速可视化。</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="a7b4" class="nc ld it my b gy nd ne l nf ng">from pandas_profiling import ProfileReport<br/>prof = ProfileReport(df)<br/>prof.to_file('output.html')</span></pre><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nu"><img src="../Images/0b4ed4c5fab495ec6d50acf45052741e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nDwyxLcyVeOW9-xfTEb6Rw.png"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">kms变量的统计信息</p></figure><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nv"><img src="../Images/915ba604d9ab5130ca00e4286c8fdb71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KO4gpWWyxinGK8Uiq4zLFQ.png"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">公里直方图</p></figure><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nu"><img src="../Images/dd2b818e5bc532fab752fe66cb1dd229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uLeLJ0X_W2PKkZNue7liNg.png"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">在极端值上，我们可以看到输入错误的值(超过一百万公里的汽车)</p></figure><p id="bf65" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">一些有趣的统计数据是在西班牙销售的最常见的品牌和型号:</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nu"><img src="../Images/407ed2d72bcba08c31322c4a7bc73f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yuQVvFGk2eoxvxtpeFhIMw.png"/></div></div></figure><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nu"><img src="../Images/09f274c348e9b998eef564337ff79ad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JHTVyQ8PmBntLoj4WTqQIQ.png"/></div></div></figure><p id="29b8" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">快速可视化之后，我检查了数据集上不太常见的品牌，发现一些汽车品牌只有几个条目。我把它们删除了，因为这么少的数据会让它过度适合这些特定的品牌。</p><p id="01cc" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">然后对品牌和型号应用一个热编码，最终得到371个变量。</p><p id="25f4" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">使用训练/测试分割来检查ML模型的准确性，并使用RMSE来评估它们的性能。目标变量是汽车的价格。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="2e99" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我想谈论的车型是XGBoost，它为RMSE和KNN提供了最佳价值，我发现这个应用程序很有趣，因为我们在搜索汽车价格时直观地将它与其他在售的类似汽车进行比较。</p><p id="3583" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">XGBoost:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="a78c" class="nc ld it my b gy nd ne l nf ng">import xgboost as xgb<br/>model=xgb.XGBRegressor(random_state=1, n_estimators=5000, learning_rate=0.01)<br/>model.fit(X_train, y_train)</span><span id="c7dd" class="nc ld it my b gy nh ne l nf ng">sqrt(mean_squared_error(y_val, model.predict(X_val)))</span></pre><p id="8551" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">得到了1.288，39的RMSE。请注意，这一幅度相当于欧元误差。这是一个很高的值，请记住，我们只查看价格超过10.000欧元的汽车，平均值为7.226欧元。</p><p id="7c8b" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">KNN:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="7a81" class="nc ld it my b gy nd ne l nf ng">from sklearn.neighbors import KNeighborsRegressor<br/>knn = KNeighborsRegressor(n_neighbors=5)<br/>knn.fit(X_train, y_train)</span><span id="68fb" class="nc ld it my b gy nh ne l nf ng">sqrt(mean_squared_error(y_val, model.predict(X_val)))</span></pre><p id="6ce5" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">即使我期望从这个模型的直观方法中得到好的结果，它也悲惨地失败了，给出了7.242的RMSE。</p><h1 id="c6bf" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="e0f3" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">我从这个项目中得到的主要收获是，我可以找到与我在附近商店看到的一样好的汽车，并获得更好的价格，能够找到4，000至5，000英镑范围内的汽车，这是目前最划算的价格。</p><p id="9345" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">最后，我买了一辆我非常满意的雪铁龙C4。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nw"><img src="../Images/62adfb3356fd7bd256aba4d0289eb8ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aWTp_g5lvnbGUMIAziCpbQ.png"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">我买的车</p></figure><p id="8c8b" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">我想提到的一些事情是，从分类广告页面提取的数据并不意味着以某一价格发布的汽车最终以该价格售出。大多数情况下，卖家在与买家谈过之后会降低价格，而这并没有反映在网站上。其他卖家可能会开出一个高得离谱的价格，但却无人问津，因为没有人愿意以这个价格购买他们的汽车。所有这些都使算法偏向于给出比真实价格更高的价格。</p><p id="a9b2" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">有很多广告缺少一些信息，有时他们缺少车龄，有时缺少公里数等。其他时候数据格式不佳，卖家没有在适当的字段中引入数据，最终导致数据点缺少大部分功能，但是他们在描述中以自己的格式引入所有这些数据，这是算法无法解释的。所有这些都会影响数据的质量，从而影响我们的结果。</p><p id="bbc9" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">改善这种分析的其他方法包括使用NLP从描述中添加信息，卖家有时会谈到汽车中包含的额外功能，有时会谈到汽车的发动机或状况，有时会说有机械问题。我相信从这些描述中可以提取出许多有趣的信息。另一种方法是使用计算机视觉从贴有广告的汽车图片中获得额外的信息，有时你可以看到汽车受到了一些影响，有时你可以看到汽车的内部，有时没有图片，这是一个不好的迹象。</p><p id="c888" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">这些仅仅是可以持续改善这个项目结果的许多途径中的一部分，然而在买了车之后，我感觉不到继续在这个项目上工作的动力。</p></div></div>    
</body>
</html>