<html>
<head>
<title>How to Train Detectron2 on Custom Object Detection Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在自定义对象检测数据上训练检测器 2</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-train-detectron2-on-custom-object-detection-data-be9d1c233e4?source=collection_archive---------7-----------------------#2020-06-24">https://towardsdatascience.com/how-to-train-detectron2-on-custom-object-detection-data-be9d1c233e4?source=collection_archive---------7-----------------------#2020-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ac16" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">注:我们还在博客上发布了<a class="ae ki" href="https://blog.roboflow.com/how-to-train-detectron2/" rel="noopener ugc nofollow" target="_blank">如何培训检测员 2 </a>。在本帖中，我们将在这本<a class="ae ki" href="https://colab.research.google.com/drive/1-TNOcPm3Jr3fOJG8rnGT9gh60mHUsvaW#scrollTo=kc8MmgZugZWR" rel="noopener ugc nofollow" target="_blank">detector 2 Colab 笔记本</a>中，详细讲解如何训练 detector 2 检测定制对象。阅读后，您将能够通过只更改一行用于自定义数据导入的代码来训练您的 custom Detectron2 检测器！</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/79a7365a60bc168ab380a24d32ceef9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1GtJp9afKm6F092Y.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae ki" href="https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/" rel="noopener ugc nofollow" target="_blank"> Detectron2 </a>提供了一个灵活的框架来训练和部署计算机视觉算法。</p></figure><h1 id="58d3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">文章大纲</h1><ul class=""><li id="8a7e" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">检测器 2 概述</li><li id="9803" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">我们的自定义数据集概述</li><li id="b8f7" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">安装检测器 2 依赖项</li><li id="c53f" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">下载自定义检测器 2 对象检测数据</li><li id="6b9b" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">可视化探测器 2 训练数据</li><li id="30ef" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">编写我们的 Detectron2 培训配置</li><li id="c7ae" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">运行检测器 2 培训</li><li id="a8fa" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">评估检测器 2 的性能</li><li id="ee13" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">对测试图像运行 Detectron2 推理</li></ul><h1 id="1ce6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">定制检测器 2 培训资源</h1><ul class=""><li id="2e14" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><a class="ae ki" href="https://colab.research.google.com/drive/1-TNOcPm3Jr3fOJG8rnGT9gh60mHUsvaW#scrollTo=wXisIbT1Zqou" rel="noopener ugc nofollow" target="_blank">实现自定义数据检测器 2 的 Colab 笔记本</a></li><li id="ea4c" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ki" href="https://public.roboflow.ai/object-detection/bccd" rel="noopener ugc nofollow" target="_blank">公共血细胞检测数据集</a></li></ul><h1 id="2444" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">检测器 2 概述</h1><p id="17c9" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">Detectron2 是一个流行的基于 PyTorch 的模块化计算机视觉模型库。这是 Detectron 的第二个版本，最初是用 Caffe2 编写的。Detectron2 系统允许您将最先进的计算机视觉技术插入到您的工作流程中。引用<a class="ae ki" href="https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/" rel="noopener ugc nofollow" target="_blank"> Detectron2 发布博客</a>:</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="bef3" class="ng la it nc b gy nh ni l nj nk">Detectron2 includes all the models that were available in the original Detectron, such as Faster R-CNN, Mask R-CNN, RetinaNet, and DensePose. It also features several new models, including Cascade R-CNN, Panoptic FPN, and TensorMask, and we will continue to add more algorithms. We’ve also added features such as synchronous Batch Norm and support for new datasets like LVIS</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nl"><img src="../Images/026daf2a1908e60b67fbcfc9290547b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3lrFWPNgpTglBOIi.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae ki" href="https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/" rel="noopener ugc nofollow" target="_blank">检测器 2 </a>中提供多种推理模式</p></figure><p id="d2e0" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">在本帖中，我们回顾了如何针对<strong class="lt iu">特别是对象检测</strong>的自定义数据训练 Detectron2。不过，在你读完之后，你将会熟悉 Detectron2 的生态系统，并且你将能够推广到 Detectron2 中包含的其他功能。</p><h1 id="f4c5" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">我们的自定义数据概述</h1><p id="2ca7" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">我们将在 Roboflow 免费托管的<a class="ae ki" href="https://public.roboflow.ai/object-detection/bccd" rel="noopener ugc nofollow" target="_blank">公共血细胞检测</a>数据上培训我们的 custom Detectron2 检测器。血细胞检测数据集是小型定制对象检测数据集的代表，人们可以收集该数据集来构建定制对象检测系统。值得注意的是，血细胞检测不是 Detectron2 中可用的功能——我们需要训练底层网络来适应我们的定制任务。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nr"><img src="../Images/60698bc4e3a45b5956b9c1fd73fe4d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5BraUOhnyEOluib6.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae ki" href="https://public.roboflow.ai/object-detection/bccd" rel="noopener ugc nofollow" target="_blank">公共血细胞检测数据</a></p></figure><p id="9d6c" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">如果你想一步一步地跟随教程，你可以分叉这个<a class="ae ki" href="https://public.roboflow.ai/object-detection/bccd" rel="noopener ugc nofollow" target="_blank">公共血细胞数据集</a>。否则，你可以上传任何格式的数据集(详见下文)。</p><h1 id="40d7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">安装检测器 2 依赖项</h1><p id="3544" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">首先，复制这个<a class="ae ki" href="https://colab.research.google.com/drive/1-TNOcPm3Jr3fOJG8rnGT9gh60mHUsvaW#scrollTo=wXisIbT1Zqou" rel="noopener ugc nofollow" target="_blank"> Colab 笔记本，它实现了对自定义数据</a>的检测器 2。Google Colab 为我们提供了免费的 GPU 资源，因此请确保通过检查运行时→更改运行时类型→ GPU 来启用它们。</p><p id="751c" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">为了开始训练我们的自定义检测器，我们安装了<code class="fe ns nt nu nc b">torch==1.5</code>和<code class="fe ns nt nu nc b">torchvision==0.6</code> -然后在导入<code class="fe ns nt nu nc b">torch</code>后，我们可以检查 torch 的版本，并确保 GPU 可用于打印<code class="fe ns nt nu nc b">1.5.0+cu101 True</code>。</p><p id="0397" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">然后我们 pip 安装 Detectron2 库并导入一些子模块。</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="8600" class="ng la it nc b gy nh ni l nj nk">!pip install detectron2==0.1.3 -f <a class="ae ki" href="https://dl.fbaipublicfiles.com/detectron2/wheels/cu101/torch1.5/index.html" rel="noopener ugc nofollow" target="_blank">https://dl.fbaipublicfiles.com/detectron2/wheels/cu101/torch1.5/index.html</a></span><span id="ae89" class="ng la it nc b gy nv ni l nj nk">import detectron2<br/>from detectron2.utils.logger import setup_logger<br/>setup_logger()</span><span id="f01e" class="ng la it nc b gy nv ni l nj nk"># import some common libraries<br/>import numpy as np<br/>import cv2<br/>import random<br/>from google.colab.patches import cv2_imshow</span><span id="1467" class="ng la it nc b gy nv ni l nj nk"># import some common detectron2 utilities<br/>from detectron2 import model_zoo<br/>from detectron2.engine import DefaultPredictor<br/>from detectron2.config import get_cfg<br/>from detectron2.utils.visualizer import Visualizer<br/>from detectron2.data import MetadataCatalog<br/>from detectron2.data.catalog import DatasetCatalog</span></pre><p id="4bd5" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">已安装 Detectron2 依赖项。</p><h1 id="48ea" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">下载自定义检测器 2 对象检测数据</h1><p id="a437" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">我们从 Roboflow 下载 COCO JSON 格式的自定义数据，只需一行代码——这是您需要修改的唯一一行代码，以便在您自己的自定义对象上进行训练！</p><p id="034f" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">注意:在本教程中，我们使用边界框导出对象检测数据。Roboflow 目前不支持语义分段注释格式。<a class="ae ki" href="https://roboflow.ai" rel="noopener ugc nofollow" target="_blank">报名</a>我们报名时会通知您。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nw"><img src="../Images/adfd2ef45fec7d4c1c41d895e9fb5bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t9rrzBfH4e3zeYH5.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">下载自定义数据集</p></figure><p id="5672" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">如果你有<strong class="lt iu">未标记的</strong>图片，你首先需要标记它们。对于免费的开源标签工具，我们推荐以下指南:标签工具<a class="ae ki" href="https://blog.roboflow.ai/getting-started-with-labelimg-for-labeling-object-detection-data/" rel="noopener ugc nofollow" target="_blank">入门指南</a>或 CVAT 注释工具<a class="ae ki" href="https://blog.roboflow.ai/getting-started-with-cvat/" rel="noopener ugc nofollow" target="_blank">入门指南。尝试标记约 50 张图像，以继续本教程。为了以后提高模型的性能，您将需要更多的标签。</a></p><p id="eecc" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">您还可以考虑<a class="ae ki" href="https://blog.roboflow.ai/custom-open-images-datasets/" rel="noopener ugc nofollow" target="_blank">从开放图像中构建一个自由对象检测数据集</a>。</p><p id="09ce" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">一旦您标记了数据，要将您的数据移动到 Roboflow 中，<a class="ae ki" href="https://app.roboflow.ai/" rel="noopener ugc nofollow" target="_blank">创建一个免费帐户</a>，然后您可以以任何格式拖动您的数据集:(VOC XML、COCO JSON、TensorFlow Object Detection CSV 等)。</p><p id="8f1b" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">上传后，您可以选择预处理和增强步骤:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nx"><img src="../Images/2059d4afb06208b8ac6fa12f00a9d57a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j46IinYn_6MhDpo3.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">为 BCCD 数据集选择的导出设置</p></figure><p id="7cf2" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">然后点击<code class="fe ns nt nu nc b">Generate</code>和<code class="fe ns nt nu nc b">Download</code>就可以选择 COCO JSON 格式了。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ny"><img src="../Images/1a1d55aa116484c6b3819ad851da9b05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_70hvT9o2rHMrxJJ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">选择“COCO JSON”导出格式</p></figure><p id="a481" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">出现提示时，请务必选择“显示代码片段”这将输出一个下载 curl 脚本，这样您就可以轻松地将数据以正确的格式导入 Colab。</p><p id="7cb8" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">然后，Detectron2 跟踪一个<code class="fe ns nt nu nc b">registry</code>中可用数据集的列表，因此我们必须向 Detectron2 注册我们的自定义数据，以便可以调用它进行训练。</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="9801" class="ng la it nc b gy nh ni l nj nk">from detectron2.data.datasets import register_coco_instances<br/>register_coco_instances("my_dataset_train", {}, "/content/train/_annotations.coco.json", "/content/train")<br/>register_coco_instances("my_dataset_val", {}, "/content/valid/_annotations.coco.json", "/content/valid")<br/>register_coco_instances("my_dataset_test", {}, "/content/test/_annotations.coco.json", "/content/test")</span></pre><p id="b0a2" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">探测器 2 数据已注册。</p><h1 id="33b7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">可视化探测器 2 训练数据</h1><p id="c74a" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">Detectron2 可以轻松查看我们的训练数据，以确保数据已正确导入。我们通过以下方式做到这一点</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="ba21" class="ng la it nc b gy nh ni l nj nk">#visualize training data<br/>my_dataset_train_metadata = MetadataCatalog.get("my_dataset_train")<br/>dataset_dicts = DatasetCatalog.get("my_dataset_train")</span><span id="5b23" class="ng la it nc b gy nv ni l nj nk">import random<br/>from detectron2.utils.visualizer import Visualizer</span><span id="76ee" class="ng la it nc b gy nv ni l nj nk">for d in random.sample(dataset_dicts, 3):<br/>    img = cv2.imread(d["file_name"])<br/>    visualizer = Visualizer(img[:, :, ::-1], metadata=my_dataset_train_metadata, scale=0.5)<br/>    vis = visualizer.draw_dataset_dict(d)<br/>    cv2_imshow(vis.get_image()[:, :, ::-1])</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/c7008ad1597d1c3c7b0df01d2e028937.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/0*cDVkwc6k9ReflxeQ.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">可视化训练数据</p></figure><p id="ec84" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">看起来我们的数据集注册正确。</p><h1 id="1e4f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">编写我们的 Detectron2 培训配置</h1><p id="55f6" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">接下来，我们编写自定义培训配置。</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="b5e8" class="ng la it nc b gy nh ni l nj nk">cfg = get_cfg()<br/>cfg.merge_from_file(model_zoo.get_config_file("COCO-Detection/faster_rcnn_X_101_32x8d_FPN_3x.yaml"))<br/>cfg.DATASETS.TRAIN = ("my_dataset_train",)<br/>cfg.DATASETS.TEST = ("my_dataset_val",)</span><span id="37d3" class="ng la it nc b gy nv ni l nj nk">cfg.DATALOADER.NUM_WORKERS = 4<br/>cfg.MODEL.WEIGHTS = model_zoo.get_checkpoint_url("COCO-Detection/faster_rcnn_X_101_32x8d_FPN_3x.yaml")  # Let training initialize from model zoo<br/>cfg.SOLVER.IMS_PER_BATCH = 4<br/>cfg.SOLVER.BASE_LR = 0.001</span><span id="6387" class="ng la it nc b gy nv ni l nj nk">cfg.SOLVER.WARMUP_ITERS = 1000<br/>cfg.SOLVER.MAX_ITER = 1500 #adjust up if val mAP is still rising, adjust down if overfit<br/>cfg.SOLVER.STEPS = (1000, 1500)<br/>cfg.SOLVER.GAMMA = 0.05</span><span id="f396" class="ng la it nc b gy nv ni l nj nk">cfg.MODEL.ROI_HEADS.BATCH_SIZE_PER_IMAGE = 64<br/>cfg.MODEL.ROI_HEADS.NUM_CLASSES = 4</span><span id="b1c5" class="ng la it nc b gy nv ni l nj nk">cfg.TEST.EVAL_PERIOD = 500</span></pre><p id="b176" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">我们在这里调用的最大的设备是对象检测模型的类型——更快的大型 RCNN。Detectron2 允许你在决定你的模型架构时有很多选择，你可以在<a class="ae ki" href="https://github.com/facebookresearch/detectron2/blob/master/MODEL_ZOO.md" rel="noopener ugc nofollow" target="_blank"> Detectron2 模型动物园</a>中看到。</p><p id="660d" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">仅对于对象检测，以下模型是可用的:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oa"><img src="../Images/927c0d37cf40ee7a2b807951697b45f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4epeFqOWmeelbuv_.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae ki" href="https://github.com/facebookresearch/detectron2/blob/master/MODEL_ZOO.md" rel="noopener ugc nofollow" target="_blank">探测器 2 模型动物园</a>中可用的物体探测模型。</p></figure><p id="1cc9" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">我们做的另一个大的配置选择是<code class="fe ns nt nu nc b">MAX_ITER</code>参数。这指定了模型将训练多长时间，您可能需要根据您看到的验证指标上下调整。</p><h1 id="a6c2" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">运行检测器 2 培训</h1><p id="865f" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">在开始训练之前，我们需要确保模型根据我们的验证集进行验证。不幸的是，默认情况下这不会发生🤔。</p><p id="907a" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">我们可以通过基于带有<code class="fe ns nt nu nc b">COCO Evaluator</code>的<code class="fe ns nt nu nc b">Default Trainer</code>定义我们的定制教练来轻松做到这一点:</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="4622" class="ng la it nc b gy nh ni l nj nk">from detectron2.engine import DefaultTrainer<br/>from detectron2.evaluation import COCOEvaluator</span><span id="fed2" class="ng la it nc b gy nv ni l nj nk">class CocoTrainer(DefaultTrainer):</span><span id="5ca4" class="ng la it nc b gy nv ni l nj nk"><a class="ae ki" href="http://twitter.com/classmethod" rel="noopener ugc nofollow" target="_blank">@classmethod</a><br/>  def build_evaluator(cls, cfg, dataset_name, output_folder=None):</span><span id="8b3b" class="ng la it nc b gy nv ni l nj nk">if output_folder is None:<br/>        os.makedirs("coco_eval", exist_ok=True)<br/>        output_folder = "coco_eval"</span><span id="b1da" class="ng la it nc b gy nv ni l nj nk">return COCOEvaluator(dataset_name, cfg, False, output_folder)</span></pre><p id="79d9" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">好了，现在我们有了<code class="fe ns nt nu nc b">COCO Trainer</code>，我们可以开始训练了:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ob"><img src="../Images/731d58c0a374ff2cde4954d1601a110c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8il_1hD9MmC4-MDW.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">培养⏰</p></figure><p id="1df2" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">培训将持续一段时间，并在我们的验证集上打印出评估指标。好奇想知道什么图是用来评价的？查看这篇关于<a class="ae ki" href="https://blog.roboflow.ai/what-is-mean-average-precision-object-detection/" rel="noopener ugc nofollow" target="_blank">分解图</a>的文章。</p><p id="d47a" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">一旦训练结束，我们可以继续进行评估和推断！</p><h1 id="8ff9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">评估检测器 2 的性能</h1><p id="2ef9" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">首先，我们可以显示一个结果的 tensorboard 来查看训练过程的执行情况。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nl"><img src="../Images/325a9cfc837f323e8c2d75a012b3a853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jm5KqRz_mEbnCDAl.png"/></div></div></figure><p id="1a6f" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">这里有很多有趣的指标——最著名的是<code class="fe ns nt nu nc b">total_loss</code>和<code class="fe ns nt nu nc b">validation mAP</code>。</p><p id="e374" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">我们在测试集上运行验证图中使用的相同评估过程。</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="fd96" class="ng la it nc b gy nh ni l nj nk">from detectron2.data import DatasetCatalog, MetadataCatalog, build_detection_test_loader<br/>from detectron2.evaluation import COCOEvaluator, inference_on_dataset</span><span id="6fda" class="ng la it nc b gy nv ni l nj nk">cfg.MODEL.WEIGHTS = os.path.join(cfg.OUTPUT_DIR, "model_final.pth")<br/>cfg.MODEL.ROI_HEADS.SCORE_THRESH_TEST = 0.85<br/>predictor = DefaultPredictor(cfg)<br/>evaluator = COCOEvaluator("my_dataset_test", cfg, False, output_dir="./output/")<br/>val_loader = build_detection_test_loader(cfg, "my_dataset_test")<br/>inference_on_dataset(trainer.model, val_loader, evaluator)</span></pre><p id="929e" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">屈服:</p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="045b" class="ng la it nc b gy nh ni l nj nk">Accumulating evaluation results...<br/>DONE (t=0.03s).<br/> Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.592<br/> Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.881<br/> Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.677<br/> Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.178<br/> Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.613<br/> Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.411<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.392<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.633<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.684<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.257<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.709<br/> Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.439<br/>[06/23 18:39:47 d2.evaluation.coco_evaluation]: Evaluation results for bbox: <br/>|   AP   |  AP50  |  AP75  |  APs   |  APm   |  APl   |<br/>|:------:|:------:|:------:|:------:|:------:|:------:|<br/>| 59.169 | 88.066 | 67.740 | 17.805 | 61.333 | 41.070 |<br/>[06/23 18:39:47 d2.evaluation.coco_evaluation]: Per-category bbox AP: <br/>| category   | AP     | category   | AP     | category   | AP     |<br/>|:-----------|:-------|:-----------|:-------|:-----------|:-------|<br/>| cells      | nan    | Platelets  | 40.141 | RBC        | 60.326 |<br/>| WBC        | 77.039 |            |        |            |        |</span></pre><p id="5209" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">该评估将让您很好地了解新的 custom Detectron2 探测器在野外的表现。同样，如果你想了解更多关于这些指标的信息，请看这篇文章<a class="ae ki" href="https://blog.roboflow.ai/what-is-mean-average-precision-object-detection/" rel="noopener ugc nofollow" target="_blank">分解图</a>。</p><h1 id="ec47" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">对测试图像运行 Detectron2 推理</h1><p id="fb60" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">最后，我们可以在真实图像上运行我们新的定制检测器 2 检测器！请注意，这些图像是<strong class="lt iu">模特从未见过的</strong></p><pre class="kk kl km kn gt nb nc nd ne aw nf bi"><span id="1bee" class="ng la it nc b gy nh ni l nj nk">cfg.MODEL.WEIGHTS = os.path.join(cfg.OUTPUT_DIR, "model_final.pth")<br/>cfg.DATASETS.TEST = ("my_dataset_test", )<br/>cfg.MODEL.ROI_HEADS.SCORE_THRESH_TEST = 0.7   # set the testing threshold for this model<br/>predictor = DefaultPredictor(cfg)<br/>test_metadata = MetadataCatalog.get("my_dataset_test")</span><span id="c1b0" class="ng la it nc b gy nv ni l nj nk">from detectron2.utils.visualizer import ColorMode<br/>import glob</span><span id="7c68" class="ng la it nc b gy nv ni l nj nk">for imageName in glob.glob('/content/test/*jpg'):<br/>  im = cv2.imread(imageName)<br/>  outputs = predictor(im)<br/>  v = Visualizer(im[:, :, ::-1],<br/>                metadata=test_metadata, <br/>                scale=0.8<br/>                 )<br/>  out = v.draw_instance_predictions(outputs["instances"].to("cpu"))<br/>  cv2_imshow(out.get_image()[:, :, ::-1])</span></pre><p id="ccc7" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">屈服:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/30f53583046c4c0991182995a0c25e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/0*bwFTMpn6yz2AW1W2.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">测试图像上的推断看起来相当不错！</p></figure><p id="fe7c" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">我们的模型做出了很好的预测，表明它已经学会了如何识别红细胞、白细胞和血小板。</p><p id="fc46" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">您可以考虑使用<code class="fe ns nt nu nc b">SCORE_THRESH_TEST</code>来改变模型进行预测所需的置信度阈值。</p><p id="4fd0" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">您现在可以将权重保存在<code class="fe ns nt nu nc b">os.path.join(cfg.OUTPUT_DIR, "model_final.pt")</code>中，以便将来通过导出到 Google Drive 进行推断。</p><p id="4a28" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">您还可以在<code class="fe ns nt nu nc b">outputs</code>对象中看到潜在的预测张量，以便在应用程序的其他地方使用。</p><h1 id="60af" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="7878" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">恭喜你！现在，您知道如何在一个全新的领域中训练您自己的 custom Detectron2 检测器。</p><p id="c79a" class="pw-post-body-paragraph mo mp it lt b lu nm ju mq lw nn jx mr ly no mt mu ma np mw mx mc nq mz na me im bi translated">看不到前进所需的结果？自从 Detectron2 模型动物园发布以来，对象检测模型已经得到了改进——可以考虑看看我们的一些其他教程，例如<a class="ae ki" href="https://blog.roboflow.ai/how-to-train-yolov5-on-a-custom-dataset/" rel="noopener ugc nofollow" target="_blank">如何训练 YOLOv5 </a>和<a class="ae ki" href="https://blog.roboflow.ai/training-yolov4-on-a-custom-dataset/" rel="noopener ugc nofollow" target="_blank">如何训练 YOLOv4 </a>，或者这篇关于<a class="ae ki" href="https://blog.roboflow.ai/yolov5-improvements-and-evaluation/" rel="noopener ugc nofollow" target="_blank">在 YOLO v5 </a>中的改进的文章。</p></div></div>    
</body>
</html>