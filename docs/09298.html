<html>
<head>
<title>Load a Large spaCy model on AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 AWS Lambda 上加载大型空间模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/load-a-large-spacy-model-on-aws-lambda-e1999e5e24b5?source=collection_archive---------18-----------------------#2020-07-03">https://towardsdatascience.com/load-a-large-spacy-model-on-aws-lambda-e1999e5e24b5?source=collection_archive---------18-----------------------#2020-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3019" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 spaCy 和 AWS Lambda 的无服务器 NLP</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f558c37477259a962ec8d39d98ab1236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8wmrtTba2fTaYunpgUdY5A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">保罗·塞尚/来自<a class="ae ky" href="https://commons.wikimedia.org/wiki/File:Paul_Cezanne_Apples_and_Oranges.jpg" rel="noopener ugc nofollow" target="_blank">维基媒体</a>的公共领域</p></figure><p id="eb6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">spaCy 是一个有用的工具，它允许我们执行许多自然语言处理任务。当将 spaCy 集成到现有的应用程序中时，使用 AWS Lambda 和 API Gateway 将其作为 API 提供会很方便。然而，由于<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank"> Lambda 的限制</a>，很难部署大型模型。</p><p id="d9e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示如何使用最近发布的特性<a class="ae ky" href="https://aws.amazon.com/jp/blogs/aws/new-a-shared-file-system-for-your-lambda-functions/" rel="noopener ugc nofollow" target="_blank">部署 spaCy，以便在 AWS Lambda </a>上挂载弹性文件系统(EFS)。通过使用这个特性，我们可以将一个大尺寸的模型存储到 EFS，并从 Lambda 函数中加载它。具体来说，可以加载比 Lambda 的<code class="fe lv lw lx ly b">/tmp</code> (512MB)中可用空间更大的数据。</p><p id="e214" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整体架构如下。Lambda 在 Lambda 层上加载 spaCy 包。EFS 商店的空间模型。Lambda 然后从 EFS 加载模型。为了实现冗余，四个子网位于两个不同的可用性区域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/1d89bd8cbff7e9ac47cafcd208b0b62c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lr4Of_8eKISU1KEH16lEig.png"/></div></div></figure><p id="4c1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要求:</p><ul class=""><li id="0a5f" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated">码头工人</li><li id="6609" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">AWS CLI</li></ul><h1 id="d64e" class="mo mp it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">创建 VPC 和子网</h1><p id="19ad" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">首先，我们必须配置可以到达 EFS 山目标的 VPC。在这里，我们创建了一个 VPC、一个 internet 网关、两个 NAT 网关和四个子网(两个公有，两个私有)。</p><p id="a2b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 VPC 控制台中，我选择<strong class="lb iu">创建 VPC </strong>并设置一个<strong class="lb iu">名称标签</strong>和<strong class="lb iu"> IPv4 CIDR 块</strong>，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/3214ca53b24be08a1d5b40c94d6eb4be.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*WMoG4Ks6t6VKETkpvSq_Pg.png"/></div></figure><p id="277d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一步中，我将创建一个 internet 网关，通过以下设置从 VPC 连接 Internet。之后，我将它附加到创建的 VPC 上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/98686bed8f4b1fd9b48ddb0446070db8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aQm10VmSl4cwsN9UJiYoYw.png"/></div></div></figure><p id="6943" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一步中，我使用以下设置创建了四个子网(<em class="nn"> public-spacy-1、public-spacy-2、private-spacy-1、private-spacy-2 </em>)。注意<em class="nn"> public-spacy-1 </em>和<em class="nn"> private-spacy-1 </em>具有相同的可用区域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/2cde871b42ee68d83104ea07bdfe13f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9XvvAsTFa4oiWm3V_2ifQ.png"/></div></div></figure><p id="f2a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我创建了两个 NAT 网关，并将其连接到公共子网，以便从私有子网中的 lambda 函数访问互联网。我给 NAT 网关起了名字:<strong class="lb iu"> NAT 空间 1 </strong>和<strong class="lb iu"> NAT 空间 2 </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/a77a634f37fe1e5e55b8a4486d77532e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4YNwYtrPN2JimrkifzhJw.png"/></div></div></figure><p id="0f99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我创建路由表。对于公共子网，我添加一个目的地<strong class="lb iu"> 0.0.0.0/0 </strong>和一个目标<strong class="lb iu">互联网网关</strong>来访问互联网。对于私有子网，我为<strong class="lb iu"> private-spacy-1 </strong>添加了目的地<strong class="lb iu"> 0.0.0.0/0 </strong>和目标<strong class="lb iu"> NAT spaCy 1 </strong>，为<strong class="lb iu"> private-spacy-2 </strong>添加了<strong class="lb iu"> NAT spaCy 2 </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/9b2b1ae0e18688501243556524bdc223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8HEHbAPKIpSGhu5z9O3ug.png"/></div></div></figure><h1 id="4143" class="mo mp it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">创建弹性文件系统</h1><p id="2726" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在 EFS 控制台中，我选择<strong class="lb iu">创建文件系统</strong>并确保默认的 VPC 及其子网被选中。对于所有子网，我使用一个安全组，它允许网络访问 VPC 中的其他资源。为了简单起见，我设置了一个允许所有流量的安全组。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/368aa45758b04816324d354aa2b38d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9B3_g1ATtlARb7QRvr2UQ.png"/></div></div></figure><p id="54e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步，我给文件系统一个<strong class="lb iu">名称</strong>标签，并选择<strong class="lb iu">下一步</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8ad1285092ca1a5361ea40a869c9594e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0NLvvFvg4Yr2AFJ9j-ZGZw.png"/></div></div></figure><p id="4c9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我选择<strong class="lb iu">添加接入点</strong>。我用<code class="fe lv lw lx ly b">1001</code>表示<code class="fe lv lw lx ly b">User ID, Group ID, Owner User ID and Owner Group ID</code>，用<code class="fe lv lw lx ly b">750</code>表示权限。另外，我限制了对<code class="fe lv lw lx ly b">/models</code>路径的访问。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/359986e3b13100dfe34b0817b3fe8dfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vxQP0TvNQXDLvYIYlHwrA.png"/></div></div></figure><p id="eb8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">EFS 的创作完成了。让我们进入下一步。</p><h1 id="e82c" class="mo mp it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">将空间发布到 Lambda 图层</h1><p id="6832" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">下一步，我们将空间发布为 Lambda 图层。我们必须做到以下几点:</p><ul class=""><li id="cdd5" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated">安装空间</li><li id="5d70" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">将其压缩为 Zip 文件</li><li id="185a" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">将文件发布到 Lambda 层</li></ul><p id="bbed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，我准备了以下 shell 脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="488c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你只需要像<code class="fe lv lw lx ly b">sh publish_spacy_as_lambda_layer.sh</code>一样执行它。</p><h1 id="7752" class="mo mp it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">创建 Lambda 函数</h1><p id="d338" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">接下来，我们创建一个 Lambda 函数。在 Lambda 控制台中，创建一个函数并选择 Python 3.7 作为运行时。对于权限，选择一个附加了策略<code class="fe lv lw lx ly b">AWSLambdaVPCAccessExecutionRole</code>和<code class="fe lv lw lx ly b">AmazonElasticFileSystemClientReadWriteAccess</code>的角色。</p><p id="0ef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建函数后，我们设置 VPC 配置。这里，我们需要指定与我们为 EFS 装载点指定的相同的安全组和 VPC，并选择专用子网。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/b07dcee54ac8de43f26bf4a7157e5f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Bm27OveEpB6eTu3czF_3w.png"/></div></div></figure><p id="823a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们选择<strong class="lb iu">添加文件系统。</strong>我们选择之前已经创建的 ESF 和接入点。这里，我们将<code class="fe lv lw lx ly b">/mnt/models</code>设置为本地挂载点。这是安装接入点的路径，对应于 EFS 中的<code class="fe lv lw lx ly b">/models</code>目录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/36327c29b424390ae969d3453912d404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrce_OCenibRolMV1gVm2w.png"/></div></div></figure><p id="56c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在图层部分，我们选择添加一个图层来添加空间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/f7bfb0076f7adf5c9fdd71022f728378.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zf2Ej0ybCSAGcodjK894OA.png"/></div></div></figure><p id="f360" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在函数编辑器中，复制并粘贴以下代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="c5ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们应该增加内存分配和超时值。如果内存分配不够大，将会出现以下错误。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="df22" class="oc mp it ly b gy od oe l of og">{<br/>  "errorType": "Runtime.ExitError",<br/>  "errorMessage": "RequestId: Error: Runtime exited with error: signal: killed"<br/>}</span></pre><p id="ecaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为测试，当我用数据<code class="fe lv lw lx ly b">{"text": "He works at Google."}</code>测试时，会返回如下响应。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="4c15" class="oc mp it ly b gy od oe l of og">[<br/>  {<br/>    "text": "Google",<br/>    "label": "ORG",<br/>    "start": 12,<br/>    "end": 18<br/>  }<br/>]</span></pre><h1 id="0765" class="mo mp it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">参考</h1><ul class=""><li id="bcdc" class="ma mb it lb b lc ng lf nh li oh lm oi lq oj lu mf mg mh mi bi translated"><a class="ae ky" href="https://aws.amazon.com/jp/blogs/aws/new-a-shared-file-system-for-your-lambda-functions/" rel="noopener ugc nofollow" target="_blank">新 Lambda 函数的共享文件系统</a></li><li id="fa6d" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank">AWSλ限值</a></li><li id="f6fa" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://blog.scottlogic.com/2019/05/11/spacy-ner.html" rel="noopener ugc nofollow" target="_blank">云中的自然语言处理</a></li><li id="09b9" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="http://geoffpg.com/spacy-and-lambda/" rel="noopener ugc nofollow" target="_blank">使用 Spacy 和 AWS Lambda 创建无服务器 NLP API</a></li></ul></div></div>    
</body>
</html>