<html>
<head>
<title>Deploying Deep Learning Models using TensorFlow Serving with Docker and Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 TensorFlow 与 Docker 和 Flask 一起部署深度学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-deep-learning-models-using-tensorflow-serving-with-docker-and-flask-3b9a76ffbbda?source=collection_archive---------11-----------------------#2020-04-28">https://towardsdatascience.com/deploying-deep-learning-models-using-tensorflow-serving-with-docker-and-flask-3b9a76ffbbda?source=collection_archive---------11-----------------------#2020-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="df5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常，任何数据科学项目的生命周期都包括定义问题陈述、收集和预处理数据，然后是数据分析和预测建模，但任何数据科学项目最棘手的部分是模型部署，我们希望最终用户使用我们的模型。有许多部署机器学习模型的方法，但 TensorFlow serving 是一个高性能的模型部署系统，它使在生产环境中随着时间的推移维护和更新模型变得非常容易。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a695222768696175e4769d730e513b01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-a5QVZFqJ06W7i1di1uIXg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">深度学习模型部署，TensorFlow 服务在 Docker 中运行，由 Flask App 使用</p></figure><p id="cb43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本教程中，我们将借助 Docker 提供的 TensorFlow 部署一个预训练的 TensorFlow 模型，还将使用 Flask web framework 创建一个可视化 web 界面，该界面将用于从所提供的 TensorFlow 模型中获取预测，并使最终用户能够通过 API 调用进行消费。</p><p id="547c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">TensorFlow serving 为开发人员提供了一个将人工智能融入软件系统的简单集成，并且已经被用于生产大量的谷歌产品。它可以同时服务于多个模型和同一模型的多个版本。Flask 是一个轻量级的 python web 框架，它让开发者可以轻松快速地创建 web 应用。Docker 是一个将软件组件隔离到容器中的工具，所有的软件依赖项都作为一个包安装和部署在容器中。</p><h1 id="2979" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">让我们把手弄脏吧！！</strong></h1><p id="fa39" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">本教程将假设您运行的是 python 3.7 版的 Windows</p><p id="ad41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们看一下目录结构，以便更好地理解模型结构和 Flask web app。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/18335458e394f387b7662547af74fb34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*Jav049cpA1xyOjXNClvJ4g.png"/></div></figure><ul class=""><li id="3087" class="mj mk it js b jt ju jx jy kb ml kf mm kj mn kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">App.py</code>—flask app 的主应用文件/控制器</li><li id="9e37" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">Model.py</code> —将 TensorFlow 模型服务器连接到 flask web 应用程序</li><li id="dd32" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">pets </code> —预训练保存的猫和狗分类 ML 模型</li><li id="0354" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">Template</code> —包含 flask 应用程序将提供的 html 文件</li><li id="fc42" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">static </code> —包含应用程序的静态内容，例如图像</li></ul><h1 id="e6b6" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">在本地主机上设置 TensorFlow 服务服务器</strong></h1><p id="c4d4" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">因为我们的 pets 文件夹中有一个预先训练好的模型，所以我们必须指定本地机器上的模型路径和模型将暴露到的端口，以便我们的 Flask 应用程序可以调用本地主机上的那个端口，并发送数据以获得预测。</p><p id="fe4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Docker RUN 命令将安装 TensorFlow 服务的 Docker 映像，并将创建指向 pets 模型的 docker 实例。</p><p id="007a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nb">先决条件:</em>请启用 Hyper-V 功能并安装<a class="ae le" href="https://docs.docker.com/docker-for-windows/install/" rel="noopener ugc nofollow" target="_blank"> docker </a></p><blockquote class="nc nd ne"><p id="df0a" class="jq jr nb js b jt ju jv jw jx jy jz ka nf kc kd ke ng kg kh ki nh kk kl km kn im bi translated">以管理员身份运行 CMD 并执行以下命令:<br/> <code class="fe ms mt mu mv b">docker run -p 8501:8501 — name=pets -v “C:\pets:/models/pets/1” -e MODEL_NAME=pets tensorflow/serving</code></p></blockquote><p id="1a1d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">命令行参数的详细信息如下:</p><p id="25df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ms mt mu mv b">-p 8501:8501 </code> —指定本地主机上 TensorFlow 服务器的端口 8501，docker 公开冒号后的端口用于服务</p><p id="a82b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ms mt mu mv b">--name=pets </code> —指定 docker 实例名称</p><p id="3c39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ms mt mu mv b">-v “C:\pets:/models/pets/1”</code> —指定本地主机上的模型路径和 docker 实例<br/>内的模型路径<strong class="js iu">注意:</strong>在模型路径<code class="fe ms mt mu mv b">“/models/pets/1”</code>中，目录名<code class="fe ms mt mu mv b">“pets”</code>应该与模型名环境变量相匹配，<code class="fe ms mt mu mv b">/1</code>表示模型的版本，可以使用这个版本号升级模型。</p><p id="b15a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ms mt mu mv b">-e MODEL_NAME=pets</code> —指定模型名称环境变量</p><p id="c81b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ms mt mu mv b">tensorflow/serving </code> —指定要下载的 docker 图像名称</p><p id="d9c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">执行该命令后，您应该会得到以下输出:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ni"><img src="../Images/c1f30991657da8df3eb08ab2af7f2ea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SWwvnEfLZFONAMKgvLTxog.png"/></div></div></figure><p id="ca9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们已经在<code class="fe ms mt mu mv b">localhost:8501</code>上设置了模型服务器，让我们开发可视化 web 界面，它将使用 REST API 调用来使用模型。</p><h1 id="8c46" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">使用</strong>引导程序对烧瓶 App 进行编码</h1><p id="3962" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在，我们将遍历<code class="fe ms mt mu mv b">app.py</code>文件，它将作为应用程序的控制器。这里，我们正在创建 flask app 的一个实例，并向接受 GET 和 POST 请求并将上传的图像保存在静态文件夹中的<code class="fe ms mt mu mv b">index.html </code>添加一个默认路由，然后静态文件夹调用 model.get_prediction 函数来获取预测并将其传递给<code class="fe ms mt mu mv b">result.html</code>。</p><p id="1433" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将简单地在 bootstrap 类中传递 app 实例，以便在 html 文件中使用 Bootstrap 功能。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="5ba7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以在<code class="fe ms mt mu mv b">index.html </code>中编写一个完整的 html 代码，也可以使用 jinja 模板引擎将其分解成组件。现在，为了在我们的 html 文件中使用 bootstrap 和一些常见功能，我们将编写一个<code class="fe ms mt mu mv b">base.html </code>，它将从 Bootstrap 扩展<code class="fe ms mt mu mv b">base.html </code>，并设置应用程序的标题和定义内容块占位符。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="ca1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们编写一个<code class="fe ms mt mu mv b">index.html </code>，在其中我们扩展了 base.html，并进一步开发了上传图像的功能。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="a459" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用下面的代码在<code class="fe ms mt mu mv b">result.html</code>中显示来自模型的预测和输入图像</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="ce83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止，TensorFlow 服务器已经启动，可视化 web 界面开发也接近完成，让我们通过在<code class="fe ms mt mu mv b">model.py </code>中编写一个小函数来连接这两个独立的实体，该函数将在 JSON 对象中加载、预处理和编码图像，并使用<code class="fe ms mt mu mv b">MODEL_URI</code>向模型服务器发出 post 请求，并对模型预测执行后处理。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="580a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">设置环境并运行应用</strong></h1><p id="304c" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">为避免现有安装出现问题，建议为此应用创建一个新的虚拟环境。</p><p id="539a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nb">先决条件:</em>请<a class="ae le" href="https://docs.anaconda.com/anaconda/install/windows/" rel="noopener ugc nofollow" target="_blank">安装 anaconda </a>用于管理虚拟环境。</p><p id="ed2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们创建一个<a class="ae le" href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-with-commands" rel="noopener ugc nofollow" target="_blank">虚拟环境</a>并通过执行以下命令<a class="ae le" href="https://pypi.org/project/Flask/" rel="noopener ugc nofollow" target="_blank">安装 flask </a>及其依赖项。</p><blockquote class="nc nd ne"><p id="1451" class="jq jr nb js b jt ju jv jw jx jy jz ka nf kc kd ke ng kg kh ki nh kk kl km kn im bi translated"><code class="fe ms mt mu mv b">conda create –n flaskapp python=3.7</code></p><p id="6bf9" class="jq jr nb js b jt ju jv jw jx jy jz ka nf kc kd ke ng kg kh ki nh kk kl km kn im bi translated"><code class="fe ms mt mu mv b">conda activate flaskapp</code></p><p id="aae5" class="jq jr nb js b jt ju jv jw jx jy jz ka nf kc kd ke ng kg kh ki nh kk kl km kn im bi translated"><code class="fe ms mt mu mv b">pip install tensorflow==2.1.0 flask flask-bootstrap requests pillow grpcio grpcio-tools</code></p></blockquote><p id="f9ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">转到保存<code class="fe ms mt mu mv b">app.py </code>的目录，使用以下命令启动 flask 应用程序，但要确保 TensorFlow 服务的 docker 实例已经启动并正在运行。</p><blockquote class="nc nd ne"><p id="a619" class="jq jr nb js b jt ju jv jw jx jy jz ka nf kc kd ke ng kg kh ki nh kk kl km kn im bi translated"><code class="fe ms mt mu mv b">python app.py</code></p></blockquote><p id="984d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您获得以下输出，这意味着应用程序在本地主机上成功运行。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/d2549c20bcd398f9b03d8af8274af179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AkIf1ex6hvke_TI0MPfhRA.png"/></div></div></figure><p id="2d1d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">flask 的默认端口是 5000，因此通过键入<code class="fe ms mt mu mv b">localhost:5000 </code>在浏览器中访问该应用程序，您应该会看到以下输出。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/0f2e0aa7fca12b3f6081c78d71a9f4fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*Wh3TTn1y7_pvaaCIUDP2Rw.png"/></div></figure><p id="69b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上传猫图像并按下上传按钮后，应用程序将显示以下结果。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/7faf864d0b5095b7545d80bc3ccddebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*9bC9pDj_jAlRk1M9MrQvJg.png"/></div></figure><p id="6f8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样—模型部署从未如此简单。您刚刚学习了如何通过 docker 和 minimal flask web framework 利用 TensorFlow 服务的能力来构建一个简单的 AI 应用程序。</p><p id="1dda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本教程是所有希望开发令人兴奋的人工智能应用程序的新手的快速入门。你可以在 Keras ( <a class="ae le" href="https://github.com/keras-team/keras-applications" rel="noopener ugc nofollow" target="_blank">这里</a>)找到很多预先训练好的模型，在<a class="ae le" href="https://github.com/muhammadarslanidrees/Deploying-Deep-Learning-Models-using-TensorFlow-Serving-with-Docker-and-Flask" rel="noopener ugc nofollow" target="_blank"> Github </a>可以找到本教程的完整代码。</p><p id="2844" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请在评论中留下您的疑问、反馈或建议。敬请关注更多内容！</p></div></div>    
</body>
</html>