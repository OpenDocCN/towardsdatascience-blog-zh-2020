<html>
<head>
<title>Churn Prediction using PySpark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PySpark进行流失预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/churn-prediction-using-spark-1d8f6bd4092d?source=collection_archive---------58-----------------------#2020-04-15">https://towardsdatascience.com/churn-prediction-using-spark-1d8f6bd4092d?source=collection_archive---------58-----------------------#2020-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9a6c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">预测音乐流媒体应用的用户流失</h2></div><h1 id="c92d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">项目概述</h1><p id="be15" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">该项目旨在探索用户交互数据，以识别客户流失。这个问题特别关注使用Spark处理大型数据集。PySpark用于清理、辩论和处理数据，并执行建模和调优以构建流失预测模型。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="284d" class="kf kg iq bd kh ki ma kk kl km mb ko kp jw mc jx kr jz md ka kt kc me kd kv kw bi translated">问题陈述</h1><p id="c358" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">Sparkify是一家音乐流媒体公司，和Spotify一样。<a class="ae mf" href="https://www.kaggle.com/saksri/sparkify" rel="noopener ugc nofollow" target="_blank">数据集</a>包含用户交互的日志。完整的数据集为12 GB。我们正在处理一个128MB的较小数据集。使用用户日志，我们需要识别有流失倾向的客户，以便为他们提供促销。我们可以确定哪些因素是客户流失的重要指标。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="3d0e" class="kf kg iq bd kh ki ma kk kl km mb ko kp jw mc jx kr jz md ka kt kc me kd kv kw bi translated">探索性数据分析</h1><p id="210c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">该数据集包含286，500个用户交互的日志。它有关于用户、交互、时间戳、用户使用的设备等信息。数据的模式如下:</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/47dbabab4092d90ebc5d4c0b12eac634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*xhhmCSXLsXDvYcez1eVEZw.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">数据模式</p></figure><p id="d926" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">数据集快照如下所示:</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mx"><img src="../Images/de4cf125f0f74fed622df1d5d8d3b3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GcXRp_5CzexxZQiQoq2-2A.png"/></div></div></figure><h2 id="9737" class="nc kg iq bd kh nd ne dn kl nf ng dp kp lg nh ni kr lk nj nk kt lo nl nm kv nn bi translated">数据清理</h2><p id="ae34" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们清理数据集以删除缺少<strong class="kz ir"> <em class="no"> userId </em> </strong>和<strong class="kz ir"> <em class="no"> sessionId </em> </strong>的记录，其中<strong class="kz ir"> <em class="no"> userId </em> </strong>为空，我们有278，154条记录，因为这些记录中的大部分是尚未登录或希望注册的用户。我们还将注册日期和当前时间从时间戳转换为更容易理解的日期时间格式。页面功能列出了数据集中所有可能的用户操作。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi np"><img src="../Images/f4fc91e54a498d82d9861ceccf7982e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/format:webp/1*nVogbV5Fm53o5lcRdbKGeA.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用户操作</p></figure><p id="98b2" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们将客户流失定义为用户执行取消确认操作。这项服务有两种订阅级别——免费和付费。用户可以升级或降级他们的订阅级别。我们创建了一个标志来标识用户何时降级他们的帐户，以及用户是否发生了搅动。</p><h2 id="ebaf" class="nc kg iq bd kh nd ne dn kl nf ng dp kp lg nh ni kr lk nj nk kt lo nl nm kv nn bi translated">电子设计自动化(Electronic Design Automation)</h2><p id="196c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们通过观察一些特征的分布来识别数据中的模式。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/326245264de972ad8eb401c648330b3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*czibKBc6G-lgZTDkQ4L2bg.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">流失用户的分布</p></figure><p id="0010" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">被搅动的用户在数据集中的分布表明数据集严重不平衡。虽然这是流失分析问题的标准，但我们需要在建模过程中考虑这一点。我们需要通过欠采样来平衡我们的数据集，或者选择适当的指标来更好地考虑少数类。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/f1b44e0a49af310ac3a7276dfcbf943a.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*nz5pWNJhMNnp3UaxmwMmJA.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">按订阅级别分发</p></figure><p id="c84a" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们音乐流媒体服务的免费用户比付费用户多得多。我们还应该检查给定订阅级别的用户是否有流失倾向。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/34b62258af0160410268fa36c6b5691d.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*-hNcwkMl4f9WIHXeB7gHNQ.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">按订阅级别划分的流失</p></figure><p id="76e2" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们注意到付费用户比免费用户更有可能流失。这可能是预测用户流失的一个重要因素。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/38a455a4f7fec6baf79fd930bb7274f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*LdvuRSMrqfOFgU1TZvopMQ.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用户的性别</p></figure><p id="e886" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们的男性用户比女性用户多，但数字相差不大，所以我们可以认为我们的数据集性别基本平衡。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/284464b2a3d9498b0a35ff3b1b45cad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*muqW3LhuDn1A0mehoFS8Lw.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">按性别划分的用户流失</p></figure><p id="ae3c" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们注意到，与女性用户相比，男性用户更容易流失。我们还可以分析组合中订阅级别的趋势。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/7dacd1281edc3f306e6970c6d295a0d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*2TUhn7t1A-3eDTEEoIebyQ.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">每次收听的歌曲数量</p></figure><p id="970e" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们发现，与付费用户相比，免费用户每次收听的歌曲要少得多。此外，没有流失的用户平均每次听的歌曲略多，尤其是付费用户。</p><p id="1d80" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">最后，让我们看看流媒体服务上最受欢迎的艺术家。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/f8347eb6842886d8bad49f754aae6a69.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*ATt-Z0Ysy4TCpY_bk3drWA.png"/></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="2153" class="kf kg iq bd kh ki ma kk kl km mb ko kp jw mc jx kr jz md ka kt kc me kd kv kw bi translated">特征工程</h1><p id="35e8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">由于数据集包含用户交互，我们需要在用户层面上对它们进行聚合，以构建用户档案，这将有助于识别客户流失倾向。</p><p id="9c24" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">基于数据集中可用的特征和我们对用户行为的理解，我们创建代表用户参与度、用户简档等的特征。</p><p id="993c" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们识别用户寿命、用户性别等特征。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/444ecee0c3ef4ca17766172ce810c6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*6Q6_spuGcy4dk9cTj5MxGw.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用户生命周期功能</p></figure><p id="4533" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们还创建了用户参与功能，如添加的朋友数量，添加到播放列表的歌曲数量，对歌曲的褒贬。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/9aadc84a1b83efba7bacf9151ac8bf7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*IuUBWZizwUURc_GbLTTkwA.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">添加的好友数量</p></figure><p id="c9f8" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们还创建了与他们的音乐收听行为相关的功能，如用户收听的歌曲数量、用户收听的艺术家数量、每次会话的歌曲数量等</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/d6731016dca927cdb049a6c8ec51408f.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*67Xv8krQQ_fnyMjyrjm7rw.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用户收听的歌曲数量</p></figure><p id="7704" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">一旦我们创建了这些特征，我们就为每个用户合并它们，以创建我们将用于建模的最终数据库。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nx"><img src="../Images/640e624ce6120bf21b51121ed0eca971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cL4yxSn4emzwQmVuINPrvQ.png"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">最终数据帧</p></figure><p id="ebb2" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">接下来，我们移动到建模部分。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="cef5" class="kf kg iq bd kh ki ma kk kl km mb ko kp jw mc jx kr jz md ka kt kc me kd kv kw bi translated">建模</h1><blockquote class="ny nz oa"><p id="5dba" class="kx ky no kz b la ms jr lc ld mt ju lf ob mu li lj oc mv lm ln od mw lq lr ls ij bi translated">注意:230 MB的中型数据集用于建模部分，训练是在IBM Watson集群上完成的，而EDA是在128 MB的小型数据集上完成的。</p></blockquote><p id="0d70" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">在开始对数据集进行建模之前，我们需要将要素转换为数字要素，然后对要素进行缩放。是否缩放数据集取决于我们计划使用的模型。我们还将把我们的数据集分成训练验证测试集，以确保对模型性能的准确评估。我对数据集使用了70:15:15的分割。</p><p id="b0ef" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">现在我们已经准备好了数据集，我们将根据基线模型对其进行测试。在我们建立模型之前，我们将问题定义为一个二元分类问题，其中0表示用户没有流失，1表示用户流失。此外，由于我们的数据集是不平衡的，准确性可能不是最好的衡量标准，因为我们可以预测所有值为0，并具有高准确性，但召回率很低。因此，为了平衡这一点，我们使用F1作为我们的指标。</p><p id="a8a8" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我认为虚拟分类器总是预测用户不会流失。我们也可以有一个随机预测用户流失的基线模型。我们的虚拟分类器的结果如下:</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oe"><img src="../Images/9a1fa2ce605ea2d68365929bd1179985.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*bjKlqKWHUXsnU17f-hroaA.png"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">虚拟分类器</p></figure><p id="84a4" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们尝试其他模型，如逻辑回归、随机森林分类器、线性支持向量和梯度提升树分类器。我们在训练集上拟合模型，并对验证数据集进行预测。然后我们选择最好的F1分数。在我们的例子中，它是随机森林分类器。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi of"><img src="../Images/3321dd10e221dd582021c15da317c2a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*xo95dJqrd4sfogDy75ZaRg.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">逻辑回归度量</p></figure><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi og"><img src="../Images/aeecbf47a27d793a4538eeef7a31483a.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/1*TSbnAYzbUHD4WbOJ8EdyAA.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">梯度增强的树分类器度量</p></figure><p id="6a84" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">接下来，我们调整我们的随机森林分类器模型。一旦我们有了一个最终的模型，我们就用它来对测试集进行预测，从而对模型性能进行基准测试。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/ad04cb18be6d0fc947024357590e007c.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*0wXFR-jd8jedXjxFx_db-w.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">最终模型的测试集结果</p></figure><p id="2f94" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们可以看看我们模型的特征重要性。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/bdba58bf2c238c91690452d16dd15042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*aGG-v4swpAwMlk-GDYkfdQ.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">特征重要性</p></figure><p id="dfc0" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们看到user_lifetime对预测客户流失的影响最大。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="038f" class="kf kg iq bd kh ki ma kk kl km mb ko kp jw mc jx kr jz md ka kt kc me kd kv kw bi translated">结论</h1><p id="6aad" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们利用CRISP-DM过程研究了客户流失预测问题。这与增加商业价值的真实问题非常相似。我们可以通过战略性地实施从探索和建模中收集的见解来留住用户并增加公司收入。</p><p id="6dba" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">对于像这样高度不平衡的数据集，准确性不是一个可靠的指标，所以我们使用F1分数。我们还可以尝试对数据集进行SMOTE过采样或随机欠采样，以平衡类。</p><p id="b550" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们可以提取其他特征，如用户使用的设备，并查看它们对客户流失预测的影响。</p><p id="7b88" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">我们尝试在中小型数据集上进行建模练习。我们可以探索完整的12GB数据集。拥有更多少数民族的记录将会提高预测能力。</p><p id="fdab" class="pw-post-body-paragraph kx ky iq kz b la ms jr lc ld mt ju lf lg mu li lj lk mv lm ln lo mw lq lr ls ij bi translated">该项目的完整代码可以在我的Github上找到。</p></div></div>    
</body>
</html>