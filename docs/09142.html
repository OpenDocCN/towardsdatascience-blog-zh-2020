<html>
<head>
<title>How to Secure Your Machine Learning App with CSRF Protection?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 CSRF 保护来保护您的机器学习应用程序？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-secure-your-machine-learning-app-with-csrf-protection-506c3383f9e5?source=collection_archive---------39-----------------------#2020-06-30">https://towardsdatascience.com/how-to-secure-your-machine-learning-app-with-csrf-protection-506c3383f9e5?source=collection_archive---------39-----------------------#2020-06-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="97f4" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">机器学习技巧</h2><div class=""/><div class=""><h2 id="b14f" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">通过真实示例了解 CSRF 保护的内容和原因。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/c17bcd874018c12f813befde796459ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yR432oWfASi4-SM1"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae le" href="https://unsplash.com/@kasiape?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Katarzyna Pe </a>拍摄</p></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><p id="5199" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi mi translated"><span class="l mj mk ml bm mm mn mo mp mq di">那么</span>你已经训练好了你的 ML/DL 模型，现在考虑在云上部署它。最受欢迎的方法之一是将你的模型包装在 Flask 应用程序中，并使用 REST API 提供服务。但是请稍等，让我们为您的应用程序添加一些安全性。我将借助一个真实世界的例子简要解释代码，以及为什么考虑应用程序的安全性很重要。我将尽可能直截了当地介绍实现部分。但是首先，像任何其他教程一样，让我们了解什么是 CSRF，为什么我们真的需要它？</p><h2 id="9df4" class="mr ms iq bd mt mu mv dn mw mx my dp mz lv na nb nc lz nd ne nf md ng nh ni iw bi translated">CSRF 到底是什么？</h2><p id="640a" class="pw-post-body-paragraph lm ln iq lo b lp nj ka lr ls nk kd lu lv nl lx ly lz nm mb mc md nn mf mg mh ij bi translated">跨站点请求伪造(CSRF)，也称为 XSRF、Sea Surf 或 Session Riding，是一种攻击媒介，它欺骗 web 浏览器在用户登录的应用程序中执行不需要的操作。</p><p id="adb3" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">那是什么意思？让我用最简单的术语来解释它。</p><p id="be8d" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我正在做一个<a class="ae le" href="https://github.com/rowhitswami/Indian-Paper-Currency-Prediction" rel="noopener ugc nofollow" target="_blank">个人深度学习</a>项目，它将一张图像(印度纸币)作为输入，并从 10、20、50、100、200、500、2000 新面值的印度货币中预测图像的类别。</p><p id="efac" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated"><strong class="lo ja">问题:</strong>我不是一个安全人员，但是在这个项目中，我注意到我的 API 端点现在是公开的。现在的问题是，你为什么要在乎它是否暴露？这对开发者来说意味着什么？</p><p id="68ac" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated"><strong class="lo ja">回答:</strong>以我的情况来说，互联网上的任何人都可以用所需的数据向我的 app 发送合法的 POST 请求，并获得预测。你真的不希望自己处于这样的场景中，你把上传的图像和预测存储在一个 S3 桶中。如果你使用 AWS 的免费层(像我一样！)，那么这些坏人可以立即消耗你的免费等级的免费配额，最终会给你这样的账单。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/34eda54982ad9bc02077e2e4aec73983.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EHtIRAmT1vI3IvXW.jpg"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">我在亚马逊网络服务上被开了 14k 美元的账单😱(来源:<a class="ae le" href="https://dev.to/juanmanuelramallo/i-was-billed-for-14k-usd-on-amazon-web-services-17fn" rel="noopener ugc nofollow" target="_blank">https://dev . to/juanmanuelramallo/I-was-billed-on-Amazon-web-services-17fn</a>)</p></figure><p id="3e20" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我试图在我的本地机器上重现这个场景，毫无疑问，我能够在我的终端上得到预测。成功执行该命令后，输入图像和预测也存储在我的 S3 存储桶中。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi np"><img src="../Images/0cc7039f9b63eb3417ec15f2b3fd306e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVuozRK_OXw4ybShscfSHA.png"/></div></div></figure><p id="51eb" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">这种合法但伪造的请求被称为跨站点伪造请求(CSRF)。现在的问题是…</p><h2 id="04ad" class="mr ms iq bd mt mu mv dn mw mx my dp mz lv na nb nc lz nd ne nf md ng nh ni iw bi translated">如何为你的应用程序实现 CSRF 保护？</h2><p id="41e5" class="pw-post-body-paragraph lm ln iq lo b lp nj ka lr ls nk kd lu lv nl lx ly lz nm mb mc md nn mf mg mh ij bi translated">根据文档，如果您使用<a class="ae le" href="https://flask-wtf.readthedocs.io/en/stable/api.html#flask_wtf.FlaskForm" rel="noopener ugc nofollow" target="_blank"> FlaskForm </a>来处理请求，您已经获得了 CSRF 保护。如果您没有使用 FlaskForm 或发出 AJAX 请求，您可能需要使用所提供的扩展显式地添加另一层安全性。</p><pre class="kp kq kr ks gt nq nr ns nt aw nu bi"><span id="2a60" class="mr ms iq nr b gy nv nw l nx ny"># app.py</span><span id="97b9" class="mr ms iq nr b gy nz nw l nx ny">from flask import Flask<br/>from flask_wtf.csrf import CSRFProtect, CSRFError</span><span id="4aa3" class="mr ms iq nr b gy nz nw l nx ny">app = Flask(__name__)<br/>app.<!-- -->config['SECRET_KEY']<!-- --> = "anything_unique"<br/>app.config['WTF_CSRF_TIME_LIMIT'] = WTF_CSRF_TIME_LIMIT<br/>CSRFProtect(app)</span></pre><p id="a89b" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">正如您可能已经猜到的，在第一行中，我们正在导入<strong class="lo ja"> Flask </strong>类。这个类的一个实例将是我们的 WSGI 应用程序。在第二行，我们从<strong class="lo ja"> flask_wtf </strong>模块导入<strong class="lo ja"> CSRFProtect </strong>类。</p><p id="7246" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">接下来，我们将创建 Flask 类的实例。在接下来的两行中，我们将设置密钥和 CSRF 令牌的到期时间限制。需要注意的是，没有这个密钥，你就不能真正享受 CSRF 的保护。</p><blockquote class="oa ob oc"><p id="4ab8" class="lm ln od lo b lp lq ka lr ls lt kd lu oe lw lx ly of ma mb mc og me mf mg mh ij bi translated">注意:CSRF 保护需要一个秘密密钥来安全地签署令牌。默认情况下，这将使用 Flask 应用程序的<code class="fe oh oi oj nr b">SECRET_KEY</code>。如果您想使用单独的令牌，您可以设置<code class="fe oh oi oj nr b">WTF_CSRF_SECRET_KEY</code>。</p></blockquote><p id="de51" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我强烈建议您将您的密钥存储在<code class="fe oh oi oj nr b">.env</code>文件中或者作为一个环境变量，这样在将您的代码推向生产时就不会被分发。我会在这篇博客的最后部分谈到<code class="fe oh oi oj nr b">WTF_CSRF_TIME_LIMIT</code>。最后一行是奇迹发生的地方！用<code class="fe oh oi oj nr b">ProtectCSRF</code>扩展注册将会为 Flask 应用启用全球 CSRF 保护。</p><p id="ed19" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">现在，我们将在表单中添加 CSRF 代币的值。</p><pre class="kp kq kr ks gt nq nr ns nt aw nu bi"><span id="1734" class="mr ms iq nr b gy nv nw l nx ny">&lt;!-- index.html --&gt;</span><span id="31a2" class="mr ms iq nr b gy nz nw l nx ny">&lt;form method="post" &gt;<br/>&lt;input type="hidden" name="csrf_token" value="{{ csrf_token() }}" /&gt;<br/>...<br/>...<br/>...<br/>&lt;/form&gt;</span></pre><p id="41a4" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">然而，<a class="ae le" href="https://flask-wtf.readthedocs.io/en/stable/csrf.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>建议在 AJAX 请求的头中添加<code class="fe oh oi oj nr b">csrf_token</code>。</p><p id="f7dd" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">你猜怎么着？我们完了！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/dbc5588939698b59323901cfe363f4d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*7Llwyw5v-7aYw-tQZ_OvFA.gif"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">来源:<a class="ae le" href="https://giphy.com/gifs/intuitquickbooks-danny-devito-quickbooks-intuit-8JW82ndaYfmNoYAekM" rel="noopener ugc nofollow" target="_blank">https://giphy . com/gifs/intuit quickbooks-Danny-devito-quickbooks-intuit-8jw 82 ndayfmnoyaekm</a></p></figure><p id="ea06" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">好吧，你不相信我？这就是证据😅</p><p id="a52e" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">添加代码后，我在我的终端中执行相同的命令，并得到以下响应。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi np"><img src="../Images/4e9f005a4c9f2a77338335ded5d8f5ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NocTJNCk2hMvkDzxx5I3WA.png"/></div></div></figure><p id="9f4d" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">Flask 应用程序在请求体中找不到<code class="fe oh oi oj nr b">csrf_token</code>，因此出现了错误的请求。</p><h2 id="5e0d" class="mr ms iq bd mt mu mv dn mw mx my dp mz lv na nb nc lz nd ne nf md ng nh ni iw bi translated">用户化</h2><ol class=""><li id="54c5" class="ol om iq lo b lp nj ls nk lv on lz oo md op mh oq or os ot bi translated">您可以使用<code class="fe oh oi oj nr b">WTF_CSRF_TIME_LIMIT</code>设置 CSRF 令牌的到期时间。这是 CSRF 令牌的最长期限(秒)。默认值为 3600。如果设置为 None，则 CSRF 令牌在会话生命周期内有效。</li><li id="9797" class="ol om iq lo b lp ou ls ov lv ow lz ox md oy mh oq or os ot bi translated">您还可以在 CSRF 令牌丢失/无效的情况下捕捉错误，并在您的应用程序视图中显示出来。阶级<code class="fe oh oi oj nr b">CSRFError</code>在这里是我们的救援。您只需要在 Flask 应用程序中定义一个简单的路由来捕获 CSRF 令牌异常。</li></ol><pre class="kp kq kr ks gt nq nr ns nt aw nu bi"><span id="fb75" class="mr ms iq nr b gy nv nw l nx ny"><a class="ae le" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.errorhandler(CSRFError)<br/>def handle_csrf_error(e):<br/>    return jsonify({"error": e.description}), 400</span></pre><p id="2630" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">在上面的代码中，我们捕获了 CSRF 可能出现的异常，并以 JSON 格式返回，状态代码为 400(错误请求)。</p><p id="1580" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">您可以根据您的应用进行修改。下面是修改 CSRF 令牌后对 POST 请求的响应。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oz"><img src="../Images/eb20513138c30172370943c63fff7524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HpviLo9LHLWyqj5VuNnWHg.png"/></div></div></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h2 id="92e8" class="mr ms iq bd mt mu mv dn mw mx my dp mz lv na nb nc lz nd ne nf md ng nh ni iw bi translated">结束注释</h2><p id="7525" class="pw-post-body-paragraph lm ln iq lo b lp nj ka lr ls nk kd lu lv nl lx ly lz nm mb mc md nn mf mg mh ij bi translated">本博客中使用的所有代码片段都是我的<a class="ae le" href="https://github.com/rowhitswami/Indian-Paper-Currency-Prediction" rel="noopener ugc nofollow" target="_blank">印度纸币预测</a>项目的一部分。</p><p id="6b0d" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我非常乐意与你见面。你可以访问我的个人网站 www.rohitswami.com<a class="ae le" href="https://www.rohitswami.com" rel="noopener ugc nofollow" target="_blank">了解我更多。还有，你可以在</a><a class="ae le" href="https://www.linkedin.com/in/rowhitswami" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>和<a class="ae le" href="https://www.github.com/rowhitswami/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到我🎉</p><p id="64cc" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我很想听到你对这篇文章的反馈。请随意在下面的评论区发送垃圾邮件。😊</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><p id="b981" class="pw-post-body-paragraph lm ln iq lo b lp lq ka lr ls lt kd lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated"><strong class="lo ja"> <em class="od">来自《走向数据科学》编辑的提示:</em> </strong> <em class="od">虽然我们允许独立作者根据我们的</em> <a class="ae le" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="od">规则和指导方针</em> </a> <em class="od">发表文章，但我们并不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae le" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="od">读者术语</em> </a> <em class="od">。</em></p></div></div>    
</body>
</html>