<html>
<head>
<title>Distributed data pipelines made easy with AWS EKS and Prefect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS EKS 和提督使分布式数据管道变得简单</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/distributed-data-pipelines-made-easy-with-aws-eks-and-prefect-106984923b30?source=collection_archive---------12-----------------------#2020-08-25">https://towardsdatascience.com/distributed-data-pipelines-made-easy-with-aws-eks-and-prefect-106984923b30?source=collection_archive---------12-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b9f8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在几分钟内建立一个分布式云工作流程编排系统，并专注于提供价值而不是管理集群</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/43656d0c218773a7ea56092bd7d409e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GdpO6gHDhI3gTaar"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卢克·切瑟在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6437" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated"><span class="l lw lx ly bm lz ma mb mc md di"> B </span>为 ETL &amp; ML 数据管道构建分布式系统是困难的。如果您尝试自己实现一个，您可能会体验到，将工作流编排解决方案与 Spark 或 Dask 等分布式多节点计算集群捆绑在一起可能很难正确设置和管理。在本文中，您将了解如何获得一个<strong class="lb iu">高度可用、可伸缩的分布式系统</strong>，这将使您的 ETL &amp; ML 数据管道的编排更加愉快，并将<strong class="lb iu">释放您的时间</strong> <strong class="lb iu">来处理数据</strong>并从中产生价值，而不是花费时间来维护集群。</p><p id="850f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整个设置在很大程度上是由 AWS 和 Prefect 自动完成的。另外，一开始你几乎不用花什么钱。为什么？因为我们将使用一个带有<strong class="lb iu">无服务器 Kubernetes 集群</strong>的工作流编排系统作为您的<em class="me">分布式、容错、高度可用、自我修复&amp;自动可伸缩</em>执行层。</p><p id="7b6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">你需要做的就是:</strong></p><ul class=""><li id="093c" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">创建<a class="ae ky" href="https://aws.amazon.com/de/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank"> AWS 帐户</a> &amp; <a class="ae ky" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html" rel="noopener ugc nofollow" target="_blank"> IAM 用户</a>具有创建 AWS ECR、ECS &amp; EKS 资源的编程权限</li><li id="c096" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">通过在 Fargate 上使用 AWS EKS 运行几个 shell 命令来建立一个 Kubernetes 集群(<em class="me">控制面板每小时只需要 0.10 美元！之前是 0.20 美元但是</em><a class="ae ky" href="https://aws.amazon.com/about-aws/whats-new/2020/01/amazon-eks-announces-price-reduction/?nc1=h_ls" rel="noopener ugc nofollow" target="_blank"><em class="me">AWS 2020 年初价格减半</em></a><em class="me"/></li><li id="70fb" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">注册一个免费的<a class="ae ky" href="https://cloud.prefect.io/" rel="noopener ugc nofollow" target="_blank">完美云账户</a> ( <em class="me">免费开发者账户可以让你使用所有功能，但仅限于你自己——如果你想在你的团队中使用它，你需要升级到团队或企业计划</em></li><li id="791b" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">在提督云用户界面中生成一个认证令牌，将您的提督帐户连接到 AWS 上的无服务器 Kubernetes 集群</li><li id="a41c" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">运行分布式数据管道。</li></ul><p id="8c6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧！</p><blockquote class="mt mu mv"><p id="30e8" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>本文使用了提督 1 的代码，不推荐使用。检查最新版本的<a class="ae ky" href="https://docs.prefect.io/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></blockquote><h1 id="7f5f" class="mz na it bd nb nc nd ne nf ng nh ni nj jz nk ka nl kc nm kd nn kf no kg np nq bi translated">无服务器 Kubernetes 集群作为执行层</h1><p id="637d" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">2019 年 12 月，AWS 推出了一个新的 Fargate 功能，对许多人来说，这被认为是一个改变游戏规则的功能——他们引入了一个在 ECS Fargate 上使用<strong class="lb iu"> AWS EKS 的选项，这是一种说法:<strong class="lb iu"> AWS 使 Fargate 服务不仅成为 ECS 的指挥者</strong>，还成为<strong class="lb iu">以及</strong><a class="ae ky" href="https://aws.amazon.com/de/blogs/aws/amazon-eks-on-aws-fargate-now-generally-available/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">【EKS</strong></a>的指挥者。到目前为止，AWS Fargate 是一种只在 AWS ECS 上运行容器的无服务器方式。</strong></p><blockquote class="mt mu mv"><p id="dbd3" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated">EKS 和法盖特让在 AWS 上运行基于 Kubernetes 的应用变得简单明了，因为他们不再需要为 pods 提供和管理基础设施。</p></blockquote><p id="df4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这对你来说意味着什么？你现在可以在 EKS 上拥有一个<em class="me">无服务器</em> Kubernetes 集群，它只对正在运行的 pods 收费，而不对它们的底层 EC2 实例收费。除其他优势外，它还意味着:</p><ul class=""><li id="2b17" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">不再需要维护工作节点，</li><li id="ee9b" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">不再有猜测的能力，</li><li id="8f4c" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">不再有 EC2 自动缩放组来缩放工作节点。</li></ul><p id="5dfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你所需要做的就是为你的<em class="me">部署</em>编写<em class="me"> YAML </em>文件，并通过<strong class="lb iu"> kubectl </strong>与 EKS 交互。简而言之:<strong class="lb iu">你现在唯一的任务</strong>就是<strong class="lb iu">编写你的 ETL &amp; ML 代码</strong>来为你的业务增值，AWS 负责运营，即操作、维护和扩展你的 Kubernetes 集群。</p><p id="0ade" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑到我们只为实际的 vCPU 和运行 pod 的内存收费，这为现代数据平台提供了<strong class="lb iu">巨大的基础。</strong></p><h1 id="694c" class="mz na it bd nb nc nd ne nf ng nh ni nj jz nk ka nl kc nm kd nn kf no kg np nq bi translated">这听起来好得令人难以置信:有哪些不利之处？</h1><p id="9548" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">使用几乎任何无服务器选项的一个可能的缺点是当容器编排系统需要首先<strong class="lb iu">分配和准备计算资源</strong> ( <em class="me"> a.o .将最新版本的映像从 docker 注册表拉至分配的工作节点并构建映像</em>)时的<strong class="lb iu">冷启动</strong>问题，这可能会在容器(<em class="me">或您的 K8s pod </em>)进入运行状态之前增加一些额外的延迟。</p><p id="a2dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的数据工作负载要求非常低的延迟水平，您可以选择具有传统数据平面的 AWS EKS 集群，并按照这篇博客文章中的说明在 AWS EKS 上设置一个非无服务器集群，并将其连接到您的完美云环境。</p><p id="7ceb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，<strong class="lb iu">你<em class="me">能</em>兼得</strong>！AWS 允许您混合这两者:</p><ul class=""><li id="7e75" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">您可以在<strong class="lb iu">默认</strong>名称空间中以无服务器方式运行相同的 AWS EKS 集群(<em class="me">这是通过生成 Fargate 概要文件</em>来设置的)</li><li id="4150" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">您可以拥有一个 EC2 实例(<em class="me"> ex。，使用 GPU </em>为您的数据科学模型连接到 EKS 上的同一个 Kubernetes 集群，但在<strong class="lb iu">不同的名称空间</strong>内或使用不同的 Kubernetes 标签。当您为与 Fargate 概要文件中定义的名称空间和标签不匹配的 pod 创建部署时，它将被调度到您维护的 EC2-worker 节点，并且该节点是无延迟可用的。</li></ul><p id="368f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，AWS 很有远见地设计了 Fargate 上的<strong class="lb iu"> EKS，允许你<strong class="lb iu">混合无服务器和非无服务器选项</strong>以节省你的时间、金钱和维护工作。你可以在 AWS 介绍这项服务的视频中找到更多信息。</strong></p><h1 id="d603" class="mz na it bd nb nc nd ne nf ng nh ni nj jz nk ka nl kc nm kd nn kf no kg np nq bi translated">AWS 设置</h1><p id="c30d" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">您需要拥有一个具有管理员访问权限的 AWS 帐户，或者至少拥有 IAM 权限的用户，以便创建 ECR、EKS 和 ECS 资源。然后，您必须为该帐户配置<a class="ae ky" href="https://www.notion.so/Distributed-data-pipelines-made-easy-with-AWS-and-Prefect-82c31104b9bd4009af527f3392fbb2fb" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>并安装<strong class="lb iu"> eksctl </strong>，如本<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html" rel="noopener ugc nofollow" target="_blank"> AWS 文档</a>中所述。</p><p id="ba21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS 上的 Kubernetes 与 AWS ECR 配合得很好，后者是 Docker 图像的注册表。要使用您的 ECR 帐户对您的终端<strong class="lb iu">进行<strong class="lb iu">身份验证，请运行:</strong></strong></p><ul class=""><li id="7c11" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">如果您使用新的 AWS CLI v2:</li></ul><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="cebe" class="ob na it nx b gy oc od l oe of">aws ecr get-login-password --region &lt;YOUR_AWS_REGION&gt; | docker login --username AWS --password-stdin &lt;YOUR_ECR_REGISTRY_ID&gt;.dkr.ecr.&lt;YOUR_AWS_REGION&gt;.amazonaws.com</span></pre><ul class=""><li id="6e01" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">如果您使用旧版本的 AWS CLI:</li></ul><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="aefd" class="ob na it nx b gy oc od l oe of">$(aws ecr get-login --no-include-email --region &lt;YOUR_AWS_REGION&gt;)</span></pre><blockquote class="mt mu mv"><p id="fab8" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><strong class="lb iu">注:</strong> <code class="fe og oh oi nx b">&lt;YOUR_AWS_REGION&gt;</code>可能是 ex。<em class="it">美东-1 </em>，<em class="it">欧盟-中部-1，</em>和<a class="ae ky" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html" rel="noopener ugc nofollow" target="_blank">更多</a>。</p></blockquote><p id="3879" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您得到<strong class="lb iu">登录成功</strong>消息，您可以为您的数据管道创建您的 ECR 存储库。我们将创建两条数据管道:<code class="fe og oh oi nx b">dask-k8</code>和<code class="fe og oh oi nx b">basic-etl-prefect-flow</code>——使用相同的名称来遵循本演练，但是一般来说，最简单的方法是将您的<strong class="lb iu"> ECR 存储库</strong>与您的<strong class="lb iu">完美流</strong>命名为<em class="me">以避免混淆。</em></p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="9f20" class="ob na it nx b gy oc od l oe of">aws ecr create-repository --repository-name dask-k8</span><span id="8d86" class="ob na it nx b gy oj od l oe of">aws ecr create-repository --repository-name basic-etl-prefect-flow</span></pre><p id="1621" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您需要做的就是运行以下命令，这将在您的 VPC 中部署 Kubernetes 控制平面和 Fargate 配置文件:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="1594" class="ob na it nx b gy oc od l oe of">eksctl create cluster --name fargate-eks --region &lt;YOUR_AWS_REGION&gt; --fargate</span></pre><p id="b2ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我为集群选择了名称<em class="me"> fargate-eks </em>，但是可以随意更改。<br/><code class="fe og oh oi nx b">--fargate</code>标志确保我们创建一个新的 Fargate 配置文件用于该集群。如果需要，EKS 允许您创建自定义的 Fargate 配置文件。</p><p id="0ff5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提供所有资源可能需要几分钟时间。完成后，您应该会看到类似如下的输出:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="44e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，如果你检查你的上下文:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="22e7" class="ob na it nx b gy oc od l oe of">kubectl config current-context</span></pre><p id="81f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会得到与下面类似的输出:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="d484" class="ob na it nx b gy oc od l oe of">&lt;YOUR_AWS_USER_NAME&gt;@fargate-eks.&lt;YOUR_AWS_REGION&gt;.eksctl.io</span></pre><p id="ba65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，您可以看到您连接到了一个运行在 AWS Fargate 上的无服务器 Kubernetes 集群！为了进一步证明这一点，运行:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="e6d8" class="ob na it nx b gy oc od l oe of">➜  ~ kubectl get nodes<br/>NAME                                                       STATUS   ROLES    AGE   VERSION<br/>fargate-ip-192-168-163-163.eu-central-1.compute.internal   Ready    &lt;none&gt;   15m   v1.17.9-eks-a84824<br/>fargate-ip-192-168-180-51.eu-central-1.compute.internal    Ready    &lt;none&gt;   15m   v1.17.9-eks-a84824</span></pre><p id="cde8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在输出中，您应该看到至少有一个 Fargate 节点等待您的 pod 部署。</p><blockquote class="mt mu mv"><p id="4aa7" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>这些节点在您的 VPC  <strong class="lb iu">内运行<strong class="lb iu">，但是</strong>它们在您的<strong class="lb iu"> EC2 </strong>仪表板内<strong class="lb iu">不可见</strong>。您也不能通过 SSH 访问这些节点，因为它们完全由 Fargate 以无服务器的方式管理和部署。</strong></p></blockquote><p id="c966" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这个 AWS EKS 集群与提督相结合的好处是，整个<strong class="lb iu"> Kubernetes pod 部署和调度由提督</strong>从您这里抽象出来 <strong class="lb iu">。这意味着你甚至不需要太了解 Kubernetes 就能从中获取价值。在下一节中，我们将把这个集群连接到我们的 Prefect Cloud 帐户，并开始构建分布式 ETL &amp; ML 数据管道。</strong></p><h1 id="45f2" class="mz na it bd nb nc nd ne nf ng nh ni nj jz nk ka nl kc nm kd nn kf no kg np nq bi translated">完美设置</h1><p id="449b" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">让我们先在 https://cloud.prefect.io/注册一个免费的开发者账户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/5a224f6ebfe3fd3505d465cf2c782ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OXO6DeaTDJirw_8ewAAFVQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云:注册页面——作者图片</p></figure><p id="b2e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，你将受到一个干净的用户界面的欢迎，显示你的<strong class="lb iu">流程、代理、</strong>和<strong class="lb iu">最近流程运行的概述</strong>和<strong class="lb iu">下一个计划的任务</strong>。流程本身可以被组织成几个项目。当您开始构建数据管道时，这个<strong class="lb iu">主仪表板</strong>可以让您快速识别所有数据管道的<strong class="lb iu">当前状态。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/d52b4e28ce96851ecffac91f590a7fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7khf4GbAW8sg03Jv3cFp3g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Prefect Cloud UI 的主仪表板—作者图片</p></figure><p id="c827" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到，我现在有一个<strong class="lb iu"> Fargate 代理</strong>准备在<strong class="lb iu"> AWS ECS </strong>上部署流。现在，我们将只关注<strong class="lb iu">AWS</strong>T13】EKS。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/9cbdd9ad1af5070c411716450301aef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QgTRytsBPHe8K_gYGmUuKg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美的云用户界面显示了一个健康的 Fargate 代理——图片由作者提供</p></figure><h2 id="cf50" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">安装提督</h2><p id="36c2" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">让我们继续设置并在您的机器上安装 prefect。以下命令将安装带有 AWS 和 Kubernetes extras 的提督(<em class="me">而不是</em> <code class="fe og oh oi nx b">[kubernetes,aws]</code> <em class="me">如果您想安装外部系统</em>的所有提督扩展，您可以使用 <code class="fe og oh oi nx b">[all_extras]</code> <em class="me">):</em></p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="de10" class="ob na it nx b gy oc od l oe of">pip install "prefect[kubernetes,aws]"</span></pre><p id="122b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，为了确保您使用的是 Prefect Cloud，而不是开源版本的 Prefect Core，请将上下文切换到 Cloud:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="815e" class="ob na it nx b gy oc od l oe of">prefect backend cloud</span></pre><h2 id="bd35" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">创建个人访问令牌，将您的流注册到 Prefect Cloud</h2><p id="8bc0" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">注册免费账户后，你需要创建一个<strong class="lb iu">个人访问令牌</strong>来认证你的本地终端。这将允许直接从您的计算机向 Prefect Cloud 注册您的流(<em class="me">即您的 ETL &amp; ML 数据管道</em>)。进入侧边栏:用户→个人访问令牌→ <code class="fe og oh oi nx b">+ CREATE TOKEN</code>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/96f3fd2894c320a23fd155420d114025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*86zv_VJR34ZvCs-1-zXXZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美的云 UI:创建令牌来注册流——图片由作者提供</p></figure><p id="dab1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">选择一些有意义的名字。<code class="fe og oh oi nx b">MyTokenToRegisterFlows</code>。</p><p id="95ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后复制令牌，并在您的终端中运行以下命令:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="7d7a" class="ob na it nx b gy oc od l oe of">prefect auth login -t &lt;MyTokenToRegisterFlows&gt;</span></pre><p id="e10a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以注册您的流程，以便从 Prefect Cloud 进行编排！</p><h2 id="1c9d" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">创建 API 令牌来授权您的 AWS EKS 代理运行您的流</h2><p id="63b9" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">最后一部分是<strong class="lb iu">为您的 Kubernetes 代理创建一个 RunnerToken </strong>并注册代理。进入侧边栏:团队→ API 令牌→ <code class="fe og oh oi nx b">+ CREATE TOKEN</code>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/b21f8d3a9b6f7fa89a57cfb802cbd048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RmOtbNAEzffLqiZt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:创建 API 令牌来注册你的 AWS EKS 代理——图片由作者提供</p></figure><p id="37d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以从您的终端进行同样的操作:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="d953" class="ob na it nx b gy oc od l oe of">prefect auth create-token -n MyEKS_on_Fargate_K8s_Token -r RUNNER</span></pre><p id="cb82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">选择<code class="fe og oh oi nx b">RUNNER</code>范围非常重要，否则您的代理将无法代表您执行流程。</p><p id="01df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击<code class="fe og oh oi nx b">CREATE</code>并复制生成的 API 令牌。</p><h2 id="2a7b" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">使用生成的 API 令牌将 EKS 集群设置为您的完美代理</h2><p id="ab20" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">现在我们到了最激动人心的部分:使用下面的命令，您将能够<strong class="lb iu">将您的无服务器 AWS Kubernetes 集群设置为您的完美数据管道的执行层</strong> ( <em class="me">即代理</em>):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="a6d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您应该能够在您的 Prefect Cloud 帐户中看到一个新的 Kubernetes 代理:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/8748cfe5d79508f556a5d76142bd19af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HwMquSfnL93UPtxkGjzIwg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:AWS EKS 集群现已注册并准备好运行流——图片由作者提供</p></figure><p id="603b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以看到一个对应于提督代理的新 pod:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="900b" class="ob na it nx b gy oc od l oe of">➜  ~ kubectl get pods<br/>NAME                             READY   STATUS    RESTARTS   AGE<br/>prefect-agent-68785f47d4-pv9kt   1/1     Running   0          5m59s</span></pre><h2 id="6fbc" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">基本完美流程结构</h2><p id="2054" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">现在一切都设置好了，我们可以开始创建我们的流了。Prefect 文档包括各种有用的教程，将快速向您展示如何修改您的 Python ETL &amp; ML 代码，使其在 Prefect 上运行。简而言之，你只需要用 <code class="fe og oh oi nx b"><strong class="lb iu">@task</strong></code>装饰器<strong class="lb iu">装饰你的 Python 函数，添加任务和流<strong class="lb iu">导入</strong>并创建一个<strong class="lb iu">流</strong>对象:</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><blockquote class="mt mu mv"><p id="2c67" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>添加<code class="fe og oh oi nx b">log_stdout=True</code>确保打印输出会出现在提督云流日志中。</p></blockquote><h2 id="461c" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">创建项目来组织您的流程</h2><p id="b8b9" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">现在，我们可以<strong class="lb iu">创建一个项目</strong>来组织我们的流，无论是从 UI 还是通过使用终端:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="9cbf" class="ob na it nx b gy oc od l oe of">➜ prefect create project Medium_AWS_Prefect<br/>Medium_AWS_Prefect created</span></pre><h2 id="a664" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">将您的流量注册到完美云</h2><p id="1326" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">如果我们现在运行这个脚本，我们应该会得到一个到 Prefect Cloud UI 的链接，从这里我们可以触发或安排流程:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="1672" class="ob na it nx b gy oc od l oe of">➜ python3 basic-prefect-etl-flow.py <br/>Result check: OK<br/>Flow: <a class="ae ky" href="https://cloud.prefect.io/anna/flow/888046e6-f366-466a-b9b5-4113cd437e4d" rel="noopener ugc nofollow" target="_blank">https://cloud.prefect.io/anna/flow/888046e6-f366-466a-b9b5-4113cd437e4d</a></span></pre><h2 id="d9b9" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">从 UI 运行您的流程</h2><p id="565d" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">当我们触发该流时，我们将看到它停留在<em class="me">预定</em>状态，并且不运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/254b762c6bc3454164483be6cf10674b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_VXZyMF1FZJNGA8mQ6XbAA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:从用户界面触发流运行—作者图片</p></figure><p id="1873" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为要在 AWS EKS 集群上运行您的流，<strong class="lb iu">您的流必须包含关于代码存储位置的信息</strong>。</p><h2 id="641c" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">添加存储信息&amp;将流程推送到 ECR</h2><p id="5df7" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">关于如何存储你的代码，有几个选择:EKS 可以从 ECR、S3 或 Github 下载。</p><p id="3e2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最简单的选择是将您的流程分类，并将图像推送到 ECR。幸运的是，提督团队让事情变得非常简单——我们只需要:</p><ul class=""><li id="264f" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">为我们的流程创建一个 ECR 存储库(<em class="me">这个步骤可以在您的生产环境中使用 CI/CD 管道自动完成</em>)</li><li id="623a" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">在代码中添加 Docker 存储。</li></ul><p id="d1fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您还记得 AWS 设置部分，我们已经创建了两个 ECR 存储库:<code class="fe og oh oi nx b">dask-k8</code>和<code class="fe og oh oi nx b">basic-etl-prefect-flow</code>。因此，我们只需要将<code class="fe og oh oi nx b">storage=Docker()</code>参数添加到我们的流代码中，这样它就可以由我们的无服务器 Kubernetes 代理执行:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="dd90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面代码的一些<strong class="lb iu">重要注释</strong>:</p><ul class=""><li id="a5aa" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">在引擎盖下，Prefect 检查您的 Prefect 版本并扩展相应的<a class="ae ky" href="https://hub.docker.com/r/prefecthq/prefect" rel="noopener ugc nofollow" target="_blank"> Prefect Docker 映像</a>以包含您的流及其依赖项，</li><li id="2210" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">确保设置您的<strong class="lb iu"> ECR 注册 ID </strong>，这样您的流将被归档并被推送到我们之前创建的 ECR 存储库<code class="fe og oh oi nx b">dask-k8</code></li><li id="8479" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><code class="fe og oh oi nx b">image_tag='latest'</code>用于禁用 ECR 图像的版本控制。将其设置为<em class="me">最新</em>或任何其他特定标记将确保每次注册流程时，您都覆盖标记为<em class="me">最新</em>的先前 ECR 图像。这对我很有用，因为我已经使用 Git 对我的代码进行版本控制，并且我不需要 ECR 版本控制。此外，它可以在 AWS 上为您节省一些资金，因为 ECR 上的每个新版本的图像，您都需要为这些 ECR 图像的存储支付更多的费用。但是可以跳过这个争论。这样，提督将使用当前日期和时间标记图像，并使用不同的标记存储每个流版本。</li></ul><blockquote class="mt mu mv"><p id="ab53" class="kz la me lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated"><strong class="lb iu">最后注意:</strong>额外的参数<code class="fe og oh oi nx b"><em class="it">python_dependencies=["pandas==1.1.0"]</em></code>允许定义需要安装在容器中的 Python 包的列表。如果您需要对您的图像进行更细粒度的控制，您可以提供一个自定义 over 文件的路径，例如:<code class="fe og oh oi nx b"><em class="it">dockerfile='/Users/anna/my_flows/aws/Dockerfile'</em></code></p></blockquote><h2 id="b531" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">部署新的流版本</h2><p id="15af" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">我们现在可以<strong class="lb iu">将之前的流程运行标记为完成</strong>或失败:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/372c27650975eaadaa25095277eb641d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Z2QyeC7jU9jmy4avxupCw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:将流程运行标记为已完成或失败——作者图片</p></figure><p id="1954" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以通过简单地重新运行修改后的脚本来注册流的新版本，如第二个要点所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="2c88" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">在 UI 中检查流程进度</h2><p id="3c11" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">如果我们访问输出中的链接，我们可以看到版本 2 已经创建，如果我们运行它，我们可以看到流程将转移到状态<em class="me">提交执行</em>(黄色)，然后<em class="me">运行</em>(蓝色)，最后<em class="me">所有引用任务成功</em>(绿色):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/5c04802c26ef0b07fb990f3487d40e7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBQSu6AOxXAyIdzd8TjIfA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:示意性任务视图—作者图片</p></figure><h2 id="2550" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">从日志和 CLI 查看进度</h2><p id="d182" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">日志显示更多信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/74c50c7981ae08deb996afe16d5363f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d9AugweYJsS3QyN29Cd0Kg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:流量日志—作者图片</p></figure><p id="0ece" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们也可以使用<strong class="lb iu"> kubectl </strong>检查吊舱:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="0686" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总结一下我们到目前为止所做的工作:</p><ul class=""><li id="e474" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">我们创建了一个完美的云帐户</li><li id="244a" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">我们使用 AWS EKS 部署了一个无服务器的 Kubernetes 集群</li><li id="3c13" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">我们创建了一个 ECR 存储库，并将包含我们的流代码和所有 Python 包依赖项的 Docker 映像推送到这个 ECR 存储库中</li><li id="a9cd" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">然后，我们注册我们的流，从 Prefect Cloud UI 运行它，并使用 kubectl 检查它在 UI 和 CLI 中的状态。</li></ul><p id="ac6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你走了这么远，恭喜你！👏🏻</p><p id="b34e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，我们将创建第二个流，它将利用分布式 Dask 集群。</p><h1 id="2e85" class="mz na it bd nb nc nd ne nf ng nh ni nj jz nk ka nl kc nm kd nn kf no kg np nq bi translated">按需分布式 dask 集群可并行处理您的数据管道</h1><p id="acc4" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">提督云与<a class="ae ky" href="https://distributed.dask.org/en/latest/" rel="noopener ugc nofollow" target="_blank"> Dask 分布式</a>很好的工作。为了以分布式方式在 Dask 上运行 Python 代码，通常需要部署一个带有几个工作节点的 Dask 集群，并对其进行维护。提督提供了一个很好的抽象概念<code class="fe og oh oi nx b">DaskKubernetesEnvironment</code>,它:</p><ul class=""><li id="432e" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated"><strong class="lb iu">加速</strong> <strong class="lb iu">按需 Dask 集群</strong>跨越多个 pod，也可能跨越多个节点(<em class="me">您可以指定最小和最大工人数量</em>)</li><li id="1d7a" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">将您的流提交到这个按需集群</li><li id="f8e1" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><strong class="lb iu">清理</strong>资源(<em class="me">即作业完成后终止集群</em>)。</li></ul><p id="6c79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个基于<a class="ae ky" href="https://docs.prefect.io/core/advanced_tutorials/dask-cluster.html" rel="noopener ugc nofollow" target="_blank">完美文档</a>的示例流程，您可以用它来测试您的 Dask 设置。我将这个流保存为<code class="fe og oh oi nx b">dask-k8.py</code>，并提供了与流名称和 ECR 存储库名称相同的名称<em class="me"> dask-k8 </em>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="b42d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在注册该流，并再次从 UI 中触发它:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="286b" class="ob na it nx b gy oc od l oe of">➜  python3 dask-k8.py</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/4725b7a408892b8f10f6180f50b4e253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tw8vCV7yhEPPrpxI4vNlWw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美云用户界面:快速运行流程的选项</p></figure><p id="9f5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以观察正在创建的在 Dask 工人之间分配工作的 pod:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="d180" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在可以看到几个与 Dask 相关的<strong class="lb iu">吊舱。UI 显示并行运行的所有任务的当前进度，以及最终运行时间:</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pi"><img src="../Images/a8a901918592448404b563a51747d5db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90b_UVmG8U-wnkVo3U-GCw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完美的云用户界面:在 AWS EKS 的按需 Dask 集群中成功执行数据管道——图片由作者提供</p></figure><p id="39b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们分析的日志，我们可以看到:</p><ul class=""><li id="e106" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">该流在 12:43 被提交执行</li><li id="33cf" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">流水作业开始于 12:47</li><li id="cc7d" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">流程在 12 点 51 分结束。</li></ul><p id="6b98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着，从 Kubernetes 代理获得流，到在我们的无服务器 AWS EKS 集群上配置 Dask 集群，以及提取所有必要的映像，大约需要 3 分钟。之后，该流程需要 4 分钟才能成功运行。</p><div class="kj kk kl km gt ab cb"><figure class="pj kn pk pl pm pn po paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/6191da565e45fccf00086c30ffd55c1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*ky9TtgR0FA03fHU5-7cD0Q.png"/></div></figure><figure class="pj kn pp pl pm pn po paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/7c635b21d8b83737668ae24d844e0314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*MVzWLExTv68b_RDTKrUOdA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk pq di pr ps translated">完美的云 UI:运行在 AWS EKS 分布式 Dask 集群上的数据流。左图:初始日志。右图:最终日志—作者图片</p></figure></div><p id="dafd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的工作负载无法接受与按需创建的 Dask 集群相关的延迟，您可以创建和维护自己的 Dask 集群，并按如下方式修改代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="722b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，您将使用 Executor 而不是环境抽象。此外，如果需要的话，您必须使 255.255.255.255 适应您的 Dask 调度程序地址，并相应地更改端口 8786。</p><h2 id="19db" class="ob na it bd nb op oq dn nf or os dp nj li ot ou nl lm ov ow nn lq ox oy np oz bi translated">清理资源</h2><p id="7ec6" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">在我们结束之前，确保删除 AWS EKS 集群和 ECR 存储库，以避免任何费用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure></div><div class="ab cl pt pu hx pv" role="separator"><span class="pw bw bk px py pz"/><span class="pw bw bk px py pz"/><span class="pw bw bk px py"/></div><div class="im in io ip iq"><h1 id="57d7" class="mz na it bd nb nc qa ne nf ng qb ni nj jz qc ka nl kc qd kd nn kf qe kg np nq bi translated">结论</h1><p id="5dca" class="pw-post-body-paragraph kz la it lb b lc nr ju le lf ns jx lh li nt lk ll lm nu lo lp lq nv ls lt lu im bi translated">在本文中，我们使用 Fargate 上的 AWS EKS 在 AWS 上创建了一个无服务器的 Kubernetes 集群。我们以安全的方式将它作为我们的执行层与完美云连接起来。然后，我们通过使用<code class="fe og oh oi nx b">DockerStorage</code>抽象，将我们的 Prefect 流分类，并将图像推送到 ECR。最后，我们部署了在单个 pod 中运行的简单数据管道，以及分布式 Dask 流，允许您的 ETL &amp; ML 代码的高级并行。</p><p id="0ab9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个过程中，我们确定了差异，以及在我们需要维护的现有资源上运行数据管道与以无服务器方式运行容器化流的优缺点。</p><p id="9b5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望这个设置能让您更容易开始编排 ETL 和数据科学工作流。无论您是初创企业、大型企业还是为论文编写代码的学生，Fargate 上的 Prefect &amp; AWS EKS 组合都可以让您轻松地将数据项目转移到生产中。</p><p id="c9ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">感谢您的阅读！</strong></p></div></div>    
</body>
</html>