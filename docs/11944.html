<html>
<head>
<title>Geocoding and Reverse Geocoding using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 进行地理编码和反向地理编码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geocoding-and-reverse-geocoding-using-python-36a6ad275535?source=collection_archive---------20-----------------------#2020-08-18">https://towardsdatascience.com/geocoding-and-reverse-geocoding-using-python-36a6ad275535?source=collection_archive---------20-----------------------#2020-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c829" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当地址已知时查找纬度和经度，或者使用 OpenCage 的 geocoder &amp; geopy 查找数据帧的纬度和经度。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b0890fb38ad9242ef1dd81ff0c0864af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uRM-iKEXz2zU3m_I"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@dead____artist?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">捕捉人心。</a>号上<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">的 Unsplash </a></p></figure><p id="dd35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">地理编码</strong>是获取输入文本(如地址或地名)并返回纬度/经度位置的过程。简单来说，地理编码就是把物理地址转换成经纬度。</p><p id="5426" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">python 中有许多地理编码 API 选项。一些流行的有 GeoPy，OpenCage geocoder，google geocoding。Geopy 是为数不多的为非商业用途提供无限制访问的 API 服务之一。对于 Google API 和 OpenCage 地理编码器，每天有 2500 个请求的限制。使用 geopy，我的数据集中一些地址的纬度和经度显示了不同的国家，而不是美国。使用<strong class="ky ir"> OpenCage </strong> <strong class="ky ir">地理编码器</strong>，令人惊讶的是所有的地址都是准确的，所以我使用 OpenCage 编码器。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="a61d" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">使用 OpenCage 地理编码器和 pandas</h2><p id="6a30" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">要在 python 中使用 OpenCage Geocoder，应该首先使用<code class="fe mx my mz na b">pip install opencage</code>安装 python 库。关于这个库的更多信息可以在这里找到:<a class="ae kv" href="https://github.com/opencagedata/python-opencage-geocoder" rel="noopener ugc nofollow" target="_blank">Github 上的 OpenCageGeocode</a></p><p id="2ab7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦安装了库，您将需要一个 OpenCage 地理编码器帐户来生成 API 密钥。可以使用<a class="ae kv" href="https://opencagedata.com/" rel="noopener ugc nofollow" target="_blank">opencagedata.com</a>创建一个免费账户。注册帐户后，您可以在 Dashboard 中找到 API 密钥，如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/f8775abd661f8e9061b89ae31c2850df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WdwCEaARX1FBoo2bkGzELw.jpeg"/></div></div></figure><h2 id="2264" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">例子</h2><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="fd68" class="lz ma iq na b gy ng nh l ni nj">from opencage.geocoder import OpenCageGeocode<br/>key = "Enter_your_Api_Key"<br/>geocoder = OpenCageGeocode(key)<br/>address='1108 ROSS CLARK CIRCLE,DOTHAN,HOUSTON,AL'<br/>result = geocoder.geocode(address, no_annotations="1")  <br/>result[0]['geometry']</span></pre><p id="8043" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:{ '纬度':31.2158271，'液化天然气':-85.3634326}</p><p id="285a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们得到了一家名为东南阿拉巴马医疗中心的医院的经度和纬度。在大多数情况下，我们会有多个地址需要像现在这样绘制在地图上。在这种情况下，使用 pandas 创建数据框将容易得多。我使用的数据集包含美国所有医院的列表，以及医院所在县的新冠肺炎病例总数。数据集可以从<a class="ae kv" href="https://www.kaggle.com/jaswanthhbadvelu/us-hospital-location-with-covid-cases-for-counties" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="47ff" class="lz ma iq na b gy ng nh l ni nj">import pandas as pd<br/>data=pd.read_csv(‘Final.csv’)<br/>data.head(10)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/c618c133632385f6f64814f4bfdc742b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EA-QMFABRNnG7OYGpiATbA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">医院位置数据框架</p></figure><p id="c183" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有一个数据框，其中包含美国所有医院的设施名称及其地址的列表，因此我们只需要找到位置坐标。</p><p id="832d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们应该将地址列转换为列表。因此，循环所有地址会更容易。</p><p id="acc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，从 OpenCage geocoder 网站输入您的 API 密钥，并创建空列表来存储纬度和经度。创建空列表后，创建一个循环，给出所有地址的经度和纬度</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="c950" class="lz ma iq na b gy ng nh l ni nj">addresses = data["Full_Address"].values.tolist()<br/>key = "Enter-your-key-here"<br/>geocoder = OpenCageGeocode(key)<br/>latitudes = []<br/>longitudes = []<br/>for address in addresses: <br/>    result = geocoder.geocode(address, no_annotations="1")  <br/>    <br/>    if result and len(result):  <br/>        longitude = result[0]["geometry"]["lng"]  <br/>        latitude = result[0]["geometry"]["lat"] <br/>    else:  <br/>        longitude = "N/A"  <br/>        latitude = "N/A"  <br/>    <br/>    latitudes.append(latitude) <br/>    longitudes.append(longitude)</span></pre><p id="19f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有数据框中所有地址列表的纬度和经度。我们可以使用这个简单的 pandas 命令将纬度和经度添加到现有的数据框中。</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="7b45" class="lz ma iq na b gy ng nh l ni nj">data["latitudes"] = latitudes<br/>data["longitudes"] = longitudes<br/>data.head(10)</span></pre><p id="a282" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们得到了所有医院地址的经度和纬度。为了更好地理解这个位置坐标，让我们使用 follow maps 将所有位置坐标绘制成地图中的点。</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="c9b8" class="lz ma iq na b gy ng nh l ni nj">folium_map= folium.Map(location=[33.798259,-84.327062],zoom_start=4.4,tiles=’CartoDB dark_matter’)</span><span id="733a" class="lz ma iq na b gy nl nh l ni nj">FastMarkerCluster(data[[‘latitudes’, ‘longitudes’]].values.tolist()).add_to(folium_map)</span><span id="bfc4" class="lz ma iq na b gy nl nh l ni nj">folium.LayerControl().add_to(folium_map) for row in final.iterrows():<br/>    row=row[1]<br/>    folium.CircleMarker(location=(row["latitudes"],<br/>                                  row["longitudes"]),<br/>                        radius= 10,<br/>                        color="#007849",<br/>                        popup=row[‘Facility_Name’],<br/>                        fill=False).add_to(folium_map)<br/>    <br/>folium_map</span></pre><p id="d900" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以看到美国所有医院的位置点。我使用 CircleMarker 聚类来更好地了解医院数量最多的地区。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/6c780a67e37e3571f64841afebd8c0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pVGXM4pQdUdBySShrHYe4w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用 follow 创建的地图可视化快照(聚类位置)</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="307c" class="nn ma iq bd mb no np nq me nr ns nt mh jw nu jx mk jz nv ka mn kc nw kd mq nx bi translated">反向地理编码</h1><p id="d0f0" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Reverse_geocoding" rel="noopener ugc nofollow" target="_blank">反向地理编码</a>，另一方面，将地理坐标转换为位置的描述，通常是一个地点或可寻址位置的名称。地理编码依赖于地址点、街道/道路网络以及邮政和行政边界的计算机表示。</p><p id="4c9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于反向地理编码，我发现 Geopy API 的输出格式比 OpenCage Geocoder 更详细。此外，Geopy API 没有限制，因此我们将使用 Geopy 而不是 OpenCage Geocoder。</p><p id="1691" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> OpenCage 反向地理编码器示例</strong></p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="506a" class="lz ma iq na b gy ng nh l ni nj">result = geocoder.reverse_geocode(31.2158271,-85.3634326)  <br/>result[0][‘formatted’] </span></pre><p id="3218" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:美利坚合众国 AL 36302 Dothan Alma 街东南健康医疗中心</p><p id="550f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> Geopy 反向地理编码器示例</strong></p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="ddbf" class="lz ma iq na b gy ng nh l ni nj">from geopy.geocoders import Nominatim<br/>geolocator = Nominatim(user_agent="test_app")<br/>location = geolocator.reverse("31.2158271,-85.3634326")<br/>location.raw[‘display_name’]</span></pre><p id="6f33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:“美国阿拉巴马州休斯顿县多森莫里斯高地罗斯克拉克圈 1108 号东南健康校园，邮编 36301。”</p><h1 id="785d" class="nn ma iq bd mb no ny nq me nr nz nt mh jw oa jx mk jz ob ka mn kc oc kd mq nx bi translated"><strong class="ak">使用 Geopy 地理编码器和熊猫</strong></h1><p id="f7e1" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">对于反向地理编码，如上所述，首先，我们将纬度和经度转换为列表并压缩在一起。</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="9f5c" class="lz ma iq na b gy ng nh l ni nj">lats=data['latitudes'].to_list()<br/>lons=data['longitudes'].to_list()<br/># Creating a zip with latitudes and longitudes<br/>coords=list(zip(lats,lons))</span></pre><p id="7bb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为，我们已经创建了列表，就像上面一样，我们将创建一个循环来查找每个位置坐标的地址，并将它们附加在一起。</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="cbc6" class="lz ma iq na b gy ng nh l ni nj">from geopy.geocoders import Nominatim<br/>geolocator = Nominatim(user_agent="test_app") <br/>full_address=[]<br/>for i in range(len(coords)):<br/>    location = geolocator.reverse(coords[i])<br/>    address=location.raw['address']['country']<br/>    full_address.append(address)<br/>#Creating dataframe with all the addresses<br/>addres=pd.DataFrame(data=full_address , columns=['Address'])<br/>addres</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/9e7a9c97d7cbba42b5746bdde6d4e718.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*CQtGYM0p2fOGIhMtBgT8cg.jpeg"/></div></figure><p id="da2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们有美国所有医院的地址列表。</p><p id="7903" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于感兴趣的读者，我把代码放在我的 GitHub Repo <a class="ae kv" href="https://github.com/JaswanthBadvelu/Geocoding/blob/master/Geocode%20%26%20Reverse.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>。如果您有任何疑问，请使用<a class="ae kv" href="https://www.linkedin.com/in/jaswanth-badvelu/" rel="noopener ugc nofollow" target="_blank"> linkedin </a>联系我。</p></div></div>    
</body>
</html>