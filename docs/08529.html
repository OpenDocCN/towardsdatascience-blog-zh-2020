<html>
<head>
<title>Using FaceNet For On-Device Face Recognition With Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 FaceNet 在 Android 设备上进行人脸识别</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-facenet-for-on-device-face-recognition-with-android-f84e36e19761?source=collection_archive---------7-----------------------#2020-06-21">https://towardsdatascience.com/using-facenet-for-on-device-face-recognition-with-android-f84e36e19761?source=collection_archive---------7-----------------------#2020-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="0f84" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">📱<a class="ae ep" href="https://equipintelligence.medium.com/list/stories-on-mobile-ml-with-kotlin-and-tf-lite-3ebee822c87b" rel="noopener">移动机器学习</a></h2><div class=""/><div class=""><h2 id="73b1" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">利用 Android 的 FaceNet 和 Firebase MLKit 的强大功能。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a3414ef4296444761d7b52c3754430ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7yMoqOoBwrnzngd-"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@harrycunnningham1?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">哈里·坎宁安</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="eac6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">随着对许多人进行即时识别和分类的需求增加，对人脸识别系统的需求与日俱增。无论是办公室的考勤系统，还是手机摄像头中的简单人脸检测器，人脸检测系统无处不在。对于边缘设备，这种需求甚至更大，因为它们有许多用途，如监控人群、机场乘客、公交车站等。</p><p id="e4c5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">今天，我们将创建一个类似的人脸识别应用程序，完全从零开始。但是等等，有些特别的东西！</p><blockquote class="mb mc md"><p id="2c07" class="lf lg me lh b li lj ka lk ll lm kd ln mf lp lq lr mg lt lu lv mh lx ly lz ma ij bi translated">想象一下，你正在办公室里使用人脸检测系统。对于你办公室的 10 名员工来说，这个系统运行得非常好。但是，现在你的一个朋友来到了你的办公室。该系统可能无法识别您的朋友，因为它没有被编程这样做。所以，对于每一个新员工，你都需要修改系统并重新编程。</p></blockquote><p id="7aa5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果，</p><blockquote class="mb mc md"><p id="c372" class="lf lg me lh b li lj ka lk ll lm kd ln mf lp lq lr mg lt lu lv mh lx ly lz ma ij bi translated">你不需要重新训练系统！为什么你不能保存这 10 名员工和你朋友的照片，而应用程序也能立即识别你的朋友呢？无需重新编写应用程序或任何其他系统，一切都可以在 Android 上运行！当你有新员工时，继续在单独的文件夹中添加他们的图像，应用程序就可以识别他们了。</p></blockquote><p id="2578" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">直到故事结束，我们将创建这样一个应用程序！</p><p id="fa89" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">GitHub 项目-&gt;</p><div class="mi mj gp gr mk ml"><a href="https://github.com/shubham0204/FaceRecognition_With_FaceNet_Android" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd ja gy z fp mq fr fs mr fu fw iz bi translated">Shu bham 0204/face recognition _ With _ FaceNet _ Android</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">存储你想认识的人的图像，应用程序将使用这些图像对这些人进行分类。我们…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">github.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz ky ml"/></div></div></a></div><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者的项目/博客。</p></figure><h1 id="8e83" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">先决条件</h1><p id="7d5e" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">在我们的应用程序中，我们将使用 CameraX、Firebase MLKit 和 TensorFlow Lite。如果你以前没有使用过这些库，一定要看看它们。</p><ul class=""><li id="7390" class="nz oa iq lh b li lj ll lm lo ob ls oc lw od ma oe of og oh bi translated">CameraX:官方代码实验室</li><li id="dd92" class="nz oa iq lh b li oi ll oj lo ok ls ol lw om ma oe of og oh bi translated"><a class="ae le" href="https://firebase.google.com/docs/ml-kit/android/detect-faces" rel="noopener ugc nofollow" target="_blank"> Firebase MLKit:在 Android 上用 MLKit 检测人脸</a></li><li id="8224" class="nz oa iq lh b li oi ll oj lo ok ls ol lw om ma oe of og oh bi translated"><a class="ae le" href="https://blog.tensorflow.org/2018/03/using-tensorflow-lite-on-android.html" rel="noopener ugc nofollow" target="_blank">Android 上的 tensor flow Lite</a></li></ul><h2 id="647e" class="on nd iq bd ne oo op dn ni oq or dp nm lo os ot no ls ou ov nq lw ow ox ns iw bi translated">FaceNet 上的一点</h2><ul class=""><li id="3295" class="nz oa iq lh b li nu ll nv lo oy ls oz lw pa ma oe of og oh bi translated"><a class="ae le" href="https://arxiv.org/abs/1503.03832" rel="noopener ugc nofollow" target="_blank"> FaceNet:人脸识别和聚类的统一嵌入</a></li><li id="025c" class="nz oa iq lh b li oi ll oj lo ok ls ol lw om ma oe of og oh bi translated"><a class="ae le" href="https://www.geeksforgeeks.org/facenet-using-facial-recognition-system/" rel="noopener ugc nofollow" target="_blank"> FaceNet —使用面部识别系统</a></li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="4557" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">1.将 Keras 模型转换为 TFLite 模型</h1><p id="5e00" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">FaceNet Keras 型号在<a class="ae le" href="https://github.com/nyoki-mtl/keras-facenet" rel="noopener ugc nofollow" target="_blank"><em class="me">n yoki-MTL/Keras-FaceNet</em></a>回购上有售。下载完<code class="fe pb pc pd pe b">.h5</code>模型后，我们将使用<code class="fe pb pc pd pe b">tf.lite.TFLiteConverter</code> API 将我们的 Keras 模型转换成 TFLite 模型。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">将 Keras 模型转换为 TFLite。</p></figure><h1 id="c4e3" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">2.使用 CameraX 设置预览和 ImageAnalyser</h1><p id="6765" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">为了实现一个实时的摄像机提要，我们使用 CameraX。我使用了<a class="ae le" href="https://codelabs.developers.google.com/codelabs/camerax-getting-started/#0" rel="noopener ugc nofollow" target="_blank">官方文件</a>中的代码。接下来，我们创建一个实现了<code class="fe pb pc pd pe b">ImageAnalysis</code>类的<code class="fe pb pc pd pe b">FrameAnalyser</code>类，它将帮助我们检索相机帧并对它们进行推理。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">正在设置 FrameAnalyser 类。</p></figure><p id="f94f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们所有的分类代码都将来自于<code class="fe pb pc pd pe b">analyze</code>方法。首先，使用 Firebase MLKit，我们将得到相机帧中所有面的边界框(一个<code class="fe pb pc pd pe b">Bitmap</code>对象)。我们将创建一个<code class="fe pb pc pd pe b">FirebaseVisionFaceDetector</code>，它在一个<code class="fe pb pc pd pe b">FirebaseVisionInputImage</code>对象上运行人脸检测模型。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">实现 FirebaseVisionFaceDetector。</p></figure><h1 id="1a21" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">3.使用 FaceNet 生成人脸嵌入并进行比较。</h1><p id="947f" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">首先，我们将使用我们的 FaceNet 模型生成人脸嵌入。在此之前，我们将创建一个助手类来处理 FaceNet 模型。这个助手类将，</p><ol class=""><li id="d8e0" class="nz oa iq lh b li lj ll lm lo ob ls oc lw od ma pf of og oh bi translated">使用我们从 Firebase MLKit 获得的边界框(如<code class="fe pb pc pd pe b">Rect</code>)裁剪给定的相机帧。</li><li id="4d4b" class="nz oa iq lh b li oi ll oj lo ok ls ol lw om ma pf of og oh bi translated">使用标准化的像素值将此裁剪图像从<code class="fe pb pc pd pe b">Bitmap</code>转换为<code class="fe pb pc pd pe b">ByteBuffer</code>。</li><li id="3555" class="nz oa iq lh b li oi ll oj lo ok ls ol lw om ma pf of og oh bi translated">最后，使用 TF Lite Android 库提供的<code class="fe pb pc pd pe b">Interpreter</code>类将<code class="fe pb pc pd pe b">ByteBuffer</code>提供给我们的 FaceNet 模型。</li></ol><p id="076f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在下面的代码片段中，可以看到封装了上述所有步骤的<code class="fe pb pc pd pe b">getFaceEmbedding()</code>方法。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">为 FaceNet 实现一个助手类</p></figure><p id="cce7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在，我们有了一个类，它将返回给定图像中所有人脸的 128 维嵌入。我们回到一个<code class="fe pb pc pd pe b">FrameAnalyser</code>的<code class="fe pb pc pd pe b">analyze()</code>方法。使用刚刚创建的 helper 类，我们将生成人脸嵌入，并将它们与我们已经拥有的一组嵌入进行比较。</p><p id="f556" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在此之前，我们需要获得一组预定义的嵌入，对吗？这些嵌入指的是我们需要认识的人。因此，该应用程序将读取用户设备内部存储中的<code class="fe pb pc pd pe b">images</code>文件夹。如果用户想要识别两个用户，即<em class="me"> Rahul </em>和<em class="me"> Neeta </em>，那么他/她需要在<code class="fe pb pc pd pe b">images</code>文件夹中创建两个单独的目录。然后，他/她必须将<em class="me"> Rahul </em>和<em class="me"> Neeta </em>的图像放在各自的子目录中。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pg"><img src="../Images/4ff9524c7b0141214f8c2824453fc667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pP8G7XLnrVuktgFo7XSHWA.png"/></div></div></figure><p id="7677" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们的目的是读取这些图像，并产生一个<code class="fe pb pc pd pe b">HashMap&lt;String,FloatArray&gt;</code>对象，其中键(<code class="fe pb pc pd pe b">String</code>)将主题的名字像<em class="me">拉胡尔</em>或<em class="me">尼塔</em>和值(<code class="fe pb pc pd pe b">FloatArray</code>)将相应的脸嵌入。通过查看下面的代码，您将对这个过程有所了解。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">读取和生成设备存储器中存在的图像的嵌入。</p></figure><p id="d1fe" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">下一步是将嵌入与合适的度量进行比较。我们可以使用 L2 范数或余弦相似性度量。使用<code class="fe pb pc pd pe b">metricToBeUsed</code>变量选择 L2 范数或余弦相似度。我们计算每张图片的分数。然后我们计算每个用户的平均分数。平均分最好的用户就是我们的产出。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ph"><img src="../Images/d75e769afb45cf3091be5d51d0c97703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERt2VNVOhd5tX-eqKPyYmA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">来自<a class="ae le" href="https://github.com/shubham0204/FaceRecognition_With_FaceNet_Android/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> README.md </a>的快照。</p></figure><p id="3a7d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后将<code class="fe pb pc pd pe b">predictions</code>数组提供给<code class="fe pb pc pd pe b">boundingBoxOverlay</code>类，该类绘制边界框并显示标签。在<code class="fe pb pc pd pe b">BoundingBoxOverlay.kt</code>班。这里，我们使用两个<code class="fe pb pc pd pe b">Matrix</code>来转换输出并显示在屏幕上。对于前置摄像头，我们必须翻转边界框的坐标，否则我们将在覆盖图中看到边界框的镜像。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">显示边界框和标签。</p></figure><h1 id="ea0a" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">结果呢</h1><p id="aaae" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">我试着用这个应用程序识别杰夫·贝索斯和埃隆·马斯克的脸，</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/bd766129d4054d6c8da34a33e07e8454.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*CDK7tNgAAMI-dgtnxsWfZg.gif"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">应用程序的运行。</p></figure><p id="e39f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">而且，我已经把图像存储在我的内部存储器中，</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pj"><img src="../Images/4e9157c72b665f319d2b3eee4bdfbabf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gHBcljB38YMgNHxDXKG2_w.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">文件结构</p></figure><h1 id="a80b" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">更多资源</h1><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="6693" class="nc nd iq bd ne nf ng nh ni nj nk nl nm kf nn kg no ki np kj nq kl nr km ns nt bi translated">结束了</h1><p id="5279" class="pw-post-body-paragraph lf lg iq lh b li nu ka lk ll nv kd ln lo nw lq lr ls nx lu lv lw ny ly lz ma ij bi translated">我希望你喜欢这个故事。感谢阅读！</p></div></div>    
</body>
</html>