<html>
<head>
<title>Everything You Didn’t Want to Have to Know About CSV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你不想知道的关于CSV的一切</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/everything-you-didnt-want-to-have-to-know-about-csv-665d0755e28?source=collection_archive---------33-----------------------#2020-01-06">https://towardsdatascience.com/everything-you-didnt-want-to-have-to-know-about-csv-665d0755e28?source=collection_archive---------33-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="27bf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">揭开CSV的神秘面纱，介绍使用CSV文件的工具和策略</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dff54578cc55509e8b6202908178919e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1oK1IKfpZvJvb2qhjVUs8w.png"/></div></div></figure><p id="7452" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">CSV是用于存储数据的更常见的文件格式之一，但是，它也充满了许多问题，这些问题会使使用它变得很痛苦。不像其他格式，如<a class="ae lq" href="http://www.json.org/" rel="noopener ugc nofollow" target="_blank"> JSON </a>，CSV不是形式化或标准化的。这意味着有些东西可能被称为CSV，但不一定能被您正在使用的CSV解析器正确读取。</p><p id="d2af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望这篇文章能让你更好地理解使用CSV文件的挑战，以及一些转换和分析CSV格式数据的方法。我假设你有一定程度的技术经验，但不一定是你写代码。</p><h1 id="8e81" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">什么是CSV？</h1><p id="adbe" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://en.wikipedia.org/wiki/Comma-separated_values" rel="noopener ugc nofollow" target="_blank">维基百科条目</a>的第一句话提供了一个简单的(但已经有问题的)CSV定义:</p><blockquote class="mo mp mq"><p id="7f1d" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">逗号分隔值(CSV)文件是使用逗号分隔值的分隔文本文件。CSV文件以纯文本格式存储表格数据(数字和文本)。文件的每一行都是一条数据记录。每个记录由一个或多个字段组成，用逗号分隔。</em></p></blockquote><p id="ed3b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据这个定义，CSV文件看起来应该是这样的(本例中的第一行代表列标题):</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="a81e" class="na ls it mw b gy nb nc l nd ne">id,name,title<br/>1,Alex Wennerberg,Cloud Data Engineer</span></pre><p id="93d5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这看起来相对简单，但是很快，问题就出现了。比如一个值里面有逗号怎么办？您可以将该值封装在双引号中，但是如果引号字符也包含在该值中呢？如果用于描述记录的字符(即换行符)出现在数据中会怎样？如果您的文件使用逗号以外的字符来描述值，该怎么办？诸如此类。这些问题的答案通常是特定的，并且依赖于系统，因此，根据您正在处理的CSV数据的来源，您需要应用一组不同的规则来正确解释该数据。如果幸运的话，您的源代码系统会提供完整的文档。如果不是，那么您必须猜测和/或逆向工程您的CSV文件遵循的任何规则集。</p><p id="e395" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">CSV从20世纪70年代就开始使用了，但是<a class="ae lq" href="https://en.wikipedia.org/wiki/Comma-separated_values#Specification" rel="noopener ugc nofollow" target="_blank">没有标准化</a>。最接近CSV标准的是2005年发布的<a class="ae lq" href="https://tools.ietf.org/html/rfc4180" rel="noopener ugc nofollow" target="_blank"> RFC 4180 </a>。虽然这可能是一个有用的参考，但不能保证您正在使用的系统称为“CSV”文件的文件遵循这个RFC。比如<a class="ae lq" href="https://answers.microsoft.com/en-us/msoffice/forum/all/why-excel-does-not-support-rfc-4180-standard-for/d0e379b1-ec3e-40d0-ad4f-33b20693c030" rel="noopener ugc nofollow" target="_blank">微软Excel </a>明确没有。RFC本身声明如下:</p><p id="8e5d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它没有规定任何类型的互联网标准。</p><p id="a13e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000323.shtml#notes" rel="noopener ugc nofollow" target="_blank">美国国会图书馆</a>提供了一个更加“真实”的CSV定义，并描述了许多常见的偏差:</p><blockquote class="mo mp mq"><p id="e074" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">在使用逗号字符代替数字中的小数点的语言环境中，字段/列之间的分隔符通常是分号。</em></p><p id="69df" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">换行符可以是CR或LF，不一定是CRLF。</em></p><p id="6fc6" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">一些基于Unix的应用程序可能使用不同的转义机制来指示某个分隔符出现在文本值中。单个字符前面有一个反斜杠字符，而不是用双引号将整个字符串括起来。单引号可能被视为等同于转义的双引号(也称为“文本限定”)。其他几个警告值得注意:</em></p><p id="4b58" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">文件中的最后一条记录可能以换行符结尾，也可能不以换行符结尾。</em></p><p id="d694" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">通过使用几种c样式字符转义序列中的一种，不可打印的字符可以包含在文本字段中:###或\ o # # # Octal\x##十六进制；\d###十进制；和\u#### Unicode。</em></p><p id="2234" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">对字段和记录分隔符附近空白的处理因应用程序而异。如果文本字段值开头和结尾的空格很重要，则文本字符串应该是文本限定的，即用引号括起来。</em></p><p id="5b91" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated"><em class="it">在某些应用中，存在强数据类型的假设，未加引号的字段被认为是数字，加引号的字段被认为是文本数据。</em></p></blockquote><p id="6489" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我在实践中见过大部分或所有这些偏差。在某些情况下，工具会通过在记录之间拼接一个逗号来导出“CSV”，这很容易被打断(例如<a class="ae lq" href="https://www.sqlservercentral.com/editorials/comedy-limited-with-sql-server" rel="noopener ugc nofollow" target="_blank"> SQL Server的“CSV”格式</a>)。</p><p id="baab" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您有兴趣进一步阅读，LOC页面有很多其他的细节，但是我不建议您假设任何CSV数据都符合RFC 4180，或者您正在与之交互的任何解析器都实现了RFC 4180。您可能想要查看您正在使用的特定CSV编写器或解析器的文档，如果它存在的话，以了解那个单独的系统如何处理CSV。一些系统将相对较好地处理CSV，而其他系统可能会以不可预测的方式失败。</p><h1 id="3537" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">CSV工具</h1><p id="83b5" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">如果您正在处理CSV格式的数据，您可能希望转换您的CSV数据并将其加载到对CSV格式有不同期望的不同系统中。您可能还想从CSV加载数据，并对其执行转换和分析。这里有一些我觉得在处理CSV文件时有用的工具。这些工具中的大多数都假设您有一些使用命令行和从二进制或软件包仓库安装软件的经验。</p><p id="3890" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://github.com/BurntSushi/xsv" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> xsv </strong> </a></p><p id="de89" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个命令行工具是我执行大多数与CSV相关的任务的首选工具——它可靠且速度极快，如果您正在处理大文件(&gt; 1GB ),它没有太大的竞争力。它可以做许多简单的操作，包括切片数据、排序数据、执行基本分析、重新格式化CSV数据、修复不匹配的行等。查看文档以获取更多信息。如果您正在对数据进行更复杂的分析或转换，xsv可能不合适，您可能想看看下面的一些其他工具。</p><p id="6b4e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://csvkit.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">T5【CSV kit】T6</a></p><p id="d13e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">另一个命令行工具，我在发现XSV之前使用CSVkit。它起着类似的作用，但速度远不及前者。CSVkit还有很多附加功能，例如在CSV和其他格式之间转换。如果你需要做一些XSV做不到的事情，或者如果你处理的文件比较小，性能不是很重要，那么这是一个很好的库。</p><p id="f112" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://www.sqlite.org/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"/></a><strong class="kw iu">(或其他关系数据库)</strong></p><p id="a669" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">大多数关系数据库都能够从CSV导入或导出。对于在大型数据集上进行复杂分析，这是一个非常好的策略，性能相对较好。如果您已经熟悉SQL，这也很容易。我推荐SQLite来做这样的分析，因为它不需要服务器，可以直接写到磁盘，甚至可以在内存中运行，但是您也可以使用您更熟悉的另一个关系数据库。</p><p id="3651" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一个相对较新的工具是<a class="ae lq" href="https://www.duckdb.org/" rel="noopener ugc nofollow" target="_blank"> DuckDB </a>，一个嵌入式列数据库，它也可以<a class="ae lq" href="https://www.duckdb.org/docs/current/sql/copy.html" rel="noopener ugc nofollow" target="_blank">读取CSV</a>。我还没有使用过这个，但如果您正在为分析工作流寻找一个更高性能的嵌入式数据库，这可能是一个很好的选择！</p><p id="f138" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">熊猫</strong> </a></p><p id="70e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您熟悉Pandas(Python数据操作和分析库),它可能是处理CSV数据的一种有用方式，但在大型(几GB)数据集上可能会遇到性能问题，具体取决于您的计算机规格。数据科学家经常结合使用Pandas和Jupyter进行数据分析，这两种工具都有一个广泛的社区。Pandas非常适合在从CSV加载数据后对其进行更复杂的转换和分析。你也可以将数据从Pandas导出为多种不同的格式。</p><p id="66db" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">big query</strong></a><strong class="kw iu">，</strong> <a class="ae lq" href="https://aws.amazon.com/redshift/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">红移</strong> </a> <strong class="kw iu">，或者其他托管的柱状数据库</strong></p><p id="ed9b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您正在处理非常大量的数据(数十或数百GB)，您的计算机可能无法通过SQLite或Pandas处理本地运行的分析。您可能想要将您的CSV文件移动到<a class="ae lq" href="https://en.wikipedia.org/wiki/Column-oriented_DBMS" rel="noopener ugc nofollow" target="_blank">列数据库</a>中，这些托管工具让您不必担心设置数据库服务器。</p><p id="b108" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">用你选择的编程语言编写代码</strong></p><p id="40b2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你喜欢写代码，你的编程语言可能有一个CSV解析库。例如，我经常使用标准Python库的一部分<a class="ae lq" href="https://docs.python.org/3/library/csv.html" rel="noopener ugc nofollow" target="_blank"> Python </a> CSV库。如果您正在处理大量数据并且对性能非常敏感，或者如果您想要执行上述工具无法处理的任务，这是一个有用的策略。在某些情况下，使用Unix工具如<a class="ae lq" href="https://www.gnu.org/software/gawk/manual/gawk.html" rel="noopener ugc nofollow" target="_blank"> awk </a>或<a class="ae lq" href="https://www.gnu.org/software/sed/manual/sed.html" rel="noopener ugc nofollow" target="_blank"> sed </a>可能对处理CSV有意义，但我通常会使用专门编写的命令行工具来处理CSV。编写自己的代码对于修复格式错误的CSV可能特别有帮助，这样它就可以被不同的解析器读取。</p><h1 id="cb23" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">提示和技巧</h1><p id="6bff" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">我确信这一点是显而易见的，但是在几乎所有情况下，您都不希望通过简单地用逗号分割文件或用逗号连接一系列值来编写自己的CSV解析器。如果您正在编写代码，几乎可以肯定存在一个CSV解析库，它可以处理尽可能多的我们已经讨论过的问题。但是，在某些情况下，您可能希望查看您的语言的CSV解析器的细节，以便更彻底地理解“CSV”的确切含义。</p><p id="e210" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您的CSV文件来自机器导出，请查看该系统的文档以了解它是如何导出CSV的。例如，Excel、MySQL、PostgreSQL等都在如何格式化CSV文件方面做出不同的决定。您正在使用的另一个专有或遗留系统可能会做出不同的决策。看看你正在使用的系统是否记录了它的CSV格式。在某些情况下，可能不会。</p><p id="49fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意数据类型。CSV是非类型化的，不同的系统可能有不同的方式来区分整数(1)和字符串(例如，邮政编码，01234)。确保您的系统不会将字符串id(可以从零开始)转换成整数。请注意不同系统处理NULL值的方式之间的差异，以及NULL和空字符串之间的差异，空字符串在CSV文件中可能是相同的值，也可能不是相同的值。</p><p id="59a1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您决定使用除CSV之外的任何其他开放格式，您可能希望考虑使用该格式而不是CSV。</p><p id="d9c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有时问题可以通过使用像XSV这样的工具来解决，使CSV中的所有字段都被引用，或者改变分隔符以便系统可以正确解析它。</p><p id="fb85" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您继续努力将您的CSV加载到某个系统中，而该系统可以加载另一种格式，如JSON，那么可以尝试在加载之前将您的CSV转换为JSON。JSON是正式指定的，可能会导致较少的问题。</p><h1 id="4b38" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">最终注释</h1><p id="f441" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在命令行查看<a class="ae lq" href="https://github.com/jeroenjanssens/data-science-at-the-command-line" rel="noopener ugc nofollow" target="_blank">Data Science</a>以更全面地了解如何通过命令行处理数据，而不仅仅是CSV文件。</p><p id="0252" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">CSV可能会令人沮丧，但请注意，你并不孤单，其他人可能也遇到了类似的问题。如果遇到问题，可以自由使用Google和StackOverflow。CSV的存在是有充分理由的——它简单、轻量级、可读，但是它表面上的简单隐藏了许多常见问题。当这些问题发生时，做好处理它们的准备。</p><h1 id="02dc" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">链接和参考</h1><ul class=""><li id="6fa9" class="nf ng it kw b kx mj la mk ld nh lh ni ll nj lp nk nl nm nn bi translated"><a class="ae lq" href="https://tools.ietf.org/html/rfc4180" rel="noopener ugc nofollow" target="_blank"> RFC 4180 —逗号分隔值(CSV)文件的通用格式和MIME类型</a></li><li id="5df5" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nk nl nm nn bi translated"><a class="ae lq" href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000323.shtml" rel="noopener ugc nofollow" target="_blank"> CSV，逗号分隔值(国会图书馆)</a></li><li id="904d" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nk nl nm nn bi translated"><a class="ae lq" href="https://chriswarrick.com/blog/2017/04/07/csv-is-not-a-standard/" rel="noopener ugc nofollow" target="_blank"> CSV不是标准的</a></li><li id="09da" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nk nl nm nn bi translated"><a class="ae lq" href="https://github.com/csvreader/docs/blob/master/why-the-csv-stdlib-is-broken.md" rel="noopener ugc nofollow" target="_blank">为什么(Ruby) CSV标准库被破坏</a></li><li id="9738" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nk nl nm nn bi translated"><a class="ae lq" href="https://www.python.org/dev/peps/pep-0305/" rel="noopener ugc nofollow" target="_blank"> PEP 305 —用Python描述CSV</a></li></ul></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="dda5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="mr">原载于</em><a class="ae lq" href="https://www.cloudbakers.com/blog/everything-you-didnt-want-to-have-to-know-about-csv" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://www.cloudbakers.com</em></a><em class="mr">。</em></p></div></div>    
</body>
</html>