<html>
<head>
<title>Newbie Adventures in COVID Data- leveraging APIs for aggregated data and Plotly for Charts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">COVID 数据中的新手冒险——将 API 用于聚合数据，将 Plotly 用于图表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/newbie-adventures-in-covid-data-leveraging-apis-for-aggregated-data-and-plotly-for-charts-a54e5f51e1fa?source=collection_archive---------78-----------------------#2020-06-24">https://towardsdatascience.com/newbie-adventures-in-covid-data-leveraging-apis-for-aggregated-data-and-plotly-for-charts-a54e5f51e1fa?source=collection_archive---------78-----------------------#2020-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3f2c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">来自 COVID ACT NOW APIs 的标准化数据允许对各州的每日阳性率进行比较</h2></div></div><div class="ab cl ki kj hx kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="im in io ip iq"><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/4e28ebb9d5438ed990134c843ee77842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p1LcOT88fUxUsIRDJQ5unQ.jpeg"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">图片由 Alison Doucette 提供</p></figure><p id="7cba" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">在《COVID 数据历险记》的<a class="ae mb" rel="noopener" target="_blank" href="/newbie-adventures-in-covid-data-e54550704b1e">第一集</a>中，我们开始探索使用 Python 基础知识(类似于 Excel 的函数)来查看新冠肺炎数据和马萨诸塞州的趋势。本周的挑战是利用由<a class="ae mb" href="https://covidactnow.org/" rel="noopener ugc nofollow" target="_blank"> COVID ACT NOW </a>发布的 API 来探索所有给定了标准化数据集的州，并利用 Plotly 进行可视化。</p><p id="27e9" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">如果你想继续学习，你可以在这里找到 COVID ACT NOW API <a class="ae mb" href="https://github.com/covid-projections/covid-data-model/blob/master/api/README.V1.md" rel="noopener ugc nofollow" target="_blank">的文档。GitHub 存储库非常有用，因为它展示了如何调用 API 以及如何提取数据。虽然有可能提取。CSV 文件(在我们的第一次冒险中，我们从一个. zip 文件导入)这次我要求 JSON 作为格式。</a></p><p id="fd01" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">对于那些对 PLOTLY 感兴趣的人，这里有一个到文档的链接。虽然有很多复杂的图表可用，但我只是复制了我用 Matplotlib 做的简单图表。</p><p id="4fb2" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">首先是一些图书馆。(由于这是在 Anaconda 中使用 Juypter 笔记本，在开始之前，我按照这里的说明<a class="ae mb" href="https://dash.plotly.com/installation" rel="noopener ugc nofollow" target="_blank">在终端中进行了 conda 安装。</a></p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="2313" class="mh mi it md b gy mj mk l ml mm">import numpy as np<br/>import pandas as pd<br/>import requests<br/>from pandas import DataFrame<br/>import matplotlib.pyplot as plt <br/>import plotly.graph_objects as go<br/>import plotly.express as px</span></pre><p id="d088" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">因为我知道我将为美国的不同州调用 API，所以我决定在组件中构建 URL，前缀是州代码(例如:MA 或 TX)作为一个单独的变量，后缀包括对 trends 和 JSON 格式的“时间系列”数据的请求。这将允许我在将来的某个时候比较不同的状态。</p><p id="2b86" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated"><strong class="lh iu">注意:从 7 月 5 日起，API 的输出不再与记录的 JSON 相匹配，所以这段代码不再起作用。根据 GIThub 链接:“</strong>从 6/5 开始，<code class="fe mn mo mp md b">cumulativePositiveTests</code>和<code class="fe mn mo mp md b">cumulativeNegativeTests</code>从<code class="fe mn mo mp md b">timeseries</code>行中移除。该数据在<code class="fe mn mo mp md b">actualsTimeseries</code>字段中仍然可用。</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="f277" class="mh mi it md b gy mj mk l ml mm">URL_prefix = “<a class="ae mb" href="https://data.covidactnow.org/latest/us/states/" rel="noopener ugc nofollow" target="_blank">https://data.covidactnow.org/latest/us/states/</a>"</span><span id="a94e" class="mh mi it md b gy mq mk l ml mm">state_code = “MA”</span><span id="bbb1" class="mh mi it md b gy mq mk l ml mm">URL_suffix = “.OBSERVED_INTERVENTION.timeseries.json”</span><span id="6ca0" class="mh mi it md b gy mq mk l ml mm">Call_URL = URL_prefix + state_code + URL_suffix</span></pre><p id="c410" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">然后是时候用请求调用 API，请求数据并打印出状态代码。</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="ff3d" class="mh mi it md b gy mj mk l ml mm">response = requests.get(Call_URL)<br/>data = response.json()<br/>print(“Status Code”,response.status_code)</span></pre><p id="447d" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">一旦我有了数据，我们的目标就是为每日检测率以及 COVID 检测的阳性率绘制趋势图。API 的伟大之处在于每个州的数据格式都是标准化的。缺点是 API 不包含抗体测试的数据。</p><p id="7698" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated"><em class="mr">正如本周《纽约时报》</em><a class="ae mb" href="https://www.nytimes.com/2020/06/18/health/coronavirus-antibodies.html" rel="noopener ugc nofollow" target="_blank"><em class="mr"/></a><em class="mr">指出的那样，缺乏抗体并不一定意味着你从未被感染，或者你缺乏免疫力，拥有抗体也不一定意味着它们不会随着时间的推移而消失，但观察这些数据很有趣。</em></p><p id="03bc" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">一旦接收到数据，我只需要将数据划分到我想要的列中，包括包含阴性测试的第一行作为开始日期，并排除尚未进行测试的日期。</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="07d9" class="mh mi it md b gy mj mk l ml mm">COVID_Series = (data[“timeseries”])<br/>COVID_Run_Date = (data[“lastUpdatedDate”])<br/>COVID_df = DataFrame(COVID_Series,columns=[‘date’,”cumulativePositiveTests”, “cumulativeNegativeTests”])<br/>Start_Row = COVID_df[‘cumulativeNegativeTests’].notna().idxmax()<br/>End_Row = COVID_df[‘cumulativeNegativeTests’].notna()[::-1].idxmax()<br/>COVID_df = COVID_df.iloc[Start_Row:End_Row]</span></pre><p id="34c0" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">然后，我需要确定每天的新测试，并计算每天的阳性率。</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="5bc7" class="mh mi it md b gy mj mk l ml mm">COVID_df[‘date’] = pd.to_datetime(COVID_df[‘date’], format=’%Y-%m-%d’)<br/>COVID_df['State'] = state_code<br/>COVID_df[‘Dly_PosTests’] = COVID_df[‘cumulativePositiveTests’].diff()<br/>COVID_df[‘Dly_NegTests’] = COVID_df[‘cumulativeNegativeTests’].diff()<br/>COVID_df[‘Dly_Tests’] = COVID_df[‘Dly_PosTests’] + COVID_df[‘Dly_NegTests’]<br/>COVID_df[‘Dly_Pos_Rate’] = (100* (COVID_df[‘Dly_PosTests’] / COVID_df[‘Dly_Tests’]))</span></pre><p id="3b33" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">这给了我一组数据来绘制图表:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ms"><img src="../Images/b13889267cc922341bec7f7bb5d3b85b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FJhjuk-GNTfdymsHtWZupQ.png"/></div></div></figure><p id="5e02" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">我对阳性测试结果的增长很感兴趣。</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="c916" class="mh mi it md b gy mj mk l ml mm">fig = px.line(COVID_df, x=”date”, y=”cumulativePositiveTests”)<br/>fig.update_layout(<br/> title=”Cumulative Positive Tests to Date”,title_x=0.5,<br/> xaxis_title=”Month”,<br/> yaxis_title=”Positive Tests”,<br/> font=dict(<br/> family=”Courier New, monospace”,<br/> size=12,<br/> color=”#7f7f7f”<br/> )<br/>)<br/>fig.show()</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mt"><img src="../Images/f53a6dcc8c4686264773e005fae74848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k9mWMoWVAs1x2s7QplR8Ng.png"/></div></div></figure><p id="28b9" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">考虑到数据隐私问题，如果可能对第一反应者进行重复检测，则不可能绘制出已检测人群的百分比，但可以绘制出每日阳性率。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mu"><img src="../Images/4894a1937ccad7cbe10c7b7214eef5f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XGilQiOSoHPZjN6TSaoMJA.png"/></div></div></figure><p id="46e8" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">每天的测试总数可以给你一个关于测试模式的想法。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mv"><img src="../Images/78aa2f35331fcb17b55188dd606af886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hd4bRUXhAMtIymr64PmdPw.png"/></div></div></figure><p id="a666" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">最后，我们可以看看用天数代替时间后的一些趋势:</p><pre class="kq kr ks kt gt mc md me mf aw mg bi"><span id="48ea" class="mh mi it md b gy mj mk l ml mm">COVID_df[‘Days’] = np.arange(len(COVID_df))</span><span id="6207" class="mh mi it md b gy mq mk l ml mm">fig = px.scatter(COVID_df, x=”Days”, y=”Dly_Tests”, trendline=”ols”)<br/>fig.update_layout(<br/> title=”Total Tests per Day Trend”,title_x=0.5,<br/> xaxis_title=”Days of Completed Testing”,<br/> yaxis_title=”Tests per Day”,<br/> font=dict(<br/> family=”Courier New, monospace”,<br/> size=12,<br/> color=”#7f7f7f”<br/> )<br/>)<br/>fig.show()</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mv"><img src="../Images/afb635ea3b230f4b0d7720071dbd3c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UwBZGpOO--H56S-kPvJB4A.png"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mw"><img src="../Images/431b46d1f83b3a1b0089b9ba96c63899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVl6fV9rjFLMh3oM3DlZag.png"/></div></div></figure><p id="a61e" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">利用 COVID ACT NOW APIs 提供美国各州的标准化数据。也就是说，数据有点混乱，需要更多的清理，因为数据输入错误可能会导致一些扭曲的值:(下面第 4 行是佛罗里达州的数据)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mx"><img src="../Images/abcec44829aa86c35969db801fed6c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXblBuXkDIKx6YYax8sYew.png"/></div></div></figure><p id="c9f3" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">结果图如下:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi my"><img src="../Images/71cfe596ec03f36403f8a06ba8e63369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4j273tRIUE7hZ36GGT9bNA.png"/></div></div></figure><p id="ef41" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">而不是更可能匹配真实情况的东西:(从第 14 行开始)并使用<a class="ae mb" href="https://en.wikipedia.org/wiki/Local_regression" rel="noopener ugc nofollow" target="_blank"> LOWESS </a>趋势:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mz"><img src="../Images/ba15bea4763f1a8f65ec7d19dd20c7ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GyYyqkoXMOUd2Emo1zwGtA.png"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi na"><img src="../Images/ed94459813cdc9d5836b527e2c1db50f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FrYsDBBCpRWplnJJsQUIAA.png"/></div></div></figure><p id="d75a" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">在这次冒险中，我们坚持一次只为一个州调用 COVID ACT NOW APIs，但是我们可以为所有的州调用它们，并开始比较各个州。我们可以使用移动平均线来平滑给定的周模式数据。我们可以建立一个用户界面，使整个过程更加用户友好。谁知道我们会去哪里？</p><p id="ea37" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">当你和云雀一起起床时，你的每一天都是以冒险开始的！</p><p id="c3ac" class="pw-post-body-paragraph lf lg it lh b li lj ju lk ll lm jx ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">接下来的系列文章:<a class="ae mb" href="https://medium.com/@alison.doucette/newbie-adventures-in-covid-data-maps-for-hotspots-and-positivity-rates-64fbeff1a163" rel="noopener">https://medium . com/@ Alison . doucette/newbie-adventures-in-covid-data-maps-for-hotspots-and-positivity-rates-64 FBE f1 a 163</a></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/b6fb045465353cbe1d08d7295f64c5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fk1HLx_kaEXaXjVPsBAU-Q.jpeg"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">图片由 Alison Doucette 提供</p></figure></div></div>    
</body>
</html>