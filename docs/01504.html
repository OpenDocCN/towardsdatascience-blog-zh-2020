<html>
<head>
<title>GROUP BY in Pandas and SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pandas和SQL中的分组依据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/group-by-in-pandas-and-sql-94777ce48658?source=collection_archive---------24-----------------------#2020-02-10">https://towardsdatascience.com/group-by-in-pandas-and-sql-94777ce48658?source=collection_archive---------24-----------------------#2020-02-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9512" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">聚合函数的比较</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4ada37d69932663bd823d447296a0ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCNIyMf6cIEvB61x1rMakA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">法国艺术家Paulo Grangeon的1600只熊猫+世界巡演。保罗·格兰金的作品|由ARR策划。参考资料中的艺术品网站链接</p></figure><p id="80bf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据分析的一个重要组成部分是通过计算总和、最大值、最小值、平均值、中值等聚合来生成摘要。这样，我们可以对数据的总体情况有所了解。这对于大型数据集尤其重要，因为查看原始数据可能不会产生任何有意义的见解。</p><p id="e52d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博文中，我将首先描述一下<code class="fe lu lv lw lx b">Group By</code>的下划线机制，然后比较一下<code class="fe lu lv lw lx b">Group By</code>概念在Python的<code class="fe lu lv lw lx b">pandas</code>库和SQL中的实现。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="d935" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">什么是分组依据？</h1><p id="b855" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">正如<code class="fe lu lv lw lx b">pandas</code>开发团队在他们的<a class="ae nc" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/groupby.html" rel="noopener ugc nofollow" target="_blank">文档中对GroupBy object </a>，<code class="fe lu lv lw lx b">Group By</code>包含三个步骤:</p><ul class=""><li id="0eb9" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated">步骤1: <strong class="la iu">根据一些标准将数据分成组</strong></li><li id="a471" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">步骤2: <strong class="la iu">独立地对每个组应用</strong>一个函数</li><li id="e7a9" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">步骤3: <strong class="la iu">将结果组合成一个数据结构</strong></li></ul><p id="3a5e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在分析数据框的上下文中，步骤1相当于找到一列，并使用该列的唯一值将数据框分成多个组。第2步是选择一个函数，如聚合、转换或过滤。所选功能将在每个单独的组上运行。步骤2的结果将被合并，并在步骤3中显示为新的数据结构。</p><p id="9671" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以上所有听起来可能仍然相当抽象；让我们使用来自<a class="ae nc" href="https://www.kaggle.com/c/titanic/data" rel="noopener ugc nofollow" target="_blank">泰坦尼克号追逐赛</a>的真实数据集来尝试一下。(注意，有三个数据集可用，我将在这篇博文中使用“train.csv”。)</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="4c49" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">在熊猫中分组</h1><p id="3672" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">Python <code class="fe lu lv lw lx b">pandas</code>库有一个名为<code class="fe lu lv lw lx b">groupby</code>的高效操作来执行Group By任务。</p><p id="9c82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在泰坦尼克号的数据集中，有一个名为“登船”的列，为每个乘客提供登船港口的信息。有三个不同的值:C、Q和S (C =瑟堡，Q =皇后镇，S =南安普顿)。如果我们想检查每个港口的乘客数量，我们可以使用以下命令:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="c14e" class="nv mg it lx b gy nw nx l ny nz">train.groupby('Embarked')['Embarked'].count()</span></pre><p id="39e7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它给出以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/969f7aee022a4ce71ca1532ca33e4817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xi6wX1f_hSvp6P1x.png"/></div></div></figure><p id="16fb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们使用<strong class="la iu">分割-应用-合并</strong>步骤对此进行一些分解。</p><p id="d424" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">第1步</strong>选择列“apollowed ”,使用它的唯一值——即C、Q、S——将数据集分成三类。</p><p id="d250" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，在此阶段，没有对组执行任何操作。命令<code class="fe lu lv lw lx b">train.groupby('Embarked')</code>仅仅输出一个<code class="fe lu lv lw lx b">GroupBy</code>对象:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/ecf9eefcd53757dbb8c226c8ccd0ef36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*c91T0DOgTWUJz5eE.png"/></div></div></figure><p id="17b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">步骤2 </strong>是选择<code class="fe lu lv lw lx b">count()</code>方法作为我们的函数，它产生每个类别的总数。</p><p id="3e11" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">第三步</strong>是组合并显示结果。<code class="fe lu lv lw lx b">pandas</code> GroupBy对象支持列索引，我们可以指定希望在聚合结果中看到哪些列。在我们的例子中，我们只关心“已装船”这一列。如果没有此规范，<code class="fe lu lv lw lx b">pandas</code>将返回所有数字列的汇总结果，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/6d6790fc3d7d3dbd44f4beb5bca1fcec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pZwODT88k8nZN0nf.png"/></div></div></figure></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="65f6" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">SQL中的分组依据</h1><p id="c994" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">Group By概念是SQL语法的重要组成部分。尽管存在一些语法差异，SQL的<code class="fe lu lv lw lx b">GOURP BY</code>语句的工作方式与<code class="fe lu lv lw lx b">pandas</code>相似。</p><p id="6829" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上述<code class="fe lu lv lw lx b">pandas</code>操作可以用SQL实现如下:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="58e0" class="nv mg it lx b gy nw nx l ny nz">SELECT Embarked, COUNT(Embarked) <br/>FROM titanic.train <br/>GROUP BY Embarked;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/4c6b8bd4769b4d8111595739c0ecbf27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cG55Ol3ljHZrmCjo.png"/></div></div></figure><p id="8e85" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe lu lv lw lx b">GROUP BY</code>语句中，选择列“apollowed”来分割数据集。在<code class="fe lu lv lw lx b">SELECT</code>语句的第二部分，选择<code class="fe lu lv lw lx b">COUNT()</code>作为聚合函数。<code class="fe lu lv lw lx b">SELECT</code>语句还包含我们希望在输出中显示哪些列的信息。第一次出现“已装船”相当于<code class="fe lu lv lw lx b">pandas</code>列索引<code class="fe lu lv lw lx b">[Embarked]</code>。另一个微小的区别是，SQL使用<code class="fe lu lv lw lx b">FROM</code>语句来指定我们正在处理的数据集，即来自“titanic”模式的“train”表；而在<code class="fe lu lv lw lx b">pandas</code>中，我们将数据帧的名称放在<code class="fe lu lv lw lx b">groupby</code>命令的开头。</p><p id="6a1e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样值得注意的是，SQL在使用<code class="fe lu lv lw lx b">GROUP BY</code>时会显示缺失值。从SQL输出中，我们可以看到两个乘客错过了登机港口。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="852d" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">高级示例</h1><h2 id="4663" class="nv mg it bd mh oc od dn ml oe of dp mp lh og oh mr ll oi oj mt lp ok ol mv om bi translated">示例1</h2><p id="ff41" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">如果我们想查看幸存与死亡乘客的平均票价，我们可以在<code class="fe lu lv lw lx b">pandas</code>中使用以下命令:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="42e6" class="nv mg it lx b gy nw nx l ny nz">train.groupby('Survived')['Fare'].mean()</span></pre><p id="149e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它给出了以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/c23e2ff89deadfeabd9fad6b89a93be6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eIaOJS1zspPE9p8u.png"/></div></div></figure><p id="ce1c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">类似地，我们可以在SQL中通过以下方式实现这一点:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="67f2" class="nv mg it lx b gy nw nx l ny nz">SELECT Survived, AVG(Fare) <br/>FROM titanic.train <br/>GROUP BY Survived;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/e3af6d5cc570d0875c4eb49dc1057b6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YYhxuiC5vPrHE6JH.png"/></div></div></figure><p id="e24f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我们所看到的，幸存的人比死去的人平均支付了更高的费用。</p><h2 id="eb54" class="nv mg it bd mh oc od dn ml oe of dp mp lh og oh mr ll oi oj mt lp ok ol mv om bi translated">示例2</h2><p id="128b" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">泰坦尼克号上有三种乘客等级，1级、2级和3级。假设我们想要检查每一个职业的幸存人数与死亡人数的百分比，我们可以结合使用下面的<code class="fe lu lv lw lx b">groupby</code>命令和<code class="fe lu lv lw lx b">pandas</code>中的<code class="fe lu lv lw lx b">.apply()</code>方法:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="4ec9" class="nv mg it lx b gy nw nx l ny nz">pclass = train.groupby(['Pclass','Survived']).agg({'Pclass':'count'}) </span><span id="2011" class="nv mg it lx b gy oo nx l ny nz">pclass_pcts = pclass.groupby(level=0).apply(<br/>lambda x: 100 * x / float(x.sum()))</span></pre><p id="7bba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，在<code class="fe lu lv lw lx b">.apply()</code>方法中，我们可以传递一个<code class="fe lu lv lw lx b">lambda</code>函数来计算百分比。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/857147388447b610a1a04abd81483688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OqPwT8Q2yXT78hdR.png"/></div></div></figure><p id="3505" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这也可以在SQL中使用<a class="ae nc" href="https://www.postgresql.org/docs/current/tutorial-window.html" rel="noopener ugc nofollow" target="_blank">窗口函数</a>来实现:</p><pre class="kj kk kl km gt nr lx ns nt aw nu bi"><span id="f254" class="nv mg it lx b gy nw nx l ny nz">WITH t1 AS <br/>   (SELECT Pclass, Survived, Count(*) AS n <br/>    FROM titanic.train <br/>    GROUP BY Pclass, Survived) <br/>SELECT Pclass, <br/>       Survived, <br/>       100 * n / (SUM(n) OVER (PARTITION BY Pclass)) AS percent<br/>FROM t1;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/85c0b0c403b778174326c68133d5a1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UWKn2llTHmqAgsMC.png"/></div></div></figure><p id="8e98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以得出结论，存活率随着乘客等级的降低而降低。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="ebfd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我的博文到此结束。Group By在<code class="fe lu lv lw lx b">pandas</code>和SQL中的实现非常通用，可以和很多其他函数结合使用，值得进一步探索。</p><p id="bfe7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读。一如既往，如果您有任何意见或反馈，我很乐意收到您的来信。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="7211" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">参考</h1><ul class=""><li id="2471" class="nd ne it la b lb mx le my lh oq ll or lp os lt ni nj nk nl bi translated">杰克·范德普拉斯的《Python数据科学手册》</li><li id="6d7d" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><a class="ae nc" href="https://www.postgresql.org/docs/current/tutorial-window.html" rel="noopener ugc nofollow" target="_blank"> SQL窗口函数</a></li><li id="8a1b" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><a class="ae nc" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/groupby.html" rel="noopener ugc nofollow" target="_blank">按对象分组的熊猫文档</a></li><li id="6e19" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">保罗·格兰金的1600只熊猫+世界巡演</li></ul></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="0f6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ot">原载于</em><a class="ae nc" href="https://github.com/FredaXin/blog_posts/blob/master/group_by/group_by.md" rel="noopener ugc nofollow" target="_blank"><em class="ot"/></a><em class="ot">。</em></p></div></div>    
</body>
</html>