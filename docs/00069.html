<html>
<head>
<title>Fast Counts on Big Data Systems using Presto or BigQuery and VerdictDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Presto 或 BigQuery 和 VerdictDB 快速计算大数据系统</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fast-counts-on-spatial-big-data-systems-using-presto-or-bigquery-and-verdictdb-ce2ac82b9b37?source=collection_archive---------40-----------------------#2020-01-02">https://towardsdatascience.com/fast-counts-on-spatial-big-data-systems-using-presto-or-bigquery-and-verdictdb-ce2ac82b9b37?source=collection_archive---------40-----------------------#2020-01-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a735" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当用户可以定义自己的谓词时，如何一致快速地(不到 4 秒)获得数十亿行的计数估计值？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/b2f3451a779474aa3268732ca11a2cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NtakQisafMSJ4R60"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">克里斯·贾维斯在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="87ef" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">问题是:</h1><blockquote class="md me mf"><p id="4dca" class="jq jr mg js b jt ju jv jw jx jy jz ka mh kc kd ke mi kg kh ki mj kk kl km kn im bi translated"><em class="it">“创建一个系统，客户可以通过选择和组合不同的滤镜来设计自己的受众”</em></p></blockquote><p id="1404" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我不会深入分析这个问题，但是我们最终找到了一个可以生成“查询”(不一定是 SQL)的系统，我们可以对我们的数据仓库运行该系统来产生受众。</p><p id="34f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其中棘手的部分是<strong class="js iu"> <em class="mg">“我们如何向客户展示对受众规模的估计”？</em>T9】</strong></p><p id="f362" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于最终用户可以从 8 个过滤器的任意组合中设计受众(每个过滤器包含 100-1000 个选项，这些选项会随着新数据的进入而频繁变化)，预缓存每个处理的计数实际上并不可行，特别是因为我们还提供了在特定日期之间进行过滤的功能，这意味着每个日期范围也需要预缓存！</p><h1 id="664e" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">早期实验</h1><p id="2e52" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我们决定使用一个示例查询作为我们的基本基准测试用例，它看起来像这样:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mp mq l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">示例查询</p></figure><p id="66e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们尝试了许多不同的方法来感受每个平台及其提供的功能。自然，我们从基础和众所周知的产品开始，但是，我们有许多来自每个数据库/数据仓库的不同需求，这在许多方面并不能真正与它们进行公平的比较(例如，我们需要地理空间功能，这排除了许多其他平台)。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mr"><img src="../Images/86b08a5e8e7279c3ba6638a0b650d949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keA65h2RoSANm2ZM-gQg3Q.png"/></div></div></figure><h1 id="f5e4" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">为什么 count(distinct())是准确性之王—但肯定不公平。</h1><p id="bf46" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">大多数读者会理解 count(distinct())是做什么的，但许多人不理解(或想不到)的是它是如何做什么的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ms"><img src="../Images/a2311703ef5a43f997615cd0e4c7b5a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FVVrnSJjErZGPpY1.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">非重复计数操作的查询计划</p></figure><p id="6655" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在一个巨大的数据集中计算不同的实体实际上是一个困难的问题，如果对数据进行排序会稍微容易一些，但是根据所使用的底层平台，在每次插入时对数据进行重新排序会变得非常昂贵。</p><p id="2ac0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常，非重复计数执行非重复排序，然后对分组值的每个“桶”中的项目进行计数。</p><p id="8308" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您需要 100%准确的计数，那么不幸的是，这几乎是您在随机数据集上获得计数的唯一方式，您可以在如何在平台中构造事物方面做一些技巧，以使事情更有效(例如，分区、聚类/分块)，但它本质上仍然必须执行相同的操作。</p><h1 id="1cbb" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">权衡——精度与速度</h1><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mt"><img src="../Images/527895357f145e9c0f653c7ef42a6f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UvB8sg5bRxO-vavw"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">卢克·切瑟在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="f9bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常有一些用例<strong class="js iu">不要求 100%的准确性，</strong>我们的就是其中之一，因为观众规模只是一个估计值——这给了我们一些额外的选择。</p><p id="f6dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有许多现有的采样方法，但它们的精度对于我们的要求来说太低了——在这种情况下，我们需要一些具有<strong class="js iu">正确平衡</strong>的方法。</p><h1 id="bcf7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用 VerdictDB 的解决方案</h1><p id="7b39" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">在这个过程的早期，我们联系了 VerdictDB，他们发布了一个开源产品的早期测试版，声称完全符合我们的要求。VerdictDB 使用概率/统计理论在大型数据集上创建基数估计值。但对我们来说最重要的是，它允许在整个表上创建。</p><p id="9662" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们使用气流建立了一个管道来协调数据准备，以确保一切就绪</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mu"><img src="../Images/de7bc7cc55152ad4dfd8abd5e4029ed0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DpCcYdZTMh2L5U4Fska5lQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">所有的错误！</p></figure><p id="af7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">VerdictDB 通过创建表的“扰码”来工作，这是一个预处理阶段，需要大量的处理能力，但只需要在添加新数据时进行一次。</p><p id="df96" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们在 Presto 和 BigQuery 上都执行了这一操作——big query 对于我们的特定用例来说更便宜，但这有许多原因(不适用于本文)。</p><h1 id="56d7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">决赛成绩</h1><p id="d6bd" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">下表列出了每种方法的最终结果。作为后台数据仓库，BigQuery 脱颖而出有许多不同的原因，但是它的焦点实际上是 VerdictDB 在简单性和速度方面相对于传统方法(如 HyperLogLog)真正能提供什么。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mv"><img src="../Images/3559ef4e917e9f0b17f0cdcae6eb5b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQ8CZzvGOxpts4UlD2TYLA.png"/></div></div></figure><h1 id="59b9" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="6664" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">通过使用 VerdictDB，Presto 和 BigQuery 都提供了允许人类界面进入我们的数据仓库所需的速度，BigQuery out 在许多领域都表现出 Presto 的性能，特别是当 BigQuery BI 进入等式时，尽管这仍处于测试阶段，仅提供 10GB(应该足以缓存 1TB 数据的 1%加扰)，但它在提供大数据的经济高效和快速界面方面具有巨大的潜力。</p><p id="c5de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想避免供应商锁定，那么 Presto 是一个很好的选择，但是需要考虑延迟和您用来确保足够快的分区模式！一旦在 Presto 上构建了扰码，还有其他几个选项可以用作查询接口。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mw"><img src="../Images/509d9efcaa8e117cc034b37e04a04e29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_d2_ZnD0sKcHeNR3lDMkLw.png"/></div></div></figure></div></div>    
</body>
</html>