<html>
<head>
<title>Interactive Power BI Custom Visuals with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交互式Power BI定制视觉效果，带R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/interactive-power-bi-custom-visuals-with-r-a6a4ac998710?source=collection_archive---------10-----------------------#2020-06-02">https://towardsdatascience.com/interactive-power-bi-custom-visuals-with-r-a6a4ac998710?source=collection_archive---------10-----------------------#2020-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="82c9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用ggplot、plotly和Power BI CLI实现交互式视觉效果</h2></div><p id="c58e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时候，正确的权力BI视觉就是不存在。最近，在尝试创建项目管理数据的执行摘要时，我碰到了这堵墙。</p><p id="4985" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个想法是一个报告页面，它将成为用户的首页——在他们进入其他报告页面的细节之前的一个快速路标，并且可以很容易地转换成演示文稿中的幻灯片。精简甘特图的尝试都是混乱而笨拙的。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/272dd34617d83ce5316167b93945c4a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rlaO3gdi3WCtQqQB.jpg"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">2003年SARS爆发的一个很好的例子，因果联系的信息可能是强大的，但项目管理数据经常会使计算机屏幕超载。<a class="ae lr" href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(03)15259-2/fulltext" rel="noopener ugc nofollow" target="_blank">引起严重急性呼吸综合征的新型冠状病毒的分子流行病学(The Lancet) </a></p></figure><h1 id="1753" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Power BI R脚本可视化</h1><p id="30f4" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">经过一番深思熟虑(玩)，一个基本的水平时间线似乎工作得很好。它将关注项目里程碑，使用颜色来描述项目状态，并尽最大努力使项目相关文本尽可能易读。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/f7f8ca0d38c0c33ac37b62fd1da57892.png" data-original-src="https://miro.medium.com/v2/resize:fit:854/format:webp/1*lbr7JSpFe_QU77ISTL5-yw.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">R script可视化，开发快速，可定制(有时令人恼火)</p></figure><p id="5f1d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="ae lr" href="https://appsource.microsoft.com/en-GB/marketplace/apps?product=power-bi-visuals" rel="noopener ugc nofollow" target="_blank">微软的AppSource </a>中似乎没有现成的可视化工具可以做到这一点，所以转向了R Script可视化工具。有了一点R知识，这些可以快速开发，并允许使用无限定制的ggplot来得到你想要的样子(注意，其他R绘图包是可用的)。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mq"><img src="../Images/da6179b460f844e6607ccc6aa2af0dd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_pGwD5XoPjIF9z9MeV6Nw.png"/></div></div></figure><p id="45c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事情是这样结束的。项目数据已经被英国首相取代，项目状态颜色现在告诉我们他们属于哪个政党。这在你下一次变焦测验中可能会很有用。<a class="ae lr" href="https://github.com/fredwise/PM_timeline/blob/master/pm_timeline_ggplot.R" rel="noopener ugc nofollow" target="_blank">代码在这里</a>。感谢<a class="ae lr" href="https://benalexkeen.com/creating-a-timeline-graphic-using-r-and-ggplot2/" rel="noopener ugc nofollow" target="_blank"> Ben Alex Keen，</a>他有一篇关于在r中构建这种时间线的精彩文章。</p><p id="c905" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如预期的那样，R视觉进入了报告。从直接在R中访问JSON数据转移到处理来自Power BI R Script Visual的数据需要一些变量重命名和格式化。视觉系统<a class="ae lr" href="https://github.com/fredwise/PM_timeline/blob/master/pm_timeline_ggplot_powerbi.R" rel="noopener ugc nofollow" target="_blank">的Power BI友好代码在这里</a>。</p><p id="1925" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些R图唯一缺少的是一点交互性。你可以使用Power BI的切片器和过滤器来限制数据进入，但你不能悬停在上面并获得工具提示，或者放大感兴趣的部分。</p><h1 id="7bc9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Plotly</h1><p id="4441" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">多亏了<a class="ae lr" href="https://plotly.com/r/" rel="noopener ugc nofollow" target="_blank"> plotly包</a>，我们可以将我们的ggplot对象转换成一些html，并至少增加一些交互性。</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="e8c4" class="mw lt iq ms b gy mx my l mz na">g = ggplotly(p, tooltip = 'text') %&gt;%<br/>  layout(legend = list(<br/>    orientation = 'h',<br/>    y = 1.1,<br/>    x = 0.1<br/>  ));</span></pre><p id="865d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Plotly也会托管这些图表，你可以从r内部把它们推上来。</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="f722" class="mw lt iq ms b gy mx my l mz na">Sys.setenv(plotly_username = 'xxx')<br/>Sys.setenv(plotly_api_key = 'xxxxxxxxxxx')</span><span id="4ee6" class="mw lt iq ms b gy nb my l mz na">api_create(g)</span></pre><div class="nc nd gp gr ne nf"><a href="https://chart-studio.plotly.com/~fred_tasker/7.embed" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">辉格党，保守党，保守党，贵族党，自由党，工党，辉格党，保守党，贵族党，自由党…</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">弗雷德·塔斯克的互动图表和数据“辉格党，保守党，保守党，贵族党，自由党，工党，辉格党，保守党…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">chart-studio.plotly.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ll nf"/></div></div></a></div><h2 id="0e0a" class="mw lt iq bd lu nu nv dn ly nw nx dp mc ko ny nz me ks oa ob mg kw oc od mi oe bi translated">工具提示</h2><p id="911e" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated"><a class="ae lr" href="https://plotly-r.com/improving-ggplotly.html" rel="noopener ugc nofollow" target="_blank">和许多其他的剧情特色</a>一样，我们现在有了一个悬停工具提示。在这个相当紧凑的图表中提供更多信息非常有用。这是在geom_text调用中使用虚拟美学定义的，名为“text”(gg plot忽略此美学)。</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="c424" class="mw lt iq ms b gy mx my l mz na">#Tooltip for plotly<br/>prime_ministers[,text:=paste0(<br/>  name, ', ',  party, '&lt;br&gt;'<br/>  ,format(start_date,'%d %b %Y'),' to ',format(end_date,'%d %b %Y')<br/>)]</span><span id="d0a0" class="mw lt iq ms b gy nb my l mz na"># Show project text<br/>p &lt;- p +  geom_text(aes(label = name,<br/>                        <strong class="ms ir">text=text</strong>,x=decade<br/>                         ,y = text_position,colour=party), <br/>                     size = 3, family = 'sans',show.legend = F, fontface='bold')</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi of"><img src="../Images/7eb9d05730ac6459f235e0a1b85aeade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*u6xCHEZGxb7oUGZPJPFDSA.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">在对geom_text的最终调用中，使用虚拟“文本”美学将自定义工具提示从ggplot传递到plotly对象</p></figure><h2 id="3dac" class="mw lt iq bd lu nu nv dn ly nw nx dp mc ko ny nz me ks oa ob mg kw oc od mi oe bi translated">古怪的行为</h2><p id="6b0c" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">关于使用ggplotly完成这项任务的快速补充说明。</p><p id="00b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> geom_label: </strong>在我们使用ggplotly从ggploty到plotly的转换中，geom_label不受支持，因此每个文本标签后面的透明矩形已被替换为字体颜色。</p><p id="7437" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">传说的命名也有一些奇怪的行为，比如“辉格党”变成了“辉格党，1”等等。这是由于ggplot对象同时具有颜色比例(用于文本和点)和填充比例(未使用，因为没有geom_label)。手动填充比例被删除，但如果需要填充比例，这将是令人讨厌的。唯一的解决方案似乎是手动调整plotly对象json。</p><h1 id="e698" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">将R代码打包到Power BI自定义可视化中</h1><p id="2c7c" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">最后一步是让这个plotly对象进入Power BI。</p><p id="00cb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不能把我们的R代码直接粘贴到R脚本中。ggplotly函数输出一个HTML对象，Power BI需要一个R plot对象。</p><p id="2d06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实证明，不需要太多的工作，我们就可以创建我们自己的自定义视觉效果来导入到Power BI中。这里有一个快速的步骤。</p><p id="2904" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1 </strong> - <a class="ae lr" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">安装node.js </a></p><p id="b3dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2 </strong> -用Powershell安装powerbi-visuals-tools包</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="d7cd" class="mw lt iq ms b gy mx my l mz na"><em class="og">npm install -g powerbi-visuals-tools</em></span></pre><p id="fc40" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3 </strong> -创建一个rhtml模板</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="ba54" class="mw lt iq ms b gy mx my l mz na">pbiviz new fredTimelineVis -t rhtml</span></pre><p id="bb56" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 4 </strong> -查找该命令创建的文件夹和文件(这取决于您的Powershell的工作目录)。然后找到script.r文件，用您自己的代码替换ggplot代码</p><p id="9d31" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的电脑上，rhtml文件输出到C:/Users/Fred tasker/fredTimelineVis。剧本。r有一个示例ggplot块和一个ggplotly行，我用上面的替换了它们。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/97001f4bedfd331f607354b19541e1cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*HZEDuXf4eKnvADewPfANSw.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">包装总理们。替换脚本的ggplot / ggplotly位。powerbi-visuals-tools 创建的r文件。</p></figure><p id="c325" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">几个注意事项:</p><ul class=""><li id="c7c4" class="oj ok iq kh b ki kj kl km ko ol ks om kw on la oo op oq or bi translated">确保在脚本的顶部有正确的库声明。记住R包<a class="ae lr" href="https://docs.microsoft.com/en-us/power-bi/connect-data/service-r-packages-support" rel="noopener ugc nofollow" target="_blank">需要存在于Power BI online </a>中，如果你打算在那里使用它的话</li><li id="399c" class="oj ok iq kh b ki os kl ot ko ou ks ov kw ow la oo op oq or bi translated">来自Power BI的数据在r中被称为Values对象。</li></ul><p id="4da5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是<a class="ae lr" href="https://github.com/fredwise/PM_timeline/blob/master/fredTimelineVis/script.r" rel="noopener ugc nofollow" target="_blank">的剧本。本例中使用的R </a>文件。</p><p id="14b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 5 - </strong>向pbiviz.json添加作者、描述和支持URL</p><p id="a0c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这很重要，因为如果不这样做，包编译将会失败。pbviz.json将与您的脚本在同一个目录中。r文件。</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="6a32" class="mw lt iq ms b gy mx my l mz na">...<br/>"description":<strong class="ms ir"><em class="og">"Horizontal timeline visual build using ggplot and plotly in R"</em></strong>,<br/>"supportUrl":<strong class="ms ir"><em class="og">"</em></strong><a class="ae lr" href="https://medium.com/@fredtasker/interactive-power-bi-custom-visuals-with-r-a6a4ac998710" rel="noopener"><strong class="ms ir">https://medium.com/@fredtasker/interactive-power-bi-custom-visuals-with-r-a6a4ac998710</strong></a><strong class="ms ir"><em class="og">"</em></strong>,<br/>"gitHubUrl":<strong class="ms ir">"</strong><a class="ae lr" href="https://github.com/fredwise/PM_timeline" rel="noopener ugc nofollow" target="_blank"><strong class="ms ir">https://github.com/fredwise/PM_timeline</strong></a><strong class="ms ir">"</strong>},<br/>...<br/>"author":{"name":<strong class="ms ir"><em class="og">"Fred Tasker"</em>,</strong>"email":<strong class="ms ir"><em class="og">"xxxx.com"</em></strong>}<br/>...</span></pre><p id="7214" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">6</strong>——回到PowerShell，导航到您的script.r目录并打包，准备好供Power BI使用。</p><p id="6e1f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就我而言:</p><pre class="lc ld le lf gt mr ms mt mu aw mv bi"><span id="0ffa" class="mw lt iq ms b gy mx my l mz na">cd C:\Users\FredTasker\fred_timeline_vis</span><span id="c0b4" class="mw lt iq ms b gy nb my l mz na">pbiviz package</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ox"><img src="../Images/230cdb87f84dff2fd1d8e9e5975e708e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Drf3j99jWzhEqAy7NI0-kg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">成功！</p></figure><p id="5a65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你遇到问题，这里有R HTML 的<a class="ae lr" href="https://github.com/microsoft/PowerBI-visuals/blob/master/RVisualTutorial/CreateRHTML.md" rel="noopener ugc nofollow" target="_blank">微软帮助页面。</a></p><h1 id="16c6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">导入到Power BI</h1><p id="fe5b" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">既然定制的可视化已经打包，我们只需要将它导入到Power BI中，并将我们的数据字段放到可视化中。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oy"><img src="../Images/96ff5bc72c9e224760848f79e35794f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-Yjoiv02-P2lTeRGhBH4w.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">从编译包的dist目录中导入pbiz vis文件</p></figure><p id="1c6a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一切都非常令人兴奋。在Power BI中构建交互式自定义视觉效果的快速方法。</p><p id="95e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看看Power BI服务上的结果仪表板<a class="ae lr" href="https://app.powerbi.com/view?r=eyJrIjoiOWEyYjJlYTYtNWQwNi00NGU1LTliNDEtODg2YzhhODQxYzY3IiwidCI6IjMyZTk3MjNkLWY2YjMtNDE5NS05MjlhLTkyZGFkMzIwNmRiMiJ9" rel="noopener ugc nofollow" target="_blank">，您会看到Power BI的发布到Web目前不支持静态R visual。要查看PBIX文件中的静态图和这里提到的所有其他脚本，请访问</a><a class="ae lr" href="https://github.com/fredwise/PM_timeline" rel="noopener ugc nofollow" target="_blank"> GitHub。</a></p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oz"><img src="../Images/ca076de6d80d472e73b75455697da1c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*64obPpM6iqfIGZ_CHdSkgA.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">我们做的不仅仅是首相！随时联系我们聊天<a class="ae lr" href="https://www.wisetechltd.com/" rel="noopener ugc nofollow" target="_blank">https://www.wisetechltd.com/</a></p></figure></div></div>    
</body>
</html>