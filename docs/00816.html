<html>
<head>
<title>Time series modeling with Facebook Prophet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用脸书预言家进行时间序列建模</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/time-series-modeling-with-facebook-prophet-57f146a11d0d?source=collection_archive---------10-----------------------#2020-01-23">https://towardsdatascience.com/time-series-modeling-with-facebook-prophet-57f146a11d0d?source=collection_archive---------10-----------------------#2020-01-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2363" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">分析和可视化时间序列数据的快速入门方法</h2></div><p id="00d0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当试图理解时间序列时，有太多的东西需要考虑。数据的总体趋势是什么？受季节性影响吗？我应该使用什么样的模型，它的性能如何？</p><p id="ab01" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有这些问题都会让时间序列建模变得有点吓人，但也没那么糟糕。最近在为我的数据科学训练营做一个项目时，我尝试了<a class="ae le" href="https://facebook.github.io/prophet/" rel="noopener ugc nofollow" target="_blank">脸书预言家</a>，一个由……你知道，脸书开发的用于时间序列建模的开源包。我发现使用我的数据运行它非常快速和容易，所以在这篇文章中，我将向您展示如何做到这一点，并分享一个我编写的使用 Prophet all-in-one 进行建模和验证的函数。请继续阅读！</p><h1 id="c2ca" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">时间序列建模:基础</h1><p id="4973" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">简而言之，时间序列建模就是寻找因变量和时间之间的关系。许多现实世界的数据可以以时间序列的形式出现:股票价格、温度、二氧化碳水平、我在万圣节每小时吃的零食数量等等。如果您想要预测时间序列中接下来会发生什么，那么您需要识别并消除时间对数据的影响，以便您可以将预测精力集中在任何潜在的、非基于时间的模式上。</p><p id="dbb0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">实际上，这意味着您应该:</p><ul class=""><li id="d94d" class="mc md it kk b kl km ko kp kr me kv mf kz mg ld mh mi mj mk bi translated">识别数据随时间变化的总体趋势。价值观总体上是上升还是下降？还是他们徘徊在一个中间点？</li><li id="0f91" class="mc md it kk b kl ml ko mm kr mn kv mo kz mp ld mh mi mj mk bi translated">识别数据中任何重复的、季节性的模式。价值观是否每年夏天都会飙升，每年冬天都会跌至低谷？值在工作日还是周末更高？“季节性”趋势可能发生在任何时间尺度上(年、月、日、小时等)。)，只要它在你的总时间段内重复。</li><li id="aecb" class="mc md it kk b kl ml ko mm kr mn kv mo kz mp ld mh mi mj mk bi translated">测试去除趋势和季节性后剩余的数据是否是平稳的。如果你的时间序列是平稳的，它的均值、方差和协方差从一项到下一项将是常数，而不是随时间变化。大多数时间序列模型都假设您提供给它们的数据是稳定的，因此如果您希望模型按预期工作，这是一个重要的步骤。</li></ul><p id="3f1f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来往往是某种形式的<a class="ae le" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average" rel="noopener ugc nofollow" target="_blank"> ARIMA </a>(自回归综合移动平均线)建模。ARIMA 类似于线性回归，但是我们的解释性特征是我们比较每个数据点的过去时间点。</p><p id="5dad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要在 Statsmodels 中运行一个<a class="ae le" href="https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.sarimax.SARIMAX.html" rel="noopener ugc nofollow" target="_blank"> ARIMA 模型，你需要计算出有多少以及哪些过去的时间点用于比较，这可能会变得棘手且耗时。要找到最佳组合，您可能需要多次运行您的模型，每次都使用不同的术语组合(使用网格搜索或随机搜索)，然后选择产生最佳结果的一个。当您考虑更多选项时，这样做所需的时间会成倍增加！</a></p><h1 id="b7c5" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">脸书先知</h1><p id="e72e" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated"><a class="ae le" href="https://facebook.github.io/prophet/" rel="noopener ugc nofollow" target="_blank">脸书预言家</a>在幕后自动化了其中的一些过程，所以你需要做的预处理和参数选择更少(你出错的机会也更少)。你可以想象，脸书对他们用户活动中基于时间的模式非常感兴趣，所以他们建立了 Prophet，使其在处理多种规模的季节性方面特别强大。Prophet 还被设计为可供开发人员和非开发人员使用，这意味着它易于编写，并且可以为您提供有吸引力的图表和方便的预测数据表，而您只需付出很少的努力。Prophet 真正希望从您那里得到的是特定格式的数据，我将在下一节介绍这一点。</p><h1 id="22d2" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">为先知做准备</h1><p id="79b6" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">请记住，我在 Python 中使用 Prophet，所以如果您在 r 中使用它，情况可能会有所不同。当 Prophet 读取您的数据帧时，它会查找两个特定的列。一个必须称为“ds”并包含您的 datetime 对象，另一个必须称为“y”并包含您的因变量。确保您的数据是“长”格式，即每行代表一个时间点。</p><p id="98e5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了更容易理解，我将使用 Statsmodels 的<a class="ae le" href="https://www.statsmodels.org/devel/datasets/generated/co2.html" rel="noopener ugc nofollow" target="_blank">数据集，记录 1958 年至 2001 年莫纳罗亚天文台</a>的二氧化碳水平。正如你将看到的，这个数据既有上升趋势，又有很强的季节性模式。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="7aa7" class="mz lg it mv b gy na nb l nc nd"># Load needed packages<br/>import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import statsmodels.api as sm<br/>from fbprophet import Prophet as proph<br/><br/># Load the "co2" dataset from sm.datasets<br/>data_set = sm.datasets.co2.load()<br/><br/># load in the data_set into pandas data_frame<br/>CO2 = pd.DataFrame(data=data_set["data"])<br/>CO2.rename(columns={"index": "date"}, inplace=True)<br/><br/># set index to date column<br/>CO2.set_index('date', inplace=True)<br/><br/>CO2.head()</span></pre><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/498d85fd73886007bb7ea7ca00e07506.png" data-original-src="https://miro.medium.com/v2/resize:fit:338/format:webp/1*YM7-imKgUTvXrKqUFFUJhQ.png"/></div><p class="ni nj gj gh gi nk nl bd b be z dk translated">现在，日期是这个数据框架的索引。</p></figure><p id="0468" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，我并没有马上将我的数据帧放入 Prophet 的正确格式中；我想先用它做些事情。</p><p id="f667" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">二氧化碳水平每周记录一次，但假设我对月间隔更感兴趣。我将重新取样为每月一次:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="9c38" class="mz lg it mv b gy na nb l nc nd"># Resample from weekly to monthly<br/>co2_month = CO2.resample('MS').mean()<br/><br/># Backfill any missing values<br/>co2_month.fillna(method='bfill', inplace=True)<br/><br/>co2_month.head()</span></pre><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/78be6bee6186f33c8aa12b2d21a21660.png" data-original-src="https://miro.medium.com/v2/resize:fit:370/format:webp/1*_sqB56y8bShnmwvAILmhYg.png"/></div><p class="ni nj gj gh gi nk nl bd b be z dk translated">现在数据代表月平均二氧化碳水平。</p></figure><p id="38bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看看趋势和季节性:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="93e6" class="mz lg it mv b gy na nb l nc nd"># Plot co2_month<br/>plt.plot(co2_month.index, co2_month.co2)</span></pre><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/419923eb70171f3f955d2280eb8c1242.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*gB7pnLtHZVxDklkbLfo-Rw.png"/></div><p class="ni nj gj gh gi nk nl bd b be z dk translated">一路曲折到达顶端！</p></figure><p id="c5e2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好吧，这是一个可怕的二氧化碳水平上升，但让我们继续。在使用 Prophet 之前，我们需要创建“ds”和“y”列。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="eb65" class="mz lg it mv b gy na nb l nc nd"># Reset the index to make the dates an ordinary column<br/>co2_month.reset_index(inplace=True)<br/><br/># Rename the columns<br/>co2_month.columns = ['ds', 'y']<br/>co2_month.tail()</span></pre><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div class="gh gi no"><img src="../Images/4391e0a66e510a8424c299b2a42e02bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:398/format:webp/1*7akYPmxM5fjHvib_aI0SPg.png"/></div><p class="ni nj gj gh gi nk nl bd b be z dk translated">我们有 526 行月度二氧化碳数据，为 Prophet 做了适当的标记。</p></figure><p id="8223" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们准备好迎接一些预言了！</p><h1 id="653f" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">包装该函数</h1><p id="cee6" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我想预测二氧化碳将如何随时间增长，但我也想知道我的模型表现如何。我可以用我所拥有的数据来做这件事，方法是分离出数据的一部分，预测这部分的值，然后将预测值与实际值进行比较。在这种情况下，我将去掉最后 10%的数据(53 个月)用于验证:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="094e" class="mz lg it mv b gy na nb l nc nd"># Split the data 90:10<br/>co2_train = co2_month[:473]<br/>co2_test = co2_month[473:]</span></pre><p id="f846" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我为自己编写了一个函数，它可以接受我的训练数据、验证数据和整个数据集，并返回以下内容:</p><ul class=""><li id="eadc" class="mc md it kk b kl km ko kp kr me kv mf kz mg ld mh mi mj mk bi translated">我的训练数据和预测的图表；</li><li id="038c" class="mc md it kk b kl ml ko mm kr mn kv mo kz mp ld mh mi mj mk bi translated">将我的预测与来自验证数据集的实际值进行比较的图；</li><li id="970b" class="mc md it kk b kl ml ko mm kr mn kv mo kz mp ld mh mi mj mk bi translated">显示基于整个数据集的长期预测的图；</li><li id="f733" class="mc md it kk b kl ml ko mm kr mn kv mo kz mp ld mh mi mj mk bi translated">显示整个数据集中总体趋势和季节性的图。</li></ul><p id="e8b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的函数打印这些图，并返回包含要与验证数据和长期预测进行比较的预测的数据帧。如果您想要分析模型预测的精确值，这些会很有用。</p><p id="b7b5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是我的函数:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="cdb6" class="mz lg it mv b gy na nb l nc nd"># Define a function to do all the great stuff described above<br/>def proph_it(train, test, whole, interval=0.95, forecast_periods1, <br/>             forecast_periods2):<br/>    '''Uses Facebook Prophet to fit model to train set, evaluate  <br/>    performance with test set, and forecast with whole dataset. The <br/>    model has a 95% confidence interval by default.<br/>       <br/>       Remember: datasets need to have two columns, `ds` and `y`.<br/>       Dependencies: fbprophet, matplotlib.pyplot as plt<br/>       Parameters:<br/>          train: training data<br/>          test: testing/validation data<br/>          whole: all available data for forecasting<br/>          interval: confidence interval (percent)<br/>          forecast_periods1: number of months for forecast on <br/>              training data<br/>          forecast_periods2: number of months for forecast on whole <br/>              dataset'''<br/>    <br/>    # Fit model to training data and forecast<br/>    model = proph(interval_width=interval)<br/>    model.fit(train)<br/>    future = model.make_future_dataframe(periods=forecast_periods1, freq='MS')<br/>    forecast = model.predict(future)<br/>    <br/>    # Plot the model and forecast<br/>    model.plot(forecast, uncertainty=True)<br/>    plt.title('Training data with forecast')<br/>    plt.legend();<br/>    <br/>    # Make predictions and compare to test data<br/>    y_pred = model.predict(test)<br/>    <br/>    # Plot the model, forecast, and actual (test) data<br/>    model.plot(y_pred, uncertainty=True)<br/>    plt.plot(test['ds'], test['y'], color='r', label='actual')<br/>    plt.title('Validation data v. forecast')<br/>    plt.legend();<br/>    <br/>    # Fit a new model to the whole dataset and forecast<br/>    model2 = proph(interval_width=0.95)<br/>    model2.fit(whole)<br/>    future2 = model2.make_future_dataframe(periods=forecast_periods2, <br/>                                          freq='MS')<br/>    forecast2 = model2.predict(future2)<br/>    <br/>    # Plot the model and forecast<br/>    model2.plot(forecast2, uncertainty=True)<br/>    plt.title('{}-month forecast'.format(forecast_periods2))<br/>    plt.legend();<br/>    <br/>    # Plot the model components<br/>    model2.plot_components(forecast);<br/>    <br/>    return y_pred, forecast2</span></pre><p id="edcd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，我的函数被设置为按月处理数据，图中将有反映这一点的标题。您可以重构函数来处理不同规模的数据，但这符合我的目的。</p><h1 id="feca" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">快跑，先知，快跑！</h1><p id="88ee" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">让我们在三个数据集(训练、验证和整体)上运行这个函数。因为我任意保留了最后 10% (53 个月)的数据进行验证，所以我也任意预测超过 10 倍的数据，即 530 个月，也就是 44 年多一点。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="ea9b" class="mz lg it mv b gy na nb l nc nd"># Run the wrapper function, supplying numbers of months for forecasts<br/>short_term_pred, long_term_pred = proph_it(co2_train, co2_test, co2_month, 53, 530)</span></pre><p id="bcef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该功能现在将开始打印出图。这是前 90%的数据集以及对后 10%的预测:</p><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/fcfb3912713813f3cb797005f0b0d992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_SsIcVzxvv9RiGAuFD54w.png"/></div></div></figure><p id="e56c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以将预测值与过去 53 个月的实际值进行比较:</p><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nu"><img src="../Images/da56640d978cfa3218c790b98bd84332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQ88xwgKA2wBg44pzbDboQ.png"/></div></div></figure><p id="6777" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在利用所有可用数据进行长期预测。自然，95%的置信区间会随着时间的推移而急剧扩大。二氧化碳水平可能会降低……但也可能会升高。</p><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nv"><img src="../Images/783c046b63d3285a98af4893857ed606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDNeZDWXk7aYr68KlqqiEA.png"/></div></div></figure><p id="483f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些是 Prophet 的“组件图”，它分解了数据中的趋势和季节性。看起来二氧化碳水平往往在春季达到年度最高，在秋季达到最低。</p><figure class="mq mr ms mt gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nw"><img src="../Images/1b366e6af19623bf8a04c6f4fa01a51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_37jQyhXmMHrYrmtkR-h3Q.png"/></div></div></figure><p id="2812" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我现在可以直观地分析这些漂亮的图，如果我想看预测值本身，我手头也有。</p><p id="64be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是全部了！我在一个关于预测未来几年俄勒冈州房价上涨的项目中使用了这个函数。你可以<a class="ae le" href="https://github.com/jrkreiger/or-real-estate" rel="noopener ugc nofollow" target="_blank">在 GitHub </a>上查看代码。</p><p id="09d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读！</p><p id="344d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nx">跨贴自</em><a class="ae le" href="http://jrkreiger.net" rel="noopener ugc nofollow" target="_blank"><em class="nx">【jrkreiger.net】</em></a><em class="nx">。</em></p></div></div>    
</body>
</html>