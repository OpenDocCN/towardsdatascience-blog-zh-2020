# âš¡ï¸åŠ è½½ç›¸åŒ CSV æ–‡ä»¶çš„é€Ÿåº¦æé«˜äº† 10 å€ï¼Œmemoryâš¡ï¸å‡å°‘äº† 10 å€

> åŸæ–‡ï¼š<https://towardsdatascience.com/%EF%B8%8F-load-the-same-csv-file-10x-times-faster-and-with-10x-less-memory-%EF%B8%8F-e93b485086c7?source=collection_archive---------2----------------------->

## ç†ŠçŒ«ï¼Œè¾¾å…‹ï¼Œå¤šé‡åŠ å·¥ï¼Œç­‰ç­‰â€¦

![](img/605444673ceba74ef491799e5a4b3c6e.png)

ç…§ç‰‡ç”±[å¡æ‹‰Â·å¯Œå‹’](https://unsplash.com/@caraventurera?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ( **æœ€å¿«çš„å“ºä¹³åŠ¨ç‰©**)ä¸Šæ‹æ‘„

å³ä½¿æˆ‘ä»¬æœ‰ 1TB çš„ç£ç›˜å­˜å‚¨ã€8GB/16GB çš„ RAMï¼Œè®¸å¤šå…¶ä»–æ•°æ®åŠ è½½ API ä»ç„¶éš¾ä»¥åŠ è½½ 2GB çš„æ–‡ä»¶ã€‚

è¿™æ˜¯å› ä¸ºå½“è¿›ç¨‹è¯·æ±‚å†…å­˜æ—¶ï¼Œå†…å­˜ä»¥ä¸¤ç§æ–¹å¼åˆ†é…:

1.  è¿ç»­å†…å­˜åˆ†é…(åˆ†é…è¿ç»­çš„å—)
2.  éè¿ç»­å†…å­˜åˆ†é…(ä¸åŒä½ç½®çš„ç‹¬ç«‹å—)

Pandas ä½¿ç”¨è¿ç»­å†…å­˜å°†æ•°æ®åŠ è½½åˆ° RAM ä¸­ï¼Œå› ä¸º RAM ä¸Šçš„è¯»å†™æ“ä½œå¿…é¡»æ¯”ç£ç›˜(æˆ– SSD)å¿«ã€‚

*   å›ºæ€ç¡¬ç›˜è¯»æ•°:~16ï¼Œ000 çº³ç§’
*   ä» RAM ä¸­è¯»å–:~100 çº³ç§’

åœ¨è¿›å…¥å¤šå¤„ç†& GPUs ç­‰ä¹‹å‰â€¦è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æœ‰æ•ˆåœ°ä½¿ç”¨ *pd.read_csv()* ã€‚

> Pandas å¯ä»¥å¾ˆå¥½åœ°åŠ è½½æ•°æ®å’Œé¢„å¤„ç†ï¼Œä½†æ˜¯è¦è®­ç»ƒä½ çš„æ¨¡å‹ï¼Œä» [TensorFlow](https://www.tensorflow.org/api_docs/python/tf/data/Dataset) æˆ– [PyTorch](https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader) æˆ–ä»»ä½•ä½ è¿è¡Œæ¨¡å‹çš„åœ°æ–¹å¼€å§‹ä½¿ç”¨ DataLoaderã€‚

![](img/1af565c16265bbd16a1078d9ca107084.png)

å¡å·´æ–¯è’‚å®‰Â·è€¶ä½©æ–¯åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

> æ³¨æ„:å¦‚æœæ‚¨åœ¨æ‰‹æœºä¸Šé˜…è¯»ï¼Œæ‚¨å¯èƒ½æ— æ³•æ»šåŠ¨æµè§ˆä»£ç ã€‚(æ‰“å¼€è¦ç‚¹å¯è¯»æ€§æ›´å¥½ã€‚)

## ***1ã€‚ä½¿ç”¨åˆ—:***

è€Œä¸æ˜¯åŠ è½½æ•°æ®å¹¶åˆ é™¤å¤„ç†æ•°æ®æ—¶æ— ç”¨çš„ä¸å¿…è¦çš„åˆ—ã€‚åªåŠ è½½æœ‰ç”¨çš„åˆ—ã€‚

ğŸ”¥å†…å­˜ä½¿ç”¨ä¸æ‚¨ä½¿ç”¨çš„åˆ—æ•°æˆæ¯”ä¾‹ã€‚ğŸ”¥

## **2 *ã€‚*ä½¿ç”¨æ­£ç¡®çš„** `**dtypes**` **è¿›è¡Œæ•°å€¼æ•°æ®:**

åœ¨ç†ŠçŒ«æ•°æ®æ¡†æ¶ä¸­ï¼Œæ¯ä¸€åˆ—éƒ½æœ‰è‡ªå·±çš„`dtype`ï¼Œä¾‹å¦‚ï¼Œæ•´æ•°æœ‰`int64`ã€`int32`ã€`int16`ç­‰

*   `int8`å¯ä»¥å­˜å‚¨-128 åˆ° 127 çš„æ•´æ•°ã€‚
*   `int16`å¯ä»¥å­˜å‚¨ä»-32768 åˆ° 32767 çš„æ•´æ•°ã€‚
*   `int64`å¯ä»¥å­˜å‚¨-9223372036854775808 åˆ° 9223372036854775807 çš„æ•´æ•°ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œç†ŠçŒ«å°†`int64`åˆ†é…ç»™æ•´æ•°`datatype`ï¼Œå› æ­¤é€šè¿‡å®šä¹‰æ­£ç¡®çš„`dtypes`ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨ã€‚

ğŸ”¥å†…å­˜ä½¿ç”¨å‡å°‘äº† 75%ã€‚ğŸ”¥

**ğŸ”¥Pro æç¤º:**åœ¨åŠ è½½æ•°æ®æ—¶ä½¿ç”¨`converters`æ¥æ›¿æ¢ç¼ºå¤±å€¼æˆ– nanï¼Œç‰¹åˆ«æ˜¯å¯¹äºä½¿ç”¨`dtype.`é¢„å®šä¹‰äº†æ•°æ®ç±»å‹çš„åˆ—

![](img/006000411a026665c6b5b00d8c1d4e11.png)![](img/f69099691a73c19c2d2873dbad2675e6.png)

ç”±[å¡ç¼ªå°”Â·å‰æ–‡](https://unsplash.com/@sam_girven?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

## ***3ã€‚ä½¿ç”¨æ­£ç¡®çš„*** `***dtypes***` ***è¿›è¡Œåˆ†ç±»åˆ—:***

åœ¨æˆ‘çš„æ•°æ®é›†ä¸­ï¼Œæˆ‘æœ‰ä¸€ä¸ªåˆ—`Thumb`ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè¢«è§£æä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å®ƒåªåŒ…å«å›ºå®šæ•°é‡çš„å€¼ï¼Œè¿™äº›å€¼å¯¹äºä»»ä½•æ•°æ®é›†éƒ½ä¿æŒä¸å˜ã€‚

![](img/4ff61fae205cc79279a660e126e5ac10.png)

è¿˜æœ‰æ€§åˆ«ç­‰æ ç›®..å¯å­˜å‚¨ä¸º[åˆ†ç±»](https://pandas.pydata.org/pandas-docs/stable/user_guide/categorical.html)å€¼ï¼Œå°†å†…å­˜ä»çº¦ 1000 KB å‡å°‘è‡³çº¦ 100 KBã€‚(æ£€æŸ¥ sat)

ğŸ”¥å†…å­˜ä½¿ç”¨å‡å°‘äº† 97%ã€‚ğŸ”¥

**ğŸ”¥ä¸“ä¸šæç¤º:**å¦‚æœä½ çš„æ•°æ®å¸§åŒ…å«å¤§é‡ç©ºå€¼ã€ç¼ºå¤±å€¼æˆ– nanï¼Œä½ å¯ä»¥é€šè¿‡å°†å®ƒä»¬è½¬æ¢æˆ[ç¨€ç–åºåˆ—](https://pandas.pydata.org/pandas-docs/stable/user_guide/sparse.html)æ¥å‡å°‘å®ƒä»¬çš„å†…å­˜å ç”¨ã€‚

## ***4ã€‚nrowsï¼Œè·³è¿‡è¡Œ*å’Œ**

ç”šè‡³åœ¨å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ° RAM ä¹‹å‰ï¼Œä½¿ç”¨å°æ•°æ®é›†æµ‹è¯•æ‚¨çš„å‡½æ•°å’Œå·¥ä½œæµæ€»æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼Œpandas ä½¿ç²¾ç¡®é€‰æ‹©è¡Œæ•°å˜å¾—æ›´åŠ å®¹æ˜“(æ‚¨ç”šè‡³å¯ä»¥è·³è¿‡ä¸éœ€è¦çš„è¡Œã€‚)

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå‡ºäºæµ‹è¯•ç›®çš„ï¼Œå½“ä¸€ä¸ªæ ·æœ¬å¯ä»¥åšå¾—å¾ˆå¥½æ—¶ï¼Œæ‚¨ä¸éœ€è¦åŠ è½½æ‰€æœ‰æ•°æ®ã€‚

`nrows`ä»æ–‡ä»¶ä¸­è¯»å–çš„è¡Œæ•°ã€‚

```
>>> Import pandas as pd
>>> df = pd.read_csv("train.csv", nrows=1000)
>>>len(df)
1000
```

`skiprows`æ–‡ä»¶å¼€å¤´è¦è·³è¿‡çš„è¡Œæ•°(0-ç´¢å¼•)æˆ–è¦è·³è¿‡çš„è¡Œæ•°(int)ã€‚

```
# Can be either list or first N rows.
df = pd.read_csv('train.csv', skiprows=[0,2,5]) 
# It might remove headings
```

**ğŸ”¥æç¤º:**`nrows`çš„ä¸€ä¸ªæœ‰æ•ˆç”¨æ³•æ˜¯å½“æ‚¨æœ‰è¶…è¿‡ 100 ä¸ªåˆ—æ—¶ï¼Œæ£€æŸ¥å¹¶ä¸ºæ¯ä¸€åˆ—å®šä¹‰æ­£ç¡®çš„æ•°æ®ç±»å‹ã€‚æ‰€æœ‰è¿™äº›å¼€é”€éƒ½å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„`nrows`æ¥å‡å°‘ã€‚

```
sample = pd.read_csv("train.csv", nrows=100) # Load Sample datadtypes = sample.dtypes # Get the dtypes
cols = sample.columns # Get the columnsdtype_dictionary = {} 
for c in cols:
    """
    Write your own dtypes using 
    # rule 2
    # rule 3 
    """
    if str(dtypes[c]) == 'int64':
        dtype_dictionary[c] = 'float32' # Handle NANs in int columns
    else:
        dtype_dictionary[c] = str(dtypes[c])# Load Data with increased speed and reduced memory.
df = pd.read_csv("train.csv", dtype=dtype_dictionary, 
                 keep_default_na=False, 
                 error_bad_lines=False,
                 na_values=['na',''])
```

**æ³¨æ„:**ç”±äº nan åœ¨ pandas ä¸­è¢«è®¤ä¸ºæ˜¯ floatï¼Œæ‰€ä»¥å¦‚æœæ‚¨çš„åˆ—åŒ…å« nanï¼Œä¸è¦å¿˜è®°å°† integer data _ types è½¬æ¢ä¸º floatã€‚

**5ã€‚åˆ†å—åŠ è½½æ•°æ®:**

ç†ŠçŒ« read_csv()ä¸­çš„å†…å­˜[é—®é¢˜](https://wesmckinney.com/blog/update-on-upcoming-pandas-v0-10-new-file-parser-other-performance-wins/)é•¿æœŸå­˜åœ¨ã€‚å› æ­¤ï¼ŒåŠ è½½å¤§å‹æ•°æ®é›†çš„æœ€ä½³å˜é€šæ–¹æ³•ä¹‹ä¸€æ˜¯åˆ†å—åŠ è½½ã€‚

**æ³¨æ„:**åˆ†å—åŠ è½½æ•°æ®å®é™…ä¸Šæ¯”ç›´æ¥è¯»å–æ•´ä¸ªæ•°æ®è¦æ…¢ï¼Œå› ä¸ºæ‚¨éœ€è¦å†æ¬¡`concat`åˆ†å—ï¼Œä½†æ˜¯æ‚¨å¯ä»¥è½»æ¾åŠ è½½è¶…è¿‡ 10 GB çš„æ–‡ä»¶ã€‚

![](img/1333fb080561694e9d8ec111eb0f3eb2.png)

ç…§ç‰‡ç”±[ä¼Šç³å¨œÂ·å¸ƒæ´›å…‹](https://unsplash.com/@irinablok?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

## 6.ä½¿ç”¨ pandas çš„å¤šé‡å¤„ç†:

å› ä¸º pandas æ²¡æœ‰ njobs å˜é‡æ¥åˆ©ç”¨å¤šå¤„ç†èƒ½åŠ›ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`multiprocessing`åº“åœ¨å¤šçº¿ç¨‹ä¸Šå¼‚æ­¥å¤„ç†å—å¤§å°æ“ä½œï¼Œè¿™å¯ä»¥å°†è¿è¡Œæ—¶é—´å‡å°‘ä¸€åŠã€‚

å¤å¡”æ›¼å·´æ‹‰æ‹‰æ›¼

> **æ³¨æ„:**æ‚¨åªéœ€è¦åœ¨ __main__ ä¸­å®šä¹‰`pool`ï¼Œå› ä¸ºåªæœ‰ main å¯ä»¥åœ¨å¤šä¸ªå¤„ç†å™¨ä¹‹é—´å¼‚æ­¥åˆ†é…æ± ã€‚

## 7.Dask ä»£æ›¿ç†ŠçŒ«:

è™½ç„¶ Dask æ²¡æœ‰åƒ pandas é‚£æ ·æä¾›å¹¿æ³›çš„æ•°æ®é¢„å¤„ç†åŠŸèƒ½ï¼Œä½†å®ƒæ”¯æŒå¹¶è¡Œè®¡ç®—ï¼ŒåŠ è½½æ•°æ®æ¯” pandas æ›´å¿«

```
import dask.dataframe as dddata = dd.read_csv("train.csv",dtype={'MachineHoursCurrentMeter': 'float64'},assume_missing=True)
data.compute()
```

ğŸ”¥**ä¸“ä¸šæç¤º:**å¦‚æœä½ æƒ³çŸ¥é“ jupyter ç»†èƒè¿è¡Œæ‰€éœ€çš„æ—¶é—´ï¼Œåªéœ€åœ¨ç»†èƒå¼€å§‹å¤„æ·»åŠ `%%time`é­”æ³•å‡½æ•°

è¯•é¢˜åº“:[**Paratext**](https://github.com/wiseio/paratext)**ï¼Œ**[**Datatable**](https://github.com/h2oai/datatable)**ã€‚**

> ä»–ä»¬çš„æ˜¯å¦ä¸€ç§æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨äº‘ä¸­ç§Ÿä¸€å°è™šæ‹Ÿæœºï¼Œ64 ä¸ªå†…æ ¸å’Œ 432GB å†…å­˜ï¼Œæ¯å°æ—¶ 3 ç¾å…ƒå·¦å³ï¼Œç”šè‡³æ›´å¥½çš„ä»·æ ¼ã€‚
> 
> **è­¦å‘Š**:ä½ éœ€è¦èŠ±ä¸‹ä¸€å‘¨çš„æ—¶é—´æ¥é…ç½®å®ƒã€‚

è°¢è°¢ä½ åšæŒåˆ°æœ€åï¼Œæˆ‘å¸Œæœ›ä½ å­¦åˆ°äº†æ–°çš„ä¸œè¥¿ã€‚å¿«ä¹è£…è´§â€¦âœŒï¸.ï¼ˆğŸ‘å¦‚æœä½ å–œæ¬¢çš„è¯ã€‚)

> åœ¨ä¸‹é¢è¯„è®ºä½ ç”¨æ¥æ›´å¿«åŠ è½½æ•°æ®çš„æŠ€å·§ï¼Œæˆ‘ä¼šæŠŠå®ƒä»¬æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚

***(æŠŠä»–ä»¬æ·»åŠ åˆ°ä½ çš„åšå®¢åˆ—è¡¨ä¸­):***

ğŸ”¥ [Itamar Turner-Trauring](https://pythonspeed.com) â€”é€Ÿåº¦å·¨èŸ’å¤§å¸ˆ(å¿…é¡»âœ…).

ğŸ”¥ [Gouthaman Balaraman](http://gouthamanbalaraman.com/) â€”ç”¨ python è¿›è¡Œé‡åŒ–é‡‘è(å¿…é¡»âœ…).

åœ¨ [Linkedin](https://www.linkedin.com/in/prudhvi-vajja-22079610b/) ä¸Šä¸æˆ‘è”ç³»ã€‚