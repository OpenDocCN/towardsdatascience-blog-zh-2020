<html>
<head>
<title>Deep Learning on AWS for a Fraction of the Cost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上进行深度学习，成本很低</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spot-connect-with-aws-f95c964b0e92?source=collection_archive---------54-----------------------#2020-06-05">https://towardsdatascience.com/spot-connect-with-aws-f95c964b0e92?source=collection_archive---------54-----------------------#2020-06-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="561e" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">PYTHON库简介</h2><div class=""/><div class=""><h2 id="eeeb" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">python的点连接模块简介</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/348f10323eb71203063d626a86edbdc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pR7Oo6503_YLPBuXJpdYFA.jpeg"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@timmossholder?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">蒂姆·莫斯霍尔德</a>在<a class="ae le" href="https://unsplash.com/s/photos/cloudy-skyscraper?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="94d6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated">S  <strong class="lh ja"> pot-connect </strong>是一个python模块，适用于任何正在寻找使用云计算的简单方法的程序员。</p><p id="e438" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最初是为机器学习项目开发的，<a class="ae le" href="https://github.com/losDaniel/spot-connect" rel="noopener ugc nofollow" target="_blank"> spot-connect </a>使得使用Amazon Web Services和EC2实例变得很容易。</p><p id="50c2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AWS提供的服务和设置帐户的步骤包含在旧文章的<strong class="lh ja">了解AWS </strong>和<strong class="lh ja">设置您的AWS帐户</strong>部分。</p><p id="ba42" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="mk">如果您计划尝试点连接，并且尚未安装和配置AWS命令行(</em> <code class="fe ml mm mn mo b"><em class="mk">pip install awscli</em></code> <em class="mk">、</em> <code class="fe ml mm mn mo b"><em class="mk">aws config</em></code> <em class="mk">)，或者如果您尚未为AWS帐户创建访问密钥，请阅读参考章节。</em></p><p id="9343" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">spot-instance运行在AWS无法出租的硬件上。从来没有足够的需求来出租亚马逊的所有机器，所以他们以原价的一小部分出租多余的容量，以弥补他们的一些成本。</p><p id="2ad0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">唯一的问题是，如果需求增加，你可能会被踢出实例，这在高端实例中更有可能发生(在你被踢出之前，你会得到2分钟的警告，以便你可以保存/转移你的工作)。</p><p id="0847" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">定点连接模块允许您创建和管理定点实例。它可以从命令行、脚本或jupyter笔记本中使用。它专注于管理EC2资源(AWS的云计算服务),但提供了额外的功能来与弹性文件系统和S3等存储选项进行交互。</p><p id="2abd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">接下来是如何使用该模块的演练。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="7b66" class="mw mx iq bd my mz na nb nc nd ne nf ng kf nh kg ni ki nj kj nk kl nl km nm nn bi translated">装置</h1><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="08a6" class="ns mx iq mo b gy nt nu l nv nw">pip install spot-connect<!-- --> </span></pre><p id="c79f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">使用python 3。*</p><h1 id="ad29" class="mw mx iq bd my mz nx nb nc nd ny nf ng kf nz kg ni ki oa kj nk kl ob km nm nn bi translated">命令行用例</h1><p id="1cd0" class="pw-post-body-paragraph lf lg iq lh b li oc ka lk ll od kd ln lo oe lq lr ls of lu lv lw og ly lz ma ij bi translated">一旦你安装了模块，你可以在提示符下使用它</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="5064" class="ns mx iq mo b gy nt nu l nv nw">spot_connect -n instance_1 -p t2.micro -a True</span></pre><p id="9297" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在命令提示符下使用spot_connect还可以让您将提示符直接连接到实例。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/698c5f0279d8efaa0dd3d77bdc2c4a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*vTif-PQvKNUL2rpJCz-kwQ.gif"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">使用spot-connect启动一个实例，然后使用链接提示符(个人屏幕截图)直接在实例上运行linux命令。</p></figure><p id="e4c0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上面的例子用“t2.micro”概要文件创建了一个名为“instance_1”的实例。它连接到一个名为“stockefs”的弹性文件系统，并将提示符连接到新创建的实例。</p><p id="def2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">gif已经被加速了。启动一个实例通常需要几分钟或更长时间，这取决于规格。 <strong class="lh ja"> <em class="mk">如果您使用现有实例的名称进行连接，您将立即重新连接到该实例。</em> </strong></p><p id="2f98" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">命令提示符下对<code class="fe ml mm mn mo b">spot_connect</code>最有用的参数是:</p><ul class=""><li id="dd67" class="oi oj iq lh b li lj ll lm lo ok ls ol lw om ma on oo op oq bi translated"><em class="mk">名称</em> ( <code class="fe ml mm mn mo b">-n</code>):现货实例的名称<strong class="lh ja"> * </strong></li><li id="28ca" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">配置文件</em> ( <code class="fe ml mm mn mo b">-p</code>):配置文件的名称(指定实例类型、最高投标价格等的预设配置……更多信息请见下文)。<strong class="lh ja"> ** </strong></li><li id="c2bf" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">文件系统</em> ( <code class="fe ml mm mn mo b">-f</code>):要连接的弹性文件系统。如果它不存在，将创建一个(不必与实例名相同)。</li><li id="8114" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated">脚本 ( <code class="fe ml mm mn mo b">-s</code>):一旦准备好就在实例上运行的脚本(如果在实例上使用linux操作系统，这必须是一个bash脚本……)。</li><li id="2f6f" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">上传</em> ( <code class="fe ml mm mn mo b">-u</code>):上传你想要的任何文件到实例中(对于小上传有用，否则使用S3传输，更多内容见下文)。</li><li id="af2f" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">远程路径</em> ( <code class="fe ml mm mn mo b">-r</code>):上传将上传到实例上的这个路径。</li><li id="a2d6" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">主动提示</em> ( <code class="fe ml mm mn mo b">-a</code>):如果为真，将提示连接到实例(只能从命令提示符完成)。</li><li id="8b5d" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><em class="mk">实例概要</em> ( <code class="fe ml mm mn mo b">-ip</code>):实例的访问角色(不同于概要)。这授予<strong class="lh ja">实例</strong>访问其他AWS资源的权限，如S3 。<strong class="lh ja"> ** </strong></li></ul><p id="2981" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja"> * </strong> <em class="mk"> </em> = <em class="mk">必需<br/> </em> <strong class="lh ja"> ** </strong> = <em class="mk">仅在创建实例时必需(不重新连接)</em></p><p id="0e5c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">能够将提示直接连接到实例对于排除脚本故障或运行任何其他检查非常有用。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="aefb" class="mw mx iq bd my mz na nb nc nd ne nf ng kf nh kg ni ki nj kj nk kl nl km nm nn bi translated">选择实例类型</h1><p id="5a7b" class="pw-post-body-paragraph lf lg iq lh b li oc ka lk ll od kd ln lo oe lq lr ls of lu lv lw og ly lz ma ij bi translated">要用spot-connect启动一个实例，您只需给该实例一个名称和一个<em class="mk">概要文件</em>。</p><p id="7b99" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">概要文件是预设的实例规范，它定义了诸如<a class="ae le" href="https://aws.amazon.com/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank">实例类型</a>、<a class="ae le" href="https://aws.amazon.com/ec2/spot/pricing/" rel="noopener ugc nofollow" target="_blank">最高投标价格</a>、区域和其他连接选项等内容。这些可以在安装模块时随模块一起下载的<a class="ae le" href="https://github.com/losDaniel/spot-connect/blob/master/spot_connect/profiles.txt" rel="noopener ugc nofollow" target="_blank"> profiles.txt </a>文件中找到。</p><p id="fdde" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">可用实例类型、</strong> <a class="ae le" href="https://aws.amazon.com/ec2/spot/pricing/" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">定价</strong> </a> <strong class="lh ja">、图片/AMI id均随地区</strong>变化。Spot-connect附带了从AWS网站获取的区域实例数据和AMI id数据。</p><p id="b5b2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您可以使用点连接模块更改默认的配置文件设置:</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="bee0" class="ns mx iq mo b gy nt nu l nv nw">from spot_connect import sutils <br/>sutils.reset_profiles()</span></pre><p id="30ad" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe ml mm mn mo b">reset_profiles()</code>方法将向您显示一个区域列表，然后是一个ami列表，每次都要求您选择一个。然后您的本地副本<a class="ae le" href="https://github.com/losDaniel/spot-connect/blob/master/spot_connect/profiles.txt" rel="noopener ugc nofollow" target="_blank"> profiles.txt </a>将被更新以使用该区域和AMI。</p><h1 id="5786" class="mw mx iq bd my mz nx nb nc nd ny nf ng kf nz kg ni ki oa kj nk kl ob km nm nn bi translated">笔记本使用案例</h1><p id="d050" class="pw-post-body-paragraph lf lg iq lh b li oc ka lk ll od kd ln lo oe lq lr ls of lu lv lw og ly lz ma ij bi translated">对于笔记本和脚本来说，<code class="fe ml mm mn mo b">SpotInstance</code>类相当于在命令提示符下使用<code class="fe ml mm mn mo b">spot_connect</code>。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="4ba3" class="ns mx iq mo b gy nt nu l nv nw">from spot_connect.spotted import SpotInstance<br/>instance = SpotInstance('instance1', profile='t2.micro', price=0.01)</span></pre><p id="af82" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">该命令创建或连接到“实例1”实例。一个<em class="mk"> SpotInstance </em>对象可以用与<code class="fe ml mm mn mo b">spot_connect</code> <strong class="lh ja">相同的参数进行实例化。此外，<em class="mk"> SpotInstance </em>还允许您指定配置文件参数，允许您覆盖像<code class="fe ml mm mn mo b">price</code>这样的配置文件中的任何默认设置，这将允许您直接提交自定义的最高出价。</strong></p><p id="530f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">使用<code class="fe ml mm mn mo b">SpotInstance</code>您可以下载和上传文件，</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="dced" class="ns mx iq mo b gy nt nu l nv nw">instance.upload('test_run.py') # script creates a test.txt file</span></pre><p id="52d4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">运行脚本，</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="dfc5" class="ns mx iq mo b gy nt nu l nv nw">instance.run('run_test.sh') # bash script is: "python test_run.py\n" </span></pre><p id="f782" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">直接在实例上运行命令，</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="5144" class="ns mx iq mo b gy nt nu l nv nw">instance.run('ls', cmd=True) # use the cmd option to pass commands</span></pre><p id="335f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">甚至终止实例。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="8b30" class="ns mx iq mo b gy nt nu l nv nw">instance.terminate()         # terminate the instance <br/>instance.refresh_instance()  # update the instance status </span></pre><p id="cd5e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">使用<code class="fe ml mm mn mo b">run(&lt;command&gt;, cmd=True)</code>方法直接在实例上运行命令。但是，请注意，这些命令总是在主目录中运行，这意味着在一次运行中更改目录并不意味着您在下一次运行中从该目录开始。</p><p id="2376" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">幸运的是，您可以使用<code class="fe ml mm mn mo b">\n</code>一起运行连续的命令</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="5aff" class="ns mx iq mo b gy nt nu l nv nw">instance.run('cd<strong class="mo ja">\n</strong>rm test.txt', cmd=True) </span></pre><p id="c498" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这可以很容易地将复杂的脚本存储为可以在python中直接使用的函数。例如:</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="b0b4" class="ns mx iq mo b gy nt nu l nv nw">def transfer_script(bucket, efs_path):<br/>    '''Download S3 data and place it in the EFS folder'''</span><span id="ee41" class="ns mx iq mo b gy ow nu l nv nw">    # The first command is the download<br/>    # Use "nohup" to run the job in the background of the instance<br/>    <br/>    script ='nohup aws s3 sync '+bucket+' '+efs_path+'<strong class="mo ja">\n</strong>'<br/>    <br/>    # Use "curpid=$!" to get the job-id for the sync job<br/>    <br/>    script +='curpid=$!<strong class="mo ja">\n</strong>'</span><span id="ae2d" class="ns mx iq mo b gy ow nu l nv nw">    # Three part command in linux <br/>    # 1) In the background, wait for all jobs to finish<br/>    # 2) when finished, run command to shutdown the instance, <br/>    # 3) place all the output from the sync job in transfer.txt<br/>    <br/>    script +="nohup sh -c 'while ps -p $0 &amp;&gt; /dev/null;<br/>              'do sleep 10; done &amp;&amp; sudo shutdown -h now' <br/>              $curpid &amp;&gt; transfer.txt &amp;<strong class="mo ja">\n</strong>" <br/>    <br/>    return script </span><span id="dc14" class="ns mx iq mo b gy ow nu l nv nw">script = transfer_script("s3://data", "/home/ec2-user/efs/")<br/>instance.run(command, cmd=True)</span></pre><h1 id="6308" class="mw mx iq bd my mz nx nb nc nd ny nf ng kf nz kg ni ki oa kj nk kl ob km nm nn bi translated">实例管理器</h1><p id="38a3" class="pw-post-body-paragraph lf lg iq lh b li oc ka lk ll od kd ln lo oe lq lr ls of lu lv lw og ly lz ma ij bi translated">启动一个实例很好，但是spot-connect的目标是便于在多个实例之间分配工作负载。这就是<code class="fe ml mm mn mo b">InstanceManager</code>类出现的原因。</p><p id="4191" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="mk">实例管理器</em>允许您一次启动并跟踪多个实例。它还提供了在实例和S3之间传输文件、运行分布式工作负载等功能。</p><p id="474c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">下面是如何跨多个实例组织执行任务的示例:</p><p id="c449" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 1。</span> <strong class="lh ja"> </strong>用<em class="mk"> </em> <code class="fe ml mm mn mo b">efs='data'</code>实例化一个<em class="mk">实例管理器</em>，这样管理器创建的实例自动链接到名为“数据”的EFS</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="7dbc" class="ns mx iq mo b gy nt nu l nv nw">from spot_connect.instance_manager import InstanceManager <br/>im = InstanceManager(efs='data')</span></pre><p id="2129" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 2。使用<code class="fe ml mm mn mo b">launch_instance</code>方法启动一个实例。用<code class="fe ml mm mn mo b">im</code>创建的实例可以在<code class="fe ml mm mn mo b">im.instances</code>中找到。</span></p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="2b95" class="ns mx iq mo b gy nt nu l nv nw">im.launch_instance('monitor', profile='t2.micro')</span></pre><p id="e850" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 3。</span>向<code class="fe ml mm mn mo b">clone_repo</code>方法提交“monitor”实例，以将项目的Github repo克隆到efs中。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="41a9" class="ns mx iq mo b gy nt nu l nv nw">im.clone_repo(im.instances['monitor'], <br/>   '<a class="ae le" href="https://github.com/FlorentF9/DeepTemporalClustering.git" rel="noopener ugc nofollow" target="_blank">https://github.com/FlorentF9/DeepTemporalClustering.git</a>',<br/>              directory='/home/ec2-user/efs/') # default path</span></pre><p id="2932" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 4。</span>运行<code class="fe ml mm mn mo b">cd efs</code>命令，然后运行<code class="fe ml mm mn mo b">mkdir results</code>命令，在EFS中创建一个结果文件夹。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="780e" class="ns mx iq mo b gy nt nu l nv nw">im.instances['monitor'].run('cd efs<strong class="mo ja">\n</strong>ls', cmd=True)</span></pre><p id="b11e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 5。设计一个方法，它可以接受每个作业的参数，并返回一个可以在每个实例上运行的脚本。</span></p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="d7f9" class="ns mx iq mo b gy nt nu l nv nw">def runDTC(n_clusters):<br/>   '''Train a DTC model on the package data with n_clusters'''</span><span id="3daa" class="ns mx iq mo b gy ow nu l nv nw">   # Change the directory to the project directory <br/>   script = 'cd /home/ec2-user/efs/DeepTemporalClustering/<strong class="mo ja">\n</strong>'</span><span id="413c" class="ns mx iq mo b gy ow nu l nv nw">   # Train the DTC algo in the background of the instance <br/>   script+= 'nohup python DeepTemporalClustering '+str(n_clusters)+' <strong class="mo ja">--savedir</strong> <strong class="mo ja">/home/ec2-user/efs/results\n</strong>'</span><span id="31e4" class="ns mx iq mo b gy ow nu l nv nw">   # Get the job ID for the training job <br/>   script +='curpid=$!<strong class="mo ja">\n</strong>'</span><span id="f143" class="ns mx iq mo b gy ow nu l nv nw">   # Shut down the instance once that job is done  <br/>   script +="nohup sh -c 'while ps -p $0 &amp;&gt; /dev/null; 'do sleep 10; done &amp;&amp; sudo shutdown -h now' $curpid &amp;&gt; transfer.txt &amp;<strong class="mo ja">\n</strong>"</span><span id="5cf2" class="ns mx iq mo b gy ow nu l nv nw">   return script </span></pre><p id="b19b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 6。</span>为一系列“n_cluster”值训练模型。使用<code class="fe ml mm mn mo b">run_distributed_jobs</code>方法在单独的实例上训练每个模型。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="e7ef" class="ns mx iq mo b gy nt nu l nv nw"># Get a list of scripts to run, one for each instance <br/>scripts = [runDTC(i) for i in range(10, 61, 10)]</span><span id="dd0f" class="ns mx iq mo b gy ow nu l nv nw">im.run_distributed_jobs(<br/>   "DTC",               # prefix given to each instance name <br/>   len(scripts),        # number of instances to launch <br/>   scripts,             # the scripts to run on each instance <br/>   'p2.xlarge'          # use this instance type for each instance <br/>)</span></pre><p id="46d4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 7。检查实例的状态，等待直到所有实例都终止(完成它们的作业)。</span></p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="c326" class="ns mx iq mo b gy nt nu l nv nw">In [7]: im.show_instances()<br/>Out[7]: {'monitor': 'running',  <br/>         'DTC_1': 'terminated',  <br/>         'DTC_2': 'terminated',  <br/>         'DTC_3': 'terminated',  <br/>         'DTC_4': 'shutting-down',  <br/>         'DTC_5': 'running',  <br/>         'DTC_6': 'running'}</span></pre><p id="a68f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi mb translated"><span class="l mc md me bm mf mg mh mi mj di"> 8。</span>使用<code class="fe ml mm mn mo b">instance_s3_transfer</code>方法将结果上传到S3。必须提供实例配置文件才能让实例访问S3。</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="e801" class="ns mx iq mo b gy nt nu l nv nw">im.instance_s3_transfer("/home/ec2-user/efs/results",<br/>                        "s3://bucket_data", <br/>                        "s3access")   # my instance profile</span></pre><p id="cdf9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在S3，您可以直接通过控制台或使用命令提示符下的<code class="fe ml mm mn mo b">awscli</code>下载结果:</p><pre class="kp kq kr ks gt no mo np nq aw nr bi"><span id="1c59" class="ns mx iq mo b gy nt nu l nv nw">aws s3 sync "s3://bucket_data/results" "&lt;local folder&gt;"</span></pre></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="b897" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在结束本节之前，有必要介绍一些有用的bash命令:</p><ul class=""><li id="36eb" class="oi oj iq lh b li lj ll lm lo ok ls ol lw om ma on oo op oq bi translated"><code class="fe ml mm mn mo b">nohup</code>:当放在命令的开头时，即使用户退出，命令也会完成。</li><li id="b639" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><code class="fe ml mm mn mo b">&amp;</code>:当放置在您的命令之后时，会将命令发送到后台，以便您可以继续使用提示。</li><li id="49a1" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated"><code class="fe ml mm mn mo b">&gt; something.txt</code>:在命令的末尾，将命令生成的任何输出指向所需的文本。在<code class="fe ml mm mn mo b">.txt</code>后添加另一个<code class="fe ml mm mn mo b">&amp;</code>来隐藏整行并继续使用提示。</li></ul><h1 id="4e26" class="mw mx iq bd my mz nx nb nc nd ny nf ng kf nz kg ni ki oa kj nk kl ob km nm nn bi translated">总结</h1><p id="dcef" class="pw-post-body-paragraph lf lg iq lh b li oc ka lk ll od kd ln lo oe lq lr ls of lu lv lw og ly lz ma ij bi translated">这就是spot-connect模块的基本功能。这里是这个项目的<a class="ae le" href="https://github.com/losDaniel/spot-connect.git" rel="noopener ugc nofollow" target="_blank"> Github回购</a>，在这里你可以找到一个<a class="ae le" href="https://github.com/losDaniel/spot-connect/blob/master/spot_connect_walkthrough.ipynb" rel="noopener ugc nofollow" target="_blank">走查笔记本</a>(仍然需要更新以包括本文中的DTC示例)以及我用来从AWS 收集价格和图像数据的<a class="ae le" href="https://github.com/losDaniel/spot-connect/blob/master/amazon_price_and_image_scraper.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本。</a></p><p id="56c7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我根据自己的时间表开发模块，但是本文中介绍的基本功能对我来说只是暂时的停止。非常欢迎投稿。以下是我认为值得追求的特性:</p><ul class=""><li id="55df" class="oi oj iq lh b li lj ll lm lo ok ls ol lw om ma on oo op oq bi translated">2分钟关机警告处理</li><li id="34c4" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated">使用boto3的AWS spot-fleet功能</li><li id="0c38" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated">扩展存储管理功能(S3、EFS、EBS)</li><li id="05aa" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated">提供运行和协调数据同步代理的能力</li><li id="d386" class="oi oj iq lh b li or ll os lo ot ls ou lw ov ma on oo op oq bi translated">提高代码的整体优雅性</li></ul><p id="42f2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">感谢阅读！</p><p id="3fe3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi">:)</p></div></div>    
</body>
</html>