<html>
<head>
<title>Using attention for medical image segmentation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用注意力进行医学图像分割</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-attention-for-medical-image-segmentation-dd78825eaac6?source=collection_archive---------12-----------------------#2020-05-05">https://towardsdatascience.com/using-attention-for-medical-image-segmentation-dd78825eaac6?source=collection_archive---------12-----------------------#2020-05-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a832" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">探索最近两篇关于使用注意力进行分割的论文，获得一些直觉和一个简短的PyTorch实现。</h2></div><p id="4b7a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意力机制是过去几年深度学习研究的最热门领域之一，始于自然语言处理，最近出现在计算机视觉任务中。在本文中，我们将重点关注注意力如何影响最新的医学图像分割架构。为此，我们将<strong class="kk iu">描述最近两篇论文中提出的架构</strong>，并尝试给出一些关于发生了什么的<strong class="kk iu">直觉</strong>，希望它能给你一些如何将注意力应用到你自己的问题上的想法。我们还将看到<strong class="kk iu">简单的PyTorch实现</strong>。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/20eb446abb6f0f5315e5aac8cde8e8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ESOwtVsh3zaPOgefcrZunA.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">彼得·卡斯普日克在<a class="ae lu" href="https://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="fb43" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">医学图像的分割在两个要点上不同于自然图像:</p><ul class=""><li id="9e92" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld ma mb mc md bi translated">大多数医学图像非常相似，因为它们是在标准化的环境中拍摄的，这意味着在方向、图像中的位置、像素范围等方面几乎没有变化</li><li id="57f9" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">例如当试图分割肿瘤时，在阳性类像素(或体素)和阴性类之间经常存在很大的不平衡</li></ul><p id="97aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:当然，代码和解释都是对论文中描述的复杂体系结构的简化，目的主要是给出一个直觉和一个好主意，而不是解释每一个细节。</p><h1 id="7aa9" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">1.请注意UNet</h1><p id="cdf7" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">UNet是细分领域的首选架构，目前大多数细分领域的进展都以此架构为基础。在本文中，作者提出了一种将注意力机制应用于标准UNet的方法。如果你想重温一下标准的UNet是如何工作的，<a class="ae lu" rel="noopener" target="_blank" href="/u-net-b229b32b4a71">这篇文章</a>非常适合。</p><h2 id="3654" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">1.1.提议的是什么</h2><p id="3190" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">该架构使用标准的UNet作为主干，并且不改变收缩路径。改变的是扩展路径，更准确的说，是注意机制被整合到了跳过连接中。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ns"><img src="../Images/bae4ba916408e95c1f27bd51891d30d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WR61Dp4KSShPuNCoZHprcA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">注意事项UNet的框图，红色为扩展路径块。来源:<a class="ae lu" href="https://arxiv.org/pdf/1804.03999.pdf" rel="noopener ugc nofollow" target="_blank">注意UNet:学习在哪里寻找胰腺</a></p></figure><p id="5a5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了解释扩展路径的一个块如何工作，让我们把来自前一个块的对这个块的输入称为<em class="nt"> g </em>，把来自扩展路径的跳过连接称为<em class="nt"> x </em>。下面的等式总结了这个模块的工作原理。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nu"><img src="../Images/d0586a56eb9d66e22bace576e7183663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SyAWIwXLGOYxtgzf2OziIA.png"/></div></div></figure><p id="d613" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上采样模块非常简单，而conv模块只是两个(卷积+批处理范数+ ReLU)模块的序列。剩下唯一需要解释的是注意力障碍。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nv"><img src="../Images/3dd6db563d3e98531a2f91bdc456f245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q1aMxFm1L6KJeia5wCmC5A.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">注意模块的框图。这里的尺寸假定一个三维输入图像。来源:<a class="ae lu" href="https://arxiv.org/pdf/1804.03999.pdf" rel="noopener ugc nofollow" target="_blank">关注UNet:学习去哪里寻找胰腺</a></p></figure><ul class=""><li id="1e2e" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld ma mb mc md bi translated"><em class="nt"> x </em>和<em class="nt"> g </em>都被送入1x1卷积，使它们达到相同数量的通道，而不改变大小</li><li id="449d" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">在一个上采样操作之后(为了具有相同的大小)，它们被相加并通过一个ReLU</li><li id="8995" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">另一个1x1卷积和一个sigmoid，展平为一个通道，对地图的每个部分给予0到1的重要性分数</li><li id="98da" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">然后，该注意图乘以跳过输入，以产生该注意块的最终输出</li></ul><h2 id="01bc" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">1.2.为什么有效</h2><p id="45fb" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">在UNet中，收缩路径可以被视为编码器，扩展路径可以被视为解码器。UNet的有趣之处在于，跳过连接允许在解码器中直接使用编码器提取的特征。这样，当“重建”图像的掩模时，网络学会使用这些特征，因为收缩路径的特征与扩展路径的特征连接在一起。</p><p id="ed19" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种连接之前应用注意块允许网络将更多的权重放在相关的跳过连接的特征上。它允许直接连接集中于输入的特定部分，而不是馈入每个特征。</p><p id="2ade" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意力分布乘以跳过连接特征图，只保留重要部分。这种注意力分布是从所谓的查询(输入)和值(跳过连接)中提取的。注意操作允许有选择地挑选包含在值中的信息。该选择基于查询。</p><p id="9c16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总结一下:输入和跳过连接用于决定关注跳过连接的哪些部分。然后，我们使用跳过连接的这个子集，以及标准扩展路径中的输入。</p><h2 id="db3e" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">1.3.简短实现</h2><p id="b5bb" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">以下代码定义了(简化版本的)注意块和用于UNet扩展路径的“上行块”。“下行模块”与原始的UNet没有变化。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">使用注意时，注意块和UNet的扩展路径块的简短实现。</p></figure><p id="c3f8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:ConvBatchNorm是Conv2d、BatchNorm2d和ReLU激活函数的序列。</p><h1 id="ff92" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">2.多尺度引导注意</h1><p id="2488" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">我们将要讨论的第二种架构比第一种更有创意。它不依赖于UNet架构，而是依赖于引导注意块之后的特征提取。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ny"><img src="../Images/d921a144696aeda4ab4d44542b86d4c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oqI02keeFy-goOMzr2VA2g.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">建议解决方案的框图。来源:<a class="ae lu" href="https://arxiv.org/pdf/1906.02849.pdf" rel="noopener ugc nofollow" target="_blank">医学图像分割的多尺度自引导注意</a></p></figure><p id="f1ea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一部分是从图像中提取特征。为此，输入图像被馈送到预训练的ResNet，并且我们在4个不同的级别提取特征图。这很有意思，因为低级特征往往出现在网络的起点，高级特征出现在网络的终点，所以我们可以访问多个尺度的特征。使用<a class="ae lu" href="https://en.wikipedia.org/wiki/Bilinear_interpolation" rel="noopener ugc nofollow" target="_blank">双线性插值</a>，所有的特征地图都被上采样到最大的地图的尺寸。这给了我们4个相同大小的特征图，它们被连接并馈入一个卷积块。这个卷积块(多尺度特征图)的输出与4个特征图中的每一个连接在一起，为我们提供关注块的输入，这比前面的要复杂一些。</p><h2 id="f117" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">2.1.提议的是什么</h2><p id="3542" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">引导注意力模块依赖于位置和通道注意力模块，我们将从描述它们开始。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nz"><img src="../Images/fc1333eebdae0928da76b590bcf5ced9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqzDJJOsPUrTuD7tVlXnUw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">位置和通道注意模块框图。来源:<a class="ae lu" href="https://arxiv.org/pdf/1906.02849.pdf" rel="noopener ugc nofollow" target="_blank">医学图像分割的多尺度自引导注意</a></p></figure><p id="3b31" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将尝试理解这些模块中发生了什么，但我们不会对这两个块中的每个操作进行太多的详细描述(这可以通过下面的代码部分来理解)。</p><p id="cd00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这两个块实际上非常相似，它们之间的唯一区别在于试图从信道或位置提取信息的操作。在展平之前应用卷积会使位置更加重要，因为在卷积过程中通道的数量会减少。在通道注意模块中，由于在整形操作期间保持了通道的原始数量，因此通道的权重更大。</p><p id="6952" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在每个区块中，重要的是要注意到顶部的两个分支负责提取特定的注意力分布。例如，在位置注意力模块中，我们有一个(W*H)x(W*H)注意力分布，其中<em class="nt"> (i，j) </em>元素告诉我们位置<em class="nt"> i </em>对位置<em class="nt"> j </em>的影响有多大。在通道模块中，我们有一个CxC注意力分布，它告诉我们一个通道对另一个通道的影响程度。在每个模块的第三分支中，该特定注意力分布乘以输入的变换，以获得通道或位置注意力分布。与上一篇文章一样，在给定多尺度特征上下文的情况下，注意力分布然后乘以输入，以提取输入的相关信息。然后将这两个模块的输出逐元素求和，以给出最终的自我关注特征。现在让我们看看这两个模块的输出是如何在全局框架中使用的。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oa"><img src="../Images/a9d5ef91afd2030a5a47e3ecde7a1836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FyZIqeEBIMBeBqHG5SNrPg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">具有2个改进步骤的引导注意力模块的框图。来源:<a class="ae lu" href="https://arxiv.org/pdf/1906.02849.pdf" rel="noopener ugc nofollow" target="_blank">医学图像分割的多尺度自引导注意</a></p></figure><p id="3a70" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">引导注意力是通过对每个尺度(在建议的架构中为4个尺度)的一系列多个细化步骤来构建的。输入特征图被馈送到位置和通道输出模块，该模块输出单个特征图。它还通过自动编码器，自动编码器产生输入的重构版本。在每个模块中，注意力图由这两个输出相乘产生。该注意力图然后乘以先前产生的多尺度特征图。因此，考虑到我们工作的具体尺度，输出代表了我们应该关注多尺度的哪些部分。然后，通过将一个模块的输出与多尺度注意力地图连接起来，并将其作为下一个模块的输入，就可以得到一系列这样的引导注意力模块。</p><p id="980f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里有两个额外的损耗是必要的，以确保优化步骤正确工作:</p><ul class=""><li id="345a" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld ma mb mc md bi translated">确保自动编码器正确重建输入特征图的标准重建损失</li><li id="57d3" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">一种引导损失，它试图最小化输入的两个后续潜在表示之间的距离</li></ul><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ob"><img src="../Images/6ec4d3411820ebf4ea1eff127c0a369f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xppp2ZPZ1PYxOP1mqFHmgQ.png"/></div></div></figure><p id="52cc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，每个注意力特征通过卷积块来预测掩模。为了产生最终的预测，取四个掩模的平均值，这可以看作是各种尺度特征的模型的一种集合。</p><h2 id="0d22" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">2.2.为什么有效</h2><p id="df2b" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">由于这个架构比前一个要复杂得多，所以很难理解注意力模块背后发生了什么。以下是我对各种模块的贡献的理解。</p><p id="c9f0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">位置注意模块试图基于输入图像的多尺度表示来指定关注特定尺度特征的哪个位置。频道关注模块通过指定对哪个频道关注多少来做同样的事情。在任一个块中使用的特定操作在注意力分布中给予通道或位置信息更大的重要性。组合这两个模块给出了注意力图，该注意力图给出了每个位置-通道对的分数，即特征图的每个元素。</p><p id="43cf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">自动编码器用于确保特征图的潜在表示不会从一个步骤到另一个步骤完全改变。由于潜在空间是低维的，所以只提取关键信息。我们不希望这些信息从一个细化步骤改变到下一个，我们只希望进行小的调整。这些不会在潜在表象中被看到。</p><p id="5592" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">引导注意力模块序列的使用允许最终注意力图被细化，并且逐渐使噪声消失，并且给予真正重要的区域更多的权重。</p><p id="3dd7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将几个这样的网络以多种尺度组合起来，可以使网络具有全局和局部特征的视野。然后将这些要素组合成多比例要素地图。关注多比例要素地图和每个特定比例有助于更好地了解哪些要素会给最终输出带来更多价值。</p><h2 id="dda4" class="ng mk it bd ml nh ni dn mp nj nk dp mt kr nl nm mv kv nn no mx kz np nq mz nr bi translated">2.3.简短实现</h2><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">位置注意模块、通道注意模块和一个引导注意块的简短实现。</p></figure><h1 id="8202" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">外卖食品</h1><p id="60a1" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">那么，从这些文章中可以学到什么呢？注意力可以被视为一种机制，它有助于根据上下文向网络指出哪些提取的特征需要关注。</p><p id="8480" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在UNet中，这意味着，给定在扩展路径期间提取的特征，我们应该更加关注在收缩路径期间提取的哪些特征。这有助于使跳过连接更有意义，即传递相关信息而不是每个提取的特征。在第二篇文章中，给定我们正在工作的当前尺度，我们应该关注哪些多尺度特征。</p><p id="ffb5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一般的想法可以应用于广泛的问题，我认为看到多个例子可以帮助更好地理解注意力是如何适应的。</p><h1 id="8433" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">参考</h1><p id="694a" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">[1] O. Oktay等人《关注UNet:学习去哪里寻找胰腺》(2018) <br/> [2] A. Sinha和J. Dolz。“用于医学图像分割的多尺度自引导注意”(2020)</p></div></div>    
</body>
</html>