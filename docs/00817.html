<html>
<head>
<title>How to Insert Records and Do Conditional Delete for DynamoDB Using Python and Boto3 Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Python 和 Boto3 库为 DynamoDB 插入记录和进行条件删除</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-insert-records-and-do-conditional-delete-for-dynamodb-using-python-and-boto3-library-3303f74c18b9?source=collection_archive---------11-----------------------#2020-01-23">https://towardsdatascience.com/how-to-insert-records-and-do-conditional-delete-for-dynamodb-using-python-and-boto3-library-3303f74c18b9?source=collection_archive---------11-----------------------#2020-01-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="177c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个教程，展示了如何使用 Python 和 Boto3 库以编程方式插入多条记录并按条件删除项目</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d64c4ec1a6f194b1d5a11ff3fbc88873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*REuQyotIyO7PbAoq"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">丹尼尔·冯·阿彭在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="c11b" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="d2f4" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">出于测试目的，我们的 DynamoDB 表中有许多垃圾或虚假记录是很常见的。它可能是我们正在开发的一个应用程序，甚至只是一个功能。它也可以是我们现有的应用程序生成的一些记录，但实际上，它们没有值。不管它是什么，我们最终都会在数据库中创建许多记录。</p><p id="94de" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我们时常想要清理数据库表，因此只存储有价值和有意义的记录。例如，我们做了一个负载测试来测试应用程序中的用户帐户创建 API。这显然导致了表中的许多记录，这些记录只是“测试”记录。所有这些“测试”记录都具有邮件以<code class="fe mz na nb nc b">testing</code>开头，姓氏以<code class="fe mz na nb nc b">TEST</code>开头的特征。你知道，不管怎样。😆显然，一旦我们完成了负载测试，这些记录就可以从表中删除。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="b9f0" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">你会学到什么</h1><p id="1313" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在本教程中，您将学习如何使用 Python 从 DynamoDB 表中插入项目和有条件地删除项目，无论出于什么原因，您都不想再保留这些项目。我们将使用 Python 的官方 AWS SDK 库，它被称为<code class="fe mz na nb nc b">Boto3</code>。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="68bb" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">先决条件</h1><h2 id="3989" class="nd lh it bd li ne nf dn lm ng nh dp lq mh ni nj ls ml nk nl lu mp nm nn lw no bi translated">设置虚拟环境</h2><p id="11bc" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我不打算做详细的演练，但会通过<code class="fe mz na nb nc b">virtualenv</code>快速展示给你如何做。</p><p id="1058" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">首先，你需要通过<code class="fe mz na nb nc b">pip3</code>安装<code class="fe mz na nb nc b">virtualenv</code>，如果你还没有安装的话。这很简单，因为:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="cfff" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo &gt; pip3 install virtualenv</span></pre><p id="ab14" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">然后，创建一个目录来存放项目文件(或者在本例中是 Python 脚本)。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="89dc" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo &gt; mkdir batch-ops-dynamodb</span></pre><p id="efe2" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">转到目录并在那里创建虚拟环境。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="a2b9" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo &gt; cd ./batch-ops-dynamodb</span><span id="42dd" class="nd lh it nc b gy nx nu l nv nw">$ ~/demo/batch-ops-dynamodb &gt; virtualenv ./venv</span><span id="a52e" class="nd lh it nc b gy nx nu l nv nw">Using base prefix '/Library/Frameworks/Python.framework/Versions/3.8'<br/>New python executable in /Users/billyde/demo/batch-ops-dynamodb/venv/bin/python3.8<br/>Also creating executable in /Users/billyde/demo/batch-ops-dynamodb/venv/bin/python<br/>Installing setuptools, pip, wheel...<br/>done.</span></pre><p id="d2e7" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">最后，我们希望激活虚拟环境。快速提醒一下，虚拟环境非常有用，因为它将您的开发与机器的其他部分隔离开来。可以将它想象成一个容器，其中所有的依赖项都在虚拟环境中提供，并且只能从环境中访问。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="19e9" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo/batch-ops-dynamodb &gt; source ./venv/bin/activate</span><span id="a3bf" class="nd lh it nc b gy nx nu l nv nw">$ ~/demo/batch-ops-dynamodb (venv) &gt;</span></pre><p id="8e27" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">注意<code class="fe mz na nb nc b">(venv)</code>。这表明您处于虚拟环境中。但是，根据终端的设置，您可能看不到这一点。因此，作为一种替代方法，这就是为什么您可以验证您的虚拟环境是否处于活动状态。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="0232" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo/batch-ops-dynamodb (venv) &gt; which python<br/>/Users/billyde/demo/batch-ops-dynamodb/venv/bin/python</span><span id="c4f4" class="nd lh it nc b gy nx nu l nv nw">$ ~/demo/batch-ops-dynamodb (venv) &gt; which pip<br/>/Users/billyde/demo/batch-ops-dynamodb/venv/bin/pip</span></pre><p id="b008" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">您可以看到 Python 和 pip 可执行文件来自我们的虚拟环境。一切都好。🙂</p><h2 id="cff1" class="nd lh it bd li ne nf dn lm ng nh dp lq mh ni nj ls ml nk nl lu mp nm nn lw no bi translated">安装依赖项</h2><p id="d273" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">本教程唯一的依赖项是<code class="fe mz na nb nc b">Boto3</code>库。因此，让我们继续在我们的虚拟环境中安装它。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="af87" class="nd lh it nc b gy nt nu l nv nw">$ ~/demo/batch-ops-dynamodb (venv) &gt; pip install boto3</span><span id="6255" class="nd lh it nc b gy nx nu l nv nw">Collecting boto3<br/>  Downloading boto3-1.11.7-py2.py3-none-any.whl (128 kB)<br/>     |████████████████████████████████| 128 kB 1.0 MB/s<br/>Collecting botocore&lt;1.15.0,&gt;=1.14.7<br/>  Downloading botocore-1.14.7-py2.py3-none-any.whl (5.9 MB)<br/>     |████████████████████████████████| 5.9 MB 462 kB/s<br/>Collecting s3transfer&lt;0.4.0,&gt;=0.3.0<br/>  Downloading s3transfer-0.3.1-py2.py3-none-any.whl (69 kB)<br/>     |████████████████████████████████| 69 kB 2.1 MB/s<br/>Collecting jmespath&lt;1.0.0,&gt;=0.7.1<br/>  Using cached jmespath-0.9.4-py2.py3-none-any.whl (24 kB)<br/>Collecting urllib3&lt;1.26,&gt;=1.20<br/>  Downloading urllib3-1.25.8-py2.py3-none-any.whl (125 kB)<br/>     |████████████████████████████████| 125 kB 5.3 MB/s<br/>Collecting python-dateutil&lt;3.0.0,&gt;=2.1<br/>  Using cached python_dateutil-2.8.1-py2.py3-none-any.whl (227 kB)<br/>Collecting docutils&lt;0.16,&gt;=0.10<br/>  Using cached docutils-0.15.2-py3-none-any.whl (547 kB)<br/>Collecting six&gt;=1.5<br/>  Downloading six-1.14.0-py2.py3-none-any.whl (10 kB)<br/>Installing collected packages: urllib3, six, python-dateutil, docutils, jmespath, botocore, s3transfer, boto3<br/>Successfully installed boto3-1.11.7 botocore-1.14.7 docutils-0.15.2 jmespath-0.9.4 python-dateutil-2.8.1 s3transfer-0.3.1 six-1.14.0 urllib3-1.25.8</span></pre><p id="a786" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">一旦您完成了先决条件，我们就可以开始做有趣的事情了，那就是编写实际的脚本来批量删除我们的垃圾记录。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="613c" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">启动本地 DynamoDB 实例</h1><p id="d6a9" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">为了帮助我们了解脚本是如何工作的，我们将在 Docker 容器中启动一个本地 DynamoDB 实例。你可以按照这个<a class="ae ky" href="https://medium.com/better-programming/how-to-set-up-a-local-dynamodb-in-a-docker-container-and-perform-the-basic-putitem-getitem-38958237b968" rel="noopener">教程</a>来实现这个。</p><p id="13dc" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">本质上，你需要做的是启动 DynamoDB Docker 并创建教程中写的表<code class="fe mz na nb nc b">demo-customer-info</code>。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="f483" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">在表中创建虚拟记录</h1><p id="0053" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">让我们创建虚拟记录，这样我们可以看到批处理操作是如何工作的。为此，我们将编写一个 Python 脚本，在一个循环中调用 DynamoDB <code class="fe mz na nb nc b">PutItem</code>操作。在<code class="fe mz na nb nc b">batch-ops-dynamo</code>中新建一个 Python 文件，命名为<code class="fe mz na nb nc b">insert_dummy_records.py</code>。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="23f3" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ touch insert_dummy_records.py</span></pre><p id="99ea" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">正如前面介绍部分提到的，我们的虚拟记录将具有以下特征:</p><ul class=""><li id="d9db" class="ny nz it ma b mb mu me mv mh oa ml ob mp oc mt od oe of og bi translated">姓氏以<code class="fe mz na nb nc b">TEST</code>开头</li><li id="84b0" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated">电子邮件地址以<code class="fe mz na nb nc b">testing</code>开头</li></ul><p id="89af" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我们的脚本将包含以下组件:</p><ul class=""><li id="8f2c" class="ny nz it ma b mb mu me mv mh oa ml ob mp oc mt od oe of og bi translated"><code class="fe mz na nb nc b">insert_dummy_record</code>:执行<code class="fe mz na nb nc b">PutItem</code>操作的功能</li><li id="bdc0" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated"><code class="fe mz na nb nc b">for loop</code>:将调用<code class="fe mz na nb nc b">insert_dummy_record</code>函数 10 次以插入虚拟记录的循环。</li></ul><p id="7d1e" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我们还利用<code class="fe mz na nb nc b">random.randint</code>方法生成一些随机整数，添加到我们的虚拟记录的属性中，它们是:</p><ul class=""><li id="a180" class="ny nz it ma b mb mu me mv mh oa ml ob mp oc mt od oe of og bi translated"><code class="fe mz na nb nc b">customerId</code></li><li id="3cf0" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated"><code class="fe mz na nb nc b">lastName</code></li><li id="c1d7" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated"><code class="fe mz na nb nc b">emailAddress</code></li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">insert _ dummy _ records.py 将虚拟记录插入到表中</p></figure><p id="ac00" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我们的剧本看起来不错！现在，是时候从命令行运行它了，使用来自我们虚拟环境的 Python 可执行文件。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="98c6" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ python3 insert_dummy_records.py</span><span id="9afd" class="nd lh it nc b gy nx nu l nv nw">Inserting record number 1 with customerId 769<br/>Inserting record number 2 with customerId 885<br/>Inserting record number 3 with customerId 873<br/>Inserting record number 4 with customerId 827<br/>Inserting record number 5 with customerId 231<br/>Inserting record number 6 with customerId 199<br/>Inserting record number 7 with customerId 272<br/>Inserting record number 8 with customerId 268<br/>Inserting record number 9 with customerId 729<br/>Inserting record number 10 with customerId 289</span></pre><p id="6dc8" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">好的。这个脚本看起来像预期的那样工作。万岁！😄</p><p id="96b0" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们通过调用本地 DynamoDB <code class="fe mz na nb nc b">demo-customer-info</code>表上的<code class="fe mz na nb nc b">scan</code>操作来检查记录。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="a111" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ aws dynamodb scan --endpoint-url <a class="ae ky" href="http://localhost:8042" rel="noopener ugc nofollow" target="_blank">http://localhost:8042</a> --table-name demo-customer-info</span><span id="d738" class="nd lh it nc b gy nx nu l nv nw">{<br/>    "Items": [<br/>        {<br/>            "customerId": {<br/>                "S": "199"<br/>            },<br/>            "lastName": {<br/>                "S": "TEST199"<br/>            },<br/>            "emailAddress": {<br/>                "S": "<a class="ae ky" href="mailto:testing199@dummy.com" rel="noopener ugc nofollow" target="_blank">testing199@dummy.com</a>"<br/>            }<br/>        },<br/>        {<br/>            "customerId": {<br/>                "S": "769"<br/>            },<br/>            "lastName": {<br/>                "S": "TEST769"<br/>            },<br/>            "emailAddress": {<br/>                "S": "<a class="ae ky" href="mailto:testing769@dummy.com" rel="noopener ugc nofollow" target="_blank">testing769@dummy.com</a>"<br/>            }<br/>        },<br/>... truncated<br/>... truncated<br/>... truncated<br/>        {<br/>            "customerId": {<br/>                "S": "827"<br/>            },<br/>            "lastName": {<br/>                "S": "TEST827"<br/>            },<br/>            "emailAddress": {<br/>                "S": "<a class="ae ky" href="mailto:testing827@dummy.com" rel="noopener ugc nofollow" target="_blank">testing827@dummy.com</a>"<br/>            }<br/>        }<br/>    ],<br/>    "Count": 10,<br/>    "ScannedCount": 10,<br/>    "ConsumedCapacity": null<br/>}</span></pre><p id="96a8" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">完美！我们的表中现在有一些虚拟记录。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="33f2" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">将“真实”记录插入表中</h1><p id="8bf6" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将快速向表中插入两条“真实”的记录。为此，我们将编写另一个 Python 脚本，它将命令行参数作为输入。我们把这个文件命名为<code class="fe mz na nb nc b">insert_real_record.py</code>。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="5727" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ touch insert_real_record.py</span></pre><p id="2cbf" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">该文件的内容如下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">insert _ real _ record.py 将“真实”记录插入到表中</p></figure><p id="6fda" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们继续向表中插入 2 条记录。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="60c4" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ python insert_real_record.py 11111 jones <a class="ae ky" href="mailto:sam.jones@something.com" rel="noopener ugc nofollow" target="_blank">sam.jones@something.com</a></span><span id="cc83" class="nd lh it nc b gy nx nu l nv nw">Inserting record with customerId 11111</span><span id="7be9" class="nd lh it nc b gy nx nu l nv nw">~/demo/batch-ops-dynamodb ❯ python insert_real_record.py 22222 smith <a class="ae ky" href="mailto:jack.smith@somedomain.com" rel="noopener ugc nofollow" target="_blank">jack.smith@somedomain.com</a></span><span id="dff1" class="nd lh it nc b gy nx nu l nv nw">Inserting record with customerId 22222</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="6d1e" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">编写根据条件删除记录的脚本</h1><p id="d1c2" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">最后，我们将编写脚本，从表中删除满足某些指定条件的记录。</p><p id="7d68" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">再次提醒，我们要删除我们插入的虚拟记录。我们需要应用的过滤器是姓氏以<code class="fe mz na nb nc b">TEST</code>开头，电子邮件地址以<code class="fe mz na nb nc b">testing</code>开头。</p><p id="8074" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">脚本的工作原理:</p><ul class=""><li id="0d56" class="ny nz it ma b mb mu me mv mh oa ml ob mp oc mt od oe of og bi translated">用给定的过滤表达式在表上执行<code class="fe mz na nb nc b">scan</code>操作</li><li id="fdd7" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated">只从所有记录中检索符合我们的过滤表达式的<code class="fe mz na nb nc b">customerId</code>属性，因为这是我们做<code class="fe mz na nb nc b">DeleteItem</code>操作所需要的。记住，<code class="fe mz na nb nc b">customerId</code>是表的分区键。</li><li id="6a49" class="ny nz it ma b mb oh me oi mh oj ml ok mp ol mt od oe of og bi translated">在<code class="fe mz na nb nc b">for loop</code>中，对于我们<code class="fe mz na nb nc b">scan</code>操作返回的每个<code class="fe mz na nb nc b">customerId</code>，进行<code class="fe mz na nb nc b">DeleteItem</code>操作。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Delete _ records _ conditionally . py-按过滤器删除记录</p></figure><p id="0832" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">继续从命令行运行这个脚本。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="e935" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ python delete_records_conditionally.py</span><span id="e234" class="nd lh it nc b gy nx nu l nv nw">Getting customer ids to delete<br/>============<br/>['199', '769', '873', '268', '289', '231', '272', '885', '729', '827']<br/>Deleting customer 199<br/>Deleting customer 769<br/>Deleting customer 873<br/>Deleting customer 268<br/>Deleting customer 289<br/>Deleting customer 231<br/>Deleting customer 272<br/>Deleting customer 885<br/>Deleting customer 729<br/>Deleting customer 827</span></pre><p id="2ed1" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">太好了！该脚本按预期工作。现在，让我们检查表中剩余的记录。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="2b59" class="nd lh it nc b gy nt nu l nv nw">~/demo/batch-ops-dynamodb ❯ aws dynamodb scan --endpoint-url <a class="ae ky" href="http://localhost:8042" rel="noopener ugc nofollow" target="_blank">http://localhost:8042</a> --table-name demo-customer-info</span><span id="ead2" class="nd lh it nc b gy nx nu l nv nw">{<br/>    "Items": [<br/>        {<br/>            "customerId": {<br/>                "S": "22222"<br/>            },<br/>            "lastName": {<br/>                "S": "smith"<br/>            },<br/>            "emailAddress": {<br/>                "S": "<a class="ae ky" href="mailto:jack.smith@somedomain.com" rel="noopener ugc nofollow" target="_blank">jack.smith@somedomain.com</a>"<br/>            }<br/>        },<br/>        {<br/>            "customerId": {<br/>                "S": "11111"<br/>            },<br/>            "lastName": {<br/>                "S": "jones"<br/>            },<br/>            "emailAddress": {<br/>                "S": "<a class="ae ky" href="mailto:sam.jones@something.com" rel="noopener ugc nofollow" target="_blank">sam.jones@something.com</a>"<br/>            }<br/>        }<br/>    ],<br/>    "Count": 2,<br/>    "ScannedCount": 2,<br/>    "ConsumedCapacity": null<br/>}</span></pre><p id="c439" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">只剩下 2 条记录，这是我们插入的“真实”记录。我们现在可以确定我们的<code class="fe mz na nb nc b">delete_records_conditionally.py</code>脚本做了它想要做的事情。</p><p id="9ac1" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">很棒的东西。👍</p><h2 id="d5f5" class="nd lh it bd li ne nf dn lm ng nh dp lq mh ni nj ls ml nk nl lu mp nm nn lw no bi translated">删除脚本的一些细节</h2><p id="8323" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">让我们来看看我们刚刚编写的<code class="fe mz na nb nc b">delete_records_conditionally.py</code>脚本中的一些内容。</p><p id="d0df" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">注意，我们有一个<code class="fe mz na nb nc b">deserializer</code>，我们用它来获取<code class="fe mz na nb nc b">customerId</code>。原因是因为，<code class="fe mz na nb nc b">scan</code>操作实际上会返回这样的结果。</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="53c2" class="nd lh it nc b gy nt nu l nv nw"># scan operation response</span><span id="5a53" class="nd lh it nc b gy nx nu l nv nw">{'Items': [{'customerId': {'S': '300'}}, {'customerId': {'S': '794'}}, {'customerId': {'S': '266'}}, {'customerId': {'S': '281'}}, {'customerId': {'S': '223'}}, {'customerId': {'S': '660'}}, {'customerId': {'S': '384'}}, {'customerId': {'S': '673'}}, {'customerId': {'S': '378'}}, {'customerId': {'S': '426'}}], 'Count': 10, 'ScannedCount': 12, 'ResponseMetadata': {'RequestId': 'eb18e221-d825-4f28-b142-ff616d0ca323', 'HTTPStatusCode': 200, 'HTTPHeaders': {'content-type': 'application/x-amz-json-1.0', 'x-amz-crc32': '2155737492', 'x-amzn-requestid': 'eb18e221-d825-4f28-b142-ff616d0ca323', 'content-length': '310', 'server': 'Jetty(8.1.12.v20130726)'}, 'RetryAttempts': 0}}</span></pre><p id="3a32" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">由于我们只对<code class="fe mz na nb nc b">customerId</code>的值感兴趣，我们需要使用 Boto3 库提供的<code class="fe mz na nb nc b">TypeDeserializer</code>去序列化 DynamoDB 项。</p><p id="e66a" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">另一个值得一提的组件是<code class="fe mz na nb nc b">Select</code>和<code class="fe mz na nb nc b">ProjectionExpression</code>，它们是<code class="fe mz na nb nc b">scan</code>函数的参数。这两个参数密切相关。我们将<code class="fe mz na nb nc b">Select</code>的值设置为<code class="fe mz na nb nc b">SPECIFIC_ATTRIBUTES</code>，根据 Boto3 官方文档，这将只返回<code class="fe mz na nb nc b">AttributesToGet</code>中列出的属性。<code class="fe mz na nb nc b">AttributesToGet</code>已被标记为遗留参数，AWS 建议我们改用<code class="fe mz na nb nc b">ProjectionExpression</code>。</p><p id="e7e0" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">来自 Boto3 官方文档:</p><blockquote class="oo op oq"><p id="dc2d" class="ly lz or ma b mb mu ju md me mv jx mg os mw mj mk ot mx mn mo ou my mr ms mt im bi translated">如果使用 ProjectionExpression 参数，则 Select 的值只能是 SPECIFIC_ATTRIBUTES。Select 的任何其他值都将返回错误。</p></blockquote><p id="2534" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这 2 个参数基本上是在说<code class="fe mz na nb nc b">scan</code>操作应该只返回<code class="fe mz na nb nc b">customerId</code>属性，这是我们需要的。</p><p id="adcf" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">最后，我们使用 AWS 提供的<code class="fe mz na nb nc b">begins_with()</code>函数。这个函数使用属性名和前缀来检查指定属性的值。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="7349" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">包裹</h1><p id="e48b" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">至此，您已经学会了如何使用 Python 和 Boto3 插入和删除 DynamoDB 记录。您当然可以调整和修改脚本来满足您的需要。例如，本教程中使用的过滤器表达式相对简单，如果需要，您可以添加更复杂的条件。</p><p id="024e" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">不管怎样，我希望这篇教程已经让你对如何使用 Python 进行 DynamoDB 操作有了基本的了解。所以，继续发挥你的创造力，利用这个脚本，增强它，做更高级的东西。黑客快乐！🙂</p><p id="d835" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">注:这里是 Github <a class="ae ky" href="https://github.com/billydh/batch-ops-dynamodb" rel="noopener ugc nofollow" target="_blank">回购</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/d3847ce046362cfc93e19a3591a52f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XkakNXrWtNA-rW85"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安东尼奥·加波拉在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div></div>    
</body>
</html>