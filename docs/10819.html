<html>
<head>
<title>How to build a Data Pipeline with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何建立一个有气流的数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-a-data-pipeline-with-airflow-f31473fa42cb?source=collection_archive---------24-----------------------#2020-07-28">https://towardsdatascience.com/how-to-build-a-data-pipeline-with-airflow-f31473fa42cb?source=collection_archive---------24-----------------------#2020-07-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2694" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">开始在 Python 中使用 Airflow 时需要知道的一些基础知识</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/435eae324e0113cd62efca84ef3ef01b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVA3ZgCqowu74ONIzhBrww.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3382863" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/VanVangelis-7215570/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3382863" rel="noopener ugc nofollow" target="_blank"> Nico Wall </a></p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="d5e1" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">简介</strong></p><p id="2386" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Airflow 是一个允许调度和监控数据管道的工具。这个工具是用 Python 编写的，它是一个开源的工作流管理平台。</p><p id="7588" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Airflow 可以用来编写机器学习管道、ETL 管道，或者一般来说用来调度作业。因此，感谢气流，我们可以自动化工作流程，避免许多无聊的手动任务。</p><p id="687b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在 Apache Airflow 中，工作流中的各种任务形成了一个图表。这些任务通过依赖关系链接在一起。连接一个任务和另一个任务的箭头有一个特定的方向，没有循环，因此在气流中我们有 DAGs，意思是有向无环图。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="2722" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">第一部分:如何创建 DAG 和操作符来执行任务？</strong></p><p id="69cc" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">当我们想要创建 DAG 时，我们必须提供名称、描述、开始日期和间隔，如下所示。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="4747" class="mh mi it md b gy mj mk l ml mm">from airflow import DAG</span><span id="4cbe" class="mh mi it md b gy mn mk l ml mm">first_dag = DAG( ‘first’, <br/>            description = ‘text’, <br/>            start_date = datetime(2020, 7, 28),<br/>            schedule_interval = ‘@daily’)</span></pre><p id="d603" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">操作符是 DAG 的构造块。它们定义了 DAG 将执行的实际工作。我们需要通过设置 task_id、python_callable 和 dag 来参数化操作符。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="9d2c" class="mh mi it md b gy mj mk l ml mm">from airflow import DAG</span><span id="504d" class="mh mi it md b gy mn mk l ml mm">from airflow.operators.python_operator import PythonOperator</span><span id="3958" class="mh mi it md b gy mn mk l ml mm">def my_func():<br/>   print('done')</span><span id="36c0" class="mh mi it md b gy mn mk l ml mm">first_dag = DAG(...)</span><span id="1091" class="mh mi it md b gy mn mk l ml mm">task = PythonOperator(<br/>     task_id = 'first_task',<br/>     python_callable=my_func ,<br/>     dag=first_dag)</span></pre><p id="a717" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">其他常见的运算符有:</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="ebb6" class="mh mi it md b gy mj mk l ml mm">- PostgresOperator</span><span id="cc1f" class="mh mi it md b gy mn mk l ml mm">- RedshiftToS3Operator</span><span id="e538" class="mh mi it md b gy mn mk l ml mm">- S3ToRedshiftOperator</span><span id="f50a" class="mh mi it md b gy mn mk l ml mm">- BashOperator</span><span id="637a" class="mh mi it md b gy mn mk l ml mm">- SimpleHttpOperator</span><span id="ff65" class="mh mi it md b gy mn mk l ml mm">- Sensor</span></pre><p id="1b36" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">计划是可选的，默认情况下，如果我们忽略计划间隔，我们的 DAG 将从开始日起每天运行一次。无论如何，在下面你可以找到设置你的时间间隔的所有选择。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="e8eb" class="mh mi it md b gy mj mk l ml mm">@once →run a DAG only once time</span><span id="4c26" class="mh mi it md b gy mn mk l ml mm">@hourly → run the DAG every hour</span><span id="ff9d" class="mh mi it md b gy mn mk l ml mm">@daily → run the DAG every day</span><span id="0687" class="mh mi it md b gy mn mk l ml mm">@weekly → run the DAG every week</span><span id="b354" class="mh mi it md b gy mn mk l ml mm">@monthly → run the DAG every month</span><span id="d57f" class="mh mi it md b gy mn mk l ml mm">@yearly → run the DAG every year</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="cf4d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">第二部分:任务依赖和气流挂钩</strong></p><p id="97e9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在 Airflow 中，每个有向无环图都由节点(即任务)和边来表征，这些节点和边强调了任务之间的顺序和依赖性。</p><p id="6140" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以使用双箭头操作符“&gt; &gt;”来描述依赖关系。所以:</p><ul class=""><li id="aeeb" class="mo mp it li b lj lk lm ln lp mq lt mr lx ms mb mt mu mv mw bi translated"><strong class="li iu">a&gt;T27】b</strong>表示 a 在 b 之前</li><li id="dc2a" class="mo mp it li b lj mx lm my lp mz lt na lx nb mb mt mu mv mw bi translated"><strong class="li iu">甲&lt; &lt;乙</strong>的意思是乙先于甲</li></ul><p id="8d03" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">另一种方法是使用<strong class="li iu">设置 _ 下游</strong>和<strong class="li iu">设置 _ 上游:</strong></p><ul class=""><li id="2c22" class="mo mp it li b lj lk lm ln lp mq lt mr lx ms mb mt mu mv mw bi translated"><strong class="li iu"> a.set_downstream(b) </strong>表示 a 在 b 之前</li><li id="dcd0" class="mo mp it li b lj mx lm my lp mz lt na lx nb mb mt mu mv mw bi translated"><strong class="li iu"> a.set_upstream(b) </strong>意思是 a 在 b 之后</li></ul><p id="b73a" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了与我们的数据存储和其他外部系统(如 Redshift、Postgres 或 MySQL)进行交互，我们可以配置<strong class="li iu">气流挂钩。</strong>下面用<strong class="li iu"> </strong>举例说明一下它的样子。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="3881" class="mh mi it md b gy mj mk l ml mm">from airflow import DAG</span><span id="a493" class="mh mi it md b gy mn mk l ml mm">from airflow.hooks.postgres_hook import PostgresHook</span><span id="2741" class="mh mi it md b gy mn mk l ml mm">form airflow.operators.python_operator import PythonOperator</span><span id="71d5" class="mh mi it md b gy mn mk l ml mm">def load():<br/>    #create  a PostgresHook option using the 'example' connection<br/>     db_hook = PostgresHook('example')<br/>     df = db_hook.get_pandas_df('SELECT * FROM my_table')</span><span id="536c" class="mh mi it md b gy mn mk l ml mm">load_task = PyhtonOperator(task_id='load',                                     python_callable=my_func_name, ...)</span></pre><p id="15e8" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">上面你可以看到我导入了一个 PostgresHook，我通过给它命名为‘example’来初始化它。</p><p id="dc33" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">然后通过函数<strong class="li iu">db _ hook . get _ pandas _ df(' SELECT * FROM my _ table '</strong>)我请求给我一个 pandas 数据框。因此，Airflow 开始运行 SQL 语句，最后结果被加载到 pandas 数据框中并返回给 Airflow。</p><p id="d73e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">然而，气流还有其他的挂钩，比如:</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="c3ad" class="mh mi it md b gy mj mk l ml mm">- HttpHook</span><span id="1ebd" class="mh mi it md b gy mn mk l ml mm">- MySqlHook</span><span id="1c83" class="mh mi it md b gy mn mk l ml mm">- SlackHook</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="e25c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">第三部分:上下文和模板</strong></p><p id="8765" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">气流提供了几个特定于运行时给定 DAG 和任务的执行的上下文变量。在处理之前访问或分割数据的过程中，上下文变量非常有用。你可以在这里找到<a class="ae ky" href="https://airflow.apache.org/docs/stable/macros-ref" rel="noopener ugc nofollow" target="_blank"/>一个变量列表，可以作为夸尔格包含在内。</p><p id="75e0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">下面，我们有一个函数叫做<strong class="li iu"> my_func。</strong>函数中有*args 和**kwargs(即关键字参数列表)。此外，您可以注意到，在<strong class="li iu">任务</strong>中，<strong class="li iu">提供 _ 上下文</strong>被设置为 True。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="5ef0" class="mh mi it md b gy mj mk l ml mm">from airflow import DAG<br/>from airflow.operators.python_operator import PythonOperator</span><span id="76f2" class="mh mi it md b gy mn mk l ml mm">def my_func(*args, **kwargs): <br/>     logging_info(f"start{kwargs['ds']}")</span><span id="4e63" class="mh mi it md b gy mn mk l ml mm">first_dag = DAG(...)<br/>task = PythonOperator(<br/>     task_id = 'date',<br/>     python_callable = my_func,<br/>     provide_context = True,<br/>     dag=first_dag)</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="1747" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">结论</strong></p><p id="8bdd" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，您已经具备了构建气流管道的基础。我认为理解这些概念的最好方法是建立你的气流环境并自己尝试。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="39ce" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我发出一份期刊简讯。如果您想加入，请通过此链接 注册。</p><p id="1661" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">除了我的<strong class="li iu">简讯</strong>，我们还可以在我的电报群<a class="ae ky" href="https://t.me/DataScienceForBeginners" rel="noopener ugc nofollow" target="_blank"> <strong class="li iu">数据科学初学者</strong> </a> <strong class="li iu">中取得联系。</strong></p></div></div>    
</body>
</html>