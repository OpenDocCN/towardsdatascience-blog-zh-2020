<html>
<head>
<title>How to Set Up Docker for Deep Learning on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS上设置深度学习的Docker</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-set-up-docker-for-deep-learning-on-aws-bce751eaf662?source=collection_archive---------35-----------------------#2020-06-11">https://towardsdatascience.com/how-to-set-up-docker-for-deep-learning-on-aws-bce751eaf662?source=collection_archive---------35-----------------------#2020-06-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="475c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用nvidia-docker访问运行容器中的GPU</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/223e2dd99641fbbe837e8d03548a56df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0kQrLwBE56ZT8sjZq5j5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://blog.pridybailo.com/docker-and-nvidia-gpus/" rel="noopener ugc nofollow" target="_blank">https://blog.pridybailo.com/docker-and-nvidia-gpus/</a></p></figure><p id="fd0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章将帮助您在AWS EC2实例上设置一个支持GPU的Docker容器，用于深度学习。我们还将介绍如何从本地机器访问运行在容器内部的Jupyter服务器。</p><p id="c365" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么？我最喜欢Docker的一点是，它允许你在远程机器上轻松地复制本地开发环境。每当你需要在GPU上训练一个模型时，这就非常方便了。</p><p id="c351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文假设读者对构建Docker映像和在AWS上启动EC2实例有一定的了解。关于Docker以及它如何帮助改进您的数据科学工作流的初级读本，请查看<a class="ae ky" rel="noopener" target="_blank" href="/how-docker-can-help-you-become-a-more-effective-data-scientist-7fc048ef91d5">这篇精彩的文章</a>。</p><p id="61f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">TL；DR: </strong>使用<code class="fe lv lw lx ly b">nvidia/cuda</code>作为您的基本映像，并在启动容器时传递<code class="fe lv lw lx ly b">--gpus all</code>标志。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="b7a1" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">步骤0:您的Git存储库</h1><p id="47ea" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">这篇文章的工作目录将是您项目的本地<code class="fe lv lw lx ly b">git</code>库。虽然这不是我们在AWS上设置支持GPU的Docker容器的目标的严格先决条件，但它将使您的生活更加轻松，因为它允许您在EC2实例上简单地<code class="fe lv lw lx ly b">git clone</code>GitHub repo。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="83d2" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">第一步:Docker图像</h1><p id="6a29" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">第一步是建立我们训练深度学习模型所需的图像。我们将通过将以下docker文件添加到我们的存储库中来实现这一点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="f11b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个does文件的关键组件是<code class="fe lv lw lx ly b"><a class="ae ky" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank">nvidia/cuda</a></code>基础映像，它完成了容器访问系统GPU所需的所有工作。</p><p id="4b70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你的<code class="fe lv lw lx ly b">requirements</code>文件应该包含你训练你的模型所需要的所有包，并且需要包含<code class="fe lv lw lx ly b">Jupyter</code>以使最后的<code class="fe lv lw lx ly b">CMD</code>工作。如果您有一个训练您的模型的脚本，只需用运行您的脚本的命令替换上面的<code class="fe lv lw lx ly b">CMD</code>。</p><p id="08bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">奖金👻:</strong>您也可以通过在需求步骤后添加<code class="fe lv lw lx ly b">RUN jupyter contrib nbextension install</code>来启用您最喜欢的Jupyter扩展。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="6be5" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">步骤2:启动并连接到EC2</h1><p id="5284" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">下一步是启动一个EC2实例并<code class="fe lv lw lx ly b">ssh</code>进入其中。您的实例需要安装<code class="fe lv lw lx ly b">Docker</code>和<code class="fe lv lw lx ly b">nvidia-docker</code>。最简单的选择是选择一个ubuntu深度学习AMI，两者都有安装。</p><p id="f544" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你选择了实例的AMI，选择一个带有GPU的实例类型。遗憾的是，它们并不便宜。在我写这篇文章的时候，<code class="fe lv lw lx ly b">us-west-2</code>中的一个<code class="fe lv lw lx ly b">p2.xlarge</code>实例将花费你<code class="fe lv lw lx ly b">$0.90/hour</code>😭。</p><p id="9705" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在启动实例之前的review页面，编辑安全组以打开<code class="fe lv lw lx ly b">port 8888</code>,这样我们就可以从本地机器连接到运行在容器内部的Jupyter服务器。</p><p id="371b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查您的评论页面看起来像这样，并启动您的实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/6fc6f931bf03d0a44b998e5df2f19993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XcP9kTQro_XFPmb8RJG-0A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">记得在source下选择MyIP。</p></figure><p id="fecc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您的实例启动并运行，通过在本地终端上运行以下命令进入它:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="ad0b" class="nk mh it ly b gy nl nm l nn no">% ssh -i &lt;path-to-aws-pem-file&gt; &lt;user&gt;@&lt;ec2-hostname&gt;</span></pre><p id="fc0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过选择您的实例并单击AWS控制台上的<code class="fe lv lw lx ly b">Connect</code>来找到您的<code class="fe lv lw lx ly b">user</code>和<code class="fe lv lw lx ly b">ec2-hostname</code>。如果你选择了一个Ubuntu图片，它看起来会像<code class="fe lv lw lx ly b">ubuntu@ec2–XXX.us-west-2.compute.amazonaws.com</code>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="aff2" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">第三步:克隆你的回购协议，建立你的形象</h1><p id="c819" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">现在我们已经连接到一个正在运行的EC2实例，是时候构建我们的Docker映像了。在实例的命令行中，克隆GitHub repo:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="1be2" class="nk mh it ly b gy nl nm l nn no">$ git clone https://github.com/&lt;username&gt;/&lt;repo&gt;.git</span></pre><p id="fd29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后<code class="fe lv lw lx ly b">cd</code>进入它并运行这个命令来构建您的Docker映像:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="7350" class="nk mh it ly b gy nl nm l nn no">$ docker build -t &lt;image-name&gt; . </span></pre><p id="3197" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">奖金👻:</strong>如果你有一个预先构建好的镜像存储在容器注册表中，比如<a class="ae ky" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> docker hub </a>，你可以用<code class="fe lv lw lx ly b">docker pull</code>来拉你的镜像，如果你的镜像需要一些时间来构建的话，这可以节省时间。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="e721" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">步骤4:启动支持GPU的容器</h1><p id="f013" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">建立了我们的映像后，我们就可以发布我们的容器了🚀。在实例的命令行中，运行:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="41c8" class="nk mh it ly b gy nl nm l nn no">$ docker run --gpus all -d -p 8888:8888 -v $(pwd):/src &lt;image-name&gt;</span></pre><p id="87bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关键的一点是<code class="fe lv lw lx ly b">--gpus</code>标志，它允许容器访问实例的GPU(多亏了<code class="fe lv lw lx ly b">nvidia-docker</code>)。至于其他的，</p><ul class=""><li id="4fc7" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">-d</code>标志在后台运行容器(分离模式)。</li><li id="3465" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">-p</code>标志将容器上的<code class="fe lv lw lx ly b">port 8888</code>绑定到EC2实例上的<code class="fe lv lw lx ly b">port 8888</code>(我们之前已经向入站连接开放了该实例)。</li><li id="7406" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">-v</code>标志将当前目录(您克隆的存储库)挂载到我们在Dockerfile中设置的工作目录(我们称之为<code class="fe lv lw lx ly b">/src</code>)中，这样我们对笔记本所做的更改就会修改磁盘上的文件。</li></ul><p id="d9b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的命令既启动了一个容器，又启动了其中的Jupyter服务器(感谢我们的<code class="fe lv lw lx ly b">Dockerfile</code>中的最后一个<code class="fe lv lw lx ly b">CMD</code>)。您将看到打印在屏幕上的容器ID。复制并运行下一个命令来获取Jupyter服务器的<code class="fe lv lw lx ly b">access token</code>:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="542f" class="nk mh it ly b gy nl nm l nn no">$ docker exec &lt;container-ID&gt; jupyter notebook list</span></pre><p id="478e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">复制打印的<code class="fe lv lw lx ly b">access token</code>并返回到您的本地命令行。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="097b" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">步骤5:连接到容器的Jupyter服务器</h1><p id="cab0" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">恭喜你。您已经完成了在远程AWS实例上设置支持GPU的容器的所有艰苦工作。最后一步是将您机器上的一个本地端口转发到容器内部运行的Jupyter服务器:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="31b0" class="nk mh it ly b gy nl nm l nn no">% ssh -NfL 8080:localhost:8888 &lt;user&gt;@&lt;ec2-hostname&gt;</span></pre><p id="3c07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的命令将机器上的<code class="fe lv lw lx ly b">port 8080</code>转发到EC2实例上的<code class="fe lv lw lx ly b">localhost:8888 </code>，Jupyter服务器在EC2实例上运行。</p><p id="9ace" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于<code class="fe lv lw lx ly b">port 8888</code>是Jupyter的默认端口，我们转发了<code class="fe lv lw lx ly b">port 8080</code>以避免与本地机器上运行的任何笔记本发生冲突。</p><p id="6b22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在浏览器中导航到<code class="fe lv lw lx ly b">localhost:8080</code>，粘贴上一步中的Jupyter <code class="fe lv lw lx ly b">access token</code>。</p><p id="c6d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哒哒🎉！您现在正在与一个运行在远程EC2实例上支持GPU的Docker容器内的Jupyter服务器对话。</p><p id="2e79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用PyTorch，您可以检查<code class="fe lv lw lx ly b">cuda</code>是否可用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/7ac4898cad8945d0834d1273b91d911e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EJS4s7jzV3FojSR1AKAIw.png"/></div></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="f740" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">最后的想法</h1><p id="7a55" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我希望这篇文章能够帮助你在训练深度学习模型时简化开发工作流程。将Docker整合到你的日常工作流程中需要时间，但是它会省去很多麻烦和花费在远程环境中的时间。</p><p id="4907" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！🙏</p><p id="d8c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">附注</strong>完成后，记得关闭您的<code class="fe lv lw lx ly b">p2.xlarge</code>实例！</p></div></div>    
</body>
</html>