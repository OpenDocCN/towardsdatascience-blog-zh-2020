<html>
<head>
<title>Job Board Scraping with Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用轨道刮除工作板</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/job-board-scraping-with-rails-872c432ed2c8?source=collection_archive---------20-----------------------#2020-03-29">https://towardsdatascience.com/job-board-scraping-with-rails-872c432ed2c8?source=collection_archive---------20-----------------------#2020-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f029" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用 Ruby on Rails 和 Heroku 构建一个调度作业刮刀</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/06d6a64ab16a95d472b85cfcb47338c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i278z2zclT05giiO8yuosA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">唐纳德·詹纳蒂在<a class="ae ky" href="https://unsplash.com/s/photos/satellite?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="6c0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与工作相关的数据是我最喜欢处理的数据之一。解析需求和分析跨时间、公司和地域的变化很有趣。</p><p id="4a4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然有一些很棒的<a class="ae ky" href="https://www.kaggle.com/c/job-salary-prediction/data" rel="noopener ugc nofollow" target="_blank">公共数据库</a>有与工作相关的信息，但也很容易找到。</p><p id="d40b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在 Ruby on Rails 中构建一个每天自动运行一次的工作板刮刀，托管在 Heroku 的免费层上。</p><h1 id="9662" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置</h1><p id="f464" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">假设你已经安装了 rails，创建一个新的 Rails 应用程序并<code class="fe ms mt mu mv b">cd</code>到它的根目录。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="ed31" class="na lw it mv b gy nb nc l nd ne">$ rails new scraper-2020-03<br/>$ cd scraper-2020-03/</span></pre><p id="b3cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后修改<code class="fe ms mt mu mv b">Gemfile</code>，这里设置了 ruby 依赖关系。注释掉这一行。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="f364" class="na lw it mv b gy nb nc l nd ne"># gem 'sqlite3'</span></pre><p id="c39a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">加上这一行。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="ea2e" class="na lw it mv b gy nb nc l nd ne">gem 'pg'</span></pre><p id="2d3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后运行这个来更新已安装的软件包。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="f02c" class="na lw it mv b gy nb nc l nd ne">$ bundle install</span></pre><p id="1654" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们刚刚用 Postgres 替换了 Sqlite。</p><h1 id="44d3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">配置数据库</h1><p id="de07" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">打开<code class="fe ms mt mu mv b">/config/database.yml</code>并更新文件，如下所示。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="9c09" class="na lw it mv b gy nb nc l nd ne">default: &amp;default<br/>  adapter: postgresql<br/>  pool: 5<br/>  timeout: 5000<br/><br/>development:<br/>  &lt;&lt;: *default<br/>  database: scraper_development<br/><br/>test:<br/>  &lt;&lt;: *default<br/>  database: scraper_test<br/><br/>production:<br/>  &lt;&lt;: *default<br/>  url: &lt;%= ENV['DATABASE_URL'] %&gt;</span></pre><p id="e0e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里重要的部分是设置<code class="fe ms mt mu mv b">development</code>的数据库名称<code class="fe ms mt mu mv b">database: scraper_development</code>和<code class="fe ms mt mu mv b">production</code>的 URL<code class="fe ms mt mu mv b">url: &lt;%= ENV[‘DATABASE_URL’] %&gt;</code>。</p><p id="6e7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">后者对我们部署到 Heroku 很重要。Heroku 默认将 Postgres 插件的 URL 设置为环境变量<code class="fe ms mt mu mv b">DATABASE_URL</code>。</p><p id="9f11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在本地创建一个数据库。它将被命名为我们上面设置的名称。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="11f3" class="na lw it mv b gy nb nc l nd ne">$ rake db:create</span></pre><h1 id="12f9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建 ORM 模型</h1><p id="5e32" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">生成迁移文件。这是我们指定要对数据库进行什么更改的地方。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="384e" class="na lw it mv b gy nb nc l nd ne">$ rails g migration CreateJobs</span></pre><p id="2a01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">导航到刚刚生成的迁移文件。我的是<code class="fe ms mt mu mv b">db/migrate/20200328142555_create_jobs.rb</code>，时间戳会有所不同。</p><p id="0227" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编辑它，如下图所示。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="60c3" class="na lw it mv b gy nb nc l nd ne">class <em class="nf">CreateJobs </em>&lt; ActiveRecord::Migration[5.0]<br/>  def change<br/>    create_table :jobs do |<em class="nf">t</em>|<br/>      <em class="nf">t</em>.string :location<br/>      <em class="nf">t</em>.string :team<br/>      <em class="nf">t</em>.string :job_title<br/>      <em class="nf">t</em>.string :url<br/><br/>      <em class="nf">t</em>.timestamps<br/>    end<br/>  end<br/>end</span></pre><p id="edba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们正在创建一个名为<code class="fe ms mt mu mv b">jobs</code>的表，它有几个字符串列来存储抓取的信息。默认情况下会添加一个主<code class="fe ms mt mu mv b">id</code>。<code class="fe ms mt mu mv b">t.timestamps</code>将添加<code class="fe ms mt mu mv b">created_at</code>和<code class="fe ms mt mu mv b">updated_at</code>列，当您将记录插入数据库时，这些列会自动填充。</p><p id="3b5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ms mt mu mv b">/app/models/</code>中创建名为<code class="fe ms mt mu mv b">job.rb</code>的文件。这是我们的模型。应该是这样的。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="e138" class="na lw it mv b gy nb nc l nd ne">class <em class="nf">Job </em>&lt; ApplicationRecord<br/>end</span></pre><h1 id="ff7d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建一个耙子任务</h1><p id="27b6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在<code class="fe ms mt mu mv b">/lib/tasks</code>中创建一个名为<code class="fe ms mt mu mv b">scrape.rake</code>的新文件。Rails 中的 Rake 任务是用于自动化管理任务的命令，可以从命令行运行。如果你想写代码并安排它运行的时间，这里是放代码的地方。</p><p id="8c32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新<code class="fe ms mt mu mv b">scrape.rake</code>。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="ebc9" class="na lw it mv b gy nb nc l nd ne">task scrape: :environment do<br/>  puts 'HERE'<br/><br/>  require 'open-uri'<br/><br/>  <em class="nf">URL </em>= 'https://jobs.lever.co/stackadapt'<br/><br/>  <em class="nf">doc </em>= Nokogiri::HTML(open(URL))<br/><br/>  <em class="nf">postings </em>= <em class="nf">doc</em>.search('div.posting')<br/><br/>  <em class="nf">postings</em>.each do |<em class="nf">p</em>|<br/>    <em class="nf">job_title </em>= <em class="nf">p</em>.search('a.posting-title &gt; h5').text<br/>    <em class="nf">location </em>= <em class="nf">p</em>.search('a.posting-title &gt; div &gt; span')[0].text<br/>    <em class="nf">team </em>= <em class="nf">p</em>.search('a.posting-title &gt; div &gt; span')[1].text<br/>    <em class="nf">url </em>= <em class="nf">p</em>.search('a.posting-title')[0]['href']<br/><br/>    <em class="nf"># skip persisting job if it already exists in db<br/>    </em>if Job.where(job_title:<em class="nf">job_title</em>, location:<em class="nf">location</em>, team:<em class="nf">team</em>, url:<em class="nf">url</em>).count &lt;= 0<br/>      Job.create(<br/>        job_title:<em class="nf">job_title</em>,<br/>        location:<em class="nf">location</em>,<br/>        team:<em class="nf">team</em>,<br/>        url:<em class="nf">url</em>)<br/><br/>      puts 'Added: ' + (<em class="nf">job_title </em>? <em class="nf">job_title </em>: '')<br/>    else<br/>      puts 'Skipped: ' + (<em class="nf">job_title </em>? <em class="nf">job_title </em>: '')<br/>    end<br/><br/>  end<br/>end</span></pre><p id="71cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用 Nokogiri (Ruby 的 html 解析库)导航 html 超出了我们的范围，但是如果你打开网页查看，你可以按照我的方法解析 DOM 树。</p><h1 id="0788" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">本地运行</h1><p id="8d18" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">应用程序都设置好了。本地运行就这么简单。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="0fa8" class="na lw it mv b gy nb nc l nd ne">$ rake scrape</span></pre><p id="7aa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的本地数据库中，我现在可以看到数据。如果您没有好的工具来查看本地数据库，可以考虑使用<a class="ae ky" href="https://dbeaver.io/" rel="noopener ugc nofollow" target="_blank"> dbeaver </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/ab5a17c76333287dd3ed8a428aeac5b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O93p62iNApRRmkwqEFP2Tw.png"/></div></div></figure><p id="1004" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们唯一的问题是我们不想每天手动运行它。通过部署到 Heroku 并安排任务来解决这个问题。</p><h1 id="f931" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">部署到生产环境</h1><p id="d1c3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在浏览器中创建或登录您的 Heroku 帐户。</p><p id="b0c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在命令行中键入以下内容。它将使用您的浏览器进行身份验证。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="3872" class="na lw it mv b gy nb nc l nd ne">$ heroku login</span></pre><p id="fc39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令在 Heroku 上创建您的应用程序。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="ad9e" class="na lw it mv b gy nb nc l nd ne">$ heroku create</span></pre><p id="db3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Heroku 将输出它给你的应用程序的名字作为响应。我的叫<code class="fe ms mt mu mv b">fast-garden-42976</code>。</p><p id="cc48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在本地设置 git。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="3ad9" class="na lw it mv b gy nb nc l nd ne">$ git init<br/>$ git add . -A<br/>$ git commit -m 'The first and last commit'</span></pre><p id="6b2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用 Heroku 给你的名称(不是我的名称)添加你的应用程序，以便我们可以部署。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="a656" class="na lw it mv b gy nb nc l nd ne">$ heroku git:remote -a fast-garden-42976</span></pre><p id="7d90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并展开。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="f503" class="na lw it mv b gy nb nc l nd ne">$ git push heroku master</span></pre><p id="c748" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，迁移 Heroku 上的数据库。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="9e6d" class="na lw it mv b gy nb nc l nd ne">$ heroku run rake db:migrate</span></pre><h1 id="d3c7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">在生产中配置调度程序</h1><p id="52b6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">通过手动运行命令在生产环境中测试它。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="b116" class="na lw it mv b gy nb nc l nd ne">$ heroku run rake scrape</span></pre><p id="d4d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们只需要将 rake 任务设置为一个调度作业。</p><p id="622c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 Heroku web 控制台中，单击“资源”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/9ce76e3f6ec49d993fe862c95597bb2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X_iZs6eANOdOt_DKqcfAYg.png"/></div></div></figure><p id="8fb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开始键入“schedule”并提供 Heroku Scheduler。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/87e428de47acabb8a46657964807b7b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uvxEk6sMEgBS6QfiyCCqnQ.png"/></div></div></figure><p id="3738" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击您刚刚添加的调度程序，然后单击“创建作业”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/9f9ceaf1b68a8cd50f860b9ab947d13e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Li8PrJuW9A4xbFCWEsiSA.png"/></div></div></figure><p id="beca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置<code class="fe ms mt mu mv b">rake scrape</code>作业，每天午夜运行一次。</p><p id="ef50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nf">要善良，不要多刮地盘。</em></p><p id="2da4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧啊。你的应用程序现在将每 24 小时添加一次新工作。</p><p id="7b64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您想要访问这些数据时，可以考虑像 Postico 这样的应用程序，它允许直接连接到 Heroku 中的远程数据库。或者，您可以从 Heroku 下载数据库并将其导入本地。</p><h1 id="e851" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="9b63" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这是一个快速简单的抓取应用程序。我们获取了每项工作的一些初步信息，并将其存入数据库。</p><p id="fe09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想更进一步，可能还需要补充一些东西。</p><ul class=""><li id="8e47" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">打开存储的 URL 以获取工作描述。</li><li id="5d2d" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">如果抓取多个工作公告板，请在数据库中添加另一列来存储公司名称。</li></ul><p id="8f05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这是有益的，我很乐意回答评论中的问题。</p></div></div>    
</body>
</html>