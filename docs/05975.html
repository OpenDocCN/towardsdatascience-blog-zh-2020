<html>
<head>
<title>How deep is their love?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">他们的爱有多深？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-deep-is-their-love-749bc9913c66?source=collection_archive---------68-----------------------#2020-05-15">https://towardsdatascience.com/how-deep-is-their-love-749bc9913c66?source=collection_archive---------68-----------------------#2020-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3716" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">机器学习的最大成功:预测客户流失(专长。PySpark)</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/63e0cfdd5f0388c0bfb04213436f86f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eV-lhB5LSLmFisY7"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">亚历山大·辛恩在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bd37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们说的是客户流失。不，不是那种会威胁到你的腰带或给你的动脉涂上美味黄油的那种。然而，如果任其发展，这种类型的流失<em class="ls">会威胁到许多企业的生命。</em></p><p id="ad0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">客户流失，也称为客户流失，是指在一段固定时间内停止使用公司产品或服务的客户数量。失去客户就意味着失去收入。在可以避免的客户流失方面，英国企业每年损失250亿英镑。如果一个企业能够正确识别可能离开的客户，那么他们可以提供折扣或激励来减轻这种情况。通常情况下，谁会离开<em class="ls">的线索就在客户交易数据库中，如果你只是跟踪大数据中的面包屑…</em></p><p id="cdb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本帖中，我们将为一家虚构的公司开发一个简单的客户流失预测模型，这家公司提供一种想象中叫做Sparkify的音乐流媒体服务。他们的商业模式与(几乎)同名的Spotify相同。用户可以选择两种订阅类型:</p><ul class=""><li id="d333" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">免费等级计划的功能有限，并且会中断带有广告的音乐流</li><li id="c542" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">付费等级计划，包含所有可用功能和无广告音乐流。</li></ul><p id="41fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用户不受任何会员类型的限制，不仅有机会随时升级或降级他们的订阅级别，还可以直接取消订阅。这种灵活性自然伴随着巨大的风险:如果用户对服务不满意，他们可以也愿意用脚投票。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="71db" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">问我，问我，问我(解决你的业务问题)</h1><p id="7e50" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">Sparkify管理层担心流失率，并希望预测哪些客户有取消帐户的风险。我们有事件日志的样本数据集、jupyter笔记本、Apache Spark的<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/index.html" rel="noopener ugc nofollow" target="_blank"> PySpark API </a>和<a class="ae kv" href="https://spark.apache.org/docs/2.2.0/api/python/pyspark.ml.html" rel="noopener ugc nofollow" target="_blank"> PySpark ML包</a>的工作知识。一个女孩还想要什么？</p><h1 id="a02a" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">臭名昭著的B.I.G .(数据)</h1><p id="bed5" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">在Sparkify上执行的每个活动都被记录在事件日志中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">是的，这个也是。GIF via <a class="ae kv" href="https://giphy.com/gifs/90s-music-video-vanilla-ice-Jale8dlFc4ASs" rel="noopener ugc nofollow" target="_blank"> Giphy </a></p></figure><p id="153a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一直在重复播放《心痛如碎》吗？那会被记录下来。在旅途中获得最佳蓝色播放列表？我们就能跟踪那里的创造。任何行动，无论多么可信或尴尬，都不会被遗漏。</p><p id="6ac3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们得到了一个. json文件，其中包含2018年10月至12月的事件日志数据。它由286，500行和18列组成，详细描述了客户的特征和正在执行的操作的性质。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/bfb2a4f696016a0edf411493ef98f63d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ILIoWqjjaqfDGvvKxG6fg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">不错的选择蠢朋克的歌有科林</p></figure><p id="b54e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在一些简单的数据检查和由此产生的数据清理(删除属于用户ID的行)之后，我们剩下225个客户的278，154行事件数据。他们一定很忙！</p><h1 id="f45c" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">定义(-可能)</h1><p id="3142" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">要建立一个预测模型，我们必须要有可以预测的东西。当且仅当客户访问了“取消确认”页面时，我们将客户定义为<strong class="ky ir">被搅动的</strong>。我们使用这个定义来创建一个二进制标志，它将成为我们开发的分类模型的目标变量。</p><p id="8ee0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，在我们的定义中，有一个案例将访问“提交降级”页面的客户包括在内。然而，这些客户在那次页面事件后仍然很活跃。免费用户仍然通过广告赚Sparkify的钱。因此，这些客户对公司收入的威胁不如那些取消订单的客户大。</p><p id="b318" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="ls">注意:</em> </strong>只有52个客户翻腾:我们的数据不平衡。因此，我们必须明智地选择用于评估基于这些数据的模型性能的指标。</p><h1 id="7833" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">你的照片(r数据)</h1><p id="4311" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">配备了一个目标变量，我们询问数据的预测特征，以输入到机器学习算法中。</p><div class="kg kh ki kj gt ab cb"><figure class="nt kk nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/ca22f63e2dcb4b57710e4c029f6fd67b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*VHF6nJIR_-A-2VxEdkzwiw.png"/></div></figure><figure class="nt kk nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/fa1539fde789c312f38e00654cc78cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*perH65YFSYM80Q1Db0oW7Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk nz di oa ob translated">按客户流失划分的性别(左)和订阅级别(右)</p></figure></div><ul class=""><li id="a9d7" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">性别:从上图可以明显看出，男性比女性更有可能取消约会。(在我的约会历史中也是如此)</li><li id="3e16" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><strong class="ky ir">订阅水平:</strong>我们可以推断，付费订阅的客户比免费会员更不容易离开。(哦，那么也许我应该让他们在约会的时候付晚餐的钱？)</li></ul><div class="kg kh ki kj gt ab cb"><figure class="nt kk oc nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/c530a9d0379297b1d6947c4f4964961d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*tqsYG2BJP-n2ZXjIxgtZ5w.png"/></div></figure><figure class="nt kk od nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/7b8a6f731d48b7a6f67cae74985fc271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Qvdyitf5VPqL59ivDNUcQA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk nz di oa ob translated">按流失划分的平均页面浏览量:包括“下一首歌”(左)，不包括“下一首歌”(右)</p></figure></div><ul class=""><li id="a8f4" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated"><strong class="ky ir">页面浏览量:</strong>以上数字显示了用户查看某一特定页面的平均次数。在整个数据集中，大部分活动都归因于播放下一首歌曲。其他页面上的趋势与左边的相比相形见绌，因此我们提供的数据也删除了“下一首歌”的浏览量。请注意，在“主页”、“添加朋友”、“添加到播放列表”、“下一首歌”、“竖起大拇指”和“注销”方面，活跃客户与不活跃客户之间存在显著差异</li></ul><div class="kg kh ki kj gt ab cb"><figure class="nt kk oe nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/b57cba62a66aae7d2b60a9566f93a439.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*--kcAYtlNLetYsyc_rPVZw.png"/></div></figure><figure class="nt kk of nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/85d9fd6b1d5bed7295a1c5775d2e14ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*tJnH4i6IGFzZKQly3KtdPw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk og di oh ob translated">按流失划分的每个会话的平均歌曲数量(左)；按流失划分的注册周数分布(右)</p></figure></div><ul class=""><li id="081c" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated"><strong class="ky ir">每次播放的歌曲:</strong>平均而言，顾客每次播放的歌曲较少。</li><li id="d3f2" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><strong class="ky ir">注册周:</strong>活跃客户比不活跃客户的注册时间更长。</li></ul><p id="bb7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们看到的上述一些特征并没有明确地包含在数据中。相反，我们操纵数据来创建更具预测性的客户级特征。</p><h1 id="0cd0" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">不要停止，直到你得到足够的(功能)</h1><p id="ff16" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">在这种情况下，我们从数据集中的现有要素为创建新要素。我总共构建了65个特性。这些可以大致分为:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">65功能是一个<em class="oj">很多</em>的能量来处理；GIF via <a class="ae kv" href="https://giphy.com/gifs/cute-aww-eyebleach-322FvxfciE8UsYvILG" rel="noopener ugc nofollow" target="_blank"> Giphy </a></p></figure><ul class=""><li id="737a" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">自注册以来的时间和最近的活动</li><li id="b091" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">订阅级别</li><li id="a5ca" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">会话/交互计数</li><li id="273a" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">主页/添加朋友/添加到播放列表/下一首歌/竖起大拇指/注销页面浏览量</li><li id="0678" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">日/周/夜活动和活动比率</li><li id="c843" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">最近一次活动前1、2、3、4周的会议/互动/现场时间</li><li id="3b51" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">与前两周相比，最后两周的活动比率。</li></ul><p id="61c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会详细介绍这个特性工程是如何完成的。你可以在这篇文章附带的<a class="ae kv" href="https://github.com/bev-o-neill/DSND-p7-Sparkify" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到这些乐趣。然而，有必要强调一下与PySpark争论数据的几个关键技巧:</p><ul class=""><li id="f2fe" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated"><strong class="ky ir">用户自定义函数</strong> (UDF)允许您定义新的基于列的函数。</li><li id="deb3" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><strong class="ky ir">窗口函数</strong>允许您在一组特定的行子集上定义新的基于行的函数。</li></ul><p id="2fc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是如何在特征工程中使用这些技术的快速入门:</p><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="7cf8" class="op mp iq ol b gy oq or l os ot">#Number of days since registration<br/>#Create window function<br/>w1 = Window.partitionBy(‘userId’)</span><span id="40f4" class="op mp iq ol b gy ou or l os ot">#Create udf for calculating the difference in weeks of two timestamps<br/>diffWeeks = udf(lambda x, y: (x-y)/604800000)</span><span id="675b" class="op mp iq ol b gy ou or l os ot">#Earliest and latest timestamp variables<br/>dfTimeStamps=withChurn.withColumn(‘tsMin’, min(‘ts’).over(w1))<br/>dfTimeStamps=withChurn.withColumn(‘tsMax’, max(‘ts’).over(w1))</span><span id="bfea" class="op mp iq ol b gy ou or l os ot">#Weeks user is registered<br/>weeksRegistered=dfTimeStamps.select(“userId”,”tsMax”,”registration”,”churn”).dropDuplicates()\<br/> .withColumn(“weeksRegistered”, diffWeeks(col(“tsMax”),col(“registration”)).cast(“float”))</span></pre><p id="8a09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="ls">小心</em> </strong> : <a class="ae kv" rel="noopener" target="_blank" href="/the-art-of-joining-in-spark-dcbd33d693c">谨防加入！因为他们很敏感，容易发怒。在经历了太多内存不足的错误之后，我只能求助于限制连接，除非完全有必要。</a></p><p id="ff3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们为建模做好准备之前，我们还有几个最后的步骤来整理我们的数据:</p><ul class=""><li id="af9e" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">将对应于性别和订阅级别的两个分类变量转换为数字变量。</li><li id="b739" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">删除多余的功能。</li></ul><h1 id="951e" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">模型</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">好吧，不是这种类型的建模；GIF via <a class="ae kv" href="https://giphy.com/gifs/black-and-white-music-video-madonna-iqdvmjxie4Zby" rel="noopener ugc nofollow" target="_blank"> Giphy </a></p></figure><p id="79af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PySpark ML包有许多二进制分类器模型供我们选择。我们将训练五种不同的算法，找出性能最好的一种，然后运行超参数调整来进一步增强它。</p><p id="ca6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将数据集分为训练(70%)和测试(30%)，并创建一个训练管道(通过<strong class="ky ir"> pyspark.ml. </strong>管道<strong class="ky ir"> ) </strong>，它执行以下操作:</p><ul class=""><li id="100a" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">收集向量列中的所有要素(使用<strong class="ky ir"> pyspark.ml.feature </strong>中的VectorAssembler类)。因此，我们有两列:一列对应于功能，另一列对应于标签(即流失结果标志)。</li><li id="1e57" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">通过最小-最大缩放来缩放所有要素(使用<strong class="ky ir"> pyspark.ml.feature </strong>中的MinMaxScaler类)。请注意，这意味着数据仍然保持其分布，而不是标准化。</li><li id="6723" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">使用默认参数训练指定的分类器。</li><li id="8548" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">计算精确度、F1分数、精确度-回忆曲线下的面积和总训练时间。</li></ul><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="a875" class="op mp iq ol b gy oq or l os ot">#Create assembler and scaler for our pipeline<br/>    #Transform features into features vector column<br/>    assembler = VectorAssembler(inputCols=feature_cols,outputCol="featuresVector")</span><span id="18b1" class="op mp iq ol b gy ou or l os ot">#Scale the features    <br/>    minmaxscaler = MinMaxScaler(inputCol="featuresVector", outputCol="scaledFeatures")</span><span id="6a55" class="op mp iq ol b gy ou or l os ot">#Performance metrics <br/>    evaluatorAcc =    MulticlassClassificationEvaluator(labelCol='churn', predictionCol='prediction', metricName='accuracy')<br/>    evaluatorF1 = MulticlassClassificationEvaluator(labelCol='churn', predictionCol='prediction', metricName='f1')<br/>    evaluatorAUPR = BinaryClassificationEvaluator(labelCol='churn', metricName='areaUnderPR')<br/>    <br/>#Pipeline for classifier using default parameters<br/>    pipeline = Pipeline(stages=[assembler, minmaxscaler, learner])</span></pre><p id="febb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下表给出了我们收集的结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/9c2e8ebb461001a99db3c4620aff7a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-qNfXMOirI1eQHsiTEwAlA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">初始模型结果</p></figure><p id="0588" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">度量混乱</strong>:当目标变量的类别平衡时，你就可以兴致勃勃地使用准确度和基尼系数。<a class="ae kv" href="https://machinelearningmastery.com/failure-of-accuracy-for-imbalanced-class-distributions/" rel="noopener ugc nofollow" target="_blank">当数据不平衡时不如此</a>。在这种情况下，它们可能被夸大和误导。别害怕，我们的超级英雄来了！</p><p id="5659" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">引入F1得分和精确回忆曲线下面积(AUC P-R): </strong>将这些视为不平衡人口的准确度和基尼系数<a class="ae kv" href="https://machinelearningmastery.com/roc-curves-and-precision-recall-curves-for-imbalanced-classification/" rel="noopener ugc nofollow" target="_blank">等价物。</a></p><p id="bcbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">初步结果表显示，随机森林是最好的全能:F1得分第一，AUC P-R第一，跑得最快。毫无疑问，这个模型是我们应该继续进行超参数调整的，看看我们是否可以进一步改进它。</p><h1 id="fa54" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">走开</h1><p id="27a9" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">通过<strong class="ky ir"> pyspark.ml.tuning </strong>中的ParamGridBuilder类和<strong class="ky ir"> pyspark.ml.tuning </strong>中的CrossValidator类，我们优化了随机森林，使用三重交叉验证来划分训练数据集，并对以下所有组合执行网格搜索迭代</p><ul class=""><li id="23c6" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated"><em class="ls">杂质</em>(熵，基尼系数)</li><li id="3fdf" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><em class="ls">最大深度</em> (3，4，5)</li><li id="e6b7" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">最大箱数(5，10，15)</li></ul><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="a857" class="op mp iq ol b gy oq or l os ot">#Create assembler and scaler for our pipeline<br/>#Transform features into features vector column<br/>assembler = VectorAssembler(inputCols=feature_cols,outputCol="featuresVector")</span><span id="4809" class="op mp iq ol b gy ou or l os ot">#Scale the features    <br/>minmaxscaler = MinMaxScaler(inputCol="featuresVector", outputCol="scaledFeatures")</span><span id="9e42" class="op mp iq ol b gy ou or l os ot">#Performance metrics <br/>evaluatorAcc = MulticlassClassificationEvaluator(labelCol='churn', predictionCol='prediction', metricName='accuracy')<br/>evaluatorF1 = MulticlassClassificationEvaluator(labelCol='churn', predictionCol='prediction', metricName='f1')<br/>evaluatorAUPR = BinaryClassificationEvaluator(labelCol='churn', metricName='areaUnderPR')<br/>    <br/>#Pipeline for classifier using default parameters<br/>pipeline = Pipeline(stages=[assembler, minmaxscaler, RF])</span><span id="be78" class="op mp iq ol b gy ou or l os ot">paramGrid = ParamGridBuilder().addGrid(RF.impurity,['entropy', 'gini']) \<br/>                              .addGrid(RF.maxDepth,[3,4,5])\<br/>                              .addGrid(RF.maxBins,[5,10,15])\<br/>                              .build()</span><span id="bd7d" class="op mp iq ol b gy ou or l os ot">cv = CrossValidator(estimator=pipeline,<br/>                    estimatorParamMaps = paramGrid, <br/>                    evaluator = evaluatorAUPR,<br/>                    numFolds=3,seed = 97)</span></pre><p id="0e4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下表给出了我们收集的结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/f60f0744ca99e28560d4d27d51786e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j3VC7zqXU_6QJNZFasRsvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">基线与优化的随机森林</p></figure><p id="ffd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们设法提高了F1分数，但降低了AUC P-r。F1分数是在特定阈值<em class="ls">下计算的精确度和召回率的调和平均值</em>。精确度-召回率曲线是精确度和召回率在<em class="ls">所有阈值</em>之间相互作用的图形表示。我们得出的结论是，与基线随机森林相比，优化模型对于特定阈值更好，但实际上对于所有阈值都更差:它是较差的分类器！</p><p id="5dad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，在我们的优化模型中，什么特征最具预测性呢？随机森林算法对此进行计算，并提供一个<em class="ls"> feature_importances </em>属性，可以访问该属性来检索每个输入要素的相对重要性分数。下表显示了优化模型的前十名得分:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/ef1f33928212406ab999b0e0603140ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RsXZv_rOzigM5hilgvmoCg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">优化模型的10大特性</p></figure><p id="6bc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大体上，这些变量对应于以下内容:</p><ul class=""><li id="8178" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">用户在数据集内活动的天数/周数</li><li id="f697" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">用户活动天数/周数的比例</li><li id="934d" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">用户注册了多长时间</li><li id="a077" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">每次会话的平均赞数</li><li id="3eef" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">活动最后一周的平均互动次数</li><li id="ff3a" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">最终活动前第三周的会议总数</li></ul><p id="8234" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过思考，我们可以看到其中许多是高度相关的，注册的周数(<em class="ls"> weeksRegistered </em>)和注册的天数(<em class="ls"> daysRegistered </em>)。这些功能应该在模型开发之前就已经删除了。这让我们深入了解了构建一个好模型的迭代过程！</p><h1 id="3950" class="mo mp iq bd mq mr nl mt mu mv nm mx my jw nn jx na jz no ka nc kc np kd ne nf bi translated">如果我能让时间倒流</h1><p id="4465" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">正如我们所看到的，我们可以对我们的模型构建过程进行一些调整，将它从一个普通的B端轨道变成最受欢迎的专辑。</p><ul class=""><li id="da39" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">探索更多行为改变特征。目前，我们有一个变量，看起来是最近两周与前两周相比的活动比率。也许在特定时间段内查看歌曲播放比率或会话计数比率有更强的预测特征。</li><li id="0edc" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">不要用厨房水槽的方法来处理模型特征。通过把所有东西都扔进模型，我们让自己暴露在异常值面前，扭曲了我们的模型。</li><li id="b68f" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">调整并再次调整:尝试更多的超参数，并绘制不同参数值下F1的差异。这将为您提供模型何时开始过度拟合以及最佳范围在哪里的指示。一旦你找到了那个信息，你就在那个范围内调谐。</li><li id="1660" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">把它带到云上:我们使用的数据只是AWS或IBM Watson上的12GB大数据集中的124MB。通过在Spark中编写所有内容，我们确保了它的可扩展性。我们可以轻松地将代码转移到Spark集群上运行，对于这些集群来说，大数据不是什么挑战。</li></ul><p id="78d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，谁准备好复出巡演了？</p><p id="7a9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">如果你喜欢在这个模型构建的引擎盖下修修补补，那么请查看我在GitHub上的知识库:</em><a class="ae kv" href="https://github.com/bev-o-neill/DSND-p7-Sparkify" rel="noopener ugc nofollow" target="_blank"><em class="ls">https://github.com/bev-o-neill/DSND-p7-Sparkify</em></a></p><p id="9500" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">感谢乐队成员Udacity，他们提供了数据集供我们使用。</em></p></div></div>    
</body>
</html>