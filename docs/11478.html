<html>
<head>
<title>Automating Lambda modules deployment with GitLab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 GitLab CI 自动部署 Lambda 模块</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automating-lambda-modules-deployment-with-gitlab-ci-b34cc58a7ac0?source=collection_archive---------20-----------------------#2020-08-09">https://towardsdatascience.com/automating-lambda-modules-deployment-with-gitlab-ci-b34cc58a7ac0?source=collection_archive---------20-----------------------#2020-08-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b46e760a74310f827dede796b8cfb0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EwMTJzaiJ3yBLX6T"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kf" href="https://unsplash.com/@_imkiran?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sai Kiran Anagani </a>拍摄的照片</p></figure><p id="800d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在使用 terraform lambda 模块时，我很难找到最佳的存储库架构来自动化我的 lambdas 部署。我找不到任何可以作为指南的文章，这就是我写这篇文章的原因。</p><p id="b3f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在从事大型项目时，项目组织是必备的<em class="le"/>。在这个故事中，您将会看到一种组织您的存储库的方法，这样可以简化部署过程，使其更具<em class="le">可扩展性</em>。</p><p id="2a68" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将构建以下存储库架构:</p><ul class=""><li id="b5b2" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><strong class="ki iu"> Lambda 模块</strong>:包含 Terraform Lambda 模块的存储库。</li><li id="9978" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><strong class="ki iu"> Lambda-Infra </strong>:包含部署到 AWS 中的 Terraform 代码的存储库。</li><li id="d906" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><strong class="ki iu"> Lambda 代码</strong>:包含使用 Gitlab-CI 进行部署的 Lambda 代码的存储库。</li></ul></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h1 id="b6e6" class="ma mb it bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">λ模块</h1><p id="1bf7" class="pw-post-body-paragraph kg kh it ki b kj my kl km kn mz kp kq kr na kt ku kv nb kx ky kz nc lb lc ld im bi translated">由<em class="le"> HashiCorp: </em>定义</p><blockquote class="nd"><p id="09ed" class="ne nf it bd ng nh ni nj nk nl nm ld dk translated"><em class="nn">模块</em>是一起使用的多个资源的容器。</p></blockquote><p id="650c" class="pw-post-body-paragraph kg kh it ki b kj no kl km kn np kp kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated">使用 terraform 模块解决了组织配置、封装配置、重用配置等问题，并且它提供了一致性并确保最佳实践。</p><p id="5c7b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用一个 AWS lambda 模块，可以在<a class="ae kf" href="https://github.com/DanielDaCosta/lambda-module" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我不会深入讨论如何构建 lambda 模块的细节，因为这不是本文的主要目标。</p><h1 id="9982" class="ma mb it bd mc md nt mf mg mh nu mj mk ml nv mn mo mp nw mr ms mt nx mv mw mx bi translated">λ-Infra</h1><p id="8146" class="pw-post-body-paragraph kg kh it ki b kj my kl km kn mz kp kq kr na kt ku kv nb kx ky kz nc lb lc ld im bi translated">一旦你准备好了你的模块，你就可以建立一个仓库来集中你所有的 lambdas 基础设施。在下面的例子中，每个<em class="le">。tf </em>代表不同的λ。</p><pre class="ny nz oa ob gt oc od oe of aw og bi"><span id="2806" class="oh mb it od b gy oi oj l ok ol">.<br/>├── README.md<br/>├── lambda_alarm.tf<br/>├── lambda_general.tf<br/>├── lambda_sms.tf</span></pre><p id="f4de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">准备好 lambda 模块后，你可以用它来构建你的 lambda 基础设施。</p><p id="f2e4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从下面的代码中可以看出，我们将 lambda zip 文件存储在 s3 bucket 中，该 bucket 已经激活了版本控制。这是至关重要的一步，因为 s3 中 zip 文件的<em class="le">版本 id </em>将触发 lambda 的重新部署，以防代码发生任何变化。</p><figure class="ny nz oa ob gt ju"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="785b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的例子中，<em class="le"> lambda-sms.zip </em>是我们的 lambda 源代码，将在下面定义。</p><h1 id="52c3" class="ma mb it bd mc md nt mf mg mh nu mj mk ml nv mn mo mp nw mr ms mt nx mv mw mx bi translated">λ代码</h1><p id="f402" class="pw-post-body-paragraph kg kh it ki b kj my kl km kn mz kp kq kr na kt ku kv nb kx ky kz nc lb lc ld im bi translated">为了自动化 lambda 部署，有必要压缩 lambda 代码并将其放入 s3 存储桶。</p><p id="f73f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，让我们检查我们的 lambda 代码示例。</p><pre class="ny nz oa ob gt oc od oe of aw og bi"><span id="fb44" class="oh mb it od b gy oi oj l ok ol">.<br/>├── README.md<br/>└── .gitlab-ci.yml<br/>└── lambda<br/>    ├── config.py<br/>    ├── database.py<br/>    ├── handler.py<br/>    ├── package<br/>    ├── queries<br/>    │   └── save_data.sql<br/>    └── requirements.txt</span></pre><p id="0bdd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的 CI 将负责:</p><ul class=""><li id="b639" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">运行<em class="le"> Flake8 </em>以检查语法错误和林挺惯例。</li><li id="ba33" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">安装在<em class="le"> requirements.txt </em>中定义的 lambda 依赖项</li><li id="3782" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">压缩我们的代码</li><li id="ddd8" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">使用 AWS CLI 将其移动到 AWS s3 存储桶</li></ul><figure class="ny nz oa ob gt ju"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="2f51" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">遵循 AWS 中的<em class="le">最小特权原则，</em>您应该创建一个只有<em class="le"> Put-Object </em>权限的 IAM 用户:</p><figure class="ny nz oa ob gt ju"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="9877" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将在 GitLab 项目的 CICD 设置中存储您的 AWS CLI 凭据:</p><figure class="ny nz oa ob gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/fd9b7f2e3e19fb661de234e3d4f60ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A3FIXeBkqcK3t8cK69ifvg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">GitLab CICD 设定截图</p></figure><p id="0377" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一切就绪后，当你将代码推送到主分支时，你的 lambda 代码将被压缩并存储在你的 S3 桶中。</p><h1 id="2bbb" class="ma mb it bd mc md nt mf mg mh nu mj mk ml nv mn mo mp nw mr ms mt nx mv mw mx bi translated">结论</h1><p id="4078" class="pw-post-body-paragraph kg kh it ki b kj my kl km kn mz kp kq kr na kt ku kv nb kx ky kz nc lb lc ld im bi translated">让我们看一下所有的部署程序:</p><ul class=""><li id="84d3" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">创建您的 lambda 代码，并将其推送到您的 GitLab 库。</li><li id="b4df" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">然后，您的代码将被压缩并存储在您的版本化 s3 存储桶中。</li><li id="339c" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">用 l <em class="le"> ambda-infra </em>代码运行 terraform。</li><li id="2b68" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">Terraform 将检查您的 lambda 源代码的版本 id 的变化。</li><li id="fedc" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">如果它检测到新的。zip 文件已经上传到 s3，它将重新部署您的 lambda。</li></ul><p id="d5b8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种架构让我的生活变得更加轻松，给了我的代码更多的可伸缩性。我希望它能像帮助我一样帮助你！</p></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h1 id="0de4" class="ma mb it bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">参考</h1><div class="op oq gp gr or os"><a href="https://learn.hashicorp.com/tutorials/terraform/module?in=terraform/modules" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">模块概述</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">当您使用 Terraform 管理基础设施时，您将创建越来越复杂的配置。没有…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">learn.hashicorp.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg jz os"/></div></div></a></div><div class="op oq gp gr or os"><a href="https://correctme.ifiamwrong.com/posts/gitlabcitos3/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">自动从 Gitlab 上传文件到 S3</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">更新于 2017 年 12 月 3 日。最近开始使用 GitLab 和他们的自动化管道(GitLab CI)来托管…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">correctme.ifiamwrong.com</p></div></div></div></a></div></div></div>    
</body>
</html>