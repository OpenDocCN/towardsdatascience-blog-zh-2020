<html>
<head>
<title>Automating AWS Server Shut-Down for Deep Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动关闭 AWS 服务器以进行深度学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automating-aws-server-shut-down-for-deep-learning-5d5de1301c70?source=collection_archive---------17-----------------------#2020-01-26">https://towardsdatascience.com/automating-aws-server-shut-down-for-deep-learning-5d5de1301c70?source=collection_archive---------17-----------------------#2020-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9466" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">因为每个人都有忘记的时候，没关系。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/598f9bd680010640799f10ff4c4c3501.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8hxjDTma6J99ZSTS"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@artbyhybrid?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">混合动力</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="d745" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我一直在为一个机器学习项目使用 AWS EC2 服务器。我看到的每篇文章都在说同样的事情……“不要忘记关闭 EC2 实例”。看这个让我焦虑。只要一想到让 GPU 开着会在口袋里烧个洞，我就会莫名其妙地出汗。</p><p id="ae9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">所以我决定编写一个 Bash 脚本来启动服务器，SSH 进入，这样我就可以继续我的项目，然后当我退出时关闭服务器。我甚至在桌面上保存了一个脚本的快捷方式，这样我只需点击两下就可以开始工作了。</strong></p><p id="a5f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，让脚本工作的过程并不简单，而且有点令人恼火。所以我决定写一个快速的帖子，这样社区也可以同样安心。</p><p id="e13d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">*我的工作站是 Windows 10 PC，所以这些步骤对于 Mac 可能会有所不同。* </em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="b517" class="md me it bd mf mg mh dn mi mj mk dp ml li mm mn mo lm mp mq mr lq ms mt mu mv bi translated">先决条件 1:拥有一个 AWS 帐户并创建一个实例</h2><p id="a79d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">您需要有一个 AWS 帐户，并实例化一个 AWS EC2 实例。FastAI 有一个关于如何做到这一点的教程<a class="ae ky" href="https://course.fast.ai/start_aws.html" rel="noopener ugc nofollow" target="_blank">在这里</a>。如果这是您第一次创建 GPU 实例，您可能需要请求增加“p 型”实例的限制。对我来说，这花了大约两天时间才收到 AWS 的回复。</p><h2 id="217d" class="md me it bd mf mg mh dn mi mj mk dp ml li mm mn mo lm mp mq mr lq ms mt mu mv bi translated">先决条件 2:设置 AWS CLI</h2><p id="5c4c" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">您将需要 AWS CLI，这样 Bash 脚本就可以调用来启动/关闭服务器。你可以从<a class="ae ky" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank">这里</a>下载 CLI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/f3dce15e5afca4db5bfec0aba3eeb257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DXD8NBA_xSv_YiUm9fiYlQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AWS CLI 下载</p></figure><p id="ac1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在接下来的几个步骤中，我们将在 AWS <a class="ae ky" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank"> IAM </a>中为您自己创建一个用户，然后生成并保存安全凭证，以便我们可以使用 AWS CLI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/a1721c2408706b536db358f6b565ef19.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*waiSBQxd7B7QIjpvQ-aL8g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">IAM 控制台</p></figure><p id="836a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果 IAM 控制台中有用户，则不需要新用户。只需确保您拥有用户的“安全凭证”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/54c63aa5e91f2b977d0971b55d013224.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*Ll2AVOesgZfQUa0a_IJzTg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果您没有用户，请创建一个。</p></figure><p id="dfda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您创建了一个用户，请确保授予其“编程访问”权限。接下来，您将为用户生成安全密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/715fa812368027839ebc1c6838924e1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*KAwV6tkyuLrRHLsEhy9u5w.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/02d4637db62b0e0dfeaaa990aa599251.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*c9RuL3lPV19DfY2aYrv81A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">保存这些钥匙！</p></figure><p id="b451" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 Windows 命令提示符下，您需要运行<code class="fe ne nf ng nh b">aws configure</code>并按照提示进行操作。用从 IAM 控制台获得的密钥填写访问密钥 ID 和秘密访问密钥。将默认区域设置为服务器所在的区域。</p><p id="dc85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成这些步骤后，您应该能够从命令行访问 AWS 实例了。尝试运行<code class="fe ne nf ng nh b">aws ec2 describe-instances</code>，您应该会看到 EC2 实例的列表。</p><h2 id="fae7" class="md me it bd mf mg mh dn mi mj mk dp ml li mm mn mo lm mp mq mr lq ms mt mu mv bi translated">先决条件 3:将 Git-Bash 连接到 AWS</h2><p id="9c5d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果您还没有安装 Git-Bash，请在这里安装 Git-Bash。您将需要它来运行 Bash 脚本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/f955ce43912ec07cdf5c191f269d05f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pWZk2npoazsEvyJCpp7Ag.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Git-Bash 下载</p></figure><p id="758a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是将 Git-Bash 连接到 AWS CLI。为此，您需要在 bash 的根目录下创建一个. bashrc 文件。打开一个 Git-Bash 终端并执行以下操作。</p><pre class="kj kk kl km gt nj nh nk nl aw nm bi"><span id="3c4b" class="md me it nh b gy nn no l np nq">cd ~</span><span id="3a7f" class="md me it nh b gy nr no l np nq">vim .bashrc</span></pre><p id="dde5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将打开一个文本编辑器。您可以在其中粘贴以下内容。</p><pre class="kj kk kl km gt nj nh nk nl aw nm bi"><span id="c649" class="md me it nh b gy nn no l np nq">#!/bin/bash</span><span id="cfef" class="md me it nh b gy nr no l np nq">alias aws=”winpty -Xallow-non-tty -Xplain C://Program\ Files/Amazon/AWSCLI/bin/aws.exe”</span></pre><p id="0bfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在 Git-Bash 终端将识别命令<code class="fe ne nf ng nh b">aws</code>。如果你跳过这一步，你将得到错误<code class="fe ne nf ng nh b">bash: aws: command not found</code>。确保上面插入的文件路径指向您的文件目录中的 aws.exe。</p><p id="8d07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，通过键入<code class="fe ne nf ng nh b">esc</code>和<code class="fe ne nf ng nh b">:wq</code>退出 vim 终端，然后按 enter 键。为了使更改生效，您需要关闭并重新打开 Git-Bash。这样做并执行<code class="fe ne nf ng nh b">aws</code>。您应该看到以下内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/e634c6738457bd8dc631c29c37b215d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_UNZmt2XSDcf9rMI3NqDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">测试 AWS CLI 命令</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="984e" class="nt me it bd mf nu nv nw mi nx ny nz ml jz oa ka mo kc ob kd mr kf oc kg mu od bi translated">创建脚本</h1><p id="8b15" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">这样，我们就非常接近我们的目标了。制作一个 Bash 脚本，自动启动、登录和关闭 EC2 服务器。</p><p id="a0d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以结束并编写脚本了。在您的 bash 终端中，导航到您想要脚本的任何地方(对我来说是<code class="fe ne nf ng nh b">cd C://Users/harrison/Desktop</code>)，然后运行<code class="fe ne nf ng nh b">vim aws.sh</code></p><pre class="kj kk kl km gt nj nh nk nl aw nm bi"><span id="a873" class="md me it nh b gy nn no l np nq">#!/bin/bash</span><span id="f5bc" class="md me it nh b gy nr no l np nq">INSTANCE_ID=<strong class="nh iu">&lt;YOUR EC2 INSTANCE-ID HERE&gt;<br/></strong>SSH_KEY=<strong class="nh iu">&lt;path/to/sshkey.pem&gt;</strong></span><span id="8c66" class="md me it nh b gy nr no l np nq">echo "Starting AWS Server."<br/>aws ec2 start-instances --instance-ids $INSTANCE_ID</span><span id="a6df" class="md me it nh b gy nr no l np nq">#Wait for server to come online<br/>STARTED=False<br/>while [ "$STARTED" != "True" ]; do<br/> SERVER_STATUS=$(aws ec2 describe-instance-status --include-all-instances --instance-ids $INSTANCE_ID --output text --query 'InstanceStatuses[].InstanceState.Name')<br/> if [ "$SERVER_STATUS" == "running" ]; then<br/>    STARTED=True<br/> else<br/>    sleep 3<br/> fi<br/> done</span><span id="614b" class="md me it nh b gy nr no l np nq">SERVER_PUBLIC_DNS=$(aws ec2 describe-instances — instance-ids $INSTANCE_ID — output text — query ‘Reservations[].Instances[].PublicDnsName’)</span><span id="3f01" class="md me it nh b gy nr no l np nq">echo “Attempting to log into server.”<br/>ssh -L localhost:8888:localhost:8888 -i $SSH_KEY ubuntu@$SERVER_PUBLIC_DNS</span><span id="f61f" class="md me it nh b gy nr no l np nq">echo “Shutting down server.”<br/>aws ec2 stop-instances — instance-ids $INSTANCE_ID<br/>echo "Sent shutdown command."<br/>sleep 1</span><span id="c105" class="md me it nh b gy nr no l np nq">echo "Querying instance status..."<br/>aws ec2 describe-instance-status --include-all-instances --instance-ids $INSTANCE_ID --output text --query 'InstanceStatuses[]'<br/>sleep 5</span></pre><p id="9847" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">*注意:我会定期对这个脚本进行改进。* </em></p><p id="1ec0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用您的 EC2 实例的实例 id 填充<code class="fe ne nf ng nh b">INSTANCE_ID</code>。在<code class="fe ne nf ng nh b">SSH_KEY</code>中填入您的 SSH 密钥的路径。</p><p id="1848" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，当您想开始在 EC2 服务器上工作时，只需运行 bash 脚本，您就可以连接到您的服务器了。从那里，您可以运行一个<code class="fe ne nf ng nh b">jupyter notebook</code>或者从 GitHub 加载 python 脚本。当您<code class="fe ne nf ng nh b">exit</code>退出实例时，脚本将继续运行并为您关闭服务器。</p><h1 id="3ec3" class="nt me it bd mf nu oe nw mi nx of nz ml jz og ka mo kc oh kd mr kf oi kg mu od bi translated">工作原理(可选)</h1><p id="91b2" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated"><code class="fe ne nf ng nh b">aws ec2 start-instances — instance-ids $INSTANCE_ID</code> <strong class="lb iu">启动 EC2 实例</strong>。</p><p id="a04e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要服务器的公共 DNS 才能登录。不幸的是，当您关闭服务器时，DNS 可能会改变。以下代码查询服务器的公共 DNS。</p><pre class="kj kk kl km gt nj nh nk nl aw nm bi"><span id="7dbf" class="md me it nh b gy nn no l np nq">SERVER_PUBLIC_DNS=$(aws ec2 describe-instances — instance-ids $INSTANCE_ID — output text — query ‘Reservations[].Instances[].PublicDnsName’)</span></pre><p id="7b58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">用<code class="fe ne nf ng nh b">ssh -L localhost:8888:localhost:8888 -i $SSH_KEY<strong class="lb iu"> </strong>ubuntu@$SERVER_PUBLIC_DNS</code>登录 EC2 实例</strong></p><p id="d88f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ne nf ng nh b">aws ec2 stop-instances — instance-ids $INSTANCE_ID</code> <strong class="lb iu">停止 EC2 实例。</strong></p></div></div>    
</body>
</html>