<html>
<head>
<title>Building + deploying a Neural Style Transfer app with pre-trained models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用预训练的模型构建+部署神经风格转移应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-deploying-a-neural-style-transfer-app-with-pre-trained-models-661bbefc74cd?source=collection_archive---------46-----------------------#2020-05-09">https://towardsdatascience.com/building-deploying-a-neural-style-transfer-app-with-pre-trained-models-661bbefc74cd?source=collection_archive---------46-----------------------#2020-05-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c032" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有 Flask、Python3、OpenCV、Heroku(还有一堆其他的东西)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/aa52bf2c835e9e994ffceecc2dab1924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DWglxxWRWkGs7b84p399Rw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">样式图像和上传的图像</p></figure><p id="7762" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">网友们好！</p><p id="dde9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我觉得我在学习软件开发时面临的一个问题是，许多教程往往太专业(而且不好玩)。这可能是因为软件开发的本质，但我觉得掌握技术概念与构建有趣的迷你项目一样重要，这将继续鼓励和鞭策我们。༼ つ ◕_◕ ༽つ</p><p id="827e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我认为制作一些简单的图像处理工具并在网上展示给我们的朋友和家人会很酷。因此，今天的教程将是一个图解式的演示，演示如何构建一个 web 应用程序:</p><ul class=""><li id="cdda" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">允许用户上传图像并选择样式</li><li id="abb0" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">使用预训练. t7 模型在图像上应用神经风格转移</li><li id="d9f9" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">显示上传的图像和样式化的图像</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mi"><img src="../Images/15c03c4a9a7a1c209fc64392c1d3fa4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*jZh2luhV16ESyNihPIttjQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">该项目的目录结构</p></figure><p id="c5b1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="mj">快速解释一下上面的目录结构——除了 test.py 之外，所有文件都是需要的。test.py 用于我在本地测试并查看我的 neuralStyleProcess.py 脚本是否正常工作。我的项目中有 11 个. t7 模型，但你可以决定想要多少(从</em><a class="ae mk" href="https://github.com/ProGamerGov/Torch-Models" rel="noopener ugc nofollow" target="_blank"><em class="mj">ProGamerGov</em></a><em class="mj"/>和<a class="ae mk" href="https://github.com/jcjohnson/fast-neural-style/blob/master/models/download_style_transfer_models.sh" rel="noopener ugc nofollow" target="_blank"> jcjohns </a> <em class="mj">下载)。最后，您可以忽略 __pycache__ 因为它是自动生成的。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/7ff412f2e6f640104e837ec11d2c4187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Br9BVR1vOevJ53aQZJ3cA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此 web 应用程序的可视化说明</p></figure><p id="654f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上图中，我试图只包括最重要的部分，希望能帮助你们理解 web 应用程序是如何工作的(我把我的应用程序命名为 pyFlaskOpenCV，我知道这是个糟糕的命名)。</p><p id="d48e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Let’s start with the app.py script. Think of this as the app’s root — we use this to set up the routes (something like the ‘control’ that tells things how to interact). <a class="ae mk" href="https://opensource.com/article/18/4/flask" rel="noopener ugc nofollow" target="_blank">这篇文章很好的解释了 Flask。从上图中我们可以看到，render_template()将渲染我们的 upload.html 模板。这意味着我们的 upload.html 页面将显示给我们，正如我们从图中看到的，有一个 POST 方法的表单。使用 action="{{url_for('upload')}} "，我们调用 def upload()，在该函数中，我们允许用户使用以下代码上传图像:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="d22b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们呈现 complete.html。</p><p id="6826" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在 complete.html，我们再次使用“url_for('send_processed_image '，parameter1，parameter2)”来调用 send_processed_image 函数，该函数将调用我们的 python OpenCV 图像处理脚本 neuralstyleprocess . py。neuralstyleprocess . py 使用 imwrite 将已处理的图像写入文件，并返回已处理的图像文件名，因此 send_processed_image 函数知道要从目录向 complete.html 发送什么。</p><p id="7412" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于 neuralStyleProcess.py 脚本，我的实现很大程度上改编自 pyImageSearch 的教程。他的文章全面详细地解释了它是如何工作的。我唯一改变的部分是——我没有显示图像，而是进行了 imwrite，并删除了图像后期处理的缩放部分。</p><h2 id="f7ae" class="mo mp it bd mq mr ms dn mt mu mv dp mw lh mx my mz ll na nb nc lp nd ne nf ng bi translated">使用 Heroku 在线部署</h2><p id="86f0" class="pw-post-body-paragraph ky kz it la b lb nh ju ld le ni jx lg lh nj lj lk ll nk ln lo lp nl lr ls lt im bi translated">您不必使用 Heroku，还有其他选择，但因为我们的模型占用相当多的空间(它们的大小可以累加)，请记住选择能够为您提供更多存储空间的服务器(例如，Heroku 的免费层对我来说很好，但 PythonAnywhere 的免费层就不行)。</p><p id="0638" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续我们之前的图表，我们仍然需要为 Heroku 提供三个额外的文件，这样 Heroku 就“知道”如何处理我们的 web 应用程序。这些文件是— Procfile、requirements.txt、Aptfile。</p><p id="8a54" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，这里有一个图表可以更好地解释事情:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/48a6f678df8513866ec599e00bd89b46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s6nHNOqs4YN-P8Lq0p7d4w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">霓虹灯颜色，非常酷</p></figure><p id="a094" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个<a class="ae mk" href="https://devcenter.heroku.com/articles/getting-started-with-python?singlepage=true#define-a-procfile" rel="noopener ugc nofollow" target="_blank"> Procfile </a>是你的应用程序根目录下的一个文本文件，用来明确声明启动你的应用程序应该执行什么命令。我的情况是这样的:</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="5c86" class="mo mp it nn b gy nr ns l nt nu">web: gunicorn app:app</span></pre><p id="16c1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧，请让我咆哮。因此，我花了几个小时调试！！！为什么？因为他们显然很在乎空间。因此，如果您编写了—web:guni corn app:app/web:guni corn app:app/或任何其他配置(好吧，我没有尝试所有，但我知道它的空间(非常)敏感ಥ_ಥ)</p><p id="848f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">叹息，继续前进…</p><p id="2b32" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用<a class="ae mk" href="https://help.heroku.com/IYRYW6VB/how-do-i-install-additional-software-packages-that-my-application-requires" rel="noopener ugc nofollow" target="_blank"> Aptfile </a>来包含我们需要安装在 dyno 上的其他附加软件。dyno 是什么？根据<a class="ae mk" href="https://www.heroku.com/dynos" rel="noopener ugc nofollow" target="_blank"> Heroku </a>、<em class="mj">Heroku<em class="mj"/><em class="mj">使用的容器称为</em><strong class="la iu"><em class="mj">dynos</em></strong><em class="mj">。</em><strong class="la iu"><em class="mj">Dynos</em></strong><em class="mj">是隔离的虚拟化 Linux 容器，旨在根据用户指定的命令执行代码</em></em></p><p id="d3cf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是我的(OpenCV 需要以下库才能正确运行):</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="5f24" class="mo mp it nn b gy nr ns l nt nu">libsm6</span><span id="8d99" class="mo mp it nn b gy nv ns l nt nu">libxrender1</span><span id="714c" class="mo mp it nn b gy nv ns l nt nu">libfontconfig1</span><span id="f62b" class="mo mp it nn b gy nv ns l nt nu">libice6</span></pre><p id="a6fb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我做了一个</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="c90c" class="mo mp it nn b gy nr ns l nt nu">$pip freeze &gt; requirements.txt</span></pre><p id="448f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">来生成我的 requirements.txt。如果你对其中的内容感兴趣:</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="8a02" class="mo mp it nn b gy nr ns l nt nu">click==7.1.1</span><span id="33da" class="mo mp it nn b gy nv ns l nt nu">cycler==0.10.0</span><span id="3e6a" class="mo mp it nn b gy nv ns l nt nu">Flask==1.1.1</span><span id="326b" class="mo mp it nn b gy nv ns l nt nu">gunicorn==20.0.4</span><span id="f72e" class="mo mp it nn b gy nv ns l nt nu">imutils==0.5.3</span><span id="d5b6" class="mo mp it nn b gy nv ns l nt nu">itsdangerous==1.1.0</span><span id="c5e9" class="mo mp it nn b gy nv ns l nt nu">Jinja2==2.11.1</span><span id="8eeb" class="mo mp it nn b gy nv ns l nt nu">kiwisolver==1.1.0</span><span id="2ad9" class="mo mp it nn b gy nv ns l nt nu">MarkupSafe==1.1.1</span><span id="4b37" class="mo mp it nn b gy nv ns l nt nu">matplotlib==3.2.1</span><span id="84ca" class="mo mp it nn b gy nv ns l nt nu">numpy==1.18.2</span><span id="2e6c" class="mo mp it nn b gy nv ns l nt nu">opencv-python==4.2.0.32</span><span id="fbbb" class="mo mp it nn b gy nv ns l nt nu">pyparsing==2.4.6</span><span id="e2c3" class="mo mp it nn b gy nv ns l nt nu">python-dateutil==2.8.1</span><span id="3b40" class="mo mp it nn b gy nv ns l nt nu">six==1.14.0</span><span id="90d3" class="mo mp it nn b gy nv ns l nt nu">Werkzeug==1.0.0</span></pre><p id="f0e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用 OpenCV-python 和 NumPy 之类的库最棘手的一点是，要弄清楚哪个版本可以协同工作，哪个版本不可以，这真的很繁琐。(有时 4.2.0.32 版本可以工作，但 4.1.0 可能不行。)这些都是适合我的版本。</p><h2 id="06b5" class="mo mp it bd mq mr ms dn mt mu mv dp mw lh mx my mz ll na nb nc lp nd ne nf ng bi translated">后续步骤(一些建议)</h2><ul class=""><li id="c559" class="lu lv it la b lb nh le ni lh nw ll nx lp ny lt lz ma mb mc bi translated">对上传的文件进行图像扩展名检查</li><li id="891b" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">调整上传图像的大小</li><li id="459d" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">将上传/处理的图像保存到数据库，以便数据持久保存</li><li id="8a84" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">其他图像处理脚本</li><li id="7419" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">更好的 html 页面样式</li><li id="38b6" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">在第一页加载时添加一些指示符(例如加载动画)</li><li id="2893" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">在它的基础上建立一些交互式的东西(例如用 javascript 等)</li><li id="eb9c" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">不要选择预先训练好的模型，用生成性对抗网络(GAN)生成 art</li></ul><p id="2174" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧，希望这能帮助人们更好地理解事物是如何工作的。我不确定这是否是一种更好的浏览代码的方式，而不是将代码分成块，然后解释每一行——我个人发现大多数教程缺乏图解解释，所以我想我会以一种自己感觉最直观的方式来呈现事情——让我知道你们是怎么想的。</p><p id="aaba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">快乐创作！\ (•◡•) /</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><p id="af4b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此处提供的代码:<a class="ae mk" href="https://github.com/Reine0017/pyFlaskOpenCV" rel="noopener ugc nofollow" target="_blank">https://github.com/Reine0017/pyFlaskOpenCV</a></p><p id="b63f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">试试看:【https://apricot-cupcake-90327.herokuapp.com/ T2】</p></div></div>    
</body>
</html>