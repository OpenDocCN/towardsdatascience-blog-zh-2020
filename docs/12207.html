<html>
<head>
<title>Deploying Sklearn Machine Learning on AWS Lambda with SAM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 SAM 在 AWS Lambda 上部署 Sklearn 机器学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-sklearn-machine-learning-on-aws-lambda-with-sam-8cc69ee04f47?source=collection_archive---------9-----------------------#2020-08-23">https://towardsdatascience.com/deploying-sklearn-machine-learning-on-aws-lambda-with-sam-8cc69ee04f47?source=collection_archive---------9-----------------------#2020-08-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="94f3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在 API 背后的无服务器架构上生产机器学习</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e523ad8d968ede1b142d885270db9dc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m_IhRJjT40Ft4dcM-8bCUA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://www.pexels.com/photo/people-at-concert-1105666/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a>的<a class="ae ky" href="https://www.pexels.com/@vishnurnair?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">毗湿奴·R·奈尔</a>的照片</p></figure><p id="aa2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在笔记本电脑上构建机器学习模型非常简单。</p><p id="7fe9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署模型以使它们在生产中可用并不容易。</p><p id="3ad7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生产 ML 很难。它不仅结合了 SDE，ML 和 DevOps。但是没有放之四海而皆准的方法。</p><p id="adf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一家公司的成立取决于业务需求、财务限制和技术技能的综合因素。</p><p id="e0ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天我们将学习在<a class="ae ky" href="https://aws.amazon.com/serverless/" rel="noopener ugc nofollow" target="_blank"> Lambda </a>上部署<a class="ae ky" href="https://en.wikipedia.org/wiki/Serverless_computing" rel="noopener ugc nofollow" target="_blank">无服务器</a> ML。</p><p id="a69f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">虽然大多数 ML 并不适合无服务器系统，但有时还是有意义的。一会儿有意义的时候我会解释的。</em></p><h2 id="7808" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">目录:</h2><ol class=""><li id="0035" class="mp mq it lb b lc mr lf ms li mt lm mu lq mv lu mw mx my mz bi translated">背景资料</li><li id="f4ae" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">在本地训练一个模型</li><li id="2003" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">将模式推向 S3</li><li id="0084" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">构建 SAM 应用程序</li><li id="01dc" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">在本地测试应用程序</li><li id="6314" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">将应用程序部署到 AWS</li><li id="a3e3" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">测试 API</li><li id="7d79" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated">结论</li></ol></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="9eb1" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">背景</h1><h2 id="3dbd" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">什么时候 ML 适合无服务器？</h2><p id="2cdb" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">你的 ML 很适合 Lambda，如果…</p><ul class=""><li id="8bca" class="mp mq it lb b lc ld lf lg li oa lm ob lq oc lu od mx my mz bi translated"><strong class="lb iu">你的型号小。</strong> Lambda 会在每次请求时重新加载模型，因此大型模型会导致响应时间变慢。</li><li id="6e06" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu od mx my mz bi translated"><strong class="lb iu">数据向量很小。</strong> Lambda 配备了 3GB 内存上限。所以如果你的输入数据是海量的，它就会崩溃。</li><li id="c50f" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu od mx my mz bi translated"><strong class="lb iu">您的模型将被零星地访问。</strong> Lambda 向外扩展(不是向上扩展)到无限，并按请求收费。因此，它非常适合间歇性的“即时”需求。</li><li id="3be0" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu od mx my mz bi translated"><strong class="lb iu">低成本很重要。</strong> Lambda 每百万次请求收费 0.2 美元。</li></ul><p id="06d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">否则…考虑在 EC2 或 Sagemaker 上部署(如果钱不是问题的话)。</p><h2 id="a906" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">山姆是什么？</h2><p id="9d41" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">SAM 代表“无服务器应用程序模型”。这是一个通过代码提供 AWS 服务的开源框架。</p><p id="b822" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，在 AWS 控制台中，总是选择基础设施即代码，而不是设置基础设施。前者更易维护，可复制，并允许在 Github 中存储版本。</p><h2 id="6a99" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">教程先决条件</h2><p id="7634" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">你需要在你的机器上设置一些东西。</p><ul class=""><li id="4c39" class="mp mq it lb b lc ld lf lg li oa lm ob lq oc lu od mx my mz bi translated">AWS 外壳(下载并<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank">配置</a></li><li id="ec5f" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu od mx my mz bi translated">AWS SAM 客户端</li><li id="228c" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu od mx my mz bi translated">码头工人</li></ul></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="702e" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">在本地训练一个模型</h1><p id="eabe" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">本教程的重点是部署。所以我们不会关心训练一个精确的模型。但是您可以很容易地用您自己的更复杂的模型来替换它。</p><p id="91ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 Jupyter notebook 中，首先导入所需的库。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="1a17" class="lw lx it of b gy oj ok l ol om">from sklearn.datasets import load_wine<br/>import pandas as pd<br/>import numpy as np<br/>import pickle</span></pre><p id="7539" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">导入数据并生成数据框架。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="774e" class="lw lx it of b gy oj ok l ol om">data = load_wine() # import dataset<br/>df = pd.DataFrame(data['data'], columns=data['feature_names']) # build dataframe<br/>df['target'] = data['target'] # add dependent variable<br/>df = df.sample(frac=1) # randomize the data<br/>df.head(3)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/915c6426d4aead28070a23af07bc2255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hdlH6BPmxBAmA_3ub3sHdg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">它看起来会像这样。</p></figure><p id="a67e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将数据分成测试集和训练集。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="436e" class="lw lx it of b gy oj ok l ol om">print("row count:",len(df))<br/>train_df = df[:150]<br/>test_df = df[150:]<br/>#=&gt; row count: 178</span></pre><p id="ab30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">准备数据以训练模型。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="c300" class="lw lx it of b gy oj ok l ol om">def X_and_y_from_df(df, y_column, X_columns = []):<br/>    '''Extract data from the dataframe'''<br/>    X = {}<br/>    for feature in X_columns:<br/>        X[feature] = df[feature].tolist()<br/>    y = df[y_column].tolist()<br/>    return X, y</span><span id="446b" class="lw lx it of b gy oo ok l ol om">X_train, y_train = X_and_y_from_df(train_df, 'target', ['alcohol'])<br/>X_test, y_test = X_and_y_from_df(test_df, 'target', ['alcohol'])</span><span id="050c" class="lw lx it of b gy oo ok l ol om">X_train = np.array(X_train['alcohol']).reshape(-1,1)<br/>X_test = np.array(X_test['alcohol']).reshape(-1,1)</span></pre><p id="70e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">符合模型。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="f9d4" class="lw lx it of b gy oj ok l ol om">from sklearn.linear_model import LogisticRegression<br/>model = LogisticRegression()<br/>model.fit(X_train, y_train)</span></pre><p id="d1a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">腌制模型。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="580b" class="lw lx it of b gy oj ok l ol om">import pickle<br/>pickle.dump( model, open( "pickled_model.p", "wb" ) )</span></pre><p id="6b41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！现在它的格式很容易在 S3 保存。</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="d149" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">将模式推向 S3</h1><p id="9cc6" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">在与上述笔记本相同的目录中打开命令行。</p><p id="f4d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个 S3 桶。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="c597" class="lw lx it of b gy oj ok l ol om">$ aws s3 mb s3://sam-sklearn-lambda-123</span></pre><p id="b94d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意:您将需要自己的全球唯一的存储桶名称。</em></p><p id="8eff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">把你的腌模推到 S3 去。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="da00" class="lw lx it of b gy oj ok l ol om">$ aws s3 cp pickled_model.p s3://lambda-app-bucket-123</span></pre><p id="e811" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS 服务现在可以访问您的模型，并且无需重新部署任何其他代码就可以对其进行更新或更改。</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="9334" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">构建 SAM 应用程序</h1><p id="d814" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">在命令行上，初始化 SAM 应用程序。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="98b8" class="lw lx it of b gy oj ok l ol om">$ sam init</span></pre><p id="399f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将询问您 4 个问题，这些问题将用于为我们的 SAM 应用程序构建一个起始模板。</p><p id="d2d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回答下面的问题。</p><h2 id="8448" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">提示:</h2><ol class=""><li id="ec3d" class="mp mq it lb b lc mr lf ms li mt lm mu lq mv lu mw mx my mz bi translated"><strong class="lb iu">您想使用哪个模板源？</strong> 1 — AWS 快速入门模板</li><li id="180d" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated"><strong class="lb iu">您想使用哪个运行时？</strong> 2 — python3.8</li><li id="8cd0" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated"><strong class="lb iu">项目名称【Sam-app】:</strong>【按“回车”保留默认名称】</li><li id="695b" class="mp mq it lb b lc na lf nb li nc lm nd lq ne lu mw mx my mz bi translated"><strong class="lb iu"> AWS 快速入门应用程序模板:</strong> 1 — Hello World 示例</li></ol><p id="90c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在<code class="fe op oq or of b">cd</code>进入刚刚创建的目录，用你喜欢的文本编辑器打开它。我用的是 Atom。</p><p id="3324" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目录结构应该如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/b5ed34f4c7d94d140e3e44b8b19f6b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ik6G4RfyZV1pLtYMUPG2sQ.png"/></div></div></figure><p id="37ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们将 lambda 代码所在的子目录的名称从<code class="fe op oq or of b">/hello_world</code>改为<code class="fe op oq or of b">code/</code>。您可以使用以下命令来完成此操作。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="b993" class="lw lx it of b gy oj ok l ol om">$ mv hello_world/ code/ </span></pre><p id="4a19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是时候更新文件了。</p><h2 id="48b4" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">template.yaml</h2><p id="dcfa" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">这个文件告诉<a class="ae ky" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>应该提供哪些服务。</p><p id="6202" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新它，如下图所示。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="1273" class="lw lx it of b gy oj ok l ol om">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: 'Serverless wine classifier'<br/>Globals:<br/>  Function:<br/>    Timeout: 10<br/>Resources:<br/>  WineClassifierFunction:<br/>    Type: AWS::Serverless::Function<br/>    Properties:<br/>      CodeUri: WineClassifierFunction<br/>      Handler: app.lambda_handler<br/>      Runtime: python3.8<br/>      MemorySize: 1024<br/>      Role: arn:aws:iam::421242169512:role/LambdaCanReadS3<br/>      Environment:<br/>        Variables:<br/>          s3_bucket: lambda-app-bucket-123<br/>          model_name: pickled_model.p<br/>      Events:<br/>        WineClassifier:<br/>          Type: Api<br/>          Properties:<br/>            Path: /classify<br/>            Method: post<br/>Outputs:<br/>  WineClassifierApi:<br/>    Description: API Gateway endpoint URL for Prod stage for WineClassifier function<br/>    Value:<br/>      Fn::Sub: <a class="ae ky" href="https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/classify/" rel="noopener ugc nofollow" target="_blank">https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/classify/</a></span></pre><p id="7d31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意:您需要在 AWS 中创建一个 IAM 角色，它允许 Lambda 读取 S3 的文件。我的名字叫做"</em>arn:AWS:iam::421242169512:role/lambda can reads 3 "但是你需要用你的角色的名字替换它。</p><p id="94df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面提供了 API 网关端点和 Lambda。</p><p id="9a08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还将运行在 lambda 上的语言指定为 Python3.8，设置一些可以在我们的 Lambda 代码中访问的变量，并配置 API 网关端点。</p><h2 id="b5f2" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">code/app.py</h2><p id="7800" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">这是我们的 Lambda 代码所在的地方。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="d854" class="lw lx it of b gy oj ok l ol om">import json<br/>import sklearn<br/>import boto3<br/>import os<br/>import json<br/>import pickle</span><span id="9c5a" class="lw lx it of b gy oo ok l ol om">s3 = boto3.client('s3')<br/>s3_bucket = os.environ['s3_bucket']<br/>model_name = os.environ['model_name']<br/>temp_file_path = '/tmp/' + model_name</span><span id="da6b" class="lw lx it of b gy oo ok l ol om">from sklearn.linear_model import LogisticRegression</span><span id="dc98" class="lw lx it of b gy oo ok l ol om">def lambda_handler(event, context):<br/>    # Parse input<br/>    body = event['body']<br/>    input = json.loads(body)['data']<br/>    input = float(input )</span><span id="eb40" class="lw lx it of b gy oo ok l ol om">    # Download pickled model from S3 and unpickle<br/>    s3.download_file(s3_bucket, model_name, temp_file_path)<br/>    with open(temp_file_path, 'rb') as f:<br/>        model = pickle.load(f)</span><span id="3439" class="lw lx it of b gy oo ok l ol om">    # Predict class<br/>    prediction = model.predict([[input]])[0]</span><span id="69bc" class="lw lx it of b gy oo ok l ol om">    return {<br/>        "statusCode": 200,<br/>        "body": json.dumps({<br/>            "prediction": str(prediction),<br/>        }),<br/>    }</span></pre><p id="15e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，它导入库，从 S3 获取模型，解析输入请求，对其进行分类，并返回响应。</p><h2 id="7991" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">code/requirement . txt</h2><p id="61b3" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">这是我们指定应该在 Lambda 上安装什么库的地方。下面是我们所需要的。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="109d" class="lw lx it of b gy oj ok l ol om">requests<br/>boto3<br/>sklearn</span></pre><p id="3615" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在命令行上运行以下命令。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="0b56" class="lw lx it of b gy oj ok l ol om">$ sam build</span></pre><p id="cf98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个<code class="fe op oq or of b">.aws-sam/build</code>目录，其中包含将被部署到 AWS 的代码。</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="ee1f" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">在本地测试应用程序</h1><p id="7dda" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">在部署之前，让我们确保应用程序在本地工作。在此处得到成功回复之前，请不要继续。</p><p id="3d66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令以在本地设置应用。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="f719" class="lw lx it of b gy oj ok l ol om">$ sam local start-api</span></pre><p id="24f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在用卷曲达到终点。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="dac1" class="lw lx it of b gy oj ok l ol om">$ curl -XPOST http://127.0.0.1:3000/classify -H 'Content-Type: application/json' -d '{"data":".10"}'</span></pre><p id="90d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">响应应该如下所示。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="9d9b" class="lw lx it of b gy oj ok l ol om">{"prediction": "1"}</span></pre><p id="1c64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你的回答如上，请继续！</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="10fc" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">将应用程序部署到 AWS</h1><p id="47cc" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated"><code class="fe op oq or of b">cd</code>进入<code class="fe op oq or of b">.aws-sam/build/</code>目录。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="f3f3" class="lw lx it of b gy oj ok l ol om">$ cd .aws-sam<br/>$ cd build</span></pre><p id="641f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在下面跑。这将创建一个 zip 文件，其中包含将要部署的依赖项(马上)。这需要一分钟。</p><p id="2ce3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意:我使用我的 S3 桶的名字，但是你应该使用你的名字。</em></p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="d327" class="lw lx it of b gy oj ok l ol om">$ sam package --template-file template.yaml --s3-bucket lambda-app-bucket-123 --output-template-file packaged.yaml</span></pre><p id="409f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后运行以下命令来部署您的应用程序。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="4d89" class="lw lx it of b gy oj ok l ol om">$ sam deploy --template-file packaged.yaml --stack-name SklearnLambdaStack --capabilities CAPABILITY_IAM</span></pre><p id="55da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该得到一个应用程序已经部署的确认。</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="ccfd" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">测试 API</h1><p id="cab7" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">在之前的部署响应中，您将获得一个 URL。</p><p id="5063" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一切正常，向该 URL 发送请求应该会返回与向本地运行的应用程序发送请求相同的响应。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="79eb" class="lw lx it of b gy oj ok l ol om">$ curl -XPOST https://6lsk6c6vw2.execute-api.us-east-1.amazonaws.com/Prod/classify/ -H 'Content-Type: application/json' -d '{"data":".10"}'</span></pre><p id="0a75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以以上应该回归。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="756f" class="lw lx it of b gy oj ok l ol om">{"prediction": "1"}</span></pre><p id="5cd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！您已经部署了您的第一个无服务器 ML 应用程序！</p></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h1 id="eece" class="nm lx it bd ly nn no np mb nq nr ns me jz nt ka mh kc nu kd mk kf nv kg mn nw bi translated">结论</h1><p id="895b" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">如您所见，在无服务器架构上部署 ML 绝非易事。</p><p id="e4d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们所走过的例子非常简单；我们甚至跳过了 API 认证，因为我不想偏离核心课程。</p><p id="dc80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于生产无服务器 ML 的例子并不多，所以我希望这有助于加速你的学习过程。</p><p id="ab64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我完全期待在未来我们会看到更多更好的生产 ML 的工具。但在此之前，基础设施将与模型部署紧密结合。</p><p id="01c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你觉得这很有用。一如既往，如果你遇到困难，请告诉我，我会尽力帮助你！</p></div></div>    
</body>
</html>