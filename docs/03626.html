<html>
<head>
<title>How to use AWS Lambda and CloudWatch for beginners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">新手如何使用AWS Lambda和CloudWatch</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-aws-lambda-and-cloudwatch-for-beginner-67df0755922e?source=collection_archive---------43-----------------------#2020-04-05">https://towardsdatascience.com/how-to-use-aws-lambda-and-cloudwatch-for-beginner-67df0755922e?source=collection_archive---------43-----------------------#2020-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b32e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们使用AWS服务构建一个简单的无服务器工作流！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/59ae1f1be133dfe84eaa7082d6a96898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9DGlj5gy17avdB8VdYsssw.jpeg"/></div></div></figure><p id="d4b2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我发现了一个很酷的网站(<a class="ae lq" href="https://covid19api.com/" rel="noopener ugc nofollow" target="_blank">https://covid19api.com/</a>)，在那里我们可以使用免费API轻松访问COVID19数据。这给了我一个想法，创建一个简单的函数来使用AWS Lambda获取数据，并将其保存到S3。该脚本将使用CloudWatch每天自动执行。</p><p id="84b9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以下是我需要完成的任务列表:</p><ol class=""><li id="2081" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><strong class="kw iu">写一个函数来检索数据并保存到S3。</strong></li><li id="44d7" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">将函数部署为AWS Lambda函数。</strong></li><li id="4e65" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">在AWS CloudWatch上创建一个事件，定时运行该功能。</strong></li></ol><p id="5f7c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以，让我们开始吧！</p><ol class=""><li id="01c6" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><strong class="kw iu">编写一个函数来检索数据并保存到S3。</strong></li></ol><p id="89d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一开始，我编写代码来检索本地计算机上的数据。下面是代码和结果:</p><pre class="kj kk kl km gt mf mg mh mi aw mj bi"><span id="1ddb" class="mk ml it mg b gy mm mn l mo mp">import requests<br/>import pandas as pd<br/>from pandas.io.json import json_normalize<br/>baseUrl = "<a class="ae lq" href="https://api.covid19api.com/total/dayone/country/indonesia/status/confirmed" rel="noopener ugc nofollow" target="_blank">https://api.covid19api.com/total/dayone/country/indonesia/status/confirmed</a>"<br/>response = requests.get(baseUrl)<br/>df = json_normalize(response.json())<br/>df['change (%)'] = df['Cases'].pct_change()*100</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mq"><img src="../Images/9c12a7cd9d07032b400edb094e545d01.png" data-original-src="https://miro.medium.com/v2/format:webp/1*thT7rn0tTiiusJvg6c2JAA.png"/></div></figure><p id="cd95" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如您所见，脚本运行良好。接下来，我们需要将脚本放在<a class="ae lq" href="https://docs.aws.amazon.com/lambda/latest/dg/python-programming-model-handler-types.html" rel="noopener ugc nofollow" target="_blank">处理函数</a>上，这是Lambda将要执行的函数。</p><pre class="kj kk kl km gt mf mg mh mi aw mj bi"><span id="408b" class="mk ml it mg b gy mm mn l mo mp">import requests<br/>import pandas as pd<br/>from pandas import json_normalize<br/>import boto3<br/>from datetime import datetime<br/>from io import StringIO </span><span id="ca15" class="mk ml it mg b gy mr mn l mo mp">def lambda_handler(event, context):<br/>    <br/>    baseUrl = "<a class="ae lq" href="https://api.covid19api.com/total/dayone/country/indonesia/status/confirmed" rel="noopener ugc nofollow" target="_blank">https://api.covid19api.com/total/dayone/country/indonesia/status/confirmed</a>"<br/>    response = requests.get(baseUrl)<br/>    df = json_normalize(response.json())<br/>    df['change (%)'] = df['Cases'].pct_change()*100<br/>    <br/>    <br/>    bucketname = 'my-beautiful-bucket'<br/>    filename = 'corona_dataset.csv'<br/>    <br/>    csv_buffer = StringIO()<br/>    df.to_csv(csv_buffer)<br/>    <br/>    client = boto3.client('s3')<br/>    <br/>    response = client.put_object(<br/>        ACL = 'private',<br/>        Body= csv_buffer.getvalue(),<br/>        Bucket= bucketname,<br/>        Key= filename<br/>    )</span></pre><p id="03cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我添加了两个新的库，即boto3和StringIo，我还添加了脚本来将数据帧转换为csv，并将其保存到我的s3存储桶中，名为“my-beautiful-bucket”。复制这个脚本并保存到一个名为lambda_function的. py文件中。</p><p id="6014" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> 2。将函数部署为AWS Lambda函数。</strong></p><p id="7a54" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">由于AWS Lambda不包括外部python库，我们不能只部署<code class="fe ms mt mu mg b">lambda_function.py</code>。我们需要将<code class="fe ms mt mu mg b">lambda_function.py</code>和所有那些库压缩成一个。zip文件。</p><p id="068c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以接下来要做的是创建一个新目录，并将<code class="fe ms mt mu mg b">lambda_function.py</code>文件放入这个新目录。对于windows用户，打开命令提示符并转到我们刚刚创建的目录，使用<a class="ae lq" href="https://pypi.org/project/pip/" rel="noopener ugc nofollow" target="_blank"> pip </a>将所有库安装到本地目录:</p><pre class="kj kk kl km gt mf mg mh mi aw mj bi"><span id="2505" class="mk ml it mg b gy mm mn l mo mp">pip install -t . pandas</span></pre><p id="fa40" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在有一个棘手的部分，因为AWS Lambda使用亚马逊Linux作为操作系统。所以我们需要兼容Linux的熊猫和Numpy。</p><p id="9148" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要解决这个问题，首先移除移除<code class="fe ms mt mu mg b">pandas</code>、<code class="fe ms mt mu mg b">numpy</code>、<code class="fe ms mt mu mg b">*.dist-info</code>和<code class="fe ms mt mu mg b">__pycache__ </code>。接下来就是打开<a class="ae lq" href="https://pypi.org/project/pandas/#files" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/pandas/#files</a>下载最新的<code class="fe ms mt mu mg b">*manylinux1_x86_64.whl</code>包。Numpy也是一样:打开<a class="ae lq" href="https://pypi.org/project/numpy/#files" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/numpy/#files</a>下载最新的Linux兼容包。两者都提取。whl文件放在我们的目录中，并将其全部压缩到一个新的。zp文件(注意:不要忘记删除whl文件、<code class="fe ms mt mu mg b">*.dist-info</code>和<code class="fe ms mt mu mg b">__pycache__</code>。):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/1d6d425bff0637a6b44dfdf92041cad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*chX2_0FBW_jw3OETJ6lI3g.png"/></div></div></figure><p id="9023" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在是时候创建一个Lambda函数了，登录你的AWS账户，找到Lambda服务，打开它，创建一个函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/4b4f1b026aadd769bb1ff98c88b695d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKDya_ywU9bYYA6hDTp6wg.png"/></div></div></figure><p id="ce7e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，进入函数内部，选择“上传. zip文件”作为代码输入类型，单击上传按钮，选择。zip文件并单击save按钮来部署它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/1a4ec8fcd247de39aa4ed2911c12b498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r3ProyRs2P01rIo160SNZQ.png"/></div></div></figure><p id="e752" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果。压缩文件太大，我们可以把它上传到我们的S3桶，然后上传。来自亚马逊S3的zip文件。单击测试按钮运行脚本。</p><p id="9bd3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> 3。在AWS CloudWatch上创建一个事件，以便按计划运行该功能。</strong></p><p id="49e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设我希望我的函数在每天10:00 GMT运行。转到CloudWatch服务，单击规则，然后单击创建规则按钮。选择Schedule然后选择Cron expression而不是Fixed rate，然后输入0 10 * *？0 10 * * ?*在文本框中，这意味着它将在每天10:00 GMT运行。选择我们的Lambda函数，单击configure details按钮，键入事件的名称，最后单击create rule按钮创建事件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/cf035b56dca66ba93fdcc46b655e1f07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iatvBG3N4b2T-af6ltHOAw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/efbef88e88f4e430f6d48cdac39b6285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CQAibtGBDWTlOsK36_OMpA.png"/></div></div></figure><p id="2291" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">希望每一个读这篇文章的人都会觉得有用。当然，还有其他的AWS服务可以包含在这个项目中，使它变得更好，例如AWS Athena在S3使用SQL语言分析数据，AWS QuickSight创建和分析数据的可视化。随意探索！</p></div></div>    
</body>
</html>