<html>
<head>
<title>How to use the Microsoft identity platform in your Azure web app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在您的 Azure web 应用中使用 Microsoft 身份平台</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-the-microsoft-identity-platform-in-your-azure-web-app-fcb3839a44e5?source=collection_archive---------26-----------------------#2020-07-19">https://towardsdatascience.com/how-to-use-the-microsoft-identity-platform-in-your-azure-web-app-fcb3839a44e5?source=collection_archive---------26-----------------------#2020-07-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1c31" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过身份、角色和权限管理对应用的访问</h2></div><h1 id="84c5" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">介绍</h1><p id="a34a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae lw" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-overview" rel="noopener ugc nofollow" target="_blank">微软身份平台</a>是安全访问您的网络应用的关键。用户可以使用他们的 Azure AD 身份或社交帐户对你的应用进行身份验证。授权模型可用于向您的后端应用程序或标准 API(如 Microsoft Graph)授予权限。在这篇博客中，我们讨论了一个 web 应用程序，它具有以下功能:</p><ul class=""><li id="7422" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">1.具有用户角色的 Azure AD 登录:基本或用户角色:高级</li><li id="d20a" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">2.使用已登录用户的委托权限访问 MS 图表</li><li id="e46f" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">3.使用应用程序权限和应用程序角色访问后端</li></ul><p id="1cb4" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">项目的代码可以在<a class="ae lw" href="https://github.com/rebremer/ms-identity-python-webapp-backend" rel="noopener ugc nofollow" target="_blank">这里找到</a>，架构可以在下面找到。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mq"><img src="../Images/fedce5e5f0c5f364a82b9d1bf96608b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GzYxgJ8dF62EXi_KPhCjWQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">项目架构，作者图片</p></figure><p id="ccbd" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">重点是提供一个使用微软身份平台的工作示例，并“弄脏你的手”。重点不是解释 OAuth 2.0 和 Azure AD 的内部工作方式。在本博客的剩余部分，将讨论以下内容。</p><ul class=""><li id="92d8" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">步骤 0:准备工作—设置前端和后端</li><li id="96c5" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">步骤 1:访问前端— Azure AD 登录，添加用户角色</li><li id="421e" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">步骤 2:访问图表-委托权限检索用户详细信息</li><li id="ff13" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">步骤 3:访问后端—应用程序检索数据的权限</li><li id="c0ac" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">杂项:配置项目的其他可能性</li><li id="b80d" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">结论</li></ul><p id="f9e2" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">要了解如何使用授权或应用程序权限访问 Azure SQL 数据库，请参见我之前的<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-overview" rel="noopener ugc nofollow" target="_blank">博客</a>。注意，两个博客共享同一个 git repo，所以这个项目可以配置为访问 Azure SQL，而不是后端应用程序。</p><h1 id="8b36" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 0。准备工作—设置前端和后端</h1><p id="fe61" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这个示例展示了如何使用 Flask 和 MSAL Python 构建 Python 前端 web 应用程序，以及如何使用 Azure 函数构建后端应用程序。在该步骤中，执行以下子步骤:</p><ul class=""><li id="38a8" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">0.1:创建前端 web 应用程序</li><li id="782c" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">0.2:创建和配置前端应用程序注册</li><li id="351d" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">0.3.创建后端 Azure 功能</li><li id="a908" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">0.4:配置 python webapp 项目</li><li id="fe39" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">0.5:运行示例</li><li id="979a" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">0.6:(可选)将前端 web 应用部署到 Azure</li></ul><h2 id="23b8" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.1:创建前端 web 应用程序</h2><p id="d590" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">若要运行此示例，您需要在本地安装它:</p><ul class=""><li id="f72f" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated"><a class="ae lw" href="https://www.python.org/downloads/release/python-2713/" rel="noopener ugc nofollow" target="_blank"> Python 2.7+ </a>或<a class="ae lw" href="https://www.python.org/downloads/release/python-364/" rel="noopener ugc nofollow" target="_blank"> Python 3+ </a></li><li id="7138" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">Azure 活动目录(Azure AD)租户。有关如何获得 Azure AD 租户的更多信息，请参见<a class="ae lw" href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-create-new-tenant" rel="noopener ugc nofollow" target="_blank">如何获得 Azure AD 租户。</a></li><li id="346f" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">Git 克隆下面的项目:<code class="fe ns nt nu nv b">git clone https://github.com/rebremer/ms-identity-python-webapp-backend.git</code>或者下载并解压存储库。zip 文件。</li></ul><h2 id="9801" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.2:创建和配置应用程序注册</h2><p id="c759" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">创建和配置应用程序注册，如下所示:</p><ul class=""><li id="1b56" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">使用此<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app" rel="noopener ugc nofollow" target="_blank">链接</a>中的步骤创建应用注册以创建应用注册。两个备注:</li><li id="afc3" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">使用<code class="fe ns nt nu nv b">http://localhost/getAToken</code>作为回复网址。如果您在创建过程中没有这样做，可以使用应用程序注册的<strong class="lc iu">验证</strong>选项卡添加它</li><li id="d06e" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">转到<strong class="lc iu">认证</strong>并启用隐式授权中的选项 ID 令牌</li><li id="53f1" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">转到<strong class="lc iu">证书&amp;秘密</strong>创建一个秘密。复制客户端 id 和客户端密码</li></ul><h2 id="487d" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.3:创建后端 Azure 函数</h2><p id="9919" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一部分，将部署 Azure 功能。这是按如下方式完成的:</p><ul class=""><li id="cb4f" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">使用这个<a class="ae lw" href="https://github.com/MicrosoftDocs/azure-docs/blob/master/articles/azure-functions/functions-create-first-function-python.md" rel="noopener ugc nofollow" target="_blank">快速入门</a>在 python 中创建一个 Azure 函数。</li><li id="1a92" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">从<a class="ae lw" href="https://github.com/rebremer/ms-identity-python-webapp-backend/tree/master/blog-webappaad-backend" rel="noopener ugc nofollow" target="_blank"> git repo </a>更新<strong class="lc iu"> blog-webappaad-backend </strong>文件夹中的<code class="fe ns nt nu nv b">requirement.txt</code>和<code class="fe ns nt nu nv b">__init__.py</code>，再次发布功能</li><li id="4cfa" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">在此<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad#-configure-with-express-settings" rel="noopener ugc nofollow" target="_blank">快速入门</a>之后，使用快速设置在您的 Azure 功能中启用身份验证/授权。</li></ul><h2 id="7006" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.4:配置 pythonwebapp 项目</h2><ol class=""><li id="c78b" class="lx ly it lc b ld le lg lh lj nw ln nx lr ny lv nz mf mg mh bi translated">打开<code class="fe ns nt nu nv b">app_config.py</code>文件，改变下面的变量。</li><li id="b48d" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv nz mf mg mh bi translated">在步骤 1.2 中创建应用程序注册时，找到文本<code class="fe ns nt nu nv b">&lt;&lt;Enter_the_Client_Secret_here&gt;&gt; </code>，并将其替换为您的应用程序密码。</li><li id="3c3f" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv nz mf mg mh bi translated">找到文本<code class="fe ns nt nu nv b">&lt;&lt;Enter_the_Tenant_Name_Here&gt;&gt;</code>并用您的 Azure AD 租户名称替换现有值。</li><li id="af76" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv nz mf mg mh bi translated">找到文本<code class="fe ns nt nu nv b">&lt;&lt;Enter_the_Application_Id_here&gt;&gt;</code>并用步骤 1.2 中应用程序注册的应用程序 ID (clientId)替换现有值。</li><li id="bab5" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv nz mf mg mh bi translated">查找文本<code class="fe ns nt nu nv b">&lt;&lt;your Azure Function&gt;&gt;</code>和<code class="fe ns nt nu nv b">&lt;&lt;your secret&gt;&gt;</code>用步骤 1.3 中创建的 Azure 函数替换现有值。</li></ol><h2 id="c956" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.5:运行示例</h2><p id="a51c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">您需要使用 pip 安装依赖项，如下所示:</p><pre class="mr ms mt mu gt oa nv ob oc aw od bi"><span id="a552" class="ng kj it nv b gy oe of l og oh">$ pip install -r requirements.txt</span></pre><p id="633f" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">使用以下命令从 shell 或命令行运行 app.py:</p><pre class="mr ms mt mu gt oa nv ob oc aw od bi"><span id="98b1" class="ng kj it nv b gy oe of l og oh">flask run --host localhost --port 5000</span></pre><p id="f9ba" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">当 app 在本地运行时，可以通过 localhost:5000(不是 127.0.0.1:5000)访问。步骤 1 之后，用户可以使用他们的 Azure AD 凭据登录，并从后端检索数据。</p><h2 id="1f3b" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">0.6:(可选)将前端 web 应用部署到 Azure</h2><p id="4497" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最后，请看<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/app-service/containers/quickstart-python?tabs=bash#deploy-the-sample" rel="noopener ugc nofollow" target="_blank">这个</a>链接如何在 Azure web 应用中部署你的前端 flask 应用。部署代码的最简单方法是从放置 app.py 的目录中运行以下命令:</p><pre class="mr ms mt mu gt oa nv ob oc aw od bi"><span id="0063" class="ng kj it nv b gy oe of l og oh">az webapp up -n &lt;&lt;your unique webapp&gt;&gt; --sku F1</span></pre><p id="5fc1" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">确保将<code class="fe ns nt nu nv b">https://&lt;&lt;your uniquewebapp&gt;&gt;.azurewebsites.net/getAToken</code>添加为回复 URL。当您登录并点击链接从 backed 中检索数据时，应显示以下屏幕:</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oi"><img src="../Images/e6c647f758b039a1230c21a7691f5a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*taMwc8W7V6YOojLL9GnnQg.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">0.6.从后端成功检索到数据</p></figure><p id="bd67" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">然而，为了能够执行本教程的剩余步骤，也可以使用 localhost。</p><h1 id="289b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 1:访问前端— AAD 登录，添加角色</h1><p id="979b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在此步骤中，将为用户分配一个角色，以指示其是基本用户还是高级用户。执行以下子步骤:</p><ul class=""><li id="8e8b" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">1.1:在应用配置中设置配置</li><li id="8a37" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">1.2:向清单添加角色</li><li id="c5bc" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">1.3:为用户分配高级角色</li></ul><p id="bac9" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">步骤 1 关注架构的以下部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oj"><img src="../Images/1cdc1a29af384f1f59ec14bd5aec01f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gPebQxlN1N31ob3nacheEg.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">1.Azure 广告登录，配置用户角色，按作者分类的图片</p></figure><h2 id="5db7" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.1:在应用配置中设置配置</h2><p id="ba9b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">索赔验证是一个可选步骤，可以使用<code class="fe ns nt nu nv b">app_config.py</code>文件中的以下设置启用:<code class="fe ns nt nu nv b">AAD_ROLE_CHECK = True</code>。</p><h2 id="2a6a" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.2:向清单添加角色</h2><p id="4f31" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">按照本教程<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps" rel="noopener ugc nofollow" target="_blank">中的步骤，向步骤 1.2 中创建的应用程序注册添加角色。显然，应使用以下方法:</a></p><pre class="mr ms mt mu gt oa nv ob oc aw od bi"><span id="835a" class="ng kj it nv b gy oe of l og oh">"appRoles": [<br/>  {<br/>    "allowedMemberTypes": ["User"],<br/>    "description": "Basic user, read product data from backend",<br/>    "displayName": "basic_user_access",<br/>    "id": "a8161423-2e8e-46c4-9997-f984faccb625",<br/>    "isEnabled": true,<br/>    "value": "basic_user_access"<br/>  },<br/>  {<br/>    "allowedMemberTypes": ["User"],<br/>    "description": "Premium user, read all data from backend",<br/>    "displayName": "premium_user_access",<br/>    "id": "b8161423-2e8e-46c4-9997-f984faccb625",<br/>    "isEnabled": true,<br/>    "value": "premium_user_access"<br/>  }<br/>],</span></pre><h2 id="7f15" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">1.3:将用户分配给角色</h2><p id="d8d5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps#assign-users-and-groups-to-roles" rel="noopener ugc nofollow" target="_blank">链接</a>中解释了用户的分配。作为测试，可以创建两个用户。用户 1 被分配了<code class="fe ns nt nu nv b">basic_user_access</code>，而用户 2 获得了<code class="fe ns nt nu nv b">premium_user_access</code>角色，另请参见下面的屏幕截图，其中 admin、student2 被分配了高级角色，而 student 1 只有基本角色。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ok"><img src="../Images/8233d46089bc7dce53c7bc1ae1351027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NlsVyG6PTN8VNU-4J7ULUQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">1.3a .分配给用户的角色</p></figure><p id="2217" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">如果学生点击客户链接，对后端的访问将被前端拒绝，另请参见下面的消息。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ol"><img src="../Images/352aef7d8ff0aef87ab7255649cc970f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F0dpGasU3i5ZU4LtfII-QA.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">1.3b .角色为“基本拒绝访问”的用户</p></figure><p id="2580" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">在下一步中，使用 Microsoft Graph API 检索用户数据。</p><h1 id="c002" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">第二步。对图表的访问-委托权限</h1><p id="74f0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae lw" href="https://docs.microsoft.com/en-us/graph/azuread-users-concept-overview?view=graph-rest-1.0" rel="noopener ugc nofollow" target="_blank">用户</a>是 Azure 广告公司或学校用户帐户或 Microsoft Graph 中的 Microsoft 帐户的表示。在这个步骤中，使用<code class="fe ns nt nu nv b">users.read</code>范围，使用登录用户的委托权限来检索自己的数据。执行以下子步骤:</p><ul class=""><li id="8f5e" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">2.1:验证应用注册中的权限</li><li id="5633" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">2.2:检索数据</li></ul><p id="4691" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">第 2 步关注架构的后续部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi om"><img src="../Images/696f4e043769be7fe332fe764b83a4fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oA2s9M-J3uBClG2VDzTk6A.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">2.委托权限，按作者获取图表数据、图像</p></figure><h2 id="53f6" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">2.1:验证应用注册中的权限</h2><p id="bb18" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">应用程序注册需要同意从 Microsoft Graph 读取用户数据。根据 Azure AD 配置，以下类型的同意是可能的:</p><ul class=""><li id="49e0" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">管理员同意:管理员已经同意应用程序可以代表登录的用户读取用户的数据。这种同意可以事先在应用程序注册权限中完成，也可以在管理员首次登录 web 应用程序时完成。</li><li id="7246" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">用户同意:An uses 本人已经同意 app 可以代表登录用户读取用户的数据。一旦用户第一次登录应用程序，这种同意就完成了</li></ul><p id="5199" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">在这种情况下，使用事先完成的管理员许可。请参阅下面的 users.read 权限是在应用程序注册中授予的:</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi on"><img src="../Images/1fb1d9f0b0f0913187f8525f825a3248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfjuhajVmJef63kbTVhOXg.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">2.1a .用户。读入应用程序注册管理员同意书</p></figure><p id="8fe2" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">随后，在 app 注册的附着企业应用中验证 App 可以代表用户读取用户的数据。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oo"><img src="../Images/13226214e2089b6be8be8339510e9cd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-SKHMdjm5b4BTe5jlxcPw.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">2.1b .用户。读入应用程序注册管理员同意书</p></figure><p id="fcb9" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">注意那个用户。只读允许用户检索他自己的数据，而不是其他人的数据(只有有权限的用户才能这样做。Read.All)</p><h2 id="2474" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">2.2:检索图形数据</h2><p id="87ed" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">一旦应用程序获得用户同意或管理员同意检索数据，只需登录并单击链接调用 Microsoft Graph API，用户自己的数据就会返回，也见下文。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi op"><img src="../Images/5f1bf7fe103a18b90a53d516698e1901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*02_L4lT5-SkffjNC-rZ9BQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">2.2.图形调用返回用户数据</p></figure><h1 id="d94c" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">第三步。访问后端—应用程序权限</h1><p id="9e55" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在步骤 1 中，已经从后端检索了数据。然而，不仅前端可以从后端检索数据，同一 Azure AD 租户内的所有身份都可以检索数据。使用应用程序权限和用户分配，确保只有前端可以访问后端。</p><p id="f197" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">执行以下子步骤:</p><ul class=""><li id="ccfe" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">3.1:向后端和前端添加应用程序权限</li><li id="cb75" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">3.2:在后端启用用户分配</li></ul><p id="285a" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">第 3 步关注架构的后续部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi om"><img src="../Images/696f4e043769be7fe332fe764b83a4fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oA2s9M-J3uBClG2VDzTk6A.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">3.应用程序权限，配置应用程序角色，按作者分类的图像</p></figure><h2 id="be82" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">3.1:向后端和前端添加应用程序权限</h2><p id="6080" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到后端应用程序注册清单，并将以下应用程序角色添加到清单中。</p><pre class="mr ms mt mu gt oa nv ob oc aw od bi"><span id="0d03" class="ng kj it nv b gy oe of l og oh">"appRoles": [<br/>  {<br/>    "allowedMemberTypes": ["Application"],<br/>    "description": "frontend_app_access",<br/>    "displayName": "frontend_app_access",<br/>    "id": "f8161423-2e8e-46c4-9997-f984faccb625",<br/>    "isEnabled": true,<br/>    "value": "frontend_app_access"<br/>  },</span></pre><p id="bfa4" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">随后，进入前端的应用注册，点击 API 权限，将这些权限授予你的前端应用，也见下文。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oq"><img src="../Images/78dedf812f9dcd4461b4673951b8d8e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ge2eZvV2BfTN3EGv0TFl8Q.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">3.1a .在前端授予应用程序权限</p></figure><p id="f6cc" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">随后，授予管理员权限，以便前端可以使用应用程序角色 front_end_access 访问后端。要验证前端是否具有应用程序角色 front_end_access，请转到后端应用程序注册、企业应用程序并查找用户/组，另请参见下文。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi or"><img src="../Images/6a624ca69a74e21ec9a51b8818a6097c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IsIRlreLyk2tF-X5n7jNKQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">3.1b .后端的应用程序角色</p></figure><p id="53f4" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">请注意，角色 front_end_access 没有明确显示，但在 3.2 中将会显示该角色。</p><h2 id="7e79" class="ng kj it bd kk nh ni dn ko nj nk dp ks lj nl nm ku ln nn no kw lr np nq ky nr bi translated">3.2:在后端启用用户分配</h2><p id="cf24" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的后端应用程序注册，企业应用程序，并寻找属性和启用用户分配，也见下文。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi os"><img src="../Images/935221c7e82d34397fe0bf4d46aee4c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hEkS-HMOYJNwD9yuuGr9Gw.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">3.2a .后端中的应用程序角色</p></figure><p id="7514" class="pw-post-body-paragraph la lb it lc b ld lz ju lf lg ma jx li lj mn ll lm ln mo lp lq lr mp lt lu lv im bi translated">启用此属性时，前端是唯一可以从后端检索数据的应用程序，另请参见下面显示角色的位置</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ot"><img src="../Images/5d6c3557aba234c038498a1e5a17d7a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CNgoneMm-BmO4wnsTJehIA.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">3.2b .显示的前端应用访问角色</p></figure><h1 id="d913" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">多方面的</h1><p id="2358" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">属于这个项目的 git repo 有额外的配置选项，讨论如下:</p><ul class=""><li id="e450" class="lx ly it lc b ld lz lg ma lj mb ln mc lr md lv me mf mg mh bi translated">通过在 appconfig 中设置<code class="fe ns nt nu nv b">DAEMON_ENABLED=True</code>，可以将应用程序配置为守护程序应用程序。用户不必再登录来检索数据。</li><li id="44f6" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">通过在 appconfig 中设置<code class="fe ns nt nu nv b">Option 2b. Database</code>，Azure SQL 数据库可以用作后端，而不是 Azure 函数。详见<a class="ae lw" rel="noopener" target="_blank" href="/how-to-secure-python-flask-web-apis-with-azure-ad-14b46b8abf22">这篇</a>博客。</li><li id="01e5" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">在应用程序配置中使用<code class="fe ns nt nu nv b">Option 3b. Delegated user is used to authenticate to backend</code>,委托权限用于对后端而不是应用程序权限进行认证。</li><li id="c965" class="lx ly it lc b ld mi lg mj lj mk ln ml lr mm lv me mf mg mh bi translated">这篇博客中的第 3 步可以通过调整这个<a class="ae lw" href="https://github.com/rebremer/managed_identity_authentication/blob/master/AAD_auth_ADFv2_MI_to_Azure_Function.ps1" rel="noopener ugc nofollow" target="_blank"> git repo </a>中的 Power Shell 脚本来实现自动化。</li></ul><h1 id="53aa" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="d6f2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Microsoft identity platform 可以帮助您保护对应用程序的访问。在这篇博客中，提供了一个具体的例子，它使用 Azure AD 以“基本”或“高级”用户角色登录用户。随后，登录用户的委托权限用于检索 Microsoft Graph 数据，应用程序权限用于访问后端，另请参见下面的架构。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mq"><img src="../Images/fedce5e5f0c5f364a82b9d1bf96608b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GzYxgJ8dF62EXi_KPhCjWQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">项目架构，作者图片</p></figure></div></div>    
</body>
</html>