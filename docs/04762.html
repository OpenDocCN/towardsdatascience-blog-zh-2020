<html>
<head>
<title>Visualizing Revenues of German Car Suppliers in Python’s Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python的Plotly中可视化德国汽车供应商的收入</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualizing-revenues-of-german-car-suppliers-in-pythons-plotly-9c90610af4f1?source=collection_archive---------55-----------------------#2020-04-26">https://towardsdatascience.com/visualizing-revenues-of-german-car-suppliers-in-pythons-plotly-9c90610af4f1?source=collection_archive---------55-----------------------#2020-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4e56e46853a376b591929b469decc535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztKMzmfkcO1LOyztQFsQsg.jpeg"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">初升的太阳从<a class="ae kc" href="http://images.unsplash.com/photo-1513010963904-2fefe6a92780?ixlib=rb-0.3.5&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=1080&amp;fit=max&amp;s=b3fca9d9fbd9d1e9bbee5379f3e45ce3" rel="noopener ugc nofollow" target="_blank">升起</a></p></figure><p id="60da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如今，数据无处不在，让<em class="lb">每个人</em>都能访问数据是必不可少的一步，不管他们的专业背景如何。</p><p id="a122" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">手动分析表格数据是极其讨厌的，肯定不会引起任何人的注意。</p><p id="448a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事情不一定要这样。</p><p id="0d70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完全相同的数据可以以奇特的方式可视化，甚至非数据科学家也渴望一睹这些令人钦佩的情节。</p><p id="3ecb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果每个人眼前都有一个有意义的图表，而不是枯燥的表格，那么用数据来销售一个故事就会变得容易得多。</p><p id="16b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与表格相比，拥有一个漂亮而干净的图表可以更快地浏览手头的数据，提供更好的交互机会，并且看起来非常漂亮。</p><p id="7168" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们点燃蜡烛。</p><p id="ac50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章使用了<a class="ae kc" href="https://www.listenchampion.de" rel="noopener ugc nofollow" target="_blank">listen campion</a><a class="ae kc" href="https://www.listenchampion.de)," rel="noopener ugc nofollow" target="_blank">，</a>的一小段数据，这是一家提供特定市场列表的领先公司，对于可视化和分析目的来说是最佳的。非常感谢它的团队为我提供了这个列表，并允许发表对它的分析。</p><p id="d6d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当以正确的方式可视化数据时，用数据说服人们会变得简单。我的正道是<em class="lb"> Python的Plotly </em>库。与matplotlib相比，它的视觉效果一流，响应速度也很快，因此它是我在Python中实现可视化的首选库。</p><p id="d4a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们必须对手头的数据有一个概念，所以让我们检查一下我们的代码片段提供了什么:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lc"><img src="../Images/37089cee19b5cc9b028f006df0b38ce7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8XoOGgYdq2MUS_lAvlPAGw.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">关于手头数据集的信息</p></figure><p id="630e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">令人兴奋的是，德国20大汽车供应商名单。二十个条目足够小，甚至对人类友好，但是，想想一个有几千个条目的列表，事情会变得很快变得很糟糕。这就是为什么Python和Plotly是分析和可视化数据的好方法。</p><p id="35b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该数据集包括公司地址、员工人数、2015年至2018年的收入、首席执行官、联邦州、联系人等信息。</p><p id="9eea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在世界地图上显示这些公司，有必要以经度-纬度格式提取它们的地理位置。幸运的是，我们有一个给定的地址，可以进一步用来获得地理坐标。因此，<a class="ae kc" href="https://developers.google.com/maps/documentation/geolocation/intro" rel="noopener ugc nofollow" target="_blank">谷歌地理位置API </a>来得非常方便。初次登录时，您还可以获得最初的300美元，这对于任何较小的项目来说都足够了。</p><p id="54ff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么，让我们得到这些地址的地理坐标(经度，纬度):</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="6c8b" class="lm ln iq li b gy lo lp l lq lr">import googlemaps<br/>gmaps = googlemaps.Client(MAPS_KEY)</span><span id="b352" class="lm ln iq li b gy ls lp l lq lr">def get_coordinates(plz_string):<br/>```<br/>convert zip code into geo coordinates.</span><span id="43db" class="lm ln iq li b gy ls lp l lq lr">Input:<br/>plz_string: string with the zip code + country location, i.e. 75242 Germany, or 94086 USA<br/>```</span><span id="fa00" class="lm ln iq li b gy ls lp l lq lr">   location = gmaps.geocode(plz_string)<br/>   try:<br/>      lon = location[0][“geometry”][“location”][“lng”]<br/>      lat = location[0][“geometry”][“location”][“lat”]<br/>   except:<br/>      lon = None<br/>      lat = None<br/>      print(“Something went wrong with: {}”.format(plz_string))<br/>   return lat, lon</span><span id="a092" class="lm ln iq li b gy ls lp l lq lr">df[‘location’] = df[“PLZ”].apply(lambda x: str(x) + “, Germany”)<br/>df[‘lat / lon’] = df[‘location’].apply(lambda x: get_coordinates(x))</span></pre><p id="f15b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这太神奇了，在几分钟内，我们已经将邮政编码转换成地理坐标，这使我们能够在地图上标出确切的位置。</p><p id="4456" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了这些简洁的坐标，让我们进入这篇文章的核心，用最好的方式使用Plotly的功能。</p><p id="ddc4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我为建议和改进而高兴，也为你指出的每一个代码垃圾而高兴。</p><p id="b4c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Plotly提供了各种可以使用的地图，如chloropleth地图、地图框或散点图。我将利用后者。</p><p id="a152" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在的问题是，你想把公司总部的位置形象化吗？因此，我将从我们的数据中列出的他们过去两次录音(2018-2017)的收入差异入手。我还根据联邦州、公司规模或他们运营的分支机构进行了可视化。查看<a class="ae kc" href="https://github.com/lenlehm/Plotly_Vizualization" rel="noopener ugc nofollow" target="_blank">我的github，包括整个笔记本</a>。</p><p id="2585" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，为了简单和美观，我将只带您进行收入发展之旅。请随意实现其他版本或提出更有创意的想法来可视化该数据集。</p><p id="5c07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我向你展示情节之前，请记住，这些是汽车供应商，没有谷歌或亚马逊。他们的收入可能会让你震惊。</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="0753" class="lm ln iq li b gy lo lp l lq lr">scale = 56<br/>revenue = go.Figure()</span><span id="d806" class="lm ln iq li b gy ls lp l lq lr">for diff in list(df[colName]):<br/>    ## create sub dataframe containing the 16 federal states in Germany<br/>    df_sub = df[df[colName] == diff]<br/>    ## plot the bubbles on the map<br/>    revenue.add_trace(go.Scattergeo(<br/>        locationmode = 'geojson-id',<br/>        lon = df_sub['longitude'],<br/>        lat = df_sub['latitude'],<br/>        name = df_sub['Unternehmen'].values[0],<br/>        hovertemplate = "&lt;b&gt;{} &lt;/b&gt;&lt;br&gt;&lt;br&gt;".format(df_sub['Unternehmen'].values[0]) +<br/>                        "Rev. Difference: {}&lt;br&gt;".format(diff) +<br/>                        "# Employees: {}&lt;br&gt;".format(df_sub["Mitarbeiter"].values[0]) ,<br/>        marker = dict(<br/>            ## scale the bubble size properly, to at least have a size of 5<br/>            size = diff/scale if (diff/scale) &gt; 6 else 7,<br/>            line_color='rgb(40,40,40)',<br/>            line_width=0.4,<br/>            color = df_sub['color'],<br/>            sizemode = 'area'<br/>        )))</span><span id="0531" class="lm ln iq li b gy ls lp l lq lr">## get the layout right<br/>revenue.update_layout(<br/>        #title_text = 'Revenue Difference [in Mio. €] from 2017 to 2018 of selected automotive suppliers',<br/>        showlegend = True,<br/>    <br/>    geo = go.layout.Geo(<br/>        resolution = 50,<br/>        scope = 'europe',<br/>        showframe = False,<br/>        showcoastlines = True,<br/>        landcolor = "rgb(229, 229, 229)",<br/>        countrycolor = "white" ,<br/>        coastlinecolor = "white",<br/>        projection_type = 'mercator',<br/>        ## limit our projection to Germany only<br/>        lonaxis_range= [ 5.0, 15.0 ],<br/>        lataxis_range= [ 47.0, 55.0 ],<br/>        ## center the projection at Germany's center coordinates<br/>        center = {"lat": 50.757958, "lon": 10.266271},<br/>        domain = dict(x = [ 0, 1 ], y = [ 0, 1 ])<br/>    )<br/>)<br/>## enable and disable all the configurations we do not want to display<br/>config = dict({'scrollZoom':True, <br/>               'displayModeBar':False,<br/>               'showLink':False, <br/>               'displaylogo': False,<br/>               'editable': False})</span><span id="521a" class="lm ln iq li b gy ls lp l lq lr">## Save Plot on plotly account<br/>py.plot(revenue, filename = 'revenue difference map', auto_open=True, showLink=False, config=config)<br/>revenue.show()</span><span id="df18" class="lm ln iq li b gy ls lp l lq lr">## Also possible to save it as HTML and host it on github<br/>#pio.write_html(revenue, file=’biggest firms.html’, auto_open=True)</span></pre><figure class="ld le lf lg gt jr"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="ac24" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经有了一张所有20家公司的整洁地图，可以根据它们各自的公司名称进行过滤，如果有一条显示每家公司在记录年份的收入增长的线形曲线，那就太棒了。</p><p id="77f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要做到这一点，我们必须对我们的数据框架做一点小小的调整，将其变成不同的形状，我们将每家公司的记录年份作为x轴，将2015年至2018年的收入作为y轴。</p><p id="44d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是在下面完成的，我们循环遍历每一家公司，并强迫它进入正确的形状。如果你是虐待狂，那么这个解决方案可能适合你，然而，聪明的人会找到更有效的方法来达到同样的结果。</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="0a96" class="lm ln iq li b gy lo lp l lq lr">cols = ['Unternehmen', 'Umsatz 2015 (in Mio. €)', 'Umsatz 2016 (in Mio. €)', 'Umsatz 2017 (in Mio. €)', 'Umsatz 2018 (in Mio. €)']<br/>revenue_plot = df.loc[:, cols]<br/>## extract all the years, cast it to int and reverse the list to get [2015, 2016, 2017, 2018]<br/>years = [ int(ele[0]) for ele in list(filter(None, [ re.findall('\d+', string) for string in df.columns ]))][::-1]</span><span id="07a1" class="lm ln iq li b gy ls lp l lq lr">revenue_cruve = go.Figure()<br/>for i in range(len(revenue_plot)):<br/>    plot_df = pd.DataFrame(<br/>        {'Company': [revenue_plot.iloc[i, 0] for j in range(len(years))],<br/>         'Year': years,<br/>         'Revenue': list(revenue_plot.loc[i, ["Umsatz 2015 (in Mio. €)", 'Umsatz 2016 (in Mio. €)', 'Umsatz 2017 (in Mio. €)', 'Umsatz 2018 (in Mio. €)']]) },<br/>        columns = ['Company', 'Year', 'Revenue'])<br/>    revenue_cruve.add_trace(go.Scatter(<br/>                    x=plot_df['Year'],<br/>                    y=plot_df['Revenue'],<br/>                    name=plot_df['Company'][0],<br/>                    text =  '&lt;b&gt;{}&lt;/b&gt; &lt;br&gt;'.format(plot_df['Company'][0]) +<br/>                            'Revenue {}: {} &lt;br&gt;'.format(plot_df['Year'][0], plot_df['Revenue'][0]) +<br/>                            'Revenue {}: {} &lt;br&gt;'.format(plot_df['Year'][1], plot_df['Revenue'][1]) +<br/>                            'Revenue {}: {} &lt;br&gt;'.format(plot_df['Year'][2], plot_df['Revenue'][2]) +<br/>                            'Revenue {}: {}'.format(plot_df['Year'][3], plot_df['Revenue'][3])<br/>    ))</span><span id="f506" class="lm ln iq li b gy ls lp l lq lr">revenue_cruve.update_traces(mode="markers+lines",<br/>                            hovertemplate = None                           )<br/>    <br/>revenue_cruve.update_layout(<br/>    width = 1100,<br/>    height = 800,<br/>    legend_title='&lt;b&gt; Company &lt;/b&gt;',<br/>    <br/>    yaxis=dict(<br/>        title_text="Revenue in Mio. €",<br/>        titlefont=dict(size=22),<br/>    ),<br/>    xaxis = dict(<br/>        tickmode = 'linear',<br/>        tick0 = years[0],<br/>        dtick = 1)<br/>)<br/>config = dict({'scrollZoom':True, <br/>               'displayModeBar':False,<br/>               'showLink':False, <br/>               'displaylogo': False,<br/>               'editable': False})</span><span id="e5c6" class="lm ln iq li b gy ls lp l lq lr">py.plot(revenue_cruve, filename='revenue firms curve', auto_open=True, config=config)<br/>revenue_cruve.show()</span></pre><figure class="ld le lf lg gt jr"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="adc0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们甚至有了每家公司的收入线曲线图，之后我们还可以进行筛选。这使得一切更容易分析，我们不必手动仔细检查每一行。正如你可能看到的，20家公司会很快变得混乱不堪。减少混乱的另一个好方法是添加一个带有Plotly 的<a class="ae kc" href="https://plotly.com/python/dropdowns/" rel="noopener ugc nofollow" target="_blank">下拉按钮来选择感兴趣的公司。不幸的是，我还没有这样做，但这是一个很好的实践，以培养我们刚刚学到的东西。</a></p><p id="84c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可视化方法对于在公司范围内共享信息也非常方便，例如在时事通讯中。每个员工只需简单浏览一下就能获得关键信息。</p><p id="ebbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样，我希望你今天学到了一些新东西，这篇文章不会太无聊。无论如何，如果你有一些建议或发现错误，请让我知道。该代码可在我的github账户中获得。</p><p id="bde8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>