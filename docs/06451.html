<html>
<head>
<title>Trials and Tribulations: Using Keras on Colab and TPU</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">考验和磨难:在科拉布和TPU上使用Keras</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/trials-and-tribulations-using-keras-on-colab-and-tpu-69378762468d?source=collection_archive---------60-----------------------#2020-05-22">https://towardsdatascience.com/trials-and-tribulations-using-keras-on-colab-and-tpu-69378762468d?source=collection_archive---------60-----------------------#2020-05-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/da011357d1110aa22e120e969e4ccc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uIykHL9vkqk1GUXA"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">Max陈在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="e98d" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">延续<a class="ae jd" href="https://medium.com/@umash4/using-tpus-on-google-colab-966239d24573" rel="noopener"> <strong class="ak">之前的帖子</strong> </a>关于在Colab和TPU上试验Keras，同时尝试一些旧的NLP教程。在这篇文章中，我试图帮助我的业余爱好者节省一些时间和挫折。</h2></div><p id="7c4e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">根据上一篇文章中概述的设置，在160万条推文中训练情感分类器的速度非常快(每个时期大约500秒，而1.5小时)。然而，完整的训练仍然需要一个多小时。对于这一轮来说，81%的准确度就足够了。因此，我决定现在停止花时间在训练上，这样我就可以专注于进一步的实验。</p><p id="8602" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为此，我想将模型保存到磁盘(即映射的Google Drive)，这样每当我重新打开Colab时，我就可以加载模型并从我离开的地方继续。这比预期的要困难得多。我不得不尝试各种组合，然后才能满足于一个折衷的解决方案(使用h5格式保存到Google Drive )。</p><ol class=""><li id="bd22" class="lr ls jg kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">首先，我尝试在映射的Google Drive文件夹中使用<em class="ma"> model.save() </em>。出现以下错误:</li></ol><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a966" class="mk ml jg mg b gy mm mn l mo mp"><em class="ma">UnimplementedError: File system scheme ‘[local]’ not implemented.</em></span></pre><p id="8c71" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">2.显然，TPU训练过的SavedModel模型只能保存到谷歌云存储中。这让我开始了在google.cloud.storage API和各种gsutil命令中尝试blobs的徒劳之旅。用这些工具将模型(二进制格式)保存到GCS似乎是不可能的。</p><p id="a490" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我想到了最简单的解决方案——简单地使用<em class="ma">GS://&lt;bucket name&gt;/&lt;save folder&gt;"</em>作为调用<em class="ma"> model.save </em>的路径。虽然我可以保存它，装载它回来原来是一个全新的分支洞穴。</p><p id="ee9d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.我在运行<em class="ma"> load_model </em>时不断遇到这个错误:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9135" class="mk ml jg mg b gy mm mn l mo mp"><em class="ma">NotFoundError: Unsuccessful TensorSliceReader constructor</em></span></pre><p id="a55e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">显然，它无法在<em class="ma">变量/变量</em>文件夹中找到一些匹配的文件。这是真的，因为那个文件夹是空的，我不知道为什么tensorflow没有填充那个文件夹。那不是我能解决的问题。</p><p id="b243" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设这里引用的变量是优化器变量，我在保存时尝试了<em class="ma">include _ optimizer = False</em>。对错误没有影响。</p><p id="3644" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">4.接下来，我尝试了h5格式，理由是它是一个单独的文件，所以不需要处理丢失的文件夹和文件。这次尝试失败得很惨，因为这个错误导致我甚至无法保存文件:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="95a9" class="mk ml jg mg b gy mm mn l mo mp"><em class="ma">OSError: Unable to create file (unable to open file: name = ‘gs:&lt;savepath&gt;’, errno = 2, error message = ‘No such file or directory’, flags = 13, o_flags = 242)</em></span></pre><p id="9047" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">保存路径的目录存在，正在运行<em class="ma">！gsutil ls </em>命令<em class="ma">T3确认了这一点。该文件显然不存在，因为tensorflow尚未保存它。</em></p><p id="125a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为一个黑客实验，我复制了一个虚拟文件到那个位置，tensorflow可以覆盖它。没什么区别。</p><p id="7d7c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">5.接下来尝试将h5保存到本地映射的Google Drive，并加载回来，它工作得非常好。虽然我仍然在检查使用“旧的”h5格式会丢失什么，但这将是我目前默认的保存和加载方法。</p><p id="e516" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我没有尝试的一个选项是只使用<em class="ma"> save_weights() </em>调用，因为我想保存整个模型。</p><p id="4d44" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">再说一次，虽然训练中表现出色，使用TPU的愿望非常强烈，但实现这一愿望的途径却是一个绝对的雷区。讨论这些问题的一些线程已经运行了多年。我相信在某个地方会有解决办法。但我希望谷歌团队能尽快坐下来，写一本合适的剧本，帮助我们解决这些问题。</p></div></div>    
</body>
</html>