<html>
<head>
<title>Data Cleaning, Merging, and Wrangling in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R中的数据清理、合并和争论</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-cleaning-merging-and-wrangling-in-r-26c2cd3649f4?source=collection_archive---------31-----------------------#2020-02-04">https://towardsdatascience.com/data-cleaning-merging-and-wrangling-in-r-26c2cd3649f4?source=collection_archive---------31-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ec46" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这里有一些整理数据和在r中进行常见数据操作的有用技巧。</h2></div><p id="1d2f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在任何上下文中处理数据的一个大问题是数据清理和数据集合并的问题，因为通常情况下，您会发现自己必须整理多个文件中的数据，并且需要依赖R来执行通常在Excel中使用VLOOKUP等命令执行的功能。</p><p id="85e0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一些关于R如何用于数据操作的有用例子。虽然Python的pandas库传统上被认为是这一领域的赢家，但R经常使用的数据操作技术实际上非常强大。</p><p id="9c33" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们来看看其中的一些。</p><h1 id="f464" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">数据清理和合并功能</h1><p id="ee28" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">对于示例1–7，我们有两个数据集:</p><ul class=""><li id="86a9" class="mb mc it kk b kl km ko kp kr md kv me kz mf ld mg mh mi mj bi translated"><strong class="kk iu"> sales: </strong>该文件包含变量Date、ID(即产品ID)和sales。我们将它加载到R中，命名为mydata。</li><li id="7544" class="mb mc it kk b kl mk ko ml kr mm kv mn kz mo ld mg mh mi mj bi translated"><strong class="kk iu">客户:</strong>该文件包含变量ID、年龄和国家。我们将它加载到R中，命名为mydata2。</li></ul><p id="e7f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些数据集可以在下面的<a class="ae mp" href="https://github.com/MGCodesandStats/rtutorial-data-cleaning" rel="noopener ugc nofollow" target="_blank"> GitHub仓库</a>获得。</p><p id="d353" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是R中用来清理数据集的流行技术的例子，以及如何有效地格式化变量以方便分析。以下函数特别适用于面板数据集，其中混合了横截面和时间序列数据。</p><h2 id="f4dc" class="mq lf it bd lg mr ms dn lk mt mu dp lo kr mv mw lq kv mx my ls kz mz na lu nb bi translated"><strong class="ak"> 1。在数据帧中存储变量</strong></h2><p id="9588" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">从一个简单的例子开始，让我们选择客户数据集。假设我们只希望在数据中包含变量ID和Age。为此，我们将数据框定义如下:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="2958" class="mq lf it nh b gy nl nm l nn no">dataframe&lt;-data.frame(ID,Age)</span></pre><h2 id="428f" class="mq lf it bd lg mr ms dn lk mt mu dp lo kr mv mw lq kv mx my ls kz mz na lu nb bi translated"><strong class="ak"> 2。使用合并功能模拟VLOOKUP</strong></h2><p id="ce40" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">通常，有必要将不同数据集中的两个变量组合起来，类似于在Excel中使用VLOOKUP根据特定标准连接两个变量。如果你不熟悉VLOOKUP函数，你可能会发现Spreadsheeto的这个指南特别有用。</p><p id="6b16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在R中，这可以使用merge函数来完成。</p><p id="d906" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，假设我们希望将sales数据集中的Date变量与customers数据集中的Age和Country变量链接起来，用ID变量作为公共链接。</p><p id="d426" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们做如下工作:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="4d99" class="mq lf it nh b gy nl nm l nn no">mergeinfo&lt;-merge(mydata[, c("ID", "Sales")],mydata2[, c("ID", "Age", "Country")])</span></pre><p id="4c15" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样做后，我们看到在R中形成了一个新的数据集，它连接了我们选择的变量:</p><figure class="nc nd ne nf gt nq gh gi paragraph-image"><div class="gh gi np"><img src="../Images/84cc1f47dd5b018a26eb069db10718c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/0*6jYD5n1JBrpB7a9X.png"/></div></figure><p id="c6ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 3。使用as.date格式化日期并计算持续时间</strong></p><p id="0138" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们现在希望计算当前日期和销售文件中列出的销售日期之间的天数。为了实现这一点，我们可以使用as.date，如下所示:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="34e1" class="mq lf it nh b gy nl nm l nn no">currentdate=as.Date('2016-12-15')<br/>dateinfile=as.Date(Date)<br/>Duration=currentdate-dateinfile</span></pre><p id="9627" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回到上面的例子，假设我们现在希望将这个持续时间变量与其余的数据结合起来。</p><p id="0958" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们现在可以将我们的新Duration变量与上面的merge函数结合起来，并且可以这样做:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="0c6a" class="mq lf it nh b gy nl nm l nn no">durationasdouble=as.double.difftime(Duration, units='days')<br/>updateddataframe=data.frame(ID,Sales,Date,durationasdouble)<br/>updateddataframe</span></pre><figure class="nc nd ne nf gt nq gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/e64f03490c6ae533e10cc57631e46afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/0*B18q_PBktJBLIp4M.png"/></div></figure><p id="a143" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 4。使用as。POSIXct和format来计算秒之间的差异</strong></p><p id="aab4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然在上面的例子中情况并非如此，但在我们拥有包含时间的日期的情况下，经常会出现这样的情况，例如“2016–10–13 19:30:55”。</p><p id="53e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有时，我们可能希望找出两个日期的秒数之间的差异。对此，作为。POSIXct是比as.Date更合适的选项。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="491d" class="mq lf it nh b gy nl nm l nn no">date_converted&lt;-format(Date, format="%Y-%m-%d %H:%M:%S")<br/>new_date_variable&lt;-as.POSIXct(date_converted)<br/>seconds&lt;-diff(new_date_variable,1)</span></pre><p id="cc07" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们定义秒变量时，它会给出两个日期之间的秒差。然后，这是一个简单的算术问题，以获得分钟和秒的差异。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="bfe0" class="mq lf it nh b gy nl nm l nn no">minutes&lt;-seconds/60<br/>hours&lt;-minutes/60</span></pre><p id="f2ea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 5。grepl:从变量中删除一个字符串的实例</strong></p><p id="b2d7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们看看国家变量。假设我们希望从变量中删除所有“Greenland”的实例。这是使用grepl命令完成的:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="1326" class="mq lf it nh b gy nl nm l nn no">countryremoved&lt;-mydata2[!grepl("Greenland", mydata2$Country),]</span></pre><p id="4b57" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 6。使用头尾功能删除观察值</strong></p><p id="a63f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们希望从变量中删除某些观察值，例如销售额，可以使用head和tail函数。head函数允许我们删除前30行，而tail函数允许我们删除后30行。</p><p id="6508" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当使用以这种方式编辑的变量进行计算时，例如回归，as.matrix函数也用于将变量转换为矩阵格式:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="1092" class="mq lf it nh b gy nl nm l nn no">Salesminus30days←head(Sales,-30)<br/>X1=as.matrix(Salesminus30days)<br/>X1<br/> <br/>Salesplus30days&lt;-tail(Sales,-30)<br/>X2=as.matrix(Salesplus30days)<br/>X2</span></pre><p id="624d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 7。使用“聚集”功能</strong>复制SUMIF</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="d108" class="mq lf it nh b gy nl nm l nn no">names &lt;- c("John", "Elizabeth", "Michael", "John", "Elizabeth", "Michael")<br/>webvisitsframe &lt;- cbind("24","32","40","71","65","63")<br/>webvisits=as.numeric(webvisitsframe)<br/>minutesspentframe &lt;- cbind("20", "41", "5", "6", "48", "97")<br/>minutesspent=as.numeric(minutesspentframe)</span></pre><p id="98fe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们已经创建了如下表格，并希望获得在任何特定时间段内网站访问量和在网站上花费时间的总和:</p><figure class="nc nd ne nf gt nq gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/6acf59e6d3bc55f4ba63dde9b8a8d35d.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/0*w9ztZTWMY3zulqJ6.png"/></div></figure><p id="b247" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种情况下，我们可以通过使用r中的聚合函数来复制Excel中的SUMIF函数(其中与特定标识符相关联的值被求和)，这可以按如下方式完成(其中raw_table是上面指定的表):</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="ec30" class="mq lf it nh b gy nl nm l nn no">sumif_table&lt;-aggregate(. ~ names, data=raw_table, sum)<br/>sumif_table</span></pre><p id="4f00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，与标识符(在本例中是名称)相关联的值总结如下:</p><figure class="nc nd ne nf gt nq gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/a203691bf0d75283d69ab8f4b85fe34b.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/0*rrFVe7y7QUOcwy99.png"/></div></figure><p id="b7e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据堆栈溢出中的示例，plyr和data.table库也可用于实现相同的结果，如下所示:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="6500" class="mq lf it nh b gy nl nm l nn no">library(plyr)<br/>ddply(nametable, .(names), summarise, Sum_webvisits = sum(webvisits), Sum_minutesspent = sum(minutesspent))<br/> <br/>library(data.table)<br/>DT &lt;- as.data.table(nametable)<br/>DT[ , lapply(.SD, sum), by = "names"]</span></pre><p id="0d3d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 8。使用diff()函数</strong>计算滞后</p><p id="6644" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当进行时间序列分析时，经常需要计算特定变量的滞后时间。为了在R中做到这一点，我们使用diff()函数。</p><p id="2af2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本例中，我们创建一个矩阵，以价格数据作为列名，以年份作为行名:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="c56b" class="mq lf it nh b gy nl nm l nn no">pricedata &lt;- matrix(c(102, 90, 84, 130, 45), ncol=1)<br/>colnames(pricedata) &lt;- c('Price')<br/>rownames(pricedata) &lt;- c('2012', '2013', '2014', '2015', '2016')<br/>pricedata.table &lt;- as.table(pricedata)<br/>pricedata.table<br/>Year	Price<br/>2012	102<br/>2013	90<br/>2014	84<br/>2015	130<br/>2016	45<br/>2. Lag = 1</span><span id="68c9" class="mq lf it nh b gy nw nm l nn no">diff(pricedata.table,1)<br/>Year	Price<br/>2013	-12<br/>2014	-6<br/>2015	46<br/>2016	-85<br/>3. Lag = 2</span><span id="d292" class="mq lf it nh b gy nw nm l nn no">diff(pricedata.table,2)<br/>Year	Price<br/>2014	-18<br/>2015	40<br/>2016	-39<br/>4. Differences = 2</span><span id="c807" class="mq lf it nh b gy nw nm l nn no">diff(pricedata.table,differences=2)<br/>Year	Price<br/>2014	6<br/>2015	52<br/>2016	131</span></pre><p id="40a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> 9。按列表分隔(对面板数据集有用)</strong></p><p id="8880" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们有一个需要分离的数据集，例如通过ID。手动操作会导致一个相当混乱的过程。相反，我们可以使用unique和split函数来形成一个列表。这里有一个如何做到这一点的例子。</p><p id="902a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用包含日期、姓名和id的数据框:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="974c" class="mq lf it nh b gy nl nm l nn no">&gt; Date&lt;-c("20/02/2017","21/02/2017","22/02/2017","20/02/2017","21/02/2017","22/02/2017")<br/>&gt; ID&lt;-c("20","20","20","40","40","40")<br/>&gt; Name&lt;-c("Brian","Brian","Brian","Adam","Adam","Adam")<br/>&gt; df&lt;-data.frame(Date,ID,Name)<br/>&gt; df<br/>        Date ID  Name<br/>1 20/02/2017 20 Brian<br/>2 21/02/2017 20 Brian<br/>3 22/02/2017 20 Brian<br/>4 20/02/2017 40  Adam<br/>5 21/02/2017 40  Adam<br/>6 22/02/2017 40  Adam</span></pre><p id="08b8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，我们希望通过按ID过滤将观察结果分成两个单独的列表。我们将这样做，如下所示:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="2f72" class="mq lf it nh b gy nl nm l nn no">&gt; listofids=as.character(unique(df$ID))<br/>&gt; mylist &lt;- split(df, df$ID)<br/>&gt; mylist<br/> <br/>$`20`<br/>        Date ID  Name<br/>1 20/02/2017 20 Brian<br/>2 21/02/2017 20 Brian<br/>3 22/02/2017 20 Brian</span><span id="edbf" class="mq lf it nh b gy nw nm l nn no">$`40`<br/>        Date ID Name<br/>4 20/02/2017 40 Adam<br/>5 21/02/2017 40 Adam<br/>6 22/02/2017 40 Adam</span></pre><p id="99db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是完整的列表。如果我们希望一次调用一个(通过ID作为我们的唯一标识符，我们可以这样做:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="2242" class="mq lf it nh b gy nl nm l nn no">&gt; mylist[1]<br/>$`20`<br/>        Date ID  Name<br/>1 20/02/2017 20 Brian<br/>2 21/02/2017 20 Brian<br/>3 22/02/2017 20 Brian<br/>&gt; mylist[2]<br/>$`40`<br/>        Date ID Name<br/>4 20/02/2017 40 Adam<br/>5 21/02/2017 40 Adam<br/>6 22/02/2017 40 Adam</span></pre><h1 id="3c8b" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">结论</h1><p id="1246" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">上面的例子说明了我们在R中进行数据操作过程的各种方法，以及复制普通Excel函数(如VLOOKUP)的技术。非常感谢您的宝贵时间，上面例子的相关GitHub库再次在<a class="ae mp" href="https://github.com/MGCodesandStats/rtutorial-data-cleaning" rel="noopener ugc nofollow" target="_blank">这里</a>可用。</p><p id="03a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你也可以在michael-grogan.com的<a class="ae mp" href="https://www.michael-grogan.com/" rel="noopener ugc nofollow" target="_blank">找到更多我的数据科学内容。</a></p><p id="8a6b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nx">免责声明:本文是在“原样”的基础上编写的，没有担保。本文旨在提供数据科学概念的概述，不应以任何方式解释为专业建议。</em></p></div></div>    
</body>
</html>