<html>
<head>
<title>UNPIVOT multiple columns into tidy pairs with BigQuery and a SQL UDF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 BigQuery 和 SQL UDF 将多个列拆分成整齐的对</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675?source=collection_archive---------18-----------------------#2020-04-20">https://towardsdatascience.com/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675?source=collection_archive---------18-----------------------#2020-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/c550afe3eb5a475234e3e5cbf470b695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RV19-MCMsD7HMMWD7He0QA.png"/></div></div></figure><div class=""/><div class=""><h2 id="0da6" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">这篇文章是写给任何在 CSV 中处理时间序列的人的，每天都有一个新的专栏。拥有整洁的数据很重要！尤其是现在，一些公共数据的提供者选择了每天一列——这使得用 SQL 分析时间序列变得非常困难。在这篇文章中，可以找到一个共享的持久化 BigQuery UDF，它可以将数百个列转换成整齐的(日期，值)对，供您使用。</h2></div><p id="1ae5" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc"> <em class="lm">重要更新</em> </strong> : <em class="lm">我在 2020 年离开了谷歌，加入了雪花——所以我无法保持更新我的旧帖子。如果你想尝尝雪花啤酒，加入我们吧——我在❄️.玩得很开心</em></p><p id="d8ca" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">作为非整齐数据的一个例子，我们可以看到新型冠状病毒(新冠肺炎)案例(由 JHU·CSSE 提供)和<a class="ae ln" href="https://www.apple.com/covid19/mobility" rel="noopener ugc nofollow" target="_blank">苹果移动趋势报告</a>表格的外观:</p><div class="lo lp lq lr gt ab cb"><figure class="ls is lt lu lv lw lx paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/b48208b4d2475302aeb26d79b4d88b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*14pRddVwnm6wAhzDL9MXcw.png"/></div></figure><figure class="ls is ly lu lv lw lx paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/7074d0fc17bf5988895febaf51c9fd98.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*sDYJDPd9RZAKUVc5N4QCpw.png"/></div><p class="lz ma gj gh gi mb mc bd b be z dk md di me mf translated">JHU CSSE 表格，苹果移动趋势报告表格:每个日期一列。我们不想那样。</p></figure></div><p id="9c43" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们不希望多列，每个日期。我们希望有(日期，值)对。因为这个问题似乎很常见，所以我编写了两个 BigQuery 持久性 UDF 来解决这个问题:</p><ul class=""><li id="b59a" class="mg mh jb ks b kt ku kw kx kz mi ld mj lh mk ll ml mm mn mo bi translated"><code class="fe mp mq mr ms b">fhoffa.x.unpivot()</code></li><li id="2838" class="mg mh jb ks b kt mt kw mu kz mv ld mw lh mx ll ml mm mn mo bi translated"><code class="fe mp mq mr ms b">fhoffa.x.cast_kv_array_to_date_float()</code></li></ul><p id="62fc" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">让我们回顾一下它们是如何工作的。</p><h2 id="60d4" class="my mz jb bd na nb nc dn nd ne nf dp ng kz nh ni nj ld nk nl nm lh nn no np nq bi translated">使用 fhoffa.x.Unpivot()进行 unpivot</h2><p id="4cf4" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">只需给<code class="fe mp mq mr ms b">unpivot()</code>一个完整的行，以及每个列的名称如何显示的正则表达式。</p><p id="eb7b" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">苹果桌子:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="84c6" class="my mz jb ms b gy oa ob l oc od">SELECT a.geo_type, region, transportation_type, unpivotted<br/>FROM `fh-bigquery.public_dump.applemobilitytrends_20200414` a<br/>  , UNNEST(fhoffa.x.unpivot(a, '_2020')) unpivotted</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/c29a68ce8482d10129232438e818edc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*OhTsAh0rsx-xu_VLqsb-uQ.png"/></div><p class="lz ma gj gh gi mb mc bd b be z dk translated">颠覆苹果移动趋势</p></figure><p id="23e6" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">与 JHU 表:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="32e2" class="my mz jb ms b gy oa ob l oc od">SELECT province_state, country_region, unpivotted<br/>FROM `bigquery-public-data.covid19_jhu_csse.confirmed_cases`  a<br/>  , UNNEST(fhoffa.x.unpivot(a, '_[0-9]')) unpivotted</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi of"><img src="../Images/d7465a831fffce36ec8b9d0037b764da.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*lYDzMdjJJndmSWsgX8mYNA.png"/></div><p class="lz ma gj gh gi mb mc bd b be z dk translated">取消旋转 JHU 表</p></figure><p id="e11d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这就好多了，但我们还没完。我们如何将这些值转换成日期和数字？</p><h2 id="f4ac" class="my mz jb bd na nb nc dn nd ne nf dp ng kz nh ni nj ld nk nl nm lh nn no np nq bi translated">用 cast_kv_array_to_date_float()转换数组</h2><p id="0cba" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">我们可以使用<code class="fe mp mq mr ms b">cast_kv_array_to_date_float()</code>重新转换未透视的列。</p><p id="2816" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当将这些列转换为日期时，更“令人恼火”的是它们使用不同的格式对日期进行编码。您不必担心，因为 UDF 也可以将日期格式作为输入。</p><p id="c85c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">例如，苹果的桌子:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="524f" class="my mz jb ms b gy oa ob l oc od">SELECT a.geo_type, region, transportation_type, unpivotted.*<br/>FROM `fh-bigquery.public_dump.applemobilitytrends_20200414` a<br/>  , UNNEST(fhoffa.x.cast_kv_array_to_date_float(fhoffa.x.unpivot(a, '_2020'), '_%Y_%m_%d')) unpivotted</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi og"><img src="../Images/fcd26aa96736355dd85eafe24bc7626e.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*qQOflH8qT4E0wekrJwtL0w.png"/></div><p class="lz ma gj gh gi mb mc bd b be z dk translated">颠覆和铸造苹果移动趋势</p></figure><p id="4534" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">还有 JHU 的桌子:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="f0c5" class="my mz jb ms b gy oa ob l oc od">SELECT province_state, country_region, unpivotted.*<br/>FROM `bigquery-public-data.covid19_jhu_csse.confirmed_cases`  a<br/>  , UNNEST(fhoffa.x.cast_kv_array_to_date_float(fhoffa.x.unpivot(a, '_[0-9]'), '_%m_%d_%y')) unpivotted</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/fe4433eeef7b02bd10d55d13e2a15203.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*1fegV_3iU-ldhMI5tiAe7Q.png"/></div><p class="lz ma gj gh gi mb mc bd b be z dk translated">拆除和铸造 JHU 表</p></figure><p id="91af" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">看到了吗？这些结果看起来比开始的表格更整洁。</p><h2 id="a745" class="my mz jb bd na nb nc dn nd ne nf dp ng kz nh ni nj ld nk nl nm lh nn no np nq bi translated">奖励:covid 19 _ USA facts . confirmed _ cases 表</h2><p id="9e31" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">一旦我们有了这两个 UDF，将它们应用到其他表就变得非常容易了:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="0fcc" class="my mz jb ms b gy oa ob l oc od">SELECT county_fips_code, county_name, state, state_fips_code, unpivotted.*<br/>FROM `bigquery-public-data.covid19_usafacts.confirmed_cases` a<br/>  , UNNEST(fhoffa.x.cast_kv_array_to_date_float(fhoffa.x.unpivot(a, '_[0-9]'), '_%m_%d_%y')) unpivotted</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oi"><img src="../Images/aded760b4cc923868a229248f3086536.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ogwynrq4-D_oxjm9J3_UQw.png"/></div></div><p class="lz ma gj gh gi mb mc bd b be z dk translated">取消“covid 19 _ USA facts . confirmed _ cases”表的透视</p></figure><h1 id="c9f1" class="oj mz jb bd na ok ol om nd on oo op ng kh oq ki nj kk or kl nm kn os ko np ot bi translated">操作方法</h1><p id="4a96" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">查看我之前关于 BigQuery 中<a class="ae ln" href="https://medium.com/@hoffa/new-in-bigquery-persistent-udfs-c9ea4100fd83" rel="noopener">持久 UDF 的帖子:</a></p><div class="ip iq gp gr ir ou"><a href="https://medium.com/@hoffa/new-in-bigquery-persistent-udfs-c9ea4100fd83" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd jc gy z fp oz fr fs pa fu fw ja bi translated">BigQuery 中的新特性:持久性 UDF</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">用户定义的函数是扩展 BigQuery 的一种强有力的方法，但直到现在，它一直是一个必须复制粘贴的累赘…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ix ou"/></div></div></a></div><p id="6df6" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这两个 UDF 的源代码是:</p><pre class="lo lp lq lr gt nw ms nx ny aw nz bi"><span id="f5c8" class="my mz jb ms b gy oa ob l oc od">CREATE OR REPLACE FUNCTION fhoffa.x.unpivot(x ANY TYPE, col_regex STRING) <br/>AS ((<br/>  # <a class="ae ln" href="https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675" rel="noopener">https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675</a><br/>  SELECT <br/>   ARRAY_AGG(STRUCT(<br/>     REGEXP_EXTRACT(y, '[^"]*') AS key<br/>   , REGEXP_EXTRACT(y, r':([^"]*)\"?[,}\]]') AS value<br/>   ))<br/>  FROM UNNEST((<br/>    SELECT REGEXP_EXTRACT_ALL(json,col_regex||r'[^:]+:\"?[^"]+\"?') arr<br/>    FROM (SELECT TO_JSON_STRING(x) json))) y<br/>));</span><span id="d754" class="my mz jb ms b gy pj ob l oc od">CREATE OR REPLACE FUNCTION fhoffa.x.cast_kv_array_to_date_float(arr ANY TYPE, date_format STRING) <br/>AS ((<br/>  # <a class="ae ln" href="https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675" rel="noopener">https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675</a><br/>  SELECT ARRAY_AGG(STRUCT(SAFE.PARSE_DATE(date_format, key) AS date, SAFE_CAST(value AS FLOAT64) AS value))<br/>  FROM UNNEST(arr)<br/>));</span></pre><p id="e2f7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这个函数背后的秘密引擎:用<code class="fe mp mq mr ms b">TO_JSON_STRING()</code>将一整行转换成 JSON，然后对它执行一个<code class="fe mp mq mr ms b">REGEXP_EXTRACT_ALL</code>。</p><h2 id="4438" class="my mz jb bd na nb nc dn nd ne nf dp ng kz nh ni nj ld nk nl nm lh nn no np nq bi translated">历史笔记</h2><p id="28d0" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">我的<a class="ae ln" href="https://stackoverflow.com/a/27832362/132438" rel="noopener ugc nofollow" target="_blank">以前的解决方案</a>在 BigQuery 中的 UNPIVOT 已经收到了超过 5000 个关于堆栈溢出的视图:</p><div class="ip iq gp gr ir ou"><a href="https://stackoverflow.com/a/27832362/132438" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd jc gy z fp oz fr fs pa fu fw ja bi translated">如何在 BigQuery 中取消透视？</h2><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">stackoverflow.com</p></div></div><div class="pd l"><div class="pk l pf pg ph pd pi ix ou"/></div></div></a></div><h2 id="8bb9" class="my mz jb bd na nb nc dn nd ne nf dp ng kz nh ni nj ld nk nl nm lh nn no np nq bi translated">后续步骤</h2><p id="4a3c" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">一旦我为这些函数编写了文档，并且我们确定了它们的最终名称——我将把它们提交给我们与社区 UDF(<code class="fe mp mq mr ms b"><a class="ae ln" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community" rel="noopener ugc nofollow" target="_blank">bqutil</a></code>)共享的存储库。</p><div class="ip iq gp gr ir ou"><a href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd jc gy z fp oz fr fs pa fu fw ja bi translated">Google cloud platform/big query-utils</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">该目录包含社区贡献的用户定义函数，以扩展 BigQuery 用于更专门的用途…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">github.com</p></div></div><div class="pd l"><div class="pl l pf pg ph pd pi ix ou"/></div></div></a></div><h1 id="259b" class="oj mz jb bd na ok ol om nd on oo op ng kh oq ki nj kk or kl nm kn os ko np ot bi translated">想要更多吗？</h1><p id="63b3" class="pw-post-body-paragraph kq kr jb ks b kt nr kc kv kw ns kf ky kz nt lb lc ld nu lf lg lh nv lj lk ll ij bi translated">查看<a class="ae ln" href="https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19" rel="noopener ugc nofollow" target="_blank">谷歌的公共数据集项目</a>，在 BigQuery 中收集了越来越多的新冠肺炎相关数据集:</p><div class="ip iq gp gr ir ou"><a href="https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd jc gy z fp oz fr fs pa fu fw ja bi translated">新冠肺炎免费公共数据集|谷歌云博客</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">数据在调查、研究和应对突发公共卫生事件的能力中始终发挥着至关重要的作用</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">cloud.google.com</p></div></div><div class="pd l"><div class="pm l pf pg ph pd pi ix ou"/></div></div></a></div><p id="33d0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我是 Felipe Hoffa，谷歌云的开发者倡导者。在<a class="ae ln" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank"> @felipehoffa </a>上关注我，在<a class="ae ln" href="https://medium.com/@hoffa" rel="noopener">medium.com/@hoffa</a>上找到我以前的帖子，在<a class="ae ln" href="https://reddit.com/r/bigquery" rel="noopener ugc nofollow" target="_blank">reddit.com/r/bigquery</a>上找到所有关于 BigQuery 的帖子。</p></div></div>    
</body>
</html>