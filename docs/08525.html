<html>
<head>
<title>How to import Google Sheets data into a Pandas DataFrame using Google’s API v4 (2020)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Google的API v4 (2020)将Google Sheets数据导入熊猫数据框架</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-import-google-sheets-data-into-a-pandas-dataframe-using-googles-api-v4-2020-f50e84ea4530?source=collection_archive---------3-----------------------#2020-06-21">https://towardsdatascience.com/how-to-import-google-sheets-data-into-a-pandas-dataframe-using-googles-api-v4-2020-f50e84ea4530?source=collection_archive---------3-----------------------#2020-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/81131d560b1574639e555f7433282994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxhZLz2qz3jfYUrUrQLcmA.jpeg"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">图片来自Pixabay</p></figure><h2 id="f627" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">将Google工作表数据导入熊猫数据框架</h2><p id="b52c" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">Google Sheets是一种共享数据和远程协作的有用方式。但是定期将数据转移到Python这样的环境中会很麻烦。这篇文章将介绍如何为Python设置最新的Google Sheets API，即2020年6月的v4。我们还将介绍如何从Google工作表范围(甚至整个工作表)中提取数据到Pandas数据框中。</p><h2 id="7db5" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">开始之前:</h2><p id="1284" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">开始之前，您需要以下材料:</p><ul class=""><li id="496e" class="lt lu iq la b lb lv lf lw kl lx kp ly kt lz ls ma mb mc md bi translated">Python 2.6或更高版本(建议使用Python 3)</li><li id="80a4" class="lt lu iq la b lb me lf mf kl mg kp mh kt mi ls ma mb mc md bi translated">Pip/pip3包管理工具(Python 2 &gt;= 2.7.9或Python 3 &gt;= 3.4的标准配置)</li><li id="aceb" class="lt lu iq la b lb me lf mf kl mg kp mh kt mi ls ma mb mc md bi translated">一个谷歌账户(和包含你感兴趣的数据的谷歌表单)。</li></ul><h2 id="8a3c" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">API设置:</h2><p id="a421" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">首先，你需要在你的Gmail账户上启用Google Sheets API，Google Sheets就存储在这里。登录您的Gmail帐户，访问<a class="ae mj" href="https://developers.google.com/sheets/api/quickstart/python" rel="noopener ugc nofollow" target="_blank">Google Sheets API Python快速入门指南</a>。你会看到一个蓝色的“启用Google Sheets API”按钮。点击按钮(下图中标为[1]):</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/ce1f581964445be9195ae86ba805386f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mOSOy-0x8HMlBTTPLdKvKQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="7865" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">从下拉菜单中选择“桌面应用程序”(下图中标为[2])，然后单击“创建”(下图中标为[3])。这将创建一个客户端配置，我们需要通过API设置初始连接:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/14ab56b0e82206dc2de8f4e2259fb99c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*olB4CTp0ZVV9XeLlhRyT9w.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="98be" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">单击蓝色的“下载客户端配置”按钮(在下图中标为[4])。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/8a8fb09e9a4b444d26c9a3fff6648e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8W9TiZGLOakLpr5_5iGN2A.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="4bd8" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">您现在应该已经下载了一个名为“<em class="mu"> credentials.json </em>的文件。您需要将该文件移动到您的工作目录中。</p><h2 id="81d3" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">安装Google的客户端库:</h2><p id="ea7e" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">接下来，我们需要使用pip安装Google的客户端库:</p><pre class="ml mm mn mo gt mv mw mx my aw mz bi"><span id="6ef1" class="kc kd iq mw b gy na nb l nc nd">pip install — upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib</span></pre><p id="3c02" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated"><strong class="la ir">注意:</strong>我们将使用他们脚本的修改版本，而不是运行Google在其指南中提供的示例Python代码。</p><h2 id="975a" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">生成我们的API用户令牌:</h2><p id="4a71" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">首先，我们将设置我们的<em class="mu"> gsheet_api_check() </em>函数。它查找现有的<em class="mu">令牌。pickle </em>文件(存储我们的用户访问和刷新令牌)。如果没有找到<em class="mu"> token.pickle </em>文件，该功能将提示您登录您的Google Gmail帐户。<strong class="la ir">您的工作目录中必须有<em class="mu"> credentials.json </em>才能启动<em class="mu"> token.pickle </em>创建/刷新</strong>。该函数生成我们将用来进行API调用的凭证:</p><pre class="ml mm mn mo gt mv mw mx my aw mz bi"><span id="cf7a" class="kc kd iq mw b gy na nb l nc nd">import pickle<br/>import os.path<br/>from google_auth_oauthlib.flow import InstalledAppFlow<br/>from google.auth.transport.requests import Request</span><span id="2d8f" class="kc kd iq mw b gy ne nb l nc nd">def gsheet_api_check(SCOPES):<br/>    creds = None<br/>    if os.path.exists('token.pickle'):<br/>        with open('token.pickle', 'rb') as token:<br/>            creds = pickle.load(token)</span><span id="b529" class="kc kd iq mw b gy ne nb l nc nd">    if not creds or not creds.valid:<br/>        if creds and creds.expired and creds.refresh_token:<br/>            creds.refresh(Request())<br/>        else:<br/>            flow = InstalledAppFlow.from_client_secrets_file(<br/>                'credentials.json', SCOPES)<br/>            creds = flow.run_local_server(port=0)</span><span id="8cc3" class="kc kd iq mw b gy ne nb l nc nd">        with open('token.pickle', 'wb') as token:<br/>            pickle.dump(creds, token)</span><span id="9191" class="kc kd iq mw b gy ne nb l nc nd">    return creds</span></pre><p id="78c4" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated"><strong class="la ir">注意:</strong>完成初始凭证设置后，我们可以丢弃<em class="mu"> gsheet_api_check()和</em>在以后的api调用中直接加载我们的令牌<em class="mu"> </em>。或者，保留<em class="mu"> gsheet_api_check() </em>可能是有益的，因为该函数检查我们的令牌是否过期和/或丢失。如果令牌过期/丢失，<em class="mu"> gsheet_api_check() </em>将开始刷新用户令牌(通过提示您重新登录您的Google帐户)。您可以决定是继续使用<em class="mu"> gsheet_api_check() </em>还是直接加载令牌。</p><h2 id="ba29" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">进行API调用:</h2><p id="198e" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">接下来，我们将定义一个函数，该函数进行API调用并从Google Sheets中提取我们想要的数据。<em class="mu"> pull_sheet_data() </em>函数建立API调用，拉取我们想要的数据。如果没有找到数据，该函数将显示“没有找到数据”，否则它将通过打印“完成:数据已复制”来确认数据已被检索，并返回我们的数据:</p><pre class="ml mm mn mo gt mv mw mx my aw mz bi"><span id="dcb8" class="kc kd iq mw b gy na nb l nc nd">from googleapiclient.discovery import build</span><span id="afec" class="kc kd iq mw b gy ne nb l nc nd">def pull_sheet_data(SCOPES,SPREADSHEET_ID,DATA_TO_PULL):<br/>    creds = gsheet_api_check(SCOPES)<br/>    service = build('sheets', 'v4', credentials=creds)<br/>    sheet = service.spreadsheets()<br/>    result = sheet.values().get(<br/>        spreadsheetId=SPREADSHEET_ID,<br/>        range=DATA_TO_PULL).execute()<br/>    values = result.get('values', [])<br/>    <br/>    if not values:<br/>        print('No data found.')<br/>    else:<br/>        rows = sheet.values().get(spreadsheetId=SPREADSHEET_ID,<br/>                                  range=DATA_TO_PULL).execute()<br/>        data = rows.get('values')<br/>        print("COMPLETE: Data copied")<br/>        return data</span></pre><p id="53f4" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated"><strong class="la ir">注意:</strong> <em class="mu">可以修改pull_sheet_data() </em>来定义其他API任务，比如将数据追加到google工作表，更新现有数据，或者创建新的电子表格。</p><h2 id="d2e8" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">运行我们的API调用并将数据保存为Pandas DataFrame:</h2><p id="9516" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">接下来，我们需要两条信息。首先，我们需要找到并复制感兴趣的电子表格的ID。这可以在您的谷歌电子表格的URL中找到(在下图中标记为[5]):</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/06502870f02fe7817b876d26fcb77929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xTDG-icHB7rnZ2fB0-43zQ.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><p id="f2cf" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">其次，我们需要从中提取数据的电子表格选项卡的名称。或者，如果希望从电子表格中提取特定的数据部分，可以明确定义要检索的单元格范围(下面提供了示例):</p><pre class="ml mm mn mo gt mv mw mx my aw mz bi"><span id="c4ef" class="kc kd iq mw b gy na nb l nc nd">#Pulls data from the entire spreadsheet tab.<br/>DATA_TO_PULL = 'spreadsheet_tab_name'</span><span id="5508" class="kc kd iq mw b gy ne nb l nc nd">or</span><span id="e704" class="kc kd iq mw b gy ne nb l nc nd">#Pulls data only from the specified range of cells.<br/>DATA_TO_PULL = 'spreadsheet_tab_name!A2:C6'</span></pre><p id="1e81" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">最后，我们将通过指定<em class="mu"> pull_sheet_data() </em>参数，运行函数，然后将检索到的数据存储到Pandas DataFrame中，从而将所有代码组合在一起。确保用您复制的电子表格ID替换'<em class="mu">电子表格_url_ID </em>，并替换'<em class="mu">电子表格_tab_name！</em>'以及您的电子表格选项卡名称(如有必要，还有范围):</p><pre class="ml mm mn mo gt mv mw mx my aw mz bi"><span id="25eb" class="kc kd iq mw b gy na nb l nc nd">import pandas as pd</span><span id="367a" class="kc kd iq mw b gy ne nb l nc nd">SCOPES = ['<a class="ae mj" href="https://www.googleapis.com/auth/spreadsheets'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/spreadsheets'</a>]<br/>SPREADSHEET_ID = 'spreadsheet_url_ID'<br/>DATA_TO_PULL = 'spreadsheet_tab_name'</span><span id="b10f" class="kc kd iq mw b gy ne nb l nc nd">data = pull_sheet_data(SCOPES,SPREADSHEET_ID,DATA_TO_PULL)<br/>df = pd.DataFrame(data[1:], columns=data[0])</span><span id="ffec" class="kc kd iq mw b gy ne nb l nc nd">df</span></pre><p id="afa4" class="pw-post-body-paragraph ky kz iq la b lb lv ld le lf lw lh li kl mp lk ll kp mq ln lo kt mr lq lr ls ij bi translated">现在，您可以在Python中探索检索到的数据，而无需手动下载或导入数据集！</p></div></div>    
</body>
</html>