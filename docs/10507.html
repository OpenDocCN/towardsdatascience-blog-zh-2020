<html>
<head>
<title>How to detect a baseball in image and video using Detectron2 with custom dataset</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用带有自定义数据集的 detector 2 检测图像和视频中的棒球</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-a-baseball-detector-using-detectron2-50b44edec6b7?source=collection_archive---------27-----------------------#2020-07-23">https://towardsdatascience.com/how-to-build-a-baseball-detector-using-detectron2-50b44edec6b7?source=collection_archive---------27-----------------------#2020-07-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d312" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用自定义数据集的 Train Detectron2 对象检测。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3692696a45b7bd834f69eb8d7797fc47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2eMC7I8EvcMvqO669HdLIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="69c6" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">介绍</h1><p id="2687" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">作为一个业余棒球运动员，我总是想分析我的投球和挥杆，以量化我在练习中的技能。实际上有一些应用不同技术的商业工具可以做到这一点，但是，它们中的大多数都非常昂贵，并且需要额外的设备。</p><p id="d214" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我想知道我是否可以从一个简单的手机视频中分析我的运动。为此，我需要从视频中收集信息。首先，我想检测棒球并确定它的位置，然后我可以做进一步的分析，如发射速度和角度。</p><p id="c3f7" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在这篇文章中，我将展示如何创建一个定制的棒球数据集，训练一个对象检测模型，并使用 detectron 2(<a class="ae mr" href="https://github.com/facebookresearch/detectron2" rel="noopener ugc nofollow" target="_blank">https://github.com/facebookresearch/detectron2</a>)将其应用于棒球视频。</p><p id="bcce" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">棒球检测器是按照三个步骤构建的，这将在本文中详细讨论:<br/> 1 .创建 COCO 格式的自定义棒球数据集<br/> 2。玩探测器 2，并在 Colab <br/> 3 训练模型。加载视频/图像并应用训练好的模型进行检测。</p><h1 id="7eb3" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">以 COCO 格式创建自定义棒球数据集</h1><p id="b3c7" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">真实视频剪辑中的棒球图像通常不是清晰和完美的。它可能有点模糊和扭曲，如下所示。因此，不使用 Detectron 2 提供的预训练模型。为了更好地检测，我决定创建一个包含视频中真实棒球图像的数据集。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/043ac70945331367082292c8808cbdd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*CcBLIdJxd1Yf-2L6_i3iRw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自挥动棒球的视频截图(图片由作者提供)</p></figure><p id="4c24" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">首先，我在 Youtube 上使用了一些棒球比赛视频，并在第一次尝试中获得了 120 张包含棒球的图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/1672d1d10eb9d0b8b04be0c777d438d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhs9Gs6FIvbNZspZSFOfNQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从视频剪辑中捕获的训练图像。</p></figure><p id="eb82" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后我用<a class="ae mr" href="https://github.com/tzutalin/labelImg" rel="noopener ugc nofollow" target="_blank">标签</a>手工给棒球贴标签。Labelimg 是一种方便的标记对象的工具。按照回购中的说明，它可以很容易地安装和使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/0672f0477d16d7ba79d0153ce8d18f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5FwLRzIvnEZSUVO4KgBrLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用标签标记棒球</p></figure><ol class=""><li id="1392" class="mv mw it ls b lt mm lw mn lz mx md my mh mz ml na nb nc nd bi translated">选择“PascalVOC”，这是默认的注释格式。</li><li id="9535" class="mv mw it ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">打开包含图像的文件夹</li><li id="5147" class="mv mw it ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">设置保存注释的文件夹</li><li id="d45b" class="mv mw it ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">标记球并保存注释</li></ol><p id="39b9" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我花了大约 20 分钟来手动标记 120 张图片，然后将注释保存在您用 xml 设置的文件夹中。</p><p id="9265" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后我使用 Tony607 的 GitHub repo 中的这个<a class="ae mr" href="https://github.com/Tony607/voc2coco/blob/master/voc2coco.py" rel="noopener ugc nofollow" target="_blank"> voc2coco.py </a>脚本将 PascalVOC xml 文件转换成一个 coco 格式的 JSON 文件。</p><p id="5738" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在，我必须用 COCO 格式的注释定制棒球数据集，为训练做好准备。</p><h1 id="dccc" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">使用 Colab 中的 Detectron2 训练模型</h1><p id="981f" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我修改了 Detectron2 的好看又清晰的<a class="ae mr" href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5" rel="noopener ugc nofollow" target="_blank">教程 Colab 笔记本</a>并训练了模型。</p><p id="90de" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">首先，我将我的 Google Drive 安装到笔记本上，并将我创建的数据集上传到上面。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="4925" class="no kz it nk b gy np nq l nr ns">from google.colab import drive<br/>drive.mount('/content/gdrive', force_remount=True)<br/>root_dir = 'gdrive/My Drive/Colab Notebooks/'<br/>base_dir = root_dir + 'baseball_detection'</span></pre><p id="2b14" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后，我按照笔记本上的说明安装和设置 detectron2。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="33cc" class="no kz it nk b gy np nq l nr ns"># install dependencies:<br/>!pip install pyyaml==5.1 pycocotools&gt;=2.0.1<br/>import torch, torchvision<br/>print(torch.__version__, torch.cuda.is_available())<br/>!gcc --version<br/># opencv is pre-installed on colab</span><span id="d182" class="no kz it nk b gy nt nq l nr ns"># install detectron2: (colab has CUDA 10.1 + torch 1.5)<br/># See https://detectron2.readthedocs.io/tutorials/install.html for instructions<br/>assert torch.__version__.startswith("1.5")<br/>!pip install detectron2==0.2 -f https://dl.fbaipublicfiles.com/detectron2/wheels/cu101/torch1.5/index.html</span><span id="dae6" class="no kz it nk b gy nt nq l nr ns"># Some basic setup:<br/># Setup detectron2 logger<br/>import detectron2<br/>from detectron2.utils.logger import setup_logger<br/>setup_logger()<br/># import some common libraries<br/>import numpy as np<br/>import os, json, cv2, random<br/>from google.colab.patches import cv2_imshow<br/># import some common detectron2 utilities<br/>from detectron2 import model_zoo<br/>from detectron2.engine import DefaultPredictor<br/>from detectron2.config import get_cfg<br/>from detectron2.utils.visualizer import Visualizer<br/>from detectron2.data import MetadataCatalog, DatasetCatalog</span></pre><p id="676b" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后我将球数据集注册到 detectron2。输入注释文件路径(COCO json)和包含训练图像的文件夹路径。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="6c2d" class="no kz it nk b gy np nq l nr ns">from detectron2.data.datasets import register_coco_instances<br/>register_coco_instances("ball", {}, path/'image'/'output.json', path/'image')</span></pre><p id="566a" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后打电话</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="9319" class="no kz it nk b gy np nq l nr ns">ball_metadata = MetadataCatalog.get("ball")<br/>dataset_dicts = DatasetCatalog.get("ball")</span></pre><p id="9e9f" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">然后我运行这个单元来查看训练图像</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="e08a" class="no kz it nk b gy np nq l nr ns">for d in random.sample(dataset_dicts, 3):<br/>   img = cv2.imread(d["file_name"])<br/>   visualizer = Visualizer(img[:, :, ::-1], metadata=ball_metadata,    scale=0.5)<br/>   out = visualizer.draw_dataset_dict(d)<br/>   cv2_imshow(out.get_image()[:, :, ::-1])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/078b1e598f06e879d53b97d3114f2ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*NCdhOu5W3vqnLbzQ8xZKWA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">标签图像。</p></figure><p id="2ca5" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我现在准备好训练了！</p><p id="96d4" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我在棒球数据集上微调了 COCO 预训练的 R50-FPN 面具 R-CNN 模型。我得到了配置和重量使用模型 _ 动物园的方法。记得换 cfg。模型。ROI_HEADS。NUM_CLASSES 设置为 1，因为我现在只有一个类。我花了几分钟在 Colab 上运行 2000 次迭代。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="72ad" class="no kz it nk b gy np nq l nr ns">from detectron2.engine import DefaultTrainer</span><span id="937e" class="no kz it nk b gy nt nq l nr ns">cfg = get_cfg()<br/>cfg.merge_from_file(model_zoo.get_config_file("COCO-Detection/faster_rcnn_R_50_FPN_3x.yaml"))<br/>cfg.DATASETS.TRAIN = ("ball",)<br/>cfg.DATASETS.TEST = ()<br/>cfg.DATALOADER.NUM_WORKERS = 2<br/>cfg.MODEL.WEIGHTS = model_zoo.get_checkpoint_url("COCO-Detection/faster_rcnn_R_50_FPN_3x.yaml")   # Let training initialize from model zoo<br/>cfg.SOLVER.IMS_PER_BATCH = 2<br/>cfg.SOLVER.BASE_LR = 0.00025  # pick a good LR<br/>cfg.SOLVER.MAX_ITER = 2000    # 300 iterations seems good enough for this toy dataset; you may need to train longer for a practical dataset<br/>cfg.MODEL.ROI_HEADS.BATCH_SIZE_PER_IMAGE = 128   # faster, and good enough for this toy dataset (default: 512)<br/>cfg.MODEL.ROI_HEADS.NUM_CLASSES = 1  # only has one class (ball)</span><span id="1a70" class="no kz it nk b gy nt nq l nr ns">os.makedirs(cfg.OUTPUT_DIR, exist_ok=True)<br/>trainer = DefaultTrainer(cfg)<br/>trainer.resume_or_load(resume=False)<br/>trainer.train()</span></pre><p id="1849" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我可以在 tensorboard 上看到训练表演</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="de99" class="no kz it nk b gy np nq l nr ns"># Look at training curves in tensorboard:<br/>%load_ext tensorboard<br/>%tensorboard --logdir output</span></pre><p id="9345" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在，我可以在球验证数据集上使用训练好的模型进行推理。首先，让我们使用我刚刚训练的模型创建一个预测器:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="5663" class="no kz it nk b gy np nq l nr ns">cfg.MODEL.WEIGHTS = os.path.join(cfg.OUTPUT_DIR, "model_final.pth")<br/>cfg.MODEL.ROI_HEADS.SCORE_THRESH_TEST = 0.5   # set a custom testing threshold for this model<br/>cfg.DATASETS.TEST = ("ball", )<br/>predictor = DefaultPredictor(cfg)</span></pre><p id="aca5" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">选择一些测试图像来测试模型</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="d40c" class="no kz it nk b gy np nq l nr ns">im = cv2.imread('gdrive/My Drive/Colab Notebooks/baseball_detection/test/1.png')<br/>outputs = predictor(im)<br/>v = Visualizer(im[:, :, ::-1],<br/>  metadata=ball_metadata,<br/>  scale=1)<br/>out = v.draw_instance_predictions(outputs["instances"].to("cpu"))<br/>cv2_imshow(out.get_image()[:, :, ::-1])</span></pre><p id="281a" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">且看结果！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/db93da3da060c69b724d8d46f7b0c411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*3bQGvvWglTp-OJBS-ClrIA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">被训练模型检测到的棒球。</p></figure><h1 id="9217" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">加载视频/图像，应用训练好的模型进行检测</h1><p id="9195" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">现在我有了训练好的模型，我可以加载我想要进行检测的图像/视频。</p><p id="5357" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我编写了一个脚本，使用 OpenCV 逐帧读取视频，并使用每一帧的模型检测棒球。所以我现在有了检测到的棒球的信息，例如每一帧的位置，以便进一步分析。我还可以输出棒球检测视频！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/a675258d01d2b016bdcb918dc07cfeda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*u0ZZTP-1ITPZMqzXGHbM-w.gif"/></div></figure><h1 id="1232" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">未来工作:</h1><ol class=""><li id="e515" class="mv mw it ls b lt lu lw lx lz nx md ny mh nz ml na nb nc nd bi translated">应用对象跟踪来跟踪球</li></ol><div class="oa ob gp gr oc od"><a rel="noopener follow" target="_blank" href="/detect-and-track-baseball-using-detectron2-and-sort-6dd92a46e6f2"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">检测和跟踪棒球使用探测器 2 和排序</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">当视频中有多个棒球时，我如何跟踪棒球。</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">towardsdatascience.com</p></div></div><div class="om l"><div class="on l oo op oq om or ks od"/></div></div></a></div><ol class=""><li id="6686" class="mv mw it ls b lt mm lw mn lz mx md my mh mz ml na nb nc nd bi translated">计算球的速度和发射角度</li><li id="0958" class="mv mw it ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">一些快速移动的球不能被识别，这可能有助于扩展训练数据集并包括一些快速移动的、扭曲的和模糊的球</li><li id="bd54" class="mv mw it ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">构建 web 应用程序</li></ol><p id="d643" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">感谢阅读。欢迎反馈和建议！</p></div></div>    
</body>
</html>