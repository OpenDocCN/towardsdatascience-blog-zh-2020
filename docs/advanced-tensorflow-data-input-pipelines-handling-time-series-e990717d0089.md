# 高级 Tensorflow 数据输入管道:处理时间序列

> 原文：<https://towardsdatascience.com/advanced-tensorflow-data-input-pipelines-handling-time-series-e990717d0089?source=collection_archive---------16----------------------->

## 提取标签、多变量序列窗口、多个 TF 记录文件碎片和其他处理顺序数据的有用技巧

![](img/c8483234dae322e545049bba143815a6.png)

[图片来自 Pixabay 的 stux](https://pixabay.com/photos/grow-blossom-time-lapse-sequence-73353/)

[tf.data.Dataset](https://www.tensorflow.org/guide/data) API 是一个非常高效的管道构建器。时序任务的正确实现可能有点棘手。在本文中，我们将深入探讨常见任务:

*   窗口标记数据
*   通过前瞻设置未标记数据的窗口
*   分片 TF 记录文件提高效率和无数据丢失的技巧

我们开始吧！

# 窗口标记数据

有了数据集 api，这很容易做到。假设以下配置。输入特征为`a`，标签为`b`。

```
a, b
1, 0
2, 0
3, 1
4, 0
5, 0
6, 1
```

每一行都可以用一个张量形状的`(2,)`来描述。所以我们的数据集大小为`(6, 2)`。

现在，用一个窗口大小的`2`，产生训练数据。这看起来像是:

```
1, 2 -> 0 (label of row 2)
2, 3 -> 1 (label of row 3)
4, 5 -> 0 ...
```

`.window()`函数实际上产生了一组数据集。这就是为什么我们需要做一个`.flat_map(batch)`运算来得到一系列我们可以统一处理的张量。

# 通过前瞻设置未标记数据的窗口

有时你只想预测一个序列的下一个滴答。这可以在没有标签的情况下完成。对于输入数据集:

```
a
1
2
3
4
5
6
```

训练对将是(同样，窗口大小为`2`):

```
1, 2 -> 3
2, 3 -> 4
4, 5 -> 6
```

让我们尝试采用前面的方法，使用大小为`3`的窗口，保留最后一个元素作为标签。

> 数据丢失

实现这一点的最佳方法是创建 2 个类似的数据集管道，窗口大小为`2`，但其中一个管道滞后于前端。

# 分片 TF 记录文件提高效率和无数据丢失的技巧

大规模深度学习输入管道的典型方式是将输入数据分割成 1-100 兆字节范围内的文件，这些文件可以顺序和并行读取。这意味着，通过只使用旋转驱动器而不是固态硬盘来保持性能，存储服务器成本大幅降低。

这种做法的一个非常常见的例子是将 TF 记录存储在 Hadoop 文件系统或基于存储桶的公共云解决方案(如 Google Cloud Storage)中。

将 X-Y 对数据集(如图像)分割成多个文件是很简单的。对于手头的时间序列窗口任务，保持序列完整性和避免数据丢失变得很棘手。

让我们看一个简单的例子。

```
File 1
----------
a, b
1, 1
1, 2
1, 3File 2
----------
a, b
1, 4
1, 5
1, 6
1, 7
```

当然，你可以得到一个文件包，把它们加载起来，直接推给训练。但是你有很多问题。

首先，为了获得最佳性能，2+个碎片之间的顺序是不确定的。这意味着您的数据将**无序，**类似于位置不变的并行算法，如 map-reduce。

您最终将同时打开文件 1 的第 1 行和文件 2 的第 2 行，而另一个工人同时打开文件 1 的第 2 行和文件 2 的第 1 行。

故障部分现已修复。但是还有一个问题需要仔细检查。缺少**跨文件数据**。如果文件 2 是文件 1 的序列延续，您需要确保您的回顾窗口包括这两个文件之间的链接。否则，你会丢失数据点。

这意味着，当`tf.data.Dataset`解析分片文件时，为您的模型生成的最终数据集需要包括(让我们为 2 个窗口演示这一点):

```
(a)1,2 and (a)1,3 -> (b)1, 4
(a)1,3 and (b)1,4 -> (b)1, 5
```

当然，你可以删除这几个数据点。但是请记住，窗口越大，丢失的数据点就越多。根据数据的性质和大小，做出正确的决定。

如果您像我们在上面的**窗口未标记数据中通过前瞻**部分演示的那样强制执行纯顺序读取，您将不会从并行读取加速中受益。

简单而有效的解决方案是制作多个数据集，然后按 2 的顺序将它们连接起来。

# 结论

您甚至可以使用这种优化的管道在一个或多个 TPU 上用大量的时间序列数据进行训练。

通过实现本文中提到的技术，您可以避免常见的缺陷，如数据丢失和顺序完整性，从而为顺序数据创建高性能的管道。

恭喜你！你已经取得了时间序列**卓越**。

谢谢你一路看完！