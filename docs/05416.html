<html>
<head>
<title>Rendering OpenAI Gym Envs on Binder and Google Colab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Binder和Google Colab上渲染OpenAI健身房环境</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/rendering-openai-gym-envs-on-binder-and-google-colab-536f99391cc7?source=collection_archive---------18-----------------------#2020-05-07">https://towardsdatascience.com/rendering-openai-gym-envs-on-binder-and-google-colab-536f99391cc7?source=collection_archive---------18-----------------------#2020-05-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bc16" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于解决一个乏味(但重要)问题的笔记</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d4e906611d72c0c274fa6660f2dbb66f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8aHpWuMJHxbLdGeQRTXrfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在Google Colab或Binder中远程渲染OpenAI envs很容易(一旦你知道了配方！).</p></figure><p id="7503" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我目前正在使用我的新冠肺炎强制隔离来扩展我的深度学习技能，完成了来自<a class="ae lu" href="https://www.udacity.com/" rel="noopener ugc nofollow" target="_blank"> Udacity </a>的<a class="ae lu" href="https://www.udacity.com/course/deep-reinforcement-learning-nanodegree--nd893" rel="noopener ugc nofollow" target="_blank"> <em class="lv">深度强化学习纳米学位</em> </a>。当在远程服务器上训练时，我几乎立刻就遇到了让我的模拟正确渲染的乏味问题。</p><p id="d7de" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">特别是，让<a class="ae lu" href="https://openai.com/" rel="noopener ugc nofollow" target="_blank"> OpenAI </a> <a class="ae lu" href="https://gym.openai.com/docs/" rel="noopener ugc nofollow" target="_blank"> Gym </a>环境在远程服务器上正确渲染，比如那些支持流行的免费计算设施的服务器，如<a class="ae lu" href="https://colab.research.google.com/notebooks/intro.ipynb" rel="noopener ugc nofollow" target="_blank"> Google Colab </a>和<a class="ae lu" href="https://mybinder.org/" rel="noopener ugc nofollow" target="_blank"> Binder </a>比我预期的更具挑战性。在这篇文章中，我列出了我的解决方案，希望我可以节省其他人的时间和精力来独立解决这个问题。</p><h1 id="d8cc" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Google Colab序言</h1><p id="8a42" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">如果你希望使用Google Colab，那么这个部分就是为你准备的！否则，您可以跳到活页夹前言的下一节。</p><h2 id="4945" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">安装X11系统依赖项</h2><p id="01ee" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">首先，您需要安装必要的<a class="ae lu" href="https://en.wikipedia.org/wiki/X_Window_System" rel="noopener ugc nofollow" target="_blank"> X11 </a>依赖项，特别是<a class="ae lu" href="https://www.x.org/releases/X11R7.7/doc/man/man1/Xvfb.1.xhtml" rel="noopener ugc nofollow" target="_blank"> Xvfb </a>，它是一个可以在没有显示硬件和物理输入设备的机器上运行的X服务器。您可以在Colab笔记本中安装系统依赖项，方法是在install命令前面加上一个感叹号(<code class="fe nf ng nh ni b">!</code>)，它将在自己的Bash shell中运行该命令。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="c3b3" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong>apt-get install -y xvfb x11-utils</span></pre><h2 id="ed0a" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">安装其他Python依赖项</h2><p id="0746" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">现在您已经安装了Xvfb，您需要安装一个Python包装器<code class="fe nf ng nh ni b">pyvirtualdisplay</code>,以便在Python中与Xvfb虚拟显示交互。你还需要为<a class="ae lu" href="https://www.opengl.org/" rel="noopener ugc nofollow" target="_blank"> OpenGL </a> : <a class="ae lu" href="http://pyopengl.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> PyOpenGL </a>和<a class="ae lu" href="https://pypi.org/project/PyOpenGL-accelerate/" rel="noopener ugc nofollow" target="_blank"> PyOpenGL-accelerate </a>安装Python绑定。前者是实际的Python绑定，后者是一组可选的C (Cython)扩展，为PyOpenGL 3.x中的常见操作提供加速。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="f4bb" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong>pip install pyvirtualdisplay<strong class="ni iu">==</strong>0.2.* \<br/>             PyOpenGL<strong class="ni iu">==</strong>3.1.* \<br/>             PyOpenGL-accelerate<strong class="ni iu">==</strong>3.1.*</span></pre><h2 id="bbbc" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">安装开放式健身房</h2><p id="e8c2" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">接下来，你需要安装OpenAI健身房包。请注意，根据您感兴趣的健身房环境，您可能需要添加额外的依赖项。因为我要在下面的演示中模拟LunarLander-v2环境，所以我需要安装<code class="fe nf ng nh ni b">box2d</code> extra来启用依赖于<a class="ae lu" href="https://box2d.org/" rel="noopener ugc nofollow" target="_blank"> Box2D </a>物理模拟器的健身房环境。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="46ae" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong>pip install gym<strong class="ni iu">[</strong>box2d<strong class="ni iu">]==</strong>0.17.*</span></pre><p id="ba60" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了简单起见，我将所有的软件安装步骤收集到一个代码块中，您可以将其剪切并粘贴到您的笔记本中。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="76ac" class="mt lx it ni b gy nn no l np nq">%%bash</span><span id="8f8d" class="mt lx it ni b gy nr no l np nq"><em class="lv"># install required system dependencies</em><br/>apt-get install -y xvfb x11-utils</span><span id="a260" class="mt lx it ni b gy nr no l np nq"><em class="lv"># install required python dependencies</em><br/>pip install gym<strong class="ni iu">[</strong>box2d<strong class="ni iu">]==</strong>0.17.* \<br/>            <em class="lv">pyvirtualdisplay</em><strong class="ni iu">==</strong>0.2.* \<br/>            <em class="lv">PyOpenGL</em><strong class="ni iu">==</strong>3.1.* \<br/>            PyOpenGL-accelerate<strong class="ni iu">==</strong>3.1.*</span></pre><h2 id="ac32" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">在背景中创建虚拟显示</h2><p id="671c" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">现在已经安装了所有需要的软件，您可以创建一个虚拟显示器(即在后台运行的显示器)，OpenAI Gym Envs可以连接到该显示器进行渲染。您可以通过确认<code class="fe nf ng nh ni b">DISPLAY</code>环境变量的值还没有被设置来检查当前是否没有显示。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="0858" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong><em class="lv">echo</em> <em class="lv">$DISPLAY</em></span></pre><p id="6013" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面单元格中的代码在背景中创建了一个虚拟显示，您的健身房env可以连接到该显示进行渲染。您可以随意调整虚拟缓冲区的<code class="fe nf ng nh ni b">size</code>，但在使用Xvfb时必须设置<code class="fe nf ng nh ni b">visible=False</code>。</p><p id="6767" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个代码只需要在你的笔记本上运行一次就可以开始显示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用pyvirtualdisplay启动Xvfb虚拟显示</p></figure><p id="789e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在笔记本上运行上述代码后，您可以再次回显环境变量<code class="fe nf ng nh ni b">DISPLAY</code>的值，以确认您现在有一个正在运行的显示。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="cad0" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong><em class="lv">echo</em> <em class="lv">$DISPLAY # should now be set to some value</em></span></pre><p id="1e03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了方便起见，我将上述步骤收集到两个单元格中，您可以复制并粘贴到您的Google Colab笔记本的顶部。</p><h1 id="f9cb" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">活页夹序言</h1><p id="e3d1" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">如果您希望使用<a class="ae lu" href="https://mybinder.org/" rel="noopener ugc nofollow" target="_blank">活页夹</a>，那么这一部分就是为您准备的！</p><h2 id="cd98" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">不需要额外安装！</h2><p id="347d" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">不像Google Colab，使用Binder你可以烘焙所有需要的依赖项(包括X11系统依赖项！)放入绑定器实例所基于的Docker映像中。这些配置文件可以位于Git repo的根目录中，也可以位于一个<code class="fe nf ng nh ni b">binder</code>子目录中(这是我的首选)。</p><h2 id="a4d8" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">binder/apt.txt</h2><p id="c327" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">需要定义的第一个配置文件是用于安装系统依赖项的<code class="fe nf ng nh ni b">apt.txt</code>文件。您可以创建一个适当命名的文件，然后列出您想要安装的依赖项(每行一个)。经过一段时间的反复试验，我发现了下面的成功组合。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="b8cb" class="mt lx it ni b gy nn no l np nq">freeglut3-dev<br/>xvfb<br/>x11-utils</span></pre><h2 id="9004" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">binder/environment.yml</h2><p id="bbf8" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">第二个配置文件是用于定义Conda环境的标准<code class="fe nf ng nh ni b">environment.yml</code>文件。如果你对Conda不熟悉，那么我建议你看看我最近写的关于<a class="ae lu" rel="noopener" target="_blank" href="/managing-project-specific-environments-with-conda-b8b50aa8be0e"><em class="lv">Conda</em></a><em class="lv"/>和<a class="ae lu" rel="noopener" target="_blank" href="/managing-project-specific-environments-with-conda-406365a539ab"> <em class="lv">使用Conda </em> </a> <em class="lv">管理特定项目环境的文章。</em></p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="fdb6" class="mt lx it ni b gy nn no l np nq">name: null </span><span id="fdc7" class="mt lx it ni b gy nr no l np nq">channels:<br/>  - conda-forge<br/>  - defaults </span><span id="b5df" class="mt lx it ni b gy nr no l np nq">dependencies:<br/>  - gym-box2d=0.17<br/>  - jupyterlab=2.0<br/>  - matplotlib=3.2<br/>  - pip=20.0<br/>  - pip:<br/>    - -r file:requirements.txt<br/>  - python=3.7<br/>  - pyvirtualdisplay=0.2</span></pre><h2 id="2233" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">binder/requirements.txt</h2><p id="2d99" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">最后需要的配置文件是Conda使用的<code class="fe nf ng nh ni b">requirements.txt</code>文件，用于安装任何额外的Python依赖项，这些依赖项不能通过使用<code class="fe nf ng nh ni b">pip</code>的Conda通道获得。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="7189" class="mt lx it ni b gy nn no l np nq">PyOpenGL==3.1.*<br/>PyOpenGL-accelerate==3.1.*</span></pre><p id="34b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你有兴趣学习更多关于Binder的知识，那就去看看<a class="ae lu" href="https://binderhub.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> BinderHub </a>的文档，这是Binder项目背后的底层技术。</p><h2 id="d862" class="mt lx it bd ly mu mv dn mc mw mx dp mg lh my mz mi ll na nb mk lp nc nd mm ne bi translated">在背景中创建虚拟显示</h2><p id="3899" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">接下来，您需要在背景中创建一个虚拟显示器，健身房env可以连接到该显示器进行渲染。您可以通过确认<code class="fe nf ng nh ni b">DISPLAY</code>环境变量的值尚未设置来检查当前是否没有显示。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="5333" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong><em class="lv">echo</em> <em class="lv">$DISPLAY</em></span></pre><p id="2cc2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面单元格中的代码在背景中创建了一个虚拟显示，您的健身房env可以连接到该显示进行渲染。您可以随意调整虚拟缓冲区的<code class="fe nf ng nh ni b">size</code>,但在使用Xvfb时必须设置<code class="fe nf ng nh ni b">visible=False</code>。</p><p id="7eaa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这段代码只需要在每个会话中运行一次就可以开始显示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">启动Xvfb虚拟显示与使用Google Colab完全一样！</p></figure><p id="3e6e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行上面的单元格后，您可以再次回显<code class="fe nf ng nh ni b">DISPLAY</code>环境变量的值，以确认您现在有一个正在运行的显示。</p><pre class="kj kk kl km gt nj ni nk nl aw nm bi"><span id="b563" class="mt lx it ni b gy nn no l np nq"><strong class="ni iu">!</strong><em class="lv">echo</em> <em class="lv">$DISPLAY</em></span></pre><h1 id="f202" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">演示</h1><p id="7d5f" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">只是为了证明上面的设置像宣传的那样有效，我将运行一个简短的模拟。首先我定义了一个<code class="fe nf ng nh ni b">Agent</code>，它从一组可能的动作中随机选择一个动作，然后定义一个函数，它可以用来创建这样的代理。然后我将代码打包，模拟一个开放的人工智能健身房环境中的一集。注意，实现假设所提供的环境支持<code class="fe nf ng nh ni b">rgb_array</code>渲染(不是所有的健身房环境都支持！).</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模拟“代理”与支持RGB数组渲染的OpenAI Gym环境交互</p></figure><p id="fb8a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">目前，在模拟过程中似乎有相当数量的闪烁。不完全确定是什么导致了这种不良行为。如果你有任何改进的想法，请在下面留下评论。如果我找到一个好的解决方法，我一定会相应地更新这篇文章。</p></div></div>    
</body>
</html>