<html>
<head>
<title>Step by Step Guide of AWS Elastic Container Service(With Images)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS 弹性容器服务的逐步指南(附图片)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/step-by-step-guide-of-aws-elastic-container-service-with-images-c258078130ce?source=collection_archive---------12-----------------------#2020-06-20">https://towardsdatascience.com/step-by-step-guide-of-aws-elastic-container-service-with-images-c258078130ce?source=collection_archive---------12-----------------------#2020-06-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bf53" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">部署您的容器并配置为访问 AWS 资源</h2></div><p id="52ab" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我将展示使用 AWS ECS 部署 docker 容器的过程，并配置它来访问其他 AWS 资源。现在，让我们直接进入核心。</p><p id="3036" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">先决条件:对 docker，AWS 的基本了解，你需要有一个具有管理员权限的 AWS 帐户。</em></p><h1 id="f6c3" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">建造一个容器</h1><p id="575f" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">如果您已经准备好要部署的容器，那么您可以跳过这一部分。如果没有，我写了一个最简单的 python 项目<a class="ae mc" href="https://github.com/MJeremy2017/ecs-example" rel="noopener ugc nofollow" target="_blank">这里是</a>，其中有 docker 容器最基本的结构:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8642" class="mm lg it mi b gy mn mo l mp mq">ecs-example:<br/>    |_ model<br/>    |    |_ run.py<br/>    |    |_ sample.txt<br/>    |<br/>    |_ docker-entrypoint.sh<br/>    |_ Dockerfile<br/>    |_ requirements.txt</span></pre><p id="e0f7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">主文件<code class="fe mr ms mt mi b">run.py</code>驻留在<code class="fe mr ms mt mi b">model</code>文件夹中，它所做的只是将<code class="fe mr ms mt mi b">sample.txt</code>上传到<code class="fe mr ms mt mi b">s3</code> (S3 是 AWS 存储数据的简单存储系统)</p><figure class="md me mf mg gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a7a0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mr ms mt mi b">docker-entrypoint.sh</code>定义了在容器开始时运行的命令</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b4d6" class="mm lg it mi b gy mn mo l mp mq"><strong class="mi iu">#!/usr/bin/env bash<br/><br/></strong>export PYTHONPATH=.<br/><br/>python3 model/run.py</span></pre><p id="2bab" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以当容器启动时，它会调用上面写的<code class="fe mr ms mt mi b">run.py</code>并将指定的文件加载到 s3。</p><p id="2349" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在看看我们的<code class="fe mr ms mt mi b">Dockerfile</code></p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9565" class="mm lg it mi b gy mn mo l mp mq">FROM python:3.7-slim<br/><br/>ENV <em class="le">APP_DIR </em>/ecs-example<br/><br/>RUN mkdir -p ${<em class="le">APP_DIR</em>}<br/><br/>WORKDIR ${<em class="le">APP_DIR</em>}<br/><br/>ADD ./requirements.txt ${<em class="le">APP_DIR</em>}<br/>RUN pip install -r requirements.txt<br/><br/>COPY ./model ${<em class="le">APP_DIR</em>}/model<br/>COPY ./docker-entrypoint.sh ${<em class="le">APP_DIR</em>}/docker-entrypoint.sh<br/><br/>ENTRYPOINT ${<em class="le">APP_DIR</em>}/docker-entrypoint.sh</span></pre><p id="17b0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它做以下事情，</p><ol class=""><li id="6f21" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated">设置工作目录</li><li id="66d1" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">安装所需的软件包</li><li id="3f18" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">将本地文件复制到 docker 容器中</li><li id="3398" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated">在容器的起点设置起点</li></ol><p id="23b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们的演示项目已经设置好了，让我们构建并标记我们的容器，并将它推送到您自己的 docker hub。</p><p id="ed58" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在项目根目录中，执行以下操作</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="5e17" class="mm lg it mi b gy mn mo l mp mq">docker build -t ecs-example .<br/>(Optional) docker run ecs-example</span></pre><p id="3ef9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">标记并推送至私有回购</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9002" class="mm lg it mi b gy mn mo l mp mq">docker tag ecs-example {YOUR_REPO_ACCOUNT}/ecs-example:v1<br/>docker push {YOUR_REPO_ACCOUNT}/ecs-example:v1</span></pre><p id="1b16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在转到您的私有 docker 注册表，您应该会在您的回购中看到它，如下所示:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/1935f5b648692c611cded9c0049ee1d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MFDDS_ldEkRJPulziI8a9w.png"/></div></div></figure><p id="89a4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经将项目装箱并发布了，让我们开始部署吧。</p><h1 id="8418" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">在 ECS 上部署</h1><p id="ccea" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">ECS 代表弹性集装箱服务。顾名思义，这是一项专门用于管理 docker 容器的服务，但其优势在于简化了容器部署的过程，并避免了来自用户的繁重工作。简而言之，这可能是在云上部署容器的最简单的方式，并且具有适当的标准。(有关更多信息，您可以在此处阅读文档<a class="ae mc" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"/></p><h2 id="b39a" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">ECS 概述</h2><p id="a50c" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">首先，去你的 AWS 控制台，搜索弹性容器服务或者仅仅是 ECS。</p><p id="bfea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你开始的最快方法可能是点击首页的<code class="fe mr ms mt mi b">Get Started</code>按钮，并遵循指导，但在这篇文章中，我们将手动构建每个组件，我相信这将使你对每个部分有更深的理解，而且对于我们的容器来说，访问 S3，它需要额外的配置，这是“开始”不允许的。</p><p id="e4ae" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们来了解一下 ECS 中的组件，</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi od"><img src="../Images/24fc35319fbed523d68be702dbb000c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HEyDpRq-O4oIh3wrjHa1BQ.png"/></div></div></figure><ol class=""><li id="d185" class="mx my it kk b kl km ko kp kr mz kv na kz nb ld nc nd ne nf bi translated"><strong class="kk iu">容器定义</strong>:定义你的容器镜像、环境变量、存储挂载等等。</li><li id="bb8a" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated"><strong class="kk iu">任务定义</strong>:包装你的容器，是你部署的蓝图，为你的容器指定角色，如何拉取图像等等。</li><li id="e220" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated"><strong class="kk iu">服务</strong>:管理要部署多少容器实例，它应该驻留在哪个网络中等等。</li><li id="92b8" class="mx my it kk b kl ng ko nh kr ni kv nj kz nk ld nc nd ne nf bi translated"><strong class="kk iu">集群</strong>:包含 VPC、子网等。</li></ol><h2 id="c457" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">创建一个集群</h2><p id="a2c6" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">首先，让我们创建一个集群。选择边栏上的集群并选择<code class="fe mr ms mt mi b">Create Cluster</code>，</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oe"><img src="../Images/0a9a11641970e4b5d289bd4a3c7e1403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YADVEZXityjSyO9QVTLalg.png"/></div></div></figure><p id="0da1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择<code class="fe mr ms mt mi b">Networking only</code>，并选择下一步。<code class="fe mr ms mt mi b">Networking only</code>是为 Fargate taks 建造的。与 EC2 任务相反，</p><p id="7cd4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">Fargate 启动类型允许您运行您的容器化应用程序，而无需供应和管理后端基础架构。当您使用与 Fargate 兼容的任务定义运行任务时，Fargate 会为您启动容器。</em></p><p id="7225" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基本上，使用这种类型，AWS 可以为您处理大部分基础设施，因此您最不用担心。</p><p id="dd82" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步，输入您的<strong class="kk iu">集群名称</strong>(这里我使用 ecs-example-cluster)，选择<strong class="kk iu">创建新的 VPC </strong>(如果您没有的话)，然后<strong class="kk iu">启用容器洞察</strong>(这将提供 CloudWatch 监控和帮助调试)。</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi of"><img src="../Images/769b90b411e801590cc4648afcff2297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GDELARHcMhmKf3Wl82tTJA.png"/></div></div></figure><p id="b1dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并点击<strong class="kk iu">创建</strong>。您的集群应该马上就准备好了。</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi og"><img src="../Images/81ac233e41724bdb4a578dffb6ddfb7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nTQpO0IS8BL534hTkWNo_g.png"/></div></div></figure><p id="1c91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为您的集群设置了一组资源。现在让我们转到任务定义。</p><h2 id="0c3c" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">创建任务定义</h2><p id="dd5d" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">现在让我们开始创建您的容器蓝图。在工具条上，选择<strong class="kk iu">任务定义</strong>并选择<strong class="kk iu">创建新的任务定义</strong>。</p><p id="4dc5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择<strong class="kk iu"> Fargate </strong>(如果您希望 AWS 为您处理 infra)，它将引导您:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oh"><img src="../Images/8e674101c1524d7da5a233250744f202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ay8UKDNIvaSTuqDyKDjM6Q.png"/></div></div></figure><h2 id="29f7" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated"><strong class="ak">创建任务角色</strong></h2><p id="941b" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">为您的任务定义命名。并为您的容器选择一个任务角色，但是等等，什么是任务角色？如输入中所解释的，</p><p id="f7f9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="le">任务角色</em> </strong> <em class="le">:可选的 IAM 角色，任务可以使用它向授权的 AWS 服务发出 API 请求。在 IAM 控制台中创建一个 Amazon 弹性容器服务任务角色</em></p><p id="778e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">记得我们的容器需要上传一个文件到 S3 吗？因此，要允许您的容器访问 s3，它需要一个角色来授权它这样做。(更多信息，请点击此处获取官方文档<a class="ae mc" href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/task-iam-roles.html" rel="noopener ugc nofollow" target="_blank">)</a></p><p id="fe8d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在在一个新标签页中打开 AWS 控制台。</p><p id="4c88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择服务<strong class="kk iu"> IAM </strong> →选择<strong class="kk iu">角色</strong> → <strong class="kk iu">创建角色</strong></p><p id="8edf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">选择可信实体类型</strong>部分，选择<strong class="kk iu"> AWS 服务</strong>。</p><p id="a752" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">选择将使用这个角色</strong>的服务，选择<strong class="kk iu">弹性容器服务</strong>。</p><p id="3051" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">选择您的用例</strong>，选择<strong class="kk iu">弹性容器服务任务</strong>并选择<strong class="kk iu">下一步:权限</strong>。</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/3fd318b6deed9d98723974f9720d9aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a4mRYHOhcKXevxw98Ea_AQ.png"/></div></div></figure><p id="7a93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于我们访问 s3 的服务，选择<strong class="kk iu"> Amazons3FullAccess </strong>(这不是授予 S3 对服务的完全访问权的最佳实践，您可能需要通过创建新的<strong class="kk iu">策略</strong>来将服务限制到某个桶)。</p><p id="20a8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">添加标签(可选)</strong>，输入您想要与 IAM 角色关联的任何元数据标签，然后选择<strong class="kk iu">下一步:查看</strong>。</p><p id="9644" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">角色名称</strong>，输入您的角色名称。对于本例，键入<code class="fe mr ms mt mi b">ECSs3AccessTaskRole</code>来命名角色，然后选择<strong class="kk iu">创建角色</strong>来完成。</p><p id="9717" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在回到任务定义</p><p id="225a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将您刚刚创建的角色选择到任务角色中。</p><p id="0a39" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">任务执行 IAM 角色</strong>，该角色有助于从 docker 寄存器中提取图像，因此如果您还没有该角色，我们首先需要创建它。角色创建过程与上面类似，您可以在这里按照步骤<a class="ae mc" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html#create-task-execution-role" rel="noopener ugc nofollow" target="_blank">操作</a>。(这里创建的角色名称是<code class="fe mr ms mt mi b">ecsTaskExecutionRole</code>！)</p><p id="397c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而对于<strong class="kk iu">任务大小</strong>，我们都选择最小，当然我们的任务简单，不需要太多资源。</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oj"><img src="../Images/75c7983686041582f1f3381c5d34f1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ov0N2QZNETHCNvDx3LO0yA.png"/></div></div></figure><p id="8590" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">任务执行角色不同于我们刚刚创建的任务角色，如创建过程中所述:</p><p id="f4cb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="le">任务执行角色</em> </strong> <em class="le">:这个角色是任务需要的，代表你拉容器镜像，发布容器日志到 Amazon CloudWatch。</em></p><p id="d2ad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="le">任务角色</em> </strong> <em class="le">:可选的 IAM 角色，任务可以使用它向授权的 AWS 服务发出 API 请求。在 IAM 控制台中创建一个 Amazon 弹性容器服务任务角色</em></p><p id="cd99" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从堆栈溢出<a class="ae mc" href="https://stackoverflow.com/questions/48999472/difference-between-aws-elastic-container-services-ecs-executionrole-and-taskr" rel="noopener ugc nofollow" target="_blank">到这里</a>的一个很好的区别解释。</p><h2 id="ce4c" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">添加容器</h2><p id="a83b" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">现在最重要的是，让我们来看看容器的定义。输入以下内容:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ok"><img src="../Images/654661fb1e66aa0aac85ec4da3f59b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VejJbgb1JP2eXNyuaxSblg.png"/></div></div></figure><p id="0356" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于<strong class="kk iu">图像* </strong>，输入您的私人图像注册表 url。勾选<strong class="kk iu">私有存储库认证</strong>，因为我们的映像驻留在 docker hub 上的私有回购中。为了让我们的服务访问我们的私人注册表，我们需要告诉代理我们的帐户和密码。AWS 上管理秘密的方式是使用<strong class="kk iu">秘密管理器</strong>。</p><h2 id="4aba" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">创建秘密</h2><p id="c333" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">再次转到 AWS 控制台→选择机密管理器→存储新机密→其他类型的机密</p><p id="07e0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输入纯文本:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="ad81" class="mm lg it mi b gy mn mo l mp mq">{<br/>  "username": {YOUR_DOCKER_ACCOUNT},<br/>  "password": {YOUR_DOCKER_PWD}<br/>}</span></pre><p id="165b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择下一步，给你的秘密一个名字，其他的就用默认的。</p><p id="f80e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建后，你应该有这样的东西:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ol"><img src="../Images/5a9d49a21e32f03ded2a63b60c86bec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ylq_vB8tWn6mGphw_D5P8g.png"/></div></div></figure><p id="6d65" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击您的秘密，您可以检索您的秘密 ARN，并输入这个 ARN 到上面的容器定义！</p><p id="4865" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然我们已经在容器中输入了我们的秘密，但是请记住，fargate 代理使用任务执行角色从您的私有注册表中提取图像，您可以这样理解这个过程:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi om"><img src="../Images/fa8cf49ad92beb631b4f77e8fe5356f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pVh68E_xpcL3N4pRZikVyg.png"/></div></div></figure><p id="b1ce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，下一步是将这个秘密添加到我们上面创建的执行角色中。</p><h2 id="106f" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">向任务执行角色添加机密</h2><p id="cf64" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">现在再次转到 IAM 下的执行角色，添加<strong class="kk iu">内联策略</strong>:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi on"><img src="../Images/fc2073c3402d1c8431b5286688cb6498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xJirBcgXZYBSb0vagWR6kQ.png"/></div></div></figure><p id="a6f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择 Json 格式并输入、</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="888d" class="mm lg it mi b gy mn mo l mp mq">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "secretsmanager:GetSecretValue"<br/>            ],<br/>            "Resource": [<br/>               {YOUR_SECRET_ARN}<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="babd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我知道很累，但我们就要完成了！现在我们的任务定义完成了！回到我们的任务定义，保留其他为默认，并点击<strong class="kk iu">创建</strong>。</p><h2 id="dcee" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">创建服务并部署任务定义</h2><p id="d4f1" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我们已经完成了最难的部分，现在我们需要的是创建最后一个组件——服务并部署我们的任务！</p><p id="9fbf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在侧面板上，单击集群</p><p id="c385" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择 ECS-示例-集群</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oo"><img src="../Images/63ad68f220a1f6692c75538ea433929a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GcNoAUmu-O0KLOHBpSZRw.png"/></div></div></figure><p id="091b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在服务选项卡下，选择创建，并输入以下内容:</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi op"><img src="../Images/6a9d5343d9595ee15458fc4a4ff3b69f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JRCiwjip7oAWL-LSmpT_5A.png"/></div></div></figure><p id="eb7c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择下一步，对于 VPC，只需选择我们在<strong class="kk iu">创建集群会话中创建的 VPC 和子网，</strong>其他保持默认，最后创建服务。</p><p id="b883" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在转到“service”选项卡，您应该会看到作业正在运行…</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oq"><img src="../Images/3fd05ff5c64ed3b3ce8aa9458f849190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vZKOSY7AofXBrVr2oMnDog.png"/></div></div></figure><p id="85dd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了验证我们的工作，请转到 s3，您应该看到(前提条件是，您应该在此之前创建了您的存储桶):</p><figure class="md me mf mg gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi or"><img src="../Images/81ecc441947fbeb186539a60999ac69d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8rE933orPNlSpBXjK5BrJw.png"/></div></div></figure><p id="99ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">搞定了。我们的容器成功部署，文件上传到 S3！</p><h2 id="0bd0" class="mm lg it bd lh ns nt dn ll nu nv dp lp kr nw nx lr kv ny nz lt kz oa ob lv oc bi translated">删除集群</h2><p id="3d88" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">要删除我们的集群，首先删除我们的服务，然后删除集群，这需要几分钟才能生效。</p></div></div>    
</body>
</html>