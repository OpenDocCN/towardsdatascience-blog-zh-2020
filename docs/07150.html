<html>
<head>
<title>How to secure Python Flask Web APIs with Azure AD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Azure AD 保护 Python Flask Web APIs</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-secure-python-flask-web-apis-with-azure-ad-14b46b8abf22?source=collection_archive---------13-----------------------#2020-06-01">https://towardsdatascience.com/how-to-secure-python-flask-web-apis-with-azure-ad-14b46b8abf22?source=collection_archive---------13-----------------------#2020-06-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ed0a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习在 web 应用和 Azure SQL 中使用身份和令牌</h2></div><h1 id="b927" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.介绍</h1><p id="60ac" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Python Flask 是创建 web 应用程序的流行工具。使用 Azure AD，用户可以向 REST APIs 进行身份验证，并从 Azure SQL 检索数据。在这篇博客中，创建了一个示例 Python web 应用程序，如下所示:</p><ul class=""><li id="5ecf" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">1a:用户登录 web 应用程序并获得一个令牌</li><li id="2d23" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">1b:用户调用 REST API 来请求数据集</li><li id="51f9" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">2: Web 应用程序使用令牌中的声明来验证用户对数据集的访问</li><li id="5cdc" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">3: Web app 从 Azure SQL 检索数据。Web 应用程序可以配置为 a)应用程序的托管身份或 b)登录的用户身份用于数据库的身份验证</li></ul><p id="e2af" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">项目的代码可以在<a class="ae mp" href="https://github.com/rebremer/ms-identity-python-webapp-backend" rel="noopener ugc nofollow" target="_blank">这里找到</a>，架构可以在下面找到。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mq"><img src="../Images/f8221765d8270103ed7403cbe842b016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_AV6rTN0UdbKNdhI7LR87Q.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">1.使用 Azure AD 保护 Python Flask web APIs 简介。图片作者。</p></figure><p id="03e7" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">在本博客的剩余部分，将执行以下步骤:</p><ul class=""><li id="4ce1" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">步骤 1:获取令牌并使用令牌调用 api</li><li id="0843" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">步骤 2:验证令牌中的声明</li><li id="7ffb" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">步骤 3a:应用程序管理的身份认证</li><li id="1fff" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">步骤 3b:登录的用户通过认证</li></ul><p id="4c5c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">要了解如何使用授权或应用程序权限访问 Azure Function 后端，请参见<a class="ae mp" rel="noopener" target="_blank" href="/how-to-use-the-microsoft-identity-platform-in-your-azure-web-app-fcb3839a44e5">我的后续博客</a>，它与我的博客共享相同的 git repo。</p><h1 id="9554" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 1:获取令牌并使用令牌调用 api</h1><p id="30f5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">此示例展示了如何使用 Flask 和 MSAL Python 构建一个 Python web 应用程序，该应用程序登录用户并访问 Azure SQL 数据库。有关协议在这个场景和其他场景中如何工作的更多信息，请参见 Azure AD 的<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-authentication-scenarios" rel="noopener ugc nofollow" target="_blank">认证场景。在该步骤中，执行以下子步骤:</a></p><ul class=""><li id="e96a" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">1.1:准备工作</li><li id="0345" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">1.2:创建和配置应用程序注册</li><li id="b174" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">1.3:配置 python webapp 项目</li><li id="2348" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">1.4:运行示例</li></ul><p id="4f7f" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">步骤 1 关注架构的以下部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ng"><img src="../Images/5587766feff3f3ad68c9ac38b43b5a09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvRw3wXttm7Z1decqKxTeg.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">步骤 1:获取令牌并使用令牌调用 api。图片作者。</p></figure><h2 id="7241" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">1.1:准备工作</h2><p id="b615" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">若要运行此示例，您需要:</p><ul class=""><li id="d375" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated"><a class="ae mp" href="https://www.python.org/downloads/release/python-2713/" rel="noopener ugc nofollow" target="_blank"> Python 2.7+ </a>或<a class="ae mp" href="https://www.python.org/downloads/release/python-364/" rel="noopener ugc nofollow" target="_blank"> Python 3+ </a></li><li id="6897" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">Azure 活动目录(Azure AD)租户。有关如何获得 Azure AD 租户的更多信息，请参见<a class="ae mp" href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-create-new-tenant" rel="noopener ugc nofollow" target="_blank">如何获得 Azure AD 租户。</a></li><li id="1e21" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">Git 克隆下面的项目:<code class="fe nt nu nv nw b">git clone https://github.com/rebremer/ms-identity-python-webapp-backend.git</code>或者下载并解压存储库。zip 文件。</li></ul><h2 id="7056" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">1.2:创建和配置应用程序注册</h2><p id="4b9c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">创建和配置应用程序注册，如下所示:</p><ul class=""><li id="4a50" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">使用此<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app" rel="noopener ugc nofollow" target="_blank">链接</a>中的步骤创建应用注册以创建应用注册。两个备注:</li><li id="51ca" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">使用<code class="fe nt nu nv nw b">http://localhost/getAToken</code>作为回复网址。如果您在创建过程中没有这样做，可以使用应用程序注册的<strong class="lc iu">验证</strong>选项卡添加它</li><li id="7b98" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">转到<strong class="lc iu">认证</strong>并启用隐式授权中的选项 ID 令牌</li><li id="9106" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">转到<strong class="lc iu">证书&amp;秘密</strong>创建一个秘密。复制客户端 id 和客户端密码</li></ul><h2 id="8ab1" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">1.3:配置 pythonwebapp 项目</h2><ol class=""><li id="86e2" class="lw lx it lc b ld le lg lh lj nx ln ny lr nz lv oa me mf mg bi translated">打开<code class="fe nt nu nv nw b">app_config.py</code>文件，改变下面的变量。</li><li id="0a0f" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv oa me mf mg bi translated">在步骤 1.2 中创建应用程序注册时，找到文本<code class="fe nt nu nv nw b">&lt;&lt;Enter_the_Client_Secret_here&gt;&gt; </code>，并将其替换为您的应用程序密码。</li><li id="8f66" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv oa me mf mg bi translated">找到文本<code class="fe nt nu nv nw b">&lt;&lt;Enter_the_Tenant_Name_Here&gt;&gt;</code>，用你的 Azure AD 租户名称替换现有值。</li><li id="6714" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv oa me mf mg bi translated">找到文本<code class="fe nt nu nv nw b">&lt;&lt;Enter_the_Application_Id_here&gt;&gt;</code>并用步骤 1.2 中应用程序注册的应用程序 ID (clientId)替换现有值。</li></ol><h2 id="2b1d" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">1.4:运行示例</h2><p id="a07b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">您需要使用 pip 安装依赖项，如下所示:</p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="5dae" class="nh kj it nw b gy of og l oh oi">$ pip install -r requirements.txt</span></pre><p id="9323" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">使用以下命令从 shell 或命令行运行 app.py:</p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="91ec" class="nh kj it nw b gy of og l oh oi">flask run --host localhost --port 5000</span></pre><p id="47a2" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">当 app 在本地运行时，可以通过 localhost:5000(不是 127.0.0.1:5000)访问。在步骤 1 之后，用户可以使用他们的 Azure AD 凭据登录。在下一步中，设置用户角色，这些角色可用于验证是否允许用户使用 API 检索数据。</p><h1 id="1e18" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 2:验证令牌中的声明</h1><p id="0bb9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在此步骤中，可以设置令牌中的声明，令牌可以只是 web 应用程序，以验证是否允许用户调用 api。有关令牌声明的更多信息，请参见<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-optional-claims" rel="noopener ugc nofollow" target="_blank">此</a>链接。执行以下子步骤:</p><ul class=""><li id="c66e" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">2.1:在应用配置中设置配置</li><li id="5ca5" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">2.2:向清单添加角色</li><li id="0fea" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">2.3:将用户分配给角色</li></ul><p id="b0ce" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">第 2 步关注架构的后续部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oj"><img src="../Images/c2034a4b1c587790a607d4519191c5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2PC_GnoRSqitPw2L-vhzQ.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">步骤 2:验证令牌中的声明。图片作者。</p></figure><h2 id="29d8" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.1:在应用配置中设置配置</h2><p id="4e57" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">索赔验证是一个可选步骤，可以使用<code class="fe nt nu nv nw b">app_config.py</code>文件中的以下设置启用:<code class="fe nt nu nv nw b">AAD_ROLE_CHECK = True</code>。</p><h2 id="7977" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.2:向清单添加角色</h2><p id="1323" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">按照本教程<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps" rel="noopener ugc nofollow" target="_blank">中的步骤，向步骤 1.2 中创建的应用注册添加角色。显然，应使用以下方法:</a></p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="3ecb" class="nh kj it nw b gy of og l oh oi">"appRoles": [<br/>  {<br/>    "allowedMemberTypes": ["User"],<br/>    "description": "Basic user, only read product data from SQLDB",<br/>    "displayName": "basic_user_access",<br/>    "id": "a8161423-2e8e-46c4-9997-f984faccb625",<br/>    "isEnabled": true,<br/>    "value": "basic_user_access"<br/>  },<br/>  {<br/>    "allowedMemberTypes": ["User"],<br/>    "description": "Premium user, read all data from SQLDB",<br/>    "displayName": "premium_user_access",<br/>    "id": "b8161423-2e8e-46c4-9997-f984faccb625",<br/>    "isEnabled": true,<br/>    "value": "premium_user_access"<br/>  }<br/>],</span></pre><h2 id="91bd" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.3:将用户分配给角色</h2><p id="ae77" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps#assign-users-and-groups-to-roles" rel="noopener ugc nofollow" target="_blank">链接</a>中解释了用户的分配。作为测试，可以创建两个用户。用户 1 被分配了<code class="fe nt nu nv nw b">basic_user_access</code>，而用户 2 获得了<code class="fe nt nu nv nw b">premium_user_access</code>角色。</p><p id="8e42" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">下一步，创建 Azure SQL 数据库，并使用应用程序身份从数据库中检索数据。</p><h1 id="3afc" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 3a:应用程序管理的身份认证</h1><p id="4f3c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在此步骤中，应用程序的托管身份用于检索数据，该数据链接到在步骤 1 中创建的应用程序注册。执行以下子步骤:</p><ul class=""><li id="61f0" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">3a.1:创建 Azure SQL 数据库</li><li id="e032" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">3a.2:在应用配置中设置配置</li></ul><p id="18b6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">步骤 3a 关注架构的以下部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ok"><img src="../Images/94e85a74dc7a9022a8c1f288306c920a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_NwPFLBMAMNDvNtEfDQ2Q.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">步骤 3a:向 Azure SQL 应用托管身份认证。图片作者。</p></figure><h2 id="d6a0" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">3a.1:创建 Azure SQL 数据库</h2><p id="34d6" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">使用这个<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/single-database-create-quickstart?tabs=azure-portal#create-a-single-database" rel="noopener ugc nofollow" target="_blank">链接</a>创建一个 Azure SQL DB，其中可以选择最便宜的 SKU(基本)。确保完成以下工作:</p><ul class=""><li id="90c0" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">AdvertureWorks 作为示例数据库安装，可以选择最便宜的数据库(SKU 基本)。</li><li id="35c4" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">使用正确的读者角色将应用程序身份作为用户添加到 Azure SQL 数据库，请参见以下示例</li></ul><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="6be1" class="nh kj it nw b gy of og l oh oi">CREATE USER [&lt;&lt;Name of app registration&gt;&gt;] FROM EXTERNAL PROVIDER;<br/>EXEC sp_addrolemember [db_datareader], [&lt;&lt;Name of app registration&gt;&gt;];</span></pre><h2 id="48bb" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">3a.2:在应用配置中设置配置</h2><p id="7ee8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">backend_settings 需要设置为 database。还要确保连接中填入了您的设置。由于使用了 app 的 MI，application_permissions 需要指向"https://database.windows.net//。默认”在<code class="fe nt nu nv nw b">app_config.py</code>文件中，也见下文。</p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="cb17" class="nh kj it nw b gy of og l oh oi"># 2. Type of BACKEND<br/>#<br/># Option 2a. Database<br/>BACKEND_SETTINGS = {"Type": "Database", "Connection":{"SQL_SERVER": "&lt;&lt;Enter_logical_SQL_server_URL_here&gt;&gt;.database.windows.net", "DATABASE": "&lt;&lt;Enter_SQL_database_name_here&gt;&gt;"}}</span><span id="852a" class="nh kj it nw b gy ol og l oh oi"># Option 3a. Delegated user is used to authenticate to Graph API, MI is then used to authenticate to backend</span><span id="4f00" class="nh kj it nw b gy ol og l oh oi">...</span><span id="1ff9" class="nh kj it nw b gy ol og l oh oi">APPLICATION_PERMISSIONS = ["https://database.windows.net//.default"]</span></pre><p id="1c8a" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">现在，应用程序可以按照步骤 1.4 中的描述运行。当您点击链接<code class="fe nt nu nv nw b">(Premium users only) Get Customer data from Database</code>时，将检索客户数据。随后，当点击链接<code class="fe nt nu nv nw b">Get Product data from Database</code>时，将检索产品数据(前提是在步骤 2 中为用户正确设置了声明或者检查被禁用)</p><p id="8491" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">在此步骤中，应用程序的身份用于检索数据。但是，用户的身份也可以通过(AAD passthrough)从数据库中检索数据。</p><h1 id="d7a9" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">步骤 3b:登录的用户通过认证</h1><p id="49d2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在该步骤中，用户本身的身份用于检索数据。这意味着在步骤 1 中创建的用于登录 web 应用程序的令牌也用于对数据库进行身份验证。执行以下子步骤:</p><ul class=""><li id="0049" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">3b.1:将 Azure SQL DB 范围添加到应用程序注册</li><li id="56f6" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">3b.2:将 AAD 用户添加到数据库</li><li id="f240" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">3b.3:在应用配置中设置配置</li></ul><p id="3656" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">步骤 3b 着重于体系结构的以下部分。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi om"><img src="../Images/29585e3359f128c316e22b677e9896a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*clDQlKBe6XRoTnvyvd-Mzw.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">步骤 3b:对 Azure SQL 的已登录用户直通身份验证。图片作者。</p></figure><h2 id="b242" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">3b.1:将 Azure SQL DB 范围添加到应用程序注册</h2><ul class=""><li id="9182" class="lw lx it lc b ld le lg lh lj nx ln ny lr nz lv md me mf mg bi translated">修改在步骤 1.2 中创建的应用程序注册。作为委派用户拥有 Azure SQL 数据库的权限。这个在<a class="ae mp" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/active-directory-interactive-connect-azure-sql-db#register-your-app-and-set-permissions" rel="noopener ugc nofollow" target="_blank">环节</a>中有解释</li><li id="2471" class="lw lx it lc b ld mh lg mi lj mj ln mk lr ml lv md me mf mg bi translated">重要提示:Azure SQL 数据库需要管理员同意。这可以通过在<strong class="lc iu">权限</strong>选项卡中选择<strong class="lc iu">默认目录</strong>的 Grant_admin 权限来完成，也可以在运行时登录完成</li></ul><h2 id="a7a1" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">3b.2:将 AAD 用户添加到数据库</h2><p id="93fe" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">因为在这个步骤中使用了 AAD passthrough，所以用户本身应该在 SQLDB 中具有适当的角色，作为外部用户和 datareader。参见下面的例子。</p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="dd8c" class="nh kj it nw b gy of og l oh oi">CREATE USER [&lt;&lt;AAD user email address&gt;&gt;] FROM EXTERNAL PROVIDER;<br/>EXEC sp_addrolemember [db_datareader], [&lt;&lt;AAD user email address&gt;&gt;];</span></pre><p id="4ee9" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">如果您想在数据库中的角色成员中获得更多的粒度，<code class="fe nt nu nv nw b">read_customer</code>从 SalesLT 中读取数据。客户，而<code class="fe nt nu nv nw b">read_product</code>从 SalesLT 读取数据。产品)</p><h2 id="6b9c" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">3b.3:在应用配置中设置配置</h2><p id="8ad8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">通过将 delegated_permissions 设置为[" https://SQL . azure syncapse-dogfood . net/User _ impersonation "]，可以在<code class="fe nt nu nv nw b">app_config.py</code>文件中设置 AAD 用户直通身份验证，另请参见下文</p><pre class="mr ms mt mu gt ob nw oc od aw oe bi"><span id="4cf3" class="nh kj it nw b gy of og l oh oi"># Option 3b. Delegated user is used to authenticate to backend, graph API disabled</span><span id="c9b4" class="nh kj it nw b gy ol og l oh oi">...</span><span id="3d1b" class="nh kj it nw b gy ol og l oh oi">DELEGATED_PERMISSONS = ["https://sql.azuresynapse-dogfood.net/user_impersonation"]</span></pre><p id="6899" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mm ll lm ln mn lp lq lr mo lt lu lv im bi translated">现在，应用程序可以按照步骤 1.4 中的描述运行，其中可以使用登录用户的身份从数据库中检索数据。</p><h1 id="7f7d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="1c8f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这篇博客中，创建了一个从 SQLDB 检索数据的 Python web 应用程序。讨论了用户声明、托管身份和登录用户直通令牌，以验证和授权用户从 Azure SQL 检索数据，另请参见下面的概述。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mq"><img src="../Images/f8221765d8270103ed7403cbe842b016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_AV6rTN0UdbKNdhI7LR87Q.png"/></div></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">4.使用 Azure AD 保护 Python Flask web APIs 结论。图片作者。</p></figure></div></div>    
</body>
</html>