<html>
<head>
<title>Querying Microsoft Graph API with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 查询 Microsoft Graph API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/querying-microsoft-graph-api-with-python-269118e8180c?source=collection_archive---------1-----------------------#2020-01-06">https://towardsdatascience.com/querying-microsoft-graph-api-with-python-269118e8180c?source=collection_archive---------1-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a788" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用微软的 REST API 和 Python 请求库获取 Azure 上的 O365 数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c2e41c1d8a70d489fb8c9b390a066f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5WDkCFfsNRXviWiQReDefw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae ky" href="https://www.pexels.com/@jay-kunwar-55532" rel="noopener ugc nofollow" target="_blank">周杰伦 K </a>上<a class="ae ky" href="https://www.pexels.com/photo/computer-monitor-on-table-204611/" rel="noopener ugc nofollow" target="_blank">像素</a></p></figure><h1 id="238e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="3de5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了向用户提供丰富的数据驱动体验，您可能需要将定制的应用程序与您组织的数据集成在一起。Microsoft Graph 是一个 REST API，它提供了与 Office 365 中的数据进行交互的能力。在这篇文章中，我将展示如何使用 python 连接到你的 Azure Active Directory (Azure AD)。主要步骤是在 Azure 上设置一个企业应用程序，并编写代码来处理数据。</p><blockquote class="mn mo mp"><p id="5f3c" class="lr ls mq lt b lu mr ju lw lx ms jx lz mt mu mc md mv mw mg mh mx my mk ml mm im bi translated">点击此处获取此服务<a class="ae ky" href="mailto:ephraimmwai.w@gmail.com" rel="noopener ugc nofollow" target="_blank"/></p></blockquote><h2 id="502a" class="mz la it bd lb na nb dn lf nc nd dp lj ma ne nf ll me ng nh ln mi ni nj lp nk bi translated">创建企业应用程序</h2><p id="e924" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用全局管理员帐户登录到<a class="ae ky" href="http://72658a08-b17f-4deb-b69d-b87214776484" rel="noopener ugc nofollow" target="_blank"> Azure </a>。</p><p id="7d39" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">在左侧窗格中，导航至&gt;&gt; Azure Active Directory &gt; &gt;企业应用&gt; &gt;+新应用&gt; &gt;添加您自己的应用(您正在开发的应用)&gt; &gt;+新注册</p><p id="fd65" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">成功注册应用程序后，您将看到以下内容；</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/c4295136baf789e9f05fcf3948a104b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pg59dUrhOuhcJ6Ezm6P3Qg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">快照</p></figure><p id="598f" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">在右边，用下面的模板添加一个重定向 URL</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="fb71" class="mz la it nn b gy nr ns l nt nu"><a class="ae ky" href="https://login.microsoftonline.com/0ce08dd4-2728-49fa-8e71-acb4a3c3d145/oauth2/token'" rel="noopener ugc nofollow" target="_blank">https://login.microsoftonline.com/&lt;DIRECTORY (tenant) ID&gt;/oauth2/token</a></span></pre><p id="9f68" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">证书&amp;秘密</strong></p><p id="0c90" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">创建一个客户端密码并记录下来。</p><p id="0df8" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu"> API —权限</strong></p><p id="53d9" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">默认情况下，Microsoft Graph <em class="mq">用户。添加了读取</em>权限。为了进行演示，我将查询 O365 Planner(相当于 Trello)数据。以下是<a class="ae ky" href="https://developer.microsoft.com/en-us/graph/graph/docs/concepts/permissions_reference" rel="noopener ugc nofollow" target="_blank">许可</a>授予<strong class="lt iu">2 号 MFA </strong>的账户。更多信息见<a class="ae ky" href="https://docs.microsoft.com/en-us/graph/overview" rel="noopener ugc nofollow" target="_blank">文档</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/d6a296551159e2cf34fd9adc3e94ceeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kLRWwqRAuuep8iSWd5dwEw.png"/></div></div></figure><h1 id="5614" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">获取数据</h1><p id="f889" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们深入研究 python 脚本；</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="c8a7" class="mz la it nn b gy nr ns l nt nu"><em class="mq">#import libraries</em><br/>import requests<br/>import json<br/>import pandas as pd<br/>import pyodbc</span></pre><p id="1745" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">创建在请求中使用的令牌数据字典</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="b93c" class="mz la it nn b gy nr ns l nt nu">app_id = 'xxxxxx' #Application Id - on the azure app overview page<br/>client_secret = 'xxxxx' </span><span id="225f" class="mz la it nn b gy nw ns l nt nu">#Use the redirect URL to create a token url<br/>token_url = '<a class="ae ky" href="https://login.microsoftonline.com/0ce08dd4-2728-49fa-8e71-acb4a3c3d145/oauth2/token'" rel="noopener ugc nofollow" target="_blank">https://login.microsoftonline.com/&lt;DIRECTORY (tenant) ID&gt;/oauth2/token</a>'</span><span id="4750" class="mz la it nn b gy nw ns l nt nu">token_data = {<br/> ‘grant_type’: ‘password’,<br/> ‘client_id’: app_id,<br/> ‘client_secret’: client_secret,<br/> ‘resource’: ‘<a class="ae ky" href="https://graph.microsoft.com'" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com'</a>,<br/> ‘scope’:’<a class="ae ky" href="https://graph.microsoft.com'" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com'</a>,<br/> ‘username’:’<a class="ae ky" href="mailto:helpdesk@centum.co.ke" rel="noopener ugc nofollow" target="_blank">john.doe@companyxxx.com</a>’, #Account with no 2MFA<br/> ‘password’:’Happy2020’,<br/>}</span><span id="2b07" class="mz la it nn b gy nw ns l nt nu">token_r = requests.post(token_url, data=token_data)<br/>token = token_r.json().get(‘access_token’)</span></pre><p id="2d86" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">测试令牌</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="72a2" class="mz la it nn b gy nr ns l nt nu">token_r.content</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/a1850dc9448fe703ecbce5a26772c622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23YFv0tC7S0QBNm0v0kJoQ.png"/></div></div></figure><p id="1858" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">在 Office 365 Planner 上创建一个计划，并创建一个组字典，如下所示:</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="e4b6" class="mz la it nn b gy nr ns l nt nu">#groups list<br/>group_ids = {‘plannergroup01’:’xxxx-xxx–xxx-xxxx–xx',’test’:’xxxx-xxx–xxx-xxxx–xx’}</span><span id="0d79" class="mz la it nn b gy nw ns l nt nu">#define required lists<br/>userId,displayName,mailAddress,plans_data,planId,PlanGrpOwnerId,PlanTitle,PlanCreatedBy,bucketId,bucketName,bucketPlanId,taskId,taskPlanId,taskBucketId,taskName,taskPercentComplete,taskStartDateTime,taskDueDateTime,taskCompleteDateTime,taskIdAssignment,taskUserIdAssignment = [],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]</span></pre><p id="d068" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">用户查询:</strong></p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="eb89" class="mz la it nn b gy nr ns l nt nu"># Use the token using microsoft graph endpoints<br/>users_url = ‘<a class="ae ky" href="https://graph.microsoft.com/v1.0/users?$top=500'" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com/v1.0/users?$top=500'</a><br/><br/>headers = {<br/> ‘Authorization’: ‘Bearer {}’.format(token)<br/>}</span><span id="f125" class="mz la it nn b gy nw ns l nt nu">user_response_data = json.loads(requests.get(users_url, headers=headers).text)<br/># user_response_data[‘<a class="ae ky" href="http://twitter.com/odata" rel="noopener ugc nofollow" target="_blank">@odata</a>.nextLink’]</span><span id="f143" class="mz la it nn b gy nw ns l nt nu">#initial user data<br/>#get all users<br/>for user in user_response_data[‘value’]:<br/> userId.append(user[‘id’])<br/> displayName.append(user[‘displayName’])<br/> mailAddress.append(user[‘userPrincipalName’])<br/> <br/>users_dict = {‘userId’:userId,’displayName’:displayName,’mailAddress’:mailAddress}<br/>users_df = pd.DataFrame(data=users_dict)</span><span id="e6f6" class="mz la it nn b gy nw ns l nt nu">#additional user query for paging<br/>while ‘<a class="ae ky" href="http://twitter.com/odata" rel="noopener ugc nofollow" target="_blank">@odata</a>.nextLink’ in user_response_data:<br/> user_response_data = json.loads(requests.get(users_url, headers=headers).text)<br/> if ‘<a class="ae ky" href="http://twitter.com/odata" rel="noopener ugc nofollow" target="_blank">@odata</a>.nextLink’ in user_response_data: <br/> users_url = user_response_data[‘<a class="ae ky" href="http://twitter.com/odata" rel="noopener ugc nofollow" target="_blank">@odata</a>.nextLink’]<br/> <br/> for user in user_response_data[‘value’]:<br/> userId.append(user[‘id’])<br/> displayName.append(user[‘displayName’])<br/> mailAddress.append(user[‘userPrincipalName’])</span><span id="80b4" class="mz la it nn b gy nw ns l nt nu">users_dict = {‘userId’:userId,’displayName’:displayName,’mailAddress’:mailAddress}<br/>users_df = pd.DataFrame(data=users_dict)<br/>users_df.head()</span></pre><p id="92df" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">计划员计划查询:</strong></p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="88c2" class="mz la it nn b gy nr ns l nt nu">#get all plans</span><span id="66ae" class="mz la it nn b gy nw ns l nt nu">for key, value in group_ids.items():<br/> <br/> plans_url = ‘<a class="ae ky" href="https://graph.microsoft.com/v1.0/groups/'+" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com/v1.0/groups/'+</a> value +’/planner/plans?$top=500' <br/> plans_response_data = json.loads(requests.get(plans_url, headers=headers).text)</span><span id="f47b" class="mz la it nn b gy nw ns l nt nu">for plan in plans_response_data[‘value’]:<br/> planId.append(plan[‘id’])<br/> PlanGrpOwnerId.append(plan[‘owner’])<br/> PlanTitle.append(plan[‘title’])<br/> PlanCreatedBy.append(plan[‘createdBy’][‘user’][‘id’])<br/> <br/>plans_dict = {‘planId’:planId,’PlanGrpOwnerId’:PlanGrpOwnerId,’PlanTitle’:PlanTitle,’PlanCreatedBy’:PlanCreatedBy}<br/>plans_df = pd.DataFrame(data=plans_dict)</span></pre><p id="2588" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">计划员时段查询:</strong></p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="aed3" class="mz la it nn b gy nr ns l nt nu">#get all buckets<br/>for plan_id in planId:<br/> buckets_url = ‘<a class="ae ky" href="https://graph.microsoft.com/v1.0/planner/plans/'+" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com/v1.0/planner/plans/'+</a> plan_id +’/buckets’<br/> buckets_response_data = json.loads(requests.get(buckets_url, headers=headers).text)<br/> <br/> for bucket in buckets_response_data[‘value’]:<br/> bucketId.append(bucket[‘id’])<br/> bucketName.append(bucket[‘name’])<br/> bucketPlanId.append(bucket[‘planId’]) <br/> <br/>bucket_dict = {‘bucketId’:bucketId,’bucketName’:bucketName,’bucketPlanId’:bucketPlanId} <br/>bucket_df = pd.DataFrame(data=bucket_dict)</span></pre><p id="0e2a" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">计划员任务查询:</strong></p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="25cc" class="mz la it nn b gy nr ns l nt nu">#get all tasks</span><span id="542a" class="mz la it nn b gy nw ns l nt nu">for plan_id in planId:<br/> tasks_url = ‘<a class="ae ky" href="https://graph.microsoft.com/v1.0/planner/plans/'+" rel="noopener ugc nofollow" target="_blank">https://graph.microsoft.com/v1.0/planner/plans/'+</a> plan_id +’/tasks’<br/> tasks_response_data = json.loads(requests.get(tasks_url, headers=headers).text)<br/> <br/> for task in tasks_response_data[‘value’]:<br/> taskId.append(task[‘id’])<br/> taskPlanId.append(task[‘planId’])<br/> taskBucketId.append(task[‘bucketId’])<br/> taskName.append(task[‘title’])<br/> taskPercentComplete.append(str(task[‘percentComplete’]))<br/> if task[‘startDateTime’] is not None:<br/> taskStartDateTime.append(datetime.strptime(task[‘startDateTime’], ‘%Y-%m-%dT%H:%M:%SZ’))<br/> else:<br/> taskStartDateTime.append(0)<br/> if task[‘dueDateTime’] is not None:<br/> taskDueDateTime.append(datetime.strptime(task[‘dueDateTime’], ‘%Y-%m-%dT%H:%M:%SZ’))<br/> else:<br/> taskDueDateTime.append(0)<br/># if task[‘completedDateTime’] is not None:<br/># complete_time = task[‘completedDateTime’].replace(task[‘completedDateTime’].split(‘:’)[-1],’00Z’)<br/># taskCompleteDateTime.append(datetime.strptime(complete_time, ‘%Y-%m-%dT%H:%M:%S%z’))<br/># else:<br/># taskCompleteDateTime.append(str(0))<br/> <br/> for assignment in task[‘assignments’]:<br/> taskIdAssignment.append(task[‘id’]) <br/> taskUserIdAssignment.append(assignment)</span><span id="fffd" class="mz la it nn b gy nw ns l nt nu">tasks_dict = {‘taskId’:taskId,’taskPlanId’:taskPlanId,’taskBucketId’:taskBucketId,’taskName’:taskName,’taskPercentComplete’:taskPercentComplete,’taskStartDateTime’:taskStartDateTime,’taskDueDateTime’:taskDueDateTime,’taskCompleteDateTime’:0} <br/>task_df = pd.DataFrame(data=tasks_dict)</span></pre><p id="ff15" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">将用户数据插入数据库:</strong></p><p id="c777" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated">下面的函数可以对上面创建的所有数据框进行复制。就我而言，我使用的是 SQL Server 2017。</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="9ad2" class="mz la it nn b gy nr ns l nt nu">server = 'SERVERNAME\INSTANCEID,64346'<br/>database = 'GRAPHAPI' <br/>username = 'uname' <br/>password = 'Happy2020'</span><span id="76b0" class="mz la it nn b gy nw ns l nt nu">def insert_user_db(users_df,server,database,username,password):</span><span id="206c" class="mz la it nn b gy nw ns l nt nu">#Create a connection string<br/>cnxn = pyodbc.connect('DRIVER={ODBC Driver 17 for SQL Server};SERVER='+server+';DATABASE='+database+';UID='+username+';PWD='+ password)<br/>    cursor = cnxn.cursor()<br/> <br/> for index in range(users_df.shape[0]): <br/> #insert into table <br/> try:<br/> insert_query = “INSERT INTO GRAPHAPI.dbo.[DIM_User] ([userId],[displayName],[mailAddress]) VALUES (?,?,?)”<br/> cursor.execute(insert_query,users_df[‘userId’][index],users_df[‘displayName’][index],users_df[‘mailAddress’][index])</span><span id="08ef" class="mz la it nn b gy nw ns l nt nu">except:</span><span id="2f36" class="mz la it nn b gy nw ns l nt nu">cnxn.rollback()</span><span id="e9e8" class="mz la it nn b gy nw ns l nt nu">finally:</span><span id="8195" class="mz la it nn b gy nw ns l nt nu">cnxn.commit()<br/> cnxn.close()</span><span id="868d" class="mz la it nn b gy nw ns l nt nu">#Call the function<br/>insert_user_db(users_df,server,database,username,password)</span></pre><h1 id="55c8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="1168" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">随着微软套件服务的广泛使用，对于<a class="ae ky" href="https://docs.microsoft.com/en-us/graph/overview" rel="noopener ugc nofollow" target="_blank">图形 API </a>请求，还有许多其他应用<a class="ae ky" href="https://docs.microsoft.com/en-us/graph/overview" rel="noopener ugc nofollow" target="_blank">场景</a>。如此巨大的数据量为组织提供了商业智能，并使开发人员能够构建数据驱动的应用程序。</p><p id="4fee" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mu mc md me mw mg mh mi my mk ml mm im bi translated"><strong class="lt iu">喜欢你读的书吗？</strong>关注我上<strong class="lt iu"/><a class="ae ky" href="https://www.linkedin.com/in/ephraimwaithaka/" rel="noopener ugc nofollow" target="_blank"><strong class="lt iu">LinkedIn</strong></a>或<a class="ae ky" href="https://medium.com/@ephraim.mwai" rel="noopener"> <strong class="lt iu"> Medium </strong> </a></p></div></div>    
</body>
</html>