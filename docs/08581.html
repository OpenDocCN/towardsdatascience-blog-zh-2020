<html>
<head>
<title>Sankey Diagram Basics with Python’s Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Python的Plotly的桑基图基础</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sankey-diagram-basics-with-pythons-plotly-7a13d557401a?source=collection_archive---------1-----------------------#2020-06-22">https://towardsdatascience.com/sankey-diagram-basics-with-pythons-plotly-7a13d557401a?source=collection_archive---------1-----------------------#2020-06-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cf7c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">可视化流量和比较比例的绝佳选择</h2></div><p id="832e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将介绍使用Plotly和Python绘制桑基图的基础知识。</p><p id="822a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它们是一个方便的图表，用于可视化任何一种可测量的流量——一些例子是<a class="ae le" href="https://www.flickr.com/photos/walkingsf/8222524899/in/photostream" rel="noopener ugc nofollow" target="_blank">旅行者</a>、<a class="ae le" href="https://www.reddit.com/r/dataisbeautiful/comments/6a4pb8/how_52_ninthgraders_spell_camouflage_sankey/" rel="noopener ugc nofollow" target="_blank">拼写者</a>和<a class="ae le" href="https://www.behance.net/gallery/16622319/Sankey-diagrams" rel="noopener ugc nofollow" target="_blank">金钱</a>的流量。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/8fe354e000ac801083c1fcae69f8f8d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M94Uln2IJkqISu_b.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae le" href="https://upload.wikimedia.org/wikipedia/commons/1/10/JIE_Sankey_V5_Fig1.png" rel="noopener ugc nofollow" target="_blank">桑基图显示了蒸汽机的能效，1898年</a></p></figure><p id="37ed" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这张图表的制作归功于爱尔兰船长马修. H. P. R .桑基，他用它来形象化蒸汽机的能源效率。</p><p id="6549" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">桑基图的思想类似于网络图，其中链接连接节点。</p><p id="a0ee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">主要区别在于，在桑基的模型中，链接具有不同的宽度，它们共同编码一个可测量的变量。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="f698" class="mc md it bd me mf mg dn mh mi mj dp mk kr ml mm mn kv mo mp mq kz mr ms mt mu bi translated">亲自动手</h2><p id="6eba" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">对于下面的例子，我将结合Jupyter Lab使用Plotly来探索如何创建一个Sankey。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="5cf2" class="mc md it nb b gy nf ng l nh ni">import plotly.graph_objects as go</span></pre><p id="246b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用Plotly构建图表有不同的方法；我将使用图形对象，用Jupiter小部件可视化图形，并为最终的可视化导出一个HTML。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="478f" class="mc md it bd me mf mg dn mh mi mj dp mk kr ml mm mn kv mo mp mq kz mr ms mt mu bi translated">逻辑</h2><p id="9dec" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">构建一个Sankey可能相当困难，特别是如果您有太多的节点和连接，我将使用列表作为例子来简化它，但是您可以用JSON文件或Pandas数据帧来修改这个逻辑。</p><p id="d89c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用<code class="fe nj nk nl nb b">go.Sankey</code>来构建图表，这需要一个<code class="fe nj nk nl nb b">link</code>。</p><p id="7445" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那个<code class="fe nj nk nl nb b">link</code>是一本包含我们想要绘制的连接数据的字典。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="e91f" class="mc md it nb b gy nf ng l nh ni">source = [0, 0, 1, 1, 0]<br/>target = [2, 3, 4, 5, 4]<br/>value = [8, 2, 2, 8, 4]</span></pre><p id="ff91" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">源和目标是Plotly将连接的节点的索引列表，值是将定义这些连接的宽度的数字列表。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="acb3" class="mc md it nb b gy nf ng l nh ni">link = dict(source = source, target = target, value = value)<br/>data = go.Sankey(link = link)<br/>print(data)</span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nm"><img src="../Images/22d4c4214eda19b6e171eb90e1d67104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xaPs1nI2S2J53e_SwZnBYA.png"/></div></div></figure><p id="7000" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将Sankey对象保存到一个名为data的变量中，现在我们可以将该数据传递给一个图形；</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="442d" class="mc md it nb b gy nf ng l nh ni">fig = go.Figure(data)</span></pre><p id="4f17" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并显示图表。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="4dad" class="mc md it nb b gy nf ng l nh ni">fig.show()</span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/d5dd2721a8318e642586eb5dff0f5b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SfVbPnXGd_vMhe_xtwrkjQ.png"/></div></div></figure><p id="b8b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这个想法。让我们试着识别这些节点，这样我们就能更清楚地看到什么在连接什么。</p><p id="785e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要一个包含节点数据的字典，它应该包含一个带有标签的列表。我们还可以添加更多的参数，比如<code class="fe nj nk nl nb b">pad</code>来定制节点之间的距离，或者<code class="fe nj nk nl nb b">thickness</code>来定义它们的句柄的大小。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="6619" class="mc md it nb b gy nf ng l nh ni"># data<br/><strong class="nb iu">label = ["ZERO", "ONE", "TWO", "THREE", "FOUR", "FIVE"]</strong><br/>source = [0, 0, 1, 1, 0]<br/>target = [2, 3, 4, 5, 4]<br/>value = [8, 2, 2, 8, 4]</span><span id="5188" class="mc md it nb b gy no ng l nh ni"># data to dict, dict to sankey<br/>link = dict(source = source, target = target, value = value)<br/><strong class="nb iu">node = dict(label = label, pad=50, thickness=5)</strong><br/>data = go.Sankey(link = link, <strong class="nb iu">node=node</strong>)</span><span id="dcaf" class="mc md it nb b gy no ng l nh ni"># plot<br/>fig = go.Figure(data)<br/>fig.show()</span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/7bb1b557dec67334ac15419a59430640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*MEegKuQFUbXng_F_mZfFAw.png"/></div></figure><p id="b19b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那更好理解。我们可以阅读列表，并想象它们之间的联系。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="7ed2" class="mc md it bd me mf mg dn mh mi mj dp mk kr ml mm mn kv mo mp mq kz mr ms mt mu bi translated">用例</h2><p id="ffa0" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">现在让我们用一些真实的数据来尝试一下，我将尝试改变温哥华2020年预算中的这种可视化。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/77454322d43a95d32a242ab8aa4c01da.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*n-Ct--5tc1pmkR26jlRg5w.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae le" href="https://vancouver.ca/files/cov/2020-budget-book.PDF" rel="noopener ugc nofollow" target="_blank">温哥华2020年预算，第。6 </a></p></figure><p id="f02a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望看到资金从运营支出流向地区和服务的比例。</p><p id="3661" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将从总支出的一个节点开始，它将连接到四个领域，然后将链接到它们的细分领域——让我们快速勾画一下这个想法。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nr"><img src="../Images/2c8bbccd3a72f439e0bad7f7c62ff4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1kzyDU9_8Vm_L6aVIsnJA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">用sketch.io绘制</p></figure><p id="d304" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我已经使用了百分比来查找值，并为链接构建了以下列表。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="c404" class="mc md it nb b gy nf ng l nh ni">source = [0, 0, 0, 0,       # Op Expeditures<br/>          1, 1,             # Public Safety<br/>          2, 2,             # Eng n Util<br/>          3, 3, 3, 3, 3, 3, # Community Serv<br/>          4, 4, 4]          # Corp Support</span><span id="bea5" class="mc md it nb b gy no ng l nh ni">target = [1, 2, 3, 4, <br/>          5, 6,<br/>          7, 8, <br/>          9, 10, 11, 12, 13, 14, <br/>          15, 16, 17]</span><span id="66fe" class="mc md it nb b gy no ng l nh ni">value = [484500, 468350, 355300, 306850, <br/>         339150, 145350, <br/>         371450, 96900, <br/>         129200, 80750, 48450, 48450, 32300, 16150, <br/>         113050, 129200, 64600]</span></pre><p id="f3a5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们也为节点定义标签。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="39cc" class="mc md it nb b gy nf ng l nh ni">label = ['Operating Expeditures', <br/>         'Public Safety', <br/>         'Engineering and Utilities', <br/>         'Community-Related Services', <br/>         'Corporate Support',<br/>         'Police', <br/>         'Fire',<br/>         'Utilities', <br/>         'Engineering Public Works',<br/>         'Parks and Recreation', <br/>         'Arts, Culture, and Community Services',<br/>         'Library', <br/>         'Development, Buildings, and Licensing',<br/>         'Planning, Urban Design, and Sustainability', <br/>         'Other',<br/>         'Corporate Support', <br/>         'Debt and Capital (Non-Utility)', <br/>         'Contingencies and Transfers']</span></pre><p id="c89e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦我们准备好数据，剩下要做的就是定义我们的图形和绘图。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/da936757608c6a511ba9bd62e1a8c965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4enL2RoIKO0lWsowyZ_HVg.png"/></div></div></figure><p id="e9d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">很好，越来越好了。</p><p id="e1ee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以在图表中使用另一种编码，即颜色。</p><p id="e3bb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以定义节点和链接的颜色；为此，我们需要一个每个元素有一种颜色的列表。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="afde" class="mc md it nb b gy nf ng l nh ni">color_node = [<br/>'#808B96', <br/>'#EC7063', '#F7DC6F', '#48C9B0', '#AF7AC5',<br/>'#EC7063', '#EC7063',<br/>'#F7DC6F', '#F7DC6F',<br/>'#48C9B0', '#48C9B0', '#48C9B0', '#48C9B0', '#48C9B0', '#48C9B0',<br/>'#AF7AC5', '#AF7AC5', '#AF7AC5']</span><span id="41cc" class="mc md it nb b gy no ng l nh ni">color_link = [<br/>'#EBBAB5', '#FEF3C7', '#A6E3D7', '#CBB4D5',<br/>'#EBBAB5', '#EBBAB5',<br/>'#FEF3C7', '#FEF3C7',<br/>'#A6E3D7', '#A6E3D7', '#A6E3D7', '#A6E3D7', '#A6E3D7', '#A6E3D7',<br/>'#CBB4D5', '#CBB4D5', '#CBB4D5']</span></pre><p id="c0c8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我试图突出每个支出的区域，我对节点和链接使用相似的颜色，一个比另一个亮一点。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ns"><img src="../Images/4e7feff31498831c8f67d4b31a08d003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y3Zr8rXv1BPLmSKT7FYr-Q.png"/></div></div></figure><p id="bf4c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几乎准备好了，剩下要做的就是添加标题、调整细节和导出HTML文件。</p><p id="ef26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以在绘图之前更新图形的布局，这允许我们更改字体、背景颜色、定义工具提示上的信息等等。</p><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="a9fc" class="mc md it nb b gy nf ng l nh ni">fig.update_layout(<br/>    hovermode = 'x',<br/>    title="Vancouver Operating Expeditures by Area of Service",<br/>    font=dict(size = 10, color = 'white'),<br/>    paper_bgcolor='#5B5958'<br/>)</span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nt"><img src="../Images/a236613be3b2331c5403760fd04021ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UdL3WsXYeAjNRcC1J0e8CQ.png"/></div></div></figure><p id="85f8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦可视化准备就绪，我们就可以将其导出为HTML。这可能是最自然的部分，我们所要做的就是调用<code class="fe nj nk nl nb b">.write_html(‘filename.html’)</code>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="aeb3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里你可以看到另一个例子，我增加了营业收入。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nu"><img src="../Images/f31ce69488a321f2058f802a281f3edc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIHnWf9B2rsKuu0UnsijqA.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae le" href="https://thiagobc23.github.io/plotly-sankey/van.html" rel="noopener ugc nofollow" target="_blank">https://thiagobc23.github.io/plotly-sankey/van.html</a></p></figure><p id="e764" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我试图移除白色的文字阴影，但是我在Plotly中找不到解决方案，我找到的最好的答案是<a class="ae le" href="https://github.com/ropensci/plotly/issues/1118" rel="noopener ugc nofollow" target="_blank">覆盖CSS </a>。</p><p id="0d44" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在这里找到这篇文章的代码<a class="ae le" href="https://github.com/Thiagobc23/plotly-sankey" rel="noopener ugc nofollow" target="_blank">，在这里</a>找到带有交互式Sankey <a class="ae le" href="https://thiagobc23.github.io/plotly-sankey/van.html" rel="noopener ugc nofollow" target="_blank">的网页。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="6cc5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢你花时间阅读我的文章，我希望你喜欢它。</p><p id="34eb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">更多资源:<br/> </strong> <a class="ae le" href="https://plotly.github.io/plotly.py-docs/generated/plotly.graph_objects.Sankey.html" rel="noopener ugc nofollow" target="_blank"> Plotly —图形对象</a> <br/> <a class="ae le" href="https://plotly.com/python/sankey-diagram/#reference" rel="noopener ugc nofollow" target="_blank"> Plotly —桑基图</a></p></div></div>    
</body>
</html>