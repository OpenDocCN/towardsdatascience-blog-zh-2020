<html>
<head>
<title>How to write an advanced trend following strategy to algotrade Bitcoin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为algotrade比特币编写高级趋势跟踪策略</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-write-an-advanced-trend-following-strategy-to-algotrade-bitcoin-a38e47443ddc?source=collection_archive---------47-----------------------#2020-06-09">https://towardsdatascience.com/how-to-write-an-advanced-trend-following-strategy-to-algotrade-bitcoin-a38e47443ddc?source=collection_archive---------47-----------------------#2020-06-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b2c5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">趋势跟踪不再困难</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5280eeb6fd23ae425eb5f1b67ee81a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uOB3GjI0TBCbXaKS.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://undraw.co/" rel="noopener ugc nofollow" target="_blank"> Katerina Limpitsouni </a>拍摄</p></figure><p id="7ca8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论是开始算法交易还是盈利，趋势跟踪都是最容易的。在<a class="ae ky" rel="noopener" target="_blank" href="/how-to-use-multiple-timeframes-in-your-algotrading-strategy-8be026a890e2?source=friends_link&amp;sk=a35c562268ca6c7c6c3d1df1cec1d7d1">上一篇文章</a>中，我写了一个趋势跟踪策略，通过使用更大的时间框架来确定趋势，甚至提高了它的性能。但这是一个简单的立即进入和立即退出的策略。</p><p id="c550" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程的重点是让你从Jesse的一些特性开始，这些特性可以帮助你写出你会发现的大多数趋势跟踪策略。这些特征中很少是:</p><ul class=""><li id="85ab" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">分两点退出交易，一点是固定价格，另一点是动态价格。</li><li id="3e4b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">退出一半仓位后将止损更新为盈亏平衡。</li><li id="3186" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">过滤盈亏比不好的交易。</li><li id="a80f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">利用事件与交易的生命周期挂钩。</li></ul><p id="ef4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我用<code class="fe mj mk ml mm b">make-strategy</code>命令创建一个新策略:</p><pre class="kj kk kl km gt mn mm mo mp aw mq bi"><span id="49c9" class="mr ms it mm b gy mt mu l mv mw">jesse make-strategy TrendFollowingStrategy</span></pre><p id="2900" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我编辑我的<code class="fe mj mk ml mm b">routes.py</code>文件来使用这个策略，我把时间范围设置为<code class="fe mj mk ml mm b">4h</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="e799" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我打开新创建的策略文件，它看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="b524" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">进入规则</h1><p id="9acb" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">我想去很久，当:</p><ul class=""><li id="845e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们处于上升趋势中(反之亦然)</li><li id="07f1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">收盘(当前)蜡烛线触及50均线</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="d392" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">他们说一张图片抵得上1000个单词，所以这里有一张图片显示了我认为的上升趋势:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/4cec8120fe9d52c25627011d66c6a804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/0*7wmlh_RtPNfGK3et.png"/></div></figure><p id="ff28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我所说的当前蜡烛碰到50均线的意思(橙色线是50均线):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/91eab924f397b5c63f6fbaf2f1e54563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/0*B9kdcWBmUlPFzB3k.png"/></div></figure><p id="bb68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们为<code class="fe mj mk ml mm b">current_candle_touches_long_ema</code>和<code class="fe mj mk ml mm b">trend</code>写代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="699b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我用三根均线来确定趋势方向。我返回<code class="fe mj mk ml mm b">1</code>表示上涨趋势，返回<code class="fe mj mk ml mm b">-1</code>表示下跌趋势。<code class="fe mj mk ml mm b">current_candle_touches_long_ema</code>很简单，我只要确保当前蜡烛线的高价大于<code class="fe mj mk ml mm b">long_ema</code>线(周期为50的均线)并且当前蜡烛线的低价低于<code class="fe mj mk ml mm b">long_ema</code>线。</p><h1 id="ffc0" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">设置进场价格和仓位大小</h1><p id="0c66" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">对于多头交易，进场价格将是当前蜡烛线的最高点。止损价格将是当前ATR的3倍，距离我的进场价格。</p><p id="08d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个策略中，我想一次进场交易，但在两点出场。我将在趋势的前一个高点退出我的前半部分头寸。这里是我所说的上升趋势的高点(蓝线是我的目标):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/3bf4430b6f7c8e0e91bc691b16fc0451.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/0*v6UN7NVEfMG25y5r.png"/></div></figure><p id="92d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了对此进行编码，我首先选择最后20根蜡烛线的最高价格。然后返回其中的最大值。</p><p id="e8a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于头寸规模，我想在每笔交易中用我总资本的5%来冒险。为了计算<code class="fe mj mk ml mm b">qty</code>，我使用了<code class="fe mj mk ml mm b">risk_to_qty</code>实用程序。</p><p id="7f58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，短线交易的情况正好相反。代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="4413" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">将止损转为盈亏平衡</h1><p id="4b37" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">正如你所看到的，我只是以获利价格退出了我一半的仓位。换句话说，在我的仓位降低后，我想移动我的止损价格以达到盈亏平衡。为了在Jesse中编写代码，我将使用内置的<a class="ae ky" href="https://docs.jesse-ai.com/docs/strategies/events.html#on-reduced-position" rel="noopener ugc nofollow" target="_blank"> on_reduced_position </a>方法。</p><p id="492c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新<code class="fe mj mk ml mm b">self.stop_loss</code>是我告诉杰西更新我的止损单所需要做的。Jesse自动选择它，取消之前的止损单，并提交新的止损单。这再简单不过了！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="2167" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要了解关于事件的更多信息并查看Jesse中所有可用事件方法的列表，请务必阅读其<a class="ae ky" href="https://docs.jesse-ai.com/docs/strategies/events.html#on-cancel" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="99be" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">动态退出我交易的后半部分</h1><p id="408c" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">对于这个策略，我打算在动态的情况下退出我的后半部分头寸。这种情况背后的想法是，当价格高度超买，即将进行严重的修正时退出。用quant的语言来说，我想在RSI指标达到80以上的时候退出。</p><p id="9aba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我将使用内置的<code class="fe mj mk ml mm b">update_position()</code>方法来编写我的逻辑。只有当我们有一个未结头寸时，这个方法才会在每根新蜡烛线后执行。因此，它用于更新位置。也就是说我们不需要检查这个职位是否空缺。</p><p id="424d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里要考虑的下一件事是，我只想退出我的后半部分头寸。换句话说，我想平仓，如果它已经减少。检查我的头寸是否已经减少的最简单的方法是使用内置的<a class="ae ky" href="https://docs.jesse-ai.com/docs/strategies/api.html#is-reduced" rel="noopener ugc nofollow" target="_blank"> is_reduced </a>属性和<a class="ae ky" href="https://docs.jesse-ai.com/docs/strategies/api.html#liquidate" rel="noopener ugc nofollow" target="_blank">清算()</a>方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="bc40" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">使用过滤器</h1><p id="9cf1" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">到目前为止，我的策略看起来不错，让我们进行一次回溯测试，看看效果如何:</p><pre class="kj kk kl km gt mn mm mo mp aw mq bi"><span id="5074" class="mr ms it mm b gy mt mu l mv mw">jesse backtest 2019-01-01 2020-05-01</span></pre><p id="e14a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经过大约4%的回溯测试后，我得到一个错误:</p><pre class="kj kk kl km gt mn mm mo mp aw mq bi"><span id="debb" class="mr ms it mm b gy mt mu l mv mw">Uncaught Exception: InvalidStrategy: take-profit(3601.6) must be below entry-price(3601.6) in a short position</span></pre><p id="13d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">错误是试图告诉我们，在某一点上，我们的策略的获利和进场价格相等(3601.6美元)，这是不可接受的。这是一个很难调试的问题，但是在编写了最初的几个策略之后，你会很擅长和Jesse一起调试。</p><p id="f997" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了解释为什么会出现这个问题，我们需要再看一下获利和进场交易:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="42c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个错误告诉我们，进场和获利在某些时候是相同的。这意味着，在这一点上，当前的蜡烛线是过去20根棒线中最高的。这不是我们在这个策略中想要的交易类型。</p><p id="5289" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过在我们的<code class="fe mj mk ml mm b">should_long</code>方法中使用一些肮脏的if-else语句，或者通过使用一个专为这类情况设计的过滤器来防止这种情况发生。</p><p id="bff4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">过滤器只是一个返回布尔值的函数。通过返回一个<code class="fe mj mk ml mm b">True</code>值来传递一个过滤器，反之亦然。我定义了一个过滤器，并命名为<code class="fe mj mk ml mm b">reward_to_risk_filter</code>。这个名字可以是任何东西，但是用单词<code class="fe mj mk ml mm b">filter</code>开始或结束一个过滤方法的名字通常是一个好的习惯。这个过滤器的工作是确保我们试图进入的交易是值得的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="b4b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一点上，杰西仍然不知道<code class="fe mj mk ml mm b">reward_to_risk_filter()</code>是一个过滤器。为了让它识别我的过滤器，我需要将它添加到<code class="fe mj mk ml mm b">filters()</code>方法中，这是一个返回Python列表的内置方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="99bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我将把<code class="fe mj mk ml mm b">reward_to_risk_filter</code>作为一个<strong class="lb iu">变量添加到返回列表中。</strong>这意味着它的末尾不能有括号:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="8ed1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们再执行一次回溯测试:</p><pre class="kj kk kl km gt mn mm mo mp aw mq bi"><span id="2d66" class="mr ms it mm b gy mt mu l mv mw">jesse backtest 2019-01-01 2020-05-01</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/2572f5404bc9bdfba4c12d4208ec17fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Xtv1C3Fnt89GxTjb.jpg"/></div></div></figure><p id="a4be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这次一切顺利。</p><h1 id="a6f1" class="mz ms it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">结论</h1><p id="81ab" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">你的策略越简单，就越容易调试它们，甚至随着时间的推移改进它们。</p><p id="805e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和杰西一起写策略就像手动交易你的策略一样简单。所以下一次你在交易书上或者交易大师那里发现一个策略时，就写下代码，并进行回溯测试。</p><p id="cb45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了获得我未来的作品和产品，请务必订阅杰西的<a class="ae ky" href="https://jesse-ai.com/" rel="noopener ugc nofollow" target="_blank">时事通讯</a>，并查看<a class="ae ky" href="https://forum.jesse-ai.com/" rel="noopener ugc nofollow" target="_blank">论坛</a>与像你我这样的量化分析师讨论算法交易。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><p id="ffe5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="og">原载于</em><a class="ae ky" href="https://jesse-ai.com/blog/tutorials/how-to-write-an-advanced-trend-following-strategy-to-algotrade-bitcoin" rel="noopener ugc nofollow" target="_blank"><em class="og">https://jesse-ai.com</em></a><em class="og">。</em></p><p id="b470" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="og">注来自《走向数据科学》的编辑:</em> </strong> <em class="og">虽然我们允许独立作者根据我们的</em> <a class="ae ky" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="og">规则和指导方针</em> </a> <em class="og">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae ky" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="og">读者术语</em> </a> <em class="og">。</em></p></div></div>    
</body>
</html>