<html>
<head>
<title>Geobinning Starbucks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Geobinning 星巴克</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geobinning-starbucks-88bc636f43c6?source=collection_archive---------65-----------------------#2020-07-28">https://towardsdatascience.com/geobinning-starbucks-88bc636f43c6?source=collection_archive---------65-----------------------#2020-07-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5eaa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用 Python、Geobinning 和 Matplotlib 生成 Choropleth 图</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/91386c7c3d1fe34b45905a6e4b467ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ot7IGO2PCzcmU-knsb9lMg.png"/></div></div></figure><p id="1ccb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我看到外面有很多 choropleth 地图，它们看起来非常好，真的吸引了很多注意力。如果你有一个干净的数据集，创建它们是非常容易的，但是，我想探索的很多数据并没有按照我想要的方式分类。通常情况下，它以坐标(lat/lng)的形式出现，这让我来决定他们应该去地图的哪个区域。</p><blockquote class="lq lr ls"><p id="b2b8" class="ku kv lt kw b kx ky ju kz la lb jx lc lu le lf lg lv li lj lk lw lm ln lo lp im bi translated">即。我需要想出如何地理定位结果</p></blockquote><p id="843e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为此，我创建了一个名为<strong class="kw iu"> Geobinning </strong>的 pypi 库，它并不十分花哨，但可以让我们将点数据绑定到任意多边形中。这将允许我们生成 choropleth 地图，并做一些有趣的事情，如叠加原始点数据。今天，我们将使用这个 python 包和 matplotlib 重新创建上面的图像，以绘制最终的地图。</p><p id="f235" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:我专门用 Kaggle 来做我的编码，因为我喜欢有一个基于云的平台，我可以到处玩。所有的数据集和代码对我的顾客都是可用的(如果你想要它，只要问，我会给你！)但是如果你想支持我的工作，请检查一下</p><div class="lx ly gp gr lz ma"><a href="https://www.patreon.com/datastuffplus" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd iu gy z fp mf fr fs mg fu fw is bi translated">Datastuffplus 正在创建数据驱动的图形和可视化。帕特里翁</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">嘿，欢迎光临！Datastuffplus 主要是我开始分享一些开发工作的 instagram 账号…</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">www.patreon.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo ks ma"/></div></div></a></div><h2 id="137b" class="mp mq it bd mr ms mt dn mu mv mw dp mx ld my mz na lh nb nc nd ll ne nf ng nh bi translated">代码</h2><p id="c628" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">首先，我们将安装我们的软件包</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="b576" class="mp mq it no b gy ns nt l nu nv">!pip install <strong class="no iu">geobinning</strong></span></pre><p id="2a2a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们将加载加载和处理数据所需的包</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="8ef0" class="mp mq it no b gy ns nt l nu nv">import numpy as np # linear algebra<br/>import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)<br/>import geobinning as gb<br/>import shapefile  # Shapefile processing</span></pre><p id="50bd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于这个特定的研究，我将按美国县来收集数据，但我还想画出美国的州边界，以便以后更容易理解。所以我会加载。shp 和。dbf 文件，可从</p><div class="lx ly gp gr lz ma"><a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd iu gy z fp mf fr fs mg fu fw is bi translated">地图边界文件-形状文件</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">查看 2018 年及以前年份的 shapefile 格式的制图边界文件。</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">www.census.gov</p></div></div><div class="mj l"><div class="nw l ml mm mn mj mo ks ma"/></div></div></a></div><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="e2ab" class="mp mq it no b gy ns nt l nu nv"><strong class="no iu"># Load in the shape data</strong></span><span id="fe87" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Counties</strong><br/>myshp = open('<strong class="no iu">../input/us-county-<br/>    shapefile/cb_2018_us_county_5m.shp</strong>', "rb")<br/>mydbf = open('<strong class="no iu">../input/us-county-<br/>    shapefile/cb_2018_us_county_5m.dbf</strong>', "rb")county = shapefile.Reader(shp=myshp, dbf=mydbf)<br/>county_shapes = county.shapes()</span><span id="c18c" class="mp mq it no b gy nx nt l nu nv"># <strong class="no iu">States</strong><br/>myshp = open('.<strong class="no iu">./input/us-states-shapefile/tl_2017_us_state.shp</strong>',<br/>    "rb")<br/>mydbf = open('<strong class="no iu">../input/us-states-shapefile/tl_2017_us_state.dbf</strong>',<br/>    "rb")<br/>states = shapefile.Reader(shp=myshp, dbf=mydbf)<br/>state_shapes = states.shapes()</span></pre><p id="1f5a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们将获取形状文件对象，并提取定义县和州形状的多边形</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="712f" class="mp mq it no b gy ns nt l nu nv"><strong class="no iu">state_polygons</strong> = []<br/>for s in state_shapes:<br/>    state_polygons.append(s.points)</span><span id="7734" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu">county_polygons</strong> = []<br/>for s in county_shapes:<br/>    county_polygons.append(s.points)</span></pre><p id="c3af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">加载我在 Kaggle 上找到的星巴克数据</p><div class="lx ly gp gr lz ma"><a href="https://www.kaggle.com/starbucks/store-locations" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd iu gy z fp mf fr fs mg fu fw is bi translated">星巴克在全球的位置</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">运营中的每家星巴克店的名称、所有权类型和位置</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">www.kaggle.com</p></div></div><div class="mj l"><div class="ny l ml mm mn mj mo ks ma"/></div></div></a></div><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="1457" class="mp mq it no b gy ns nt l nu nv">starbucks = pd.read_csv('<strong class="no iu">../input/store-locations/directory.csv</strong>')</span><span id="c7f2" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Filter for US only</strong><br/>starbucks = starbucks[starbucks['Country'].isin(['US'])]</span><span id="217b" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Extract the coordinates <br/></strong>points = []<br/>for i,d in starbucks.iterrows():<br/>    points.append([d['Longitude'],d['Latitude']])</span><span id="a2ac" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Use the geobinning package we created to bin the points in the polys</strong><br/>star = gb.geobin(county_polygons,points)</span></pre><p id="f2b7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">剩下的就是使用 matplotlib 来生成我们的最终图像。不使用标准的绘图功能，我决定只使用多边形和圆形补丁对象。效果超级好！基本上使用 matplotlib 作为 MS paint</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="67c7" class="mp mq it no b gy ns nt l nu nv"><strong class="no iu"># Load the packages</strong><br/>import matplotlib.pyplot as plt<br/>import matplotlib<br/>from matplotlib.patches import Polygon,Circle<br/>from matplotlib.collections import PatchCollection</span><span id="5dc7" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Generate a figure with a white background</strong><br/>fig, ax = plt.subplots(figsize=(80,40), dpi=80, facecolor='w', edgecolor='k')</span><span id="9675" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Generate the patches (polygon objects) using the county data polygon set we created earlier</strong><br/>patches = []<br/>colors = []<br/>for i,poly_data in enumerate(county_polygons):<br/>    polygon = Polygon(poly_data, True)<br/>    patches.append(polygon)<br/>    colors.append(star[i])  <strong class="no iu"><em class="lt"># Colour by binning!!!!!</em></strong></span><span id="6925" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Make a patch collection of these polygons and use the BuGu colormap for the polygon colours (this creates a choropleth map)</strong><br/>p = PatchCollection(patches, cmap=matplotlib.cm.BuGn, alpha=1,linewidth=0.1,edgecolor=(0,0,0))<br/>p.set_array(np.array(colors))<br/>ax.add_collection(p)</span><span id="0f36" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Same treatment as above but for the state polygon set</strong><br/>patches = []<br/>colors = []<br/>for i,poly_data in enumerate(state_polygons):<br/>    polygon = Polygon(poly_data, True)<br/>    patches.append(polygon)</span><span id="0fa4" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Notice facecolour is none since we only want the borders<br/></strong>p = PatchCollection(patches, alpha=1,linewidth=6,edgecolor='w',<strong class="no iu">facecolor='none'</strong>)<br/>ax.add_collection(p)</span><span id="d141" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Now we plot the actual raw point data.  Same deal as before but we are using the Circle instead of Polygon</strong><br/>patches = []<br/>for i,point_data in enumerate(points):<br/>    pt = Circle(point_data,radius=0.06)<br/>    patches.append(pt)<br/>p = PatchCollection(patches,color='#0f713e',alpha=0.1)<br/>ax.add_collection(p)</span><span id="67c8" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Set the x/y ranges to be the rough boundary coordinates of the continental US</strong><br/>ax.set_ylim(24, 50)<br/>ax.set_xlim(-130, -60)</span><span id="308c" class="mp mq it no b gy nx nt l nu nv"><strong class="no iu"># Remove the axis and plot!</strong><br/>plt.axis('off')<br/>plt.show();</span></pre><h2 id="63d8" class="mp mq it bd mr ms mt dn mu mv mw dp mx ld my mz na lh nb nc nd ll ne nf ng nh bi translated">结果</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/317992d1399ecb43ce066b0c7b7c2bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYLd4Csp67sAyEbpGttPXA.png"/></div></div><p class="oa ob gj gh gi oc od bd b be z dk translated">上面代码的原始结果(原始内容)</p></figure><p id="9d38" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">哇，看起来真不错！在这一点上，我们可以继续下去，做任何其他编辑，我们想告诉这个故事。在这种情况下，有人指出，这基本上是一个人口地图，并没有提供太多的信息，但现在我们配备了工具来做更有趣的事情，如比较不同地点的不同商店密度等。</p><h1 id="6166" class="oe mq it bd mr of og oh mu oi oj ok mx jz ol ka na kc om kd nd kf on kg ng oo bi translated"><strong class="ak">贡献者</strong></h1><p id="0245" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">凯尔·帕斯托尔和拉贝·纳齐姆</p><h1 id="555d" class="oe mq it bd mr of og oh mu oi oj ok mx jz ol ka na kc om kd nd kf on kg ng oo bi translated">参考</h1><div class="lx ly gp gr lz ma"><a href="https://pypi.org/project/geobinning/" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd iu gy z fp mf fr fs mg fu fw is bi translated">地理分箱</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">使用 geobinning 根据 geojson 几何来存储[lng，lat]点。任何包含 ID 和多边形的 geojson</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">pypi.org</p></div></div><div class="mj l"><div class="op l ml mm mn mj mo ks ma"/></div></div></a></div></div></div>    
</body>
</html>