<html>
<head>
<title>Introduction to Arrays in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery中数组的介绍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-arrays-in-bigquery-d9f6bd84ce54?source=collection_archive---------25-----------------------#2020-04-24">https://towardsdatascience.com/introduction-to-arrays-in-bigquery-d9f6bd84ce54?source=collection_archive---------25-----------------------#2020-04-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c85f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">实际用例:字数统计</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/916b56e67f287b7b781356f29ca87bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OK9R8rTolA4238_g"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@sortino?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Joshua Sortino </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="64a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我每天都在使用BigQuery，不得不说它的速度和易用性令人惊叹。</p><p id="3ac0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我为什么喜欢BigQuery？三个原因:</p><ol class=""><li id="47d3" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">它无需服务器，完全受管理。除了我的疑问，我什么都不用想。</li><li id="3899" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">由于高效的压缩柱状存储，它的速度非常快。</li><li id="29db" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">它有一个现代化的用户界面:我可以从浏览器做任何事情，没有笨重的安装。</li></ol><p id="335f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了举例说明性能，这里有一个18.5M行的表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/bd53f3546b67b600c6da61eb1b13ff8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/0*Aj_TNtpFM9NA6HqP.png"/></div></figure><p id="29ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们对它运行一个简单的正则表达式查询，提取所有问题的标题和正文，其中标题提到了以下编程语言之一:<code class="fe mk ml mm mn b">python</code>、<code class="fe mk ml mm mn b">rstats</code>、<code class="fe mk ml mm mn b">sql</code>:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="14fe" class="ms mt it mn b gy mu mv l mw mx">select title, body <br/>from `bigquery-public-data.stackoverflow.posts_questions` <br/>where regexp_contains(title, r"\b(python|rstats|sql)\b")</span></pre><p id="cb1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是输出结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/a3c52f5f5ac42facd34b0a8ad0d696fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jaKSJOvdSsEeZaSn.png"/></div></div></figure><p id="4a15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我不知道你，但<strong class="lb iu"> 21秒处理26.9 GB</strong>…我印象深刻。想知道那要花多少钱吗？BigQuery每处理一TB收费5美元，因此查询成本为26.9 / 1000 * 5 = 0.1345美元。</p><p id="342f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至此，让我们直接开始使用BigQuery中的数组。</p><h1 id="1786" class="mz mt it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">在BigQuery中使用数组</h1><p id="ec4c" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">现在你可能已经猜到了，我们将会统计StackOverflow问题中出现的单词。但是在我们开始实际的例子之前，我想先介绍一下在BigQuery中使用数组的基础知识。</p><h2 id="be4a" class="ms mt it bd na nv nw dn ne nx ny dp ni li nz oa nk lm ob oc nm lq od oe no of bi translated">1.创建数组</h2><p id="6524" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在原型开发阶段，创建小的数组会很有用。例如:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="a5fb" class="ms mt it mn b gy mu mv l mw mx">select <br/>'Engineering' as role, 'Mike' as name, ['Java', 'C#'] as languages </span><span id="d522" class="ms mt it mn b gy og mv l mw mx">union all </span><span id="5d48" class="ms mt it mn b gy og mv l mw mx">select 'Data science' as role, 'Vlad' as name, ['python', 'SQL', 'R'] as languages </span><span id="32e6" class="ms mt it mn b gy og mv l mw mx">union all </span><span id="249e" class="ms mt it mn b gy og mv l mw mx">select 'Front-end' as role, 'Guillaume' as name, ['javascript', 'C#', 'HTML', 'CSS'] as languages</span></pre><p id="2bc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这为我们提供了以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/94c11fc3a01491f997b7ac55af848077.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/0*lfvo8SAOuUu8HjOm.png"/></div></figure><p id="3e63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意数组是如何垂直嵌套在每行中的。</p><h2 id="97f6" class="ms mt it bd na nv nw dn ne nx ny dp ni li nz oa nk lm ob oc nm lq od oe no of bi translated">2.展平数组</h2><p id="3fbf" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">如果我们想把这个嵌套结构变成一个普通的平面表，我们需要<strong class="lb iu">取消嵌套</strong>数组:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="4808" class="ms mt it mn b gy mu mv l mw mx">with T0 as <br/>(select 'Engineering' as role, 'Mike' as name, ['Java', 'C#'] as languages </span><span id="79fe" class="ms mt it mn b gy og mv l mw mx">union all </span><span id="c5ae" class="ms mt it mn b gy og mv l mw mx">select 'Data science' as role, 'Vlad' as name, ['python', 'SQL', 'R'] as languages </span><span id="8fb0" class="ms mt it mn b gy og mv l mw mx">union all </span><span id="e76a" class="ms mt it mn b gy og mv l mw mx">select 'Front-end' as role, 'Guillaume' as name, ['javascript', 'C#', 'HTML', 'CSS'] as languages) </span><span id="1922" class="ms mt it mn b gy og mv l mw mx">SELECT role, name, languages <br/>from T0 <br/>CROSS JOIN UNNEST(T0.languages) as languages</span></pre><p id="9464" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mk ml mm mn b">CROSS JOIN UNNEST</code>代码执行所谓的关联连接，这意味着它跟踪每个数组与哪一行相关联，这样就不会不必要地执行完全的交叉连接。</p><p id="055d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在得到了更熟悉的扁平和重复结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/46619fd061ab08978d2f0d405d135552.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/0*TJaCMmrCU-GHY6kx.png"/></div></figure><h2 id="7e2c" class="ms mt it bd na nv nw dn ne nx ny dp ni li nz oa nk lm ob oc nm lq od oe no of bi translated">3.索引数组</h2><p id="5da6" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">假设我们想知道每个程序员最后的语言是什么。BigQuery中数组的索引有两种方式:基于0的索引(python风格)用<code class="fe mk ml mm mn b">OFFSET</code>或者基于1的索引(R风格)用<code class="fe mk ml mm mn b">ORDINAL</code>。</p><p id="d02e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将以<code class="fe mk ml mm mn b">ORDINAL</code>为例，和<code class="fe mk ml mm mn b">ARRAY_LENGTH</code>一起检索每个数组的长度。使用与上面相同的T0定义:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="9d67" class="ms mt it mn b gy mu mv l mw mx">SELECT role, name, languages[ORDINAL(ARRAY_LENGTH(languages))] as last_language from T0</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/4d2714bbd872776f42e4318b3ecb0f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/0*y3w7Xjep_61Z49gr.png"/></div></figure><h1 id="544d" class="mz mt it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">使用BigQuery统计单词</h1><p id="0da0" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">基础知识讲完了，让我们进入一个具体的数组用例。</p><p id="2d1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们希望有一种方法来统计问题标题中每个单词的频率，如果可能的话，还有一种方法来捕捉单词和问题标签之间的相关性。</p><p id="36df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将字符串转换成单词数组的一个关键函数是<code class="fe mk ml mm mn b">split</code>函数。这里有一个例子:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="3b2d" class="ms mt it mn b gy mu mv l mw mx">select title, tags, split(title, ' ') as words <br/>from `bigquery-public-data.stackoverflow.posts_questions` limit 10</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/2bcbf2b7133c25ba35165ec29a572a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4Zv9_3WN9_yekzLs.png"/></div></div></figure><p id="729c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有趣的是，我们在上图中看到我们有一串标签。让我们把它也变成一个数组:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="0eb6" class="ms mt it mn b gy mu mv l mw mx">select <br/>title, <br/>split(tags, '|') as tags, <br/>split(title, ' ') as words <br/>from `bigquery-public-data.stackoverflow.posts_questions` limit 10</span></pre><p id="91ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以每行包含两个数组:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/76236fdb6d4c69fc9355f20a3b7f8dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AtHKSYiryn8F7VaFP_IpXQ.png"/></div></div></figure><p id="4e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们将<strong class="lb iu">交叉连接/取消嵌套两个数组</strong>，并过滤掉不感兴趣的单词，即长度小于2个字符的单词和一些常见的停用词:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="46af" class="ms mt it mn b gy mu mv l mw mx">with t0 as </span><span id="817c" class="ms mt it mn b gy og mv l mw mx">(select <br/>id, <br/>title, <br/>split(tags, '|') as tags, <br/>split(title, ' ') as words <br/>from `bigquery-public-data.stackoverflow.posts_questions`) </span><span id="70eb" class="ms mt it mn b gy og mv l mw mx">select <br/>id, <br/>tag, <br/>word <br/>from t0 <br/>cross join unnest(t0.words) as word <br/>cross join unnest(t0.tags) as tag <br/>where length(word) &gt; 1 <br/>and lower(word) not in ('me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', "it's", 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', "isn't", 'are', 'was','were', "aren't", "wasn't", "weren't", 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'can', "can't", 'will', "won't", 'just', "don't", 'should', "shouldn't", 'now', 'get')</span></pre><p id="f75c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个查询运行了24秒，就这样，我们获得了所有相关标签和单词的笛卡尔积:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/580b25dccbadc3402056547f3aaa89de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*qBm6WkaOQmsei49AD8QpiA.png"/></div></figure><p id="7f3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以很容易地问，对于一个给定的标签，例如<code class="fe mk ml mm mn b">python</code>(假设上一步的输出已经保存在表<code class="fe mk ml mm mn b">so</code>中，在数据集<code class="fe mk ml mm mn b">temp</code>内)，哪些单词最能被表示出来:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="a2b6" class="ms mt it mn b gy mu mv l mw mx">select <br/>word, <br/>count(*) as frequency <br/>from `temp.so` where tag='python' <br/>group by word order by frequency desc</span></pre><p id="84d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们得到的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/9985f4a875c47b9dfa2eb87c11c56f58.png" data-original-src="https://miro.medium.com/v2/resize:fit:470/format:webp/0*dIL70tGlQJnUpReR.png"/></div></figure><p id="dd21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者我们可以反过来问什么标签与一个特定的单词相关联，例如<code class="fe mk ml mm mn b">flask</code>:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="c860" class="ms mt it mn b gy mu mv l mw mx">select <br/>tag, <br/>count(*) as frequency <br/>from temp.so <br/>where word = 'flask' <br/>group by tag order by frequency desc</span></pre><p id="b31e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/7bd7e0e16012618733a3e7222ec63ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/0*_3MWDMArwaY93-4t.png"/></div></figure><h1 id="e392" class="mz mt it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">更进一步</h1><p id="a182" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在这里，tf-idf分析将有助于挑选出python相对于其他标记真正特有的内容。虽然超出了本文的范围，但这将是一个很好的副业。</p><p id="67ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数组构成了BigQuery的一个重要特性，我还期待着写一些其他的好东西。在我看来，BigQuery是最令人印象深刻的大数据分析工具之一！</p></div></div>    
</body>
</html>