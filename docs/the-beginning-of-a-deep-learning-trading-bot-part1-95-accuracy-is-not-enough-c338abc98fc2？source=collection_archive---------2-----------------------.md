# 深度学习交易机器人的开始——第一部分:95%的准确率是不够的

> 原文：<https://towardsdatascience.com/the-beginning-of-a-deep-learning-trading-bot-part1-95-accuracy-is-not-enough-c338abc98fc2?source=collection_archive---------2----------------------->

## 跟随我的研究之旅，我开发了一个基于深度学习的交易系统。

![](img/f964953e13131a1bec9813fb017f28dc.png)

由 vectorpouch / Freepik 设计

好吧，我的朋友们，我们的目标是开发一个能够持续跑赢市场的复杂交易系统。最终，我们将有一个生产就绪的应用程序，我将投资大约****我自己的积蓄**20，000 美元，并与你们分享成果。因此，在这一系列文章中，我将不仅仅分享概念的证明，还将分享开发能够处理真实市场不确定性的人工智能系统实际需要的东西。**

**大多数人工智能和深度学习来源都倾向于只呈现最终的研究结果，这在试图理解和再现所提供的解决方案时可能会令人沮丧。相反，我想让这个系列尽可能有教育意义，因此将分享我的思路和所有进入最终解决方案的实验。**

**在我们开始之前，我们必须提醒自己，预测市场中特定股票的价格变动是一项非常复杂的任务。股票走势是由每个市场参与者接触到的**数百万个印象和先决条件**造成的。因此，我们需要能够**捕获尽可能多的**这些**印象和先决条件**。此外，我们还必须对市场的运行方式做几个假设。**

# **假设**

1.  ****市场并不完全完善**。也就是说，信息不是所有市场参与者都能立即获得的，而是需要时间来传播。**
2.  **历史市场事件和股票走势会影响未来的股票走势。**
3.  **市场主要遵循人们的理性行为。**

**请务必阅读底部的免责声明。**

# **即将到来的结构**

**由于我们无法在一篇文章中涵盖整个交易机器人的开发，我设想本系列的结构如下:**

1.  **在这篇文章中，我分享了我第一次使用**股票价格/回报** **和交易量**来预测未来股票走势的实验。**
2.  **在下一篇文章中，我将分享不同的实验，利用**金融和市场新闻**来补充历史股票价格，以对未来股票价格和回报做出更稳健的预测。**
3.  **结合所有实验结果和**开发一个生产级模型**，该模型包含股票价格、交易量、新闻和其他数据点，用于预测股票回报。**
4.  **建造一个**深度加固机器人**用于交易执行。我们将训练一个机器人，它可以根据历史价格和我们的股票走势预测，学习何时买卖不同的股票。**
5.  **在**云服务**上托管和部署交易机器人。**
6.  **将交易机器人连接到**纸交易账户，**作为最后的预演。**
7.  ****投资 2 万美元**让 bot 与市场自由互动。**

# **开始实验——找到正确的数据**

**在训练生产级别的模型之前，我们首先必须找出在预测股票回报时股票价格和金融新闻的解释力有多大。**

**为了获得股票价格和新闻如何预示未来股票价格变化的第一印象，我们最初在一个较小的数据集上训练多个模型。我们将用来开始证明我们假设的数据集是 IBM**股票的历史价格和交易量数据。****

**IBM 在雅虎上有相当长的价格历史，价格可以追溯到 1962 年。获得 IBM 历史价格的最简单方法是从雅虎的 IBM 页面下载数据集。对于每个交易日，雅虎提供开盘价、最高价、最低价、收盘价和交易量( **OHLCV** )。一旦下载并加载到笔记本中，IBM OHLCV 数据如下所示。**

**![](img/68a4db7c4c69b59dbf916b2d7505c169.png)**

**IBM 的价格和销量数据**

**为了了解价格如何随时间变化，我们绘制了**日收盘价**。IBM 价格图的开始日期是 1962 年 1 月 2 日，结束日期是 2020 年 2 月 3 日，价格范围在 7.5 美元到 225 美元之间。**

**![](img/d2a95c3d60d232dd39f3367f6e028063.png)**

**IBM 每日收盘价 1962–2020**

**让我们也来看看**成交量数据**，我们将使用它作为价格数据点的附加特征。每天的交易量是通过**乘以每笔交易的**乘以**股数**乘以交易的**股价**计算出来的。然后将一天中所有交易的产品相加，形成这一天的交易量数据点。**

**![](img/bbac025eed62b3e1d0d62fb6175a2a2b.png)**

**IBM 1962 年至 2020 年的日交易量**

## **预处理我们的数据——我知道这很无聊，但很有必要😊**

**将原始价格和交易量数据输入深度学习模型通常不是一个好主意。当查看 IBM 的价格图表时，你可以看到 1962 年至 1991 年的价格(7 美元至 48 美元)与 2000 年和 2020 年的价格(140 美元至 220 美元)完全不同。本质上，这两个价格区间关系不大。这意味着从 1962 年到 1991 年的范围(平均价格 25 美元)对 2000 年到 2020 年的价格范围(平均价格 130 美元)没有什么解释价值。为了使过去的价格点与最近的价格点处于同一水平，从而对训练我们的神经网络更有用，我们必须做一些预处理步骤。让我们开始预处理，我保证会很快。**

****首先**，我们将把价格和交易量转换成价格回报/百分比变化。最简单的方法是使用 pandas 函数 pct_change()。**

**有价格回报的好处是它们比原始价格数据更稳定。平稳性的简单解释:**平稳性=好**，因为过去的数据与未来的数据更相似，使得预测更容易。**

**![](img/a208b158bd5b3dcbf7f840c75931c19e.png)**

**IBM 的每日股票回报和成交量变化**

**下一张图很好地说明了将股票价格转换为股票回报消除了股票价格上涨的趋势。**

****其次**，最小-最大归一化应用于所有价格和交易量数据，使我们的数据范围从 0 到 1。标准化数据不使用原始价格回报和交易量变化，而是具有允许深度学习模型更快更稳定地训练的优势。**

****第三**，我们将把时间序列分成训练、验证和测试数据集。在大多数情况下，训练和验证数据集分割就足够了。然而，对于时间序列数据，在测试集上进行最终评估是至关重要的。模型根本没有看到测试数据集，因此我们在评估中避免了任何前瞻或其他时间偏差。**

**计算股票回报、标准化并将数据分成 3 个部分后，数据集现在具有下图所示的形状。**

**![](img/6df670b105b95607c5c28631479bc04c.png)**

# **培训和测试不同的模型架构**

**准备好数据集后，我们现在可以开始做有趣的事情了——训练不同的深度学习模型。我试验过双向 LSTM、变形金刚和 CNN + Bi-LSTM 所有型号的代码都可以在 Github 上找到。**

## **双向 LSTM(双向 LSTM)**

**双向 LSTM 是传统 LSTM(**L**ONG**S**short**T**erm**M**记忆单元)的扩展，可以提高处理顺序数据集时的模型性能。双向 LSTM 组合了两个单独的 LSTM 层，而第一 LSTM 层以正确的时间顺序接收顺序数据(例如 IBM 价格),而第二 LSTM 层仅以相反的顺序接收相同的数据。在输入数据被双向 LSTM 层(2 个 LSTM 层)处理后，两个输出被连接以产生最终预测。为了更容易理解，我在下面添加了一个插图和代码。**

**![](img/0e51ca74ec77df40d1626393d345059f.png)**

**现在让我们看看双向 LSTM 模型编码后的样子。该模型不是只有一个双 LSTM 层，而是由三个双 LSTM 层构成，以提高模型的容量。**

**现在让我们开始训练过程。**

## **评估模型**

**![](img/c9fb18b64738804e12ea71f32fc46840.png)**

**双向 LSTM 结果**

**在训练了 200 个时期后，我们获得了以下结果。对于验证集，我们有一个**平均百分比误差** (MAPE)为 **3.5828** ，为了简单起见，可以解释为 **96.42%** 的准确度。测试数据集的 MAPE 值为 **4.2656** ，相当于精度为 **95.73%** 。一开始，超过 95%的准确率似乎令人惊讶，但下一张图显示了一个不同的故事。**

**蓝线代表 IBM 股票的每日价格变化(每日股票回报)，黄线对应于我们的模型预测。尽管平均准确率超过 95%，但该模型仅仅设法找到了股票收益分布的中心。黄色预测线根本没有偏离 0.6 左右的股票回报中心。**

**![](img/3ebff2207b6ff42d3ec8dc054f4eb03a.png)**

**Bi-LSTM — IBM 每日股票回报(蓝色)和次日股票回报预测(黄色)**

**对稳定预测线的解释是，我们的模型能够**识别 IBM 股票的总体趋势**。目前，我们的实验表明，仅通过单只股票的价格数据，只能得出趋势，而不能得出异常值。**

## **CNN +双向 LSTM**

**现在，我们将执行与普通双 LSTM 模型完全相同的步骤，但我们将把双 LSTM 与卷积网络(CNN)结合起来，而不是使用普通双 LSTM。**

**![](img/39f5a2540a313e0b726ab4609b338def.png)**

**通常，CNN 用于图像分类，而 CNN 中的每个卷积层从图像中提取不同的特征。然而，近年来已经表明，CNN 在分析时间序列和顺序数据(例如声音和文本)时提供了价值。卷积层在检测空间上彼此接近的数据点之间出现的模式方面表现良好。如果你每天的价格和交易量数据应该是这样的。**

**传统层的架构受到了 Google 的 Inception blocks 的启发。我把盗梦空间模型的 2D 卷积改成了 1D 卷积，使得各层与我们的时间序列兼容。**

**好，让我们构建 CNN +双 LSTM 模型。**

**最后是 CNN +双 LSTM 模型的训练启动。**

## **评估模型**

**![](img/7d03795ea02f39d294e8e98ce82dad57.png)**

**CNN+Bi_LSTM 结果**

**在对该模型进行了 200 个时期的训练后，训练结果如下。验证集的 MAPE 值为 **3.8454** 仅略高于前代车型的**3.5828**。测试数据集的 MAPE 值为 **4.5289** ，而不是双 LSTM 模型的 **4.2656** 。对于验证和测试集来说，CNN+双 LSTM 网络比传统的双 LSTM 模型表现更差。虽然我们有更差的结果，但我很满意地看到，这一次我们不只是有一条直线预测线，因此可以排除任何严重的模型或数据结构缺陷。🤓**

**这一次，我们的模型再次学会了只预测价格运动的趋势。然而，仅凭 IBM 价格数据是不可能预测异常值的。**

**![](img/9e6a1cb0ef5994dc36b157f13861c1fb.png)**

**CNN+Bi-LSTM — IBM 每日股票回报(蓝色)和次日股票回报预测(黄色)**

**如果你有兴趣看所有不同模型架构的结果和我实验的完整代码，请看这里。 [**Github**](https://github.com/JanSchm/CapMarket/blob/master/bot_experiments/IBM_PriceFeatures.ipynb)**

# **后续步骤—最终想法**

**总之，我们的模型能够识别价格变化的总体趋势，但异常值无法预测。平均百分比误差(MAPE)始终低于 5，相当于 95%以上的准确度解释。对于第一次实验来说，结果已经很有希望了。然而，为了改进我们模型的缺点和掌握异常值预测，我们有几个选择。**

****首先**，我们可以添加额外的数据源来帮助预测异常值，比如金融和市场新闻。**

****其次**，我们可以用更多不同股票的价格数据训练更大的模型。为此，我整理了一份 7200 只公开交易股票的列表，我们将在未来的文章中使用它来提高模型性能。**

**还有更多的细节需要探索。我确信有许多问题和未回答的部分。所以，任何意见和建议——请分享。我很乐意在未来的过程中提出建议。**

****在下一篇文章**中，我将向**展示如何将金融新闻与价格数据结合起来**，以提高我们网络的价格回报预测。**

> **非常感谢你读到最后。**
> 
> **一月**

## **编辑于 2022 年 6 月 1 日:**

**在过去，我收到了一些反馈和请求，希望我的金融资产预测模型能够变得可用且易于使用。这将有助于人们回答以下问题:**

**有哪些好的资产可以投资？我应该把什么放入我的金融投资组合？**

> **我给你介绍一下**pink lion**[www . pink lion . XYZ](http://www.pinklion.xyz)**

**[](https://www.pinklion.xyz/) [## 粉色狮子

### 我们把你从乏味和令人沮丧的工作中解脱出来。没有更多的清洁数据和模型试验和…

www.pinklion.xyz](https://www.pinklion.xyz/) 

PinkLion 是一款基于我的代码基础之上的产品，它使成千上万的股票、基金/ETF 和加密货币的日常资产数据可用。此外，通过提供对基础预测模型的访问，它允许资产分析和投资组合的动态优化。

目前，注册人数仍然有限，因为单个计算需要大量的服务器资源。

请随意尝试并提供反馈。(目前还处于大致状态) [www.pinklion.xyz](http://www.pinklion.xyz)** 

# **放弃**

****本文中的任何内容都不构成任何特定证券、证券组合、交易或投资策略适合任何特定人士的建议。期货、股票和期权交易包含巨大的损失风险，并不适合每个投资者。期货、股票和期权的估值可能会波动，因此，客户的损失可能会超过其原始投资。****