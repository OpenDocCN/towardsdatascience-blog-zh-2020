<html>
<head>
<title>AWS Athena and Glue: Querying S3 data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Athena 和 Glue:查询 S3 数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/aws-athena-and-glue-querying-s3-data-ce83f1ba9f9f?source=collection_archive---------24-----------------------#2020-04-13">https://towardsdatascience.com/aws-athena-and-glue-querying-s3-data-ce83f1ba9f9f?source=collection_archive---------24-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="908b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">AWS Glue 是一个 ETL 服务，允许数据操作和数据管道管理。</h2></div><p id="7c67" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个特定的例子中，让我们看看如何使用 AWS Glue 将 csv 文件从 S3 存储桶加载到 Glue 中，然后在 Athena 中对这些数据运行 SQL 查询。</p><p id="3e28" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是 S3 存储桶中的 CSV 文件，如下图所示——数据集本身可以从本文末尾引用的 GitHub 存储库中获得。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/8f6e4f69c05436cf86f03de2ba868d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h6y37ly4dTEn2Ww51Zj6BA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><h1 id="98d9" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">在 AWS Glue 中设置爬虫</h1><p id="9e59" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">爬行器用于从源中提取数据，分析数据，然后确保数据符合特定的模式——或定义表中每个变量的数据类型的结构。</p><p id="9725" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">定义了 crawler，并设置了数据存储、IAM 角色和调度。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mr"><img src="../Images/d6eb97c2daaec485554f48a5b8be02b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1JiWS8RDGn12qoMZTycGwQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><p id="8855" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">crawler 将需要一点时间来提取表，这取决于数据的大小。在这里，爬虫被安排按需运行。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ms"><img src="../Images/2a97ac4a957ac02c2794b9abd144a159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tbl4c2RPWHwm8fkSff2jOg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><p id="6018" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，也可以将 crawler 设置为按特定的时间表运行。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mt"><img src="../Images/d17cf3aacd589a3dc783c364a88b0f1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xoBMmRN0kQgvzXGtM0W3YA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><p id="880e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当 S3 存储桶中的数据定期更新或更改时，这一点尤其重要——必须确保 Glue 中的数据保持最新。</p><p id="00dd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该表现在显示在 AWS 胶中。这里，模式被自动检测。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mu"><img src="../Images/62ceabe2cae0227e56258ce7b7d6218f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*laOlfk39ynkbsONB.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务。</p></figure><p id="bc47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，也可以通过选择编辑模式，然后手动定义每个变量的数据类型来编辑模式:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mv"><img src="../Images/fcf431b0e56109de56977dfa39ca1a0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R16O_1oGTvHC-BlYdXm8Cw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务。</p></figure><h1 id="11a4" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">雅典娜中的查询</h1><p id="b4c9" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">现在这个表是用 AWS Glue 表示的，让我们试着运行一些查询！</p><p id="fd00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Athena 是一项 AWS 服务，允许在 S3 对数据运行标准 SQL 查询。因为已经在 Glue 中建立了模式，并且表已经加载到数据库中，所以我们现在只需要查询我们的数据。</p><p id="7528" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正在分析的特定数据集是酒店预订数据集。</p><p id="0081" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们使用一些 SQL 查询来执行以下操作:</p><ol class=""><li id="c573" class="mw mx it kk b kl km ko kp kr my kv mz kz na ld nb nc nd ne bi translated">从表中选择所有列，其中 Country 列下的所有条目都以字母 p 开头。</li><li id="d04b" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated">计算平均提前期，其中国家= 'PRT '(葡萄牙)。</li><li id="d280" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated">计算平均 ADR 值，其中 Country = 'GBR '(英国)，且细分市场属于直接类别。</li><li id="7635" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated">最后，让我们根据国家、预订的房间类型和客户类型来订购桌子。</li></ol><h2 id="6629" class="nk lv it bd lw nl nm dn ma nn no dp me kr np nq mg kv nr ns mi kz nt nu mk nv bi translated">查询 1</h2><p id="b3c7" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated"><code class="fe nw nx ny nz b">select * from table where country like ‘P%’;</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oa"><img src="../Images/c96413cd59c0cac7a97ff11d7a5cb1f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZBzePF6X2S-YmFaIMFLSew.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><h2 id="4017" class="nk lv it bd lw nl nm dn ma nn no dp me kr np nq mg kv nr ns mi kz nt nu mk nv bi translated">查询 2</h2><p id="8275" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated"><code class="fe nw nx ny nz b">select avg(leadtime) from table where country=’PRT’;</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ob"><img src="../Images/cc2b8846acf10be78fad2038dc0b7b0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*giSyCAyQnByG3Ir_zxeg4w.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><h2 id="5ef3" class="nk lv it bd lw nl nm dn ma nn no dp me kr np nq mg kv nr ns mi kz nt nu mk nv bi translated">查询 3</h2><p id="79e4" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated"><code class="fe nw nx ny nz b">select avg(adr) from table where country=’GBR’ and marketsegment=’Direct’;</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oa"><img src="../Images/c17a2cc7c4fd822248fa2beeb592ed56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CLo3EkEn_S2mO7MVtW8HQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><h2 id="a6e9" class="nk lv it bd lw nl nm dn ma nn no dp me kr np nq mg kv nr ns mi kz nt nu mk nv bi translated">查询 4</h2><p id="483c" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated"><code class="fe nw nx ny nz b">select * from table order by country, reservedroomtype, customertype;</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oc"><img src="../Images/00376718ce3d5ffe9f74ed930db6d2bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a3zQa6pDwtz2Kt6jlyQKBw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><p id="8df3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些查询也可以保存起来供以后使用。让我们保存查询 3 作为一个例子。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi od"><img src="../Images/fb8cb2fc389932d6ff9b54bd1bf5c361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*zC7W-r2D2C6wTi-n.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务。</p></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oe"><img src="../Images/fc46476c3e10bca9d0b89ede3269e7d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rGrJFASVy49S1-yZU05rjA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:亚马逊网络服务</p></figure><h1 id="5f22" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">结论</h1><p id="0a9a" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">在本例中，您看到了:</p><ul class=""><li id="94cd" class="mw mx it kk b kl km ko kp kr my kv mz kz na ld of nc nd ne bi translated">如何用胶水在 S3 桶中抓取数据</li><li id="8070" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld of nc nd ne bi translated">在 Glue 中编辑表模式</li><li id="f664" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld of nc nd ne bi translated">使用 Athena 运行 SQL 查询</li></ul><p id="5a48" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">非常感谢您的参与，相关的数据集可以在<a class="ae og" href="https://github.com/MGCodesandStats/aws-glue-athena-hotels" rel="noopener ugc nofollow" target="_blank"> MGCodesandStats GitHub 存储库</a>中找到。</p><p id="ae25" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还可以在 michael-grogan.com 的<a class="ae og" href="https://www.michael-grogan.com/" rel="noopener ugc nofollow" target="_blank">找到我的数据科学内容。</a></p><p id="5197" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="oh">免责声明:本文是在“原样”的基础上编写的，没有担保。本文旨在提供数据科学概念的概述，不应以任何方式解释为专业建议。</em></p></div></div>    
</body>
</html>