<html>
<head>
<title>AutoML for Time Series Forecasting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">时间序列预测的AutoML</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automl-for-time-series-forecasting-6caaf194d268?source=collection_archive---------9-----------------------#2020-01-06">https://towardsdatascience.com/automl-for-time-series-forecasting-6caaf194d268?source=collection_archive---------9-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/d3406316e7f1079fbe76619ef2515e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/1*8Qqu7RarZProX_n7UxnYUg.gif"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">《辛普森一家》第七季第135集(“特大号荷马”)</p></figure><div class=""/><p id="a3b3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然我不是现在汽车的粉丝，但我喜欢参加汽车比赛。我相信这样的比赛是一个很好的学习机会，可以为未来的项目提供强大的管道。AutoML竞赛介于Kaggle类竞赛和LeetCode任务之间:您的代码应该给出高分，并且应该稳定快速。</p><p id="c951" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最近我参加了<a class="ae kz" href="https://autodl.lri.fr/competitions/163" rel="noopener ugc nofollow" target="_blank">汽车系列</a>——汽车时间序列数据竞赛，我在40名参赛者中获得了第一名(15名进入决赛)。这篇文章概述了我的解决方案。</p><figure class="la lb lc ld gt iv"><div class="bz fp l di"><div class="le lf l"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">我在莫斯科2020年奥维托ML培训期间关于最终解决方案概述的讲话</p></figure><h1 id="ea14" class="lg lh je bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">竞争描述</h1><p id="b456" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">AutoSeries是网络搜索和数据挖掘(<a class="ae kz" href="http://www.wsdm-conference.org/2020/index.php" rel="noopener ugc nofollow" target="_blank"> WSDM </a>)大会的竞赛项目之一。该比赛是由4Paradigm和ChaLearn举办的第10届AutoML比赛。之前的目标是为表格数据、计算机视觉、自然语言处理和语音识别任务提供自动化的机器学习解决方案。过去挑战赛的完整列表可以在AutoML挑战赛的官方网站<a class="ae kz" href="http://automl.chalearn.org/" rel="noopener ugc nofollow" target="_blank">上找到。</a></p><p id="f77c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这项挑战旨在为时间序列回归任务提出自动化解决方案。AutoSeries仅限于多元回归问题，这些问题来自不同的时间序列领域，包括空气质量、销售、工作场所、城市交通等。挑战中的每个数据集都是表格数据，其特征主要有三种类型:Id(可能有多个特征，也可能没有)、时间戳(每个数据集只有一个时间戳)、其他特征(数字或分类)以及预测目标。Id特征的组合识别一个变量(一个时间序列)。</p><figure class="la lb lc ld gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/1bfa2cc62c6a585b3fc607efef84b54e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R4Py4B2WNhGhfIk_KB73Jw.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">给定数据集的示例。正如你所看到的，数据是混乱的，但是有一些时序模式</p></figure><p id="d5e6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">参与者要提交代码，代码将在Docker容器中运行(CPU: 4核，16 Gb RAM，无GPU)。首先，该模型是在完整数据上训练的，但是在推理过程中，它可以被更新或重新训练。公共排行榜是在五个数据集上计算的，私人——没有人为干预的五个新数据集。私有数据集的结果决定了最终的排名。</p><figure class="la lb lc ld gt iv gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/780acc89f6677f138b6397288f09dd6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/0*o4OdVChCf0Dx1U83.png"/></div></figure><h1 id="2fa6" class="lg lh je bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">最终解决方案概述</h1><figure class="la lb lc ld gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mp"><img src="../Images/79c639392b56713b5a3b5af233d7496e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oz9_6gjO29mo0BrjoEvdpQ.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">最终解决方案的一般步骤</p></figure><p id="5656" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这一部分专门讨论最终解决方案的主要部分。它的代码公布在这里:</p><div class="is it gp gr iu mq"><a href="https://github.com/DenisVorotyntsev/AutoSeries" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jf gy z fp mv fr fs mw fu fw jd bi translated">DenisVorotyntsev/汽车系列</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">github.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne iw mq"/></div></div></a></div><h2 id="625f" class="nf lh je bd li ng nh dn lm ni nj dp lq km nk nl lu kq nm nn ly ku no np mc nq bi translated">特征工程</h2><p id="c7f7" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">该解决方案由几个步骤组成。首先，为时序任务生成公共特征。这些特征的数量和类型是管道的超参数，应该针对每个任务分别进行优化，但是由于缺乏计算时间，我决定为所有任务生成相同的特征，并在特征选择阶段删除无用的特征。</p><p id="adfb" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">第一批特征是基于最关键的数字特征的特征。数字特征对的数字运算(加、减、乘、除)总是提高基于树的模型的得分，因为新特征可能揭示数据中的一些隐藏关系。</p><p id="4d4b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们以预测公寓的价格为例。关于公寓楼层(<em class="nr"> ap_floor </em>)和建筑物中楼层总数(<em class="nr"> total_floors </em>)的已知信息可以通过添加新特征来丰富，该新特征显示公寓楼层在建筑物中的相对位置:</p><pre class="la lb lc ld gt ns nt nu nv aw nw bi"><span id="1de0" class="nf lh je nt b gy nx ny l nz oa"><em class="nr">rel_floor</em> = <em class="nr">ap_floor / total_floors</em></span></pre><p id="21df" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此功能可能有助于模型理解排屋中的第三层(<em class="nr"> rel_floor </em>更接近1)与摩天大楼中的第三层(<em class="nr"> rel_floor </em>更接近0)不同。</p><p id="cc32" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，如果我们执行所有可能对的数值运算，这种特征工程策略有两个重大问题:过拟合，这在时序任务中尤其重要，以及存储器问题(使用了16 RAM docker)。为了减少负面影响，选择一小部分特征用于配对。这是通过将整个数据集拟合到浅层LigtGBM模型(10棵树)来完成的。所有使用的特征按照“增益”重要性排序，即使用该特征的分裂的增益的总和。然后<em class="nr"> top-n </em>最重要的<em class="nr"> </em>数字特征被选择成对。</p><p id="f8f5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一批特征基于数据的时间序列性质:以前的值和差异。我计算目标的滞后值、最重要的数字和分类特征、目标的最后值(滞后= 1)和目标的滞后值(滞后&gt; 1)之间的差异。这些新特性是最重要的特性之一。</p><p id="27f0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后一批是时间序列特征:年、月、星期几、一年中的某一天和小时。我可以添加更多基于时间的特性，比如一天中的一分钟，一年中的四分之一，等等，但是我决定不这样做，所以我的解决方案是通用的。将这些新特征分类有时会提高分数，但在其他情况下，会显著降低分数。我在推理过程中没有足够的计算时间来优化这个超参数(即，作为数值或分类处理)，所以它们都被作为数值处理。</p><h2 id="3588" class="nf lh je bd li ng nh dn lm ni nj dp lq km nk nl lu kq nm nn ly ku no np mc nq bi translated">验证和基线模型</h2><figure class="la lb lc ld gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ob"><img src="../Images/fdb46a0fc5af9b509ad3648706538d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5cofa_Fm4_AlWErtgz0lYQ.png"/></div></div></figure><p id="e7bd" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在生成新特征之后，基线模型被训练。基线模型使用所有初始和创建的特征。它使用CatBoost编码器对类别进行编码，并按原样使用目标。该模型分两步训练:</p><ol class=""><li id="53b0" class="oc od je kd b ke kf ki kj km oe kq of ku og ky oh oi oj ok bi translated">首先，数据被分成训练和验证部分。通常，您希望您的培训/验证/测试分割能够模拟“生产设置”中模型的使用。在时间序列的情况下，这意味着模型不会频繁更新，您在验证部分采用20–30%的数据(或使用相同比例的滚动窗口)。在这个竞赛中，模型的频繁更新是可能的，因此，验证部分应该更小:验证部分是全部训练数据的10%。它用于早期停止，即优化boosting集成中的树的数量。在这一步之后，模型可以开始进行预测，接下来的所有步骤都是可选的(对于高分来说是至关重要的)。</li><li id="b32b" class="oc od je kd b ke ol ki om km on kq oo ku op ky oh oi oj ok bi translated">使用最佳数量的树在全部数据上重新调整模型。</li></ol><p id="1a2f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我使用solo LigthGBM模型进行预测。我测试了CatBoost(没有GPU太慢)和LinearModels(不够准确)。我还用不同的种子测试了打包和训练，以减少预测的方差，但这些方法花费了大量时间，并且没有将分数提高到足以包含在最终解决方案中。</p><h2 id="beb6" class="nf lh je bd li ng nh dn lm ni nj dp lq km nk nl lu kq nm nn ly ku no np mc nq bi translated">超参数优化</h2><figure class="la lb lc ld gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oq"><img src="../Images/91a8817693be0ff3f72f58938406485f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cEbIcRd2JN-kbU7z99wNPA.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">超参数优化的步骤</p></figure><p id="57a1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我在超参数优化的推理过程中时间太少，所以我决定将所有可能的超参数组合缩小到最有希望的组合，即:</p><ol class=""><li id="68c9" class="oc od je kd b ke kf ki kj km oe kq of ku og ky oh oi oj ok bi translated">处理分类变量:将分类特征视为pandas类别类型，将难题留给LightGBM，或者用CatBoost编码对每个类别进行编码(如果您还没有阅读，请查看我以前关于编码类别的文章)。</li><li id="8b3d" class="oc od je kd b ke ol ki om km on kq oo ku op ky oh oi oj ok bi translated">目标预处理:按原样使用目标或者通过微分计算一个新的目标进行回归:<em class="nr">new _ target(t)= target(t)-target(t-1)</em>。差分有助于克服时间序列数据的非平稳性。我还测试了power transformation(对target和Box-Cox求根)来减少平稳性，但它没有将分数提高到足以包含在最终解决方案中。</li></ol><div class="is it gp gr iu mq"><a rel="noopener follow" target="_blank" href="/benchmarking-categorical-encoders-9c322bd77ee8"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jf gy z fp mv fr fs mw fu fw jd bi translated">基准分类编码器</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">通过选择最佳类别编码器来增加ML模型的分数</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">towardsdatascience.com</p></div></div><div class="mz l"><div class="or l nb nc nd mz ne iw mq"/></div></div></a></div><p id="0b11" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先对每组参数进行验证，如果新的验证分数更高，则对模型进行改装。在选择了最佳的管线超参数集之后，模型开始特征选择:使用前5、10、20等来重新调整模型。最重要特性的百分比(“获得”重要性)。如果分数有所提高——一组新的特征被用于最后的可选步骤——优化超参数(随机网格)。</p><h2 id="a526" class="nf lh je bd li ng nh dn lm ni nj dp lq km nk nl lu kq nm nn ly ku no np mc nq bi translated">更新</h2><p id="411d" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">更新很简单:用完整的数据(训练数据加上新的训练数据)改装最优模型。然而，频繁更新对高分至关重要。</p><h1 id="53dd" class="lg lh je bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">结果</h1><p id="7d9d" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">我在这个项目上投入了大量的精力，奋斗得到了回报。我在公共排行榜上获得第三名，在私人排行榜上获得第一名。</p><figure class="la lb lc ld gt iv gh gi paragraph-image"><div class="gh gi os"><img src="../Images/1d72f3c1d9e3e740071ce1f03e7415fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*VNEpc4pSc8KEPK2mcfI8Vg.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">比赛的最终私人排行榜(已更新)</p></figure><h2 id="0531" class="nf lh je bd li ng nh dn lm ni nj dp lq km nk nl lu kq nm nn ly ku no np mc nq bi translated">经验教训</h2><p id="fb6a" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">在比赛期间，我面临了很多bug，这些bug耗费了我的时间和提交材料。bug是不可避免的，但是有注释，如果一开始就用的话对我帮助很大:</p><ol class=""><li id="02b8" class="oc od je kd b ke kf ki kj km oe kq of ku og ky oh oi oj ok bi translated">记录尽可能多的有用信息:数据框中的列(训练和测试数据中的列顺序可能不同)、数据类型(训练和测试数据框中的数据类型可能不同)、每次训练的时间、训练的剩余时间等。这将有助于理解为什么提交失败或得分低。例如，由于一个愚蠢的错误，我提交的一些模型没有更新，我没有注意到这一点。因此，我的分数远低于应有的水平。一条简单的消息<em class="nr">打印出来("型号更新！")</em>化险为夷，帮我找到了bug。</li><li id="943b" class="oc od je kd b ke ol ki om km on kq oo ku op ky oh oi oj ok bi translated">在AutoML中，对未知数据的测试是必不可少的。您可能很容易使您的解决方案过度适应公共部分，并且它可能会在看不见的数据上崩溃。这就是我的情况——我提交的第一个任务失败了。尽量在比赛开始的时候收集更多的数据。新的数据集应该是多样化的，例如，在类别和其他因素中缺少值或字符串，这可能会使您的代码崩溃。用不同的时间预算来测试它们:当你时间紧迫时，试着输出甚至很差的模型。</li><li id="9ba2" class="oc od je kd b ke ol ki om km on kq oo ku op ky oh oi oj ok bi translated">以“即插即用”的方式组织代码:管道的每个部分都不应该依赖于其他部分。例如，我想拟合线性回归而不是LightGBM，这样做容易吗？如果你的代码是组织良好的，它将是。在这次比赛中，我朝着更干净、更有条理的代码迈出了一大步。然而，有时我认为它仍然是垃圾，我看到了进步。</li><li id="75af" class="oc od je kd b ke ol ki om km on kq oo ku op ky oh oi oj ok bi translated">不要在熊猫身上使用<em class="nr">代替</em>操作，因为<a class="ae kz" href="https://github.com/pandas-dev/pandas/issues/30484" rel="noopener ugc nofollow" target="_blank">有问题</a>。只要有可能，就不要使用它。</li></ol><h1 id="4ec5" class="lg lh je bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">感谢</h1><p id="25c0" class="pw-post-body-paragraph kb kc je kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">我要感谢汽车系列赛的组织者——4个Paradigm和ChaLearn团队。他们做得很好:收集了数据，准备了提交评分引擎，编写了一个强大的基线解决方案，并回答了论坛和电子邮件中出现的问题。谢谢你的工作！</p></div></div>    
</body>
</html>