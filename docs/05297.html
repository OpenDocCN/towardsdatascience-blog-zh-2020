<html>
<head>
<title>I Built a Telegram Bot to Combat Food Wastage — Here’s How</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我做了一个电报机器人来对抗食物浪费——下面是我的方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/i-built-a-telegram-bot-to-combat-food-wastage-heres-how-293259a1bd32?source=collection_archive---------19-----------------------#2020-05-05">https://towardsdatascience.com/i-built-a-telegram-bot-to-combat-food-wastage-heres-how-293259a1bd32?source=collection_archive---------19-----------------------#2020-05-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="dd6c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 python-telegram-bot 创建电报机器人的完整 Python 指南</h2></div><p id="b1d7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">elegram 机器人现在风靡一时——从让你玩游戏、寻找朋友、寻找新机器人，甚至创造新机器人的机器人——可能性是无穷无尽的。今天，我将介绍我如何构建一个电报机器人来消除食物浪费，提供一个完整的教程，从(1) <strong class="kk iu">如何使用 BotFather 创建一个电报机器人</strong>，赋予它(2) <strong class="kk iu">提问</strong>，(3) <strong class="kk iu">接收和存储用户响应和图片</strong>，(4) <strong class="kk iu">将此<strong class="kk iu">信息发布到公共电报频道</strong>，同时(5) <strong class="kk iu">调用谷歌地图 API </strong>来显示</strong></p><p id="040e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">代码可以在我的 Github 库<a class="ae ln" href="https://github.com/liuhh02/food-waste-bot" rel="noopener ugc nofollow" target="_blank">这里</a>找到。代码进一步在 Heroku 上部署了这个机器人，你可以在这里阅读我的关于我如何部署这个机器人的教程。</p><h1 id="68eb" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz lz ka ma kc mb kd mc kf md kg me mf bi translated">食物浪费——一个荒谬的问题</h1><p id="72aa" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">根据联合国粮食及农业组织(FAO)的统计，全球每年大约有 13 亿吨的食物被浪费掉，相当于所有人类消费食物的三分之一。一些常见的罪魁祸首包括自助餐，餐馆，甚至家庭，原因包括购买了太多，甚至更荒谬的是，食物看起来不好吃。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/6b528c2e6071f6a7414b1fd3a84f1b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mooB2znLVxLkCO5q"/></div></div><p class="mx my gj gh gi mz na bd b be z dk translated">照片由<a class="ae ln" href="https://unsplash.com/@okikuy0930?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Yukiko Kanada </a>在<a class="ae ln" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1976" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，与此同时，每天有 8.2 亿人挨饿。这似乎是矛盾的——我们怎么能浪费这么多食物，而同时让世界上这么多人挨饿？这归结为剩饭剩菜和需要食物的人之间缺乏沟通。当然，有慈善组织接受食物捐赠，但是在需要食物的人和有剩菜的人之间没有直接的交流。再加上令人沮丧的错综复杂的监管程序，毫不奇怪，在食品捐赠和它们真正惠及最需要的人之间存在着巨大的时间差。</p><p id="fb43" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">考虑到这个问题，为什么不促进剩饭剩菜和需要食物的人之间的交流呢？这将有助于把那些有剩菜的人直接联系到那些需要食物的人。这样，需要食物的人可以很快收到食物，不会有任何明显的时间延误。</p><h1 id="1bc9" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz lz ka ma kc mb kd mc kf md kg me mf bi translated">电报机器人简介</h1><p id="2b3a" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">当然，这听起来不错，但是我们如何去实现它呢？这就是电报机器人和频道提供轻量级解决方案，将食品供应商与需要食品的人联系起来的地方。</p><p id="575a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">食物供应商可以首先与电报机器人聊天，提供关于食物的关键信息，如食物的位置、饮食规格等。收集完这些信息后，机器人会将它们的食物列表发布到公众可以访问的电报频道上。一旦食物被发布在频道上，有需要的人可以简单地收集食物。所有这些都可以在没有任何明显时间延迟的情况下完成——事实上，将食品邮寄给收到信息的最终用户的整个过程只需不到 10 秒钟！</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nb"><img src="../Images/ff63dadc552b2553bb1c46fd629279f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-ZiknOAvYAo0N9R7k1hPg.png"/></div></div><p class="mx my gj gh gi mz na bd b be z dk translated">食品过账流程图解</p></figure><p id="dac5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，机器人将从食物海报中询问以下问题:</p><ol class=""><li id="db3a" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">食物的位置。使用 Google Maps API，位置将被转换为相应的纬度和经度坐标，然后可以显示在地图上，使用户可以轻松地导航到该位置。</li><li id="3144" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">食物的图片。</li><li id="1bc3" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">饮食规格，即食物是否是清真的、素食的等等。</li><li id="2812" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">可供食用的食物数量。</li><li id="46af" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">食物被清除前必须收集的时间。</li></ol><p id="0590" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">食物海报将回答这些问题，机器人将把这些回答汇编成一条消息。有了这个摘要消息，在发帖人确认输入的细节是正确的之后，机器人将把信息转发到公共频道。</p><h1 id="63ad" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz lz ka ma kc mb kd mc kf md kg me mf bi translated">创建你的机器人</h1><p id="824f" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">既然我们已经了解了这个过程是如何工作的，那就让我们来看看本质的细节吧！</p><p id="6cfb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将创建一个机器人。为此，通过电报向<a class="ae ln" href="https://t.me/botfather" rel="noopener ugc nofollow" target="_blank">机器人父亲</a><strong class="kk iu">T3】发送/newbot 命令。它将提示您输入 bot 的名称，后面是用户名(必须以 bot 结尾)。您可以使用/setname 命令轻松地更改 bot 的名称，但不可能通过 BotFather 更改 bot 的用户名，因此如果您不确定，可以先用随机用户名创建一个测试 bot，一旦您测试了所有功能并确保 bot 正常工作，就用您想要的用户名创建一个新 bot。</strong></p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/443ac322ef74bb1cc507ac20017cadc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*XxKPtfrohg3GX5Sq18w-NA.png"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">与机器人父亲的第一次交流——“一个机器人统治所有人”！</p></figure><p id="fd6e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建 bot 后，BotFather 将向您发送 bot 的 API 密钥(在“使用此令牌访问 HTTP API:”行下)。把这个 API 密匙留给你自己，因为它可能被任何拥有 API 密匙的人滥用来控制你的机器人，这是你不希望发生的！你可以向机器人之父发送一堆命令来定制你的机器人，包括改变机器人的描述，它的简介图片等等，这些都是不言自明的，所以我会让你在<a class="ae ln" href="https://core.telegram.org/bots#6-botfather" rel="noopener ugc nofollow" target="_blank">官方电报文档</a>上阅读它。</p><h1 id="679f" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz lz ka ma kc mb kd mc kf md kg me mf bi translated">使用 python-telegram-bot 与机器人交互</h1><p id="ff97" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">已经创建了我们的机器人，是时候给它一些额外的功能了！由于目标是创建一个与食物海报交互的机器人，该机器人必须能够向海报发送问题，以提示所需的信息，然后在转发到公共频道之前存储这些信息。为此，我们可以使用一个非常方便的 python 包装器，<a class="ae ln" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank"> python-telegram-bot </a>。Github <a class="ae ln" href="https://github.com/python-telegram-bot/python-telegram-bot/blob/master/examples/README.md" rel="noopener ugc nofollow" target="_blank">页面</a>提供了许多使用该包装器编写的机器人示例，所以请查看该页面，看看是否有满足您的用例的示例！</p><p id="779f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将安装所需的软件包。因为我们调用 Google Maps API 来提供食物位置的地图，所以我们还将安装 googlemaps python 包。如果你不想使用谷歌地图，你可以跳过这个包的安装。</p><p id="4cdc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在终端/命令提示符下，键入以下命令来安装这两个库:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="1308" class="nw lp it ns b gy nx ny l nz oa">pip install python-telegram-bot # using version 12.7<br/>pip install googlemaps # using version 4.3.1</span></pre><p id="04c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经安装了这两个库，让我们开始研究代码吧！下面是代码(以防你想直接跳到它)，我将在下面详细介绍。</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="ob oc l"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">电报机器人的完整代码，包括调用谷歌地图 API</p></figure><p id="3724" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们导入相关的库:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="6166" class="nw lp it ns b gy nx ny l nz oa">import logging<br/>import telegram<br/>from telegram import (ReplyKeyboardMarkup, ReplyKeyboardRemove)<br/>from telegram.ext import (Updater, CommandHandler, MessageHandler,  Filters, ConversationHandler)<br/>from googlemaps import Client as GoogleMaps</span></pre><p id="88e4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们正在导入日志记录，以显示用户在终端中与机器人交互时的日志消息，以及 python-telegram-bot 下的各种模块。我们也在导入谷歌地图，在地图上显示食物的位置。</p><p id="c843" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们配置日志记录设置如下:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="78ff" class="nw lp it ns b gy nx ny l nz oa"># Enable logging<br/>logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO) <br/>logger = logging.getLogger(__name__)</span></pre><p id="89ed" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们定义六个状态，这六个状态决定了机器人将提出的问题:食物的位置、照片、饮食规格、份数、领取食物的时间，以及与海报的确认。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="a097" class="nw lp it ns b gy nx ny l nz oa">LOCATION, PHOTO, DIET, SERVINGS, TIME, CONFIRMATION = range(6)</span></pre><p id="1a0e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于确认，将有一个回复键盘，用户将能够选择两个选项:确认信息是正确的或重新开始整个过程。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/5f5278797bff150f95d15bc00898c8b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*Ty9edvg6X1zr5qmDzelFew.png"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">确认并重启按钮</p></figure><p id="a9bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们使用 python-telegram-bot 模块中的 ReplyKeyboardMarkup 模块指定了这两个选项，代码如下:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="8a88" class="nw lp it ns b gy nx ny l nz oa">reply_keyboard = [['Confirm', 'Restart']]<br/>markup = ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)</span></pre><p id="c92d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，我们指定一些变量，包括你的 Telegram bot 的 API(你从 BotFather 获得的)，以及 Google Maps 的 API。</p><p id="8011" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了获得谷歌地图应用编程接口，你需要一个谷歌云平台账户。创建帐户后(会有免费的信用点数，所以只要你不超过限额，这应该是免费的)，转到谷歌云平台<a class="ae ln" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">控制台</a>并执行以下操作:</p><ol class=""><li id="1456" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">在搜索栏中搜索<strong class="kk iu"> API &amp;服务</strong>。</li><li id="0bff" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">点击搜索栏正下方的蓝色加号按钮<strong class="kk iu">启用 API 和服务</strong>。</li><li id="6851" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">搜索<strong class="kk iu">地理编码 API </strong>并启用。</li><li id="c817" class="nc nd it kk b kl nl ko nm kr nn kv no kz np ld nh ni nj nk bi translated">在<strong class="kk iu"> API &amp;服务</strong>下，转到<strong class="kk iu">凭证</strong>并选择<strong class="kk iu">创建凭证</strong> &gt; <strong class="kk iu"> API 密钥</strong>。</li></ol><p id="dc4a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将会生成一个 API 密钥，所以只需复制这个密钥。这将是您的谷歌地图 API 令牌。再说一遍，保管好这个！地理编码 API 提供了 200 美元的免费积分，这应该足够满足您的需求了。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="f0a9" class="nw lp it ns b gy nx ny l nz oa">TOKEN = 'YOURTELEGRAMBOTTOKEN'<br/>bot = telegram.Bot(token=TOKEN) </span><span id="e1e0" class="nw lp it ns b gy oe ny l nz oa">GMAPSAPI = 'YOURGOOGLEMAPSAPITOKEN'<br/>gmaps = GoogleMaps(GMAPSAPI)</span></pre><p id="7213" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经定义了变量，让我们深入研究代码的实际部分！首先，我们定义一个函数来总结食物海报提供的信息，如下所示:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="4da2" class="nw lp it ns b gy nx ny l nz oa">def facts_to_str(user_data):<br/>    facts = list()<br/>    for key, value in user_data.items():<br/>        facts.append('{} - {}'.format(key, value))<br/>    return "\n".join(facts).join(['\n', '\n'])</span></pre><p id="50ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当这个函数被调用时，它将以 key-value 的格式返回信息(例如，饮食规范- Halal)。</p><p id="74e2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们定义当用户启动机器人时会发生什么。这是通过使用命令/start 来完成的(它的工作方式类似于您使用命令/newbot 和 BotFather 来创建您的 bot)。当海报启动 bot 时，我们希望 bot 问候用户并提示他发送食物的位置，因此我们将 start 定义如下:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="482a" class="nw lp it ns b gy nx ny l nz oa">def start(update, context):<br/>    update.message.reply_text("Hi! I am your posting assistant to help you advertise your leftover food to reduce food waste. To start, please type the location of the leftover food.")<br/>    return LOCATION</span></pre><p id="03d7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前一个函数返回 LOCATION，这是下一个函数，因为 bot 将存储用户提供的位置，以便在最后创建一个摘要。在函数<em class="of"> location </em>中，代码做了几件事:首先，它告诉机器人有一条来自用户的新消息，然后它将用户提供的信息存储在键“location”下，以便以后打印摘要时参考。接下来，记录器将记录用于调试目的的信息，以防出错。最后，机器人会回复一条信息，要求提供食物的照片。然后，函数返回 PHOTO，这是下一个函数。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="b5cb" class="nw lp it ns b gy nx ny l nz oa">def location(update, context):<br/>    user = update.message.from_user<br/>    user_data = context.user_data<br/>    category = 'Location'<br/>    text = update.message.text<br/>    user_data[category] = text<br/>    logger.info("Location of %s: %s", user.first_name, update.message.text)<br/>    update.message.reply_text('I see! Please send a photo of the leftovers, so users will know how the food looks like, or send /skip if you don\'t want to.')<br/>     return PHOTO</span></pre><p id="0140" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一个函数中，用户有两个选择:要么给食物拍照并发送给机器人，要么如果没有准备好图像就跳过。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="bda1" class="nw lp it ns b gy nx ny l nz oa">def photo(update, context):<br/>    user = update.message.from_user<br/>    photo_file = update.message.photo[-1].get_file()<br/>    photo_file.download('user_photo.jpg')<br/>    logger.info("Photo of %s: %s", user.first_name, 'user_photo.jpg')<br/>    update.message.reply_text('Great! Is the food halal? Vegetarian? Please type in the dietary specifications of the food.')<br/>     return DIET </span><span id="2fe5" class="nw lp it ns b gy oe ny l nz oa">def skip_photo(update, context):<br/>    user = update.message.from_user<br/>    logger.info("User %s did not send a photo.", user.first_name)<br/>    update.message.reply_text('Is the food halal? Vegetarian? Please type in the dietary specifications of the food.')<br/>    return DIET</span></pre><p id="9063" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样，机器人首先接收来自用户的消息，然后从用户那里获取照片文件，然后保存为 user_photo.jpg。然后，记录器记录信息，机器人用下一个关于食物饮食规格的问题进行响应。</p><p id="9444" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面几行遵循和以前一样的结构，因为机器人询问饮食规格、份数、收集食物的时间。您会注意到相同的结构:机器人首先接收来自用户的消息，然后将用户响应存储在<em class="of"> user_data </em>中，接着进行日志记录，然后机器人做出响应，提示用户下一个问题。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="04d5" class="nw lp it ns b gy nx ny l nz oa">def diet(update, context):<br/>    user = update.message.from_user<br/>    user_data = context.user_data<br/>    category = 'Dietary Specifications'<br/>    text = update.message.text<br/>    user_data[category] = text<br/>    logger.info("Dietary Specification of food: %s", update.message.text)<br/>    update.message.reply_text('How many servings are there?')<br/>    return SERVINGS </span><span id="ad60" class="nw lp it ns b gy oe ny l nz oa">def servings(update, context):<br/>    user = update.message.from_user<br/>    user_data = context.user_data<br/>    category = 'Number of Servings'<br/>    text = update.message.text<br/>    user_data[category] = text<br/>    logger.info("Number of servings: %s", update.message.text)    update.message.reply_text('What time will the food be available until?')<br/>     return TIME</span><span id="de3c" class="nw lp it ns b gy oe ny l nz oa">def time(update, context):<br/>    user = update.message.from_user<br/>    user_data = context.user_data<br/>    category = 'Time to Take Food By'<br/>    text = update.message.text<br/>    user_data[category] = text<br/>    logger.info("Time to Take Food By: %s", update.message.text) <br/>    update.message.reply_text("Thank you for providing the information! Please check the information is correct:{}".format(facts_to_str(user_data)), reply_markup=markup)<br/>    return CONFIRMATION</span></pre><p id="c022" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从海报中获得所有必要的信息后，是时候总结信息并与海报进行确认了。首先，机器人合并信息，然后使用我们在上面定义的<em class="of"> </em>函数<em class="of"> facts_to_str(用户 _ 数据)</em>发出摘要。</p><p id="9719" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果用户选择“确认”，机器人会将信息转发到公共频道。bot.send_photo 的 chat_id 参数代表频道的链接。</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="936e" class="nw lp it ns b gy nx ny l nz oa">def confirmation(update, context):<br/>    user_data = context.user_data<br/>    user = update.message.from_user<br/>    update.message.reply_text("Thank you! I will post the information on the channel now.", reply_markup=ReplyKeyboardRemove())<br/>    bot.send_photo(chat_id='@nameofchannel', photo=open('user_photo.jpg', 'rb'), caption="&lt;b&gt;Food is Available!&lt;/b&gt; Check the details below: \n {}".format(facts_to_str(user_data)) +  "\n For more information, message the poster {}".format(user.name), parse_mode=telegram.ParseMode.HTML)</span><span id="e3ae" class="nw lp it ns b gy oe ny l nz oa">    geocode_result = gmaps.geocode(user_data['Location'])<br/>    lat = geocode_result[0]['geometry']['location'] ['lat']<br/>    lng = geocode_result[0]['geometry']['location']['lng']<br/>    bot.send_location(chat_id='@nameofchannel', latitude=lat, longitude=lng)</span></pre><p id="5082" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们现在调用谷歌地图来精确定位海报提供的确切位置。当用户回答关于位置的第一个问题时，位置已经存储在 user_data['Location']中，所以现在我们将使用 google maps 提取位置的纬度和经度。有了这些信息，机器人将位置和地图一起发送到由<em class="of"> @nameofchannel </em>指定的频道。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div class="gh gi og"><img src="../Images/223268c3fea109ff74c8acb32ee9e874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*K1dhdMe5-7yvysjQzdPnjQ.png"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">bot 在公共频道上发布的消息；自助餐图片摘自<a class="ae ln" href="https://myfave.com/johor-bahru/v8-hotel-johor-bahru-v8-hotel-johor-bahru-dinner-buffet-for-1-adult-64925" rel="noopener ugc nofollow" target="_blank">https://my fave . com/johor-Bahru/V8-hotel-johor-Bahru-V8-hotel-johor-Bahru-晚餐-自助餐-1 人份-成人-64925 </a></p></figure><p id="bb31" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是一些帮助功能，以防用户取消与机器人的对话或出现错误:</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="e656" class="nw lp it ns b gy nx ny l nz oa">def cancel(update, context):<br/>    user = update.message.from_user<br/>    logger.info("User %s canceled the conversation.", user.first_name)<br/>    update.message.reply_text('Bye! Hope to see you again next time.', reply_markup=ReplyKeyboardRemove())<br/>     return ConversationHandler.END</span><span id="9854" class="nw lp it ns b gy oe ny l nz oa">def error(update, context):<br/>    """Log Errors caused by Updates."""<br/>    logger.warning('Update "%s" caused error "%s"', update, context.error)</span></pre><p id="04fb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们到了代码的最后一段！这里，代码定义了机器人应该为六种状态中的每一种状态做什么。最后，我们开始投票，这基本上使我们能够从海报中获取信息。python-telegram-bot 的<a class="ae ln" href="https://github.com/python-telegram-bot/python-telegram-bot/wiki/Introduction-to-the-API" rel="noopener ugc nofollow" target="_blank"> Github wiki </a>在解释这里的代码方面做得更好，所以如果你不确定每一行是做什么的，一定要检查一下！</p><pre class="mm mn mo mp gt nr ns nt nu aw nv bi"><span id="8508" class="nw lp it ns b gy nx ny l nz oa">def main():<br/>    updater = Updater(TOKEN, use_context=True)<br/>     # Get the dispatcher to register handlers<br/>    dp = updater.dispatcher<br/>     # Add conversation handler with the states LOCATION, PHOTO, DIET, SERVINGS, TIME and DONE<br/>    conv_handler = ConversationHandler(entry_points=[CommandHandler('start', start)],states={            <br/>LOCATION: [MessageHandler(Filters.text, location)],             PHOTO: [MessageHandler(Filters.photo, photo),                             CommandHandler('skip', skip_photo)],             <br/>DIET: [MessageHandler(Filters.text, location)],             <br/>SERVINGS: [MessageHandler(Filters.text, bio)],             <br/>TIME: [MessageHandler(Filters.text, time)],             <br/>CONFIRMATION: [MessageHandler(Filters.regex('^Confirm$'), done),            MessageHandler(Filters.regex('^Restart$'), start)]        },         fallbacks=[CommandHandler('cancel', cancel), CommandHandler('start', start)]    )<br/>    dp.add_handler(conv_handler)     # log all errors<br/>    dp.add_error_handler(error)</span><span id="f10a" class="nw lp it ns b gy oe ny l nz oa">    # start the bot<br/>    updater.start_polling()</span><span id="7116" class="nw lp it ns b gy oe ny l nz oa">    # Run the bot until you press Ctrl-C  <br/>    updater.idle()  </span><span id="dee9" class="nw lp it ns b gy oe ny l nz oa">if __name__ == '__main__':<br/>    main()</span></pre><p id="9475" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要启动您的 bot，只需进入终端/命令提示符并执行 python 文件。执行完文件后，进入 bot 并键入/start。你的机器人应该响应并问你上面编码的问题！当您响应时，您还应该看到出现以下日志:</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oh"><img src="../Images/6f26ec60a6974a2a5829df7bf680b51a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFbHG9PCcCG6IjJj7gqbFg.png"/></div></div><p class="mx my gj gh gi mz na bd b be z dk translated">记录在命令行中看到的张贴者的响应</p></figure><p id="ab5d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">原来如此！如果你想看看我创建的机器人，你可以在<a class="ae ln" href="https://t.me/foodrescuerbot" rel="noopener ugc nofollow" target="_blank"> @foodrescuerbot </a>找到它。公共频道的链接是 https://t.me/foodrescuers 的<a class="ae ln" href="https://t.me/foodrescuers" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="1317" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">试试这个！我希望你能从中得到乐趣，并告诉我进展如何！如果你需要任何澄清，请随时提问。让我们都三思而后行，我们是否可以在购买之前吃完食物，并努力减少食物浪费~</p><p id="6392" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你正在寻找免费的<strong class="kk iu"> <em class="of">部署机器人</em> </strong>，请点击<a class="ae ln" rel="noopener" target="_blank" href="/how-to-deploy-a-telegram-bot-using-heroku-for-free-9436f89575d2">这里的</a>获取一个关于如何在本地成功运行机器人后在 Heroku 上部署机器人的教程。</p></div></div>    
</body>
</html>