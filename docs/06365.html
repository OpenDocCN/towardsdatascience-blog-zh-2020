<html>
<head>
<title>Aren’t all your experiments sacred? — Managing your machine learning experiments using Sacred</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你所有的实验不都是神圣的吗？—使用Sacred管理您的机器学习实验</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/arent-all-your-experiments-sacred-managing-your-machine-learning-experiments-4f8a66be65ae?source=collection_archive---------40-----------------------#2020-05-21">https://towardsdatascience.com/arent-all-your-experiments-sacred-managing-your-machine-learning-experiments-4f8a66be65ae?source=collection_archive---------40-----------------------#2020-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f860383dfe59a939665746ba15834e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxCW1HBJoiZH77rkPyxJXQ.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图片由Luka从<a class="ae kf" href="https://www.pexels.com/photo/analytics-blur-close-up-commerce-590020/" rel="noopener ugc nofollow" target="_blank"> Pexels </a></p></figure><p id="e822" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能已经花了无数个小时来调整你的超参数，观察你的机器学习模型的性能指标和运行时间，当你想回到你以前的迭代时，你就是无法获得超参数或其他一些正确的配置来重新创建结果。作为一名研究人员，重要的是记录这些超参数和观察值，以便在需要时再次重现相同的结果。手动将它们记录在某个地方既乏味又容易出错，这会使您的进度落后几天。此外，很难理解你的日志，也很难长时间地重现实验。</p><p id="d87d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设你正在做一个简单的时尚MNIST分类项目，下面是你可能想出的用于训练和评估的代码:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="1423" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该代码在每个时期具有三个配置参数<code class="fe lk ll lm ln b">batch_size</code>、<code class="fe lk ll lm ln b">num_epochs</code>和<code class="fe lk ll lm ln b">learning_rate</code>以及四个性能度量<code class="fe lk ll lm ln b">train loss</code>、<code class="fe lk ll lm ln b">train accuracy</code>、<code class="fe lk ll lm ln b">val loss</code>和<code class="fe lk ll lm ln b">val accuracy</code>。此外，您可能希望跟踪<code class="fe lk ll lm ln b">test accuracy</code>和<code class="fe lk ll lm ln b">run-time</code>。为每个实验手动地做它是不令人兴奋的，并且你甚至可能有更多的度量想要为每个实验跟踪。</p><p id="1672" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是神圣在画面中出现的地方。</p><blockquote class="lo lp lq"><p id="3141" class="kg kh lr ki b kj kk kl km kn ko kp kq ls ks kt ku lt kw kx ky lu la lb lc ld im bi translated">每个实验都是神圣的<br/>每个实验都是伟大的<br/>如果一个实验被浪费了<br/>上帝会非常生气</p></blockquote><p id="7058" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是《神圣的:D》的标题</p><h2 id="8b74" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">什么是神圣？</h2><p id="94c8" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated"><a class="ae kf" href="https://github.com/IDSIA/sacred" rel="noopener ugc nofollow" target="_blank">神圣</a>是由Instituto Dalle Molle di Studi sull ' intelligenza artificial e(id sia)开发的工具。它可以帮助您配置、组织、记录和重现您的实验。它旨在完成您在实际实验中需要做的所有繁琐的日常工作，以便:</p><ul class=""><li id="7253" class="mt mu it ki b kj kk kn ko kr mv kv mw kz mx ld my mz na nb bi translated">记录你实验的所有参数</li><li id="c558" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">轻松运行不同设置的实验</li><li id="f678" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">在数据库中保存单次运行的配置</li><li id="848f" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">重现您的结果</li></ul><h2 id="a7f0" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">神圣是如何工作的？</h2><p id="e13f" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">神圣连接到一个MongoDB，并把所有关于实验的信息放入一个名为experiments的集合中的一个文档中。<code class="fe lk ll lm ln b">MongoObserver</code>是神圣附带的默认观察者之一。神圣试图捕捉所有的输出，并将信息传送给观察者。</p><p id="eeac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe lk ll lm ln b">Experiment</code>是神圣框架的中心类，收集大量关于运行的信息，像:</p><ul class=""><li id="682f" class="mt mu it ki b kj kk kn ko kr mv kv mw kz mx ld my mz na nb bi translated">启动时间和停止时间</li><li id="b373" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">使用的配置</li><li id="9efb" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">结果或发生的任何错误</li><li id="3569" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">运行它的机器的基本信息</li><li id="4824" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">实验所依赖的包及其版本</li><li id="902a" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">所有导入的本地源文件</li><li id="d981" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">用ex.open_resource打开的文件</li><li id="bb8c" class="mt mu it ki b kj nc kn nd kr ne kv nf kz ng ld my mz na nb bi translated">使用ex.add_artifact添加的文件</li></ul><h2 id="8089" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">安装神圣的</h2><p id="98c0" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">你可以像这样直接从pypi获得神圣:</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="016b" class="lv lw it ln b gy nl nm l nn no">pip install sacred</span></pre><p id="c4cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要安装pymango，因为我们需要连接一个MongoDB</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="d831" class="lv lw it ln b gy nl nm l nn no">pip install pymango</span></pre><h2 id="f69e" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">修改时尚MNIST分类脚本以使用神圣</h2><p id="e733" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">下面是更早的脚本修改使用神圣。</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="b51f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们首先创建一个名为<code class="fe lk ll lm ln b">fashion_mnist</code>的实验实例<code class="fe lk ll lm ln b">ex</code>，并将一个观察者链接到它。<code class="fe lk ll lm ln b">MongoObserver</code>是圣物自带的默认观察者。你甚至可以使用其他可用的<a class="ae kf" href="https://readthedocs.org/projects/sacred/downloads/pdf/latest/#section.1.6" rel="noopener ugc nofollow" target="_blank">观察者</a></p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="6738" class="lv lw it ln b gy nl nm l nn no">ex = Experiment("fashion_mnist")<br/>ex.observers.append(MongoObserver())</span></pre><p id="56b6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们在用<code class="fe lk ll lm ln b">@ex.config</code>修饰的函数<code class="fe lk ll lm ln b">cfg()</code>中定义配置变量。这会创建一个配置范围，然后收集函数局部范围内定义的所有变量，并成为实验的配置条目。在我们的示例中，我们将<code class="fe lk ll lm ln b">batch_size</code>、<code class="fe lk ll lm ln b">num_epochs</code>和<code class="fe lk ll lm ln b">learning_rate</code>视为配置变量。</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="2cf8" class="lv lw it ln b gy nl nm l nn no">@ex.config<br/>def cfg():<br/>    batch_size = 64<br/>    num_epochs = 10<br/>    learning_rate = 0.01</span></pre><p id="f25d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要将脚本的模型训练和评估部分放在一个用<code class="fe lk ll lm ln b">@ex.automain</code>修饰的函数内。这告诉实验文件在脚本运行时需要执行什么。这个函数将所有的配置变量和一个<code class="fe lk ll lm ln b">_run</code>对象作为参数。<code class="fe lk ll lm ln b">_run</code>对象表示并管理实验的一次运行。它存储与实验相关的所有信息，然后将这些信息写入观察器。如果您想了解更多关于<code class="fe lk ll lm ln b">_run</code>对象的信息，请参考<a class="ae kf" href="https://sacred.readthedocs.io/en/stable/apidoc.html?highlight=_run#the-run-object" rel="noopener ugc nofollow" target="_blank">和</a>。</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="3672" class="lv lw it ln b gy nl nm l nn no">@ex.automain<br/>def run(_run, batch_size, num_epochs, learning_rate):<br/>    # importing the dataset<br/>    fashion_mnist = keras.datasets.fashion_mnist<br/>    <br/>    (train_images, train_labels), (test_images, test_labels) = <br/>         fashion_mnist.load_data()</span><span id="1c1f" class="lv lw it ln b gy np nm l nn no">    # normalizing the images to 0 and 1<br/>    train_images = train_images / 255.0<br/>    test_images = test_images / 255.0</span><span id="72c6" class="lv lw it ln b gy np nm l nn no">    # setting up the model<br/>    model = keras.Sequential([<br/>        keras.layers.Flatten(input_shape=(28, 28)),<br/>        keras.layers.Dense(128, activation='relu'),<br/>        keras.layers.Dense(10, activation='softmax')<br/>    ])</span><span id="6cff" class="lv lw it ln b gy np nm l nn no">    # compiling the model<br/>    model.compile(optimizer=keras.optimizers.Adam(<br/>        learning_rate=learning_rate),<br/>        loss=keras.losses.SparseCategoricalCrossentropy(<br/>                 from_logits=True<br/>             ),<br/>        metrics=['accuracy'])</span><span id="bdde" class="lv lw it ln b gy np nm l nn no">    # training the model<br/>    model.fit(train_images, <br/>             train_labels,<br/>             batch_size=batch_size,<br/>             epochs=num_epochs,<br/>             validation_data=(test_images, test_labels),<br/>             callbacks=[MetricsLoggerCallback(_run)],<br/>             verbose=2)<br/> <br/>    # evaluating the model<br/>    test_loss, test_acc = model.evaluate(<br/>                              test_images, <br/>                              test_labels, <br/>                              verbose=2)</span><span id="84e0" class="lv lw it ln b gy np nm l nn no">    print('Test loss:', test_loss, ' and Test accuracy:', test_acc)</span><span id="1048" class="lv lw it ln b gy np nm l nn no">    return test_acc</span></pre><p id="27f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还希望记录度量标准，如每个时期的训练和验证的损失和准确性。为此，我们定义了一个名为<code class="fe lk ll lm ln b">MetricsLoggerCallback</code>的Keras自定义回调类，它有<code class="fe lk ll lm ln b">on_epoch_end</code>方法。回调类将<code class="fe lk ll lm ln b">_run</code>对象作为参数。<code class="fe lk ll lm ln b">_run</code>对象有一个<code class="fe lk ll lm ln b"><a class="ae kf" href="https://sacred.readthedocs.io/en/stable/apidoc.html?highlight=_run#sacred.run.Run.log_scalar" rel="noopener ugc nofollow" target="_blank">log_scalar</a></code>方法，可以用来捕获指标。</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="3408" class="lv lw it ln b gy nl nm l nn no">class MetricsLoggerCallback(keras.callbacks.Callback):<br/>    def __init__(self, _run):<br/>        super().__init__()<br/>        self._run = _run <br/>    <br/>    def on_epoch_end(self, _, logs):<br/>        self._run.log_scalar("training.loss", logs.get('loss'))<br/>        self._run.log_scalar("training.acc", logs.get('accuracy'))<br/>        self._run.log_scalar("validation.loss",<br/>                             logs.get('val_loss'))<br/>        self._run.log_scalar("validation.acc",<br/>                             logs.get('val_accuracy'))</span></pre><p id="795a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">度量和日志也可以用一个用<code class="fe lk ll lm ln b">@ex.capture</code> decorator修饰的函数以不同的方式捕获，如这个<a class="ae kf" href="https://sacred.readthedocs.io/en/stable/logging.html?highlight=ex.capture#integrate-logging-into-your-experiment" rel="noopener ugc nofollow" target="_blank">示例</a>所示。</p><p id="bfe7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的<code class="fe lk ll lm ln b">@ex.automain</code>修饰函数也返回<code class="fe lk ll lm ln b">test_acc</code>值。该值存储在<code class="fe lk ll lm ln b">_run</code>对象的<code class="fe lk ll lm ln b"><a class="ae kf" href="https://sacred.readthedocs.io/en/stable/apidoc.html?highlight=result#sacred.run.Run.result" rel="noopener ugc nofollow" target="_blank">result</a></code>属性中。它代表了我们实验的主要结果。</p><h2 id="571a" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">运行实验</h2><p id="f2ba" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">为了运行实验，您需要在运行脚本时链接一个观察器，如下所示:</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="0447" class="lv lw it ln b gy nl nm l nn no">python fashion_mnist_sacred.py -m sacred_fashion_mnist</span></pre><p id="9c53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行脚本时，您还可以从cli修改配置变量，如下所示:</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="c20f" class="lv lw it ln b gy nl nm l nn no">python fashion_mnist_sacred.py with learning_rate=0.003 num_epochs= 20 -m sacred_fashion_mnist</span></pre><p id="bd2d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦运行完成，你可以使用Sacredboard或任何其他由Sacred支持的<a class="ae kf" href="https://github.com/IDSIA/sacred#frontends" rel="noopener ugc nofollow" target="_blank">前端</a>来查看实验日志。</p><h2 id="27b6" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">神圣纸板</h2><p id="6c0e" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated"><a class="ae kf" href="https://github.com/chovanecm/sacredboard" rel="noopener ugc nofollow" target="_blank"> SacredBoard </a>连接到Sacred使用的MongoDB数据库，显示实验列表、它们的状态、Sacred的配置和运行程序的标准输出。</p><p id="b102" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以用pypi安装它:</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="6bc3" class="lv lw it ln b gy nl nm l nn no">pip install sacredboard</span></pre><p id="3e3f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在运行它时，我们需要将它与我们的观察者连接起来:</p><pre class="le lf lg lh gt nh ln ni nj aw nk bi"><span id="586b" class="lv lw it ln b gy nl nm l nn no">sacredboard -m <!-- -->sacred_fashion_mnist</span></pre><p id="81ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">启动后，您可能会看到所有实验的详细信息，如下图所示:</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/3a54e1bca4dc8cfa5fd535b123b3869a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZB5hU-mS3VvjqnTM5Dp5iQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">配置详细信息</p></figure><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/065c4450c3e59803414ee8df1364df79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HfxJZqJtl9JlmTmKu_s12w.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">捕获的日志</p></figure><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/d2e4d70f49e73c4baa737bf93d56a551.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rHvLD5GVGaX99MKZeuODeg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">结果(即我们的test_acc)</p></figure><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/e5ec2dc3d237b17a89390ee9f953b5ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dU0Rr3V1bodicW1E0fEIYg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">进行实验的主机信息</p></figure><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/369ea0988824b56c2189f6bd780b87e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kqWMC-W8r-cHPJGuHxsI5w.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">训练和验证损失</p></figure><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/33988a43531ab76cd6e90a10ed045762.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eg7-QIZNFfdpI57QRYTTow.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">训练和验证准确性</p></figure><h2 id="fc74" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">从这里去哪里？</h2><p id="8f9a" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这只是让你的生活变得简单的一瞥。它有大量的其他功能，更多的功能仍在添加。如果你想进一步探索，他们的<a class="ae kf" href="https://sacred.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>非常详细。</p></div></div>    
</body>
</html>