<html>
<head>
<title>Web Scraping Yahoo Finance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网页抓取雅虎财经</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-yahoo-finance-477fe3daa852?source=collection_archive---------5-----------------------#2020-02-01">https://towardsdatascience.com/web-scraping-yahoo-finance-477fe3daa852?source=collection_archive---------5-----------------------#2020-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="566a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从任何公开交易的公司提取财务报表和股票数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b5ba77a951735298c96f5027700186b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-bJhdnax_2NjvHq1RCz5w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·斯皮斯克在<a class="ae ky" href="https://unsplash.com/s/photos/finance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b7eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">这个博客的代码可以在我的</em> <a class="ae ky" href="https://github.com/rmacaraeg/yahoo_finance" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> GitHub </em> </a> <em class="lv">上找到。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="b3d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi md translated">在商界，了解一家公司的财务状况很重要。查看财务报表是了解一家公司经营状况的好方法。</p><p id="5851" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇博客中，我将用 Python 从雅虎财经的数据库中提取任何公司的财务报表。因为 Yahoo Finance 使用 JavaScript，所以我们结合使用了 BeautifulSoup 和 Selenium</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="524f" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">导入库</h1><p id="e776" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">让我们从必要的库开始:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="5637" class="no mn it nk b gy np nq l nr ns">import pandas as pd<br/>from bs4 import BeautifulSoup<br/>import re<br/>from selenium import webdriver<br/>import chromedriver_binary<br/>import string</span><span id="c4bc" class="no mn it nk b gy nt nq l nr ns">pd.options.display.float_format = '{:.0f}'.format</span></pre><h1 id="252d" class="mm mn it bd mo mp nu mr ms mt nv mv mw jz nw ka my kc nx kd na kf ny kg nc nd bi translated">设置并运行驱动程序</h1><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="16d9" class="no mn it nk b gy np nq l nr ns">is_link = '<a class="ae ky" href="https://finance.yahoo.com/quote/AAPL/financials?p=AAPL'" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/AAPL/financials?p=AAPL'</a></span><span id="bf3a" class="no mn it nk b gy nt nq l nr ns">driver = webdriver.Chrome()<br/>driver.get(is_link)<br/>html = driver.execute_script('return document.body.innerHTML;')<br/>soup = BeautifulSoup(html,'lxml')</span></pre><p id="aa1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我更喜欢使用 Chrome 作为我的网络浏览器，但也可以随意使用你最熟悉的浏览器(Firefox、Safari 等)。).我也使用苹果公司作为我的示例公司，但是您可以更改链接中的 AAPL 股票代码到另一家公司的股票代码来更改数据。</p><p id="d4c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述代码将在虚拟浏览器中打开页面，并提取网站正文中的所有数据。由于 Yahoo Finance 是在 JavaScript 上运行的，所以通过这种方法运行代码会提取所有数据并保存，就像它是一个静态网站一样。这对于拉动股价很重要，因为这些是网页上的动态项目，可以定期刷新/更新。</p><p id="5ddd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了提取股票数据，我们从获取股票价格的位置开始。通过将鼠标悬停在股票价格上，我们可以使用 Inspect 工具找到股票价格的确切语法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/9e6c2ed500bab92c81316e59ecec58dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hcrgbu8QBU9cJs1XmBY6Vg.png"/></div></div></figure><p id="989c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这些信息转移到 Python 中，代码将如下所示:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="ef48" class="no mn it nk b gy np nq l nr ns">close_price = [entry.text for entry in soup.find_all('span', {'class':'Trsdu(0.3s) Fw(b) Fz(36px) Mb(-4px) D(ib)'})]</span></pre><p id="41a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码在所有 HTML 代码中搜索“span”标记，并查找与输入的属性相匹配的 class 属性。幸运的是，这只拉了一个数字，即收盘时的股价。</p><p id="ee0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了这个，我们可以继续看财务报表了。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6e3f" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">提取财务报表数据</h1><p id="22bb" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">继续抓取，我们搜索页面以找到所有的 div 容器，并深入一点以找到我们想要使用的特性。我发现财务数据的每一行都存储在一个 div 容器中，该容器有一个公共的 class 属性<strong class="lb iu"> 'D(tbr)' </strong>。在下面的例子中，class 属性中有额外的数据，但是只要第一部分与我们要搜索的内容匹配，它就会提取这些数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/9ba033994ae6b513868f541ffabb71c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*piDWB2ytyUIUoBiwbS3dDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">财务报表上的每一行都存储在一个 div 中</p></figure><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="60db" class="no mn it nk b gy np nq l nr ns">features = soup.find_all('div', class_='D(tbr)')</span></pre><p id="d0cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将拉出很多看起来杂乱的数据，让我困惑了一段时间。在深入研究提取的数据后，我使用 find 函数来查看我想要的每行数据在哪里。经过大量的试验和错误，我能够生成只提取财务数据的代码:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="ee50" class="no mn it nk b gy np nq l nr ns">headers = []<br/>temp_list = []<br/>label_list = []<br/>final = []<br/>index = 0</span><span id="bda5" class="no mn it nk b gy nt nq l nr ns">#create headers<br/>for item in features[0].find_all('div', class_='D(ib)'):<br/>    headers.append(item.text)</span><span id="bd6e" class="no mn it nk b gy nt nq l nr ns">#statement contents<br/>while index &lt;= len(features)-1:<br/>    #filter for each line of the statement<br/>    temp = features[index].find_all('div', class_='D(tbc)')<br/>    for line in temp:<br/>        #each item adding to a temporary list<br/>        temp_list.append(line.text)<br/>    #temp_list added to final list<br/>    final.append(temp_list)<br/>    #clear temp_list<br/>    temp_list = []<br/>    index+=1</span><span id="b1ff" class="no mn it nk b gy nt nq l nr ns">df = pd.DataFrame(final[1:])<br/>df.columns = headers</span></pre><p id="4bfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">头与数据的其余部分是分开的，因为当把所有数据放在一起时会引起一些问题。在为财务报表中的数据创建一个标题列表和多个列表后，它将所有内容组合在一起生成一个副本！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/0b7e985ba8a8890ac237ace7b7f93840.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*buHuGF-5EZHvIK2lz-oNQA.png"/></div></div></figure><p id="e2cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它看起来就像苹果的损益表(没有格式化)，但尽管看起来很完整，下一个问题是页面上的所有数字都保存为字符串。如果我们想对它做任何未来的计算，我们必须把它们都变成整数:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="da06" class="no mn it nk b gy np nq l nr ns">#function to make all values numerical<br/>def convert_to_numeric(column):</span><span id="8827" class="no mn it nk b gy nt nq l nr ns">    first_col = [i.replace(',','') for i in column]<br/>    second_col = [i.replace('-','') for i in first_col]<br/>    final_col = pd.to_numeric(second_col)<br/>    <br/>    return final_col</span></pre><p id="840c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过快速 for 循环，我们可以将所有数字字符串转换为整数:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="2e0d" class="no mn it nk b gy np nq l nr ns">for column in headers[1:]:<br/>    <br/>    df[column] = convert_to_numeric(df[column])</span><span id="3831" class="no mn it nk b gy nt nq l nr ns">final_df = df.fillna('-')</span></pre><p id="17db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这会将所有带编号的字符串转换为实际数字，对于所有 nan，它会被一个破折号替换。</p><p id="fbcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终产品看起来非常好，现在可以用于计算！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/08570d0ccc53ee6f239fa962e9982e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PjBrKUg2oPKy_0t_73rgrA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">最终损益表</p></figure><p id="b637" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这只是从苹果公司提取损益表，但如果你在资产负债表或现金流量表上使用雅虎金融的链接，代码应该会提取所有细节，并像上面一样将报表放在一起。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="428e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我确信有很多额外的工作可以做，以清理这一点，我很乐意在不久的将来使它看起来更像一个官方声明。在继续这方面的工作的同时，我想对数据进行一些深入研究，以找到基本的财务比率，并检查公司估值、投资分析以及我可以从这些数据中挖掘出的其他趋势/发现。敬请期待！</p><p id="7f89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这段代码有所帮助，如果你有任何反馈或建议，我很乐意听到！</p></div></div>    
</body>
</html>