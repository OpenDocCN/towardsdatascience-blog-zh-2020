<html>
<head>
<title>Building a Deep Learning Model API for Tagging Trout Species</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建用于标记鳟鱼种类的深度学习模型 API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-a-deep-learning-api-for-tagging-trout-species-bff1b1f902a3?source=collection_archive---------55-----------------------#2020-05-05">https://towardsdatascience.com/deploying-a-deep-learning-api-for-tagging-trout-species-bff1b1f902a3?source=collection_archive---------55-----------------------#2020-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eed1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个用于识别鳟鱼种类的全栈深度学习研究项目&amp;更多</h2></div><p id="b7ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">本博客参考了正在进行的</em> <a class="ae lc" href="http://www.aqua-vision-research.com" rel="noopener ugc nofollow" target="_blank"> <em class="lb">水视觉深度学习研究项目</em> </a>的工作</p><p id="a433" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我最近在蒙大拿迷上了干蝇钓鱼。这是一项技术运动，我还不是很好(目前为止！)但是，在河上航行是一种享受，每次航行都能学到更多东西。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/95a970b4ce77cf07b1d382fb43242a62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vkf2PR6knHTMg-YFGwTd9w.jpeg"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">蒙大拿州洛克克里克</p></figure><p id="7233" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我出去钓鳟鱼时，我注意到的一件事是，我对不同种类的鳟鱼知之甚少。当我钓到鳟鱼时(这种情况仍然不常见)，我发现自己在谷歌上搜索照片，并将它们与我钓到的鱼进行比较。我几乎无法区分不同的物种。这让我想到，也许有一种方法可以用计算机视觉深度学习来程序化地识别鳟鱼种类。我问了几个朋友，他们是专业的钓鱼向导和铁杆业余爱好者，因为我认为图像识别可能会有所帮助，他们是这样说的:</p><p id="0d02" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">鳟鱼有大约 30 种，所以很难区分它们中的一些</p><p id="1016" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">“这对于所有的杂交鳟鱼物种来说都是非常有趣的，比如切弓鳟”</strong> <em class="lb">(切弓鳟是割喉鳟和虹鳟的杂交品种)</em></p><p id="a8aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我开始提出以下问题:</p><ol class=""><li id="0e4d" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated"><em class="lb">能否建立一个准确的深度学习计算机视觉模型，从图像中识别鳟鱼种类？</em></li><li id="cdd1" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated"><em class="lb">我能否构建一个 web 应用、REST API 和移动应用，作为深度学习模型的支持基础设施？</em></li><li id="a65b" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated"><em class="lb">我是否可以建立一个开源的 trout 照片收集库，以鼓励进一步的深度学习模型开发、图像收集/标记和 trout 研究？</em></li></ol><h1 id="d97e" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">数据收集和机器学习管道</h1><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi mz"><img src="../Images/db6314828b046cc67df5e6fb34460281.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33srLaYvnTzF15l_AE1aqg.png"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">用于构建<a class="ae lc" href="http://www.aqua-vision-research.com" rel="noopener ugc nofollow" target="_blank"> <em class="na"> Aqua Vision 深度学习</em> </a> <em class="na">、深度学习应用和 API 的完整数据管道</em></p></figure><h2 id="cbeb" class="nb mi iq bd mj nc nd dn mn ne nf dp mr ko ng nh mt ks ni nj mv kw nk nl mx nm bi translated">数据</h2><p id="6df5" class="pw-post-body-paragraph kf kg iq kh b ki nn jr kk kl no ju kn ko np kq kr ks nq ku kv kw nr ky kz la ij bi translated">对于鳟鱼图像(更不用说任何其他鱼类)没有一个全面的标记数据集，所以我从头开始建立了自己的 500+图像数据集。我用下面列出的几种不同的方法收集图像。</p><p id="1b0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">数据来源:</strong></p><ul class=""><li id="1e61" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ns lz ma mb bi translated">谷歌图片搜索:<a class="ae lc" href="https://github.com/fastai/course-v3/blob/master/nbs/dl1/lesson2-download.ipynb" rel="noopener ugc nofollow" target="_blank">在控制台中运行 Javascript 命令</a>来抓取图片和下载文件</li><li id="fbfc" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ns lz ma mb bi translated">hashtag<a class="ae lc" href="https://github.com/rarcega/instagram-scraper" rel="noopener ugc nofollow" target="_blank">insta gram Scraper</a>的命令行工具(即<em class="lb"> #browntrout </em>，<em class="lb"> #rainbowtrout </em>)</li><li id="678c" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ns lz ma mb bi translated">从钓鱼博客和研究机构下载照片</li></ul><p id="97ca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">收集完图像后，我手动检查了所有的照片，以确保图像与它们各自的鳟鱼种类标签相匹配，并删除了任何不属于它们的杂项图像(捕鱼设备、河流、钓具箱、错误标记的鱼种等)。数据收集和清理阶段大约需要三周时间。现在，我拥有了 500 多张跨越少数鳟鱼物种的图像，我有了一个初始图像数据集，可以开始构建一个深度学习鳟鱼识别模型。</p><h2 id="cbe7" class="nb mi iq bd mj nc nd dn mn ne nf dp mr ko ng nh mt ks ni nj mv kw nk nl mx nm bi translated"><strong class="ak">构建深度学习模型</strong></h2><p id="0051" class="pw-post-body-paragraph kf kg iq kh b ki nn jr kk kl no ju kn ko np kq kr ks nq ku kv kw nr ky kz la ij bi translated">Fastai 深度学习库有一些非常好的内置工具，可以从谷歌图像搜索中抓取图像，然后将图像文件加载到一个<code class="fe nt nu nv nw b">ImageDataBunch</code>对象中。然后，<code class="fe nt nu nv nw b">ImageDatabunch</code>可以应用数据扩充转换器，设置图像像素分辨率的大小，加载迁移学习并将数据分成训练、验证和测试集。</p><p id="66fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于数据扩充，我用默认设置保持它非常简单，但我确实随机水平翻转图像，以帮助标准化鱼面向每个方向的图像。</p><div class="le lf lg lh gt ab cb"><figure class="nx li ny nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><img src="../Images/007598826cea1b8b5fd16e146f441d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*S0oFQIhXSQI7UVRizSj_wQ.png"/></div></figure><figure class="nx li ny nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><img src="../Images/c627965b9ce9811703742a2dac4f6ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*kntBPyMPYcEJS5y6Z0ZqfQ.png"/></div><p class="lp lq gj gh gi lr ls bd b be z dk od di oe of translated">数据扩充:棕鳟鱼的水平翻转示例</p></figure></div><p id="9034" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据增强真的很好，因为它本质上有助于规范化现有的数据集，以训练更多的例子，增强的图像看起来都很不同，但我们不必做任何额外的手动标记，所以它们就像免费的额外数据。我发现，试验数据扩充参数和数据集的领域专业知识确实是最大限度地扩充数据的方法。</p><p id="7d0d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我利用迁移学习，从 ImageNet 预加载模型权重，而不是从头开始初始化深度学习模型权重。ImageNet 是一个数据集，包含数百万张带有标签的高分辨率图像，大致属于 22k 个类别。这些图片是从互联网上收集的，并由人们使用众包工具进行标记。迁移学习是一种很好的方式，可以利用之前训练的模型并降低计算成本，然后根据特定领域的数据进行微调，以执行特定领域的任务。</p><p id="651a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后将<code class="fe nt nu nv nw b">ImageDataBunch</code>与神经网络架构和损失函数一起加载到<code class="fe nt nu nv nw b">Learner</code>对象中，以训练深度学习模型。</p><p id="6d87" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">learn = cnn_learner(ImageDataBunch, models.resnet.34, metrics=error_rate)</code></p><p id="ebac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提高模型性能的一个小技巧是从较小的图像尺寸(224)开始训练，然后将这个拟合的模型在较大的图像尺寸(352)上进行一些拟合。这在几乎所有情况下都有助于提高性能。</p><p id="0b6b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在 70%的图像上训练模型，并保留剩余的 30%用于测试。我喜欢使用<a class="ae lc" href="https://www.paperspace.com" rel="noopener ugc nofollow" target="_blank"> Paperspace </a>来训练深度学习模型，因为他们有免费的 GPU 支持的 Jupyter 笔记本，非常容易设置和加载到深度学习库中。</p><p id="aaa0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在通过数据(历元)的几次运行将数据拟合到更深的像素分辨率之后，该模型在测试集数据上达到 96%分类准确度的峰值。这已经足够好了，可以作为 web-app 和 API 的第一个深度学习鳟鱼标识符版本。</p><h2 id="1969" class="nb mi iq bd mj nc nd dn mn ne nf dp mr ko ng nh mt ks ni nj mv kw nk nl mx nm bi translated">将深度学习模型部署为 API 和 Web 应用程序</h2><p id="d100" class="pw-post-body-paragraph kf kg iq kh b ki nn jr kk kl no ju kn ko np kq kr ks nq ku kv kw nr ky kz la ij bi translated">我将训练好的深度学习模型导出，用于生产环境中进行预测。我将模型包装在 Python 的 web 框架 Flask 中，通过 web 应用程序和 REST API 进行预测。支持这个 Aqua Vision 深度学习研究项目的 web-app 和 API 文档可以在<a class="ae lc" href="http://www.aqua-vision-research.com" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="f703" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> Rest API </strong></p><p id="c0dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目前有两个 API 端点可用:一个用于获取深度学习模型当前支持的类(物种)，另一个通过发布图像文件进行物种预测。您可以通过从命令行执行以下 cURL 命令来测试 API。</p><p id="463d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">目前支持的类(种):</strong></p><p id="875e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在端点查看模型当前支持的鳟鱼种类:</p><p id="34a8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">GET</code> <code class="fe nt nu nv nw b">/api/classes</code></p><p id="0cb6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">curl -X GET “https://aqua-vision.herokuapp.com/api/classes"</code></p><p id="a308" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你会得到这样的回报:<code class="fe nt nu nv nw b">["brown_trout", "bull_trout", "rainbow_trout"]</code></p><p id="0664" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">物种预测</strong></p><p id="b388" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">预测终点位于:</p><p id="560e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">POST</code> <code class="fe nt nu nv nw b">/api/predict</code></p><p id="020e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">curl -X POST -F image=<a class="ae lc" href="http://twitter.com/file_name" rel="noopener ugc nofollow" target="_blank">@b</a>rown_trout.png “<a class="ae lc" href="https://aqua-vision.herokuapp.com/api/predict" rel="noopener ugc nofollow" target="_blank">https://aqua-vision.herokuapp.com/api/predict</a>"</code></p><p id="5c71" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nt nu nv nw b">-X</code>标志和<code class="fe nt nu nv nw b">POST</code>值表示我们正在执行 POST 请求。我们提供<code class="fe nt nu nv nw b">-F image=@brown_trout.jpg</code>来表明我们正在提交表单编码数据。然后将<code class="fe nt nu nv nw b">image</code>键设置为<code class="fe nt nu nv nw b">brown_trout.jpg</code>文件的内容。在<code class="fe nt nu nv nw b">brown_trout.jpg</code>之前提供<code class="fe nt nu nv nw b">@</code>意味着我们希望 cURL 加载图像内容并将数据传递给请求。</p><p id="c7d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你会得到这样的回报:<code class="fe nt nu nv nw b">{“class”:”rainbow_trout”,”success”:true}</code></p><p id="5548" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">通过 Python 以编程方式访问 API</strong></p><p id="31c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是一个简单的 Python <a class="ae lc" href="https://github.com/perryrjohnson/aqua-vision/blob/master/simple_request.py" rel="noopener ugc nofollow" target="_blank">脚本</a>，它使用请求库向 API 提交数据，然后使用返回的预测。</p><h1 id="8702" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">正在进行的工作</h1><p id="346d" class="pw-post-body-paragraph kf kg iq kh b ki nn jr kk kl no ju kn ko np kq kr ks nq ku kv kw nr ky kz la ij bi translated">您可以通过访问<a class="ae lc" href="http://www.aqua-vision-research.com" rel="noopener ugc nofollow" target="_blank">项目的网站</a>和<a class="ae lc" href="https://github.com/perryrjohnson/aqua-vision/issues" rel="noopener ugc nofollow" target="_blank"> GitHub 问题</a>来查看正在进行的进度。</p><p id="4182" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该项目的持续目标是:</p><ol class=""><li id="c766" class="lt lu iq kh b ki kj kl km ko lv ks lw kw lx la ly lz ma mb bi translated"><strong class="kh ir">建立开源鳟鱼照片库</strong>继续提高深度学习模型的准确性，增加鳟鱼种类识别的支持类数量(最终扩展到其他鱼类)</li><li id="fa93" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">用边界框标记图像以<strong class="kh ir">将对象检测</strong>并入深度学习图像分类</li><li id="ffdc" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">带有坐标和时间戳的地理标签照片，用于未来的鳟鱼物种研究(种群分布、迁徙模式、杂交育种、地理空间分析等)</li><li id="3fcc" class="lt lu iq kh b ki mc kl md ko me ks mf kw mg la ly lz ma mb bi translated">构建支持性的<strong class="kh ir">本地移动应用</strong></li></ol><h1 id="617b" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">密码</h1><p id="1aeb" class="pw-post-body-paragraph kf kg iq kh b ki nn jr kk kl no ju kn ko np kq kr ks nq ku kv kw nr ky kz la ij bi translated">这个项目的代码可以在我的 GitHub 上找到</p><p id="8eed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想为这个项目做出贡献，或者有任何意见或问题，请发邮件给我:<a class="ae lc" href="mailto:perryrjohnson7@gmail.com" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir"><em class="lb">【perryrjohnson7@gmail.com】</em></strong></a><strong class="kh ir"><em class="lb">或者联系</em></strong><a class="ae lc" href="https://www.linkedin.com/in/perryrjohnson/" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir"><em class="lb">LinkedIn</em></strong></a><strong class="kh ir"><em class="lb">。</em>T49】</strong></p></div></div>    
</body>
</html>