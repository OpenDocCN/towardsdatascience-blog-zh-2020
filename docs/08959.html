<html>
<head>
<title>Use Machine Learning to Predict Horse Racing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用机器学习预测赛马</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-machine-learning-to-predict-horse-racing-4f1111fb6ced?source=collection_archive---------3-----------------------#2020-06-28">https://towardsdatascience.com/use-machine-learning-to-predict-horse-racing-4f1111fb6ced?source=collection_archive---------3-----------------------#2020-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d00e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将机器学习知识应用于现实世界分类问题的指南</h2></div><h1 id="7e1b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">背景</strong></h1><p id="66f0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我是 HKU 大学计算机科学硕士的非全日制学生。在上学期的考试之后，我在想将机器学习应用到真实世界的数据集上会很有趣也很酷。</p><p id="9d7d" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">我很快就找到了机器学习的好网站，<a class="ae mb" href="http://kaggle.com" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>。Kaggle 为数据科学学生和专业人士提供了许多有趣的数据集。我搜索“香港”，因为我想找到一个与我密切/相关的数据集，我得到了<a class="ae mb" href="https://www.kaggle.com/gdaley/hkracing" rel="noopener ugc nofollow" target="_blank">香港</a>赛马的数据集。非常感谢<a class="ae mb" href="https://www.kaggle.com/gdaley" rel="noopener ugc nofollow" target="_blank">格雷厄姆·戴利</a>在 Kaggle 上发布数据集。</p><p id="880c" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">我非常兴奋能够从事我的第一个真实世界机器学习项目。我觉得赛马是可以预测的，是典型的分类问题。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/88da46cdc07f702070bbf58522e8a7c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LocBAGZ3hxHOkniD"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">Julia Joppien 在<a class="ae mb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="634e" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">摘要</h1><p id="9e48" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这篇文章中，我将与你分享如何做数据预处理，神经网络模型的建立和训练。我们准备用熊猫、tensorflow、numpy、sklearn 等常见的机器学习包。最后，我也会分享一些我在这个项目之后走出来的思考。</p><h1 id="d8af" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">数据预处理</strong></h1><p id="bbd0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">数据集包含两个 csv 文件:races.csv 和 runs.csv。这两个表通过列“race_id”相关联。我们将需要连接这两个表，以便为训练生成有意义的数据。</p><h2 id="42fa" class="ms kj it bd kk mt mu dn ko mv mw dp ks lj mx my ku ln mz na kw lr nb nc ky nd bi translated"><strong class="ak">处理 races.csv 文件</strong></h2><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用于处理 races.csv 文件的代码</p></figure><ul class=""><li id="3b85" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">第 1-6 行:导入我们将用于项目的包。</li><li id="66b0" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 8–9 行:使用 pandas 读取 csv 文件。然后，选择我认为重要的 6 个栏目。</li><li id="7108" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 11–13 行:数据集包含 NaN 是很常见的，这意味着某些字段丢失了。在这里，让我们只是放弃他们。</li><li id="3baa" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 15–23 行:一些列是字符串。但是，神经网络模型只处理数字，所以我们需要对它们进行编码。字符串列有不同的类型:名义列和序数列。我们对列“venue”使用 LabelEncoder，而对列“config”和“going”使用 OrdinalEncoder。</li></ul><p id="fcbd" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">到目前为止，我们对来自 races.csv 的数据很满意。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="1a3e" class="ms kj it bd kk mt mu dn ko mv mw dp ks lj mx my ku ln mz na kw lr nb nc ky nd bi translated"><strong class="ak">处理 runs.csv 文件</strong></h2><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">用于处理 runs.csv 文件的代码</p></figure><p id="3d48" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">runs.csv 文件包含每场比赛的马匹数据，通过 race_id 与 races.csv 相关联。通常，每场比赛有 14 匹或更少的马一起比赛。该代码与我们对 races.csv 文件所做的非常相似，所以我不打算逐行解释。需要注意的一点是，在上面的第 10–13 行，我们需要删除一些有噪声的数据，原因在代码行内注释中有解释。处理后的数据帧头如下图所示。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="d1f2" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">您可能认为我们已经完成了 runs.csv 文件，但事实并非如此，因为我们需要考虑如何将数据输入神经网络。基本上，我们需要 races.csv 中的一行加上 runs.csv 中属于同一种族的所有行，并将它们放在一起作为神经网络的一个样本输入。下面的代码将对 runs dataframe 进行整形，以便相同种族的行将形成一行。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><ul class=""><li id="8e3b" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">第 1–5 行:我们定义了一个小函数 her 来对列进行排序。</li><li id="0ae1" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 7 行:magic pivot 方法对 runs.csv 数据进行了整形，使相同种族的行成为一行。列的排序如下[(马龄，1)，(马龄，2)，(马龄，3) … ]。但是，我希望列像[(horse_age，1)，(horse_country，1)，(horse_type，1)……(horse _ age，2)，(horse_country，2)，(horse_type，2)……]，这样我们将按顺序拥有 horse-1-features，horse-2-features，horse-3-features。我花了很长时间才弄明白该用哪个熊猫 API 来做这件事。不得不提的是，我们需要避免使用循环来争取更好的计算效率。</li><li id="3ebf" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 8–10 行:使用第 1–5 行中定义的函数对列进行排序。除了对马的特性进行分组之外，它还将“结果”列放在最后。因此最右边的列将是[……(结果，11)，(结果，12)，(结果，13)，(结果，14)]。将它们放在最后，因为它们是输出，而不是特征输入。</li><li id="820d" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 12–14 行:正如行内注释所解释的，我们的神经网络需要 14 匹马的数据作为输入。在这里，我们简单地用 0 填充虚拟马特征。</li></ul><h2 id="63ef" class="ms kj it bd kk mt mu dn ko mv mw dp ks lj mx my ku ln mz na kw lr nb nc ky nd bi translated"><strong class="ak">准备训练和测试数据集</strong></h2><p id="b15b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">你看，数据预处理的工作量很大。幸运的是，我们快到了。现在，让我们做最后一点，为神经网络准备好数据。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><ul class=""><li id="40ad" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">第 1 行:通过“race_id”连接我们上面准备的两个数据帧。</li><li id="5e0c" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 2 行:选择除最后 14 列之外的所有列作为输入<strong class="lc iu"> X </strong>。</li><li id="b0f8" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 3-4 行:应用特征缩放技术，标准化，这使得培训更容易。否则，网络很难学习特征“申报体重”(1100 sth)和特征“马龄”(大约 3-5)的参数。</li><li id="cdac" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 6 行:将列“结果”转换为输出<strong class="lc iu"> y </strong>。这是一个二元分类。因此，如果这匹马得了第一名，我们就放<strong class="lc iu"> 1 </strong>，否则就放<strong class="lc iu"> 0 </strong>。</li><li id="b49e" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 8–9 行:简单地打印出输入和输出的形状来看看。我们可以看到，我们有 6348 个比赛，每个比赛有 104 个特征和 14 个输出。</li></ul><pre class="md me mf mg gt nu nv nw nx aw ny bi"><span id="0264" class="ms kj it nv b gy nz oa l ob oc">(6348, 104)<br/>(6348, 14)</span></pre><ul class=""><li id="ce9b" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">第 11–12 行:使用 sklearn 提供的一个方便的 util 方法来分割数据以训练和测试(验证)集合。</li></ul><h1 id="4547" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">建立神经网络模型</strong></h1><p id="1ad8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">首先，我想向你展示神经网络的架构如下。这是项目的核心。到目前为止，我们所做的所有数据预处理都是为了输入神经网络。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi od"><img src="../Images/ab6ca15e32629dad80c904298c405ff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QNeSw6Ow90g-55yP0Po0Zw.jpeg"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">图片由作者提供:赛马的神经网络</p></figure><ul class=""><li id="201a" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">输入层:104 个节点，从 races.csv 文件中取 6，从 runs.csv 文件中取 7x14。</li><li id="71cc" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">隐藏层:只有 96 个节点。我认为这对于我们的项目来说已经足够了，因为这个分类的功能并不复杂。</li><li id="5094" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">输出层:14 个节点，每个节点表示一匹马是否赢得了比赛。</li></ul><p id="0b27" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">代码如下所示，非常简单，这要感谢 keras。请注意度量。我选择 precision，<a class="ae mb" href="https://developers.google.com/machine-learning/crash-course/classification/precision-and-recall" rel="noopener ugc nofollow" target="_blank"> 𝑝𝑟𝑒𝑐𝑖𝑠𝑖𝑜𝑛 = 𝑇𝑃/(𝑇𝑃+𝐹𝑃) </a>作为评估参数，因为赌赢是我们的兴趣所在。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f972" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">模型细节打印如下。可训练参数是 11，438，这是神经网络的能力。这意味着网络将学习和调整这些参数中的每一个，以便找到一个函数 y = f(X)来拟合我们的数据。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="f62c" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">训练网络，策划表演</strong></h1><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><ul class=""><li id="e117" class="ng nh it lc b ld lw lg lx lj ni ln nj lr nk lv nl nm nn no bi translated">第 1–4 行:在输入数据用于训练之前，进一步扭曲数据。</li><li id="170f" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 6–8 行:培训本身。在训练过程中，控制台会打印进度。</li><li id="8aa1" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">第 10–26 行:绘制性能图，图表如下所示。</li></ul><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/fd5ee128918a2ad85d7e4ded66aec045.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*8pk6X8JRZqNxl54IMDXELQ.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">作者图片:精确绘图</p></figure><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/5df81713fcbc5df07fb932a1ca6ab31d.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*plKzU5Zom2LwrmphY-fBgw.png"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">作者图片:损失的策划</p></figure><p id="215f" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">该网络足够强大，可以很好地适应训练数据集。然而，有很大的过度拟合。我们在验证数据集上可以达到的最佳性能大约是精度=0.3，这发生在纪元 60~80 左右。Precision=0.3 意味着我们可以在 10 个赢注中正确获得 3 个。这个性能没有我预期的高。原因可能是大多数比赛都是障碍赛，这意味着跑步者携带不同的重量来平衡他们赢得比赛的机会，参见参考文献<a class="ae mb" href="https://entertainment.hkjc.com/entertainment/common/images/learn-racing/racing-academy/pdf/Racing_101_202005_Eng_final.pdf" rel="noopener ugc nofollow" target="_blank"> Racing 101 </a>。</p><h1 id="c083" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">一些想法</strong></h1><ul class=""><li id="e6e5" class="ng nh it lc b ld le lg lh lj of ln og lr oh lv nl nm nn no bi translated">在数据分析之前，应该学习领域知识。我的教训是，我不理解赛马术语，如“win_odds”和“actual_weight ”,所以我不知道哪些列是有用的功能。在研究了<a class="ae mb" href="https://special.hkjc.com/racing/info/en/betting/guide.asp" rel="noopener ugc nofollow" target="_blank">指南</a>之后，事情变得清晰多了。</li><li id="a887" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">在编写代码之前做更多数据分析。找到数据集后，我很快开始编码。你可以看到<a class="ae mb" href="https://www.kaggle.com/cullensun/deep-learning-model-for-horse-racing" rel="noopener ugc nofollow" target="_blank">我的另一个笔记本</a>，其中我犯了一个大错误，我把一行 runs.csv 文件当成了一个样本。一匹马能否赢得一场比赛是相对于同场比赛的其他马而言的，所以我们要把一场比赛的 14 匹马的数据放在一起作为一个样本。</li><li id="9f72" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">我听人说过，数据预处理通常比建模和训练花费更多的时间。我发现这个项目确实如此。Pandas 有数百个强大的 API 供您操作数据帧，要想选择正确的 API 快速完成工作，需要花时间熟悉它们。</li><li id="dcad" class="ng nh it lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated">做这个项目真的可以学到很多东西。这比课程作业要多得多。</li></ul><h1 id="dcd5" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">总结</strong></h1><p id="7d29" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这篇文章中，我与您分享了如何在 Kaggle 的真实世界数据集上端到端地应用机器学习技能。我的完整笔记本可以在这里找到<a class="ae mb" href="https://www.kaggle.com/cullensun/deep-learning-model-for-hong-kong-horse-racing" rel="noopener ugc nofollow" target="_blank"/>。非常感谢您的阅读，并欢迎您的评论。</p></div></div>    
</body>
</html>