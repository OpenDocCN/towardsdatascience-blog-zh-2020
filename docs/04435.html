<html>
<head>
<title>How to create a Selenium web scraper in Azure Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Azure 函数中创建 Selenium web scraper</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-create-a-selenium-web-scraper-in-azure-functions-f156fd074503?source=collection_archive---------4-----------------------#2020-04-21">https://towardsdatascience.com/how-to-create-a-selenium-web-scraper-in-azure-functions-f156fd074503?source=collection_archive---------4-----------------------#2020-04-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3593" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">了解如何使用自定义 docker 图像创建 Azure 函数，并将其作为 Python 中的 lenium web scraper</em></h2></div><h1 id="8cbc" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">A.介绍</h1><p id="69fb" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">Selenium 是自动化 web 浏览器测试的标准工具。最重要的是，Selenium 是一个流行的<a class="ae lx" href="https://medium.com/the-andela-way/introduction-to-web-scraping-using-selenium-7ec377a8cf72" rel="noopener">网页抓取工具</a>。在 Azure 中创建 web scraper 时，Azure Functions 是运行代码的理想选择。然而，默认的 Azure Functions 映像不包含 Selenium 所需的依赖项。在这篇博客中，Azure Functions 中的 web scraper 创建如下:</p><ul class=""><li id="473f" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated">使用 Selenium 创建并部署 docker 映像作为 Azure 函数</li><li id="cdd1" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">定期抓取网站并存储结果</li></ul><p id="fcc6" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated"><strong class="ld iu"> <em class="mr">更新 2022–08–13:使用最新版本的 Azure Functions，Python 3.10 成功部署代码。Git 回购和博客是最新的。</em> </strong></p><p id="8782" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">web scraper 的架构如下所示。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/c354649723cc236ea3d80090812c2326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rSrrOfr8i7LdsxR2kfzXOQ.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">A.构建 Selenium web scaper 的架构(图片由作者提供)</p></figure><p id="7728" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">在剩下的部分，我们将讨论在 Azure Functions 中部署和运行 web scraper 的步骤。关于如何保护你的 Azure 功能的详细信息，请看这个博客。有关如何在 Azure 函数中使用 OpenCV 创建自定义 docker 映像的详细信息，请参见此处的<a class="ae lx" rel="noopener" target="_blank" href="/intelligent-realtime-and-scalable-video-processing-in-azure-201f87104f03">和此处</a>的 DockerFile <a class="ae lx" href="https://github.com/rebremer/realtime_video_processing/blob/master/AzureFunction/afpdqueue_rtv/Dockerfile" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="3ab1" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">B0。用 Selenium 作为 Azure 函数部署 Azure 函数</h1><p id="2c3c" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">基础 Azure 函数映像不包含运行 selenium webdriver 所需的 chromium 包。这个项目创建了一个定制的 docker 图像和所需的库，这样它就可以作为 Azure 函数运行。执行以下步骤:</p><ul class=""><li id="682a" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated">B01。安装必备组件</li><li id="ae1c" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">B02。从 GIT 克隆项目</li><li id="f60a" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">B03。使用 docker 桌面创建 docker 图像</li><li id="b8b9" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">B04。创建 Azure 函数并部署 docker 映像</li></ul><p id="ad82" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">另请参见下面的架构。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ni"><img src="../Images/ebf6a5be4ee713c9604e1f1551990947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RpZRTnzpoamCPriiudIBsg.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">B0。运行 Selenium 的 Azure 函数(图片由作者提供)</p></figure><h2 id="dcc5" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B01。安装依赖项</h2><p id="c575" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">需要安装以下先决条件:</p><ul class=""><li id="6bd3" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated"><a class="ae lx" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> Docker 桌面</a></li><li id="d7c9" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated"><a class="ae lx" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="4396" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated"><a class="ae lx" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=windows%2Ccsharp%2Cbash#v2" rel="noopener ugc nofollow" target="_blank"> Azure 核心工具版本 2.x </a></li><li id="ce9a" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated"><a class="ae lx" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">(可选)Visual Studio 代码</a></li><li id="7aca" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">(可选)<a class="ae lx" href="https://docs.microsoft.com/nl-nl/azure/container-registry/container-registry-get-started-portal" rel="noopener ugc nofollow" target="_blank"> Azure 容器注册中心</a>(也可以使用 docker hub)</li></ul><h2 id="a3b4" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B02。使用 docker 桌面创建 docker 图像</h2><p id="2e26" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">运行下面的命令从 git 克隆项目。如果您没有安装 git，也可以下载并解压缩 zip 文件。</p><pre class="mt mu mv mw gt nv nw nx ny aw nz bi"><span id="edd5" class="nj kk it nw b gy oa ob l oc od">git clone <a class="ae lx" href="https://github.com/rebremer/azure-function-selenium.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/azure-function-selenium.git</a></span></pre><p id="e510" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">在此项目中，可以找到以下文件:</p><ul class=""><li id="ed00" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated">TimeTrigger/__init__。py: Python 文件，包含抓取网站的所有代码。这个 Azure 函数是时间触发的</li><li id="907a" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">HttpTrigger/__init__。py:与前面的项目符号相同，但是，这是 HTTP 触发的函数，可以从浏览器运行..</li><li id="cc67" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">DockerFile:包含所有命令的文件，用于创建将在下一步中使用的 Docker 映像</li></ul><h2 id="f5f5" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B03。使用 docker 桌面创建 docker 图像</h2><p id="5eda" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">运行以下命令，在 Azure 函数基础映像上安装 chrome、chrome 驱动程序和 selenium。命令可以在 Visual Studio 终端或 PowerShell 终端中运行。对于&lt;<username>&gt;、&lt;<password>&gt;，您需要获取可以在访问键选项卡中找到的容器注册中心的凭证。</password></username></p><pre class="mt mu mv mw gt nv nw nx ny aw nz bi"><span id="2e19" class="nj kk it nw b gy oa ob l oc od"># Variables<br/>$acr_id = "&lt;&lt;your acr&gt;&gt;.azurecr.io"</span><span id="1e11" class="nj kk it nw b gy oe ob l oc od"># Create docker image using docker desktop<br/>docker login $acr_id -u &lt;&lt;your username&gt;&gt; -p &lt;&lt;your password&gt;&gt;<br/>docker build --tag $acr_id/selenium .</span><span id="b8a5" class="nj kk it nw b gy oe ob l oc od"># Push docker image to Azure Container Registry<br/>docker push $acr_id/selenium:latest</span></pre><h2 id="23e7" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B04。创建 Azure 函数并部署 docker 映像</h2><p id="20d7" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">运行以下命令创建一个 Azure 函数，并从 Azure Container Registry 部署 docker 映像。</p><pre class="mt mu mv mw gt nv nw nx ny aw nz bi"><span id="8a7f" class="nj kk it nw b gy oa ob l oc od"># Variables<br/>$rg = "&lt;&lt;your resource group name&gt;&gt;"<br/>$loc = "&lt;&lt;your location&gt;&gt;"<br/>$plan = "&lt;&lt;your azure function plan P1v2&gt;&gt;"<br/>$stor = "&lt;&lt;your storage account adhering to function&gt;&gt;"<br/>$fun = "&lt;&lt;your azure function name&gt;&gt;"<br/>$acr_id = "&lt;&lt;your acr&gt;&gt;.azurecr.io"</span><span id="a3dd" class="nj kk it nw b gy oe ob l oc od"># Create resource group, storage account and app service plan<br/>az group create -n $rg -l $loc<br/>az storage account create -n $stor -g $rg --sku Standard_LRS<br/>az appservice plan create --name $plan --resource-group $rg --sku P1v2 --is-linux</span><span id="15c1" class="nj kk it nw b gy oe ob l oc od"># Create Azure Function using docker image<br/>az functionapp create --resource-group $rg --os-type Linux --plan  $plan --deployment-container-image-name $acr_id/selenium:latest --name  $fun --storage-account $stor <!-- -->--docker-registry-server-user &lt;&lt;your acr user&gt;&gt; --docker-registry-server-password &lt;&lt;your acr password&gt;&gt;</span></pre><h1 id="89e2" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">B1。抓取网站并存储结果</h1><p id="9791" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">上一步部署的 Azure 函数包含一个时间触发函数和一个 HTTP 触发器函数。在这一部分，该功能将被触发，刮网站和存储结果到一个数据湖帐户。执行以下步骤:</p><ul class=""><li id="c75a" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated">B11。创建数据湖帐户</li><li id="fa3e" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">B12。运行 HTTP 触发器功能</li></ul><p id="3226" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">另请参见下面的架构。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi of"><img src="../Images/30f3fcd25d54f82999aee9f26a726f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7dgzZJe8CMcGexZJpi2CA.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">B1_1。抓取网站(作者图片)</p></figure><h2 id="4029" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B11。创建数据湖帐户和更新功能</h2><p id="8caa" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">执行以下命令在 Azure 中创建一个数据湖帐户，并更新函数的设置。</p><pre class="mt mu mv mw gt nv nw nx ny aw nz bi"><span id="8d07" class="nj kk it nw b gy oa ob l oc od"># Variables<br/>$rg = "&lt;&lt;your resource group name&gt;&gt;"<br/>$fun = "&lt;&lt;your azure function name&gt;&gt;"<br/>$adls = "&lt;&lt;your storage account&gt;&gt;"<br/>$sub_id = "&lt;&lt;your subscription id&gt;&gt;"<br/>$container_name = "scraperesults"</span><span id="4ba3" class="nj kk it nw b gy oe ob l oc od"># Create adlsgen2<br/>az storage account create --name $adls --resource-group $rg --location $loc --sku Standard_RAGRS --kind StorageV2 --enable-hierarchical-namespace true<br/>az storage container create --account-name $adls -n $container_name</span><span id="85f8" class="nj kk it nw b gy oe ob l oc od"># Assign identity to function and set params<br/>az webapp identity assign --name $fun --resource-group $rg<br/>az functionapp config appsettings set --name $fun --resource-group $rg --settings par_storage_account_name=$adls par_storage_container_name=$container_name</span><span id="9875" class="nj kk it nw b gy oe ob l oc od"># Give fun MI RBAC role to ADLS gen 2 account<br/>$fun_object_id = az functionapp identity show --name $fun --resource-group $rg --query 'principalId' -o tsv<br/>New-AzRoleAssignment -ObjectId $fun_object_id -RoleDefinitionName "Storage Blob Data Contributor" -Scope  "/subscriptions/$sub_id/resourceGroups/$rg/providers/Microsoft.Storage/storageAccounts/$adls/blobServices/default"</span></pre><h2 id="53ed" class="nj kk it bd kl nk nl dn kp nm nn dp kt lk no np kv lo nq nr kx ls ns nt kz nu bi translated">B12。运行功能</h2><p id="db2f" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">时间触发功能将定期运行，以抓取网站。但是，还有一个 HTTP 触发的功能。获取 URL 后，可以在浏览器中复制并运行它，另请参见下文。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi og"><img src="../Images/ee2d6573560c7681c5eeb77c0b57c41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UuzRcJ-nnBPg0sdxYZKSEg.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">B12_1。运行 HTTP 触发功能(图片由作者提供)</p></figure><p id="355d" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">运行该函数后，结果将存储在 data lake 帐户中，另见下文。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi og"><img src="../Images/ec6ef5ab4292b7c0a9533f2b38679b65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ODqg7xIrInQojhOE6SlUkQ.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">B12_2。存储在 ADLSgen2 帐户中的抓取结果(图片由作者提供)</p></figure><h1 id="aad2" class="kj kk it bd kl km kn ko kp kq kr ks kt jz ku ka kv kc kw kd kx kf ky kg kz la bi translated">C.结论</h1><p id="dc4e" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">Selenium 是一个流行的网络抓取工具。然而，默认的 Azure Functions 映像不包含 Selenium 所需的依赖关系。在这篇博客中，Azure Functions 中创建了一个 web scraper 来安装这些依赖项，如下所示:</p><ul class=""><li id="a3fc" class="ly lz it ld b le ma lh mb lk mc lo md ls me lw mf mg mh mi bi translated">使用 Selenium 创建并部署 docker 映像作为 Azure 函数</li><li id="7836" class="ly lz it ld b le mj lh mk lk ml lo mm ls mn lw mf mg mh mi bi translated">定期抓取网站并存储结果</li></ul><p id="063c" class="pw-post-body-paragraph lb lc it ld b le ma ju lg lh mb jx lj lk mo lm ln lo mp lq lr ls mq lu lv lw im bi translated">web scraper 的架构如下所示。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/c354649723cc236ea3d80090812c2326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rSrrOfr8i7LdsxR2kfzXOQ.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">C.构建 Selenium web scaper 的架构(图片由作者提供)</p></figure></div></div>    
</body>
</html>