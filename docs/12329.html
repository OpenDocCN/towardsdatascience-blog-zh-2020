<html>
<head>
<title>When Pandas is not enough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当熊猫还不够</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/when-pandas-is-not-enough-use-pandasql-d762b9b84b38?source=collection_archive---------17-----------------------#2020-08-25">https://towardsdatascience.com/when-pandas-is-not-enough-use-pandasql-d762b9b84b38?source=collection_archive---------17-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/61e9213cd5bd319c7ba0fa0f499dbfce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6jGmO0ShF2C6X8D2"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@kunal_au?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">库纳尔·卡拉</a>在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="f02b" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/python-shorts" rel="noopener" target="_blank">蟒蛇短裤</a></h2><div class=""/><div class=""><h2 id="2db3" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">非对等加入熊猫和 PandaSQL</h2></div><p id="d334" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Pandas 是最近最好的数据操作库之一。它可以让你切片和切块，分组，连接和做任何任意的数据转换。你可以看看这篇<a class="ae jg" rel="noopener" target="_blank" href="/minimal-pandas-subset-for-data-scientists-6355059629ae">文章</a>，它讲述了如何使用 Pandas 以一种简单明了的方式处理大多数数据操作。</p><p id="48d6" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">但是即使熊猫一般来说有多棒，有时候你还是想再多要一点。假设您来自一个 SQL 背景，其中相同的操作太容易了。或者你想有更多可读的代码。或者您只想对您的数据框运行特殊的 SQL 查询。或者，也许你来自 R，想要一个<code class="fe md me mf mg b">sqldf.</code>的替代品</p><p id="9cb9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">例如，Pandas 没有替代方法的操作之一是非等价连接，这在 SQL 中非常琐碎。</p><p id="50b4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在这一系列名为<a class="ae jg" href="https://towardsdatascience.com/tagged/python-shorts" rel="noopener" target="_blank"> <strong class="lj jt"> Python Shorts </strong> </a>的帖子中，我将解释 Python 提供的一些简单但非常有用的构造，一些基本的技巧，以及我在数据科学工作中经常遇到的一些用例。</p><p id="f56d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jt"> <em class="mh">这篇文章本质上是关于对熊猫数据框架使用 SQL。</em>T19】</strong></p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="f2e0" class="mp mq jj bd mr ms mt mu mv mw mx my mz ky na kz nb lb nc lc nd le ne lf nf ng bi translated">但是，什么是非等价连接，我为什么需要它们？</h1><p id="770d" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">假设您必须连接两个数据框。一个向我们展示了我们对某些商品进行促销的时期。第二个是我们的交易数据框架。我想知道由促销推动的销售额，即在促销期间某一商品的销售额。</p><p id="f7cf" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们可以通过在<code class="fe md me mf mg b">item</code>列上做一个连接以及一个连接条件(<code class="fe md me mf mg b">TransactionDt≥StartDt</code>和<code class="fe md me mf mg b">TransactionDt≤EndDt</code>)来做到这一点。由于现在我们的连接条件也有大于号和小于号，这样的连接称为非等价连接。在继续前进之前，一定要想好你将如何在熊猫身上做这样的事情。</p><figure class="nn no np nq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/95111291ccf08564029aad4f44009c71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vzkgnSuhZ4jQocdv5QWB8g.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="f1a3" class="mp mq jj bd mr ms mt mu mv mw mx my mz ky na kz nb lb nc lc nd le ne lf nf ng bi translated">熊猫解决方案</h1><p id="fd88" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">那么在熊猫身上你会怎么做呢？是的，基于熊猫的解决方案是存在的，尽管我觉得它不够易读。</p><p id="40e5" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们从生成一些随机数据开始。</p><figure class="nn no np nq gt iv"><div class="bz fp l di"><div class="nr ns l"/></div></figure><pre class="nn no np nq gt nt mg nu nv aw nw bi"><span id="7351" class="nx mq jj mg b gy ny nz l oa ob">offerDf,transactionDf = generate_data(n=100000)</span></pre><p id="33c1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">不需要担心上面的随机数据生成代码。只要知道我们的随机数据是什么样的:</p><div class="nn no np nq gt ab cb"><figure class="oc iv od oe of og oh paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><img src="../Images/e8733881c616289aa80e123fcfebbbfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*2Gbw0MncUzW5bc2oeFezFg.png"/></div></figure><figure class="oc iv oi oe of og oh paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><img src="../Images/6439484a41ce3e2a48e00f057f31d9e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*yflcEhtC8F9FCbQxcdywvQ.png"/></div></figure></div><p id="9d28" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">一旦有了数据，我们就可以通过合并列<code class="fe md me mf mg b">item</code>上的数据，然后根据所需的条件进行过滤，来进行非等价连接。</p><pre class="nn no np nq gt nt mg nu nv aw nw bi"><span id="fe88" class="nx mq jj mg b gy ny nz l oa ob">merged_df = pd.merge(offerDf,transactionDf,on='Item')</span><span id="841b" class="nx mq jj mg b gy oj nz l oa ob">pandas_solution = merged_df[(merged_df['TransactionDt']&gt;=merged_df['StartDt']) &amp; <br/>          (merged_df['TransactionDt']&lt;=merged_df['EndDt'])]</span></pre><p id="7aeb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">正如我们所希望的，结果如下:</p><figure class="nn no np nq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/7b9575c540da9a35f8a9d3277db0fec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pfOocETek5B5D31GTbJrIg.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="8c1f" class="mp mq jj bd mr ms mt mu mv mw mx my mz ky na kz nb lb nc lc nd le ne lf nf ng bi translated">PandaSQL 解决方案</h1><p id="867a" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">Pandas 解决方案很好，它做了我们想要的事情，但是我们也可以使用 PandaSQL 以一种可读性更好的方式来完成同样的事情。</p><p id="c205" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">什么是<a class="ae jg" href="https://github.com/yhat/pandasql" rel="noopener ugc nofollow" target="_blank"> PandaSQL </a>？</p><p id="2b25" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">PandaSQL 为我们提供了一种在 Pandas 数据帧上写 SQL 的方法。因此，如果您已经编写了一些 SQL 查询，使用 pandaSQL 可能比将它们转换成 pandas 语法更有意义。要开始使用 PandaSQL，我们只需简单地安装它:</p><pre class="nn no np nq gt nt mg nu nv aw nw bi"><span id="8135" class="nx mq jj mg b gy ny nz l oa ob">pip install -U pandasql</span></pre><p id="5740" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">一旦我们安装了 pandaSQL，我们就可以通过创建一个<code class="fe md me mf mg b">pysqldf</code>函数来使用它，该函数将一个查询作为输入，并运行该查询来返回一个 Pandas DF。不要担心语法；它大致保持不变。</p><pre class="nn no np nq gt nt mg nu nv aw nw bi"><span id="c5d1" class="nx mq jj mg b gy ny nz l oa ob">from pandasql import sqldf<br/>pysqldf = lambda q: sqldf(q, globals())</span></pre><p id="9115" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们现在可以使用这个函数在我们的 Pandas 数据框上运行任何 SQL 查询。下面是非等价连接，我们希望以可读性更好的 SQL 格式进行。</p><pre class="nn no np nq gt nt mg nu nv aw nw bi"><span id="3821" class="nx mq jj mg b gy ny nz l oa ob">q = """<br/>    SELECT A.*,B.TransactionDt,B.Sales<br/>        FROM<br/>            offerDf A<br/>        INNER JOIN<br/>            transactionDf B<br/>        ON <br/>            A.Item = B.Item AND<br/>            A.StartDt &lt;= B.TransactionDt AND<br/>            A.EndDt &gt;= B.TransactionDt;<br/>    """<br/>pandaSQL_solution = pysqldf(q)</span></pre><p id="254c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">结果是我们预期的熊猫数据帧。与以前不同，索引已经为我们重置。</p><figure class="nn no np nq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ol"><img src="../Images/ae351ebcbd86269279436efe7260047c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dqG3l18zMJ2DihbKgAkLJA.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="8ed6" class="mp mq jj bd mr ms mt mu mv mw mx my mz ky na kz nb lb nc lc nd le ne lf nf ng bi translated">警告:</h1><p id="3210" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">虽然 PandaSQL 函数允许我们在 pandas 数据框上运行 SQL 查询，并且在某些情况下是一个很好的工具，但它的性能不如纯 Pandas 语法。</p><figure class="nn no np nq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi om"><img src="../Images/32015dcaee0c7fd5e1c398f1aa960c93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CDciV2-P7A8r1YYiQIcZoA.png"/></div></div></figure><figure class="nn no np nq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi on"><img src="../Images/82d0b27f7b5009c0f5c691bcfb3e962f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a0AgZ4BEuHhx851KmSYvVw.png"/></div></div></figure><p id="a829" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">当我们用可读性更好的 PandaSQL 对熊猫计时时，我们发现 PandaSQL 花费的时间大约是本地熊猫的 10 倍。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="0b5f" class="mp mq jj bd mr ms mt mu mv mw mx my mz ky na kz nb lb nc lc nd le ne lf nf ng bi translated">结论</h1><p id="1c4e" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">在<a class="ae jg" href="https://towardsdatascience.com/tagged/python-shorts" rel="noopener" target="_blank"> Python Shorts </a>系列的这篇文章中，我们了解了 pandaSQL，它允许我们在数据帧上使用 SQL 查询。我们还研究了如何使用本地 pandas 和 pandaSQL 进行非对等连接。</p><p id="f2a9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">虽然 PandaSQL 库的性能不如 native pandas，但当我们想要进行特别分析时，它是我们数据分析工具箱的一个很好的补充，对于那些更喜欢使用 SQL 查询的人来说也是如此。</p><p id="2074" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了更仔细地查看这篇文章的代码，请访问我的<a class="ae jg" href="https://github.com/MLWhiz/data_science_blogs/tree/master/pandasql" rel="noopener ugc nofollow" target="_blank"> GitHub </a>库，在那里你可以找到这篇文章的代码以及我所有的文章。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="b89a" class="nx mq jj bd mr oo op dn mv oq or dp mz lq os ot nb lu ou ov nd ly ow ox nf jp bi translated">继续学习</h2><p id="6b17" class="pw-post-body-paragraph lh li jj lj b lk nh kt lm ln ni kw lp lq nj ls lt lu nk lw lx ly nl ma mb mc im bi translated">如果你想了解更多关于 Python 3 的知识，我想从密歇根大学调出一门关于学习<a class="ae jg" href="https://bit.ly/2XshreA" rel="noopener ugc nofollow" target="_blank">中级 Python </a>的优秀课程。一定要去看看。</p><p id="2ee2" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">将来我也会写更多初学者友好的帖子。在<a class="ae jg" href="https://medium.com/@rahul_agarwal" rel="noopener"><strong class="lj jt"/></a>关注我或者订阅我的<a class="ae jg" href="http://eepurl.com/dbQnuX" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jt">博客</strong> </a>了解他们。一如既往，我欢迎反馈和建设性的批评，可以通过 Twitter <a class="ae jg" href="https://twitter.com/MLWhiz" rel="noopener ugc nofollow" target="_blank"> @mlwhiz </a>联系。</p><p id="8d0f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">此外，一个小小的免责声明——这篇文章中可能会有一些相关资源的附属链接，因为分享知识从来都不是一个坏主意。</p></div></div>    
</body>
</html>