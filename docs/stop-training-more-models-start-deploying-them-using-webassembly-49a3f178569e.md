# 停止训练更多的模型，开始部署它们(使用 WebAssembly)

> 原文：<https://towardsdatascience.com/stop-training-more-models-start-deploying-them-using-webassembly-49a3f178569e?source=collection_archive---------46----------------------->

![](img/d3ed48bb9c56831db291cc74db98be74.png)

(图片来源:[迈克尔·帕尔多](https://www.flickr.com/photos/michaelpardo/21291816790/in/photolist-yru8ku-j2MaMa-9RQRd5-XQUUWV-27fPkcb-2hmSiv2-2iQoVQE-2gkMWEX-6K4sdF-2gkMWvo-2gkMMJZ-2gkMMN1-2gkMMGp-oeXzYC-S2KzMR-4U95KA-6v8xgu-dpjzQ6-SG65Rr-MQhTih-Prh3eJ-4jyRXw-2gkMMHG-2gkMMLn-oe2jc2-MhJHbj-nRSmrG-25AiTAb-2iMyY1A-2gkNgi2-xejXs7-odpVPu-24NefSX-otq9G4-Wk23fE-SU8GH3-2iQmeUy-THdcMs-tjkE5d-Rugw6Z-XB4pC1-ouVBmn-WoeRgX-V9HCJk-2aYcsL3-2aYctgG-tAAPoR-FuZaqN-ouzMis-NRj4sS))

## *我们很难兑现人工智能在医疗保健领域的承诺。不是因为我们的训练，是因为我们的部署。*

关于 *AI* (和 *ML* )将彻底改变医疗保健的传言已经有一段时间了。是的，我们已经看到了人工智能在医疗保健领域的一些惊人应用[例如，参见 2，3]。但是，根据我的个人经验，大多数在医疗保健领域接受过培训的模型都没有付诸实践。让我们看看为什么(或者，向下滚动，看看我们如何解决它)。

> **注:**这句话*“大多数在……接受培训的模型从未付诸实践”*可能适用于所有学科。医疗保健恰好是我确信的一个领域。

# 开发医疗保健模式

在过去十年里，我开发了人工智能方法，让计算机学习“什么对谁有效”。我研究过 Bandit 问题[例如，4]以及在线营销中的应用[5]，因此学会了“向谁展示哪个产品”。最近，我对“哪种治疗方法对哪个病人有效？”产生了兴趣；部分使用相同的数据科学方法，但这一次产生了积极的影响。

例如，在过去的两年里，我和沈凌杰一起与荷兰癌症登记处([T13)合作。伟大的人在 NCR 保持详细的记录包含荷兰癌症病例的进展。该登记包含患者的背景特征、他们的治疗(例如，化疗是或否)和结果(2 或 5 年死亡率)。从各个医院获取这些数据需要大量的整理工作，但 NCR 最终提供了一个干净的、记录良好的病例集合。我们从包含超过 50，000 名结肠癌患者且其肿瘤被手术切除的注册中摘录了一段内容。肿瘤切除后，关于是否进行化疗存在争议；虽然大多数随机对照试验(RCT)显示了积极的效果，但这似乎因患者和肿瘤类型而异[6]。](https://www.iknl.nl/en)

我们开始研究是否能知道哪些病人应该接受辅助化疗。一个简单的方法是拟合一个灵活的监督学习模型来预测 5 年生存率。因此，我们使用贝叶斯加法回归树[7]。然而，很明显，这还不够:NCR 的数据描述了在医院接受治疗的真实病例:治疗任务很可能会被严重混淆。我们可能混淆了因果关系。为了解决这个问题，我们研究了控制这种混杂的各种方法。我们最终将我们的估计与一个大 RCT 的估计进行了比较。这使我们能够验证我们的“校正模型”。

最后，这些步骤允许“输入反事实”[8]。我们创建了一个数据集，包含我们对每一位患者在治疗*和不治疗*下的预期结果。这允许生成个性化的治疗规则[9]:我们终于可以说哪种治疗对谁有效。**

上面的三个段落花了一年多的时间，需要我们的团队，NCR 和许多参与的肿瘤学家之间的协调。最终，该项目给了我们一个人工智能(或我们应该叫它什么)模型，给定一个特征向量，确定最佳治疗选择。然而，这个惊人的结果引出了下一个合乎逻辑的问题；我们如何确保这个模型被医疗专业人员实际使用？

# 模特从不离开他们的笔记本

为了找到答案，我决定和那些曾经经历过这个问题的人谈谈。所以，大约一年前，我开始和 NCR 大学的杰出人士交谈:“你如何部署你和使用你的数据的研究人员训练的模型？”简而言之，关于公共 API、监管、隐私以及文化和组织障碍，他们几乎不会这么做。事实证明，部署模型极其困难。

而且，不仅仅是 NCR；我和不同健康保险公司的数据科学家谈过。同样的问题。他们训练模型并验证它们，但很难将它们部署到医疗实践中。我与荷兰科学基金来源进行了交谈:是的，他们定期为各种医疗保健应用的模型培训提供资金。但是，实际部署这些模型是具有挑战性的，并且大多数项目都没有通过“笔记本阶段”:模型的有效性和有用性的良好演示，但是在实践中没有影响。

这里的底线是，不仅仅是我，一个研究人员，未能将训练好的模型投入生产。它无处不在，损害了我们真正改善患者生活的能力。

# 训练和部署是不同的

因此，我们面临一个问题:我们如何将模型投入生产？这个问题的答案会很复杂。这需要的不仅仅是技术解决方案。但是，我碰巧发现技术问题很有趣，所以现在让我们把重点放在这些问题上。

在我看来，部署模型的一个主要障碍是由我们对模型训练和模型部署的巨大不同的需求造成的。让我们来看几个:

*   **数据收集和管理:**在培训期间，我们喜欢使用从主要流程导出的管理数据集。这在 NCR 的例子中很明显:涉及的数据已经通过手术从各个医院的电子病历中删除(没有双关语的意思)。然而，在生产中，我们面对的是收集的数据。我们需要能够处理来自单个患者的(原始)数据。
*   **试验和探索:**在培训期间，我们喜欢能够让我们快速探索和预处理数据的工具。我们喜欢轻松地绘制图表，创建新的特征向量，并可视化我们的结果。在生产中，我们不需要这些工具；我们只需要确保快速可靠地生成推论。
*   **内存使用和计算性能:**在训练期间，我们喜欢访问整个数据集来训练我们的模型。我们喜欢确保模型参数被快速学习(例如使用 GPU)。我们需要大容量的存储空间和快速的机器来解决我们的问题，但我们通常有几分钟的空闲时间。然而，在生产中，我们只需要评估当时的单个示例，但是这种评估需要快速完成(导致低延迟和低计算成本)。在生产中，我们需要精简高效的代码。
*   **可移植性:**在培训期间，我们真的只需要在我们自己的机器上工作的东西。在部署方面，情况大不相同；我们希望大量的消费者使用我们的模型，很可能使用各种不同的系统。因此，我们应该使用标准化的接口提供对模型的访问，或者我们应该确保我们的模型可以随时随地运行。后者在健康上下文中非常重要，因为我们经常希望将模型发送到数据源，而不是将数据发送到某个外部服务器。

因此，虽然大多数数据科学家可以理解地乐于使用他们的 jupyter 笔记本(或各种其他工具)，但无论在他们的本地机器上发生什么，都太不适合在医院运行。实际上，我们需要一种方法来弥合从培训需求到部署需求之间的差距。

# 当前部署解决方案失败

显然，我不是唯一发现这个问题的人；近年来，已经提出了许多潜在的解决方案。大多数解决方案属于以下三类之一，每一类都有其缺点。

1.  **原样容器化:**从数据科学家的角度来看，一种相对简单的部署模型的方法是只取(例如)“python”笔记本代码，将其全部包装到一个(Docker)容器中，并公开一个 REST API。如果你不认真考虑，这听起来很不错。但事实并非如此:容器通常非常臃肿，结合大多数模型的底层`c`代码的`python`接口，这种方法导致部署比需要的大[数量级(内存方面)和慢](https://www.scailable.net/demo/bench/)数量级。
2.  **从头开始重建:**除了将现有内容容器化，另一种方法是将经过训练的模型从头开始重建为独立的高性能应用程序。在`c`或`rust`中重做模型，强大的打字和内存管理将使它变得小而快。您可能仍然需要对可执行文件进行容器化，或者针对不同的目标进行重新编译，但是本质上，您最终得到了一个可以在任何地方运行的小而快速的模型。然而，重建会消耗大量宝贵的开发时间。
3.  **存储和检索:**我遇到的容器化或重建模型以进行部署的替代方法是将协变量空间中多个点的模型生成的推理存储到数据库中，该数据库在生产中充当查找表。这非常快，但是容易出错，而且对于较大的协变量空间几乎不可能。

实际上，如果我们能在上面的方法 1 和 2 之间找到平衡点，那就太好了:我们能让数据科学家太容易地将一个合适的模型转换成一个可以在任何地方运行的小而有效的应用程序吗？

# 使用 WebAssembly 快速部署

自动重建一个模型，让它可以在极小而高效的容器中运行，这听起来似乎不可能，但仔细想想，事实并非如此。我们使用 [WebAssembly](https://webassembly.org) 、由我们在[的朋友提供的运行时 wasmer](https://wasmer.io) 解决了这个问题，并且，不可否认的是，对`c`代码底层(例如)`sklearn`和各种编译器指令进行了大量的修改。所有这些导致了一种使用单行代码将存储的模型对象编译(或*传输*到 WebAssembly 的全自动方式。结果是一个惊人的快速，超级小的“可执行文件”,可以在几乎任何环境下运行；我们可以在服务器上运行该任务，并使用简单的 API 来公开它，但我们甚至可以在浏览器或边缘上运行它。WebAssembly(或`.wasm`)可执行文件可以被运送到医院，并在他们的系统中运行，直接基于 EPD 数据，而无需将数据运出医院。

## 简单的例子

为了说明这一点，让我们看一些简单线性回归模型的代码。下面的代码使用`sklearn`拟合一个简单的回归模型，随后使用`[sclblpy](https://pypi.org/project/sclblpy/)`包将它上传到[可伸缩的](https://www.scailable.net):

几秒钟内，模型就完成了。为了让事情变得超级简单，我们甚至在我们的服务器上托管生成的`.wasm`可执行文件。这种特定的模型上传可以在 id `7d4f8549-a637–11ea-88a1–9600004e79cc`下获得，并且可以在[这里](https://admin.sclbl.net/run.html?cfid=7d4f8549-a637-11ea-88a1-9600004e79cc&exin=%5B%5B10%5D%5D)进行测试。

或者，一个简单的 cURL 调用，如下所示:

```
curl - location - request POST '[https://taskmanager.sclbl.net:8080/task/7d4f8549-a637-11ea-88a1-9600004e79cc'](https://taskmanager.sclbl.net:8080/task/7d4f8549-a637-11ea-88a1-9600004e79cc') - header 'Content-Type: application/x-www-form-urlencoded' - data-raw '{"input":{"content-type":"json","location":"embedded","data":"{\"input\": [[10]]}"},"output":{"content-type":"json","location":"echo"},"control":1,"properties":{"language":"WASM"}}'
```

立即提供结果模型推断。

## 试试看！

我们认为，我们将模型投入生产的方法可以弥合医疗保健等领域从培训到部署的差距。这很容易，结果是高性能和可移植的。然而，我们确实需要人们去尝试它，给予反馈，并帮助我们改进。所以，如果你想试一试，就在[www.scailable.net](https://www.scailable.net)获得自己的账户。

任何评论都非常感谢！

# 结论

让我们结束这一切。我认为我们开发有用模型的速度快于我们使用它们的速度。我认为模型部署是医疗保健领域(以及其他领域)的一个问题。我认为，部分原因是我们在训练模型和部署模型时有着非常不同的需求。我认为自动将模型传输到 WebAssembly 解决了这个问题:这很容易，它是高性能的，并且产生的可执行文件是可移植的。我们期待看到您的反馈。

## 参考

1.  [https://doi . org/10.1016/s 0140-6736(17)31540-4](https://doi.org/10.1016/S0140-6736(17)31540-4)
2.  [https://www . science direct . com/science/article/ABS/pii/s 0040816619300904](https://www.sciencedirect.com/science/article/abs/pii/S0040816619300904)
3.  【https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6616181/ 
4.  [https://journals . sage pub . com/doi/ABS/10.1177/2158244019851675](https://journals.sagepub.com/doi/abs/10.1177/2158244019851675)
5.  [https://www . emerald . com/insight/content/doi/10.1108/EJM-08-2016-0485](https://www.emerald.com/insight/content/doi/10.1108/EJM-08-2016-0485/full/html?casa_token=_vFH61lzgRQAAAAA:DHoQVIdURX8Z4yCny3runzpvXsQnMGkZEZYMKRM2EAILvy27QUgOPxv4un7bNrhScByTj7tML-9BFSWSOnUZ7FzVc6hanykZ6kVpDU3tQ5xG_BMA3pc)
6.  [https://www . the lancet . com/article/s 0140-6736(07)61866-2](https://www.thelancet.com/article/S0140-6736(07)61866-2)
7.  [https://arxiv.org/abs/0806.3286](https://arxiv.org/abs/0806.3286)
8.  [https://amstat . tandfonline . com/doi/ABS/10.1198/016214504000001880](https://amstat.tandfonline.com/doi/abs/10.1198/016214504000001880)
9.  [https://arxiv.org/abs/1709.07498](https://arxiv.org/abs/1709.07498)

## 放弃

*值得一提的是我自己的参与:我是 Jheronimus 数据科学院的数据科学教授，也是 Scailable 的联合创始人之一。因此，毫无疑问，我对 Scailable 有既得利益；我有兴趣让它成长，这样我们就可以最终将人工智能投入生产并兑现它的承诺。这里表达的观点是我自己的。*