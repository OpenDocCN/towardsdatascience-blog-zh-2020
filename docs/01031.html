<html>
<head>
<title>Geolocations and geocodes instrument set for data analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于数据分析的地理定位和地理编码仪器组</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geolocations-and-geocodes-instrument-set-for-data-analysis-5eb4e33a1677?source=collection_archive---------27-----------------------#2020-01-29">https://towardsdatascience.com/geolocations-and-geocodes-instrument-set-for-data-analysis-5eb4e33a1677?source=collection_archive---------27-----------------------#2020-01-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="f14e" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">数据科学提示</h2><div class=""/><div class=""><h2 id="8183" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">four square+geopy+leav 完美共生</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/0d28c2a60d92d54833452e5b6ffb6ffc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S1SrHz2d_DOwelXQ"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae lh" href="https://unsplash.com/@aronvisuals?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aron 视觉</a>拍摄的照片</p></figure><p id="def3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi me translated"><span class="l mf mg mh bm mi mj mk ml mm di">地理对象、地址或坐标的大型数据集的分析需要一些固定的仪器。您需要提取关键数据，获得必要的细节，在地图上可视化数据点，并为分析或某种学习算法做好准备。我想以我的家乡城市为例，分享我在这些任务中使用的工具集。</span></p><h1 id="02b0" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">1.使用 geopy 获取城市区域位置</h1><p id="c8a9" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">城市的地理标签本身有一点信息，所以我们应该发现城市所有区域的坐标。对于大城市来说，这可能是一项复杂的任务，需要额外的邮政编码数据集、一些网络抓取工具或其他资源。嗯，我的家乡(第聂伯)不是很大，所以这里是它的地区:</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="0295" class="np mo it nl b gy nq nr l ns nt">['Amur-Nyzhnodniprovskyi',<br/> 'Shevchenkivskyi',<br/> 'Sobornyi',<br/> 'Industrialnyi',<br/> 'Tsentralnyi',<br/> 'Chechelivskyi',<br/> 'Novokodatskyi',<br/> 'Samarskyi']</span></pre><p id="dc7e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在我们将使用<a class="ae lh" href="https://github.com/geopy/geopy" rel="noopener ugc nofollow" target="_blank">地理包</a>来发现这些地区的地理标签。默认的地理编码器对我们来说已经足够了，尽管你可以在<a class="ae lh" href="https://geopy.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">文档页面</a>上找到更多的 API。为了以防万一，我们将设置响应的最大延迟和尝试次数。</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="1b0f" class="np mo it nl b gy nq nr l ns nt">from <strong class="nl jd">geopy</strong>.geocoders import <strong class="nl jd">Nominatim</strong><br/>from <strong class="nl jd">geopy</strong>.extra.rate_limiter import RateLimiter</span><span id="12dd" class="np mo it nl b gy nu nr l ns nt">geolocator = <strong class="nl jd">Nominatim</strong>(user_agent="dnipro",timeout=10)<br/>geocode = RateLimiter(geolocator.geocode, min_delay_seconds=2)</span><span id="79bb" class="np mo it nl b gy nu nr l ns nt">longitudes = []<br/>latitudes = []<br/>for region in dnipro_regions['Region']:<br/>    location = geocode('{}, Dnipro'.format(region))<br/>    longitudes.append(location.longitude)<br/>    latitudes.append(location.latitude)</span></pre><p id="7534" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">将坐标连接到我们的数据集并继续。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/fa52216bd5f8f321f75a9b552a073e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/1*oHpJQvgtufjFPlAZE3eXhA.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">带有地理标记的区域</p></figure><h1 id="ad0f" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">2.使用 Foursquare 获取咖啡馆和商店的详细信息</h1><p id="c18e" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">让我们假设，我们为孤独的游客开发推荐系统，他们想去一个外国城市的咖啡馆或食品店吃饭。为此，我们需要一个咖啡馆、餐馆、食品店等的列表。在每个城市区域的邻近地区。我们可以在地理定位服务的帮助下形成数据集。我更喜欢 Foursquare API。它有非常方便的端点来搜索不同的地点(像旅游场所，咖啡馆，汽车站等。)通过具体的坐标或在一些邻居、端点内发现场地细节、评级和许多其他东西。这是<a class="ae lh" href="https://developer.foursquare.com/docs/api" rel="noopener ugc nofollow" target="_blank">有据可查的</a>，其免费帐户允许足够数量的调用，所以让我们来看看代码。</p><h2 id="a880" class="np mo it bd mp nw nx dn mt ny nz dp mx lr oa ob mz lv oc od nb lz oe of nd iz bi translated">2.1.获取场地</h2><p id="4310" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">首先，我们必须找到所有符合“咖啡馆或食品店”类别的场所。<strong class="lk jd">“探索”</strong> endpoint 将帮助我们完成这项任务:</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="f8d8" class="np mo it nl b gy nq nr l ns nt">venues_list=[]<br/>for name, lat, lng in zip(names, latitudes, longitudes):<br/>    url = 'https://api.foursquare.com/v2/venues/<strong class="nl jd">explore</strong>?&amp;<strong class="nl jd">client_id</strong>={}&amp;<strong class="nl jd">client_secret</strong>={}&amp;<strong class="nl jd">v</strong>={}&amp;<strong class="nl jd">ll</strong>={},{}&amp;<strong class="nl jd">radius</strong>={}&amp;<strong class="nl jd">limit</strong>={}'.format(CLIENT_ID, CLIENT_SECRET, VERSION, lat, lng, 3000, 200)<br/>        <br/>    results = requests.get(url).json()["response"]['groups'][0]['items']<br/>    venues_list.extend([<br/>        [name, v['venue']['name'], v['venue']['id'],<br/>         v['venue']['location']['lat'],<br/>         v['venue']['location']['lng'],  <br/>         v['venue']['categories'][0]['name']<br/>        ] for v in results])</span><span id="45c0" class="np mo it nl b gy nu nr l ns nt">    nearby_venues = pd.DataFrame(venues_list)<br/>    nearby_venues.columns = ['Region', 'Venue', 'Venue ID',<br/>                             'Venue Latitude', 'Venue Longitude',<br/>                             'Venue Primary Category']<br/>    </span></pre><p id="064c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们只保存了对我们的目的重要的信息:位置坐标、名称、id 和主要类别。简单看一下我们的场馆数据:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi og"><img src="../Images/483d2c8ef868a5a2d9bae6f8e4587022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WscUgFgfsmsRAbF2PUXNXg.png"/></div></div></figure><p id="4dbf" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，通过“场馆主要类别”一栏，只过滤我们需要的“食品和咖啡馆”类别，我们就可以开始下一步了。</p><h2 id="88b2" class="np mo it bd mp nw nx dn mt ny nz dp mx lr oa ob mz lv oc od nb lz oe of nd iz bi translated">2.2.获取场馆信息</h2><p id="e17f" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">我们的数据集包含大量的场馆，并附有它们的类别、位置和区域。信息量很大，但肯定不够。任何学习算法都需要更多的信息。所以，是时候测试另一个 Foursquare 端点了— <strong class="lk jd">“场馆详情”</strong>。它的主要参数是 venue ID，这是我们在上一步中获得的。</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="7ca7" class="np mo it nl b gy nq nr l ns nt">venues_list=[]<br/>for venue_id in venues_dataset['Venue ID'].values:<br/>    url_venue = 'https://api.foursquare.com/v2/<strong class="nl jd">venues</strong>/{}?&amp;<strong class="nl jd">client_id</strong>={}&amp;<strong class="nl jd">client_secret</strong>={}&amp;<strong class="nl jd">v</strong>={}'.format(venue_id, CLIENT_ID, CLIENT_SECRET, VERSION)<br/>    venue_results = requests.get(url_venue).json()["response"]['venue']<br/>        <br/>    venues_list.append([<br/>        venue_results['location']['formattedAddress'],<br/>        [el['name'] for el in venue_results['categories']],<br/>        venue_results['likes']['count'] if 'likes' in venue_results else 0, <br/>        venue_results['rating'] if 'rating' in venue_results else 0,<br/>        venue_results['hours']['isOpen'] if 'hours' in venue_results else np.nan<br/>        ])</span><span id="0268" class="np mo it nl b gy nu nr l ns nt">venues_table = pd.DataFrame(venues_list)<br/>venues_table.columns = ['Venue Address', 'Venue Categories',<br/>                        'Venue Likes', 'Venue Rating',<br/>                        'Venue Is Open']</span></pre><p id="9664" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">API 响应中有很多细节，不过，我们将只使用其中的几个:扩展类别、用户点赞数、评级以及场馆是否暂时开放的信息。到这个时候，我们的连接了场馆细节的数据集就快完成了。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oh"><img src="../Images/2eafff44b93ecd0dbb3ef8d67f943671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sX3f-_ppzTQD1CYHdeK3lA.png"/></div></div></figure><h1 id="bfe5" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">3.用叶子想象咖啡馆和商店</h1><p id="afec" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">我们的“地理管道”的最后一步是地图的可视化，以获得整个画面。我最喜欢的工具是<a class="ae lh" href="https://python-visualization.github.io/folium/quickstart.html" rel="noopener ugc nofollow" target="_blank">叶库</a>，所以，没有更多的话，只有地图。</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="2785" class="np mo it nl b gy nq nr l ns nt">import <strong class="nl jd">folium</strong><br/>import matplotlib.cm as cm<br/>import matplotlib.colors as colors</span><span id="358b" class="np mo it nl b gy nu nr l ns nt">map_venues_food = folium.Map(location=[lat, lon], zoom_start=12)</span><span id="3914" class="np mo it nl b gy nu nr l ns nt">colors_array = cm.rainbow(np.linspace(0, 1, 7))<br/>rainbow = [colors.rgb2hex(i) for i in colors_array]</span><span id="b106" class="np mo it nl b gy nu nr l ns nt">for lat, lng, name, region in zip(<br/>                         dnipro_venues_food['Venue Latitude'],<br/>                         dnipro_venues_food['Venue Longitude'],<br/>                         dnipro_venues_food['Venue'],<br/>                         dnipro_venues_food['Region']):<br/>    label = folium.Popup('{}, {}'.format(name, region))<br/>    folium.CircleMarker(<br/>        [lat, lng],<br/>        radius=5,<br/>        popup= label,<br/>        color=rainbow[region_index],<br/>        fill=True,<br/>        fill_color='#3186cc',<br/>        fill_opacity=0.7,<br/>        parse_html=False).add_to(map_venues_food)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oi"><img src="../Images/967670abbb6b2a31d9fb69bb7f0eb2dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKgdE0y9XZBt33vZ6PT2_g.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">带有按区域分组的场馆的树叶地图</p></figure><h1 id="000d" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">4.使用数据</h1><p id="9c6c" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">然而，地理工具仅仅为我们提供了数据分析的基础。接下来的步骤取决于你。</p><p id="029d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以统计每个地区的场馆数量:</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="4d7f" class="np mo it nl b gy nq nr l ns nt">gp_venues = dnipro_venues_food.groupby('Region').count()['Venue']</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/b9e06876671b61fd509c11c451920d58.png" data-original-src="https://miro.medium.com/v2/resize:fit:468/format:webp/1*6A-KCxeEjY72u3B2fyEC4Q.png"/></div></figure><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="c2e7" class="np mo it nl b gy nq nr l ns nt">grouped_venues.plot.bar()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/e34687a33c7038678080689fbb3f3ac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*BjiKQUwlWFUH7HkJDqomkw.png"/></div></figure><p id="4d47" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">找出每个地区的前 5 个类别:</p><pre class="ks kt ku kv gt nk nl nm nn aw no bi"><span id="2d7b" class="np mo it nl b gy nq nr l ns nt">dnipro_onehot = pd.get_dummies(venues[['Venue Primary Category']])<br/>dnipro_onehot['Region'] = venues['Region']</span><span id="d8b8" class="np mo it nl b gy nu nr l ns nt">top_5 = dnipro_onehot.groupby('Region').sum().reset_index()</span><span id="63a2" class="np mo it nl b gy nu nr l ns nt">for i in np.arange(top_5.shape[0]):<br/>    row = top_5.iloc[i, 1:].sort_values(ascending=False)<br/>    top_5_sorted.iloc[i, 1:] = row.index.values[0:5]</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ol"><img src="../Images/16a6ac57da3995b9208bff854cd75d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SD1ha1SbDyN3k0jjgHtryQ.png"/></div></div></figure><p id="1c34" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">或者我们甚至可以将这些值转换成学习算法的特性表(参见 GitHub 上的完整代码)。</p><p id="065f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">继续你想要的任何例子。</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="5c41" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你可以看到，提供的“地理管道”让我们能够非常灵活地为您的项目提供坐标、地址和不同的位置，这肯定可以用于进一步的分析。您可以在我的 GitHub 上的 Jupyter 笔记本中看到当前的工作示例:</p><div class="ot ou gp gr ov ow"><a href="https://github.com/Midvel/medium_jupyter_notes/blob/master/geolocation_for_analysis/geolocations-for-analysis.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd jd gy z fp pb fr fs pc fu fw jc bi translated">中级/中等 _jupyter_notes</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">github.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk lb ow"/></div></div></a></div><p id="6238" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你可能会注意到，“地理管道”包含了我自己更喜欢的工具。但是它可以扩展，元素可以改变。您使用哪些服务和工具来处理地理数据？</p></div></div>    
</body>
</html>