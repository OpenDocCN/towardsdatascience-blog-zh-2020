<html>
<head>
<title>How-To: A Color-Coded, Segmented Bar Graph</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:用颜色编码的分段条形图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-a-color-coded-segmented-bar-graph-9e09b5bad3b0?source=collection_archive---------69-----------------------#2020-05-26">https://towardsdatascience.com/how-to-a-color-coded-segmented-bar-graph-9e09b5bad3b0?source=collection_archive---------69-----------------------#2020-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0a34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最近我做了很多新冠肺炎分析。上周末，我想为我正在撰写的关于 T4 新冠肺炎封锁和流动性水平的<a class="ae ko" href="https://medium.com/data-in-the-time-of-corona/lockdown-fatigue-94efeae6f24a" rel="noopener">博客文章</a>制作一个特定类型的图表。我想要一个如下的条形图:</p><ol class=""><li id="7c80" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn ku kv kw kx bi translated">每个条形反映一个国家在新冠肺炎封锁期间经历的总流动性下降；为此，我使用了谷歌和苹果的移动数据集。</li><li id="657d" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">对每个条形进行分段，以便每个分段反映其封锁的连续一周内的流动性下降；换句话说，如果锁定持续 10 周，那么酒吧将由 10 个部分组成。</li><li id="c1a9" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">每一条都用颜色编码，以反映该国的人均死亡人数。</li></ol><p id="116f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本着<em class="ld">“这是我之前做的一张”</em> …这是我最终创建的图表，接下来我将解释我是如何制作它的。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/91764aefc103cbc99733a94c63f1ff92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6aMbrjX94V5HQQ7NveER3A.png"/></div></div></figure><h1 id="bf2b" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">一些错误的开始…</h1><p id="ceef" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">起初，我认为这是一个<a class="ae ko" href="https://matplotlib.org/3.1.1/gallery/lines_bars_and_markers/bar_stacked.html" rel="noopener ugc nofollow" target="_blank">堆积条形图</a>的变体，但是经过一番挖掘和研究，我得出结论，这不是正确的方法。虽然堆积条形图可以提供分段效果，但不可能单独给条形着色；更确切地说，堆积条形图<em class="ld">给</em> <em class="ld">段</em>着色，使得每个条形图由一组有序的多色段组成。接下来，我想一个<a class="ae ko" href="https://matplotlib.org/3.1.1/gallery/images_contours_and_fields/image_annotated_heatmap.html" rel="noopener ugc nofollow" target="_blank">热图</a>可能会有用，但那也不起作用，因为热图使用固定大小的单元，所以我们不能产生不同大小的片段。</p><p id="5cac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我想出了一个更加定制的解决方案，通过一次一段地构建每个条形，并给条形着色。这样做的好处是每个条和段都是可单独寻址的，因此控制大小和颜色很简单。在接下来的内容中，我将逐步描述所采用的方法，代码和样本数据可以从<a class="ae ko" href="https://github.com/barrysmyth/data_science_in_practice/blob/master/notebooks/a_colour_coded_segmented_bar_graph.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><h1 id="182c" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">样本数据集</h1><p id="9cfd" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">为了解释这一点，我们需要一些样本数据。以下是新冠肺炎一级防范禁闭的数据，这些数据最初推动了该图表的开发。每行对应一个国家。有一列是该国(截至 2020 年 5 月中旬)每百万人死亡人数的对数(基数为 10)，还有一组列是一个国家封锁期每周的平均流动性下降百分比；这些周数是基于该国第 100 例确诊病例以来的周数。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mt"><img src="../Images/345fe1a867d61fe6aa8d4e104de56075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pdcRTNo9Q48iTwFxlG6tBg.png"/></div></div></figure><p id="aa3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，奥地利的死亡人数约为百万分之 70(log 10(70)~ 1.84)，封锁始于奥地利记录第 100 例(第 0 周)的一周，其流动性下降了 8%(相对于封锁前的水平)，在接下来的几周内，奥地利的流动性水平下降了 70%。柱状图中的分段高度将对应于这些单个的每周流动性下降。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="6044" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便提一下，我们在这里使用死亡率的对数只是为了强调死亡率之间的差异，因为每百万人的原始死亡率值范围很广(从&lt;5 to &gt; 500)，对数标度有助于将这些值“分散”一点。</p><h1 id="cb71" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">一段一段地绘制条形</h1><p id="7282" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">为了构建我们的分段棒线，下面的<em class="ld"> plot_segments </em>函数在适当的 x 轴坐标上分别绘制每个棒线的分段，为每个周值创建一个单独的棒线分段，并将这些分段堆叠在一起以生成最终的棒线。然后，通过将<em class="ld"> plot_segments </em>应用于每周数据集的每一行，可以创建完整的条形图；我们使用熊猫申请功能来做到这一点。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="ac14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是由上述代码产生的基本分段条形图。根据我们的需求，每个国家/地区由一个分段的条形表示，每个分段对应于每周的流动性下降。不同大小的段表示国家之间和国家内部几周的差异，柱的总高度是每周流动性下降的总和。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mw"><img src="../Images/daac3874957928ebdfbdafc550c9befe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-GfuZknf24RKCl8fUVPoQ.png"/></div></div></figure><p id="f9c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，我们可以通过改变条的<em class="ld">宽度</em>和/或通过调整<em class="ld">线宽</em>来调整片段的大小(以控制片段之间的间距)；通过改变<em class="ld">边缘颜色</em>，我们也可以改变分割的颜色。事实上，我们甚至可以通过使用定制的 Matplotlib <em class="ld">补丁</em>来为我们的线段使用不同的形状，而不是简单的条，但那是另一天的事了。</p><h1 id="fb38" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">对条/段进行颜色编码</h1><p id="64bd" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">现在我们有了基本的分段条形图，它为我们提供了对单个分段的控制，是时候使用相应国家的一些属性来给每个条形的分段着色了；在这种情况下，我们使用每个国家的(对数)死亡率作为该属性。</p><p id="46de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最好的方法是使用一张与我们的(对数)死亡率成比例的彩色地图(连续的颜色)。我们为此使用 Matplotlib 的<em class="ld"> coolwarm </em>彩色地图，它提供了从红色到蓝色的良好过渡，我们缩放它，以便最高死亡率映射到红色，最低映射到蓝色。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4ee6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我们创建一个简单的字典，将一个国家的名称与其对应的颜色联系起来。由此产生的调色板，按照我们数据框架中的国家顺序排列如下，以供参考</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mx"><img src="../Images/213b37a2b344b0719b6c3210ee59a9a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t4uBAX5W0WKvIcb4vEw9WA.png"/></div></div></figure><p id="fa1a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了自己的颜色，我们需要做的就是改变<em class="ld"> plot_segments </em>函数的一行，这样我们就可以使用颜色字典中分配给当前国家的颜色，而不是使用固定的颜色。我们还应该将颜色字典传递到函数中，并记住<em class="ld"> x </em>是国家名称。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d22e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了:我们的分段条形图根据每个国家的死亡率进行着色。我们需要的最后一件东西是一个带标签的钥匙，用它来解释颜色，这样一看我们就可以估计对应于特定颜色的死亡率。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi my"><img src="../Images/f07b817704a5a9e12cf6b6e231d665a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9mbCl4GLBb6rRdi7OSaN3w.png"/></div></div></figure><h1 id="d4bb" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">添加颜色键</h1><p id="597e" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">为此，我们使用 Matplotlib <a class="ae ko" href="https://matplotlib.org/3.2.1/api/_as_gen/matplotlib.pyplot.colorbar.html" rel="noopener ugc nofollow" target="_blank"> colorbar </a>，它将在缩放后的彩色地图中显示连续的颜色。我们在主条形图上方显示一个水平的颜色条，但是，以类似的方式，我们可以在其中一个边上显示一个垂直的颜色条。</p><p id="8246" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了便于定位，我们给颜色条指定了自己的轴，并使用 gridspec 排列颜色条和条形图轴，如下所示。然后，在绘制分段条形图之后，我们添加颜色条，设置其标题，并添加其刻度标签。因为我们使用死亡率的对数(基数为 10 ),所以在将它们显示在颜色条上之前，我们将它们转换回常规死亡率；在最终版本中，我们可能希望为这些死亡率选择<em class="ld">舍入</em>数(例如，5、10、25、100、250、500)，但在这里，我们使用的是等间距刻度。</p><p id="6edc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里是最终的代码</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="c597" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成的图表…</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mz"><img src="../Images/5392e81f36beb8cfe214f5b0a01c246d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*97n5dkLwQg4X8IfMJ8vy9g.png"/></div></div></figure><h1 id="e987" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">结论</h1><p id="bb32" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">这就完成了彩色编码分段条形图的开发。根据需要，每个条形由一组单独大小的段组成，每个条形可以单独进行颜色编码，以反映条形的一些独立属性。有没有我错过的更好的方法？如果是的话，我很想听听。</p><p id="e6a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">照目前的情况来看，这是一个非常灵活的解决方案。通过改变段之间的间隙的厚度(如上所述使用<em class="ld">线宽</em>，或间隙的颜色(使用<em class="ld">边缘颜色</em>，可以很容易地调整分段，当然，通过调整条的宽度和/或增加间隙计算，条/段的宽度和它们之间的间隙可以以通常的方式改变。甚至可以通过使用不同形状的贴片(圆形、椭圆形等)来改变单个片段的形状。).</p></div></div>    
</body>
</html>