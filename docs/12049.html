<html>
<head>
<title>Implementing A Keras CNN in iOS Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 iOS 应用中实现 Keras CNN</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-a-keras-cnn-in-ios-9e82836b0ee3?source=collection_archive---------56-----------------------#2020-08-19">https://towardsdatascience.com/using-a-keras-cnn-in-ios-9e82836b0ee3?source=collection_archive---------56-----------------------#2020-08-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cd31" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何利用 Keras 和 Swift 实现一个移动 CNN 可以识别你的狗品种看起来很像</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/4f7dcec0d7acdfbe2a1860a50ab269bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*1fzTT-p6uDXTSzrlul76HQ.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">作者拥有许可证</p></figure><p id="921c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我第一次想到在一个应用程序中进行图像分类是在看电视节目《T2》的时候。对于任何非<em class="lo">硅谷</em>爱好者来说，这部剧是一部喜剧，剧中人物在一个科技孵化器里。孵化器的一名成员推出了一个应用程序，其中唯一的功能是告诉你你看到的图片是“热狗”还是“不是热狗”卷积神经网络(CNN)很可能最适合完成这项任务，虽然我过去上过这方面的课程，但我对如何在移动设备上实现和部署机器学习算法很感兴趣。</p><p id="8cb5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我的第一个行动是为一个图像分类应用程序选择一个主题，我选择了狗。谁不喜欢给自己的狗拍照呢？但是为了做到这一点，我需要一个相对大而广的数据集来训练 CNN。幸运的是，斯坦福大学有一个开源数据库，里面有 120 个不同的狗品种，每个品种至少有 150 张图片。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/f6fdc408d4ced44cf75ec4dadca38d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*kUAXawukA7OcSHVLUFLlrw.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">示例输入—作者提供的图片</p></figure><p id="3875" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我的下一个想法是，虽然给狗分类的应用程序会很有趣，但它可能相对来说很平凡。那么，如果模型取一张人的照片作为输入和输出，那么与人最相似的狗的品种是什么呢？该分类器将只在狗身上训练，但给定任何图像，包括一个人的图像，它将提供各种品种的概率结果，因此它将输出最可能的品种作为预测。</p><p id="74f8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">苹果 iOS 使用一种名为 Core ML 的工具来执行所有的机器学习任务，如图像识别。起初，我认为我可能需要用 Swift 来构建和训练一个模型，这是一种我相对不熟悉的语言。然而，在谷歌搜索了几次后，我发现苹果提供了一个核心 ML 转换器，它可以将 Keras 模型转换为可以部署在 iOS 应用程序中的核心 ML 模型。</p><p id="8a6a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">接下来，我必须建立 CNN，并对大约 20，000 张图片进行训练。为了在不进行大量训练迭代的情况下获得足够的模型深度，迁移学习可能是最佳途径。我决定使用流行的 VGG16 网络，它在过去赢得了 ImageNet 竞赛。下面是该网络的概况。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi lq"><img src="../Images/91990dd6ccf8e20ab7b1f395de675b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U0z2HwGmfAG9-_VA.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">VGG16 网络的架构—公共域</p></figure><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="0a1b" class="ma mb iq lw b gy mc md l me mf">from keras.models import Sequential<br/>from keras.layers import Dense, Conv2D, Flatten, Dropout, MaxPooling2D, Activation, Reshape<br/>from keras.preprocessing.image import ImageDataGenerator<br/>from keras.applications.vgg16 import VGG16</span></pre><p id="9566" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我将层设置为不可训练，以保持原始的 VGG 权重，并在末端添加了 2 个完全连接的层，同时利用下降来控制过度拟合。我还“弹出”了 VGG 的最后一层，并添加了两个完全连接的层，以使其符合正确的输出数量。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="cd18" class="ma mb iq lw b gy mc md l me mf">model = Sequential()<br/>model.add(VGG16(include_top = False, input_shape = (270,201,3)))<br/>model.layers.pop()<br/>model.layers.pop()</span><span id="c8a7" class="ma mb iq lw b gy mg md l me mf">for layer in model.layers:<br/>    layer.trainable = False<br/>model.add(Flatten())<br/>model.add(Dense(3000, activation = 'relu'))<br/>model.add(Dropout(0.2))<br/>model.add(Dense(118, activation = 'softmax'))<br/>model.compile(optimizer = 'adam', loss = 'categorical_crossentropy', metrics = ['accuracy'])</span></pre><p id="3d86" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">然而，在开始训练之前，我需要对图像进行预处理。使用 Keras 的 ImageDataGenerator 非常有用，因为它可以根据给定的输入大小调整图像，并允许训练和验证分割。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="11ae" class="ma mb iq lw b gy mc md l me mf">data = ImageDataGenerator(rescale=1./255, horizontal_flip=True, validation_split=.2)</span><span id="968d" class="ma mb iq lw b gy mg md l me mf">train_gen = data.flow_from_directory('/Users/Derek/Desktop/ImageTrain', subset = 'training', class_mode = 'categorical', target_size = (270,201))#201 for ease in coreml</span><span id="3d0a" class="ma mb iq lw b gy mg md l me mf">test_gen = data.flow_from_directory('/Users/Derek/Desktop/ImageTrain', subset = 'validation', class_mode = 'categorical', target_size = (270,201))</span></pre><p id="1193" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我对模型进行了训练，直到验证错误开始增加，并将其保存为 Keras checkpoint .h5 格式。然后我把我的模型转换成。可用于 iOS 设备的 mlmodel 格式。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="60a0" class="ma mb iq lw b gy mc md l me mf">import coremltools<br/>model.save('your_model.h5')<br/>coreml_model = coremltools.converters.keras.convert('your_model.h5', image_scale = 1./255., class_labels=class_list, input_names='Image', image_input_names = "Image")<br/>spec = coreml_model.get_spec()<br/>coremltools.utils.convert_double_to_float_multiarray_type(spec)<br/>coreml_model = coremltools.models.MLModel(spec)</span><span id="bc28" class="ma mb iq lw b gy mg md l me mf">coreml_model.save('my_model.mlmodel')</span></pre><p id="213d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在我开始应用程序开发之前，我必须学习一些 Swift 的基础知识，老实说，我还必须学习应用程序开发！我在 YouTube 上找到了一个很棒的教程，叫做《Chris 的编码》,它讲述了 Swift 和 Xcode 应用程序开发的所有基础知识。⁴:有了这个教程，我能够把一个单一视图应用程序放在一起，它接受来自用户相机胶卷的图像或通过应用程序拍摄的图像作为输入，并输出最可能的狗品种分类，以及狗的图片。虽然这个过程的大多数方面都很简单，因为 Apple 在 Xcode 中使用了许多拖放功能，但我必须手动预处理用户图像大小，以确保它适合 CNN 中的输入尺寸。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="9fa4" class="ma mb iq lw b gy mc md l me mf"><strong class="lw ir">func</strong> full_preprocess(uiim: UIImageView, cgim: CGImage) -&gt; CVPixelBuffer {</span><span id="0b6e" class="ma mb iq lw b gy mg md l me mf"><strong class="lw ir">var</strong> im = <strong class="lw ir">self</strong>.imageWithImage(image: uiim.image!, scaledToSize:CGSize(width: 67, height: 90))//This has to be half of the model input size because of the buffer</span><span id="855e" class="ma mb iq lw b gy mg md l me mf"><strong class="lw ir">let</strong> ratio:Double = 270.0/Double(im.cgImage!.height)</span><span id="c11e" class="ma mb iq lw b gy mg md l me mf"><strong class="lw ir">if</strong> ratio != 1 {im = <strong class="lw ir">self</strong>.imageWithImage(image: uiim.image!, scaledToSize:CGSize(width: 67.0 * ratio, height: 90 * ratio))}</span><span id="61f4" class="ma mb iq lw b gy mg md l me mf"><strong class="lw ir">let</strong> new_im:CVPixelBuffer = <strong class="lw ir">self</strong>.pixelBufferFromCGImage(image: im.cgImage!, image2: im)</span><span id="0fbe" class="ma mb iq lw b gy mg md l me mf"><strong class="lw ir">return</strong> new_im</span><span id="3d6a" class="ma mb iq lw b gy mg md l me mf">}</span></pre><p id="1968" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在你有了它，一个利用数据科学和应用程序开发的项目，一个有希望让你一路开怀大笑的项目！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mh"><img src="../Images/534cba4e819eb61b818be921617f7efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fn17c0wUt89EcbrKKarXPg.jpeg"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">作者拥有许可证</p></figure></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="aebe" class="mp mb iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">参考文献</strong></h1><ol class=""><li id="ddc8" class="ng nh iq ku b kv ni ky nj lb nk lf nl lj nm ln nn no np nq bi translated">越南安乐，<em class="lo">杨坚:热狗识别 app </em>，2017，<a class="ae kr" href="https://www.youtube.com/watch?v=vIci3C4JkL0" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=vIci3C4JkL0</a></li><li id="b290" class="ng nh iq ku b kv nr ky ns lb nt lf nu lj nv ln nn no np nq bi translated">斯坦福大学，<em class="lo">斯坦福狗数据集</em>，<a class="ae kr" href="http://vision.stanford.edu/aditya86/ImageNetDogs/" rel="noopener ugc nofollow" target="_blank">http://vision.stanford.edu/aditya86/ImageNetDogs/</a></li><li id="ef62" class="ng nh iq ku b kv nr ky ns lb nt lf nu lj nv ln nn no np nq bi translated">苹果，<em class="lo">芯 ML，</em>T14】https://developer.apple.com/documentation/coreml</li><li id="3513" class="ng nh iq ku b kv nr ky ns lb nt lf nu lj nv ln nn no np nq bi translated">CodeWithChris，<em class="lo"> Code With Chris，</em><a class="ae kr" href="https://www.youtube.com/channel/UC2D6eRvCeMtcF5OGHf1-trw" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/channel/UC2D6eRvCeMtcF5OGHf1-trw</a></li></ol></div></div>    
</body>
</html>