<html>
<head>
<title>Examining the Postgres catalog with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 检查 Postgres 目录</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/examining-the-postgres-catalog-with-python-70d872b8f6d5?source=collection_archive---------55-----------------------#2020-07-20">https://towardsdatascience.com/examining-the-postgres-catalog-with-python-70d872b8f6d5?source=collection_archive---------55-----------------------#2020-07-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/9d2217a522a2e9b3b9051c4d4bb3704c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*nOQl2ha23LsdwrQGDYxyfQ.jpeg"/></div><p class="iv iw gj gh gi ix iy bd b be z dk translated">Postgres 目录中的大量信息</p></figure><div class=""/><div class=""><h2 id="be80" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">充分利用数据库元数据</h2></div><p id="a798" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">像 Postgres 这样的关系数据库包括一组描述数据库中的表的表。这组元数据表被称为<strong class="ks jc">目录</strong>，它包含了关于数据库的大量细节。我最近需要编写一个程序来从数据库目录中自动提取见解，这使我编写了一个简单的 Python 模块来连接到 Postgres 数据库，从目录中获取信息，并将该信息加载到 Pandas 数据帧中，以便用 Python 进行进一步处理。这篇文章描述了我遵循的过程。</p><h2 id="38e0" class="lm ln jb bd lo lp lq dn lr ls lt dp lu kz lv lw lx ld ly lz ma lh mb mc md me bi translated">介绍</h2><p id="2938" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">关于 Postgres 的一个关键事实是，它有两个目录，而不是一个:</p><ul class=""><li id="e09b" class="mk ml jb ks b kt ku kw kx kz mm ld mn lh mo ll mp mq mr ms bi translated"><strong class="ks jc"> ANSI </strong> (information_schema):这个目录包含为 ANSI 标准定义的公共关系数据库信息。如果您将目录的使用限制在 information_schema，那么您的代码应该与实现 ANSI 标准的其他关系数据库一起工作。</li><li id="3f29" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll mp mq mr ms bi translated"><strong class="ks jc"> PostgreSQL </strong> (pg_catalog):这个目录包含特定于 Postgres 的元数据。如果您的代码依赖于这个目录，那么在它可以与其他关系数据库一起使用之前，需要对它进行更新。</li></ul><p id="7323" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当您使用 Postgres UI 管理工具<a class="ae my" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>检查与数据库相关的对象时，您可以看到数据库 dvdrental 有以下两个目录:</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/a28231aa15e59d4d01c8fcf329198658.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*5PSWi8IfDKd0mkd1ObyQ2w.jpeg"/></div></figure><p id="dea8" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">出于本文的目的，我将重点放在 ANSI 目录上，因为它有我需要的信息，并且我编写的用于 Postgres ANSI 目录的代码应该可以用于其他关系数据库的目录。</p><h2 id="d8e7" class="lm ln jb bd lo lp lq dn lr ls lt dp lu kz lv lw lx ld ly lz ma lh mb mc md me bi translated">设置 Postgres 目录的探索</h2><p id="4cc6" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">为了从 Python 程序中探索 Postgres ANSI 目录，我遵循了以下步骤:</p><ol class=""><li id="f311" class="mk ml jb ks b kt ku kw kx kz mm ld mn lh mo ll ne mq mr ms bi translated"><a class="ae my" href="https://www.postgresql.org/download/" rel="noopener ugc nofollow" target="_blank">下载了</a>并安装了 Postgres，还有<a class="ae my" href="https://www.pgadmin.org/download/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>。出于本练习的目的，pgAdmin 提供了快速检查目录和复查 Python 代码结果的完美方法。</li><li id="cc73" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll ne mq mr ms bi translated">设置<a class="ae my" href="https://www.postgresqltutorial.com/postgresql-sample-database/" rel="noopener ugc nofollow" target="_blank"> dvdrental </a>数据库。这个示例数据库很容易设置，并且有丰富的数据库对象，包括触发器、视图、函数和序列，所以在它的 ANSI 目录中有很多需要研究的内容。</li><li id="cd14" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll ne mq mr ms bi translated">创建了一个 Python 模块来连接数据库，运行一个查询来从一个目录表中提取信息，并将结果保存为一个 pickled 数据帧</li></ol><p id="ff1c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">以下部分描述了我为实现步骤 3 而编写的 Python 代码。</p><h2 id="d855" class="lm ln jb bd lo lp lq dn lr ls lt dp lu kz lv lw lx ld ly lz ma lh mb mc md me bi translated">探索 Postgres 目录的 Python 模块</h2><p id="495d" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">你可以在这里找到探索 Postgres 目录<a class="ae my" href="https://github.com/ryanmark1867/dl_auto_catalog/blob/master/notebooks/scrape_db_catalog.py" rel="noopener ugc nofollow" target="_blank">的 Python 模块。以下是该守则的要点:</a></p><ol class=""><li id="38af" class="mk ml jb ks b kt ku kw kx kz mm ld mn lh mo ll ne mq mr ms bi translated">使用 psycopg2 库创建到 Postgres 数据库的连接。使用从配置文件<a class="ae my" href="https://github.com/ryanmark1867/dl_auto_catalog/blob/master/notebooks/scrape_db_catalog_config.yml" rel="noopener ugc nofollow" target="_blank">scrape _ db _ catalog _ config . yml</a>读取的参数和用户交互提供的 Postgres 密码建立连接:</li></ol><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="ce50" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">2.使用配置文件中的参数构建查询来检查目录中的一个表，运行查询，并将结果复制到 Python 变量 record_col_details 中。</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="2a50" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">3.将查询结果写入熊猫数据帧:</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="54fe" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">配置文件包含连接参数(在 general 部分)和查询参数(在 query_scope 部分)。</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="6029" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">通过更新配置文件中的参数，您可以轻松地更改查询，以检查不同的目录表(通过更新 from_table)或目录表中不同的列集(通过更新 cols)。这意味着您可以重复地重新运行 Python 模块来从目录中获得您需要的细节，而不必接触 Python 代码。</p><p id="7b89" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">例如，如果我想在查询的输出中包含 ordinal_position 列，我只需将它添加到配置文件的 cols 列表中:</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="7cdf" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">请注意，Postgres 连接的密码不包含在配置文件中。相反，代码会直接提示用户输入密码:</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="5380" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">以下是 Python 模块的输出示例，显示了从 ANSI 目录的列表(information_schema.columns)中选择的列。我可以使用列的数据类型信息来帮助自动创建简单的深度学习模型，以对这些表中的数据进行预测。</p><pre class="na nb nc nd gt nh ni nj nk aw nl bi"><span id="66ff" class="lm ln jb ni b gy nm nn l no np">column_name                    data_type     table_name<br/>0     last_name            character varying          actor<br/>1      actor_id                      integer          actor<br/>2    first_name            character varying          actor<br/>3   last_update  timestamp without time zone          actor<br/>4    first_name            character varying     actor_info<br/>5      actor_id                      integer     actor_info<br/>6     last_name            character varying     actor_info<br/>7     film_info                         text     actor_info</span></pre><h2 id="f275" class="lm ln jb bd lo lp lq dn lr ls lt dp lu kz lv lw lx ld ly lz ma lh mb mc md me bi translated">结论</h2><p id="8bc9" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">Postgres ANSI 目录包含关于 Postgres 数据库的有用元数据。通过使用 psycopg2 库连接到数据库并在配置文件中维护连接和查询参数，您可以从 Python 模块中有效地检查目录。</p><h2 id="3683" class="lm ln jb bd lo lp lq dn lr ls lt dp lu kz lv lw lx ld ly lz ma lh mb mc md me bi translated">相关资源</h2><ul class=""><li id="29e0" class="mk ml jb ks b kt mf kw mg kz nq ld nr lh ns ll mp mq mr ms bi translated">包含本文所述代码的回购:【https://github.com/ryanmark1867/dl_auto_catalog T4】</li><li id="0b79" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll mp mq mr ms bi translated">Python PostgreSQL 教程使用 psycopg 2:<a class="ae my" href="https://pynative.com/python-postgresql-tutorial/" rel="noopener ugc nofollow" target="_blank">https://pynative.com/python-postgresql-tutorial/</a></li><li id="a4e6" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll mp mq mr ms bi translated">结构化数据深度学习主 repo:<a class="ae my" href="https://github.com/ryanmark1867/deep_learning_for_structured_data" rel="noopener ugc nofollow" target="_blank">https://github . com/ryanmark 1867/Deep _ Learning _ for _ Structured _ Data</a></li><li id="d6d9" class="mk ml jb ks b kt mt kw mu kz mv ld mw lh mx ll mp mq mr ms bi translated">结构化数据深度学习书籍:<a class="ae my" href="https://www.manning.com/books/deep-learning-with-structured-data" rel="noopener ugc nofollow" target="_blank">https://www . manning . com/books/deep-Learning-with-Structured-Data</a></li></ul></div></div>    
</body>
</html>