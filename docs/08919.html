<html>
<head>
<title>How to use BigQuery API with your own dataset?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对自己的数据集使用 BigQuery API？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-bigquery-api-with-your-own-dataset-c901972cebd?source=collection_archive---------12-----------------------#2020-06-27">https://towardsdatascience.com/how-to-use-bigquery-api-with-your-own-dataset-c901972cebd?source=collection_archive---------12-----------------------#2020-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6342" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Flask 和 Bigquery APIs 根据用户查询参数从 Bigquery 数据集中提取数据。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/b37e887d0da01e38efe1cccd9db7b490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*_OSPbxMSvPbknSL-sV7yeg.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来源:<a class="ae ku" href="https://imgflip.com/memetemplate/Brace-Yourselves-X-is-Coming" rel="noopener ugc nofollow" target="_blank"> imgflip </a></p></figure><h1 id="d057" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">我们要用 BigQuery APIs 做什么？</h1><blockquote class="ln lo lp"><p id="8516" class="lq lr ls lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">big query(BQ)API 对于让最终用户与数据集和表进行交互非常有用。</p></blockquote><p id="7bef" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">我们在本文中的目标是利用一些 BQ API 函数建立与 BigQuery 项目的连接，然后查询存储在那里的数据库。该数据库包含通过将 firebase analytics 链接到 Firebase 仪表板中的 BigQuery 而获得的 firebase 事件数据。</p><p id="7a43" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">这是我的<code class="fe mq mr ms mt b">podcastApp</code>项目的云控制台的样子(它现在是一个 Android 和 IOS 应用程序，对那些有兴趣听播客的人来说是<a class="ae ku" href="https://podurama.com/" rel="noopener ugc nofollow" target="_blank"> Podurama </a>):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mu"><img src="../Images/759d9f28cdd4f3cf37e60ca8ae27bebe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zII-LXIgBg51l6dmRkuCrA.png"/></div></div></figure><h1 id="8b49" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">装置</h1><p id="9741" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">步骤 1:在终端中运行以下命令:</p><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="9f52" class="ni kw it mt b gy nj nk l nl nm">pip install --upgrade google-cloud-bigquery</span></pre><p id="8de4" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">步骤 2:使用以下步骤从 Google Cloud console 获取您的 BQ 项目的认证密钥:</p><ul class=""><li id="6300" class="nn no it lt b lu lv lx ly mn np mo nq mp nr mm ns nt nu nv bi translated">前往<a class="ae ku" href="https://console.cloud.google.com/projectselector2/home/dashboard?_ga=2.31442943.1164828906.1593094302-317534299.1590154480&amp;_gac=1.251470514.1590548362.EAIaIQobChMIzsjynIbT6QIVsiCtBh0-wAAvEAAYASAAEgI2DvD_BwE&amp;pli=1" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu">项目选择器页面</strong> </a>。</li><li id="464f" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated"><a class="ae ku" href="https://console.cloud.google.com/flows/enableapi?apiid=bigquery&amp;_ga=2.64793711.1164828906.1593094302-317534299.1590154480&amp;_gac=1.242952502.1590548362.EAIaIQobChMIzsjynIbT6QIVsiCtBh0-wAAvEAAYASAAEgI2DvD_BwE" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu">启用 API </strong> </a>。</li><li id="e3c1" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">在云控制台中，进入<a class="ae ku" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey?_ga=2.231582815.1164828906.1593094302-317534299.1590154480&amp;_gac=1.246546736.1590548362.EAIaIQobChMIzsjynIbT6QIVsiCtBh0-wAAvEAAYASAAEgI2DvD_BwE" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu">创建服务账号密钥</strong> </a>页面。</li><li id="1286" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">从<strong class="lt iu">服务账户</strong>列表中选择<strong class="lt iu">新服务账户</strong>。</li><li id="20a6" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">在<strong class="lt iu">服务帐户名称</strong>字段中，输入一个名称。</li><li id="aff3" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">从<strong class="lt iu">角色</strong>列表中，选择<strong class="lt iu">项目</strong> &gt; <strong class="lt iu">所有者</strong>。</li><li id="a599" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">点击<strong class="lt iu">创建</strong>。一个 JSON 文件，包含下载到您计算机的密钥。</li></ul><p id="82fb" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">如果你在遵循这些步骤时遇到困难，在开始<a class="ae ku" href="https://cloud.google.com/bigquery/docs/quickstarts/quickstart-client-libraries" rel="noopener ugc nofollow" target="_blank">官方 Bigquery 文档</a>页面上的之前，检查一下<em class="ls">下的步骤 1、2 和 3。</em></p><p id="5735" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">一旦您按照这些步骤操作，您的下载文件夹中就会有一个 JSON 文件。确保将它移动到您将要编写 python API 脚本的目录中。</p><h1 id="f613" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">在我们开始之前…</h1><p id="b171" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">在我们之前的博客文章中，我们讨论了什么是 API 和端点，如何使用 Flask 框架编写一个简单的<code class="fe mq mr ms mt b">HelloWorld</code> API，然后编写稍微高级的 API——从用户那里获取输入参数的 API。我们还深入讨论了如何通过在本地运行后端服务器来测试我们的 API。最后，我们还学习了如何编写简单而强大的 REST APIs 来部署机器学习模型。</p><p id="80a2" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">我强烈推荐您去看看，因为在使用 Flask 框架方面有很多重叠，也因为在本文中我将更多地关注 BigQuery API。</p><p id="995f" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">注意:我将使用<strong class="lt iu"> Spyder </strong>来编写 API 代码。最后，我将从<strong class="lt iu"> Jupyter 笔记本中访问我的 API。</strong></p><h1 id="0895" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">让我们直接进入编码...</h1><p id="2c61" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">在存储 JSON 认证密钥的同一个目录中创建一个新的 Python 脚本<code class="fe mq mr ms mt b">BigQuery_API.py</code>。</p><h2 id="b3cc" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">正在导入 BigQuery 库</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="5024" class="ni kw it mt b gy nj nk l nl nm">from google.cloud import bigquery</span></pre><h2 id="3a74" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">直接在代码中设置环境变量</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="f18b" class="ni kw it mt b gy nj nk l nl nm">import os<br/>os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = 'podcastApp-e07020594640.json'</span></pre><p id="62c4" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">在上面的代码中替换 JSON 键的名称。</p><blockquote class="ln lo lp"><p id="ae40" class="lq lr ls lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">提示:我发现在代码中直接设置 Google 应用程序凭证<strong class="lt iu">非常有用，当你同时处理需要不同凭证的项目时。</strong></p></blockquote><h2 id="ef49" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">初始化 BigQuery 客户端</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="fe7f" class="ni kw it mt b gy nj nk l nl nm"><em class="ls"># simple non parameterized query</em><br/>client = bigquery.Client()</span></pre><h2 id="967f" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">编写 SQL 查询</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="1626" class="ni kw it mt b gy nj nk l nl nm">query = """<br/>    SELECT user_pseudo_id, event_name <br/>    FROM `podcastapp-767c2.analytics_193436959.events_*` <br/>    LIMIT 5<br/>    <br/>"""</span></pre><p id="86ca" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">这是一个非常基本的查询，我希望看到两列的前五行数据——用户 id 和事件名称。当然，你的问题可能会比这更复杂。要获得一些查询灵感，请查看这篇文章。</p><h2 id="08cd" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated"><strong class="ak">发出 API 请求</strong></h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="b2ab" class="ni kw it mt b gy nj nk l nl nm">query_res = client.query(query)  # Make an API request.</span></pre><h2 id="cae0" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated"><strong class="ak">打印结果</strong></h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="9cf0" class="ni kw it mt b gy nj nk l nl nm"><em class="ls"># to print in the console</em><br/>for row in query_res:<br/>    print(f'{row.user_pseudo_id}: {row.event_name}')</span></pre><h2 id="8673" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">最后，所有代码都在一个地方…</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="5954" class="ni kw it mt b gy nj nk l nl nm">from google.cloud import bigquery</span><span id="a9ea" class="ni kw it mt b gy om nk l nl nm">import os<br/>os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = 'podcastApp-e07020594640.json'</span><span id="e62e" class="ni kw it mt b gy om nk l nl nm"><em class="ls"># simple non parameterized query</em><br/>client = bigquery.Client()</span><span id="de9d" class="ni kw it mt b gy om nk l nl nm">query = """<br/>    SELECT user_pseudo_id, event_name <br/>    FROM `podcastapp-767c2.analytics_193436959.events_*` <br/>    LIMIT 5<br/>    <br/>"""</span><span id="cf11" class="ni kw it mt b gy om nk l nl nm">query_res = client.query(query)  # Make an API request.</span><span id="76a7" class="ni kw it mt b gy om nk l nl nm"><em class="ls"># to print in the console</em><br/>for row in query_res:<br/>    print(f'{row.user_pseudo_id}: {row.event_name}')</span></pre><p id="0b1d" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">运行该脚本会在 iPython 控制台中产生以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/4d70bd597609f4cd83a7c61229ae8750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*UIGMgKcor7NNvTt8vVpZrA.png"/></div></figure><p id="fef7" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">Wohoo！我们已经成功地从我们的 BigQuery 数据库中进行了查询。</p><h1 id="a840" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">参数化 SQL 查询</h1><p id="13ff" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">正如我之前提到的，我们选择了一个相对简单的查询作为例子。让我们继续，这次对数据集进行一个有用的查询:</p><p id="9e6f" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">查询以显示每个国家/地区的 ios 应用程序用户数量:</p><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="5438" class="ni kw it mt b gy nj nk l nl nm">query = """<br/>        SELECT geo.country AS country, COUNT(DISTINCT user_pseudo_id) AS count<br/>        FROM `podcastapp-767c2.analytics_193436959.events_*` <br/>        WHERE device.operating_system = 'IOS'<br/>        GROUP BY geo.country<br/>        """</span></pre><p id="531c" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">但是，如果我想将 WHERE 子句指定为用户的输入，该怎么办呢？好了，向<strong class="lt iu">参数化查询</strong>问好:</p><blockquote class="ln lo lp"><p id="b515" class="lq lr ls lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在参数化查询中，占位符用于参数，参数值在执行时提供。这些通常用于防止 SQL 注入袭击。</p></blockquote><p id="38f7" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">要指定一个已命名的参数，使用字符<code class="fe mq mr ms mt b">@</code>后跟一个用户特定的变量名，例如<code class="fe mq mr ms mt b">@device_name</code>。</p><h2 id="a09c" class="ni kw it bd kx ob oc dn lb od oe dp lf mn of og lh mo oh oi lj mp oj ok ll ol bi translated">让我们看看如何将它作为 BigQuery API 请求的一部分:</h2><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="5c5e" class="ni kw it mt b gy nj nk l nl nm">from google.cloud import bigquery</span><span id="b349" class="ni kw it mt b gy om nk l nl nm">import os<br/>os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = 'podcastApp-e07020594640.json'</span><span id="1c5d" class="ni kw it mt b gy om nk l nl nm"><em class="ls"># simple non parameterized query</em><br/>client = bigquery.Client()</span><span id="666b" class="ni kw it mt b gy om nk l nl nm"><strong class="mt iu">query = """<br/>        SELECT geo.country AS country, COUNT(DISTINCT user_pseudo_id) AS count<br/>        FROM `podcastapp-767c2.analytics_193436959.events_*` <br/>        WHERE device.operating_system = @device_name<br/>        GROUP BY geo.country<br/>        """</strong></span><span id="e40a" class="ni kw it mt b gy om nk l nl nm"><strong class="mt iu">job_config = bigquery.QueryJobConfig(<br/>                query_parameters=[<br/>                        bigquery.ScalarQueryParameter("device_name", "STRING", 'IOS')])</strong></span><span id="5040" class="ni kw it mt b gy om nk l nl nm">query_res = client.query(query, <strong class="mt iu">job_config = job_config</strong>)  </span><span id="b046" class="ni kw it mt b gy om nk l nl nm"><strong class="mt iu"><em class="ls"># to print in the console</em><br/>results = {} <br/>for row in query_res:<br/>    results[row.country] = row.count<br/>print(results)</strong></span></pre><p id="a6d4" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">评估我们所做的修改:</p><ul class=""><li id="dc5f" class="nn no it lt b lu lv lx ly mn np mo nq mp nr mm ns nt nu nv bi translated">查询中的 WHERE 子句现在有了一个占位符<code class="fe mq mr ms mt b">@device_name</code></li><li id="5f9c" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">该查询现在使用在<code class="fe mq mr ms mt b">job_config</code>中指定的某些作业配置运行。</li><li id="3332" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">我们指定了一个名为<code class="fe mq mr ms mt b">device_name</code>的<code class="fe mq mr ms mt b">ScalarQueryParameter</code>，它的类型为<code class="fe mq mr ms mt b">STRING</code>，值为<code class="fe mq mr ms mt b">IOS</code>。</li></ul><p id="99f6" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">控制台中的输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/09c52104c9efb0988d6b2c24d6798aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*reU5huZ2RN9Z5NhRJGl3Fw.png"/></div></figure><p id="0ad0" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">这看起来很棒，除了让用户指定他们感兴趣的设备作为 API 调用的一部分对我们来说更有意义。幸运的是，我们已经知道(从我们的<a class="ae ku" rel="noopener" target="_blank" href="/deploying-h2o-models-as-apis-using-flask-42065a4fa567">之前的教程</a>中)如何接受用户输入并使用 Flask 将它们作为 API 请求的一部分<strong class="lt iu">插入。</strong></p><h1 id="ac22" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">将 REST APIs 和 BigQuery APIs 结合成一个令人惊叹的大碗:</h1><p id="9327" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">如果你完全遵循了之前和当前的教程，下面的代码将会非常有意义。</p><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="d315" class="ni kw it mt b gy nj nk l nl nm"><strong class="mt iu">from flask import Flask<br/>from flask_restful import Resource, Api, reqparse<br/></strong>from google.cloud import bigquery</span><span id="7624" class="ni kw it mt b gy om nk l nl nm">import os<br/>os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = 'podcastApp-e07020594640.json'</span><span id="4bbf" class="ni kw it mt b gy om nk l nl nm"><strong class="mt iu">app = Flask(__name__)<br/>api = Api(app)</strong></span><span id="f489" class="ni kw it mt b gy om nk l nl nm"><strong class="mt iu"># argument parsing<br/>parser = reqparse.RequestParser()<br/>parser.add_argument('user_device', choices = ('IOS', 'ANDROID', 'WEB'), help = 'Bad Choice: {error_msg}')<br/>parser.add_argument('countries', action = 'append')</strong></span><span id="d394" class="ni kw it mt b gy om nk l nl nm"># parameterized query- one is scalar and other is array <br/><strong class="mt iu">class PrintUserCount(Resource):<br/>    def get(self):<br/>        # parsing the input argument<br/>        args = parser.parse_args()<br/>        device = args['user_device']<br/>        countries = args['countries']</strong><br/>    <br/>        client = bigquery.Client()</span><span id="1f6a" class="ni kw it mt b gy om nk l nl nm">        query = """<br/>        SELECT geo.country AS country, COUNT(DISTINCT user_pseudo_id) AS count<br/>        FROM `podcastapp-767c2.analytics_193436959.events_*` <br/>        WHERE device.operating_system = <a class="ae ku" href="http://twitter.com/device" rel="noopener ugc nofollow" target="_blank">@device</a> <strong class="mt iu">AND geo.country IN UNNEST(</strong><a class="ae ku" href="http://twitter.com/countries" rel="noopener ugc nofollow" target="_blank"><strong class="mt iu">@countries</strong></a><strong class="mt iu">)</strong><br/>        GROUP BY geo.country<br/>        """</span><span id="1c18" class="ni kw it mt b gy om nk l nl nm">        job_config = bigquery.QueryJobConfig(<br/>                query_parameters=[<br/>                        bigquery.ScalarQueryParameter("device", "STRING", device),<strong class="mt iu"><br/>                        bigquery.ArrayQueryParameter("countries", "STRING", countries)</strong><br/>                        ]<br/>                )</span><span id="972d" class="ni kw it mt b gy om nk l nl nm">        query_res = client.query(query, job_config = job_config)<br/>    <br/>        # to store results in dataframe <br/>        results = {} #empty dataframe<br/>        for row in query_res:<br/>            results[row.country] = row.count<br/>       <strong class="mt iu"> return{'res': results}</strong><br/>        <br/><strong class="mt iu">api.add_resource(PrintUserCount, '/')<br/><br/>if __name__ == '__main__':<br/>    app.run(debug=True, port = 1123)</strong></span></pre><p id="2fd4" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">评估我们所做的一些修改:</p><ul class=""><li id="b605" class="nn no it lt b lu lv lx ly mn np mo nq mp nr mm ns nt nu nv bi translated">我们现在接受来自用户的两个输入:<br/> (1)设备类型，可以是<code class="fe mq mr ms mt b">IOS</code>、<code class="fe mq mr ms mt b">ANDROID</code>或<code class="fe mq mr ms mt b">WEB</code>、<br/> (2)您想要输出用户数量的国家列表。</li><li id="bdf8" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">作业配置必须将<code class="fe mq mr ms mt b">countries</code>占位符指定为<code class="fe mq mr ms mt b">ArrayQueryParameter</code>，因为这将是一个国家名称数组。</li><li id="6dd9" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">在访问 WHERE 子句中的<code class="fe mq mr ms mt b">countries</code>占位符时，记住要<code class="fe mq mr ms mt b">UNNEST</code>它。</li></ul><p id="5a40" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">最后，保存文件并使用顶部绿色的 run 按钮(或 Mac 上的 F5)运行它。正如您在 iPython 控制台中看到的，API 正在本地服务器上运行<code class="fe mq mr ms mt b"><a class="ae ku" href="http://127.0.0.1:12345/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:1123/</a></code>。</p><p id="df51" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">现在打开<strong class="lt iu"> Jupyter Notebook </strong>并输入以下代码来访问我们刚刚编写的 API。</p><pre class="kj kk kl km gt ne mt nf ng aw nh bi"><span id="9464" class="ni kw it mt b gy nj nk l nl nm">url = '<a class="ae ku" href="http://127.0.0.1:1123/'" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:1123/'</a><br/>params = {'user_device': 'IOS', <br/>          'countries':["China", "India", "Canada"]<br/>         }<br/>response = requests.get(url, params)<br/>response.json()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi op"><img src="../Images/28b96b284ee03d5df3b8cbad7883511b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2wzZf2GjqDamCYILqtc_Pg.png"/></div></div></figure><p id="2b20" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">瞧，我们有一个可用的 API，您可以使用它来查询您的 BigQuery 数据集，并接受来自用户的输入。</p><h1 id="e2a3" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">结束前的一些提示…</h1><ul class=""><li id="4732" class="nn no it lt b lu mz lx na mn oq mo or mp os mm ns nt nu nv bi translated">用生命保护您的 JSON 认证密钥。防止它落入坏人之手！</li><li id="bf25" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">为了获得轻松的体验，在从您最喜欢的客户端库中访问 SQL 查询之前，请始终在 BigQuery Web UI 中尝试/测试/运行您的 SQL 查询。</li><li id="2b7d" class="nn no it lt b lu nw lx nx mn ny mo nz mp oa mm ns nt nu nv bi translated">如需进一步阅读，请查看<a class="ae ku" href="https://github.com/googleapis/google-cloud-python#google-cloud-python-client" rel="noopener ugc nofollow" target="_blank"> API 参考文档</a>。</li></ul></div><div class="ab cl ot ou hx ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="im in io ip iq"><h1 id="32a1" class="kv kw it bd kx ky pa la lb lc pb le lf jz pc ka lh kc pd kd lj kf pe kg ll lm bi translated">结论</h1><p id="628f" class="pw-post-body-paragraph lq lr it lt b lu mz ju lw lx na jx lz mn nb mc md mo nc mg mh mp nd mk ml mm im bi translated">在本文中，我们学习了如何使用 Flask 和 Bigquery APIs 根据用户查询参数从 Bigquery 数据集中提取数据。我目前正在使用这些框架作为我先睹为快的播客数据集的一部分。这对于创建基于 user_id 和他们之前与其他播客节目的交互请求推荐的 API 非常有用。希望在不久的将来，我会分享这些脚本。</p><p id="c42a" class="pw-post-body-paragraph lq lr it lt b lu lv ju lw lx ly jx lz mn mb mc md mo mf mg mh mp mj mk ml mm im bi translated">直到下次:)</p></div></div>    
</body>
</html>