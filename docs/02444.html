<html>
<head>
<title>SQL-lise Elasticsearch Query For Data Analysis Using Docker, SQL Client, And Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker、SQL客户端和Python进行数据分析的SQL-lise Elasticsearch查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-lise-elasticsearch-query-for-data-analysis-using-docker-sql-client-and-python-part-1-bd4db524c452?source=collection_archive---------28-----------------------#2020-03-08">https://towardsdatascience.com/sql-lise-elasticsearch-query-for-data-analysis-using-docker-sql-client-and-python-part-1-bd4db524c452?source=collection_archive---------28-----------------------#2020-03-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cefb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本文中，我将解释使用简单的SQL语言分析Elasticsearch中的原始数据的两种不同方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/34b30fef633e55105624dd59e6cd5a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VDa_RBJfMyw15VZ99IcLqw.png"/></div></div></figure><blockquote class="ku kv kw"><p id="9932" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">关于弹性搜索:</strong></p></blockquote><p id="39cc" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">Elasticsearch是一个非SQL数据库，由一家名为Elastic的公司作为开源和商业产品提供。它用于存储和执行对数据的大数据分析，如web服务器日志、来自任何应用程序的事件数据或物联网中的传感器数据。</p><p id="dba4" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">elasticsearch之所以受欢迎，是因为它安装简单，无需任何额外的软件包就可以从几个节点扩展到数百个节点。它使用内置的REST API对数据执行查询。</p><p id="27aa" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">所以你听说了Elasticsearch可以做的所有很酷的事情，你决定在你的项目中使用它来存储和分析你的日志或事件或任何其他数据。但是您发现用JSON编写一个复杂的嵌套查询很麻烦，只是为了对存储在Elasticsearch中的数据进行简单的分析。</p><p id="f037" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">例如，Elasticsearch中的一个简单过滤查询如下所示:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="18e1" class="mc md it ly b gy me mf l mg mh">GET /_search<br/>{<br/> "query":{<br/>    "bool":{<br/>      "filter":[<br/>                {"term":{"status":"running"}},<br/>                {"range":{"last_updated_date":{"gte":"2019–12–31"}}}<br/>              ]<br/>      } <br/>   }<br/>}</span></pre><p id="8ec9" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">相同的查询可以用SQL编写，如下所示:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="1367" class="mc md it ly b gy me mf l mg mh">SELECT * <br/>FROM   sample_table <br/>WHERE  status = "running" <br/>       AND last_updated_date &gt; "2019–12–31"</span></pre><p id="685d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在，从Elasticsearch 6.3版本开始，其中一个插件X-Pack是开放的，并默认集成为Elasticsearch堆栈(ELK)中的一个功能。</p><p id="4a27" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">我们可以使用X-Pack插件提供的特性，使用类似SQL的查询来分析Elasticsearch中的数据，而不是编写复杂的嵌套JSON查询。</p><p id="a52a" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">我们将看看两种不同的方法:</p><ol class=""><li id="dc77" class="mi mj it la b lb lc le lf lu mk lv ml lw mm lt mn mo mp mq bi translated">使用通用数据库客户机(Dbeaver):连接到我们的Elasticsearch服务器，用SQL方言运行我们的查询。</li><li id="eb41" class="mi mj it la b lb mr le ms lu mt lv mu lw mv lt mn mo mp mq bi translated">使用Python模块(elasticsearch-dbapi和Sqlalchemy):连接到我们的elasticsearch服务器，并将数据查询到pandas dataframe中，以执行进一步的分析和可视化。</li></ol><blockquote class="ku kv kw"><p id="37bf" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">设置及要求:</strong></p></blockquote><ol class=""><li id="29f5" class="mi mj it la b lb lc le lf lu mk lv ml lw mm lt mn mo mp mq bi translated"><em class="kz"> Ubuntu OS: </em>我用Ubuntu做演示，但是所有需要的工具和模块也可以在其他OS上使用。</li><li id="41e7" class="mi mj it la b lb mr le ms lu mt lv mu lw mv lt mn mo mp mq bi translated">这是一个通用的数据库工具，也不支持SQL。你可以从<a class="ae mw" href="https://dbeaver.io/download/" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</li><li id="01ae" class="mi mj it la b lb mr le ms lu mt lv mu lw mv lt mn mo mp mq bi translated"><em class="kz"> Docker: </em>为快速旋转的麋鹿群在我的本地进行演示。你可以从<a class="ae mw" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">这里</a>下载安装。如果您已经运行了一个Elasticsearch实例，那么您可以跳过这一步。</li><li id="3709" class="mi mj it la b lb mr le ms lu mt lv mu lw mv lt mn mo mp mq bi translated"><em class="kz"> Jupyter notebook: </em>对于第二种方法，我们在获取后用python分析数据。</li></ol><blockquote class="ku kv kw"><p id="647e" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">第一种方法-分析来自数据库客户端的弹性搜索数据:</strong></p></blockquote><p id="a4e6" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">首先，我将克隆一个免费的git存储库，其中包含了在本地运行ELK集群所需的所有docker文件。您也可以从<a class="ae mw" href="https://github.com/deviantony/docker-elk" rel="noopener ugc nofollow" target="_blank">这里</a>下载/克隆这个库。</p><p id="43b6" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在进入克隆项目的目录，在docker命令下运行:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="aeba" class="mc md it ly b gy me mf l mg mh">$ sudo docker-compose up -d</span></pre><p id="2f96" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">如果一切正常，您将得到下面的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/cf864caad01ea0ffe732b82069795106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qe6eAH7LMjx9vuZb-RIA9w.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">docker-compose up命令的输出</p></figure><p id="8fdf" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">让我们使用以下命令检查所有服务是否都已启动:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="7be2" class="mc md it ly b gy me mf l mg mh">$ sudo docker-compose ps</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/f9c9305d86596ed8a05b735c1f67972a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sANzyVAPAVjNO67E2a8uog.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">docker-compose ps命令的输出</p></figure><p id="5c31" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">我们看到我们的Elasticsearch服务在端口9200运行，而Kibana在端口5601运行。</p><p id="d30d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">出于演示目的，我添加了一些示例数据。如果您不是在处理自己的数据，那么您也可以使用Kibana的主页进行同样的操作，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/a0e1020b2af6321b2dc625104b480dcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MTKGWvFwRTNcrGl8Pu-7g.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">用于添加示例数据的Kibana主页</p></figure><p id="83ac" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">首先，让我们使用Elasticsearch REST API格式获取数据。我正在使用<em class="kz"> curl </em>运行以下对飞行样本数据的查询:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="d404" class="mc md it ly b gy me mf l mg mh">curl -X GET "elastic:changeme@localhost:9200/_search?pretty" -H 'Content-Type: application/json' -d'<br/>{<br/>"query": { <br/> "bool": {<br/>   "filter": [ <br/>   { "term":  { "DestCountry": "IT" }},<br/>   { "range": { "timestamp": { "gte": "2020-03-06T21:08:31.000Z" }}}<br/>      ]<br/>    }<br/>  }<br/>}<br/>'</span></pre><p id="d481" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">以下是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/35a8d220aa84273d95a1c062073236ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IbDj_FAjMQndasBIAiLFJg.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">Elasticsearch REST API格式的简单提取查询的输出</p></figure><p id="cdf9" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">让我们用SQL语言运行同样的查询。为此，打开Dbeaver客户端并单击add connection:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/9f76b16595795cc29e0ee42a47902f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hqb1neWiQBUhaKt8WgskKQ.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">在Dbeaver中添加连接</p></figure><p id="2d4a" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在添加凭据和主机详细信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/5045a350e86c306532d0f5027d467675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*END0UFa_TbCxubT7BMpBbA.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">添加主机和凭据</p></figure><p id="fd12" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">Dbeaver将自动下载并安装连接到Elasticsearch服务器所需的驱动程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/ad9a98655b7ecae573168247d2987e05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*pgbN81cPR7oBpnN_LqVoSA.png"/></div><p class="my mz gj gh gi na nb bd b be z dk translated">通过Dbeaver自动下载驱动程序</p></figure><p id="0eaf" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">如果您面临驱动程序版本的任何问题，请在此从<a class="ae mw" href="https://www.elastic.co/downloads/past-releases#jdbc-client" rel="noopener ugc nofollow" target="_blank">下载所需版本。并将其添加到<em class="kz">编辑驱动</em>设置中，点击<em class="kz">确定</em>。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/0b2010360db84118798e3dc233a54fdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hen7vVqSxstGdFFmitMppQ.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">在编辑驱动程序设置中添加下载的驱动程序(jar文件)</p></figure><p id="bcf4" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在点击<em class="kz">测试连接</em>如果一切正常，您将得到如下所示的成功消息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/84e99b65b7733f81095a9439c459b371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UehI7u_mw1MRfG07r6eVjg.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">测试连接的成功消息</p></figure><p id="ceae" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在点击<em class="kz">完成。</em>您将在左侧看到与Elasticsearch服务器的连接:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/580a328e0fb45b88e10382fed9e99d4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Otm2olucN-vfhw-DgWPMYQ.png"/></div></div></figure><p id="4155" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在点击<em class="kz">新建SQL编辑器:</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/678bcddb74b9eec1a7b55a6f08ea2896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0R0mq13g8KA2hu5CtQ7hXg.png"/></div></div></figure><p id="d728" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">现在，我们将使用SQL语言编写相同的查询:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="5d05" class="mc md it ly b gy me mf l mg mh">SELECT<br/> *<br/>FROM<br/> kibana_sample_data_flights<br/>WHERE<br/> "DestCountry" = 'IT'<br/> AND "timestamp" &gt; '2020-03-06T21:08:31.000Z'</span></pre><p id="cda0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">瞧啊。！您将得到一个漂亮的表格格式的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/d5bcec4a46ff573e86bcf6bab26e5f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BeRjZRiia7-ZkcuYVmAu_Q.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">我们的SQL查询的最终输出</p></figure><blockquote class="ku kv kw"><p id="5ded" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">第二种方法-将数据查询到pandas dataframe: </strong></p></blockquote><p id="20d3" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">从Elastic search获取数据到python的老方法是使用<em class="kz"> Python Elasticsearch客户端</em>(此处阅读文档<a class="ae mw" href="https://elasticsearch-py.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank"/>)，它使用我们在<em class="kz"> Curl </em>中看到的相同的REST API查询格式。</p><p id="3c86" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">我们将通过使用简单的SQLAlchemy和elasticsearch-dbapi模块来简化这一点。</p><p id="da04" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">下面是示例代码:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="7c21" class="mc md it ly b gy me mf l mg mh">##Importing required library<br/>from sqlalchemy import create_engine<br/>import pandas as pd</span><span id="1fc1" class="mc md it ly b gy nm mf l mg mh">## Creating connection to our Elasticsearch server<br/>## format of connection string is: <br/>## "dialect://username:password@host:port/"<br/>connection_es=create_engine("""elasticsearch+<a class="ae mw" href="http://elastic:changeme@localhost:9200/" rel="noopener ugc nofollow" target="_blank">http://elastic:changeme@localhost:9200/</a>""")</span><span id="d5df" class="mc md it ly b gy nm mf l mg mh">##Fetching Data using SQL language and Pandas read_sql function<br/>result_data=pd.read_sql("""<br/>SELECT<br/> *<br/>FROM<br/> kibana_sample_data_flights<br/>WHERE<br/> "DestCountry" = 'IT'<br/> AND "timestamp" &gt; '2020-03-06T21:08:31.000Z'<br/>""", connection_es)</span></pre><p id="b1dc" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">在上面的代码中，我们使用了之前在SQL客户机上运行的相同的SQL查询。</p><p id="1bab" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">最后，我们将得到熊猫数据帧的输出，您可以使用该数据帧进行进一步的分析和可视化</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/e1fae51ca1c660a7ddd4a8d930585238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*io5XdBgC2VjkdOasHrbU_w.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">Python代码的最终输出</p></figure><blockquote class="ku kv kw"><p id="1bbe" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">结论:</strong></p></blockquote><p id="8de1" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated">在本文中，我们看到了如何使用简单的SQL语言而不是复杂的嵌套REST API查询来分析Elasticsearch中的数据。我们看到了从Elasticsearch查询数据的两种不同方式，一种是用DB client，另一种是用python。</p><p id="d7b0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lu li lj lk lv lm ln lo lw lq lr ls lt im bi translated"><strong class="la iu">我希望你喜欢我的文章，如果你想了解更多关于这个话题的信息，你可以在</strong><a class="ae mw" href="https://www.instagram.com/_aakash.rathore/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">insta gram</strong></a><strong class="la iu">或</strong><a class="ae mw" href="http://www.linkedin.com/in/aakash-rathore-big-data-engineer" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">LinkedIn</strong></a><strong class="la iu">上关注并留言给我。</strong></p></div></div>    
</body>
</html>