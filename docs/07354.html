<html>
<head>
<title>PostgreSQL: Rank function introduction.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL:秩函数介绍。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/postgresql-rank-function-introduction-c8ac008506dd?source=collection_archive---------50-----------------------#2020-06-03">https://towardsdatascience.com/postgresql-rank-function-introduction-c8ac008506dd?source=collection_archive---------50-----------------------#2020-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1755" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如果您尝试过分析一些应用程序数据库，您可能会看到如下内容。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/84dc9a2814b80fddd2e59120cf458ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Nj75S7F3u8VP5O1W"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">卢克·切瑟在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kw"><img src="../Images/78eda257b64d224c3dcabdc582d8f672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nnMu05zlQkegGzT_EOxjiw.png"/></div></div></figure><p id="c0c1" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">每个用户都可以在应用程序中发布多个帖子，我想一个超级简化版的 twitter 数据库应该是这样的。</p><p id="eae4" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">数据分析的问题来了。</p><p id="53b7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们如何才能发现每个用户第一次发帖的时间和内容？这种问题很常见，当你分析应用程序数据时，你想知道每个用户的第一个活动。通过实现这一点，我们应该得到如下表格。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/966a835398ff548a600e250cf859a1bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GNg2TQgbQqVb0VR5nSxPXQ.png"/></div></div></figure><p id="18d5" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您可以看到，现在我们提取了三个帖子，它们是用户从上一个表中首先创建的第一个帖子。该提取可以作为获得如下服务洞察的基础</p><ol class=""><li id="e19c" class="lu lv iq kz b la lb ld le lg lw lk lx lo ly ls lz ma mb mc bi translated">用户创建第一个帖子需要多长时间？</li><li id="57dd" class="lu lv iq kz b la md ld me lg mf lk mg lo mh ls lz ma mb mc bi translated">用户倾向于在第一篇帖子中使用什么样的词？</li></ol><p id="cd6c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">增强用户采取主动是激活服务的关键，所以你应该知道如何做到这一点。</p><h1 id="1006" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">编写 SQL</h1><p id="fc46" class="pw-post-body-paragraph kx ky iq kz b la na jr lc ld nb ju lf lg nc li lj lk nd lm ln lo ne lq lr ls ij bi translated">我们可以将所需的程序总结如下。</p><ol class=""><li id="fa75" class="lu lv iq kz b la lb ld le lg lw lk lx lo ly ls lz ma mb mc bi translated">按<code class="fe nf ng nh ni b">user_id</code>分组数据样本。</li><li id="a92b" class="lu lv iq kz b la md ld me lg mf lk mg lo mh ls lz ma mb mc bi translated">按每组中的<code class="fe nf ng nh ni b">id</code>降序排序。</li><li id="9f45" class="lu lv iq kz b la md ld me lg mf lk mg lo mh ls lz ma mb mc bi translated">从每组中提取 id 最小的样本。</li></ol><p id="de06" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">要仅使用 PostgreSQL 实现这一点，有一些可能的方法，但今天我们将使用其中实现的一个窗口函数，<a class="ae kv" href="https://www.postgresqltutorial.com/postgresql-rank-function/" rel="noopener ugc nofollow" target="_blank"> RANK 函数</a>。使用这个，我们可以简单容易地完成这个分析。该函数将用于分组和排序方法的列作为参数，并给出每个组的排名。它的语法是这样的。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="0076" class="nn mj iq ni b gy no np l nq nr">RANK() OVER (<br/>    [PARTITION BY partition_expression, ... ]<br/>    ORDER BY sort_expression [ASC | DESC], ...<br/>)</span></pre><p id="36a7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如你所见，我们将“如何分组”交给<code class="fe nf ng nh ni b">PARTITION BY</code>，将“如何排序”交给<code class="fe nf ng nh ni b">ORDER BY</code>。似乎很简单，对吗？让我们把这个排序函数应用到我们的问题中。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="bff0" class="nn mj iq ni b gy no np l nq nr">select<br/>  *,<br/>  rank() over (partition by user_id order by id)<br/>from<br/>  posts</span></pre><p id="8dbe" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><code class="fe nf ng nh ni b">PARTITION BY</code>使用<code class="fe nf ng nh ni b">user_id</code>将数据分组到每个用户中，<code class="fe nf ng nh ni b">ORDER BY</code> <code class="fe nf ng nh ni b">id</code>对每个用户组中的帖子进行排序。通过执行这个 SQL，我们可以获得下表。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/f5f10ee111341bcc3e3ac78b96aaa9f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3D9Qpld8kDp6LZPRJzGWww.png"/></div></div></figure><p id="a1f2" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您可以看到每个用户组的排名数字，为了从转换后的表格中只提取第一篇文章，我们可以利用<code class="fe nf ng nh ni b">where</code>来约束<code class="fe nf ng nh ni b">rank = 1</code>。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="c2c2" class="nn mj iq ni b gy no np l nq nr">select<br/>  *<br/>from<br/>(<br/>  select<br/>    *,<br/>    rank() over (partition by user_id order by id)<br/>  from<br/>    posts<br/> ) as tmp<br/> where<br/>   rank = 1</span></pre><p id="2f40" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这个 SQL 最终给出了我们想要的东西。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/dc7cf6330d6235c8caacdd81f3e5fd9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NTDNcasTOD_BNBjUL8ahYw.png"/></div></div></figure><p id="9354" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我希望您现在可以看到，使用 PostgreSQL 的 RANK 函数提取数据库中每个用户的第一篇文章是多么容易。基于这些提取的信息，你可以运行大量的分析来更好地理解你的用户。</p></div></div>    
</body>
</html>