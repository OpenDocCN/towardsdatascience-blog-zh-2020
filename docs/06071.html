<html>
<head>
<title>How to Scale Python on Every Major Cloud Provider</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在每个主要的云提供商上扩展Python</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-scale-python-on-every-major-cloud-provider-5e5df3e88274?source=collection_archive---------41-----------------------#2020-05-17">https://towardsdatascience.com/how-to-scale-python-on-every-major-cloud-provider-5e5df3e88274?source=collection_archive---------41-----------------------#2020-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="44a2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Python进行云计算的最佳实践</h2></div><p id="3cf8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用<a class="ae lb" href="https://github.com/pywren/pywren" rel="noopener ugc nofollow" target="_blank">皮雷恩</a>创造者<a class="ae lb" href="http://ericjonas.com/" rel="noopener ugc nofollow" target="_blank">艾瑞克·乔纳斯、</a> <strong class="kh ir">的话说，“云太他妈硬了！”</strong></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/4305dad73cf1a979c9541200e66f93db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JYrDrRLBkF23pdUl.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">云中的Python。</p></figure><p id="23b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你在笔记本电脑上开发了一个Python应用程序，并希望在云中扩展它(可能需要更多的数据或更多的GPU)，接下来的步骤就不清楚了，除非你有一个已经为你设置好的基础设施团队，“只使用kubernetes”并不那么简单。</p><p id="8276" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，您将选择AWS、GCP和Azure中的一个，并导航到管理控制台来筛选实例类型、安全组、现货价格、可用性区域、实例限制等等。一旦你解决了所有这些问题，并设法租了一些虚拟机，你仍然需要弄清楚如何在这些虚拟机上运行你的应用程序。我的Python脚本如何在一个10台机器的集群中准确地分配工作？此时，您可以尝试使用<a class="ae lb" href="https://spark.apache.org/docs/latest/api/python/index.html" rel="noopener ugc nofollow" target="_blank"> PySpark </a>或<a class="ae lb" href="https://mpi4py.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> mpi4py </a>或<a class="ae lb" href="http://www.celeryproject.org/" rel="noopener ugc nofollow" target="_blank"> Celery </a>来重写您的应用程序。</p><p id="a09a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果失败了，你将建立一个全新的分布式系统，就像优步和Lyft最近用<a class="ae lb" href="https://uber.github.io/fiber/introduction/" rel="noopener ugc nofollow" target="_blank"> Fiber </a>和<a class="ae lb" href="https://eng.lyft.com/introducing-flyte-cloud-native-machine-learning-and-data-processing-platform-fb2bb3046a59" rel="noopener ugc nofollow" target="_blank"> Flyte </a>所做的那样。在这两种情况下，要么重写应用程序，要么构建新的分布式系统，或者两者兼而有之。这一切都是为了加速你在云中的Python脚本。</p><p id="07ae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将介绍如何使用<a class="ae lb" href="https://github.com/ray-project/ray" rel="noopener ugc nofollow" target="_blank"> Ray </a>在这些云提供商上启动集群和扩展Python，只需几个命令。</p><p id="8df5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是图表。<strong class="kh ir">第一步</strong>是开发你的Python应用。这通常发生在您的笔记本电脑上，但是如果您愿意，也可以在云中进行。第二步是在你选择的云提供商上启动一个集群。第三步是在任何你想去的地方运行你的应用程序(你的笔记本电脑或者云端)。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ls"><img src="../Images/c954dfcf3a86b8803c266a57ca65ea1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j1FfShMsqWHMFRI4.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">通过三个步骤在任何云提供商上扩展您的Python应用程序。<strong class="bd lt">第一步:</strong>在本地开发你的应用程序(或者在云中，如果你愿意的话)。<strong class="bd lt">步骤2: </strong>在您选择的云提供商上启动集群。<strong class="bd lt">步骤3: </strong>在集群上运行您的应用程序！</p></figure><h1 id="19a0" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">设置</h1><p id="3d81" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">首先，安装一些Python依赖项。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="cdbd" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir">pip install -U ray \<br/>               boto3 \<br/>               azure-cli \<br/>               azure-core \<br/>               google-api-python-client</strong></span></pre><p id="0f8c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，为您选择的云提供商配置凭证。如果您已经设置为从命令行使用云提供商，则可以跳过这一步。</p><ul class=""><li id="ff2d" class="nb nc iq kh b ki kj kl km ko nd ks ne kw nf la ng nh ni nj bi translated"><strong class="kh ir"> AWS: </strong>按照<a class="ae lb" href="http://boto3.readthedocs.io/en/latest/guide/configuration.html" rel="noopener ugc nofollow" target="_blank">boto文档</a>中的描述在<code class="fe nk nl nm ms b">~/.aws/credentials</code>中配置您的凭证。</li><li id="6631" class="nb nc iq kh b ki nn kl no ko np ks nq kw nr la ng nh ni nj bi translated"><strong class="kh ir"> Azure: </strong>用<code class="fe nk nl nm ms b">az login</code>登录，然后用<code class="fe nk nl nm ms b">az account set -s &lt;subscription_id&gt;</code>配置你的凭证。</li><li id="1b28" class="nb nc iq kh b ki nn kl no ko np ks nq kw nr la ng nh ni nj bi translated"><strong class="kh ir"> GCP: </strong>按照<a class="ae lb" href="https://cloud.google.com/docs/authentication/getting-started" rel="noopener ugc nofollow" target="_blank">文档</a>中的描述设置<code class="fe nk nl nm ms b">GOOGLE_APPLICATION_CREDENTIALS</code>环境变量。</li></ul><p id="02af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">射线簇发射器使用了一个配置文件，看起来像这样</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ns nt l"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">与<a class="ae lb" href="https://docs.ray.io/en/master/autoscaling.html" rel="noopener ugc nofollow" target="_blank">射线簇发射器</a>一起使用的最小簇配置文件。</p></figure><p id="d986" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，您可以指定所有内容，包括要运行的设置命令、要使用的实例类型、要rsync的文件、自动缩放策略等等。</p><p id="c7b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获取一个稍微完整一点的示例，带有如下的附加可配置字段。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="0827" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># AWS</strong><br/>wget <a class="ae lb" href="https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/dafd4c6bd26fe4599dc3c6b05e80789188b3e2e5/aws-config.yaml" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/dafd4c6bd26fe4599dc3c6b05e80789188b3e2e5/aws-config.yaml</a><br/><strong class="ms ir"># Azure</strong><br/>wget <a class="ae lb" href="https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/dafd4c6bd26fe4599dc3c6b05e80789188b3e2e5/azure-config.yaml" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/dafd4c6bd26fe4599dc3c6b05e80789188b3e2e5/azure-config.yaml</a><br/><strong class="ms ir"># GCP</strong><br/>wget <a class="ae lb" href="https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/1846cbf971d1cd708b3d29d9ae50ad882fbaac50/gcp-config.yaml" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/1846cbf971d1cd708b3d29d9ae50ad882fbaac50/gcp-config.yaml</a></span></pre><p id="b2d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您需要对上面的配置文件做一些小的修改:</p><ul class=""><li id="0345" class="nb nc iq kh b ki kj kl km ko nd ks ne kw nf la ng nh ni nj bi translated">用合适的密钥文件替换<code class="fe nk nl nm ms b">~/.ssh/id_rsa</code>和<code class="fe nk nl nm ms b">~/.ssh/id_rsa.pub</code>。</li><li id="aa85" class="nb nc iq kh b ki nn kl no ko np ks nq kw nr la ng nh ni nj bi translated"><strong class="kh ir"> GCP: </strong>设置合适的<code class="fe nk nl nm ms b">project_id</code>。</li></ul><h1 id="1711" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">步骤1:创建一个Python应用程序</h1><p id="8b3d" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">定义一个我们想要扩展的简单Python脚本。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ns nt l"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">一个简单的Python应用程序，可以在你的笔记本电脑或云中运行，并跟踪执行任务的机器的IP地址。这个脚本使用<a class="ae lb" href="https://github.com/ray-project/ray" rel="noopener ugc nofollow" target="_blank">射线</a>来并行化计算。</p></figure><p id="7341" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以如下运行这个示例(实际上是一个稍微完整的示例)。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="27d3" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># Fetch the example.</strong><br/>wget <a class="ae lb" href="https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/4313660c0bd40f8bd909f70c1e0abc4be8584198/script.py" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/robertnishihara/a9ce1d0d434cd52dd9b07eb57f4c3476/raw/4313660c0bd40f8bd909f70c1e0abc4be8584198/script.py</a><strong class="ms ir"># Run the script.</strong><br/>python script.py</span></pre><p id="a0d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到以下输出。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="52fa" class="mw lv iq ms b gy mx my l mz na">This cluster consists of<br/>    1 nodes in total<br/>    16.0 CPU resources in totalTasks executed<br/>    10000 tasks on XXX.XXX.X.XXX</span></pre><p id="4688" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，在光线簇上运行相同的脚本。这些说明适用于AWS。要使用Azure或GCP，只需将两行中的<code class="fe nk nl nm ms b">aws-config.yaml</code>替换为<code class="fe nk nl nm ms b">azure-config.yaml</code>或<code class="fe nk nl nm ms b">gcp-config.yaml</code>。</p><h1 id="cbea" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">步骤2:启动集群</h1><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="210f" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># AWS</strong><br/>ray up -y aws-config.yaml<br/><strong class="ms ir"># Azure</strong><br/>ray up -y azure-config.yaml<br/><strong class="ms ir"># GCP</strong><br/>ray up -y gcp-config.yaml</span></pre><h1 id="6806" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">步骤3:在集群上运行脚本</h1><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="a8b9" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># AWS</strong><br/>ray submit aws-config.yaml script.py<br/><strong class="ms ir"># Azure</strong><br/>ray submit azure-config.yaml script.py<br/><strong class="ms ir"># GCP</strong><br/>ray submit gcp-config.yaml script.py</span></pre><p id="b72a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到以下输出。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="4df4" class="mw lv iq ms b gy mx my l mz na">This cluster consists of<br/>    3 nodes in total<br/>    6.0 CPU resources in totalTasks executed<br/>    3561 tasks on XXX.XXX.X.XXX<br/>    2685 tasks on XXX.XXX.X.XXX<br/>    3754 tasks on XXX.XXX.X.XXX</span></pre><p id="444b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果它说只有一个节点，那么您可能需要多等一会儿，让其他节点启动。</p><p id="0f5d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，10，000个任务在三台机器上运行。</p><p id="cad9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以连接到集群，使用以下命令之一进行探索。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="1aab" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># Connect to the cluster (via ssh).# AWS</strong><br/>ray attach aws-config.yaml<br/><strong class="ms ir"># Azure</strong><br/>ray attach azure-config.yaml<br/><strong class="ms ir"># GCP</strong><br/>ray attach gcp-config.yaml</span></pre><h1 id="2d15" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">关闭集群</h1><p id="6f48" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">完成后，不要忘记关闭集群！</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="cc4f" class="mw lv iq ms b gy mx my l mz na"><strong class="ms ir"># AWS</strong><br/>ray down -y aws-config.yaml<br/><strong class="ms ir"># Azure</strong><br/>ray down -y azure-config.yaml<br/><strong class="ms ir"># GCP</strong><br/>ray down -y gcp-config.yaml</span></pre><h1 id="7b2e" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">进一步的细节</h1><p id="abdd" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">想要增加对新云提供商的支持吗？只需扩展<a class="ae lb" href="https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/node_provider.py" rel="noopener ugc nofollow" target="_blank"> NodeProvider类</a>，这通常需要200-300行代码。看看AWS 的<a class="ae lb" href="https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/aws/node_provider.py" rel="noopener ugc nofollow" target="_blank">实现。</a></p><ul class=""><li id="171b" class="nb nc iq kh b ki kj kl km ko nd ks ne kw nf la ng nh ni nj bi translated">了解更多关于<a class="ae lb" href="https://docs.ray.io/en/master/autoscaling.html" rel="noopener ugc nofollow" target="_blank">射线集群发射器</a>的信息。</li><li id="9ee1" class="nb nc iq kh b ki nn kl no ko np ks nq kw nr la ng nh ni nj bi translated">从<a class="ae lb" href="https://docs.ray.io/en/master/" rel="noopener ugc nofollow" target="_blank">文档</a>、<a class="ae lb" href="https://github.com/ray-project/ray" rel="noopener ugc nofollow" target="_blank"> GitHub </a>和<a class="ae lb" href="https://twitter.com/raydistributed" rel="noopener ugc nofollow" target="_blank"> Twitter </a>中了解更多关于Ray的信息。</li><li id="b970" class="nb nc iq kh b ki nn kl no ko np ks nq kw nr la ng nh ni nj bi translated">了解如何缩放<a class="ae lb" href="https://docs.ray.io/en/latest/raysgd/raysgd.html" rel="noopener ugc nofollow" target="_blank">机器学习训练</a>、<a class="ae lb" href="https://docs.ray.io/en/master/tune.html" rel="noopener ugc nofollow" target="_blank">超参数调优</a>、<a class="ae lb" href="https://docs.ray.io/en/master/rayserve/overview.html" rel="noopener ugc nofollow" target="_blank">模型服务</a>、<a class="ae lb" href="https://docs.ray.io/en/master/rllib.html" rel="noopener ugc nofollow" target="_blank">强化学习</a>。</li></ul><p id="b921" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nu">原贴</em> <a class="ae lb" href="https://medium.com/distributed-computing-with-ray/how-to-scale-python-on-every-major-cloud-provider-12b3bde01208" rel="noopener"> <em class="nu">此处</em> </a> <em class="nu">。</em></p></div></div>    
</body>
</html>