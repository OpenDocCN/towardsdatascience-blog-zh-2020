<html>
<head>
<title>Building a Regression Testing Framework for your SQL Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为您的 SQL 数据库构建回归测试框架</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-regression-test-your-sql-database-c6c8d66848c5?source=collection_archive---------12-----------------------#2020-03-03">https://towardsdatascience.com/how-to-regression-test-your-sql-database-c6c8d66848c5?source=collection_archive---------12-----------------------#2020-03-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d0f0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用 Python 构建 SQL 回归框架</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f0fafec5ede8f1c1bf1059b89acb59e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VXL5ZbPWxsWZ6AAc"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="8650" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当谈到测试软件时，有无数种方法可以做。回归测试就是其中的一种方法，它本质上是一种比较软件的两个不同版本的输出的方法。</p><p id="7913" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比较软件的两个版本的输出将很快突出相同点和不同点。如果软件中的一个变化导致了一个意想不到的不同，它会立即被突出显示。这同样适用于预期有差异但没有发现的情况。</p><p id="a1a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着解决方案规模的增长，以及它们的输出在数量和复杂性上的增加，必须建立一个框架来允许这种类型的测试快速、轻松地执行。手动测试容易出错且耗时。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2272" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">这个想法</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/42b9cad826e1aac1d017b938c6c2290a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C8HtaBkrJSmytKov"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@campaign_creators?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">活动创作者</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="59d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个想法非常简单。构建一个 python 脚本，允许我们快速有效地比较两个 SQL 数据库。该脚本需要尽可能可扩展和可配置。</p><p id="3ae1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更具体地说，该脚本应该允许多环境设置和多数据集比较。换句话说，用户应该能够设置不同的环境和要执行的 SQL 命令，然后通过几个配置更改就可以运行它。</p><p id="06ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，让我们进入细节。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="caff" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">魔力</h1><h2 id="a9a6" class="mv md it bd me mw mx dn mi my mz dp mm li na nb mo lm nc nd mq lq ne nf ms ng bi translated">连接到 SQL Server</h2><p id="8b71" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">连接到 SQL server 很简单，但是根据 SQL server 的类型，您需要使用不同的库。对于这个例子，我使用的是 Microsoft SQL server，因此使用的是 pyodbc 库。</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="6a5b" class="mv md it nn b gy nr ns l nt nu">import pyodbc<br/>import pandas as pd<br/>Env1 = pyodbc.connect('Driver = {SQL Server}; Server = ServerName; Database = DatabaseName; Trusted_Connection = yes;')<br/>SQL = 'SELECT * FROM Table1'<br/>print(pd.read_sql_query(SQL, con = Env1)</span></pre><h2 id="8d5e" class="mv md it bd me mw mx dn mi my mz dp mm li na nb mo lm nc nd mq lq ne nf ms ng bi translated">比较两个数据帧</h2><p id="0bf3" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">这里没有必要重新发明轮子；我们将使用现有的库来比较数据集。</p><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="cde4" class="mv md it nn b gy nr ns l nt nu">import datacompy<br/>import pandas as pd<br/>df1 = pd.read_csv('FL_insurance_sample.csv')<br/>df2 = pd.read_csv('FL_insurance_sample - Copy.csv')<br/>compare = datacompy.Compare(<br/>    df1,<br/>    df2,<br/>    join_columns='policyID',  #You can also specify a list of columns eg ['policyID','statecode']<br/>    abs_tol=0, #Optional, defaults to 0<br/>    rel_tol=0, #Optional, defaults to 0<br/>    df1_name='Original', #Optional, defaults to 'df1'<br/>    df2_name='New' #Optional, defaults to 'df2'<br/>)<br/>print(compare.report())</span></pre><h2 id="9bc7" class="mv md it bd me mw mx dn mi my mz dp mm li na nb mo lm nc nd mq lq ne nf ms ng bi translated">有趣的是</h2><p id="ac71" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">这个练习有趣的部分是把所有的东西放在一起。本质上，我们需要创建一个要执行的 SQL 语句列表，以及用于比较的结果的相关数据键。</p><p id="50fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦定义好，我们就可以遍历 SQL 语句列表，在我们的两个环境中执行每个语句。一旦我们得到结果，使用我们的比较库，我们可以评估是否有任何差异。为了提高效率和减少返回的数据，我们将在尝试获得更细粒度的反馈之前，首先进行“哑”的同类比较。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="39ea" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">代码</h1><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="85c4" class="mv md it nn b gy nr ns l nt nu">import pyodbc, datacompy<br/>import pandas as pd</span><span id="ef3f" class="mv md it nn b gy nv ns l nt nu">###############Set up your Environment connections#########################<br/>Env1 = pyodbc.connect('Driver = {SQL Server}; Server = ServerName; Database = DatabaseName; Trusted_Connection = yes;')<br/>Env2 = pyodbc.connect('Driver = {SQL Server}; Server = ServerName2; Database = DatabaseName2; Trusted_Connection = yes;')</span><span id="9a6d" class="mv md it nn b gy nv ns l nt nu">########Environment Set Up###################################<br/>Original = Env1<br/>Target = Env2</span><span id="b23c" class="mv md it nn b gy nv ns l nt nu">######SQL Statements to Execute#############################<br/>SQLStatement = [<br/>    #[ReportName, Stored Proc, [data keys]]<br/>    ['Report1','EXEC StoredProc1 <a class="ae ky" href="http://twitter.com/Var1" rel="noopener ugc nofollow" target="_blank">@Var1</a> = "Woop" , <a class="ae ky" href="http://twitter.com/Var2" rel="noopener ugc nofollow" target="_blank">@Var2</a> = "Woop2"', ['Key1', 'Key2']],<br/>    ['Report2','EXEC StoredProc2 <a class="ae ky" href="http://twitter.com/Var1" rel="noopener ugc nofollow" target="_blank">@Var1</a> = "Woop", <a class="ae ky" href="http://twitter.com/Var2" rel="noopener ugc nofollow" target="_blank">@Var2</a> = "Woop2"', ['Key3','Key4']]<br/>]</span><span id="65c0" class="mv md it nn b gy nv ns l nt nu">###############################<br/>def compareResults(reportName, df1, df2, joinOnKeys):<br/>    if df1.equals(df2) == True:<br/>        print('###########################################################')<br/>        print(reportName, 'Success')<br/>    else:<br/>        print('###########################################################')<br/>        print(reportName, 'Fail')<br/>        compare = datacompy.Compare(<br/>            df1,<br/>            df2,<br/>            join_columns= joinOnKeys,<br/>            abs_tol = 0, <br/>            rel_tol = 0,<br/>            df1_name= 'Original',<br/>            df2_name= 'Target'<br/>        )<br/>        print(compare.report(sample_count=20))</span><span id="a9e0" class="mv md it nn b gy nv ns l nt nu">for i in SQLStatement:<br/>    results1 = pd.read_sql_query(i[1], con = Original)<br/>    results2 = pd.read_sql_query(i[1], con = Target)<br/>    compareResults(i[0], results1, results2, i[2])</span></pre><h2 id="bc24" class="mv md it bd me mw mx dn mi my mz dp mm li na nb mo lm nc nd mq lq ne nf ms ng bi translated">示例输出</h2><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="a2e4" class="mv md it nn b gy nr ns l nt nu">###########################################################<br/>Report1 Success</span><span id="38bf" class="mv md it nn b gy nv ns l nt nu">###########################################################<br/>Report2 Fail</span><span id="3f71" class="mv md it nn b gy nv ns l nt nu">DataComPy Comparison<br/>--------------------<br/>DataFrame Summary<br/>-----------------<br/>DataFrame  Columns   Rows<br/>0  Original       18  36634<br/>1       New       18  36634Column Summary</span><span id="c19d" class="mv md it nn b gy nv ns l nt nu">--------------<br/>Number of columns in common: 18<br/>Number of columns in Original but not in New: 0<br/>Number of columns in New but not in Original: 0</span><span id="381c" class="mv md it nn b gy nv ns l nt nu">Row Summary<br/>-----------<br/>Matched on: policyid<br/>Any duplicates on match values: No<br/>Absolute Tolerance: 0<br/>Relative Tolerance: 0<br/>Number of rows in common: 36,634<br/>Number of rows in Original but not in New: 0<br/>Number of rows in New but not in Original: 0<br/>Number of rows with some compared columns unequal: 2<br/>Number of rows with all compared columns equal: 36,632</span><span id="f6b5" class="mv md it nn b gy nv ns l nt nu">Column Comparison<br/>-----------------<br/>Number of columns compared with some values unequal: 2<br/>Number of columns compared with all values equal: 16<br/>Total number of values which compare unequal: 2</span><span id="b691" class="mv md it nn b gy nv ns l nt nu">Columns with Unequal Values or Types<br/>------------------------------------<br/>Column Original dtype New dtype  # Unequal   Max Diff  # Null Diff<br/>0  eq_site_limit        float64   float64          1  190601.40            0<br/>1  hu_site_limit        float64   float64          1   79375.76            0</span><span id="d6d0" class="mv md it nn b gy nv ns l nt nu">Sample Rows with Unequal Values<br/>-------------------------------<br/>policyid  eq_site_limit (Original)  eq_site_limit (New)<br/>2    206893                  190724.4                123.0<br/>policyid  hu_site_limit (Original)  hu_site_limit (New)<br/>3    333743                  79520.76                145.0</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1b93" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="63d4" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">好了，伙计们！用不到 50 行代码，您就有了一个完整的 SQL 回归测试框架来帮助您确定下一个候选版本的有效性。</p><p id="2b23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您所需要做的就是选择正确的两个环境，并定义您想要执行的存储过程的列表。</p><p id="eeac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会用不同的方式做事情吗，或者对改进这段代码有什么建议吗？让我知道！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="3ea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你觉得这篇博客有用，你可能也会喜欢:</p><div class="nw nx gp gr ny nz"><a rel="noopener follow" target="_blank" href="/building-a-python-ui-for-comparing-data-13c10693d9e4"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">构建用于比较数据的 Python UI</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">如何快速让您的非技术团队能够比较数据</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on ks nz"/></div></div></a></div><div class="nw nx gp gr ny nz"><a rel="noopener follow" target="_blank" href="/automate-ui-testing-with-pyautogui-in-python-4a3762121973"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">用 Python 中的 PyAutoGUI 实现自动化 UI 测试</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">回归测试你的用户界面的一个快速简单的方法</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oo l ok ol om oi on ks nz"/></div></div></a></div><div class="nw nx gp gr ny nz"><a href="https://medium.com/financeexplained/from-excel-and-pandas-dataframes-to-sql-f6e9c6b4a36a" rel="noopener follow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">从 Excel 和 Pandas 数据框架到 SQL</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">如何使用您的 SQL 知识来利用 Python 的熊猫</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">medium.com</p></div></div><div class="oi l"><div class="op l ok ol om oi on ks nz"/></div></div></a></div></div></div>    
</body>
</html>