# 实时特征工程和 ML 模型的 NoSQL

> 原文：<https://towardsdatascience.com/nosql-for-real-time-feature-engineering-and-ml-models-93d057c0a7b8?source=collection_archive---------29----------------------->

![](img/5a82610f632d0b40dde1f63beba1b5f8.png)

[来源](https://pixy.org/223930/)

## 使用流式数据构建用户配置文件

在我数据科学职业生涯的大部分时间里，我使用从数据仓库或湖泊中获取的数据来构建机器学习模型。使用这种方法，您可以通过应用 SQL 命令将几个事件转换成一个用户摘要，从而为每个用户创建一个特征向量。但是，这种方法的一个主要问题是，它是一个批处理操作，如果从应用程序发送的事件需要几分钟或几小时才能在数据存储中显示出来，则可能不包括用户的最新事件。

如果您需要在应用预测模型时使用最近的数据点，则可能有必要构建一个流数据管道，以近乎实时地应用特征工程来构建用户摘要。例如，一个电子商务网站可能希望根据 ML 模型的输出向用户发送一个通知，通知他们将商品添加到购物车中，但不结账。这个用例需要一个模型来使用基于最近 web 会话活动的数据，由于批处理和 ETL 操作引入的延迟，这在数据仓库中可能不可用。对于这种情况，为了提供最新的模型预测以确定是否向用户发送通知，可能有必要基于流数据集逐步建立用户概要。

我是一名为移动游戏发行商工作的数据科学家，我们会遇到类似的场景，我们需要使用最近的会话数据来确定如何为用户提供个性化的体验。我最近一直在探索 NoSQL 数据存储，将其作为一种构建近实时数据产品的方式，这些产品以最小的延迟执行特征工程和模型应用。虽然这篇文章将使用 Python 完成一个示例管道，但是想要亲自动手构建生产级系统的数据科学家应该探索 Java 或 Go，正如我在这里讨论的。在这篇文章中，我将介绍数据科学领域的 NoSQL，介绍使用 Redis 的选项，并演示一个使用 Redis 执行实时特征工程的示例 Flask 应用程序。

## NoSQL 数据科学奖

NoSQL 数据存储是关系数据库的一种替代方式，它专注于最小化延迟，同时限制可以执行的操作类型。虽然有很多服务都属于 NoSQL 的概念，但最常见的实现之一是键值数据存储。使用键值存储，您可以以亚毫秒级的延迟从数据存储中保存和检索元素，但不能查询数据存储中的内容。您需要一个键作为保存值的索引，比如用户 ID，并且在检索值时使用相同的键。虽然这组操作对于习惯于使用关系数据库的数据科学家来说似乎是限制性的，但它提供的延迟和吞吐量性能比传统数据库快几个数量级。

数据科学家可能不熟悉这种类型的工作流，在这种工作流中，您可以对数据集执行创建-读取-更新-删除(CRUD)操作，因为使用批处理是很常见的，在批处理中，可以使用 SQL 将事件转换为用户摘要。对于键值数据存储，没有可用于聚集数据集的 SQL 命令，相反，用户概要需要以增量方式构建，其中由系统接收的新数据用于更新用户记录，例如每当用户在电话上打开游戏时递增会话计数。

使用 NoSQL 数据存储使得数据产品能够在接收到新数据时近乎实时地更新用户概要。这意味着，对于每个新数据点，用户的特征向量将只滞后几秒钟，而使用传统的数据仓库工作流时则需要几分钟或几小时。使用这种方法时有一个权衡，即与使用 SQL 数据库时可用的选项相比，您可以使用的功能类型是有限的。例如，在增量更新数据时，您不能计算非重复值或中间值，因为您是在处理单个事件，而不是用户的历史事件。然而，大多数使用实时数据的系统也将包括来自延迟过程的特征，该特征提供更完整的用户简档。例如，对于流数据，不可能计算用户播放的模式的不同数量(除非使用 1-hot 特征编码)，但可以有一个批处理过程来计算该值，该值带有附加到特征向量的额外滞后。

当数据科学家需要构建增量更新而非批处理的用户配置文件时，他们应该探索 NoSQL 解决方案。这种工作流的一个常见用例是，当您需要根据最近的会话数据为用户提供个性化的治疗时。例如，先前选择了通知的用户可能更有可能在新游戏中与未来的通知进行交互。移动游戏发行商可以利用该会话数据来为用户提供个性化体验。

为了提供一个具体的例子，我们将使用 Kaggle NHL 数据集来提供一个流数据源，曲棍球运动员的个人资料将根据实时数据源进行增量更新，并通过 web REST 调用来实现。这个示例应用程序的输出将是存储在 Redis 中的用户配置文件，然后可以用于实时应用 ML 模型。我们将关注特征工程步骤而不是模型应用步骤，但是展示了用户简档如何可以用于模型预测。

在这个练习中，我们将使用 Redis 作为我们的 NoSQL 解决方案。虽然 Redis 有类似的替代方案，如 Memcached，但 Redis 是一种跨多种编程语言工作的标准，并在流行的云基础设施上管理实现。Redis 应该被视为一种短暂的缓存，这意味着如果您的用户配置文件需要长期持久性，它可能不是最佳方法。然而，如果你正在构建面向新用户的 ML 模型，这是一个很好的选择。

对于数据科学项目的 NoSQL，通常使用数据存储根据传递给数据产品的实时数据来更新用户配置文件。对于流数据，这个端点可以设置为将数据作为 REST 命令进行处理，或者设置为处理来自 Kinesis 和 Kafka 等工具的数据流。我们将通过一个样例部署来设置一个 REST 端点，该端点使用 Redis 递增地更新用户配置文件。

## Redis 部署

有各种不同的选项来设置 Redis 实例，该实例将用于为您的机器学习项目缓存数据。以下是一些可用的不同选项。

1.  模拟实现:Python 的 [fakeredis](https://pypi.org/project/fakeredis/) ，Java 的 [jedis-mock](https://github.com/fppt/jedis-mock)
2.  **本地部署:**在本地构建和运行，或者使用 [Docker](https://redislabs.com/get-started-with-redis/#optionc)
3.  **托管部署:**在云中的集群上运行 Redis
4.  **托管部署:**AWS elastic cache、GCP Memorystore、 [Redis Cloud](https://redislabs.com/redis-enterprise-cloud/overview/)

当开始使用 Redis 时，使用模拟实现对于学习 Redis 的接口非常有用。此外，模拟实现对于为您的应用程序设置单元测试非常有用。一旦您想了解应用程序的潜在吞吐量，最好直接或通过 Docker 迁移到运行在您机器上的 Redis 的本地实例。这将使您能够测试与 Redis 的连接，并更好地了解应用程序的概要分析。

一旦您希望将系统投入生产，那么您将希望迁移到 Redis 集群，它可以是云平台上的托管解决方案，您负责在机器集群上提供和监控 Redis，或者您可以使用托管解决方案来处理维护集群的所有开销，同时提供相同的 Redis 接口。托管解决方案非常适合在生产应用程序中启动和运行 Redis，但是在为 Redis 选择托管解决方案还是托管解决方案或其他 NoSQL 解决方案时，需要考虑一些因素:

1.  您的延迟要求是什么？
2.  你的内存需求是什么？
3.  您的吞吐量要求是什么？

使用托管解决方案，您可以确保 Redis 集群与您的数据产品位于同一位置，以确保您的服务和 Redis 实例之间的最小延迟。使用 GCP Memorystore，您可以将这两个集群配置为位于同一个可用性区域内，这将导致 Redis 命令的亚毫秒级延迟，但是在使用托管方法时，您将无法配置您的实例。

决定托管还是托管方法的可能因素是群集的预期成本。使用 Memorystore 时，你需要支付每 GB 每小时的费用，并且根据容量有不同的定价等级。读取或写入命令也可能会有变化，这是 AWS 上 DynamoDB 定价的一部分。如果成本看起来合理，那么使用托管选项可能是首选，因为它可以减少您的团队维护集群所需的开发工作量。如果您有较大的内存需求，例如每个区域超过 1TB，那么托管解决方案可能无法扩展到您的使用情形。

在这篇文章中，我们将坚持 Redis 的模拟实现，保留与 Python 编码相关的所有内容，因为 Redis 是一个庞大的主题，读者应该在这篇文章之后更详细地探索它。

## Python 中的实时应用程序

为了实时模拟构建特征向量，我们将使用 Kaggle NHL [数据集](https://www.kaggle.com/martinellis/nhl-game-data)。这个数据集中的 *game_skater_stats.csv* 文件提供了球员级别的比赛摘要，比如一场比赛中完成的射门次数、进球次数、助攻次数等。我们将读入该文件，将行过滤到单个播放器，然后遍历事件并将它们发送到 Flask 端点，该端点将更新用户配置文件。发送事件后，我们还将调用端点，使用简单的线性回归模型来获取更新的玩家分数。目标是展示如何设置 Flask 端点来处理流数据集并为实时模型预测服务。这篇文章的完整代码可以在 GitHub 的 Jupyter 笔记本上找到。

[](https://www.kaggle.com/martinellis/nhl-game-data) [## NHL 游戏数据

### 游戏、团队、玩家和游戏信息，包括 x、y 坐标

www.kaggle.com](https://www.kaggle.com/martinellis/nhl-game-data) 

对于想开始使用 Python 的 Redis 新手读者来说，参考 [redis-py 文档](https://redis-py.readthedocs.io/)以获得关于 Python 接口的更多细节是很有用的。在本文中，我们将使用一个模拟 Redis 服务器来演示基本功能，该服务器实现了该接口的一个子集。要开始使用，请安装以下 Python 库:

```
pip install pandas
pip install fakeredis
pip install flask
```

接下来，我们将使用 Redis 运行 CRUD 命令。下面的代码片段展示了如何启动一个进程内 Redis 服务，并使用键`12345`检索记录。由于我们还没有存储任何记录，print 语句将输出`None`。代码片段的其余部分显示了如何创建、读取、更新和删除记录。

要在 Redis 中创建一个记录，这是一个键-值条目，我们可以使用`set`命令，该命令接受键和值参数。您可以将这个键视为 Redis 用来检索值的索引。上面的代码检查记录，如果没有找到记录，则创建一个新的用户配置文件作为字典，并使用球员 ID 作为关键字将对象保存到 Redis。

接下来，我们使用 Redis 中的`get`命令读取记录，该命令检索保存到数据存储的最新值。如果没有找到记录，则返回值 None。然后，我们使用 *json* 库将 Redis 返回的字符串值翻译成一个字典。

接下来，我们通过增加 *sessions* 值来更新用户摘要，然后使用`set`命令将更新的记录保存到 Redis。如果您多次运行 create、read、update 命令，那么每次运行时您都会看到会话计数更新。

上面显示的最后一个操作是删除操作，可以使用过期或通过删除密钥来执行。`delete`命令立即从数据存储中删除键-值对，而`expire`命令将在指定的秒数过后删除该对。使用`expire`命令是一个常见的用例，因为您可能只需要维护最近更新的数据。

接下来，我们将把 NHL 数据集作为 Pandas 数据帧拉入内存，然后遍历该帧，将行翻译成字典，并将事件发送到我们将要设置的端点。现在，您需要注释掉 post 并获取命令，因为服务器还没有运行。

对于这个例子，我们将数据帧过滤为玩家 ID 等于 *8467412* 的行，这导致了 213 条记录。一旦我们设置了端点，我们就可以尝试遍历所有的记录来测试端点的性能。

下面的代码片段显示了设置两条路线的示例 Flask 应用程序的代码。`/update`路线在应用中实施特征工程工作流程，而`/score`路线使用简单的线性模型实施模型应用。

更新路径使用 CRUD 模式在收到新数据时更新用户配置文件，但它不包括删除或过期步骤。当新的事件被发送到服务器时，应用程序将获取最新的玩家摘要，用新的数据点更新记录，然后保存更新的配置文件。这意味着概要文件会随着数据流向服务器而实时更新，从而最大限度地减少模型管道中的延迟。使用这种方法进行特性工程时需要注意的一点是，与 SQL 相比，只有一部分特性可以使用，因为聚合命令不可用。您可以更新计数器、设置标志、计算平均值，但不能执行计算中值或计算非重复值等操作。

更新路径采用玩家 ID，并根据检索到的特征向量返回一个分数(如果可用)。它从查询字符串中解析玩家 ID，然后获取相应的玩家摘要。此摘要中的值与硬编码线性回归模型的系数相结合，以返回模型预测。结果是一个端点，我们可以调用它来使用最新数据实时获得模型预测。

我们现在有一个模拟服务，展示了如何使用 Redis 作为数据存储来实时执行特性工程和建模应用程序。在实践中，我们将使用 Redis 集群替换模拟 Redis 实现，使用模型存储来应用 ML 模型，使用诸如 gunicorn 之类的 WSGI 服务器运行 Flask 应用程序，并使用 Docker 和 Kubernetes 之类的工具扩展应用程序。将这个工作流投入生产有许多不同的方法，但是我们已经用一个简单的服务演示了核心循环。

## 结论

当数据科学家需要从批处理工作流转移到流工作流来构建预测模型时，NoSQL 工具非常有用。通过使用 NoSQL 数据存储，工作流中的延迟可以从几分钟或几小时减少到几秒钟，使 ML 模型能够使用最新的输入。虽然数据科学家通常不会接触这些类型的数据存储，但有多种方法可以接触到 Redis 等工具，甚至可以在 Jupyter 笔记本中构建原型服务。

使用 Redis 扩展实时特征工程服务时，会出现各种不同的问题。一个问题是对一个键的并发更新，这可能发生在不同的线程或服务器更新一个概要文件的时候。这可以用检查和设置[模式](https://redis.io/topics/transactions)来处理。在模型应用程序方面，也有一些问题，比如模型维护，通常有不同的服务来构建特征向量和应用模型。

Redis 和其他 NoSQL 解决方案只是为数据科学工作流实施实时特征工程的一种方式。另一种方法是使用 Kafka 或 Kinesis 等流系统，以及 Kinesis Analytics 或 Apache Flink 等流处理工具。最好探索不同的方法，以便找到最适合您组织的数据平台和服务的解决方案。

[本·韦伯](https://www.linkedin.com/in/ben-weber-3b87482/)是 Zynga 杰出的数据科学家。我们正在[招聘](https://www.zynga.com/job-listing-category/data-analytics-user-research/)！