# AWS Lambda 性能:专业提示和技巧

> 原文：<https://towardsdatascience.com/aws-lambda-performance-pro-tips-and-tricks-322452844ddf?source=collection_archive---------36----------------------->

## 如何诊断和优化您的功能

![](img/570f3e11269fb3f36edd76661ee5570f.png)

[图像来源](https://pixabay.com/illustrations/digitization-transformation-binary-5140071/)

Lambda 是亚马逊网络服务(AWS)提供的无服务器云计算服务。该服务使您能够在 AWS 服务上运行后端代码，而无需管理基础设施。你在 AWS Lambda 上运行的代码叫做函数。可以使用自己的函数，也可以使用预制的函数。一旦您的函数被加载，您就选择了一个 AWS 事件源。你可以根据需要设置事件，然后让 Lambda 自动运行。

如果您不想处理供应、资源和其他计算任务，Lambda 是一个很好的解决方案。但是，您仍然需要以确保性能的方式设置您的函数和触发器。本文解释了 AWS Lambda 性能如何受到冷启动时间、执行时间和并发性的影响。您还将学习如何诊断和优化 Lambda 性能问题。

# 什么导致了 AWS Lambda 性能问题？

当[用 AWS Lambda 设置功能](https://aws.amazon.com/lambda/getting-started/)时，几个问题破坏了无服务器应有的速度和灵活性。当函数没有按预期执行时，以下三个原因是最常见的原因。

**冷启动时间**

调用后，函数会在一段未声明的时间内保持热度。一般 30 分钟左右。之后，函数实例被终止，下一次调用需要创建并初始化一个新的实例。这种冷启动增加了操作的时间和成本。冷启动的等待时间最长可达 10 秒，您需要为该功能预热的时间付费。

**执行时间**

Lambda 函数每次调用最多可以运行 15 分钟。这是你无法改变的硬性限制。函数运行时间为什么长，函数是否在等待响应，或者它是否需要大量的计算，这些都无关紧要。由于这个限制，对于任何运行时间接近 15 分钟的函数，您应该考虑另一种方法。

**并发**

使用 Lamba，每个函数实例一次只能调用一个。如果您在运行时再次调用它，则会创建一个新实例，直到达到您的并发限制。美国(东西)和欧洲(爱尔兰)的并发量最高可达 3k，亚太(东京)和欧洲(法兰克福)最高可达 1k，其他地区最高可达 500。对于更多的并发实例，您必须请求 AWS 增加数量。如果不这样做，任何超出限制的调用都会被抑制。

# 诊断性能问题

诊断 Lambda 中的性能问题可能很棘手。功能的短暂性要求动态监控，而无服务器架构的分布式特性使得调试变得困难。

**监控、记录和追踪**

除了您提供给 Lambda 的函数和资源需求之外，您几乎无法控制函数实例如何操作。这意味着您不能使用守护程序进行监控，也不能轻松地将日志导出到外部平台。然而，AWS 确实提供了一些解决方案来帮助您克服这个障碍。

*   **监控** — AWS CloudWatch 自动从您的函数中收集运行时和基本性能指标。您可以将这些指标导出到第三方监控解决方案，或者通过 CloudWatch 控制台或 AWS CLI 访问它们。但是，请记住，每次您访问指标时，都会收取少量费用。
*   **日志** —可以在代码中插入日志语句，将数据发送到 CloudWatch 日志中。然后，您可以通过控制台、AWS CLI 或使用 API 导出来查看这些日志。
*   **跟踪** — AWS X-Ray 是一种服务，通常可用于对 Lambda 函数和微服务架构进行端到端跟踪。它支持 Java、Node.js 和。NET 并跨 AWS 帐户、区域和可用性区域工作。

**调试**

在调试函数时，可以很容易地结合 CloudWatch 和 X-Ray 信息来识别性能瓶颈，并为单次调用请求问题。然而，将这些服务用于多次调用可能是一个挑战，因为来自所有调用的日志记录混合在 CloudWatch 日志中。这使得很难按时间顺序查看数据。

如果您试图调试跨多个函数或服务的错误，上述工具提供的帮助就更少了。这意味着为了有效地调试，您需要将数据导出到第三方平台。

# 如何优化 AWS Lambda 性能

除了监控和调试之外，您还可以采用一些最佳实践来帮助减少或防止性能问题。下面是一些需要考虑的实践。

# 提高冷启动性能

减少冷启动的影响是提高功能表现最有效的方法之一。有几种方法可以减少冷起动时间，但是你也可以消除许多冷起动。

为了避免冷启动，你可以使用更热的逻辑。这个逻辑包含在一个处理函数中，用于与 Lambda 函数和事件触发器接口。较热的逻辑以 5 到 10 分钟的增量调用主函数中的少量逻辑，以确保实例在实际需要调用它时保持活动状态。您可以使用 cron 作业来完成这些调用，也可以使用一些模块来批量预热。

# 内存和 CPU

在定义函数的资源需求时，您只能指定 RAM，最大为 3GB。无论您指定多少，都会按比例分配 CPU 能力。您每分配 1，792 MB，就会向您的资源中添加一个虚拟 CPU。

要优化，你需要找到功能性能和成本的平衡点。对于单线程应用程序，这通常意味着 1.8GB 或更少的 RAM。对于 CPU 绑定代码的多线程应用，任何低于 1.8GB 的东西都可能是无效的。

# 错误

捕捉函数中异常的最佳方式是嵌入导出到 CloudWatch 日志的日志记录语句。这可以通过普通的 stdout 或 stderr 语句或者特定于语言的日志方法来完成。

无论哪种方式，您都需要确保分配给您的功能的身份和访问管理(IAM)角色拥有将日志发布到 CloudWatch 的权限。否则，您的日志将只显示没有帮助的权限被拒绝错误。

# 喉咙

一旦达到并发限制，调用请求就会受到限制并返回一个错误。对于保留和非保留并发都是如此。这个限制的一个警告是，它取决于函数是如何被调用的。对于基于流的事件，限制由并行化因子决定。这个因素决定了使用多少并发调用来处理数据流的每个片段。

对于非基于流的事件，计算的调用请求数是实际调用数乘以函数持续时间。这意味着即使在给定时间内没有新调用那么多函数实例，您也可以很快达到极限。

要解决这个问题并避免返回错误，您可以:

*   **异步调用** —适用于非基于流的事件。这种方法需要排队服务，像 [SQS](https://medium.com/@sorenso/what-ive-learned-working-with-amazon-sqs-f0192fc10a29) 。这使得调用能够按顺序处理，并确保每个调用都得到响应。
*   **减少并行化** —适用于基于流的事件。这种方法包括减少你的批量和减少一次处理的碎片数量。这样做时，请记住，当映射单个源时，最大调用数等于碎片数。

# 结论

有三个主要因素会极大地影响 AWS Lambda 性能——冷启动时间、执行时间和并发性。这三个问题直接关系到每个函数的寿命，以及你如何利用函数。因为您是按使用计费的，并且您使用的是函数，所以冷启动时间、执行时间和并发性问题不仅会影响延迟，还会影响计费。

为了确保您的功能正常执行，您应该不断地监视、记录、跟踪和调试。您可以使用 AWS CloudWatch 来设置基于度量的自动化监控。对于日志记录，在代码中插入语句可以帮助您将数据发送到 CloudWatch。您可以使用 AWS X-Ray 对 Lambda 函数进行端到端跟踪。然后，您将能够识别问题并进行调试。