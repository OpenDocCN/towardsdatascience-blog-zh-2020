<html>
<head>
<title>Data Reshaping in SQL, R and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL、R和Python中的数据整形</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-reshaping-in-sql-r-and-python-d44ca19e71b8?source=collection_archive---------20-----------------------#2020-05-26">https://towardsdatascience.com/data-reshaping-in-sql-r-and-python-d44ca19e71b8?source=collection_archive---------20-----------------------#2020-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="713f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于长到宽和宽到长转换的有用指南</h2></div><p id="f6f8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设想这样一个场景:您刚刚完成了一个SQL查询，为涉众生成了汇总统计数据，让我们以下面的表格为例，</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/e5ad21d7f0ce029e8944619dbec3c2c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*HA73FDbSX8Ik7T3nx1TZ7g.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">长数据格式</p></figure><p id="7f3b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个纵向数据，跟踪每月和州的枪支许可证检查次数。原始数据是公开的，更多背景资料<a class="ae lq" href="https://github.com/BuzzFeedNews/nics-firearm-background-checks" rel="noopener ugc nofollow" target="_blank">链接于此</a>。所以你的项目是对枪支许可变化的时间序列分析，包括纵向跨时间和横向跨州。不难认识到，该分析需要转换数据，以便将<em class="lr"> </em> <strong class="kk iu"> <em class="lr">月</em> </strong>或<strong class="kk iu"> <em class="lr">状态</em> </strong>变量放置在列上，如下所示:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/b720d48a4b9b1f5bf331ab6b37cc1e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*4rZ9TaqO2czs80QfYnqjDw.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">宽数据格式</p></figure><p id="aaa3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种数据整形过程被称为旋转(即，长/堆叠到宽/扩散)，其逆过程是取消旋转(即，宽/扩散到长/堆叠)。将数据从一种格式转换为另一种格式是分析项目中最常见的数据操作步骤之一。因此，在这篇博客中，我们将探索如何有效地将数据从long转换为wide(反之亦然)，我们将使用SQL、R和Python来完成这一过程。</p><p id="b79e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="lr"> ***更新2022: </em> </strong> <strong class="kk iu"> <em class="lr">加入我们的YouTube社区🎦</em> </strong> <a class="ae lq" href="https://www.youtube.com/channel/UCbGx9Om38Ywlqi0x8RljNdw" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="lr">【数据说话带吉】</em> </strong> </a> <strong class="kk iu"> <em class="lr">😄</em> </strong></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="lx ly l"/></div></figure><h1 id="719b" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated"><strong class="ak">旋转:长到宽</strong></h1><h2 id="dd09" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated"><strong class="ak"> SQL: </strong></h2><p id="9bc2" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">先说<code class="fe ni nj nk nl b">PIVOT()</code>函数，Oracle 11g和MS server 2017都有。为了方便访问，我还在这里的<a class="ae lq" href="http://sqlfiddle.com/#!18/14047/2" rel="noopener ugc nofollow" target="_blank">SQL fiddle playground</a>中对它进行了编码，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="6c52" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在该查询中，<em class="lr">允许</em>列被指定为要分摊的值，而<em class="lr">月</em>列被指定为新透视表的标签。其他列(即玩具数据中的<em class="lr">状态</em>列)被隐式地视为<code class="fe ni nj nk nl b">GROUP BY</code>变量。回报正是我们所期望的，</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi nn"><img src="../Images/a4eb7cd6a4a5f145cd5e4118a8188d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_7rv1sVpc6O1q9Q6y4ajjw.png"/></div></div></figure><p id="f1b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，您一定注意到了我们查询中的聚合函数<code class="fe ni nj nk nl b">SUM()</code>。该功能无法消除，因为旋转是一种侵略性操作，因为<a class="ae lq" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/from-using-pivot-and-unpivot?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">它将(可能的)多行合并成输出</a>中的一行。</p><p id="e38a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，在我们的例子中，由于每个月每个州只有一行，<code class="fe ni nj nk nl b">SUM()</code>什么也不做，因此可以被其他agg替换。功能(如<code class="fe ni nj nk nl b">AVG()</code>)。相反，如果我们有多行(对于每个月的每个州)要聚合，这些函数将通过避免额外的子查询而派上用场。</p><p id="ad23" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，转到其他SQL数据库，例如MySQL或PostgreSQL，其中<code class="fe ni nj nk nl b">PIVOT</code>操作符不可用，下面显示了查询(<a class="ae lq" href="http://sqlfiddle.com/#!9/36e0e5/1" rel="noopener ugc nofollow" target="_blank"> SQL fiddle playground </a>)，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="fa62" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与<code class="fe ni nj nk nl b">PIVOT</code>操作符一样，聚合函数也是指定的，但是随着月份的增加，这个查询很容易变得冗长。假设我们有100个月的记录，而不是4个月，我们将不得不手动键入100列标签！这肯定不是最佳解决方案。</p><h2 id="812b" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated"><strong class="ak">R—shape()&amp;pivot _ wider():</strong></h2><p id="e17d" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">R中的<strong class="kk iu"> </strong>数据帧本质上是矩阵，因此矩阵转置的公知思想是适用的。有很多R函数可以处理这个任务，我最喜欢的两个是包<strong class="kk iu"><em class="lr">【stats】</em></strong>和<strong class="kk iu"><em class="lr">【tidyr】</em></strong>中的<code class="fe ni nj nk nl b">reshape(direction = 'wide')</code> <strong class="kk iu"> </strong>和<code class="fe ni nj nk nl b">pivot_wider()</code> <strong class="kk iu"> <em class="lr"> </em> </strong>。</p><p id="f01b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，<code class="fe ni nj nk nl b">pivot_wider()</code>是<code class="fe ni nj nk nl b">spread()</code>的更新功能，不再处于积极开发中(更多详细信息，请参见此处的<a class="ae lq" href="https://tidyr.tidyverse.org/reference/pivot_wider.html" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="5d22" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，下面的代码展示了如何使用<code class="fe ni nj nk nl b">pivot_wider()</code>用R中的几行代码实现旋转。如果你也对<code class="fe ni nj nk nl b">reshape() </code>版本感兴趣，我在<a class="ae lq" href="https://github.com/YiLi225/Data_Reshaping" rel="noopener ugc nofollow" target="_blank">我的Github </a>中有它的链接，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="6df9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里:[1]我们将<strong class="kk iu"> names_from </strong>参数设置为跨列分布的变量(即<em class="lr"> month </em>变量)；[2]另一个有用的可选参数是<a class="ae lq" href="https://rdrr.io/github/tidyverse/tidyr/man/pivot_wider.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> names_prefix </strong> </a>，它指定每个列名的前缀词(例如，month _ 2020–01–31)。</p><h2 id="5f6c" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated"><strong class="ak"> Python — pivot_table() </strong>:</h2><p id="cdcd" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">同样，Python中也有一个函数<strong class="kk iu"><em class="lr"/></strong>恰如其分地命名为<code class="fe ni nj nk nl b">pivot_table()</code><strong class="kk iu"/></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="d0e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里:[1]我们用0 替换缺失值，将<em class="lr"> permit </em>列转换为整数(与默认float64相反)；[2]输出表的列被设置为类型字符串，以避免标签在<a class="ae lq" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.reset_index.html" rel="noopener ugc nofollow" target="_blank"> reset_index </a>之后被转换为日期时间(如2020–01–31 00:00:00)；[3]此函数有一个可选参数<a class="ae lq" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html" rel="noopener ugc nofollow" target="_blank"><strong class="kk iu"/></a>，可用于聚合多行(如<code class="fe ni nj nk nl b">‘sum’, ‘count’</code>)。</p><h1 id="0f71" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">非旋转:从宽到长</h1><p id="44af" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">现在让我们假设我们想要将宽数据转换回原始的长数据结构。<strong class="kk iu">在SQL </strong>中，除了我们用<code class="fe ni nj nk nl b">unpivot()</code>替换了函数<code class="fe ni nj nk nl b">pivot()</code>之外，查询几乎与旋转相同，并且SQL小提琴在这里链接<a class="ae lq" href="http://sqlfiddle.com/#!18/45c51/5" rel="noopener ugc nofollow" target="_blank"/>，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><h2 id="81aa" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated"><strong class="ak">R—shape()&amp;pivot _ longer():</strong></h2><p id="09a5" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">对于这个演示，我们将再次关注来自<strong class="kk iu"> <em class="lr"> {tidyr} </em> </strong>的<code class="fe ni nj nk nl b">pivot_longer()</code>，它的对等<code class="fe ni nj nk nl b">reshape(direction = 'long')</code>版本可在我的<a class="ae lq" href="https://github.com/YiLi225/Data_Reshaping" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中获得。与<code class="fe ni nj nk nl b">pivot_wider()<strong class="kk iu"> </strong></code>的情况类似，<code class="fe ni nj nk nl b">pivot_longer()</code> <strong class="kk iu"> </strong>是对原有<code class="fe ni nj nk nl b">gather()</code>功能的更新，不再开发。</p><p id="5f6a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是我们如何将数据从宽数据转换回长数据，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="01b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这段代码中，<strong class="kk iu"> cols </strong>参数接受要堆叠成更长格式的列，即我们数据中的月份变量。这一行<code class="fe ni nj nk nl b">colnames(wide_dat)[-1]</code>将排除第一个变量<em class="lr">状态</em>。这是输出，它符合我们的原始数据格式，</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi no"><img src="../Images/a6eed82c8c156c809376759e131e655f.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*PnUGok5LSqvYVugkFMKxEQ.png"/></div></figure><p id="098b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一个问题是，如果聚合了多行，那么取消投票不会产生原始的表值。</p><h2 id="5e1a" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated"><strong class="ak"> Python — melt(): </strong></h2><p id="702c" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated"><strong class="kk iu"> <em class="lr">熊猫</em> </strong>也有，函数<code class="fe ni nj nk nl b">melt()</code>执行宽到长的转换，</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nm ly l"/></div></figure><p id="9e5e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与R输出一样，这段代码的返回与我们的原始数据完全匹配。</p><p id="8e16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="lr">想要更多数据科学和编程技巧？使用</em> </strong> <a class="ae lq" href="https://yilistats.medium.com/membership" rel="noopener"> <strong class="kk iu"> <em class="lr">我的链接</em> </strong> </a> <strong class="kk iu"> <em class="lr">注册Medium，获得我所有内容的全部访问权限。</em>T25】</strong></p><h1 id="54cd" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">最后的想法</h1><p id="1cc6" class="pw-post-body-paragraph ki kj it kk b kl nd ju kn ko ne jx kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">正如我们刚刚了解到的，SQL作为一种查询语言，在用于数据整形时会变得繁琐冗长。与SQL表不同，R和Python中的数据框本质上是矩阵，其中行和列是可互换的；因此更适合像数据转换这样的任务。</p><p id="ba6d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">关于R与Python的对比，我的经验是，通常一个任务可以使用R中不同的包以多种方式完成，而Python的开发方式是尽可能只提供一种功能。虽然一些数据科学家欣赏R中的这种灵活性，但其他人可能会发现它含糊不清、令人困惑。</p><p id="435e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，Python被认为是比R稍低级的语言，它有更严格的数据类型要求。例如，一只<em class="lr">熊猫。系列</em>与<em class="lr"> numpy.array、</em>不同，因此它们不共享属性或方法。然而，在R中，不存在这样的区别，其中等价的概念只是一个<em class="lr">向量</em>或<em class="lr">矩阵</em>。这一特性使得统计/科学分析比Python中的分析更加方便。</p><p id="c434" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">毕竟，R和Python的设计目的有些不同。我希望对这些区别的认识能使你更有效地选择最佳语言来解决你的具体问题。😀</p></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><p id="030c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="lr">想要更多数据科学和编程技巧？使用</em> </strong> <a class="ae lq" href="https://yilistats.medium.com/membership" rel="noopener"> <strong class="kk iu"> <em class="lr">我的链接</em> </strong> </a> <strong class="kk iu"> <em class="lr">注册Medium，获得我所有内容的全部访问权限。</em>T49】</strong></p><p id="c520" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="lr">还订阅我新创建的YouTube频道</em> </strong> <a class="ae lq" href="https://www.youtube.com/channel/UCbGx9Om38Ywlqi0x8RljNdw" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="lr">【数据谈吉】</em></strong></a><strong class="kk iu"><em class="lr"/></strong></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="lx ly l"/></div></figure><h2 id="13c5" class="mr ma it bd mb ms mt dn mf mu mv dp mj kr mw mx ml kv my mz mn kz na nb mp nc bi translated">更多有用的数据科学博客:</h2><div class="nw nx gp gr ny nz"><a rel="noopener follow" target="_blank" href="/6-sql-tricks-every-data-scientist-should-know-f84be499aea5"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">每个数据科学家都应该知道的6个SQL技巧</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">提高分析效率的SQL技巧</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on lk nz"/></div></div></a></div><div class="nw nx gp gr ny nz"><a href="https://levelup.gitconnected.com/4-simple-ways-to-import-word-and-pdf-files-into-python-when-pandas-fails-43cf81599461" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">熊猫失败时将Word和PDF文件导入Python的4种简单方法</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">导入非结构化文本/图像数据的实用指南</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oi l"><div class="oo l ok ol om oi on lk nz"/></div></div></a></div></div></div>    
</body>
</html>