<html>
<head>
<title>Introducing Observable, Self-Documenting ELT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">介绍可观察的、自我记录的ELT</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introducing-observable-self-documenting-elt-41aa8b124098?source=collection_archive---------26-----------------------#2020-06-20">https://towardsdatascience.com/introducing-observable-self-documenting-elt-41aa8b124098?source=collection_archive---------26-----------------------#2020-06-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a07f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://www.virevol.com" rel="noopener ugc nofollow" target="_blank"> Virevol ai </a>是一款协同视觉购物app。我们经营一个远程优先的精益团队，已经有2年多了。为了施展我们的魔法，我们带着大量的数据畅游。</p><p id="d8e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们每天从数百个数据源中获取数百万行数据，在这些数据上运行我们的模型，并以各种方式为它们提供服务。我们在谷歌堆栈上，有GCP云功能、服务、容器，你能想到的都有。它们触发关于文件丢弃、队列消息、挂钩和时间表的其他事件。一切都是基于事件的，只是及时供应(我们很吝啬)。</p><p id="8250" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的头脑中有太多的数据路径需要保留。</p><p id="8f87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了可观察的ELT，我们可以通过匹配日志、输入、涉及它的每个作业的版本，追踪数据的来源，直到每一行。我们可以用美元做ELT会计，这是大多数CTO的白日梦。这使我们能够返工花费更多的管道部分，而不是所有遗留代码。</p><p id="67cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是我们保持理智的方法。我们如何在保持数据质量的同时快速发货？</p><p id="1565" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">数据如何移动</strong></p><p id="9ba7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ETL是一系列批处理作业。当一个完成时，下一个被触发。有时是两个，有时是Y形连接成一个。</p><p id="a511" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你会得到一个有向图。图表很简单。</p><p id="ff8f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">图表从上到下排列(如果您愿意，也可以从左到右排列)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/5150936411c04af3faaa4ae77ff85484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JdT8OGhdQcQs6f4w"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">照片由<a class="ae ko" href="https://unsplash.com/@ignitedit?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克·巴萨拉</a>在<a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="f928" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当中间的某个步骤中断或花费太长时间时，复杂性就产生了。想想鲁布·戈德堡机器。</p><p id="6360" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者更糟，如果什么都没发生。你会在理解数据的过程中发现错误。</p><p id="7ddb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了管理这种复杂的管道协调，人们使用了各种各样的工具——Luigi、dbt、Airflow等。</p><p id="1dde" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一种非常自上而下的乐器演奏方式。</p><p id="72b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最终用户只关心最后一步。如果报告需要在上午9点发出，而数据还没有准备好，你会接到电话。那是你的SLA。</p><p id="df3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一项服务需要每10分钟为用户更新一次推荐，这就是您的SLA。</p><p id="73aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">遗憾的是，最终用户对Dag或花哨的工具不感兴趣。</p><p id="224b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当事情发生时，一个泪流满面的初级开发人员试图在凌晨3点调试“为什么”。她加入公司是为了涉足神经网络。但是被引诱，转而做ETL。更糟糕的是，它被一些人称为“数据看门人的工作”，而不是它应该有的“数据Lorax”。</p><p id="a9a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">她费力地翻阅一些本该发生的事情的文件。如果写这个的人还在那里工作，那就有点懈怠了。然后查看日志来搞清楚事情。如果她真的幸运的话，甚至可能会有一份关于这份工作的最新手册。她从Pagerduty跳到JIRA，跳到wiki，跳到github，跳到日志。</p><p id="7bfa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">鸟儿在远处歌唱，迎接黎明的到来。</p><p id="f51e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">可观察的ELT </strong></p><p id="3c79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们引入了一个新概念，叫做<strong class="js iu">全局跟踪标识符</strong>，简称tid。</p><p id="616e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个将转换数据的函数、批处理作业或服务都需要获得一个特定运行的tid。</p><p id="daae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它提供所有旧的tid、其版本和实例变量(例如X-AppEngine-QueueName、X-Appengine-Taskname)。这些记录在service_tracker表的BigQuery中。</p><p id="0051" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是python中调用的样子</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="2055" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它必须用这个tid记录运行。</p><p id="2bd5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，它必须将该行的last_tid列追加到这个。如果它是一个新行，它还必须将tid列填充到该行。向下滚动到“渐变尺寸”部分进行优化。</p><p id="fe1e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是已经部署的Google功能，它可以满足我们的所有需求。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="c3cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">它是如何工作的？</strong></p><p id="1398" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们画一张图来概括这些情况:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lh"><img src="../Images/a252e8ee0c62c343db2022692d520fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1hOeztnGjAu9q4QqfdHeg.png"/></div></div></figure><p id="12ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里A，B，C，…F，都是不同的过程。各取一物，醒来，发一物，关机。但是我们不需要任何地方都有这样的记录图表。</p><p id="0f64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么我们如何产生它呢？</p><p id="23c2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从插入到D末尾的表行的角度来看，我们有A的tid，D的last_tid跟踪到[B]，B跟踪到[A]。</p><p id="2b82" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我们知道，A -&gt; B -&gt; D -&gt;这一行。我们可以跟踪这里的每一行，以及生成它的代码版本。</p><p id="6f61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们来做一个更复杂的案例。</p><p id="67ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从插入到F末尾的表行的角度来看，我们有A的tid和last_tid F，它们跟踪到[E，D]的tid。我们可以追踪列表中提到的每一个tid来反转图表。</p><p id="e4c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当有东西损坏(F)时，我们不会在数据仓库中为它获得一行。我们无畏的开发人员可以看看前面的运行，它将F引用为prev_tid(它们有时间戳)。然后，她可以直接调试F运行的日志，并会在e。</p><p id="757d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">她可以做所有这些事情而不需要问任何人。你仍然需要服务F的操作手册，就在github里。</p><p id="e3cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">她从pagerduty转到Google logging和github寻找代码和问题。如果她发现服务有问题，她可以从那里更新并推送代码，这将触发CI/CD测试。</p><p id="4f66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">她可以用代码记录下来，并指出帮助她找到问题的tid。该代码是最好的“当前”文档。该表是指向它的指针的时间序列。</p><p id="afbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还可以做更多的事情，我们可以审计每张桌子生产需要多长时间，以及生产链中的哪些工作导致了这种情况。我们可以计算出链何时改变(ML作业C被插入到组合中)。</p><p id="0346" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以通过查看每个服务每次运行的成本来确定哪些遗留代码需要返工。这提供了一种新的优化方法。我们的优化不仅仅是通过“感觉”哪个代码最让我们厌烦，而是通过一个目标函数——成本。</p><p id="a154" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">把它想象成剖析一个程序，除了你看到的是函数和美元，而不是子程序计时。</p><p id="ede5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们来谈谈小而重要的细节，以获得更好的结果。</p><p id="a2c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> ELT not ETL </strong></p><p id="5593" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为你的数据在云中，移动数据是你的账单中最大的份额。尽可能用ELT代替ETL。数据将直接在服务器上转换并保存下来，只需要最少的传输。</p><p id="6d1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为另一个原因，它会更快。BigQuery和大多数现代数据仓库正在它们的大型服务器集群上为您进行map-reduce。您必须加快k8s实例的速度，才能在大负载下获得相同级别的性能。</p><p id="b857" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了获得最大的收益，请使用特定于数据库的SQL，而不是抽象来转换数据。在这种情况下，编写SQL是合适的工具。克服它。</p><p id="8754" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">SQL能有多复杂？作为一个练习，这里的<a class="ae ko" href="https://gist.github.com/sanealytics/0e910380576fbe4825455264b125ecdb" rel="noopener ugc nofollow" target="_blank"/>是用SQL计算tf-idf，只是为了好玩(实际上你可以使用类似<a class="ae ko" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank"> spaCy </a>的东西，因为你可能需要更多的步骤)。您也可以从示例中获得使SQL令人愉快的样式技巧。</p><p id="788c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于可观察的ELT，使用Google函数获取tid并从字典中运行参数化的SQL。</p><p id="3985" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">类似这样的事情，</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="60e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果可以在SQL中全部完成，那么直接使用merge语句会更快(参见示例)。</p><p id="a138" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">哦，确保你有测试用例来测试你现在所有的SQL。</p><p id="a670" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">渐变尺寸</strong></p><p id="6838" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们用另外三个细节来美化生活。</p><p id="e6ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一种是将每个表包装在视图后面。所以一个名为‘学生’的表就变成了‘v _学生’。这使得重构变得容易。这是我在租跑道的时候发现的，并保存了下来。</p><p id="9e89" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">二是用一个版本的<a class="ae ko" href="https://en.wikipedia.org/wiki/Slowly_changing_dimension#Type_2:_add_new_row" rel="noopener ugc nofollow" target="_blank"> SCD type 2 </a>。</p><p id="dcf5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于大多数重要的表，每一行都只是被追加，并按时间分区。顶部的视图使用added_ts上的rank()给出了该表的最新版本。</p><p id="9347" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这可能看起来很浪费，但它让我们保持理智，存储成本也没有人们想象的那么高。当旧分区变得太大时，我们总是可以丢弃它。</p><p id="c31a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，每份工作都可以重新开始。这通常是大多数成熟数据团队的标准，我就不赘述了。</p><p id="768f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于可观察的ELT，我们必须发明一些新工具，但是我们不需要任何其他外部工具来进行协调。它与Google Cloud任务队列、Pub/Sub和Apache Beam pipes共存。</p><p id="5bf1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止，我们很开心。一旦我们有了一个稍微大一点的团队为10亿客户服务，我们会让你知道我们是否还在。</p><p id="3ba4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些想法也可以扩展到日志记录。我们最近在日志记录上看到了这个主题，并且很高兴尝试一下。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="li lg l"/></div></figure><p id="ac25" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果这给了你任何关于你自己的ETL流程的想法，我们很乐意听到你的意见。这种分散的方法应该有助于您更快地发货。</p><p id="2458" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你喜欢解决具有挑战性的问题，并且是非传统的思考者，请<a class="ae ko" href="mailto:saurabh@virevol.com" rel="noopener ugc nofollow" target="_blank">联系</a>。</p></div></div>    
</body>
</html>