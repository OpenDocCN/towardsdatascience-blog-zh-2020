<html>
<head>
<title>Python and AWS SSM Parameter Store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 和 AWS SSM 参数存储</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-and-aws-ssm-parameter-store-7f0e211bb91e?source=collection_archive---------5-----------------------#2020-01-30">https://towardsdatascience.com/python-and-aws-ssm-parameter-store-7f0e211bb91e?source=collection_archive---------5-----------------------#2020-01-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9a51" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">保护应用程序秘密的一种方法是通过 AWS SSM 参数存储。我们将看看如何以编程方式检索和解密这个秘密。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/205c03094f4dad7d45b19e2cbe86b976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HjnkuNz-0Wr2_9QB"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@chrispanas?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯·帕纳斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5fae" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="0937" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在任何应用程序中，拥有一些秘密是很常见的，我们的应用程序需要这些秘密来提供它想要的功能。禁止把那些秘密放在我们的项目文件夹里，提交给 Github repo。这是一个很大的不，不。🙅‍♂</p><p id="e35f" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">有几个安全存储秘密的替代方法，但是，在本教程中，我将向您展示如何使用 AWS 密钥管理服务(KMS)和系统管理器的参数存储(SSM)来实现。我们将使用 Python 3.8 作为编程语言，并使用官方的 AWS Boto3 库来与 AWS 资源进行交互。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="1e74" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">你将学到什么</h1><p id="fece" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">本教程结束时，您将能够完成以下练习:</p><ul class=""><li id="6ddf" class="mz na it ma b mb mu me mv mh nb ml nc mp nd mt ne nf ng nh bi translated">用 KMS 创建一个密钥</li><li id="030b" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated">把一个参数/秘密作为进入 SSM 的安全措施</li><li id="581c" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated">检索并解密 SSM 秘密参数</li></ul><p id="010c" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">本教程的 Github repo 可从<a class="ae ky" href="https://github.com/billydh/kms-ssm-decrypt" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="45ad" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">先决条件</h1><p id="b478" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">本教程假设您已经拥有一个 AWS 帐户，并且可以访问它。这是做 KMS 和 SSM 相关练习所必需的，特别是创建 KMS 键并将一个参数放入 SSM。我们将使用<code class="fe nn no np nq b">aws-cli</code>来做这件事。你可以按照 AWS 官方<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv1.html" rel="noopener ugc nofollow" target="_blank">文档</a>来安装和设置凭证。</p><p id="bba7" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">或者，您可以直接在 AWS 控制台上完成。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="e884" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">准备 Python 环境和依赖性</h1><p id="81f8" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在本节中，我们将设置 SSM 参数解密所需的所有组件。</p><h2 id="cb74" class="nr lh it bd li ns nt dn lm nu nv dp lq mh nw nx ls ml ny nz lu mp oa ob lw oc bi translated">创建虚拟环境</h2><p id="b919" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">让我们使用<code class="fe nn no np nq b">virtualenv</code>创建一个虚拟环境来包含我们的项目依赖关系。从您的终端运行以下命令来创建虚拟环境并激活它。</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="89d9" class="nr lh it nq b gy oh oi l oj ok">$ ❯ mkdir -p ./demo/kms-ssm-decrypt</span><span id="c78e" class="nr lh it nq b gy ol oi l oj ok">$ ❯ cd ./demo/kms-ssm-decrypt</span><span id="c183" class="nr lh it nq b gy ol oi l oj ok">$ ~/demo/kms-ssm-decrypt ❯ virtualenv ./venv<br/>Using base prefix '/Library/Frameworks/Python.framework/Versions/3.8'<br/>New python executable in /Users/billyde/demo/kms-ssm-decrypt/venv/bin/python3.8<br/>Also creating executable in /Users/billyde/demo/kms-ssm-decrypt/venv/bin/python<br/>Installing setuptools, pip, wheel...<br/>done.</span><span id="6780" class="nr lh it nq b gy ol oi l oj ok">$ ~/demo/kms-ssm-decrypt ❯ source ./venv/bin/activate</span><span id="ae67" class="nr lh it nq b gy ol oi l oj ok">$ ~/demo/kms-ssm-decrypt (venv) ❯</span></pre><h2 id="ae8b" class="nr lh it bd li ns nt dn lm nu nv dp lq mh nw nx ls ml ny nz lu mp oa ob lw oc bi translated">安装 Boto3 库</h2><p id="2079" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">唯一需要的库是 Boto3。让我们创建一个文本文件来保持项目的依赖性，并将其命名为<code class="fe nn no np nq b">requirements.txt</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">requirements.txt</p></figure><p id="2417" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我们之所以有这个文本文件而不是直接安装库，是因为我们可以将它提交给 Github repo，而不是整个<code class="fe nn no np nq b">venv</code>以保持 repo 大小紧凑。然后，任何人都可以克隆 repo，并通过<code class="fe nn no np nq b">pip</code>在他们的机器上安装所有的需求。</p><p id="05e9" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们继续从我们的终端安装这个包。</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="7f04" class="nr lh it nq b gy oh oi l oj ok">$ ~/demo/kms-ssm-decrypt (venv) ❯ pip install -r requirements.txt<br/>Collecting boto3==1.11.0<br/>  Using cached boto3-1.11.0-py2.py3-none-any.whl (128 kB)<br/>Collecting s3transfer&lt;0.4.0,&gt;=0.3.0<br/>  Downloading s3transfer-0.3.2-py2.py3-none-any.whl (69 kB)<br/>     |████████████████████████████████| 69 kB 1.5 MB/s<br/>Collecting botocore&lt;1.15.0,&gt;=1.14.0<br/>  Downloading botocore-1.14.9-py2.py3-none-any.whl (5.9 MB)<br/>     |████████████████████████████████| 5.9 MB 4.6 MB/s<br/>Collecting jmespath&lt;1.0.0,&gt;=0.7.1<br/>  Using cached jmespath-0.9.4-py2.py3-none-any.whl (24 kB)<br/>Collecting urllib3&lt;1.26,&gt;=1.20<br/>  Using cached urllib3-1.25.8-py2.py3-none-any.whl (125 kB)<br/>Collecting python-dateutil&lt;3.0.0,&gt;=2.1<br/>  Using cached python_dateutil-2.8.1-py2.py3-none-any.whl (227 kB)<br/>Collecting docutils&lt;0.16,&gt;=0.10<br/>  Using cached docutils-0.15.2-py3-none-any.whl (547 kB)<br/>Collecting six&gt;=1.5<br/>  Using cached six-1.14.0-py2.py3-none-any.whl (10 kB)<br/>Installing collected packages: urllib3, six, python-dateutil, docutils, jmespath, botocore, s3transfer, boto3<br/>Successfully installed boto3-1.11.0 botocore-1.14.9 docutils-0.15.2 jmespath-0.9.4 python-dateutil-2.8.1 s3transfer-0.3.2 six-1.14.0 urllib3-1.25.8</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="4f67" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">创建 KMS 键</h1><p id="28af" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">既然我们要存储 secret/s，最好在静态时加密它，以提供额外的安全层。我们将创建一个 KMS 密钥，用于加密和解密我们的秘密参数</p><p id="b7ac" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">从您的终端，运行以下命令，这将创建一个 KMS 密钥。</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="2a95" class="nr lh it nq b gy oh oi l oj ok">$ ~/demo/kms-ssm-decrypt (venv) ❯ aws kms create-key --description "A key to encrypt-decrypt secrets"<br/>{<br/>    "KeyMetadata": {<br/>        "AWSAccountId": "xxxxxxxxxxxx",<br/>        "KeyId": "ca83c234-7e63-4d8d-1234-28603cb10123",<br/>        "Arn": "arn:aws:kms:ap-southeast-2:xxxxxxxxxxxx:key/ca83c234-7e63-4d8d-1234-28603cb10123",<br/>        "CreationDate": 1580217378.859,<br/>        "Enabled": true,<br/>        "Description": "A key to encrypt-decrypt secrets",<br/>        "KeyUsage": "ENCRYPT_DECRYPT",<br/>        "KeyState": "Enabled",<br/>        "Origin": "AWS_KMS",<br/>        "KeyManager": "CUSTOMER"<br/>    }<br/>}</span></pre><p id="0912" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">很好，如果运行成功，该命令会将密钥元数据输出到控制台上。我们可以继续下一步了。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="57b1" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">将秘密放入 SSM 参数存储中</h1><p id="9eb9" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将把一个秘密参数作为<code class="fe nn no np nq b">SecureString</code>存储到 SSM 参数库中。<code class="fe nn no np nq b">SecureString</code>参数类型仅仅表示我们存储的参数值将被加密。</p><p id="76de" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">为了放置一个秘密参数，让我们从终端执行下面的命令。</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="c7d9" class="nr lh it nq b gy oh oi l oj ok">$ ~/demo/kms-ssm-decrypt (venv) ❯ aws ssm put-parameter --name "/demo/secret/parameter" --value "thisIsASecret" --type SecureString --key-id ca83c234-7e63-4d8d-1234-28603cb10123 --description "This is a secret parameter"<br/>{<br/>    "Version": 1,<br/>    "Tier": "Standard"<br/>}</span></pre><p id="6c7a" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">该命令的参数是不言自明的，但是，我只想强调其中的几个:</p><ul class=""><li id="5b4e" class="mz na it ma b mb mu me mv mh nb ml nc mp nd mt ne nf ng nh bi translated"><code class="fe nn no np nq b">--name</code>:是你正在存储的参数的名称或路径，例如，它可能只是一个类似于“somesecretpathname”的名称，而不是上面的路径。</li><li id="c5aa" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated"><code class="fe nn no np nq b">--value</code>:您正在存储的参数值。</li><li id="c7a8" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated"><code class="fe nn no np nq b">--type</code>:参数的类型，在这个例子中是一个<code class="fe nn no np nq b">SecureString</code>，告诉 SSM 在将值存储到参数存储之前加密它。如果你只是存储一个非秘密的参数，那么 SSM 参数类型应该是<code class="fe nn no np nq b">String</code>。</li><li id="462c" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated"><code class="fe nn no np nq b">--key-id</code>:您想要用来加密参数值的 KMS 密钥的 id。这是上一节中生成 KMS 键的<code class="fe nn no np nq b">KeyId</code>的值。</li><li id="6922" class="mz na it ma b mb ni me nj mh nk ml nl mp nm mt ne nf ng nh bi translated"><code class="fe nn no np nq b">--description</code>:是您正在存储的参数的描述，以便您知道它的用途。</li></ul><p id="2848" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">太棒了。现在，我们将秘密参数存储在 SSM 参数存储中。让我们看看如何以编程方式检索和解密它。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="a43d" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">编写一个 Python 脚本来检索和解密机密</h1><p id="5b7e" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">现在，是时候编写脚本来检索我们刚刚存储在 SSM 参数存储中的秘密参数，并解密它，以便我们可以在我们的应用程序中使用它。</p><p id="9146" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们在项目目录中创建新的 Python 文件，并将其命名为<code class="fe nn no np nq b">retrieve_and_decrypt_ssm_secret.py</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe nn no np nq b">retrieve_and_decrypt_ssm_secret.py</code></p></figure><p id="8da3" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">注意<code class="fe nn no np nq b">get_parameter()</code>函数名为<code class="fe nn no np nq b">WithDecryption</code>的参数。在本练习中，我们将它指定为<code class="fe nn no np nq b">True</code>,因为我们想要获得这个秘密值并在我们的应用程序中使用它。你可能会问，为什么我们不指定用来加密它的<code class="fe nn no np nq b">KeyId</code>？答案是，<code class="fe nn no np nq b">KeyId</code>信息实际上包含在加密的参数中，因此，SSM 知道用哪个密钥来解密这个秘密。</p><p id="028e" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">该脚本可从终端运行，它接受一个参数，即参数的名称或路径。像这样从终端执行它。(注意，Boto3 将在您的环境中寻找 AWS 凭证)</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="8c42" class="nr lh it nq b gy oh oi l oj ok">$ ~/demo/kms-ssm-decrypt (venv) ❯ python3 retrieve_and_decrypt_ssm_secret.py "/demo/secret/parameter"</span><span id="f307" class="nr lh it nq b gy ol oi l oj ok">Secret is<br/>thisIsASecret<br/>=====<br/>Parameter details<br/>{'Parameter': {'Name': '/demo/secret/parameter', 'Type': 'SecureString', 'Value': 'thisIsASecret', 'Version': 1, 'LastModifiedDate': datetime.datetime(2020, 1, 30, 23, 26, 35, 169000, tzinfo=tzlocal()), 'ARN': 'arn:aws:ssm:ap-southeast-2:xxxxxxxxxxxx:parameter/demo/secret/parameter'}, 'ResponseMetadata': {'RequestId': '5ad11d35-axz6-42a0-90g5-0b7682a79321', 'HTTPStatusCode': 200, 'HTTPHeaders': {'x-amzn-requestid': '5ad07d20-ama6-43c0-90a4-0b7682a11267', 'content-type': 'application/x-amz-json-1.1', 'content-length': '239', 'date': 'Thu, 30 Jan 2020 12:48:53 GMT'}, 'RetryAttempts': 0}}</span></pre><p id="3e91" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">Tada！我们拿回了秘密参数— <code class="fe nn no np nq b">thisIsASecret</code>。🙂</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="ec11" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">包裹</h1><p id="91a0" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">到目前为止，您已经掌握了如何使用 AWS KMS 和 SSM 参数库保护您的应用程序机密的基本技能和知识。您还学习了如何以编程方式检索机密，以便可以在您的应用程序中使用它。</p><p id="918f" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">我希望本教程是有用的，并帮助您了解一种方法来保护您的应用程序的秘密。</p><p id="d90c" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">只是提醒一下，Github 回购在这里<a class="ae ky" href="https://github.com/billydh/kms-ssm-decrypt" rel="noopener ugc nofollow" target="_blank">可用</a>。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/08b25afd9f095c9f6c580d6de8a931f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2mCUxp4ERDS43sPT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Mauro Sbicego 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure></div></div>    
</body>
</html>