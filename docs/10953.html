<html>
<head>
<title>Random Forest on GPUs: 2000x Faster than Apache Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GPU 上的随机森林:比 Apache Spark 快 2000 倍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/random-forest-on-gpus-2000x-faster-than-apache-spark-9561f13b00ae?source=collection_archive---------18-----------------------#2020-07-30">https://towardsdatascience.com/random-forest-on-gpus-2000x-faster-than-apache-spark-9561f13b00ae?source=collection_archive---------18-----------------------#2020-07-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ce32" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">闪电般的快速模型训练与急流</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c3fbd9d5bd9502ce6f5eb8f842dd95fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7azp0XxjCxC2stKE"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@bady?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">巴迪·阿巴斯</a>拍摄的照片</p></figure><p id="77f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">声明:我是<a class="ae kv" href="https://www.saturncloud.io/" rel="noopener ugc nofollow" target="_blank">土星云</a>的高级数据科学家——我们用 Python、Dask 和 RAPIDS 让企业数据科学变得快速而简单。</p><p id="be84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更喜欢看？点击查看视频演练<a class="ae kv" href="https://youtu.be/IrbX9qhj5v4" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="082e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随机森林是一种机器学习算法，因其鲁棒性、准确性和可扩展性而受到许多数据科学家的信任。该算法通过 bootstrap 聚合来训练许多决策树，然后通过聚合森林中树的输出来进行预测。由于其整体特性，随机森林是一种可以在分布式计算环境中实现的算法。可以跨集群中的进程和机器并行训练树，从而比使用单个进程显著缩短训练时间。</p><p id="0665" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们探索了使用<a class="ae kv" href="http://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Spark </a>在 CPU 机器集群上实现分布式随机森林训练，并将其与使用<a class="ae kv" href="https://rapids.ai/" rel="noopener ugc nofollow" target="_blank"> RAPIDS </a>和<a class="ae kv" href="https://dask.org/" rel="noopener ugc nofollow" target="_blank"> Dask </a>在 GPU 机器集群上训练的性能进行比较。虽然 ML 世界中的 GPU 计算传统上是为深度学习应用程序保留的，但 RAPIDS 是一个在 GPU 上执行数据处理和非深度学习 ML 工作负载的库，与在 CPU 上执行相比，导致了巨大的性能加速。我们使用 3 亿个实例训练了一个随机森林模型:<strong class="ky ir"> Spark 在 20 节点 CPU 集群上花费了 37 分钟</strong>，而<strong class="ky ir"> RAPIDS 在 20 节点 GPU 集群上花费了 1 秒</strong>。这比 GPU 快了 2000 多倍🤯！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">曲速随机森林与 GPU 和急流！</p></figure><h1 id="1206" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">实验概述</h1><p id="cf04" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们使用公开可用的<a class="ae kv" href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page" rel="noopener ugc nofollow" target="_blank">纽约出租车数据集</a>并训练一个随机森林回归器，该回归器可以<a class="ae kv" href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction" rel="noopener ugc nofollow" target="_blank">使用与乘客接送相关的属性预测出租车的费用金额</a>。将 2017 年、2018 年和 2019 年的出租车乘坐次数作为训练集，总计<strong class="ky ir"> 300，700，143 个实例</strong>。</p><p id="dbbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">火花和急流代码可在 Jupyter 笔记本<a class="ae kv" href="https://github.com/saturncloud/saturn-cloud-examples/tree/main/machine_learning/random_forest" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><h1 id="64cd" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">五金器具</h1><p id="1782" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">Spark 集群使用亚马逊 EMR 管理，而 Dask/RAPIDS 集群使用<a class="ae kv" href="https://www.saturncloud.io/" rel="noopener ugc nofollow" target="_blank">土星云</a>管理。</p><p id="1237" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">两个集群都有 20 个带有这些 AWS 实例类型的工作节点:</p><p id="4234" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">火花</strong> : <code class="fe mr ms mt mu b">r5.2xlarge</code></p><ul class=""><li id="c448" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated">8 个 CPU，64 GB 内存</li><li id="7d7e" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">按需价格:0.504 美元/小时</li></ul><p id="001f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">急流</strong> : <code class="fe mr ms mt mu b">g4dn.xlarge</code></p><ul class=""><li id="0a4a" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated">4 个 CPU，16 GB 内存</li><li id="9840" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">1 个 GPU，16 GB GPU 内存(英伟达 T4)</li><li id="6736" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">点播价格:0.526 美元/小时</li></ul><p id="d04b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">土星云也可以使用 NVIDIA Tesla V100 GPUs 启动 Dask 集群，但我们选择了<code class="fe mr ms mt mu b">g4dn.xlarge</code>进行此次测试，以保持与 Spark 集群类似的每小时成本。</p><h1 id="f84c" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">火花</h1><p id="8c2c" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated"><a class="ae kv" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Spark </a>是一个开源的大数据处理引擎，内置于 Scala 中，带有一个 Python 接口，向下调用 Scala/JVM 代码。它是 Hadoop 处理生态系统中的一个主要部分，围绕 MapReduce 范式构建，具有数据帧接口和机器学习接口。</p><p id="6c1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="http://spark.apache.org/docs/latest/cluster-overview.html" rel="noopener ugc nofollow" target="_blank">设置 Spark 集群</a>超出了本文的范围，但是一旦集群准备好了，就可以在 Jupyter 笔记本中运行以下命令来初始化 Spark:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="4655" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mr ms mt mu b">findspark</code>包检测 Spark 安装在您系统上的位置；如果火花包是可发现的，则不需要这样做。需要设置几个<a class="ae kv" href="https://spark.apache.org/docs/latest/configuration.html" rel="noopener ugc nofollow" target="_blank">配置设置</a>来获得高性能的 Spark 代码，这取决于您的集群设置和工作流。在这种情况下，我们设置<code class="fe mr ms mt mu b">spark.executor.memory</code>来确保我们不会遇到任何内存溢出或 Java 堆错误。</p><h1 id="a336" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">湍流</h1><p id="c8b1" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated"><a class="ae kv" href="https://rapids.ai/" rel="noopener ugc nofollow" target="_blank"> RAPIDS </a>是一个开源的 Python 框架，它在 GPU 而不是 CPU 上执行数据科学代码。这为数据科学工作带来了巨大的性能增益，类似于训练深度学习模型所看到的那些。RAPIDS 有数据帧、ML、图形分析等接口。RAPIDS 使用<a class="ae kv" href="https://dask.org/" rel="noopener ugc nofollow" target="_blank"> Dask </a>来处理具有多个 GPU 的机器的并行化，以及每个具有一个或多个 GPU 的机器集群。</p><p id="ae0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">设置 GPU 机器可能有点棘手，但<a class="ae kv" href="https://www.saturncloud.io/" rel="noopener ugc nofollow" target="_blank"> Saturn Cloud </a>有用于启动 GPU 集群的预建映像，因此您只需几分钟就可以启动并运行！要初始化指向集群的 Dask 客户端，可以运行以下命令:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="f68c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要自己设置 Dask 集群，请参考<a class="ae kv" href="https://docs.dask.org/en/latest/setup.html" rel="noopener ugc nofollow" target="_blank">本文档页面</a>。</p><h1 id="86cf" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">数据加载</h1><p id="c43b" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">数据文件托管在一个公共的 S3 存储桶上，因此我们可以直接从那里读取 CSV。S3 存储桶将所有文件放在同一个目录中，所以我们使用<code class="fe mr ms mt mu b">s3fs</code>来选择我们想要的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="6a08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用 Spark，我们需要单独读取每个 CSV 文件，然后将它们组合在一起:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="db6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用 Dask+RAPIDS，我们可以一次性读入所有 CSV 文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><h1 id="58c8" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">特征工程</h1><p id="6b0b" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们将根据拾取时间生成一些要素，然后缓存/保存数据帧。在这两个框架中，这会执行所有的 CSV 加载和预处理，并将结果存储在 RAM 中(在 RAPIDS 中是 GPU RAM)。我们将用于培训的功能有:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="9638" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于 Spark，我们需要将特性收集到一个<code class="fe mr ms mt mu b">Vector</code>类中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="ac55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于 RAPIDS，我们将所有浮点值转换为 GPU 计算的<code class="fe mr ms mt mu b">float32</code>精度:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><h1 id="db51" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">训练随机森林！</h1><p id="e6f0" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们用几行代码为两个包初始化并训练随机森林。</p><p id="eec6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">火花:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><p id="7470" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">急流:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><h1 id="d825" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">结果</h1><p id="2f40" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们在 Spark (CPU)和 RAPIDS (GPU)集群上对纽约市出租车数据的 300，700，143 个实例训练了一个随机森林模型。两个集群都有 20 个工作节点，小时价格大致相同。以下是工作流程各部分的结果:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/d260d3fcbcd9cd2e52f9f3f36a613501.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*COU9AIOe1MTBOqPG2_72tg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">随机森林的火花与急流</p></figure><blockquote class="nl nm nn"><p id="98b4" class="kw kx no ky b kz la jr lb lc ld ju le np lg lh li nq lk ll lm nr lo lp lq lr ij bi translated">Spark 是 37 分钟，而 RAPIDS 是 1 秒钟！</p></blockquote><p id="a5bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">赢得胜利的 GPU！想想当你不需要为一个<em class="no">单次拟合</em>等待超过 30 分钟时，你可以多快地迭代和改进你的模型。一旦您添加了超参数调整或测试不同的模型，每次迭代很容易增加到几个小时或几天。</p><p id="4575" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">需要看到才相信？你可以在这里找到笔记本<a class="ae kv" href="https://github.com/saturncloud/saturn-cloud-examples/tree/main/machine_learning/random_forest" rel="noopener ugc nofollow" target="_blank">，自己运行！</a></p><h1 id="b8ec" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">你需要更快的随机森林吗？</h1><p id="95d2" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">是啊！有了<a class="ae kv" href="https://www.saturncloud.io/" rel="noopener ugc nofollow" target="_blank">土星云</a>，你可以在几秒钟内进入 Dask/RAPIDS 集群。Saturn 处理所有工具基础设施、安全性和部署方面的问题，让您立即开始使用 RAPIDS。点击<a class="ae kv" href="https://manager.aws.saturnenterprise.io/register" rel="noopener ugc nofollow" target="_blank">在你的 AWS 账户中免费试用</a>Saturn！</p><p id="47d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看<a class="ae kv" rel="noopener" target="_blank" href="/supercharging-hyperparameter-tuning-with-dask-ab2c28788bcf">用 Dask 调节增压超参数</a></p></div></div>    
</body>
</html>