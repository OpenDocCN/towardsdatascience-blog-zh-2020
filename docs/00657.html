<html>
<head>
<title>Protect your API via Input Validation in Python 3 Data Class</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Python 3数据类中的输入验证来保护您的API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/protect-your-api-via-input-validation-in-python-3-data-class-edefa5e280df?source=collection_archive---------9-----------------------#2020-01-19">https://towardsdatascience.com/protect-your-api-via-input-validation-in-python-3-data-class-edefa5e280df?source=collection_archive---------9-----------------------#2020-01-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="15b6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将json输入反序列化为Python 3数据类，并验证输入值以保护您的API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/13f9d28081cc9554ca84e60e959cbe6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CPeggXREUU5obzu5"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@gaspanik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Masaaki Komori </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d9fa" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="1435" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在构建web API时，我们不可避免地需要保护它，否则它可能会被恶意用户利用。一种方法是对API接收的请求体进行输入验证。如果这是一个错误的输入，例如，我们的API期望一个电子邮件地址，但是却给了一个地址，那么，我们的API将(或者应该)拒绝该数据并返回一个状态代码<code class="fe mu mv mw mx b">400 — BAD REQUEST</code>。</p><p id="7a8b" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">服务器端的输入验证必须在客户端的输入验证之上完成。原因是来自客户端的数据不可信，因为在数据到达服务器之前，任何事情都可能发生，例如，中间人(MITM)攻击。此外，请记住，请求可能来自任何地方，例如，Postman或curl，而不仅仅是来自您的web和/或移动应用程序。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="f9fa" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">你会学到什么</h1><p id="1efb" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">您将学习如何使用Python 3的<code class="fe mu mv mw mx b">dataclass</code>对API请求体建模，并使用<code class="fe mu mv mw mx b">marshmallow-dataclass</code>包对其进行输入验证。</p><p id="3b5b" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们将在本教程中介绍的用例是一个API，它接受一个电子邮件地址作为输入，如果用户数据库中不存在该电子邮件地址，它将基于该电子邮件地址创建一个新的用户帐户。</p><p id="b91a" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">本教程的系统详细信息:</p><ul class=""><li id="675b" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated">Python: <code class="fe mu mv mw mx b">3.8.1</code></li><li id="24d7" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">皮普:<code class="fe mu mv mw mx b">19.3.1</code></li><li id="a1d2" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">虚拟人:<code class="fe mu mv mw mx b">16.7.9</code></li><li id="177f" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">马科斯·卡特琳娜:<code class="fe mu mv mw mx b">10.15.2</code></li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="de83" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">安装依赖项</h1><p id="c72b" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">需要安装两个依赖包:</p><ul class=""><li id="a5b1" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated">棉花糖-数据类:<code class="fe mu mv mw mx b">7.2.1</code></li><li id="28b3" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">dataclass-json: <code class="fe mu mv mw mx b">0.3.6</code></li></ul><p id="d1ea" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们继续将它们安装在您的Python项目的虚拟环境中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用pip安装marshmallow-dataclass</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="bcbc" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">编写请求体模型</h1><p id="e151" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如前所述，我们将使用Python 3的<code class="fe mu mv mw mx b">dataclass</code>来建模我们的API请求体。输入是一个电子邮件地址。继续创建基本的<code class="fe mu mv mw mx b">dataclass</code>，不需要任何输入验证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">没有输入验证的初始数据类</p></figure><p id="8b32" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">接下来，我们还将添加<code class="fe mu mv mw mx b">@dataclass_json</code> decorator，以便能够将json请求体反序列化到<code class="fe mu mv mw mx b">CreateUser</code>数据类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建用dataclass_json修饰的用户</p></figure><p id="c3aa" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">现在，如果我们试图向<code class="fe mu mv mw mx b">CreateUser</code>传递任何类型的输入，它都会接受。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">示例显示CreateUser接受任何类型的输入</p></figure><p id="f5a4" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这不太好，是吗？😰</p><p id="8434" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们在下一节看看如何改进它。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5d16" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">添加输入字段验证</h1><p id="5bda" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将为<code class="fe mu mv mw mx b">CreateUser</code>数据类的<code class="fe mu mv mw mx b">emailAddress</code>字段添加一个验证器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用电子邮件地址验证创建用户</p></figure><p id="99b3" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">现在，继续尝试通过传递不同的输入值来创建<code class="fe mu mv mw mx b">CreateUser</code>的对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CreateUser对象仍然接受任何类型的输入</p></figure><p id="bc88" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">不幸的是，我们的<code class="fe mu mv mw mx b">CreateUser</code>数据类仍然接受任何类型的输入。😦</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="80ee" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">使用模式去序列化和验证</h1><p id="752e" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">输入验证的工作方式是通过一个代表我们感兴趣的<code class="fe mu mv mw mx b">dataclass</code>的<strong class="ma iu">模式</strong>。在前面的部分中，我们还没有创建模式，这就是验证没有工作的原因。</p><p id="6f4a" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">为了创建<code class="fe mu mv mw mx b">CreateUser</code>的模式，我们需要使用<code class="fe mu mv mw mx b">marshmallow_dataclass</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加CreateUserSchema</p></figure><p id="0401" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">同样，我们初始化一个<code class="fe mu mv mw mx b">CreateUser</code>对象的方式需要调整，以利用我们刚刚生成的<code class="fe mu mv mw mx b">CreateUserSchema</code>模式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建CreateUser对象的模式示例</p></figure><p id="679a" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们的输入验证与<code class="fe mu mv mw mx b">CreateUserSchema</code>一起工作。这样，我们的API将受到保护，不会收到不是有效电子邮件地址的垃圾输入。🙂</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="7e2b" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">使用模式进行输入验证的更简单方法</h1><p id="65e3" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">最后，我想向您展示我们如何从<code class="fe mu mv mw mx b">dataclass</code>中自动创建模式。</p><p id="6ddd" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">为此，我们需要使用由<code class="fe mu mv mw mx b">marshmallow_dataclass</code>包提供的<code class="fe mu mv mw mx b">@dataclass</code>装饰器，它的行为就像Python 3.x的标准<code class="fe mu mv mw mx b">dataclasses</code>库中的<code class="fe mu mv mw mx b">@dataclass</code>装饰器一样。</p><p id="0404" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们修改我们的<code class="fe mu mv mw mx b">CreateUser</code>数据类并删除<code class="fe mu mv mw mx b">CreateUserSchema</code>，因为它的创建将是自动的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用marshmallow_dataclass自动创建模式</p></figure><p id="6989" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们看看如何使用修改后的<code class="fe mu mv mw mx b">CreateUser</code>数据类创建一个<code class="fe mu mv mw mx b">CreateUser</code>对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用自动化模式创建CreateUser对象的示例</p></figure><p id="2543" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们的代码现在简单多了，输入验证也像预期的那样工作。我们成功了，伙计们！💪</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/bdcc00a78a86bb1b4b8f9ef4c291323f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bloe_R2_obaOJ9gf"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@japhethmast?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">雅弗桅杆</a>拍摄</p></figure></div></div>    
</body>
</html>