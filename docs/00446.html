<html>
<head>
<title>Deploy Neural Network with Flask, Docker and AWS Beanstalk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Flask、Docker 和 AWS Beanstalk 部署神经网络</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-neural-network-with-flask-docker-and-aws-beanstalk-6fd34373497a?source=collection_archive---------32-----------------------#2020-01-13">https://towardsdatascience.com/deploy-neural-network-with-flask-docker-and-aws-beanstalk-6fd34373497a?source=collection_archive---------32-----------------------#2020-01-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8fdb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何部署预测语音情感的机器学习多类分类 Keras 模型？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2945765ee0301d66200eea25157a7f84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dPJ7JGEWHZYw0ULR4cdpAg.png"/></div></div></figure><p id="1833" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第一部分:<br/>构建 NN 模型，Flask 应用程序，包括用于录音机的 Html、CSS、js。</p><p id="ca30" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第二部分:<br/>如何为你的 Docker 镜像选择合适的配置。</p><p id="eaa3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第三部分:<br/>在 AWS 弹性豆茎上部署以及如何调整录音笔。</p><p id="ddfa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以上所有内容也包含常见的故障排除。其中一些你会在我的<a class="ae lq" href="https://stackoverflow.com/users/11541027/daniel-moraite" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a>上找到。</p><p id="9d2e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">第一部分</strong> : <br/>为什么要声情并茂？由于过去十年技术的指数增长，生活方式发生了变化，人们要求更快、更容易地使用服务。许多公司确实续签了合同，并且只通过一个电话就获得了合法有效的客户协议。更不用说所有的营销，客户成功和销售使用。从语音输入/电话中预测客户的情绪变得非常必要。</p><p id="f1dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们来看看语音情感模型。<br/>用于训练模型的数据集:在受控环境中包含不同的说话者，主要是演员，并且确实传达了以下情绪，对于女性和男性:<strong class="kw iu">愤怒、厌恶、恐惧、高兴、中立、悲伤、惊讶</strong>。(14 节课——因为把女声和男声分开训练总是明智的)。</p><p id="1963" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了从音频中提取和转换数据特征(梅尔频率倒谱系数:<em class="lr"> MFCC </em>),我使用了<em class="lr"> LibROSA </em>。使用<strong class="kw iu"> </strong> Keras 建立<strong class="kw iu">模型</strong>:<em class="lr">顺序</em>带<em class="lr"> Conv1D </em>层带<em class="lr">批处理规范化</em>、<em class="lr"> Dropout、</em>和<em class="lr"> MaxPooling1D </em>。请随意试用我的<a class="ae lq" href="https://www.kaggle.com/dannydoeslight/voice-sentiment-a-quick-look" rel="noopener ugc nofollow" target="_blank"> Kaggle 内核</a>。</p><p id="8ddc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> Flask 应用</strong>:向用户请求数据，并保存为 WAV 文件，以便以后处理和预测。这里需要记住几件事:</p><ul class=""><li id="d9f7" class="ls lt it kw b kx ky la lb ld lu lh lv ll lw lp lx ly lz ma bi translated">确保您的应用程序文件的名称是:<em class="lr"> application.py </em>和<code class="fe mb mc md me b">application=FLASK(__name__)</code></li><li id="1d52" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">当谈到 Keras 和 Flask 时:你会发现<strong class="kw iu"> Keras 不是线程安全的</strong>，你需要使用<code class="fe mb mc md me b">model._make_predict_function()<br/></code>为什么会这样，如何解决，在<a class="ae lq" href="https://stackoverflow.com/questions/53391618/tensor-tensorpredictions-softmax0-shape-1000-dtype-float32-is-not-an/59238039#59238039" rel="noopener ugc nofollow" target="_blank">我的 StackOverflow 解决方案</a>上找到它(这里你得到了使用上述方法的优点和缺点<a class="ae lq" href="https://stackoverflow.com/questions/40850089/is-keras-thread-safe/59237758#59237758" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><p id="149b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我的<a class="ae lq" href="https://github.com/DanielMoraite/NN-Deploy-with-Docker-and-AWS-Beanstalk" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中找到<strong class="kw iu">录音机</strong>的 Html、CSS 和<strong class="kw iu"> js </strong>。可以在 recapp.js 中修改录音时间，只要记住 1 秒=1000 毫秒:<code class="fe mb mc md me b">setTimeout(function(){console.log("Recording:time up");stopRecording();},4000);</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eb65623f08ea88d7dfbf1a5d7abc1c12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H6YV42qwH9N5VZKB2-T0FA.png"/></div></div></figure><p id="03e2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">第二部分</strong> : <br/>我首先用 AWS Beanstalk 部署了 Flask 应用程序，发现服务器错误日志并不是那么详细和清晰，所以我发现 Docker 错误日志非常有用。</p><p id="de4d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当然，Docker 附带了许多其他的一体化工具和功能，使得构建环境变得更加简单和紧凑。</p><p id="d395" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将帮助您在构建 Docker 映像和处理故障排除时做出正确的选择:</p><ul class=""><li id="a9e6" class="ls lt it kw b kx ky la lb ld lu lh lv ll lw lp lx ly lz ma bi translated">从一开始就考虑容器/图像大小的限制，并为 python 图像选择正确的版本。你将在你的 docker 文件中设置这个:<code class="fe mb mc md me b">FROM python:3.6-slim</code>(注意:现在将避免 Alpine Linux，因为一些不合适的东西:更少的库，不同的 C 库，等等。).选择最精简版本的唯一问题是，你可能需要安装一些库/依赖项。而且可能相当麻烦… python 依赖项，如 LibROSA、GCC 等的声音文件..</li><li id="8519" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">您可能需要安装系统软件包，为此，您将需要安装 sudo。附注:当提示 Y/N 时，不要忘记使用<em class="lr"> -y </em>，否则如果没有键盘输入，安装将中止。</li><li id="9df9" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">对于音频安装<em class="lr"> libsndfile1-dev </em>(这应该可以解决 Linux 和 Ubuntu 的所有问题)。</li><li id="ebe6" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">确保在一次运行中运行所有内容，以避免创建中间映像:</li></ul><pre class="kj kk kl km gt mk me ml mm aw mn bi"><span id="13ec" class="mo mp it me b gy mq mr l ms mt">RUN apt-get update &amp;&amp; \<br/>      apt-get -y --no-install-recommends install sudo &amp;&amp; \<br/>      sudo apt-get -y --no-install-recommends install libsndfile1-dev &amp;&amp; \<br/>      pip install --no-cache-dir -r requirements.txt &amp;&amp; \<br/>      sudo rm -rf /var/lib/apt/lists/*</span></pre><ul class=""><li id="c616" class="ls lt it kw b kx ky la lb ld lu lh lv ll lw lp lx ly lz ma bi translated">要确保软件包不安装主动提供的依赖项:<br/> - <code class="fe mb mc md me b">sudo --no-install-recommends </code>或<code class="fe mb mc md me b">pip instal --no-deps #no dependencies </code>尽管这在处理 Tensorflow 和 Keras(如 Scikit-learn、SciPy 等)时可能会很麻烦。)<br/> - <code class="fe mb mc md me b">pip instal --no-cache-dir</code>有助于额外的缓存，<br/> -也有助于清理剩菜:<code class="fe mb mc md me b">sudo rm -rf /var/lib/apt/lists/*</code></li><li id="2676" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">docker 文件中的其他行应该涵盖申请的其余部分，如:</li></ul><pre class="kj kk kl km gt mk me ml mm aw mn bi"><span id="503f" class="mo mp it me b gy mq mr l ms mt">WORKDIR /deploy/   # pick your working directory<br/>COPY . .           # useful for copying all folders and subfolders</span><span id="a291" class="mo mp it me b gy mu mr l ms mt">EXPOSE 5000        # set port 5000 for Flask app<br/>CMD [“python”, “application.py”]  #application to be run</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c5ec08c50a91305bd030fe5be70183e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Exk6Yjty09EgkxXAUr0fqA.png"/></div></div></figure><p id="ffaf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">亚马逊网络服务和弹性豆茎看起来是个不错的选择。</p><p id="0d44" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我已经遵循了创建单个容器 docker 环境<a class="ae lq" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/single-container-docker.html" rel="noopener ugc nofollow" target="_blank">的所有说明。</a></p><p id="3fc4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你使用 AWS 控制台，事情就很简单了。如果您使用 AWS/EB CLI，请确保在安装 EB CLI 后设置路径:</p><pre class="kj kk kl km gt mk me ml mm aw mn bi"><span id="de1a" class="mo mp it me b gy mq mr l ms mt">echo 'export PATH="/Users/Daniel/.ebcli-virtual-env/executables:$PATH"' &gt;&gt; ~/.bash_profile &amp;&amp; source ~/.bash_profile</span></pre><p id="2e92" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您在 beanstalk 中创建新的应用程序和环境，上传 docker 应用程序文件夹内容的归档/zip。从控制台中，您可以修改容量、想要使用的<em class="lr">实例</em>、环境类型<em class="lr">(负载平衡、自动伸缩)等等。</em></p><p id="6464" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们来看看故障排除:</p><ul class=""><li id="7e26" class="ls lt it kw b kx ky la lb ld lu lh lv ll lw lp lx ly lz ma bi translated">现在所有问题都已解决并部署完毕，您可以访问 AWS beanstalk <strong class="kw iu"> Http </strong>链接，该链接将您带到您的应用程序，您可能会发现您的语音应用程序运行得非常好，只是您可以通过 web 浏览器请求访问您用户的麦克风。答案很简单:确保你在 https 上运行它。</li><li id="35ec" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">然后<strong class="kw iu"> OpenSSL </strong>注册并获得<strong class="kw iu">密钥</strong>以及自己签署<strong class="kw iu"> RSA </strong>(仅用于开发目的)。并将所有内容添加到 docker 下的 YAML 或 JSON 文件中。ebextensions”文件夹。(在我的<a class="ae lq" href="https://github.com/DanielMoraite/NN-Deploy-with-Docker-and-AWS-Beanstalk" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到)</li><li id="4f5e" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">如果你是 Mac 用户，遇到 __MACOSX/错误，只需<a class="ae lq" href="https://stackoverflow.com/questions/29051274/configuring-ssl-on-elastic-beanstalk-single-instance/59459665#59459665" rel="noopener ugc nofollow" target="_blank">在命令行<code class="fe mb mc md me b">zip -d Archive.zip __MACOSX/\*</code>中对你的文档执行</a>操作</li><li id="e016" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">如果你得到的错误为<em class="lr">配置文件。应用程序版本…中的 ebextensions/filename.config 包含无效的 YAML 或 JSON。YAML 异常:无效的 Yaml:在解析"&lt;阅读器&gt;"行</em>…等中的块映射时。:确保您的 RSA 密钥行对齐并且与 YAML 兼容。</li><li id="16bf" class="ls lt it kw b kx mf la mg ld mh lh mi ll mj lp lx ly lz ma bi translated">为 HTTPS 配置 AWS Beanstalk 单实例 SSL 的结论(针对 Docker env):在花时间搞清楚 YAML 和制表符与空格(或者在键页脚后没有空格，或者..)在我的编辑器(<em class="lr"> Atom/Packages/Whitespace </em>)，甚至将 YAML 转换为 JSON(<em class="lr">Atom/Packages/YAML _ JSON 转换器</em>)中，我已经意识到<strong class="kw iu">初始密钥被破解</strong>，不得不<strong class="kw iu"> <em class="lr">生成一个新的集合！！！</em>T9】</strong></li></ul><p id="be28" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以上所有代码和指令都可以通过我的<a class="ae lq" href="https://stackoverflow.com/questions/29051274/configuring-ssl-on-elastic-beanstalk-single-instance/59459665#59459665" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a> response 找到。</p><p id="5175" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望这有所帮助(并且<strong class="kw iu">为你节省了几天的辛苦工作</strong>)现在你的应用程序运行顺利，你也喜欢这些预测。我的 Github 上提供的模型给出了略低于<em class="lr"> 50%的准确度</em>——尽管乍一看这对于多类分类来说是相当好的。</p><p id="b39a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">保重，祝大家 2020 年<em class="lr">，</em></p><p id="bdb4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">指数级增长和创新的新十年！！！</p><p id="d842" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">丹尼尔（男子名）</p></div></div>    
</body>
</html>