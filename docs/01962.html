<html>
<head>
<title>Metaflow: Build and Manage Real-Life Data Science Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">元流:构建和管理现实生活中的数据科学项目</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/metaflow-build-and-manage-real-life-data-science-projects-1bd5f9a07acd?source=collection_archive---------18-----------------------#2020-02-24">https://towardsdatascience.com/metaflow-build-and-manage-real-life-data-science-projects-1bd5f9a07acd?source=collection_archive---------18-----------------------#2020-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8d9c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">不需要数据操作；独立构建、改进、运营和部署端到端数据工作流。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/94a3d521bb8d8c9d44c25519f0a24ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*leBP6fsxG0zQo9g276cL_g.png"/></div></div></figure><blockquote class="ku kv kw"><p id="9d6b" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://mailchi.mp/d2d2d4a109b5/learning-rate-newsletter" rel="noopener ugc nofollow" target="_blank"> Learning Rate </a>是为那些对AI和MLOps的世界感到好奇的人准备的时事通讯。你会在每周五收到我关于最新人工智能新闻和文章的更新和想法。订阅<a class="ae lu" href="https://mailchi.mp/d2d2d4a109b5/learning-rate-newsletter" rel="noopener ugc nofollow" target="_blank">这里</a>！</p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="2b61" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">如今，数据科学家可以利用他们掌握的工具做任何事情。主要云提供商提供对象存储架构和流行的SQL数据库管理系统作为服务，基础架构管理只需一个配置文件，调度程序可以随时随地执行任何作业。</p><p id="c58e" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">然而，这些都不容易设置，不容易利用其优势并在其上构建。在数据科学的世界里，你很少遇到对DevOps工具感到舒适的人，甚至很少遇到愿意自学的人。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mf"><img src="../Images/227fb5e781837f02524b5a0e04155bd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddj9JhZxCv9sszimFiji2w.png"/></div></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">数据科学项目的层次</p></figure><p id="f8f2" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">这是<em class="kz">元流</em>试图缓解的问题之一。它提供了一个以人为中心的框架，帮助科学家和工程师构建和管理现实生活中的数据科学项目。该框架最初在网飞开发，并在AWS re:Invent 2019上开源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">AWS re:Invent 2019上的Metaflow演示</p></figure><p id="581c" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">在这个故事中，我们将介绍元流的基本概念，并提供展示其潜力的简单代码示例。</p><h1 id="00cb" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">基本原则</h1><p id="f9ec" class="pw-post-body-paragraph kx ky it la b lb ne ju ld le nf jx lg mc ng lj lk md nh ln lo me ni lr ls lt im bi translated">元流遵循数据流编程范式，其中程序被设计为一个有向图，数据从一个操作移动到下一个操作。这种设计很自然地出现在数据科学项目中，其中管道的概念是一种合理且常见的抽象。Metaflow还自动负责版本控制，并提供了一种简单的、声明性的方式来管理依赖性和计算资源。</p><p id="e993" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">在接下来的部分中，我们将考虑一个简单的实验，我们创建一个随机数据集作为一个数字数组，并对其执行若干操作。我们将讨论如何使用简单的线性流程，以及如何并行化工作，以利用可用资源并提高性能。</p><h2 id="088f" class="nj mn it bd mo nk nl dn ms nm nn dp mw mc no np my md nq nr na me ns nt nc nu bi translated">线性流动</h2><p id="8c0f" class="pw-post-body-paragraph kx ky it la b lb ne ju ld le nf jx lg mc ng lj lk md nh ln lo me ni lr ls lt im bi translated">线性流动是最直接的过渡类型。数据以连续的方式从一个操作流向下一个操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/9c87235eb5a094eba18ca73317b3b66f.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*-pfMwh7_d4gvxylq68N8cA.png"/></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">线性流动</p></figure><p id="ba0a" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">首先，每个流必须有一个<em class="kz">开始</em>和一个<em class="kz">结束</em>节点。因此，元流运行将寻找一个开始节点来启动执行，并寻找一个结束节点来标记终止。每个节点都被认为是一个<em class="kz">步骤</em>，并在代码中如此标注。</p><p id="8aed" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">在下面的例子中，我们在开始节点初始化一个随机数据集，在中间节点计算它的平均值，在结束节点打印结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw ml l"/></div></figure><p id="35bf" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">在这个简单的线性示例中，您将看到如何定义步骤，使用<code class="fe nx ny nz oa b">self.next()</code>方法和之前计算的参考变量从一个步骤前进到下一个步骤。</p><p id="691a" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">要运行这个作业，您可以在终端中执行<code class="fe nx ny nz oa b">python metaflow_1.py run</code>,预计计算时间不到一秒。当然，这是为了展示Metaflow的一些基本功能，并不是什么有价值的东西。让我们来看一个更复杂的例子。</p><h2 id="39c6" class="nj mn it bd mo nk nl dn ms nm nn dp mw mc no np my md nq nr na me ns nt nc nu bi translated">创建分支</h2><p id="218d" class="pw-post-body-paragraph kx ky it la b lb ne ju ld le nf jx lg mc ng lj lk md nh ln lo me ni lr ls lt im bi translated">为了创建一个更复杂的示例，让我们定义一个数字数组并执行三个操作:</p><ul class=""><li id="ede5" class="ob oc it la b lb lc le lf mc od md oe me of lt og oh oi oj bi translated">找出数组中的质数</li><li id="9d5a" class="ob oc it la b lb ok le ol mc om md on me oo lt og oh oi oj bi translated">找出数组中的奇数</li><li id="e188" class="ob oc it la b lb ok le ol mc om md on me oo lt og oh oi oj bi translated">找出数组中的偶数</li></ul><p id="3324" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">我们希望并行执行这些操作；因此，我们需要在图中创建分支。最终的数字应该如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/15cba46218293b0111b0ef4bf10e74f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*EEAKxYGcbUoyz8HyT-O8Pg.png"/></div></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">元流分支</p></figure><p id="4d58" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">元流可以在分布式环境中的多个CPU内核或多个实例上执行并行操作。最后，每一步都必须结合起来，以产生一个统一的结果，我们可以把这个流程传递下去。现在，让我们用python来实现它。首先，我们定义一些方便的函数，以便能够找到素数、奇数和偶数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw ml l"/></div></figure><p id="a52e" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">接下来，我们可以在图表中调用这些函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw ml l"/></div></figure><p id="bc70" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">通过在<code class="fe nx ny nz oa b">self.next()</code>方法中传递三个参数，我们让Metaflow知道我们想要并行调用这些操作，创建一个分支。最后，我们必须加入每个分支操作的结果。因此，我们需要从分支内部的每一步指向<code class="fe nx ny nz oa b">self.join</code>方法。</p><p id="d101" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated"><code class="fe nx ny nz oa b">join</code>方法接受一个额外的参数<code class="fe nx ny nz oa b">inputs</code>。这个变量是一个<code class="fe nx ny nz oa b">object</code>，它存储来自每个分支操作的结果。使用这个对象，您可以以一种简单的、面向对象的方式检索每个操作的变量。</p><p id="f6c0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">也就是说，我们有两个问题。首先，查找质数的函数并没有得到最佳实现。但这是故意的，这样我们就可以有一个执行时间更长的方法。</p><p id="04be" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">第二个问题是搜索奇数和偶数的两个函数会立即返回结果。因此，并行化这些操作不会给我们带来任何好处。相反，我们的代码的性能比简单的顺序方法更差，因为我们必须考虑元流图带来的开销。事实上，一个简单的python脚本需要大约2分钟来返回结果，而在我的设置中，Metaflow脚本要多花20秒。那么，我们能做得更好吗？当然啦！我们可以任意嵌套树枝！</p><h2 id="6b20" class="nj mn it bd mo nk nl dn ms nm nn dp mw mc no np my md nq nr na me ns nt nc nu bi translated">为每一个</h2><p id="6d0a" class="pw-post-body-paragraph kx ky it la b lb ne ju ld le nf jx lg mc ng lj lk md nh ln lo me ni lr ls lt im bi translated">如果我们能进一步并行化素数搜索会怎么样？我们可以。在Metaflow中我们可以任意嵌套分支，也就是说，你可以在一个分支内部分支。考虑到这一点，让我们再次设计我们的图表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/61398981865bb88cf32a3d0b7354332f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*chsRsX03RnbkzQ7iPUEGcw.png"/></div></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">嵌套分支</p></figure><p id="39f6" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">缺少的是能够并行化负责动态查找素数的操作，并行化到本地可用的任意数量的CPU核心，或者分布式环境中的任意数量的机器。这就是<code class="fe nx ny nz oa b">foreach</code>关键字的用武之地。下面我们可以看到实现这个图的python代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw ml l"/></div></figure><p id="a583" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated">这个脚本中有两个新概念。首先，<code class="fe nx ny nz oa b">Parameter</code>对象允许我们将选项传递给元流脚本。我们现在可以通过执行<code class="fe nx ny nz oa b">python &lt;file_name&gt;.py run --cores 4</code>来运行这个脚本。这个选项将使用NumPy的便利函数<code class="fe nx ny nz oa b">array_split()</code>把我们的数据集分成四个块。</p><p id="ef14" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg mc li lj lk md lm ln lo me lq lr ls lt im bi translated"><code class="fe nx ny nz oa b">foreach</code>关键字为iterable中的每个元素创建一个并行执行。在这种情况下，为分割数据集中的每个数组创建一个并行操作。如果我们使用默认的数字<code class="fe nx ny nz oa b">cores</code>，我们将数据集分成四个更小的集合，并并行执行<code class="fe nx ny nz oa b">prime</code>方法四次。我们刚刚把执行时间缩短到35秒！</p><h1 id="55a2" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">结论</h1><p id="c84e" class="pw-post-body-paragraph kx ky it la b lb ne ju ld le nf jx lg mc ng lj lk md nh ln lo me ni lr ls lt im bi translated">Metaflow是一个以人为中心的数据科学框架，最初由网飞开发。它旨在通过抽象基础设施细节并为开发人员提供一种直观的方式来构建他们的程序，从而促进构建和部署现实生活中的数据科学项目的过程。在这个故事中，我们展示了当地的故事，它的能力。准备好在AWS上投入并扩展您的数据科学项目了吗？从官方网站上的<a class="ae lu" href="https://docs.metaflow.org/getting-started/tutorials" rel="noopener ugc nofollow" target="_blank">教程</a>部分开始。</p><blockquote class="ku kv kw"><p id="e760" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">我叫Dimitris Poulopoulos，是希腊比雷埃夫斯大学<em class="it"/></strong><a class="ae lu" href="https://bigdatastack.eu/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">BigDataStack</strong></a><strong class="la iu"><em class="it"/>的机器学习研究员和博士(c)。我曾为欧洲委员会、欧盟统计局、国际货币基金组织、欧洲中央银行、经合组织和宜家等主要客户设计和实施人工智能和软件解决方案。如果你有兴趣阅读更多关于机器学习、深度学习和数据科学的帖子，请在twitter上关注我的</strong> <a class="ae lu" href="https://medium.com/@dpoulopoulos" rel="noopener"> <strong class="la iu">中</strong> </a> <strong class="la iu">、</strong><a class="ae lu" href="https://www.linkedin.com/in/dpoulopoulos/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">LinkedIn</strong></a><strong class="la iu">或</strong><a class="ae lu" href="https://twitter.com/james2pl" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">@ james2pl</strong></a><strong class="la iu">。</strong></p></blockquote></div></div>    
</body>
</html>