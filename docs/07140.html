<html>
<head>
<title>A Complete Introduction to Apache Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇气流公司简介</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-complete-introduction-to-apache-airflow-b7e238a33df?source=collection_archive---------3-----------------------#2020-06-01">https://towardsdatascience.com/a-complete-introduction-to-apache-airflow-b7e238a33df?source=collection_archive---------3-----------------------#2020-06-01</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="c3fc" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">关键概念、安装和一个真实世界的 DAG 示例</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/013d406c1f439334f4276e7fe24d9bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MEAs4U2tBiodkRbcJCBstw.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@byadonia?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">ahin yeilirapak</a>在<a class="ae kz" href="https://unsplash.com/s/photos/air?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7427" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">气流是一种自动化和计划任务和工作流的工具。如果您想以数据科学家、数据分析师或数据工程师的身份高效工作，拥有一个能够定期自动化您想要重复的过程的工具是至关重要的。这可以是从为常规分析报告提取、转换和加载数据到自动重新训练机器学习模型的任何操作。</p><p id="2148" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">气流使您能够轻松地自动化主要用 Python 和 SQL 编写的简单到复杂的过程，并拥有丰富的 web UI 来可视化、监控和解决任何可能出现的问题。</p><p id="ff6f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面的文章是对该工具的完整介绍。我已经包括了从在虚拟环境中安装到运行你的第一个 dag 的所有简单步骤。</p><p id="c356" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我把教程分成了 6 个部分，这样更容易理解，你可以跳过你可能已经熟悉的部分。包括以下步骤:</p><ol class=""><li id="d83c" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">基本气流概念。</li><li id="be1d" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">如何在虚拟环境中设置气流安装。</li><li id="9506" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">运行气流网络用户界面和计划程序。</li><li id="4ee3" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">常见 CLI 命令的列表。</li><li id="034d" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">网络用户界面之旅。</li><li id="cd92" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">创建一个真实世界的 DAG 示例。</li></ol></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="7f2c" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">1.基本概念</h1><p id="b576" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">在介绍气流的安装和使用之前，我将简要介绍该工具的几个核心概念。</p><h2 id="2eea" class="no ms iu bd mt np nq dn mx nr ns dp nb lj nt nu nd ln nv nw nf lr nx ny nh nz bi translated">熟练的技艺</h2><p id="e2a3" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">该工具的核心是 DAG(有向无环图)的概念。DAG 是您希望作为工作流的一部分运行的一系列任务。这可能包括通过 SQL 查询提取数据，用 Python 执行一些计算，然后将转换后的数据加载到一个新表中。在《气流》中，这些步骤将被写成 DAG 中的单独任务。</p><p id="7637" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您还可以通过气流指定任务之间的关系、任何依赖关系(例如，在运行任务之前已加载到表中的数据)以及任务的运行顺序。</p><p id="2dad" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">DAG 是用 Python 编写的，并保存为<code class="fe oa ob oc od b">.py</code>文件。工具广泛使用<strong class="lc iv"> DAG_ID </strong>来协调 DAG 的运行。</p><h2 id="627d" class="no ms iu bd mt np nq dn mx nr ns dp nb lj nt nu nd ln nv nw nf lr nx ny nh nz bi translated">DAG 运行</h2><p id="c4fa" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">我们具体说明了 DAG 应该在什么时候通过执行日期自动运行。DAG 按照指定的时间表(由 CRON 表达式定义)运行，可以是每天、每周、每分钟或几乎任何其他时间间隔</p><h2 id="6f75" class="no ms iu bd mt np nq dn mx nr ns dp nb lj nt nu nd ln nv nw nf lr nx ny nh nz bi translated">经营者</h2><p id="03e1" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">运算符将每个任务中要执行的操作封装在 DAG 中。Airflow 有各种各样的内置操作符，可以执行特定的任务，其中一些是特定于平台的。此外，还可以创建自己的自定义操作符。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="d41a" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">2.装置</h1><p id="2d43" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">我将给你我个人在一个隔离的<a class="ae kz" href="https://pypi.org/project/pipenv/" rel="noopener ugc nofollow" target="_blank">管道</a>环境中的气流设置。如果您使用不同的虚拟环境工具，这些步骤可能会有所不同。这种设置很大程度上受到了这种优秀的<a class="ae kz" href="https://stackoverflow.com/questions/56890937/how-to-use-apache-airflow-in-a-virtual-environment" rel="noopener ugc nofollow" target="_blank"> Stackoverflow 线程</a>的启发。</p><p id="6dee" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对你的 Airflow 项目使用版本控制是一个好主意，因此第一步是在 Github 上创建一个资源库。我把我的名字叫做<code class="fe oa ob oc od b">airflow_sandbox</code>。一旦您使用<code class="fe oa ob oc od b">git clone "git web url"</code>在本地环境中创建了存储库克隆。</p><p id="6d12" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">从终端导航到目录，例如<code class="fe oa ob oc od b">cd /path/to/my_airflow_directory</code>。</p><p id="de94" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在正确的目录中，我们安装 pipenv 环境以及特定版本的 Python、Airflow 本身和 Flask，后者是运行 Airflow 所必需的依赖项。为了让一切都正常工作，为所有安装指定特定的版本是一个好主意。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="1dce" class="no ms iu od b gz oi oj l ok ol">pipenv install --python=3.7 Flask==1.0.3 apache-airflow==1.10.3</span></pre><p id="3f16" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Airflow 需要在您的本地系统上运行一个名为<strong class="lc iv"> AIRFLOW_HOME </strong>的位置。如果我们不指定它，它将默认为您的路由目录。我更喜欢通过在. env 文件中指定气流来设置我正在工作的项目目录的路径。为此，只需运行以下命令。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="c0ef" class="no ms iu od b gz oi oj l ok ol">echo "AIRFLOW_HOME=${PWD}/airflow" &gt;&gt; .env</span></pre><p id="07d5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们初始化 pipenv 环境。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="06f9" class="no ms iu od b gz oi oj l ok ol">pipenv shell</span></pre><p id="456e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Airflow 需要一个数据库后端来运行。默认设置使用 SQLite 数据库，这对于学习和实验来说很好。如果你想建立自己的数据库后端，airflow 文档有一个很好的<a class="ae kz" href="https://airflow.apache.org/docs/stable/howto/initialize-database.html" rel="noopener ugc nofollow" target="_blank">指南</a>。初始化数据库类型。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="0b7a" class="no ms iu od b gz oi oj l ok ol">airflow initdb</span></pre><p id="576c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们创建一个目录来存储我们的 Dag。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="a9b6" class="no ms iu od b gz oi oj l ok ol">mkdir -p ${AIRFLOW_HOME}/dags/</span></pre><p id="8167" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这就是最初的基本设置完成。您现在应该有一个如下所示的项目结构。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj om"><img src="../Images/5475f6c0e2b401ce723879ff0fc3553d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*2MvpZYg74WT16NW8p-RmUA.png"/></div></figure><h1 id="1006" class="mr ms iu bd mt mu on mw mx my oo na nb ka op kb nd kd oq ke nf kg or kh nh ni bi translated">3.运行气流</h1><p id="f7cc" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">气流有一个优秀的网络用户界面，您可以查看和监控您的 Dag。要启动 web 服务器查看 UI，只需运行以下 CLI 命令。默认情况下，Airflow 将使用端口 8080，因为我已经使用它来运行我指定的 8081。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="44b5" class="no ms iu od b gz oi oj l ok ol">airflow webserver -p 8081</span></pre><p id="1bd9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们还需要启动调度程序。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="0936" class="no ms iu od b gz oi oj l ok ol">airflow scheduler</span></pre><p id="3292" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在如果我们导航到<a class="ae kz" href="http://localhost:8081/admin/?showPaused=True" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/admin/？showPaused=True </a>。我们将看到以下屏幕。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj os"><img src="../Images/7c5bbc764f1e733bddb106f95315ede7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZS4MhKoG9X6Uy6LllKI5hw.png"/></div></div></figure><p id="133b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Airflow 有一组显示在用户界面中的示例 Dag。一旦您开始创建自己的 Dag，您可以通过点按屏幕底部的“隐藏暂停的 Dag”来隐藏它们。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="db84" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">4.基本 CLI 命令</h1><p id="a235" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">让我们使用这些示例 Dag 来浏览一些常见的 Airflow CLI 命令。</p><p id="0dea" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们从教程 dag 运行睡眠任务。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="6fb9" class="no ms iu od b gz oi oj l ok ol">airflow run tutorial sleep 2020-05-31</span></pre><p id="f1b9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以在教程 DAG 中列出任务。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="d15b" class="no ms iu od b gz oi oj l ok ol">bash-3.2$ airflow list_tasks tutorial</span></pre><p id="85bf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">暂停这个 DAG。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="6875" class="no ms iu od b gz oi oj l ok ol">airflow pause tutorial</span></pre><p id="ac36" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Unpause 教程。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="d4c1" class="no ms iu od b gz oi oj l ok ol">airflow unpause tutorial</span></pre><p id="93ec" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">回填(在过去的日期执行任务)。指定 dag_id(教程)、开始日期(-s)和结束日期(-e)。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="f022" class="no ms iu od b gz oi oj l ok ol">airflow backfill tutorial -s 2020-05-28 -e 2020-05-30</span></pre><p id="485d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有关 CLI 命令的完整列表，请参见文档中的第<a class="ae kz" href="https://airflow.apache.org/docs/stable/cli-ref#backfill" rel="noopener ugc nofollow" target="_blank">页</a>。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="bb1b" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">5.网络用户界面</h1><p id="c519" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">我们可以从 web UI 监控、检查和运行任务。如果我们回到 web 服务器，我们可以看到我们在教程 DAG 上运行的 CLI 命令的效果。为了便于查看，我隐藏了暂停的 Dag。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ot"><img src="../Images/2c8f276dd21a3f25d70834b1f3fd5f80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vsOkqxAx20zCq473-iNIzA.png"/></div></div></figure><p id="4f3b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们有许多方法可以检查 DAGS 的运行情况。</p><p id="232e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我们选择树形视图。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ou"><img src="../Images/42a72e77e0d623cc03f876f310fd444a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*TMpHV9gGGlpjn9EN2UtqWw.png"/></div></figure><p id="bbb6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以轻松查看哪些任务已经运行、正在运行或已经失败。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ov"><img src="../Images/97a5bf715c0603e724235df56535810e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yqo5f3trpmCvmTdd1zs2Vw.png"/></div></div></figure><p id="ddc2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们还可以通过点击小方块来运行、清除或标记特定的任务。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ow"><img src="../Images/8054fe32b4165e0e15771e0eb0c7d5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YPaOyi_oHS0spLIS-9jIMw.png"/></div></div></figure><p id="0527" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我们单击 Rendered 按钮，我们可以查看已经运行的代码或命令。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ov"><img src="../Images/835f2502df97ffbd3c4786474c435c17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2oixl8MgDUX7YtfHt3NieQ.png"/></div></div></figure><p id="b00c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">代码视图让我们看到组成 DAG 的代码。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ox"><img src="../Images/5b1f2dcebb4ebc327752d35e7d879461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x6G2SANlvKd4aLK_RBs3WQ.png"/></div></div></figure><p id="e502" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">图表视图是可视化任务如何排序或关联的好方法。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oy"><img src="../Images/c86ffe3e9f9ef8025fa939772b2971c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rMTyf0mKsueQG6CC02bDQw.png"/></div></div></figure><p id="699b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">web UI 中的另一个重要区域是管理。在这里，您可以定义到其他平台(如数据库)的连接，并定义可重用的变量。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oz"><img src="../Images/4cd6591516a6dce8de754397bfd69606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otPsHNFhKh7l9v8XM33Zyw.png"/></div></div></figure></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="594c" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">6.第一个 DAG</h1><p id="162b" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">在这里，我将尝试给出一个接近真实世界的 DAG 示例，以说明至少一种使用气流的方法，并介绍随之而来的一些复杂性。</p><p id="7c82" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我将编写一个 Airflow DAG，它首先检查 BigQuery 公共数据集中是否存在感兴趣的日期的数据，然后将每天的数据加载到我自己的私人项目的一个表中。</p><p id="4b9f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">BigQuery 有一个免费的使用层，允许您每月查询 1TB 的数据，因此如果您想亲自尝试，您将能够零成本地做到这一点。</p><h2 id="ce05" class="no ms iu bd mt np nq dn mx nr ns dp nb lj nt nu nd ln nv nw nf lr nx ny nh nz bi translated">BigQuery 设置</h2><p id="8834" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">为了一起使用 Airflow 和 BigQuery，我们需要先完成一些额外的设置步骤。</p><p id="8fb9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了能够通过 Airflow 在 BigQuery 中查询和加载数据，我们需要首先给予 Airflow 所需的安全权限。</p><p id="a121" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为此，你需要在谷歌云平台上创建一个服务账户。这有点像创建一个有权限访问您的帐户的用户，但旨在允许其他平台访问。</p><p id="09a1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">首先从谷歌云控制台导航到<a class="ae kz" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务账户</a>。然后点击<strong class="lc iv">创建服务账户</strong>按钮。</p><p id="dfd0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来填写显示的表单。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pa"><img src="../Images/44c3cddef5583cce937d2c6ee102611b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VY_TA4VHDardnsW4OQDmWQ.png"/></div></div></figure><p id="fda6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在下一页，您需要选择想要授予的访问级别。我在所有资源中选择了<strong class="lc iv">编辑</strong>，因为这是我的个人账户，这里没有存储任何敏感数据。如果我更关心潜在的安全问题，那么我会授予更细粒度的权限。</p><p id="09c1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，您需要创建一个私钥，您可以通过选择<strong class="lc iv">创建密钥</strong>来完成。选择 JSON，因为这是你需要的气流。私钥将被下载到您的本地系统，您需要安全地存储它。</p><p id="09b2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们现在需要返回到 Airflow Web UI，用这个 JSON 文件的输出更新 bigquery_default 连接。您还需要添加一个默认的项目 id，如下所示。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pb"><img src="../Images/8f262c8db13df38602c6ef1a24464991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgKqRLih2SvC6OP7zSinjg.png"/></div></div></figure><p id="ab96" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们还需要在 pipenv 环境中安装一些 Google Cloud 依赖项。我已经安装了以下软件。</p><pre class="kk kl km kn gu oe od of og aw oh bi"><span id="325d" class="no ms iu od b gz oi oj l ok ol">pipenv install google-cloud-storage httplib2 google-api-python-client google-cloud-bigquery pandas_gbq</span></pre><h2 id="68d5" class="no ms iu bd mt np nq dn mx nr ns dp nb lj nt nu nd ln nv nw nf lr nx ny nh nz bi translated">创建 DAG</h2><p id="56bf" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">下面是将执行上述步骤的 DAG 的代码。这应该作为一个<code class="fe oa ob oc od b">.py</code>文件保存在我们之前创建的 dags 目录中。</p><p id="df49" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在 DAG 的顶部是必需的导入。Airflow 提供了一系列操作人员来执行谷歌云平台上的大多数功能。我已经导入了用于运行查询和加载数据的<strong class="lc iv"> BigQueryOperator </strong>，以及用于检查特定日期的数据是否存在的<strong class="lc iv"> BigQueryCheckOperator </strong>。</p><p id="c1a6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在 dag 的下一部分，我们定义 dag_args，然后创建 DAG，它提供诸如 dag_id、start_date 和任务运行频率等信息。Airflow 使用 CRON 表达式来定义时间表，有关这些表达式的更多信息，请访问此<a class="ae kz" href="https://airflow.apache.org/docs/stable/scheduler.html" rel="noopener ugc nofollow" target="_blank">页面</a>。</p><p id="e179" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后，我们将每个步骤定义为一个任务，我将它们定义为变量 t1 和 t2。这些任务各自执行工作流中的特定步骤。在 DAG 的最底部可以找到它们的运行顺序。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="pc pd l"/></div></figure><p id="8cf0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们现在可以转到 web 用户界面，运行 DAG。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pe"><img src="../Images/bc3f61350fcf53ba8c2204dfa91ea488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubDljhh_t99IRrYsfxSxvg.png"/></div></div></figure><p id="ac70" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我们转到 BigQuery 控制台，我们还会看到 Airflow 创建并加载了数据的表。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pf"><img src="../Images/515d9158df42efaf12ddc729986d347c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WmozZt-vo4hrmX_ivsvsYA.png"/></div></div></figure></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><p id="5c2d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文旨在全面介绍如何使用气流创建第一个 DAG。有关更详细的使用指南，可在<a class="ae kz" href="https://airflow.apache.org/docs/" rel="noopener ugc nofollow" target="_blank">这里</a>找到气流文件。</p><p id="cff0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">文章中详细描述的完整项目的链接可以在这个<a class="ae kz" href="https://github.com/rebecca-vickery/airflow_sandbox" rel="noopener ugc nofollow" target="_blank"> Github 资源库</a>中找到。</p><p id="0cc4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢阅读！</p><p id="0dc2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我每月都会发一份简讯，如果你想加入，请点击此链接注册。期待成为您学习旅程的一部分！T3】</p></div></div>    
</body>
</html>