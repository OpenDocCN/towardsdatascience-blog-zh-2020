<html>
<head>
<title>NLP Classification with Universal Language Model Fine-tuning (ULMFiT)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通用语言模型微调的自然语言处理分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/nlp-classification-with-universal-language-model-fine-tuning-ulmfit-4e1d5077372b?source=collection_archive---------17-----------------------#2020-08-09">https://towardsdatascience.com/nlp-classification-with-universal-language-model-fine-tuning-ulmfit-4e1d5077372b?source=collection_archive---------17-----------------------#2020-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eb85" class="pw-subtitle-paragraph jo ip iq bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">在本文中，我们将看到如何使用优于以前文本分类方法的 ULMFiT 建立一个 NLP 分类模型。</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/f062800fc3f1fd90098c02c23901ebb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hXdraIr1PYp_3O15opwraQ.jpeg"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">马库斯·温克勒在<a class="ae kw" href="https://unsplash.com/s/photos/machine-learning?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="a241" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">文本分类是自然语言处理的重要应用之一。诸如情感分析和识别垃圾邮件、机器人和攻击性评论等应用属于<strong class="kz ir">文本分类</strong>。到目前为止，用于解决这些问题的方法包括从头开始建立机器学习或深度学习模型，在你的文本数据上训练它们，并用超参数进行微调。尽管这种模型对于像分类电影评论是正面还是负面这样的应用程序来说给出了不错的结果，但如果事情变得更加模糊，它们可能会表现得非常糟糕，因为大多数时候没有足够多的标记数据可供学习。</p><blockquote class="lt lu lv"><p id="5217" class="kx ky lw kz b la lb js lc ld le jv lf lx lh li lj ly ll lm ln lz lp lq lr ls ij bi translated">但是等一下？Imagenet 不是用同样的方法对图像进行分类吗？那么，它是如何用同样的方法取得巨大成功的呢？如果我们不是从零开始建立一个模型，而是使用一个经过训练可以解决一个问题(对 Imagenet 中的图像进行分类)的模型作为基础来解决其他一些有点类似的问题(文本分类)，会怎么样呢？由于微调后的模型不必从头开始学习，因此它不需要大量数据就能提供更高的准确性。这就是<strong class="kz ir">迁移学习</strong>的原理，通用语言模型微调(ULMFiT)就是建立在这个原理上的。</p></blockquote><p id="18eb" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">今天，我们将了解如何利用这种方法进行情感分析。您可以在此阅读更多关于 ULMFiT、其优势以及与其他方法的比较<a class="ae kw" href="http://nlp.fast.ai/classification/2018/05/15/introducing-ulmfit.html" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="9c9e" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><strong class="kz ir"> fastai </strong>库提供了训练和使用 ULMFiT 模型所需的模块。你可以在这里查看库<a class="ae kw" href="https://github.com/fastai/fastai" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3302" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们要解决的问题是美国航空公司的情绪分析。你可以从<a class="ae kw" href="https://www.kaggle.com/crowdflower/twitter-airline-sentiment#Tweets.csv" rel="noopener ugc nofollow" target="_blank">这里</a>下载数据集。所以事不宜迟，我们开始吧！</p><p id="5e9b" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">首先，让我们导入所有的库。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="4338" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在，我们将把数据的 CSV 文件转换成 Pandas Dataframe 并查看数据。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mc"><img src="../Images/921c80561fb596a6927653d763685149.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_eplBnV02r9Ke0TD3MrmA.png"/></div></div></figure><p id="ddd1" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在我们检查数据帧中是否有空值。我们观察到在 negative_reason 列中有 5462 个空值。这些空属于积极+中性的情绪有道理。我们通过统计所有非负面推文来验证这一点。两个号码都匹配。negativereason_confidence 计数与<em class="lw"> negativereason </em>计数不匹配的原因是 negativereason_confidence 列中的 0 值对应于<em class="lw"> negativereason </em>列中的空白。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="8136" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果我们看看数据样本的总数，它是 14640。列 airline _ 情操 _ 黄金，negativereason _ 黄金&amp; tweet_coord 有大量空白，即在 13000–14000 范围内。因此可以得出结论，这些列不会提供任何重要的信息&amp;因此可以被丢弃。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi md"><img src="../Images/d1b9c1638cb0e5cc954e60dfbe9b1475.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fv9iiCvLSLrL5RM8nvqWMg.png"/></div></div></figure><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi me"><img src="../Images/656535ba4d37ee9e6c45ef705a58b2de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCtT_6TZxYWMRQ9VYXRTqA.png"/></div></div></figure><p id="9e3e" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在我们有了相关的数据，让我们开始构建我们的模型。</p><p id="acee" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当我们用 Fastai 制作 NLP 模型时，有两个阶段:</p><ul class=""><li id="04aa" class="mf mg iq kz b la lb ld le lg mh lk mi lo mj ls mk ml mm mn bi translated">创建 LM 模型并使用预先训练的模型对其进行微调</li><li id="5755" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">使用微调模型作为分类器</li></ul><p id="bd25" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这里我使用的是数据块的一部分<strong class="kz ir"> <em class="lw"> TextList </em> </strong>，而不是使用工厂方法<strong class="kz ir"><em class="lw">TextClasDataBunch</em></strong>和<strong class="kz ir"><em class="lw">TextLMDataBunch</em></strong>，因为 TextList 是 API 的一部分，更加灵活和强大。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mt"><img src="../Images/a953d73edf7d385316255925d222bdb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rF6RL2tcYu24HB6z5sx7QQ.png"/></div></div></figure><p id="8e21" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们可以看到，由于我们正在训练一个语言模型，所有的文本都连接在一起(在每个新的时期，它们之间有一个随机的洗牌)。</p><p id="7ae7" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在，我们将使用在更大的语料库 Wikitext 103 上预先训练的模型的权重来微调我们的模型。这个模型已经被训练来预测作为输入提供给它的句子中的下一个单词。由于推文的语言并不总是语法上完美的，我们将不得不调整我们模型的参数。接下来，我们将找到最佳的学习速度，并将其可视化。可视化将帮助我们发现学习率的范围，并在训练我们的模型时从中进行选择。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mu"><img src="../Images/7d7c12639bceff345ff0c608b8c38d1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tj1uFn3mGYI_ZRWKTEvxSw.png"/></div></div></figure><p id="67e9" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">默认情况下，学习者对象是冻结的，因此我们需要首先训练嵌入。这里，我不是运行一个时期的循环，而是运行 6 个时期，看看精度如何变化。我挑选的学习率是借助于我们上面得到的图。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/85fc52840e4bddd7f2f3b4ecfa9342c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*M4jH2b0BVDi1_4lZEuTJvw.png"/></div></figure><p id="ba65" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们得到了非常低的精度，这是预料中的，我们模型的其余部分仍然是冻结的，但我们可以看到精度正在增加。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/7f1aa1a6d4b20dfd50c67182e5aa6897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*g6KMJccM9zpEs-bgSLm4tQ.png"/></div></figure><p id="c71f" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们看到精度略有提高，但仍在相同范围内。这是因为，首先，模型是在一个预先训练好的模型上用不同的词汇训练的&amp;其次，没有标签，我们在没有指定标签的情况下传递了数据。</p><p id="3c18" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在我们将用随机输入来测试我们的模型&amp;看看它是否能准确地完成句子。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mx"><img src="../Images/4a33a23dad7b443cba0876012757e834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5jrJltf_E6O2z_9ry4UbA.jpeg"/></div></div></figure><p id="b96e" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在，我们将创建一个新的数据对象，它只获取带标签的数据并保留这些标签。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi my"><img src="../Images/9c03af12c5f6f5c544dd24107573a10b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XDl2MTS3UrUxwHmkXw4Y9Q.png"/></div></div></figure><p id="b7e4" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">分类器需要稍微少一点的漏失，所以我们传递 drop_mult=0.5，将所有漏失乘以这个量。我们不加载预先训练好的模型，而是加载前一节中经过微调的编码器。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="3a4f" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们再次执行与语言模式相似的步骤。这里我跳过了最后 15 个数据点，因为我只对 1e-1 感兴趣。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mz"><img src="../Images/d3d5cc13c37a4279c258f99c06528faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l7KdC260fUMKMkJNKDSrqQ.png"/></div></div></figure><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi na"><img src="../Images/5b0e89a68cc44ac6fff3055c782aaa0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*AiEDGPK0M-zb0gHviudsJQ.png"/></div></figure><p id="bd55" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在这里，我们看到，如果我们与步骤 1 中提供标签时的语言模型进行比较，准确性有了很大的提高。</p><p id="f4b0" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在我们将通过一次解冻一层来部分训练模型&amp;差分学习率。这里我使用了 slice 属性，它将在 3 组模型中划分指定的学习率。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/08190eb6bfaa746ac601324127669bdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*dRzKbWq0JYL-38NV9UK2Iw.png"/></div></figure><p id="4565" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们看到，随着我们逐渐解冻各层，精确度正在逐步提高。更多的层提供更多的深度。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nc"><img src="../Images/031ce75d78d440abb9ed2d03b294fa29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*EejRT2KE8jfpeI-ilPj4uA.png"/></div></div></figure><p id="6666" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">最后，我们将解冻整个模型并可视化学习率，以选择并用于最终训练。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nd"><img src="../Images/d1c972d373701ed99e89ec40f17bd419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_wAwGiETPfdkm3-vBoyXw.png"/></div></div></figure><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="3586" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们看到，在这个模型结束时，我们已经达到了 80%的最高准确率。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/63b25d6cfb7efd3a8b96d6405bc55cd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*-ksyMP1sPbjEsLD82dNdYQ.png"/></div></figure><p id="a697" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">对于我们的最终结果，我们将取模型预测的平均值。由于样本是按文本长度排序进行批处理的，因此我们传递参数 ordered=True 来按照文本的顺序获得预测。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/ffd450203cda73ec01507e9a049e675a.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/format:webp/1*xxsYblzaPtQbOOVMkdcttg.png"/></div></figure><p id="1010" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们得到了 80.09%的准确率</p><p id="034f" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在是时候用新的文本输入来测试我们的模型了&amp;看看它的表现如何！</p><p id="4744" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">databunch 已将文本标签转换为数字标签。它们如下:</p><ul class=""><li id="a14d" class="mf mg iq kz b la lb ld le lg mh lk mi lo mj ls mk ml mm mn bi translated">0 = &gt;负数</li><li id="a9e6" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">1 = &gt;空档</li><li id="df25" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">2 = &gt;正</li></ul><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi ng"><img src="../Images/a8bcb235f5d64de36461de1f53c7c0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gtiiwYVROoIuaxBcd7d_DQ.png"/></div></div></figure><p id="00c9" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们看到我们的模型表现得相当好！！</p><p id="d390" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您可以使用负面以及混合情感文本来测试模型，并验证结果。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="78a9" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">希望这篇文章对你有所帮助，:D</p><p id="37f7" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">此外，欢迎任何建议/更正。</p><p id="af53" class="pw-post-body-paragraph kx ky iq kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">编码快乐！！</p></div></div>    
</body>
</html>