<html>
<head>
<title>Understanding DICOMs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解DICOMs</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-dicoms-835cd2e57d0b?source=collection_archive---------12-----------------------#2020-05-22">https://towardsdatascience.com/understanding-dicoms-835cd2e57d0b?source=collection_archive---------12-----------------------#2020-05-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="aa3d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">2020年9月更新</strong> : <a class="ae ko" href="https://github.com/fastai/fastai" rel="noopener ugc nofollow" target="_blank"> fast.ai </a>版本2于2020年8月正式发布。下面使用的<code class="fe kp kq kr ks b">fastai</code>是指最新版本，目前为<code class="fe kp kq kr ks b">2.0.9</code></p><p id="96a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="kt">一个</em> <strong class="js iu"> <em class="kt">深入实践</em> </strong> <em class="kt">方法，如何使用</em><a class="ae ko" href="https://github.com/fastai/fastai2" rel="noopener ugc nofollow" target="_blank"><strong class="js iu"><em class="kt">fastai</em></strong></a><strong class="js iu"><em class="kt">的</em> </strong> <em class="kt">医学成像模块查看和操作DICOM图像，并为机器学习做好准备。</em></p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ku"><img src="../Images/6962aa49cfbd723b6260b111f08d3f9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*9lBjyVypuF33ZK3aTNfcQQ.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">使用像素选择和“ocean_r”色图生成的图像</p></figure><h2 id="4833" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">什么是DICOMs？</h2><p id="73f0" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">DICOM(<strong class="js iu">D</strong>I<strong class="js iu">I</strong>maging and<strong class="js iu">CO</strong>communications in<strong class="js iu">M</strong>edicine)是事实上的标准，它建立了允许医学图像(X射线、MRI、CT)和相关信息在来自不同供应商、计算机和医院的成像设备之间交换的规则。DICOM格式提供了一种合适的方法，该方法符合<a class="ae ko" href="https://www.himss.org/interoperability-and-health-information-exchange" rel="noopener ugc nofollow" target="_blank">医疗信息交换</a> (HIE)标准，用于在医疗机构之间传输医疗相关数据，并符合<a class="ae ko" href="https://www.hl7.org/implement/standards/" rel="noopener ugc nofollow" target="_blank"> HL7 </a>标准，该标准是使临床应用能够交换数据的消息标准。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi me"><img src="../Images/290d053d920c2f5f7cadf2536a66a88c.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*lBPvpGcLKNu0i5M6WE0Xgg.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">典型的放射学工作流程[ <a class="ae ko" href="https://www.extrahop.com/company/blog/2016/introduction-to-dicom-protocol/" rel="noopener ugc nofollow" target="_blank">图像认证</a></p></figure><p id="a661" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DICOM文件通常有一个<strong class="js iu"> <em class="kt">。dcm </em> </strong>扩展，提供了在单独的<strong class="js iu">【标签】</strong>中存储数据的方法，例如患者信息、<em class="kt">图像/像素数据</em>、使用的机器以及更多信息(如下所述)。</p><p id="e737" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DICOM文件主要由打包成一个文件的<em class="kt">标题</em>和<em class="kt">图像像素强度</em>数据组成。标题中的信息被组织成一系列标准化的标签。通过从这些标签中提取数据，用户可以访问有关患者人口统计、研究参数等重要信息。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/0cb7d1883f27bca0a98e9b454e8a5f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:416/format:webp/1*8IuUtXXi8Iy0XuAz-Ft2cg.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">DICOM的一部分[ <a class="ae ko" href="http://europepmc.org/articles/PMC3354356/figure/F2/" rel="noopener ugc nofollow" target="_blank">图像来源</a></p></figure><p id="e6e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="kt"> 16位</em> </strong> DICOM图像有从<strong class="js iu"> -32768 </strong>到<strong class="js iu"> 32768 </strong>的值，而<em class="kt"> </em> <strong class="js iu"> <em class="kt"> 8位</em> </strong>灰阶图像存储从<strong class="js iu"> 0 </strong>到<strong class="js iu"> 255 </strong>的值。DICOM图像中的数值范围非常有用，因为它们与<a class="ae ko" href="https://en.wikipedia.org/wiki/Hounsfield_scale" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> <em class="kt"> Hounsfield标度</em> </strong> </a>相关联，Hounsfield标度是一种用于描述放射密度的定量标度(或一种观察不同组织密度的方式——更多解释见下文)</p><h2 id="4c65" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">安装要求</h2><p id="e31e" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">为了能够完成本教程，您需要在计算机上安装这些依赖项</p><p id="15f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装说明可以在他们的Github页面查看:<a class="ae ko" href="https://github.com/fastai/fastai" rel="noopener ugc nofollow" target="_blank"> fastai </a></p><p id="0b84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还需要安装<code class="fe kp kq kr ks b">pydicom(</code> <strong class="js iu"> Pydicom </strong>是一个python包，用于解析dicom文件，可以很容易地将DICOM文件转换成python结构，以便于操作。</p><ul class=""><li id="3869" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><code class="fe kp kq kr ks b">pip install pydicom</code></li></ul><p id="fc77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而<code class="fe kp kq kr ks b">scikit-image(</code>是图像处理的算法集合)</p><ul class=""><li id="b032" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><code class="fe kp kq kr ks b">pip install scikit-image</code></li></ul><p id="fbab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">kornia(</code>是一个包含操作符的包库，这些操作符可以插入到神经网络中，以训练模型来执行图像变换、核几何、深度估计和低级图像处理，如直接在张量上操作的滤波和边缘检测</p><ul class=""><li id="77f2" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><code class="fe kp kq kr ks b">pip install kornia</code></li></ul><blockquote class="mp"><p id="fd24" class="mq mr it bd ms mt mu mv mw mx my kn dk translated"><em class="mz">有关如何使用fastai的医学成像模块的更多信息，请访问我的</em> <code class="fe kp kq kr ks b"><a class="ae ko" href="https://github.com/asvcode/MedicalImaging" rel="noopener ugc nofollow" target="_blank"><em class="mz">github</em></a></code> <a class="ae ko" href="https://github.com/asvcode/MedicalImaging" rel="noopener ugc nofollow" target="_blank"> <em class="mz">页面</em> </a> <em class="mz">或我的</em> <a class="ae ko" href="https://asvcode.github.io/MedicalImaging/" rel="noopener ugc nofollow" target="_blank"> <em class="mz">医学成像教程博客</em> </a> <em class="mz">(哪个更适合查看笔记本教程:)</em></p></blockquote><h2 id="daf3" class="lg lh it bd li lj na dn ll lm nb dp lo kb nc lq lr kf nd lt lu kj ne lw lx ly bi translated">数据集</h2><p id="b502" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">这里列出了3个DICOM数据集，您可以随意使用。这3个数据集各有不同的属性，显示了不同DICOM数据集中可以包含的信息的巨大差异。</p><ul class=""><li id="a1ba" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><code class="fe kp kq kr ks b">fastai</code>库中方便地提供了<code class="fe kp kq kr ks b">SIIM_SMALL</code>数据集((250个DICOM文件，~30MB ),但是其某些属性受到限制，例如，它没有<code class="fe kp kq kr ks b">RescaleIntercept</code>或<code class="fe kp kq kr ks b">RescaleSlope</code>,并且其像素范围被限制在0到255的范围内</li><li id="23ff" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated">Kaggle有一个很容易访问的(437MB) <a class="ae ko" href="https://www.kaggle.com/kmader/siim-medical-images" rel="noopener ugc nofollow" target="_blank"> CT医学图像数据集</a>来自癌症成像档案馆。数据集由100幅图像(512像素乘512像素)组成，像素范围从-2000到+2000</li><li id="b56c" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated">超声数据集中的<a class="ae ko" href="https://opencas.webarchiv.kit.edu/?q=node/29" rel="noopener ugc nofollow" target="_blank">甲状腺分割提供低质量(从253px到253px)的DICOM图像，其中每个DICOM图像有多个帧(平均1000帧)</a></li></ul><p id="2006" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们加载依赖项:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="0b22" class="lg lh it ks b gy no np l nq nr">#Load the dependancies<br/>from fastai.basics import *<br/>from fastai.callback.all import *<br/>from fastai.vision.all import *<br/>from fastai.medical.imaging import *</span><span id="2efd" class="lg lh it ks b gy ns np l nq nr">import pydicom<br/>import seaborn as sns<br/>matplotlib.rcParams['image.cmap'] = 'bone'<br/>from matplotlib.colors import ListedColormap, LinearSegmentedColormap</span></pre><blockquote class="mp"><p id="2442" class="mq mr it bd ms mt mu mv mw mx my kn dk translated">了解一些关于fast.ai的知识是有益的，超出了本教程的范围，fast.ai文档页面有一些优秀的<a class="ae ko" href="https://dev.fast.ai/" rel="noopener ugc nofollow" target="_blank">教程</a>让你快速入门。</p></blockquote><h2 id="ca76" class="lg lh it bd li lj na dn ll lm nb dp lo kb nc lq lr kf nd lt lu kj ne lw lx ly bi translated">….关于数据如何存储在DICOM文件中的更多信息</h2><p id="de5b" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">使用<code class="fe kp kq kr ks b">pydicom.dcmread</code>打开DICOM文件，例如使用<code class="fe kp kq kr ks b">SIMM_SMALL</code>数据集:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="e95a" class="lg lh it ks b gy no np l nq nr">#get dicom files<br/>items = get_dicom_files(pneumothorax_source, recurse=True, folders='train')</span><span id="6f06" class="lg lh it ks b gy ns np l nq nr">#now lets read a file:<br/>img = items[10]<br/>dimg = dcmread(img)</span></pre><p id="c17c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您现在可以查看DICOM文件中包含的所有信息。对每个元素的解释超出了本教程的范围，但是<a class="ae ko" href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.7.6.3.html#sect_C.7.6.3.1.4" rel="noopener ugc nofollow" target="_blank"> <em class="kt">这个</em> </a>站点有一些关于每个条目的优秀信息。信息由<strong class="js iu"> DICOM标签</strong>(例如:0008，0005)或<strong class="js iu"> DICOM关键字</strong>(例如:特定字符集)列出。</p><p id="3410" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">比如说:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="8635" class="lg lh it ks b gy no np l nq nr">dimg</span></pre><p id="154f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在生成:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi nt"><img src="../Images/b19d41a5b1a7e1b611fea6d827355829.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tbsEMp_xHjq8MMYTMj-Ibw.png"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">从“dimg”创建的“head”信息</p></figure><p id="2fa1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下是上述标签信息的一些要点:</p><ul class=""><li id="e54b" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><strong class="js iu">像素数据</strong> (7fe0 0010)(最后一项)——这是存储原始像素数据的地方。为每个图像平面编码的像素的顺序是从左到右、从上到下，即左上像素(标记为1，1)首先被编码</li><li id="03a0" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">光度解释</strong> (0028，0004)——又名颜色空间。在这种情况下，是单色2，其中像素数据被表示为单个单色图像平面，其中最小样本值被显示为黑色<a class="ae ko" href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.7.6.3.html" rel="noopener ugc nofollow" target="_blank">信息</a></li><li id="eed9" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">每像素样本数</strong> (0028，0002) —这应该是1，因为该图像是单色的。例如，如果色彩空间是RGB，这个值将是3</li><li id="04d7" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">存储的位数</strong> (0028 0101) —每个像素样本存储的位数</li><li id="530d" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">像素表示</strong> (0028 0103) —可以是无符号的(0)或有符号的(1)</li><li id="a5af" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">有损图像压缩</strong> (0028 2110) — 00图像没有经过有损压缩。01图像已经过有损压缩。</li><li id="4fd5" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">有损图像压缩方法</strong>(0028 2114)——说明使用的有损压缩类型(在本例中为JPEG有损压缩，由<code class="fe kp kq kr ks b">CS:ISO_10918_1</code>表示)</li></ul><p id="c47d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">未包含在<code class="fe kp kq kr ks b">SIMM_SMALL</code>数据集中的重要标签:</p><ul class=""><li id="3fe2" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><strong class="js iu">重新缩放截距</strong> (0028，1052) —其中值<em class="kt"> b </em>与存储值(SV)和输出单位之间的关系。<em class="kt">输出单位= m*SV + b </em>。</li><li id="d398" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated"><strong class="js iu">重标度斜率</strong> (0028，1053)——<em class="kt">m</em>在重标度截距(0028，1052)指定的方程中。</li></ul><p id="e673" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="kt"> RescaleIntercept </em>和<em class="kt"> RescaleSlope </em>用于将图像的像素值转换为对应用有意义的值。计算新值通常遵循线性公式:</p><ul class=""><li id="f853" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated"><strong class="js iu"><em class="kt">new value</em></strong><em class="kt">=(</em><strong class="js iu"><em class="kt">raw pixel value</em></strong><em class="kt">*</em><strong class="js iu"><em class="kt">rescale slope</em></strong><em class="kt">)+</em><strong class="js iu"><em class="kt">RescaleIntercept</em></strong></li></ul><p id="be21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并且当关系不是线性时，利用<em class="kt"> LUT </em>(查找表)。</p><blockquote class="mp"><p id="3ab5" class="mq mr it bd ms mt ny nz oa ob oc kn dk translated">当我们在下面查看另一个数据集时，所有这些将变得更加清晰</p></blockquote><p id="a884" class="pw-post-body-paragraph jq jr it js b jt od jv jw jx oe jz ka kb of kd ke kf og kh ki kj oh kl km kn im bi translated">上面的列表是有限的，使用另外两个数据集会告诉你每个文件可以有大量的标签。值得指出的是，在可能有<code class="fe kp kq kr ks b">ImageComments</code>的<code class="fe kp kq kr ks b">tag</code>的地方，可能有额外的信息(然而并不总是这样)。这个<code class="fe kp kq kr ks b">tag</code>可能包含对建模有用的信息。</p><h2 id="dec5" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">…那像素数据呢？</h2><p id="0698" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">默认情况下，pydicom将像素数据作为文件中的<strong class="js iu">原始字节</strong>读取，通常<code class="fe kp kq kr ks b">PixelData</code>通常不会立即有用，因为数据可能以各种不同的方式存储:</p><ul class=""><li id="a203" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated">像素值可以是有符号或无符号的整数，也可以是浮点数</li><li id="0652" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated">可能有多个图像帧</li><li id="f2eb" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated">每帧可能有多个平面(即RGB ),像素的顺序可能不同。这只是几个例子，更多信息可在<a class="ae ko" href="https://pydicom.github.io/pydicom/stable/old/working_with_pixel_data.html#dataset-pixel-array" rel="noopener ugc nofollow" target="_blank"> pycidom </a>网站上找到</li></ul><p id="99ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是<code class="fe kp kq kr ks b">PixelData</code>的样子:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="9b7f" class="lg lh it ks b gy no np l nq nr">dimg.PixelData[:200]</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi oi"><img src="../Images/563337b3df03aa846456badc92f6ba82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Jvx66hyUcCuRAWbsIjxig.png"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">像素数据</p></figure><p id="e583" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于解释<code class="fe kp kq kr ks b">PixelData</code>的复杂性，<em class="kt"> pydicom </em>提供了一种简单的方法来以方便的形式获得它:<code class="fe kp kq kr ks b">pixel_array</code>，它返回一个包含像素数据的<code class="fe kp kq kr ks b">numpy.ndarray</code>:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="b4eb" class="lg lh it ks b gy no np l nq nr">dimg.pixel_array, dimg.pixel_array.shape</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/51c246c8876bf934df5b068be3e31915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*RIS6_Gte-YyThRWxyzIMmg.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">像素阵列</p></figure><h2 id="7036" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">加载每个文件有1帧的DICOMs</h2><p id="8a2b" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><code class="fe kp kq kr ks b">SIIM_SMALL</code>数据集是一个DICOM数据集，其中每个DICOM文件都有一个包含1幅图像的<code class="fe kp kq kr ks b">pixel_array</code>。在这种情况下，<code class="fe kp kq kr ks b">fastai.medical.imaging</code>中的<code class="fe kp kq kr ks b">show</code>功能可以方便地显示图像</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="0724" class="lg lh it ks b gy no np l nq nr">source = untar_data(URLs.SIIM_SMALL)<br/>items = get_dicom_files(source)<br/>patient1 = dcmread(items[0])<br/>patient1.show()</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/73cdef4f2710966ad5bfad3f121a24ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*SKSMNrWqEodWE_5qqCGkog.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">patient1.show()将显示上面的图像</p></figure><p id="661b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从<code class="fe kp kq kr ks b">CT medical image dataset</code>加载一个图像怎么样，每个DICOM文件也包含一个帧。这张图片是CT扫描的切片，看着肺，心脏在中间。</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="347a" class="lg lh it ks b gy no np l nq nr">csource = Path('C:/PillView/NIH/data/dicoms')<br/>citems = get_dicom_files(csource)<br/>patient2 = dcmread(citems[0])<br/>patient2.show()</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/2ecd6580e5975584dac43ca161cc7946.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*nuL030Hes9Tu1n6lgQq01g.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">patient2.show()</p></figure><p id="57f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，如果一个DICOM数据集每个文件有多个帧呢？</p><h2 id="b6ee" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">加载每个文件有多个帧的DICOMs</h2><p id="639f" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">超声数据集中的<a class="ae ko" href="https://opencas.webarchiv.kit.edu/?q=node/29" rel="noopener ugc nofollow" target="_blank">甲状腺分割是一个数据集，其中每个DICOM文件都有多个帧。</a></p><p id="1c2b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开箱后，您无法使用<code class="fe kp kq kr ks b">fastai</code>查看来自多帧DICOM文件的图像，因为这将导致出现<code class="fe kp kq kr ks b">TypeError</code>，但是我们可以自定义<code class="fe kp kq kr ks b">show</code>功能，以便检查文件是否有多于1帧，如果有，您可以选择查看多少帧(默认为1)以及打印每个文件中有多少帧。</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="9124" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">2020年9月更新:</strong>我向库提交了一个PR，现在它是<code class="fe kp kq kr ks b">fastai.medical.imaging</code>模块中<code class="fe kp kq kr ks b">show</code>函数的一部分，所以可以开箱即用。</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="b478" class="lg lh it ks b gy no np l nq nr">#updating to handle multiple frames<br/><a class="ae ko" href="http://twitter.com/patch" rel="noopener ugc nofollow" target="_blank">@patch</a><br/><a class="ae ko" href="http://twitter.com/delegates" rel="noopener ugc nofollow" target="_blank">@delegates</a>(show_image, show_images)<br/>def show(self:DcmDataset, frames=1, scale=True, cmap=plt.cm.bone, min_px=-1100, max_px=None, **kwargs):<br/>    px = (self.windowed(*scale) if isinstance(scale,tuple)<br/>          else self.hist_scaled(min_px=min_px,max_px=max_px,brks=scale) if isinstance(scale,(ndarray,Tensor))<br/>          else self.hist_scaled(min_px=min_px,max_px=max_px) if scale<br/>          else self.scaled_px)<br/>    if px.ndim &gt; 2: <br/>        gh=[]<br/>        p = px.shape; print(f'{p[0]} frames per file')<br/>        for i in range(frames): u = px[i]; gh.append(u)<br/>        show_images(gh, cmap=cmap, **kwargs)    <br/>    else: <br/>        print('1 frame per file')<br/>        show_image(px, cmap=cmap, **kwargs)</span></pre><p id="6b34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">Fastai</code>有一个非常直观的方法，你可以用<strong class="js iu"> <em class="kt">修补</em> </strong>代码，因此有了上面的<code class="fe kp kq kr ks b">@patch</code>，你可以很容易地给代码添加不同的功能</p><p id="f460" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们可以加载甲状腺数据集了:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="69ed" class="lg lh it ks b gy no np l nq nr">tsource = Path('C:/PillView/NIH/data/thyroid')<br/>titems = get_dicom_files(tsource)<br/>patient3 = dcmread(titems[0])<br/>patient3.show(10)</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi oi"><img src="../Images/d8a8719aaf6a208d6b7b70b7c057ad55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yXRrAUFYpNSEg__k3ir6gw.png"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">patient3.show(十)。我们指定了10，因此它显示了这1个文件中总共932帧中的前10帧</p></figure><h2 id="f575" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">了解组织密度</h2><p id="7e17" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">使用<a class="ae ko" href="https://www.kaggle.com/kmader/siim-medical-images" rel="noopener ugc nofollow" target="_blank"> CT医学图像数据集</a>，我们现在可以尝试其他有用的<code class="fe kp kq kr ks b">fastai.medical.imaging</code>功能。如前所述<strong class="js iu"> <em class="kt"> 16位</em> </strong> DICOM图像的像素值范围从<strong class="js iu"> -32768 </strong>到<strong class="js iu"> 32768 </strong></p><p id="a935" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">patient2</code>以上是来自该数据集的DICOM文件。</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="d3ba" class="lg lh it ks b gy no np l nq nr">#lets convert the pixel_array into a tensor.  Fastai can #conveniently do this for us<br/>tensor_dicom = pixels(patient2) #convert into tensor</span><span id="23f2" class="lg lh it ks b gy ns np l nq nr">print(f'RescaleIntercept: {patient2.RescaleIntercept:1f}\nRescaleSlope: {patient2.RescaleSlope:1f}\nMax pixel: '<br/>      f'{tensor_dicom.max()}\nMin pixel: {tensor_dicom.min()}\nShape: {tensor_dicom.shape}')</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi ot"><img src="../Images/9b59fc6c68462af1a5c5ee5fe94ffec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*yrIUOR0CcZr2PHcYL80a-A.png"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">RescaleIntercept、RescaleSlope、最大和最小像素值</p></figure><p id="9996" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该图像中<code class="fe kp kq kr ks b">RescaleIntercept</code>为<code class="fe kp kq kr ks b">-1024</code>,<code class="fe kp kq kr ks b">RescaleSlope</code>为<code class="fe kp kq kr ks b">1</code>,<code class="fe kp kq kr ks b">max</code>和<code class="fe kp kq kr ks b">min</code>像素分别为<code class="fe kp kq kr ks b">1918</code>和<code class="fe kp kq kr ks b">0</code>，图像尺寸为<code class="fe kp kq kr ks b">512</code>乘以<code class="fe kp kq kr ks b">512</code></p><p id="a7e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">绘制像素强度直方图，你可以看到大部分像素的位置</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="7b6d" class="lg lh it ks b gy no np l nq nr">plt.hist(tensor_dicom.flatten(), color='c')</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/acfb708e9899b4ed35f8df739cfd1300.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*n1lIFASkXnTtDkC-5auWXA.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">像素值直方图</p></figure><p id="d9b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">直方图显示最小像素值为<code class="fe kp kq kr ks b">0</code>，最大像素值为<code class="fe kp kq kr ks b">1918</code>。直方图主要是双峰的，大多数像素位于<code class="fe kp kq kr ks b">0</code>和<code class="fe kp kq kr ks b">100</code>像素之间以及<code class="fe kp kq kr ks b">750</code>和<code class="fe kp kq kr ks b">1100</code>像素之间。</p><p id="c507" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该图像有一个<code class="fe kp kq kr ks b">-1024</code>的<code class="fe kp kq kr ks b">RescaleIntercept</code>和一个<code class="fe kp kq kr ks b">1</code>的<code class="fe kp kq kr ks b">RescaleSlope</code>。这两个值允许将像素值转换成<a class="ae ko" href="https://en.wikipedia.org/wiki/Hounsfield_scale" rel="noopener ugc nofollow" target="_blank"> Hounsfield单位(<em class="kt"> HU </em> ) </a>。在<em class="kt">和</em>中测量CT扫描上不同组织的密度</p><p id="d1b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大多数CT扫描的范围从<code class="fe kp kq kr ks b">-1000</code> <em class="kt"> HUs </em>到<code class="fe kp kq kr ks b">+1000</code> <em class="kt"> HUs </em>其中水是<code class="fe kp kq kr ks b">0</code> <em class="kt"> HUs </em>，空气是<code class="fe kp kq kr ks b">-1000</code> <em class="kt"> HUs </em>并且组织越致密<em class="kt"> HU </em>值越高。金属有一个高得多的<em class="kt"> HU </em>范围<code class="fe kp kq kr ks b">+2000</code>HU<em class="kt">HU</em>s所以对于医学成像来说一个范围<code class="fe kp kq kr ks b">-1000</code>到<code class="fe kp kq kr ks b">+1000</code>HU<em class="kt">s是合适的</em></p><p id="1f9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上述像素值与组织密度不正确对应。例如，大多数像素在对应于水的像素值<code class="fe kp kq kr ks b">0</code>和<code class="fe kp kq kr ks b">100</code>之间，但是该图像主要显示充满空气的肺。亨斯菲尔德标度上的空气是<code class="fe kp kq kr ks b">-1000</code> <em class="kt">胡</em> s</p><p id="89b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是<code class="fe kp kq kr ks b">RescaleIntercept</code>和<code class="fe kp kq kr ks b">RescaleSlope</code>的重要之处。Fastai2提供了一种方便的方式<code class="fe kp kq kr ks b">scaled_px</code>来相对于<code class="fe kp kq kr ks b">RescaleIntercept</code>和<code class="fe kp kq kr ks b">RescaleSlope</code>重新缩放像素。</p><p id="ae1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请记住:</p><p id="1fd8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="kt">重新调整像素=像素*重新调整斜率+重新调整交点</em> </strong></p><p id="1a53" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Fastai再次提供了一个方便的方法<code class="fe kp kq kr ks b">scaled_px</code>，将<code class="fe kp kq kr ks b">pixel_array</code>转换为<code class="fe kp kq kr ks b">tensor</code>，并通过考虑<code class="fe kp kq kr ks b">RescaleIntercept</code>和<code class="fe kp kq kr ks b">RescaleSlope</code>来缩放这些值。</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="81a7" class="lg lh it ks b gy no np l nq nr">#convert into tensor taking RescaleIntercept and RescaleSlope into #consideration<br/>tensor_dicom_scaled = scaled_px(patient2)<br/>plt.hist(tensor_dicom_scaled.flatten(), color='c')</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/552a689446b8eb9135ed130da24e9058.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*FehdfgrAmu3t9Kiyd0QAmQ.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">使用“scaled_px”的缩放像素直方图</p></figure><p id="aec9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们看看最大和最小像素值:</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="1ae2" class="lg lh it ks b gy no np l nq nr">print(f'Max pixel: {tensor_dicom_scaled.max()}\nMin pixel: {tensor_dicom_scaled.min()}')</span></pre><p id="4dbe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重新缩放后，最大像素值为<code class="fe kp kq kr ks b">894</code>，最小值为<code class="fe kp kq kr ks b">-1024</code>，我们现在可以根据<em class="kt"> Hounsfield比例</em>正确地看到图像的哪些部分对应于身体的哪些部分。</p><p id="0bd7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">查看直方图的顶端，值超过300 <em class="kt"> HUs </em>的图像看起来像什么？</p><p id="0beb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">show</code>功能具有指定<code class="fe kp kq kr ks b">max</code>和<code class="fe kp kq kr ks b">min</code>值的能力</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="3f5d" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=894, min_px=300, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/0bdf9948c979a7bd80be90649e604c67.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*mo7SO-91QijszJJq-tBS0Q.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">查看300像素和894像素之间的像素值</p></figure><p id="57d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回想一下，我们让<em class="kt">为</em>修补了<code class="fe kp kq kr ks b">show</code>函数，现在它显示这个数据集有<code class="fe kp kq kr ks b">1 frame per file</code>。<em class="kt"> HU </em>值高于<code class="fe kp kq kr ks b">+300</code>通常会显示图像内的骨骼结构</p><p id="972e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么在<code class="fe kp kq kr ks b">-250</code>和<code class="fe kp kq kr ks b">250</code>的范围内，我们有一个峰值像素呢？</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="be1e" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=250, min_px=-250, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/6c21fc456a12ecc86721ba45d09cd220.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*DdVxvqO_IBNzzJ5cd3Pkhg.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">像素范围在-250像素和+250像素之间</p></figure><p id="0764" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个范围内，你现在可以看到主动脉和心脏的部分(图片中间)以及肌肉和脂肪。</p><p id="e7cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在-250像素和-600像素之间，我们注意到像素分布很低，怎么办</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="d407" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=-250, min_px=-600, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/4fb0e07bf0817f52f6a94833282a61ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*HJOntRRQyP_jldQwdnaLAA.png"/></div></figure><p id="e2c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个范围内，你只能看到轮廓。直方图显示在这个范围内没有很多像素</p><p id="d986" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">-1000px到-600px之间呢？</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="7607" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=-600, min_px=-1000, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/de94941ed80cd7e337838683d1d5d038.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*mrvj8dHj3Ngi9a9eyHvi9g.png"/></div></figure><p id="485b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个范围内，你可以清楚地看到肺部的支气管</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="ee0a" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=-900, min_px=-1024, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/6a633b2190b27ab83562eef8b816ce66.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*Ub04lpVxSMfgPafkN41a7g.png"/></div></figure><p id="ff83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个范围内，你现在也可以清楚地看到扫描仪的曲线。</p><p id="aa2b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">默认情况下，<code class="fe kp kq kr ks b">show</code>函数的<code class="fe kp kq kr ks b">max_px</code>值为<code class="fe kp kq kr ks b">None</code>，而<code class="fe kp kq kr ks b">min_px</code>值为<code class="fe kp kq kr ks b">-1100</code></p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="91db" class="lg lh it ks b gy no np l nq nr">patient2.show(max_px=None, min_px=-1100, figsize=(5,5))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/b5080c966f5a910092d95fb7cedd02c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/1*INko0hdR1a6_ECi9XZZzmg.png"/></div></figure><p id="eb47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如上所述的图像缩放确实是为了人类的利益。计算机屏幕可以显示大约256种灰度，而人眼只能检测大约6%的灰度变化，这意味着人眼只能检测大约17种不同的灰度。</p><p id="0aa3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DICOM图像可能具有从<code class="fe kp kq kr ks b">-1000</code>到<code class="fe kp kq kr ks b">+1000</code>的宽范围，并且为了使人类能够看到图像中的相关结构，使用了<code class="fe kp kq kr ks b">windowing</code>过程。Fastai提供各种<code class="fe kp kq kr ks b">dicom_windows</code>，因此屏幕上只显示特定的<em class="kt"> HU </em>值。更多关于窗口化的内容可以在<a class="ae ko" href="https://asvcode.github.io/MedicalImaging/medical_imaging/dicom/fastai/2020/04/28/Medical-Imaging-Using-Fastai.html" rel="noopener ugc nofollow" target="_blank"> <em class="kt">这里找到</em> </a></p><h2 id="e5f1" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">….关于窗口的旁注</h2><p id="88f6" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">DICOM图像可以包含大量的像素值，而<code class="fe kp kq kr ks b">windowing</code>可以被视为一种处理这些值的方法，以改变图像的外观，从而突出显示特定的结构。一个窗口有两个值:</p><p id="2d99" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">l</code> =窗位或中心，也称为亮度</p><p id="d057" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">w</code> =窗口宽度或范围，又名对比度</p><p id="0451" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">举例:</strong>从<a class="ae ko" href="https://www.kaggle.com/dcstang/see-like-a-radiologist-with-systematic-windowing" rel="noopener ugc nofollow" target="_blank">到这里</a></p><p id="0123" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大脑物质窗口</p><p id="ba24" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">l = 40(窗口中心)w = 80(窗口宽度)</p><p id="7776" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">显示的体素范围从0到80</p><p id="ce12" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">计算体素值:</p><ul class=""><li id="8daf" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated">最低可见值=窗口中心-窗口宽度/ 2</li><li id="b222" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn ml mm mn mo bi translated">最高可见值=窗口中心+窗口宽度/ 2</li></ul><p id="8d22" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(最低可见值= 40-(80/2)，最高可见值= 40 + (80/2))</p><p id="04a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，所有大于80的值都是白色的，所有小于0的值都是黑色的。</p><h2 id="5ebe" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">….但是计算机真的关心窗口、缩放比例吗？</h2><p id="5dd2" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">如果<code class="fe kp kq kr ks b">windowing</code>是为了人类的利益，当数据有一个<em class="kt">均匀分布</em>时，计算机从训练中产生更好的结果，正如本文中提到的<a class="ae ko" href="https://www.kaggle.com/jhoward/don-t-see-like-a-radiologist-fastai/data" rel="noopener ugc nofollow" target="_blank">不像放射科医生</a>那样看</p><p id="08af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回头看看像素分布，我们可以看到图像并没有均匀分布</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/552a689446b8eb9135ed130da24e9058.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*FehdfgrAmu3t9Kiyd0QAmQ.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">重新缩放像素的直方图</p></figure><p id="63e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">fastai有一个函数<code class="fe kp kq kr ks b">freqhist_hist</code>，它根据您为<code class="fe kp kq kr ks b">n_bins</code>设置的值将像素值的范围分成多个组，这样每个组都有大约相同数量的像素。</p><p id="8704" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，如果您将<code class="fe kp kq kr ks b">n_bins</code>设置为1，像素值将被分成两个不同的像素箱。</p><pre class="kv kw kx ky gt nk ks nl nm aw nn bi"><span id="3e9f" class="lg lh it ks b gy no np l nq nr">ten_freq = tensor_dicom_scaled.freqhist_bins(n_bins=1)<br/>fh = patient2.hist_scaled(ten_freq)<br/>plt.hist(ten_freq.flatten(), color='c'); show_image(fh, figsize=(7,7))</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/d49d98a0b860bf6db3b7c36c36046e45.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*1Y2Ft0uWYo9xwIRwpHpprg.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">将像素分成两个不同的箱</p></figure><p id="7a8d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，您可以在<code class="fe kp kq kr ks b">-1000</code> <em class="kt">处看到图像的两个极边，在</em>处看到空气部分，在<code class="fe kp kq kr ks b">500</code> <em class="kt">处</em>处可以清楚地看到骨骼结构，但这种分布对于机器学习模型来说仍不完全可接受。</p><p id="87e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">n_bins</code>在<code class="fe kp kq kr ks b">100</code>(这是<code class="fe kp kq kr ks b">show</code>使用的默认数字)</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/5bbb16cbfeb01862a9ceac3534500572.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*319KavF8C6EHoWY2Y7FCdw.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">分布在100个箱内的像素</p></figure><p id="16ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么在<code class="fe kp kq kr ks b">n_bins</code>处<code class="fe kp kq kr ks b">100000</code>的像素显示出更均匀的分布呢</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/73dfb744343610ae7823b995a1b74ea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*wOkLDhBoENPkCI5j7pZYRw.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">分布在100000个箱上的像素</p></figure><p id="6edf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这对训练结果有什么影响。这将是下一篇教程的主题。</p><h2 id="9e76" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">参考资料:</h2><ol class=""><li id="4766" class="mg mh it js b jt lz jx ma kb pf kf pg kj ph kn pi mm mn mo bi translated"><a class="ae ko" href="https://www.himss.org/interoperability-and-health-information-exchange" rel="noopener ugc nofollow" target="_blank">https://www . himss . org/inter operability-and-health-information-exchange</a></li><li id="be74" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn pi mm mn mo bi translated"><a class="ae ko" href="https://www.hl7.org/implement/standards/" rel="noopener ugc nofollow" target="_blank">https://www.hl7.org/implement/standards/</a></li><li id="adbb" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn pi mm mn mo bi translated"><a class="ae ko" href="https://en.wikipedia.org/wiki/Hounsfield_scale" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Hounsfield_scale</a></li><li id="c5c1" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn pi mm mn mo bi translated"><a class="ae ko" href="https://github.com/fastai/fastai2" rel="noopener ugc nofollow" target="_blank">https://github.com/fastai/fastai2</a></li><li id="15f3" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn pi mm mn mo bi translated"><a class="ae ko" href="https://www.kaggle.com/jhoward/don-t-see-like-a-radiologist-fastai/data" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/jhoward/don-t-see-like-a-放射科医生-fastai/data </a></li><li id="7e71" class="mg mh it js b jt nf jx ng kb nh kf ni kj nj kn pi mm mn mo bi translated"><a class="ae ko" href="https://www.kaggle.com/dcstang/see-like-a-radiologist-with-systematic-windowing" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/DC stang/see-like-a-a-放射科医生-系统开窗</a></li></ol></div></div>    
</body>
</html>