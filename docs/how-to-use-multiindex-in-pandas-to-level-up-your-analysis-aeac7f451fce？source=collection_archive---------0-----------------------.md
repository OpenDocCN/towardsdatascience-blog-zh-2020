# 如何在 Pandas 中使用 MultiIndex 来提升您的分析

> 原文：<https://towardsdatascience.com/how-to-use-multiindex-in-pandas-to-level-up-your-analysis-aeac7f451fce?source=collection_archive---------0----------------------->

## 大蟒

## 复杂数据分析中数据帧的层次索引介绍

![](img/3c11b33e57591b94ae804662747cbcc8.png)

[小姐姐](https://www.instagram.com/softie__arts/)创造的形象

如果您的数据框架的索引中有不止一列，会怎么样？

Pandas 中的多级索引功能允许您这样做。一个常规的 Pandas 数据帧有一个单独的列，作为唯一的行标识符，或者换句话说，一个“索引”。这些索引值可以是从 0 到无穷大的数字。它们也可以更详细，比如将“菜名”作为麦当劳特许经营店所有食物的索引值。

但是，如果你拥有两家麦当劳连锁店，并且想比较两家连锁店中一道菜的销售额，该怎么办呢？

虽然 Pandas 中的`groupby()`函数可以工作，但这个案例也是一个多索引可以派上用场的例子。

**MultiIndex** ，也称为多级索引或层次索引，允许您将多个列作为行标识符，同时通过父/子关系将每个索引列与另一个索引列相关联。

在本文结束时，我们将通过创建和选择具有分层索引的数据帧来回答以下问题:

*   **《指环王》第一章有哪些人物说话？**(用`.loc`回答)
*   **在《指环王》中最先开口的三个精灵是谁？**(用`.loc`回答)
*   《双塔奇谋》中甘道夫和萨鲁曼谈了多少？(用`.loc`回答)
*   在所有电影中，埃西铎说了多少？(用`.xs`回答)
*   在每部电影以及三部电影中，哪些霍比特人说得最多？(用透视表和`.loc`回答)

你可以在这里找到这篇文章中用到的数据。我们将使用“指环王”电影中的数据，特别是数据集中的“WordsByCharacter.csv”文件。这个文件将有每个角色在每部电影的每个场景中所说的话的数量。

和往常一样，在尝试任何代码之前，不要忘记导入熊猫。

```
import pandas as pd# load data
df = pd.read_csv('WordsByCharacter.csv')
```

![](img/c1c7ea7e77d11b519eefe960d4b836d4.png)

来自 WordsByCharacter.csv 的原始数据帧

让我们深入了解如何使用多级索引进行数据分析。

# 多索引快速介绍

分层索引意味着您的数据帧将有两个或多个维度，可用于标识每一行。

要获得原始数据帧的索引标签，我们可以使用以下代码:

```
df.index.names
```

![](img/d3e8ebec30d34a8c642cb8a8e429a3e8.png)

原始数据帧索引名的冻结列表

这将输出一个“FrozenList”，这只是一个 Pandas 特有的构造，用于显示数据帧的索引标签。这里，我们看到值是“None”，因为这是数据帧索引的默认值。

**要用我们的原始数据框架创建一个多索引，我们需要做的就是将一列列表传递到** `**.set_index()**` **Pandas 函数中，如下所示:**

```
multi = df.set_index(['Film', 'Chapter', 'Race', 'Character'])
```

![](img/988f871b63b316facf760a40575a2a5b.png)

一列多索引数据框架(单词)

在这里，我们已经可以看到名为“multi”的新数据帧已经过组织，现在有四列组成索引。我们可以通过再次查看索引名称来检查这一点:

```
multi.index.names
```

![](img/eb211c1e5e26a5d56c51fcd01561a415.png)

多级索引数据帧的索引名称的冻结列表

我们现在看到前面的值“None”已经被我们指定为新索引的四个列的名称所取代。

常规的、未改变的数据帧中的每个索引值只是一个从 0 到 730 的数字(因为数据帧有 731 行)。为了向您展示我们新创建的 MultiIndex 中的每个索引值，我们可以使用这行代码:

```
multi.index.values
```

![](img/c79ea95fdfca7d6a1141e84a7a25aa0d.png)

多索引数据帧的索引值数组

现在，我们看到“单词”列中的每一行值都可以通过它来自哪部电影、它指的是哪一章、说这个单词的角色是什么种族以及该角色的名字来标识。

在我们深入分析之前，有一点需要注意，那就是`.sort_index()` Pandas 函数。创建具有多索引的数据帧时，请确保将其附加到代码行的末尾，如下所示:

```
multi = df.set_index([‘Film’, ‘Chapter’, ‘Race’, ‘Character’]).sort_index()
```

熊猫文档上有这样的注释:

> 即使数据没有排序，索引也可以工作，但是效率会很低(并显示一个性能警告)。它还将返回数据的副本，而不是视图。

同样值得注意的是，你可以简单地通过将`.reset_index()`传递给你的数据帧来删除层次索引，就像这样:

```
multi.reset_index()
```

这将只返回原始数据帧，而不返回多个索引列上的父/子关系。

现在我们准备执行一些分析！

# 用熊猫多重索引功能回答指环王的琐事问题

## 《魔戒相交》第一章有哪些人物说话？

这里，我们将使用可靠的`.loc` Pandas 函数。如果你以前没有用过它，请随意查看这个关于矢量化熊猫函数的快速指南。

这里，我们感兴趣的是索引的两个组成部分，即“电影”和“章节”。在我们的`.loc`选择器中，我们编写了以下内容:

```
multi.loc[('The Fellowship Of The Ring', '01: Prologue'), :]
```

![](img/f359bca2244fb69b42f04009f160b535.png)

简单的输出。多索引数据帧上的锁定选择器

您可以通过将数据帧的 MultiIndex 的每个部分传递到一个 tuple 中来选择所需的值。在我们刚刚编写的选择器的第一部分中，我们传递了元组(“环的友谊”，“01: Prologue”)。我们不需要传递“种族”或“性格”的值，因为我们还不知道谁在第一章中说话。

请注意,“电影”和“章节”索引列不再出现在视图中。这是因为我们已经为“电影”和“01: Prologue”输入了“The Fellowship Of The Ring”作为元组中的值，所以输出不需要在视图中重复这些值。

另外，`:`作为最后一个参数被插入到`.loc`选择器中，表示我们希望显示所有的列。在我们的例子中，DataFrame 只有一个名为“Words”的列，因为 DataFrame 中的每隔一列都被转换为索引列。但是，如果您的数据框架中有多个列，并且只想查看一个子集，那么您应该使用列名而不是`:`。

现在，我们知道埃尔隆德、凯兰崔尔、咕鲁和比尔博在第一部电影的第一个场景中说话了。让我们来看一个稍微复杂一点的例子。

## 《指环王》中最先开口的三个精灵是谁？

这里，我们仍将使用`.loc`，但是现在我们将使用一些语法，在从多索引值中进行选择时，这些语法将为我们提供一些灵活性。

为了回答这个问题，我们对“电影”和“种族”索引列感兴趣。这一次，我们“跳过”一个索引栏，因为“章节”位于“电影”和“种族”之间。我们还不知道精灵们首先在哪个“章节”说话，所以我们需要把那个留白。

为此，我们将使用这行代码:

```
multi.loc[(‘The Fellowship Of The Ring’,slice(None),’Elf’), :].head(3)
```

![](img/3e4b1a546750d56d0dbd42c3fbd8cb67.png)

的输出。在多索引数据帧上使用切片(无)锁定选择器

同样，我们传递一个带有我们想要的索引值的元组，但是我们传递的不是“Chapter”的值，而是`slice(None)`。这是 Pandas 中默认的 slice 命令，用于选择多索引级别的所有内容。所以在这里，我们选择所有可能的“章节”值。

现在，我们知道埃尔隆德、凯兰崔尔和阿尔温是第一部书中最先说话的三个精灵。但到目前为止，我们所做的只是将每个索引列的一个值传递给`.loc`选择器。如果我们想获得多个值呢？

## 在《双塔奇谋》的每一章中，甘道夫和萨鲁曼谈了多少？

在这个问题中，我们对第二部“电影”的所有“章节”都感兴趣，这两部电影我们都已经知道如何选择。但是这一次，我们感兴趣的是“字符”索引的两个值。

为了得到答案，我们写下这行代码:

```
multi.loc[('The Two Towers',slice(None),slice(None),['Gandalf','Saruman']), :]
```

![](img/194f798292113d2efe8e749f4114a133.png)

多个条件的输出。多索引数据帧上的锁定选择器

我们在这里需要做的就是将我们想要的索引值列表传递给我们插入到`.loc`中的元组。由于我们不知道要获得哪个“章节”或“比赛”，所以在获得“字符”之前，我们为这两个索引值传递`slice(None)`。

到目前为止，我们在选择中已经有了多个条件，这就是为什么使用`.loc`很方便。但是如果我们只想指定一个级别的索引呢？写三遍`slice(None)`会很累，所以我们会转向另一种方法。

## 在所有电影中，埃西铎说了多少话？

要回答这个问题，我们只需要为“字符”指定一个索引级别值。我们将在 Pandas 中使用`xs()`(横截面)方法，它允许您指定想要搜索多索引的哪个部分。

我们使用以下代码:

```
multi.xs('Isildur', level='Character').sum()
```

![](img/be38dcd4aa13e0b51eda0d9870b36f0c.png)

basic 的输出。多索引数据框架上的 xs 选择器

最基本的是，`xs()`需要输入您想要查找的索引值和您想要搜索的级别。在这种情况下，我们需要“字符”级别，所以我们将它传递到`level=`，我们希望“字符”的值是“埃西铎”。然后，为了聚合所有的值，我们将`.sum()`添加到行尾。

我做了一点小手脚，以便验证数据的准确性，因为我知道这个问题的答案(埃西铎在整个三部曲中说的一个词是“不”)。但是您也可以使用这一行代码来查找任何角色说了多少话，只需将他们的名字作为参数代入`xs()`中。

## 哪几个霍比特人在每部电影和三部电影中都说得最多？

要回答这个问题，如果我们有一个表，其中汇总了每部电影中每个角色的“单词”值，那就太好了。这是创建数据透视表的好地方！

我们将使用 Pandas 的`.pivot_table()`函数，但是您将看到我们将一个列表传递到`index=`参数设置中，以再次创建一个 MultiIndex。我们创建数据透视表的代码如下所示:

```
pivoted = df.pivot_table(index = ['Race','Character'],
                         columns = 'Film',
                         aggfunc = 'sum',
                         margins = True, # total column
                         margins_name = 'All Films',
                         fill_value = 0).sort_index()order = [('Words', 'The Fellowship Of The Ring'),
         ('Words', 'The Two Towers'),
         ('Words', 'The Return Of The King'), 
         ('Words', 'All Films')]pivoted = pivoted.sort_values(by=('Words', 'All Films'), ascending=False)
pivoted = pivoted.reindex(order, axis=1)
```

![](img/0e7609de5134572db2db4e85c26d6e2a.png)

具有多索引的基本数据透视表

这里，我们的多级索引有两个组件，而不是上一个示例中的四个组件。这是因为我们希望“Film”值也是一个列，而不是一个索引。我们也不需要查看“章节”值，因此将其排除在外。因为我们对单词总数感兴趣，所以我们希望我们的`aggfunc`(聚合函数)参数是“sum”。

Pandas 还有一个内置的用于`.pivot_table()`函数的 total 列。您所需要做的就是通过`margins=True`来启用它，并可选地在`margins_name`参数中设置总计列的名称。

因为我们希望看到中每个“角色”的总字数，这个“角色”的“种族”值为“霍比特人”，所以我们可以通过一个非常简单的应用`.loc`来选择这个条件。

```
pivoted.loc['Hobbit']
```

![](img/dfdd9b7dbcce5c2d783dbaf6c616623b.png)

的输出。锁定多索引数据透视表

嘣！

现在我们有了一个表格，根据这个表格，霍比特人在所有电影中说得最多。我们还可以看到每部电影中每个角色说了多少话。一些有用的见解包括比尔博在《双塔奇谋》中根本没有说话，但仍然比皮聘和梅里有更多的总对话，他们在所有三部电影中都说话。

拥有这个表的好处在于，我们可以对" Elf "、" Men "、" Ainur "以及《指环王》中的其他种族进行同样的分析，只需在上面的`.loc`函数中代入一个参数。

我希望这篇关于 Pandas 中层次索引的介绍对您有用！我发现在 DataFrame 索引中有多个级别意味着我可以快速地将我的数据分组到特定的级别，而不必编写多个`groupby()`函数。

和往常一样，查看官方文档，更深入地了解如何在分析中使用多指数特性。

我喜欢参与数据收集和分析，这就是为什么我使用那篇文章中讨论的一种快速简单的方法来收集样本数据。如果你想在网上获取一些你自己的测试数据来测试这段代码，你可以在[上查看这篇文章，从一个有熊猫](/2-easy-ways-to-get-tables-from-a-website-with-pandas-b92fc835e741?source=friends_link&sk=9981ddaf0785a79be893b5a1dd3e03dd)的网站获取表格。

祝你的多级索引冒险好运！