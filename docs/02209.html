<html>
<head>
<title>Magically Pull Arguments for PySpark UDFs and Pandas Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">神奇地拉出 PySpark UDFs 和 Pandas 函数的参数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/magically-pull-arguments-for-pyspark-udfs-and-pandas-functions-8f85f6b893f2?source=collection_archive---------29-----------------------#2020-03-02">https://towardsdatascience.com/magically-pull-arguments-for-pyspark-udfs-and-pandas-functions-8f85f6b893f2?source=collection_archive---------29-----------------------#2020-03-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="51a2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在不替换参数的情况下更改函数</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9ff1d663f76dbc9815eca263d567f065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NvmCR3y8bZ-fotMnDvqXvw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">让参数名流动起来<a class="ae kv" href="https://pixabay.com/photos/prairie-river-stream-curved-sunset-679014/" rel="noopener ugc nofollow" target="_blank">https://pix abay . com/photos/prairie-river-stream-curved-sunset-679014/</a></p></figure><p id="35aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PySpark 用户定义函数(UDF)允许您使用 python 函数，并将其应用于 PySpark 数据帧的行。当您使用的功能变化很大时，必须更新功能和使用位置可能会很烦人。这篇文章将解释给定函数如何自动提取参数。该方法也适用于将 Pandas 系列作为输入的函数(见本文末尾)。</p><p id="d90a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">设置</strong></p><p id="e5e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们从一些设置开始:导入我们将会用到的东西，并创建一个玩具数据集。假设我们的数据包含关于价格、销售量、从客户那里收集的运输成本以及其他成本的列表的信息。我们将制作一些简单的 UDF 来从这些数字中计算收入和利润。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/58da4ace8cb1e60942675f3ca23a12a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*_z1Q1lW-WoLpnnROL0tqSA.png"/></div></figure><p id="d4ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">UDF 税务局</strong></p><p id="a287" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们想要创建一个简单的 UDF，它使用<code class="fe lv lw lx ly b">price </code>和<code class="fe lv lw lx ly b">revenue</code>列来创建一个新的<code class="fe lv lw lx ly b">revenue_wo_ship</code>列。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/92bab54abbee17eed7acd0b6ac21183b.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*Ik4jax6FZamcktKalkWdfg.png"/></div></figure><p id="2d33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">变更 UDF 收入</strong></p><p id="6948" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在许多情况下，当前的需求可能会发生变化。例如，假设我们更改了收入的定义，不仅包括商品的价格，还包括我们从客户那里收取的运费。这需要两个变化</p><ol class=""><li id="56ef" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated">调整函数以将运输成本添加到收入计算中</li><li id="e723" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">调整<code class="fe lv lw lx ly b">withColumn</code>调用以更改参数</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/e34660f8cb41e4657e289c222b15abc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*48OBLgWkAtFfLjm5LZ55VA.png"/></div></figure><p id="592e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用</strong>移除第二步 T4</p><p id="000a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，额外的信息已经存在于我们的数据框架中，不得不进行这两种代码更改是很烦人的。我们应该能够改变函数，让参数通过名称自动提取。</p><p id="dfbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我采取了以下策略:</p><ol class=""><li id="7687" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated">从函数开始。当它的定义改变时，我们应该能够自动改变要拉取的参数。</li><li id="7329" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">对函数参数进行循环。</li></ol><p id="e7f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">A.如果参数是传入字典中的键，则使用该键的值。否则，</p><p id="a518" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">B.如果 spark 数据框中的任何列的名称与参数名称相匹配，则使用它们作为参数。否则，</p><p id="9ab2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">C.如果参数有函数指定的默认值，则使用它。否则，</p><p id="e045" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">D.抛出一个异常，因为我们不知道该为参数使用什么值。</p><p id="d922" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该策略通过循环函数的参数名来实现。这就是<code class="fe lv lw lx ly b">inspect</code>的用武之地:它允许我们获取函数的参数名和默认值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/2f4b980ff03a5753bdc197ba4ac0b45e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cB6lw9bTLBxEEdDd5BgQSQ.png"/></div></div></figure><p id="9b53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">放在一起:功能</strong></p><p id="0107" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以将所有这些放入一个函数中，来为我们处理这个策略。注释可以在整个代码中为您提供指导。</p><p id="bb9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们从一个助手函数开始，它将常量值作为参数输入到 UDF 中，以处理上述策略中的 2A 和 2C。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="daa6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，真正的魔术:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="1958" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">看到它在行动</strong></p><p id="5007" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以对这个函数进行简单的调用，而无需改变我们向 UDF 输入内容的方式:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/82f19d37548fb96097ee0e9aff928dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*HBTGiDVk3V3l9J6AfIq7tQ.png"/></div></figure><p id="6cde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它也适用于列表输入。例如，如果我们想将利润定义为价格和数量的乘积与成本列之和之间的差值:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/818347b172fa093da81c80299f5f329a.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*4QBE8YRbnt2hS2RselxUuA.png"/></div></figure><p id="7fe7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是了。魔法</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/754ad9e5d0eca5cb657ae300f12c493c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3_IiNWeoSgk9nsWa"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@almosbech?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿尔莫斯·贝托尔德</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="8dbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">扩展:熊猫</strong></p><p id="1b33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，这种方法同样适用于熊猫:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/414f7a8e11f8ef87abee611bf58a8895.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*wAAXixR2UG7ig6X4sjrcqg.png"/></div></figure></div></div>    
</body>
</html>