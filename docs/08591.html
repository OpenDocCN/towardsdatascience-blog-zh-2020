<html>
<head>
<title>Building an ApiGateway-SQS-Lambda integration using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform构建ApiGateway-SQS-Lambda集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-an-apigateway-sqs-lambda-integration-using-terraform-5617cc0408ad?source=collection_archive---------11-----------------------#2020-06-22">https://towardsdatascience.com/building-an-apigateway-sqs-lambda-integration-using-terraform-5617cc0408ad?source=collection_archive---------11-----------------------#2020-06-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/cc4fc769da4951a52f4af90d7ebd5b87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mfOrPQZtAKnKJzyh"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kf" href="https://unsplash.com/@max_duz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Max Duzij </a>拍摄的照片</p></figure><p id="f13a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Terraform是一个非常棒的基础设施建设工具。该工具用于安全有效地构建、更改和版本控制基础设施。Terraform是HashiCorp提供的基础设施代码。</p><p id="a83e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在使用Terraform构建我正在使用Amazon Web Services (AWS)设计的项目时，我遇到了设置API网关端点的需求，该端点获取记录，并将它们放入触发Lambda函数的事件源的SQS队列中。</p><p id="0b26" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本帖中，我将与您分享构建这一基础设施所需的每个步骤。这篇文章假设你熟悉Terraform代码和AWS服务。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi le"><img src="../Images/b9aef62726bf24eaf21fdeb64bfe4294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*29ydfYBogBZmwiLMoLjIfQ.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">使用LucidChart工作空间制作的图表:<a class="ae kf" href="https://www.lucidchart.com/pages/?noHomepageRedirect=true" rel="noopener ugc nofollow" target="_blank">https://www.lucidchart.com/pages/?noHomepageRedirect=true</a></p></figure></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="125a" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">变量</h1><p id="9804" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">首先，让我们看看项目中使用的输入变量。变量存储在文件<em class="mt"> varibles.tf. </em>中</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="0889" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些变量的使用使得在不同的环境中部署服务变得非常容易。将<em class="mt">环境</em>变量更改为<em class="mt"> prd(又名</em>生产<em class="mt">)，</em>将创建所有具有相应环境名称的服务。</p><h1 id="62ad" class="lq lr it bd ls lt mw lv lw lx mx lz ma mb my md me mf mz mh mi mj na ml mm mn bi translated">简单队列服务(SQS)</h1><p id="3325" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">首先创建SQS资源。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="9774" class="lq lr it bd ls lt mw lv lw lx mx lz ma mb my md me mf mz mh mi mj na ml mm mn bi translated">ApiGateway</h1><p id="afe0" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在创建ApiGateway资源之前，让我们首先定义权限，以便API Gateway拥有向SQS队列发送消息的必要权限。我通常会创建一个名为<em class="mt"> policies </em>的文件夹，其中包含我将在项目中使用的所有策略，我建议你也这样做，这将保持你的代码整洁有序。</p><pre class="lf lg lh li gt nb nc nd ne aw nf bi"><span id="d43c" class="ng lr it nc b gy nh ni l nj nk">├── iam.tf<br/>├── policies: // all policies created<br/>│   ├── api-gateway-permission.json<br/>│   └── lambda-permission.json</span></pre><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="11d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些权限将赋予API Gateway创建和写入CloudWatch日志的能力，以及从SQS队列中放置、读取和列出数据的能力。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="077d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建了ApiGateway-SQS交互所需的所有权限后，我们就可以开始创建端点了。</p><p id="de34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的端点将有一个连接到根的路径:<code class="fe nl nm nn nc b">/form_score</code>，带有一个API Gateway POST方法。我们还需要一个名为<em class="mt"><code class="fe nl nm nn nc b">query_string_parameter</code><em class="mt">，</em>的unity，</em>通过HTTP请求<em class="mt">传递。</em>为了验证请求参数中是否存在<code class="fe nl nm nn nc b">query_string_parameter</code>，创建了一个验证器。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="1903" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以定义将记录转发到SQS队列的API网关集成。为了将方法、主体、查询参数和路径参数从端点转发到SQS消息，添加了一个<code class="fe nl nm nn nc b">request_template</code>。</p><p id="753e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于与SQS的集成，请求的HTTP头必须与<code class="fe nl nm nn nc b">Content-Type: application/x-www-form-urlencoded</code>在一起。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="5d60" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还应该为成功的响应绘制SQS响应。在这个项目中，SQS响应按原样返回给apiGateway，但是您也可以对其进行更改，以便返回一个自定义消息，例如:<code class="fe nl nm nn nc b">'Message Added to SQS successfully'</code>。这里，我们为成功的请求定义了一个200处理程序。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="94a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们可以添加API Gateway REST部署来部署我们的端点。添加了重新部署触发器。此配置计算API的Terraform资源的散列，以确定应触发新部署的更改。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="5d4d" class="lq lr it bd ls lt mw lv lw lx mx lz ma mb my md me mf mz mh mi mj na ml mm mn bi translated">希腊字母的第11个</h1><p id="47eb" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">当用terraform构建lambda时，我喜欢将lambda代码从基础代码中分离出来，这样可以使代码更干净、更有条理。</p><pre class="lf lg lh li gt nb nc nd ne aw nf bi"><span id="09f0" class="ng lr it nc b gy nh ni l nj nk">├── lambda: folder for lambda code<br/>│   ├── handler.py<br/>│   └── sqs-integration-dev-lambda.zip<br/>├── lambda.tf</span></pre><p id="635c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在构建我们的lambda之前，我们必须创建必要的权限，以便它可以读取来自SQS的消息并写入CloudWatch日志。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="f4a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以建立我们的lambda。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="1d03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们需要添加一个权限，以便SQS可以调用lambda。我们还需要添加一个事件源，以便当新消息到达队列时，SQS可以触发lambda。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="4760" class="lq lr it bd ls lt mw lv lw lx mx lz ma mb my md me mf mz mh mi mj na ml mm mn bi translated">结论</h1><p id="da17" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">设置好一切后，我们准备将所有更改应用到我们的AWS帐户。部署后，我们将拥有一个公共端点，它将使用Lambda函数向SQS写入数据，并从中消费。</p><p id="c8cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个强大的管道，可以用在不同的场景中。你可以在<a class="ae kf" href="https://github.com/DanielDaCosta/apiGateway-sqs-lambda" rel="noopener ugc nofollow" target="_blank">这里的</a>查看完整的代码和额外的分析！</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="6fad" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">参考</h1><div class="no np gp gr nq nr"><a href="https://gist.github.com/afloesch" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd iu gy z fp nw fr fs nx fu fw is bi translated">阿弗洛施的要点</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">我很难找到一个像样的例子，说明如何使用lua nginx模块来获取环境变量并传递…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">gist.github.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of jz nr"/></div></div></a></div><div class="no np gp gr nq nr"><a href="https://www.terraform.io" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd iu gy z fp nw fr fs nx fu fw is bi translated">哈希公司的Terraform</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">使用Terraform以代码形式交付基础架构协作和共享配置发展和版本化您的…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">www.terraform.io</p></div></div><div class="oa l"><div class="og l oc od oe oa of jz nr"/></div></div></a></div><div class="no np gp gr nq nr"><a href="https://medium.com/appetite-for-cloud-formation/setup-lambda-to-event-source-from-sqs-in-terraform-6187c5ac2df1" rel="noopener follow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd iu gy z fp nw fr fs nx fu fw is bi translated">在Terraform中将Lambda设置为来自SQS的事件源</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">本指南将向您展示如何设置AWS Lambda，以使用SQS作为Terraform的事件源。</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">medium.com</p></div></div><div class="oa l"><div class="oh l oc od oe oa of jz nr"/></div></div></a></div></div></div>    
</body>
</html>