<html>
<head>
<title>Azure Machine Learning Service — Train a model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习服务—训练模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/azure-machine-learning-service-train-a-model-df72c6b5dc?source=collection_archive---------42-----------------------#2020-05-31">https://towardsdatascience.com/azure-machine-learning-service-train-a-model-df72c6b5dc?source=collection_archive---------42-----------------------#2020-05-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="09f4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">第3部分:学习如何使用估计器训练模型的高级概念</h2></div><h1 id="047e" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">摘要</h1><p id="6609" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">到目前为止，在这一系列文章中，我已经能够简单介绍Azure机器学习服务(AML)的<a class="ae lw" href="https://www.kaggle.com/pankaj1234/azure-machine-learning-introduction" rel="noopener ugc nofollow" target="_blank"><strong class="lc iu"/></a><strong class="lc iu"/>，并且能够运行一个简单的实验<a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-run-python-script-experiment-1a9b2fc1b550"><strong class="lc iu"/></a>。在这篇文章中，我将介绍实验脚本的参数化，配置脚本环境、框架和依赖关系的不同方法。此外，如何在培训结束后向AML服务注册模型。</p><blockquote class="lx"><p id="1826" class="ly lz it bd ma mb mc md me mf mg lv dk translated">这篇特别的帖子摘自Kaggle笔记本托管— <a class="ae lw" href="https://www.kaggle.com/pankaj1234/azure-machine-learning-model-training" rel="noopener ugc nofollow" target="_blank">此处</a>。使用设置的链接来执行实验。</p></blockquote><figure class="mi mj mk ml mm mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mh"><img src="../Images/76546ec9221033cecc12240125b8852a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXGRpqIAqfB-bgo1b7JC2A.jpeg"/></div></div><p class="mu mv gj gh gi mw mx bd b be z dk translated"><a class="ae lw" href="https://www.pexels.com/@onewayupdesigns?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Luis J. </a>摄于<a class="ae lw" href="https://www.pexels.com/photo/star-wars-r2-d2-2085831/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a></p></figure></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="447f" class="ki kj it bd kk kl nf kn ko kp ng kr ks jz nh ka ku kc ni kd kw kf nj kg ky kz bi translated">即兴创作——简单的实验</h1><p id="f137" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在开始讨论AML中的数据存储和数据集管道之前，我将简要介绍一些高级配置选项，以运行前面描述的简单实验。</p><h2 id="adbf" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">脚本参数</h2><p id="6cb4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在<a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-run-python-script-experiment-1a9b2fc1b550">文章# 2，</a>中，我讨论了使用定制Python脚本实现一个简单的ML实验，但是那个脚本文件有一个问题，它是简单的和静态的，所以我们如何改进实验的脚本，以便它可以接受一系列值并有效地训练模型？是的，答案是参数化脚本——因此在AML服务环境中，任何实验脚本的参数值都可以按如下方式实现:</p><pre class="nw nx ny nz gt oa ob oc od aw oe bi"><span id="88bc" class="nk kj it ob b gy of og l oh oi"><em class="oj">### .... ###</em></span><span id="aaa7" class="nk kj it ob b gy ok og l oh oi">run = Run.get_context()</span><span id="fbac" class="nk kj it ob b gy ok og l oh oi"><strong class="ob iu">##Adding the parameter: regularization rate <br/>parser = argparse.ArgumentParser()<br/>parser.add_argument('--reg_rate', type=float, dest='reg', default=0.01)<br/>args=parser.parse_args()<br/>r = args.reg</strong></span><span id="9d2d" class="nk kj it ob b gy ok og l oh oi">run.log("model regularization", np.float(r))</span><span id="983f" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># load the data from a local file</em><br/>data = pd.read_csv('IRIS.csv')<br/>X = data[['sepal_length', 'sepal_width','petal_length','petal_width']].values<br/>X=StandardScaler().fit_transform(X)<br/>Y= (data['species']).map(lambda x: 0 if x=='Iris-setosa' else (1 if x=='Iris-versicolor' else 2))</span><span id="e9e6" class="nk kj it ob b gy ok og l oh oi"><em class="oj">#Split data into train and test set</em><br/>X_train, X_test, Y_train, Y_test = train_test_split(X,Y, test_size=0.25, random_state=1234)</span><span id="bf49" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># fit the model: </em><strong class="ob iu"><em class="oj">with extra parameter</em></strong><br/>model = LogisticRegression(<strong class="ob iu"><em class="oj">C=1/r,</em></strong> solver='lbfgs', multi_class='multinomial').fit(X_train,Y_train)</span><span id="963b" class="nk kj it ob b gy ok og l oh oi">Y_pred = model.predict(X_test)<br/>accuracy = np.average(Y_test == Y_pred)<br/>print("accuracy: " + str(accuracy))<br/>run.log("Accuracy", np.float(accuracy))</span><span id="40cc" class="nk kj it ob b gy ok og l oh oi"><em class="oj">###....###</em></span></pre><h2 id="61f1" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">评估者API</h2><p id="fcac" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">虽然<strong class="lc iu">运行配置</strong>和<strong class="lc iu">脚本运行配置</strong>允许开发人员运行基于脚本的实验来训练机器学习模型，但AML服务也提供了更好的抽象，将它们的功能封装到单个对象中，称为<strong class="lc iu">估计器</strong>。典型的用例是当运行配置变得太复杂而无法为某些依赖项和框架进行配置时。它可用于最常用的机器学习框架，即Scikit-Learn、PyTorch和Tensorflow。</p><p id="e9c1" class="pw-post-body-paragraph la lb it lc b ld ol ju lf lg om jx li lj on ll lm ln oo lp lq lr op lt lu lv im bi translated">下面的代码实现了通用估计器类的对象来运行训练实验。<code class="fe oq or os ob b">Estimator()</code>构造器通过使用<code class="fe oq or os ob b">compute_target</code>参数来参数化实验执行的计算资源的引用，例如容器、VM或本地计算。通用估计器不包括scikit-learn包，因此，我们需要传递参数<code class="fe oq or os ob b">conda_packages</code>的值。另外，我们可以通过使用构造函数方法<code class="fe oq or os ob b">Estimator()</code>的<code class="fe oq or os ob b">script_params</code>参数来传递脚本的参数集合。</p><pre class="nw nx ny nz gt oa ob oc od aw oe bi"><span id="fadb" class="nk kj it ob b gy of og l oh oi">from azureml.train.estimator import Estimator<br/>from azureml.core import Experiment<br/>from azureml.widgets import RunDetails</span><span id="b62a" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># Create an estimator</em><br/>estimator = Estimator(source_directory=experiment_folder,<br/>                      entry_script='iris_simple_experiment.py',<br/>                      compute_target='local',<br/>                      use_docker=False,<br/>                      <strong class="ob iu">script_params = {'--reg_rate': 0.07},</strong><br/>                      conda_packages=['scikit-learn']<br/>                      )</span><span id="5aa3" class="nk kj it ob b gy ok og l oh oi"><strong class="ob iu"><em class="oj"># COMMENTED - SKLearn as an estimator</em></strong><br/><em class="oj">#estimator = SKLearn(source_directory=experiment_folder, entry_script='iris_simple_experiment.py', compute_target='local', use_docker=False)</em></span><span id="6688" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># Create an experiment</em><br/>experiment_name = 'iris-estimator-experiment'<br/>experiment = Experiment(workspace = ws, name = experiment_name)</span><span id="5ca1" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># Run the experiment based on the estimator</em><br/>run = experiment.submit(config=estimator)</span><span id="bf4f" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># Get Run Details</em><br/>RunDetails(run).show()</span><span id="eb40" class="nk kj it ob b gy ok og l oh oi"><em class="oj"># Wait to complete the experiment. In the Azure Portal we will find the experiment state as preparing --&gt; finished.</em><br/>run.wait_for_completion(show_output=True)</span></pre><blockquote class="ot ou ov"><p id="8592" class="la lb oj lc b ld ol ju lf lg om jx li ow on ll lm ox oo lp lq oy op lt lu lv im bi translated">AML SDK包括特定于框架的estmators类，它允许开发人员轻松配置框架依赖关系，例如，用于SKLearn或Tensorflow或PyTorch。代码中还有一个SKLearn估计器的例子(注释)。</p></blockquote><h2 id="9d27" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">注册模型</h2><p id="c0de" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">完成ML模型的训练后，我们必须使用它进行推理，因此，通过AML服务，我们可以注册模型，并在需要时使用它进行推理。</p><p id="6d4d" class="pw-post-body-paragraph la lb it lc b ld ol ju lf lg om jx li lj on ll lm ln oo lp lq lr op lt lu lv im bi translated"><strong class="lc iu">下载模式:</strong>运行对象的<code class="fe oq or os ob b">download_file()</code>或<code class="fe oq or os ob b">download_files() </code>方法用于将输出文件下载到本地文件系统。</p><pre class="nw nx ny nz gt oa ob oc od aw oe bi"><span id="fefa" class="nk kj it ob b gy of og l oh oi"># List the files generated by the experiment</span><span id="d083" class="nk kj it ob b gy ok og l oh oi">for file in run.get_file_names():<br/>     print(file)</span><span id="6e14" class="nk kj it ob b gy ok og l oh oi"># Download a named file</span><span id="073e" class="nk kj it ob b gy ok og l oh oi">run.download_file(name='outputs/model.pkl', output_file_path='model.pkl')</span></pre><p id="ef49" class="pw-post-body-paragraph la lb it lc b ld ol ju lf lg om jx li lj on ll lm ln oo lp lq lr op lt lu lv im bi translated">为了<strong class="lc iu">注册</strong>模型和相关的元数据——名称、版本、标签，我们可以编写以下内容:</p><pre class="nw nx ny nz gt oa ob oc od aw oe bi"><span id="116b" class="nk kj it ob b gy of og l oh oi">from azureml.core import Model</span><span id="650e" class="nk kj it ob b gy ok og l oh oi">run.<strong class="ob iu">register_model</strong>(model_path='outputs/iris_simple_model.pkl', model_name='iris_estimator_model', tags={"Training Context":"Estimator", "Script Context":"Parameters"},<br/>                  properties={"Accuracy":run.get_metrics()["Accuracy"]})</span></pre><p id="a459" class="pw-post-body-paragraph la lb it lc b ld ol ju lf lg om jx li lj on ll lm ln oo lp lq lr op lt lu lv im bi translated">最后，要查看在反洗钱服务中注册的模型，可以使用以下信息</p><pre class="nw nx ny nz gt oa ob oc od aw oe bi"><span id="7b2e" class="nk kj it ob b gy of og l oh oi">for model <strong class="ob iu">in</strong> Model.list(ws):<br/>    print(model.name, ":", model.version)<br/>    print("<strong class="ob iu">\n</strong>Tag List")<br/>    for tag_name <strong class="ob iu">in</strong> model.tags:<br/>        tag = model.tags[tag_name]<br/>        print(tag_name, tag)<br/>    print("<strong class="ob iu">\n</strong>Properties List")<br/>    for prop_name <strong class="ob iu">in</strong> model.properties:<br/>        prop = model.properties[prop_name]<br/>        print(prop_name,prop)</span><span id="13dc" class="nk kj it ob b gy ok og l oh oi"><strong class="ob iu">Output<br/></strong>iris_estimator_model : 4</span><span id="1038" class="nk kj it ob b gy ok og l oh oi">Tag List<br/>Training Context Estimator<br/>Script Context Parameters</span><span id="2b24" class="nk kj it ob b gy ok og l oh oi">Properties List<br/>Accuracy 0.9736842105263158<br/>IRIS_model : 1</span><span id="1075" class="nk kj it ob b gy ok og l oh oi">Tag List<br/>Training context Pipeline</span></pre><h1 id="8a52" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="7a4d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">随着这篇文章的结束，到目前为止，我们能够涵盖反洗钱服务的最基本的方面。我们能够运行一个简单的实验并训练一个ML模型。此外，使用API(如运行配置、脚本运行配置和估算器)允许我们创建一个具有相关依赖关系的环境来动态运行实验，而不考虑计算环境。</p><h1 id="bb52" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">接下来呢？</h1><p id="b13c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这是一系列博客帖子，包含各种Azure机器学习功能的详细概述，其他帖子的URL如下:</p><ul class=""><li id="9f3b" class="oz pa it lc b ld ol lg om lj pb ln pc lr pd lv pe pf pg ph bi translated">帖子1: <a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-part-1-an-introduction-739620d1127b"> Azure机器学习服务:第一部分——简介</a></li><li id="fc6b" class="oz pa it lc b ld pi lg pj lj pk ln pl lr pm lv pe pf pg ph bi translated">帖子2: <a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-run-python-script-experiment-1a9b2fc1b550"> Azure机器学习服务——运行一个简单的实验</a></li><li id="e57d" class="oz pa it lc b ld pi lg pj lj pk ln pl lr pm lv pe pf pg ph bi translated">岗位3 <em class="oj">(这个)</em> : <a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-train-a-model-df72c6b5dc">蔚蓝机器学习服务——训练一个模型</a></li><li id="d36d" class="oz pa it lc b ld pi lg pj lj pk ln pl lr pm lv pe pf pg ph bi translated">帖子4: <a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-where-is-my-data-pjainani-86a77b93ab52"> Azure机器学习服务——我的数据在哪里？</a></li><li id="7d90" class="oz pa it lc b ld pi lg pj lj pk ln pl lr pm lv pe pf pg ph bi translated">帖子5: <a class="ae lw" rel="noopener" target="_blank" href="/azure-machine-learning-service-what-is-the-target-environment-cb45d43530f2"> Azure机器学习服务——目标环境是什么？</a></li></ul><blockquote class="ot ou ov"><p id="e6fe" class="la lb oj lc b ld ol ju lf lg om jx li ow on ll lm ox oo lp lq oy op lt lu lv im bi translated"><em class="it">与我连线</em><a class="ae lw" href="https://www.linkedin.com/in/p-jainani/" rel="noopener ugc nofollow" target="_blank"><strong class="lc iu"><em class="it">LinkedIn</em></strong></a><em class="it">进一步讨论</em></p></blockquote><h1 id="e960" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">参考</h1><p id="864a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">[1]笔记本&amp;代码— <a class="ae lw" href="https://www.kaggle.com/pankaj1234/azure-machine-learning-model-training" rel="noopener ugc nofollow" target="_blank"> Azure机器学习—模型训练</a>，Kaggle。[2]Azure Machine Learning—Estimator API，<a class="ae lw" href="https://aka.ms/AA70rqw" rel="noopener ugc nofollow" target="_blank"><em class="oj">URL</em></a><br/>【3】<a class="ae lw" href="https://docs.microsoft.com/en-in/azure/machine-learning/" rel="noopener ugc nofollow" target="_blank">Azure机器学习服务</a>官方文档，微软Azure。</p></div></div>    
</body>
</html>