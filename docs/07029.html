<html>
<head>
<title>Spelunking Bluetooth LE with Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Go探索蓝牙LE</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spelunking-bluetooth-le-with-go-c2cff65a7aca?source=collection_archive---------14-----------------------#2020-05-30">https://towardsdatascience.com/spelunking-bluetooth-le-with-go-c2cff65a7aca?source=collection_archive---------14-----------------------#2020-05-30</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="96f8" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用Go挖掘蓝牙LE广告</h2></div><p id="da09" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在过去的几周里，我一直在一个项目上研究蓝牙LE(低能耗),并一直愉快地摆弄着它。蓝牙有一个相当大而复杂的规范，仅仅是核心规范<a class="ae lf" href="https://www.bluetooth.com/specifications/bluetooth-core-specification/" rel="noopener ugc nofollow" target="_blank"/>(目前版本5.2)本身就有3256页长，这仅仅是核心规范。其他信息无处不在，存在于各种文档、补充文档、在线注册表和网站中。在里面找到你想要的东西简直是一场寻宝游戏！</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj lg"><img src="../Images/8d398078ecf228e08efbd5179efa0cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*umvcV47JXM8-u9Etd24Z1w.png"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">感觉是这样的(鸣谢<a class="ae lf" href="https://en.wikipedia.org/wiki/File:Caving1.jpg" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/File:Caving1.jpg</a></p></figure><p id="052e" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我特别关注了蓝牙LE，它是面向物联网设备的蓝牙的节能版本，而不是传统的蓝牙，也称为蓝牙BR/EDR(基本速率/扩展数据速率)。我正在使用BLE研究近程信标，但那有点像钻进了兔子洞，我开始挖掘其他类型的BLE设备。我对它非常感兴趣，我甚至写了一个简单的Go工具来帮助我进行洞穴探险！</p><h1 id="b238" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">对BLE的简单介绍</h1><p id="86eb" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">BLE的原始技术是由诺基亚开发的短程超低功率无线电技术，名为Wibree。2007年，诺基亚与蓝牙特别兴趣小组(SIG)达成协议，Wibree成为蓝牙规范的一部分。经过几年的争论，蓝牙LE(低能耗)于2010年作为蓝牙核心规范4.0的一部分被引入。</p><p id="0545" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">蓝牙核心规范谈到了两种无线技术——BR/EDR(或经典蓝牙)和BLE(在一些文献中也称为蓝牙智能——市场营销用语，不要问为什么)。一般蓝牙设备可以是<em class="mt">单模</em>(仅限经典蓝牙或BLE)或<em class="mt">双模</em>(经典蓝牙和BLE均可)。</p><p id="7e9f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">一般来说，BLE设备可以通过两种方式进行外部通信— <em class="mt">广播</em>和<em class="mt">连接</em>。这个想法很简单。在广播中，通信只是单向的。<em class="mt">广播器</em>将向任何能够接收传输数据的物体单向发送数据。另一方面，<em class="mt">观察器</em>重复扫描广播数据。</p><p id="9589" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">标准广播广告分组具有31个八位字节的有效载荷，并且可以具有可选的扫描响应有效载荷，其大小也是31个八位字节。广播是强大的，但也有它的缺点——它缺乏安全或隐私保护。(我在这篇文章中选择使用术语octet，以便更清楚地表明我指的是类似于<code class="fe mu mv mw mx b">0xFF</code>的东西，它是8位的单位。)</p><p id="8fb4" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">连接提供永久性的双向数据传输(至少在断开连接之前)。在连接模式中，<em class="mt">中央</em>发起连接，而<em class="mt">外设</em>接受连接。此后，相应地，中央设备成为主<em class="mt">设备</em>，而外围设备成为从<em class="mt">设备</em>。</p><p id="1ef3" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在混合使用模式中，设备开始时是一个观察者，负责扫描广播公司，一旦找到所需的设备，它将启动连接，并停止扫描。同样，一旦广播者接受连接，它将停止广播。</p><p id="1668" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我在这篇文章中所要描述的只是广播传播，也就是BLE广告。</p><p id="e423" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">现在清楚了，我们开始吧！</p><h1 id="9ced" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">和BLE一起去</h1><p id="8f6d" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">为了这个项目，我选择了Go。有很多其他的选择，包括流行的Python的<code class="fe mu mv mw mx b">bluepy</code>，但是Go对我来说更好。Go有几个选择，特别是PayPal的一个包，但不幸的是，它已经几年没有保持了。最后终于有了一个叫<code class="fe mu mv mw mx b">go-ble/ble</code>的包。为了这篇文章的目的，我将使用我自己的项目的分支<a class="ae lf" href="https://github.com/sausheong/ble" rel="noopener ugc nofollow" target="_blank">，它包含了一些对我的洞穴探险有用的小修改。</a></p><p id="3ba6" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我还在上面制作了一个工具，名为<a class="ae lf" href="https://github.com/sausheong/blueblue" rel="noopener ugc nofollow" target="_blank"> BlueBlue </a>，帮助我可视化BLE的广告。这是它看起来的样子。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj my"><img src="../Images/42f52d89b204495cc41206ee4c224c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bfjti42OSJsU7oHSdbWRWA.png"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">BlueBlue，BLE洞穴探险的必备工具</p></figure><p id="511e" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">实际的代码只有几行代码，但是为了可视化和可用性，我构建了一堆其他的东西。我们来快速看一下扫码。</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="mz na l"/></div></figure><p id="32c9" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这是<code class="fe mu mv mw mx b">scan</code>函数，它无限循环地扫描BLE广告，只要我没有通过设置<code class="fe mu mv mw mx b">stop</code>变量为真来停止它。这是一个派生的goroutine，可以无限期运行。使用的主要函数是<code class="fe mu mv mw mx b">ble.Scan</code>，它接受一个处理函数，每次检测到BLE广告时都会调用这个函数。</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="mz na l"/></div></figure><p id="eee6" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">每次检测到广告，我都会创建一个<code class="fe mu mv mw mx b">Device</code> struct来存储它，然后添加到一个Go map中，以地址为键，以struct为值。这有效地创建了在我的扫描仪(我可信赖的Pi4)附近发现的所有BLE设备的地图。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nb"><img src="../Images/7fe281a4527b30ff0860904a92448439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8XsVlz1RiTLnpqpRFZuDKQ.jpeg"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">我信任的Pi4</p></figure><p id="5458" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我使用的map不是并发安全的，所以我在写入它之前使用一个<code class="fe mu mv mw mx b">sync.RWMutex</code>来锁定它(并在我完成之后解锁它)。这是为了防止竞态条件，竞态条件只会使应用程序崩溃。</p><p id="300d" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">之后，我简单地将这张地图显示为网页，然后每秒刷新一次页面。</p><p id="32d9" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">其余的代码简单地包装它，在Go web应用程序中显示找到的设备列表。它没什么特别的，但是它很好用。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div class="gi gj nc"><img src="../Images/3eac67b57783c0284e59e4be24781ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*bZ2f0lPIf7oY14JIh6AcnA.gif"/></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">BlueBlue在行动</p></figure><p id="4159" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">请注意广告和扫描响应八位字节，这些是我们稍后将深入研究的数据。你可能还会注意到，我在下面使用的数据与截图中的数据并不完全一致，这是因为数值发生了变化，而且我也使用了不同的设备。</p><p id="9f0f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">如果你对完整的BlueBlue代码感兴趣，你可以在https://github.com/sausheong/blueblue找到它。</p><h1 id="6a52" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">接近信标</h1><p id="0aaa" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">邻近信标是BLE设备的常见应用。邻近信标是一种小型设备，它不断地向附近(因此是邻近的)接收器广播有限的一组数据。BLE非常适合这一点，因为它是低能耗、低成本的。邻近信标的一些常见用途包括邻近营销(位置敏感的目标营销)、资产跟踪、室内导航和最近的(与新冠肺炎作战)、联系追踪和社交距离。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nb"><img src="../Images/76342790068775e5e4c829f341f1a325.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3udV9xpTdKGzaTNSgChIbg.jpeg"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">一个简单的BLE灯塔(显示在一枚新加坡50美分硬币旁边)</p></figure><p id="ea01" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">它们是最简单的BLE设备之一，非常适合第一次洞穴探险。因为我的项目，我们买了一些接近信标来玩，我有一个样品。</p><p id="d568" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们戴上洞穴潜水头盔，直接跳入水中吧！</p><h2 id="4b17" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告</h2><p id="ff7a" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">BLE的广播数据将在<code class="fe mu mv mw mx b">ble</code>包中触发一个事件，我们可以用我们的处理程序捕获这个事件。<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>事件表示一个或多个设备已响应主动扫描或在被动扫描期间广播了广告。这是从BlueBlue获取的LE广告报告事件的原始数据。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="188d" class="nd lx iu mx b gz nt nu l nv nw">02 01 00 01 94 52 95 7c 58 eb 1e 02 01 06 1a ff 4c 00 02 15 fd a5 06 93 a4 e24 fb 1a fc fc 6e b0 00 0 00 6b 00 01 00 02 d8 c2</span></pre><p id="f795" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这是一串十六进制数字，现在看起来毫无意义，让我们来分解一下。将你的蓝牙核心规范(当然是象征性的)翻到第4卷，E部分(主机控制器接口功能规范)，7.7.65.2部分。对于我正在使用的5.2版规范，这应该在第2382页。这非常清楚地告诉我们这个事件的形式。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nx"><img src="../Images/3156ca116fb877c6ee03b23a4c6a4e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_bWEDjN8Wf3y_v-t1ymjg.png"/></div></div></figure><p id="4351" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">从规格可以看出:</p><ul class=""><li id="ccea" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code>—<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>事件的子事件代码</li><li id="902c" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code>——报告数量</li><li id="af5a" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —事件类型，可连接和可扫描的无向广告(<code class="fe mu mv mw mx b">ADV_IND</code>)</li><li id="82bb" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —地址类型，随机设备地址</li><li id="c512" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">94 52 95 7c 58 eb</code> —地址(<code class="fe mu mv mw mx b">eb:58:7c:95:52:94</code>)</li><li id="edf1" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">1e</code> —数据长度(十进制30)</li><li id="9f27" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">02 01 06 1a ff 4c 00 02 15 fd a5 06 93 a4 e2 4f b1 af cf c6 eb 00 00 00 6b 00 01 00 02 d8</code> —有效载荷、广告数据</li><li id="565c" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">c2</code> — RSSI(十进制194，<code class="fe mu mv mw mx b">194 - 256 = -62 dBM</code>)</li></ul><p id="5125" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">第一个八位字节<code class="fe mu mv mw mx b">0x02</code>是<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>的子事件代码，因此这是一个固定代码。报告的数量通常为1，但如果有多个报告，则其余字段会重复。在这种情况下，这个信标只有1个，所以很简单。</p><p id="01cb" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">事件类型有4种不同的可能值，通常指定设备是否可以连接，广告是否是定向的，以及广告是否是扫描响应。在这种情况下，这里的代码(<code class="fe mu mv mw mx b">0x01</code>)告诉我们，我扫描的信标可以连接到，广告是无向的(<code class="fe mu mv mw mx b">ADV_IND</code>)。</p><p id="16f9" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">接下来是地址类型，它可以是4个不同值中的一个，它们都是指设备的地址。不同的类型是指地址是否固定:</p><ul class=""><li id="14f7" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated">公共设备地址(<code class="fe mu mv mw mx b">0x00</code> )—向IEEE注册的全球固定地址，永不改变</li><li id="3ca8" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">随机设备地址(<code class="fe mu mv mw mx b">0x01</code> ) —每次设备启动时生成的随机数，或者在设备的整个生命周期内保持不变的随机数。</li><li id="22dd" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">私有可解析地址(<code class="fe mu mv mw mx b">0x02</code> ) —由身份解析密钥和随机数生成的地址，可以经常更改以避免设备被识别和跟踪</li><li id="05b0" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">私有不可解析地址(<code class="fe mu mv mw mx b">0x03</code> )—只是一个随机数(不常用)</li></ul><p id="bbab" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在这个信标的例子中，它只是一个由制造商分配的私有地址。这也是最常见的值。</p><p id="dd01" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">接下来的6个二进制八位数是地址本身，但是是反过来的(<code class="fe mu mv mw mx b">94 52 95 7c 58 eb</code>)。蓝牙规范规定数据以小字节顺序传输，所以你应该对此有很多期待。</p><p id="673c" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">其后是描述有效载荷数据长度的八位字节。有效载荷最多可以是31个八位字节(或<code class="fe mu mv mw mx b">0x1f</code>)。在这个信标的情况下，它是30个八位字节的<code class="fe mu mv mw mx b">0x1e</code>。</p><p id="d37f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">接下来的30个八位字节当然是有效载荷，也就是广告数据本身。我们稍后将讨论这个问题，但让我们看看最后一个八位字节，它是RSSI(接收信号强度指标)。</p><p id="07ec" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这是对近距离信标最有用的值，因为这是我们将用来转换为距离的值。值的范围在-127 dBM到20 dBM之间，但一般来说大多在-95到-30 dBM之间。在这种情况下，我们有十进制的194。我们只需要从中减去<code class="fe mu mv mw mx b">0xff</code>或256，得到-62 dBM。</p><h2 id="9676" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告有效载荷</h2><p id="735f" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">广告有效载荷是我们所追求的。通常，格式是这样的:</p><ul class=""><li id="ee40" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated">第一个八位字节—长度</li><li id="67cf" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">第二个八位字节—广告数据类型</li><li id="bc90" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">广告的其余部分(根据长度)是实际数据</li></ul><p id="0f89" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">广告数据类型指定广告中的数据类型。在通用接入模式(GAP)蓝牙网站的<a class="ae lf" href="https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile/" rel="noopener ugc nofollow" target="_blank">中可以找到可能的值列表。</a></p><p id="8d59" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在有效载荷中可以有几个广告。让我们看看这里的这个:</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="293f" class="nd lx iu mx b gz nt nu l nv nw">02 01 06 1a ff 4c 00 02 15 fd a5 06 93 a4 e2 4f b1 af cf c6 eb 00 00 00 6b 00 01 00 02 d8</span></pre><p id="8ea4" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我们来分解一下。第一套是:</p><ul class=""><li id="6f75" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —长度(2个八位字节)</li><li id="c69b" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —广告数据类型为标志</li><li id="80ec" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">06</code> —二进制为<code class="fe mu mv mw mx b">110</code>的旗帜</li></ul><p id="10e7" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这些标志可在蓝牙核心规范的<a class="ae lf" href="https://www.bluetooth.com/specifications/bluetooth-core-specification/" rel="noopener ugc nofollow" target="_blank">附录中找到(此处使用版本7)。</a></p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div class="gi gj om"><img src="../Images/099a73bd86d4577228ced97f6e9fc7cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*aZ1GHjIWwiwRH9Nb4l35HA.png"/></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">蓝牙核心规范第7版(第12页)附录中的标志</p></figure><p id="2889" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在我们的例子中，<code class="fe mu mv mw mx b">110</code>表示它处于LE通用可发现模式，不支持BR/EDR(即经典蓝牙)。</p><p id="548a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">第二套是:</p><ul class=""><li id="e7e2" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">1a</code> —长度(26个八位字节)</li><li id="1176" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">ff</code> —广告数据类型是制造商特定的数据</li><li id="7845" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">4c 00 02 15 fd a5 06 93 a4 e2 4f b1 af cf c6 eb 00 00 00 6b 00 01 00 02 d8</code> —制造商特定数据</li></ul><p id="a659" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">特定于制造商的数据广告数据类型正如它所说的那样，由制造商来定义该数据是什么。然而，前4个八位字节应该是由蓝牙SIG(特殊兴趣组)分配的<a class="ae lf" href="https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers/" rel="noopener ugc nofollow" target="_blank">公司标识符。在这种情况下<code class="fe mu mv mw mx b">0x004C</code>(是的，它是反过来的)是苹果的公司标识符。</a></p><p id="a0c2" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这就是有趣的地方。当然，苹果生产的许多产品都有蓝牙功能。但是在<a class="ae lf" href="https://developer.apple.com/ibeacon/" rel="noopener ugc nofollow" target="_blank"> iBeacon规范</a>中，我们知道如果接下来的2个八位字节是<code class="fe mu mv mw mx b">0x0215</code>，那么它遵循iBeacon规范。当然，你可以看到确实如此。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div class="gi gj on"><img src="../Images/5e9f233c1e4d1b3427aa7660cd637e77.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*39Jd45IP8Cz8OHrwopDHZw.png"/></div></figure><p id="d9b7" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们稍微转换一下思路，跳到iBeacon格式。iBeacon格式非常简单，只有4段数据:</p><ul class=""><li id="ebbe" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated">邻近UUID (16个八位字节)</li><li id="694c" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">主号码(2个八位字节)</li><li id="ac24" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">次要编号(2个八位字节)</li><li id="a05b" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">测量功率(1个八位字节)</li></ul><p id="1541" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在这种情况下，我们发现接下来的16个八位字节是近似UUID <code class="fe mu mv mw mx b">fd a5 06 93 a4 e2 4f b1 af cf c6 eb 00 00 00 6b</code>，接下来的2个八位字节是主要数字<code class="fe mu mv mw mx b">00 01</code>，接下来的2个八位字节是次要数字<code class="fe mu mv mw mx b">00 02</code>，最后一个八位字节是测量功率<code class="fe mu mv mw mx b">d8</code>或十进制的216。</p><p id="1d0a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">如果你认为邻近UUID是用来唯一识别(毕竟UUID的意思是全球唯一标识符)的信标，那么你会惊讶地发现，它实际上是相反的。为特定部署(或客户)部署的所有iBeacons应该是相同的！这是由iOS本身强制执行的，除非您知道UUID，否则不允许您扫描信标。具有讽刺意味的是，虽然iOS不允许你访问iBeacon UUID，但你可以使用其他任何东西访问它，只要你能获得制造商的具体数据！</p><p id="7e0d" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">那么我们怎样才能唯一地识别信标呢？建议的方法(因为苹果不能强迫开发者)是<a class="ae lf" href="https://developer.apple.com/ibeacon/Getting-Started-with-iBeacon.pdf" rel="noopener ugc nofollow" target="_blank">使用主要和次要号码</a>。诚然，这不是一个坏主意，因为仅用次要编号中的2个二进制八位数，您就可以部署2个⁶ = 65，536个设备！如果将这两者结合在一起，就是2 = 4，294，967，296或大约42亿台设备。</p><p id="34db" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">但是等等。还有更多。</p><h2 id="4417" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">扫描响应</h2><p id="8405" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">BLE设备也可以通过回复扫描响应来响应扫描请求。扫描响应包含广告数据之上的附加数据。虽然不是所有的BLE设备都有扫描响应，但在我们的例子中，信标发送了一个，我们也在BlueBlue上捕捉到了它。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="99a4" class="nd lx iu mx b gz nt nu l nv nw">05 09 53 50 42 31 11 16 03 18 eb 58 7c 95 52 94 00 01 00 02 06 03 e8 64 00 00 00 00 00 00 00</span></pre><p id="7c3c" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">幸运的是，这种格式与广告数据非常相似——第一个八位字节是长度，接下来是数据类型，然后是数据本身。让我们来分解一下我们的扫描响应。</p><ul class=""><li id="9ee7" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">05</code> —长度(5)</li><li id="5635" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">09</code> —类型是完整的本地名称</li><li id="9772" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">53 50 42 31</code>—“sp B1”(ASCII)</li><li id="1175" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">11</code> —长度(十进制17)</li><li id="f734" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">16</code> —类型是服务数据(16位UUIDs)</li><li id="12d4" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">03 18 eb 58 7c 95 52 94 00 01 00 02 06 03 e8 64 00 00 00 00 00 00 00</code> —服务数据</li></ul><p id="72ab" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">因为类型是具有16位UUID的服务数据，所以服务UUID是前2个八位字节，即<code class="fe mu mv mw mx b">0x1803</code>(是的，它再次被颠倒)，并且服务的剩余数据是<code class="fe mu mv mw mx b">eb 58 7c 95 52 94 00 01 00 02 06 03 e8 64 00 00 00 00 00 00 00</code>。</p><p id="7793" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">那么，您能对服务数据做些什么呢？首先，服务数据的前2个八位字节是16位服务UUID(如所示类型)，即<code class="fe mu mv mw mx b">0x1803</code>。如果您查看蓝牙SIG的<a class="ae lf" href="https://www.bluetooth.com/specifications/gatt/services/" rel="noopener ugc nofollow" target="_blank"> GATT服务列表</a>，您可能会注意到这是链路丢失服务。</p><p id="157c" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">然而，这个信标并没有真正的链接丢失服务，它只是一个便宜的信标，花费几美元，我们从中国制造商那里买的。制造商基本上使用这个服务UUID，但是存储不同的数据。至于是什么样的数据，这个是来自厂商的数据表。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj oo"><img src="../Images/4067969c36f408e8a76c2ff672676feb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bfzV6vv2WW5IGVr1JlFDcg.png"/></div></div></figure><ul class=""><li id="6b53" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">eb 58 7c 95 52 94</code>——这是信标的地址，但令人惊讶的是这不是反过来的(我不知道为什么)！</li><li id="1d64" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00 01</code> —这是主要编号(来自iBeacon格式)</li><li id="4e86" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00 02</code> —这是次要编号(也来自iBeacon格式)</li><li id="d32f" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">06</code> —这是发射功率(在另一个表中)表示发射功率为0 dBM</li><li id="426f" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">03 e8</code> —这是以毫秒为单位的广播间隔(十进制1，000)。因此这意味着广播间隔为1秒</li><li id="2375" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated">这是电池电量(十进制100)，我想这意味着电池电量仍然是100%(我才用了几个星期)</li><li id="d727" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00 00 00 00 00 00 00</code> —我假设剩下的只是填充符</li></ul><p id="6b07" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">没那么糟糕。有大量的数据，我们学到了很多关于信标的知识。让我们看看别的。</p><h1 id="681b" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">资产标签</h1><p id="fa13" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">市场上有一种特殊的设备，只需几美元，就可以用来追踪或标记你的物品。如果你放错了地方，你可以用这个标签找到它。你能用它的东西包括车钥匙，钱包，甚至宠物和孩子！这背后的想法是，如果你标记的东西丢失了，你只需使用手机上相应的应用程序，让它大声发出哔哔声。反过来也可以，标签上有一个按钮，当你按下时，手机会发出声音。它可以非常方便。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj op"><img src="../Images/1ba04e7b5ba06bad46d45686bca1ce9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3uFd56-Lmzv_N1nWpiFpig.jpeg"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">我的iTags(鸣谢张秀雄)</p></figure><h2 id="273c" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告</h2><p id="9425" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">在第一次潜入信标后，这应该更熟悉了。这是乐广告报道播出的广告:</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="eca1" class="nd lx iu mx b gz nt nu l nv nw">02 01 00 00 80 e4 56 b4 ff ff 0e 02 01 05 02 0a 00 03 19 c1 03 03 02 e0 ff be</span></pre><p id="c781" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们经历同样的分解。</p><ul class=""><li id="0bec" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code>—<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>事件的子事件代码</li><li id="ea2f" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —报告数量</li><li id="c738" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —事件类型，可连接和可扫描的无向广告(ADV _印度)</li><li id="152f" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —地址类型是公共设备地址</li><li id="0336" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">80 e4 56 b4 ff ff</code> —地址(反过来，地址是<code class="fe mu mv mw mx b">ff:ff:b4:56:e4:80</code>)</li><li id="8838" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">0e</code> —数据长度(十进制14)</li><li id="358d" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">02 01 05 02 0a 00 03 19 c1 03 03 02 e0 ff</code> —广告</li><li id="3052" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">be</code> — RSSI(十进制190，190–256 =-66 dBM)</li></ul><p id="73e8" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">前3个二进制八位数应该很熟悉。地址类型是公共地址，这意味着它应该是固定地址。现在我们来看地址(<code class="fe mu mv mw mx b">ff:ff:b4:56:e4:80</code>)。如果您查看地址的U/L位<a class="ae lf" href="https://medium.com/swlh/scanning-for-mobile-devices-through-wi-fi-using-pi-zero-w-8099be08cc1e" rel="noopener">，第一个八位字节的第二个最低有效位(LSB)是1 </a>(第一个八位字节是<code class="fe mu mv mw mx b">0xFF</code>，因此它们都是1)，这意味着这是一个LAA，这意味着它实际上不是一个由IEEE管理的范围。</p><p id="2a41" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">数据长度不言自明，RSSI的计算方法与上面相同，为-66 dBM。现在我们来看看广告数据。</p><h2 id="fa55" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告有效载荷</h2><p id="acb4" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">这是来自广播广告的广告有效载荷。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="cbf4" class="nd lx iu mx b gz nt nu l nv nw">02 01 05 02 0a 00 03 19 c1 03 03 02 e0 ff</span></pre><p id="9fb5" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们像以前一样分解它，从第一盘开始。</p><ul class=""><li id="597e" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —数据长度(2)</li><li id="2637" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —广告数据类型为标志</li><li id="97cd" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">05</code> —标志以位为单位，所以翻译成二进制就是(0101)。由此我们可以看出这是LE受限发现模式，BR/EDR不支持。</li></ul><p id="3631" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们继续下一盘。</p><ul class=""><li id="63cb" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —数据长度(2)</li><li id="7e49" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">0a</code> —广告数据类型为发射功率电平(TX功率电平)</li><li id="85d8" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —这是发射功率水平的值(0)。有了这个值，你可以计算路径损耗(或路径衰减)。计算路径损耗的公式为:</li></ul><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="9e59" class="nd lx iu mx b gz nt nu l nv nw">path loss = Tx Power Level - RSSI</span></pre><p id="4f34" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在我们的例子中，这将是:</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="5be9" class="nd lx iu mx b gz nt nu l nv nw">path loss = 0 - (-66) = 66 dB</span></pre><p id="d19e" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这是下一组。</p><ul class=""><li id="9ac5" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">03</code> —数据长度(3)</li><li id="fa4d" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">19</code> —广告数据类型为外观</li><li id="c8f6" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">c1 03</code> —(十进制961)通过与GATT特征的核对，我们可以看到所列的外观是键盘的外观</li></ul><p id="19d5" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我们现在到了最后一盘。</p><ul class=""><li id="0d30" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">03</code> —数据长度(3)</li><li id="bfe2" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —广告类型为16位服务UUID不完整列表</li><li id="af89" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">e0 ff</code> —这是16位服务UUID值</li></ul><p id="c12f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">“不完整列表”的广告类型实质上意味着该服务UUID仅仅是可用的少数服务之一。然而，制造商选择不广播全部内容(出于各种原因，主要是为了节省电池电量)。如果你想知道其他人，你可以连接到设备上找到答案。</p><h2 id="53f1" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">扫描响应</h2><p id="352d" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">iTAG也发送扫描响应。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="747d" class="nd lx iu mx b gz nt nu l nv nw">11 09 69 54 41 47 20 20 20 20 20 20 20 20 20 20 20 20</span></pre><p id="30e8" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">答案非常简单</p><ul class=""><li id="3ab8" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">11</code> —数据长度(17位)</li><li id="7cf7" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">09</code> —类型是完整的本地名称</li><li id="b922" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">69 54 41 47 20 20 20 20 20 20 20 20 20 20 20 20 </code> —这是ASCII中的“iTAG”，后面跟着一串空格</li></ul><p id="c9ee" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这些都在扫描响应中。</p><p id="4c17" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这看起来很短，实际上大多数有趣的行为只发生在我们连接的时候。我在这里不讨论如何连接到它，那将是另一个故事，所以让我们看看别的东西。</p><h2 id="8803" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">苹果铅笔</h2><p id="dfba" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">在我测试BlueBlue的时候，碰巧我的Apple Pencil也在附近，有趣的是，当我开始使用这支铅笔时，它就出现了。也就是说，当我拿起它使用时，它就开始做广告了。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nb"><img src="../Images/af56c8e9a6417e9464c2076fa9e05b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBCvUMtQtxaoMjlKwFZ7lQ.jpeg"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">我的苹果铅笔1</p></figure><p id="8bf1" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">但是它没有扫描响应。这是广告。</p><h2 id="c387" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告</h2><p id="7dbc" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">现在我们已经用两种不同的设备做了两次，这应该很快。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="fcb4" class="nd lx iu mx b gz nt nu l nv nw">02 01 00 01 e2 1e 4d 3c a8 48 1e 02 01 06 1a 09 41 70 70 6c 65 20 50 65 6e 63 69 6c 00 00 00 00 00 00 00 00 00 00 00 00 00 e4</span></pre><ul class=""><li id="7e4f" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code>—<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>事件的子事件代码</li><li id="e466" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —报告数量</li><li id="59c2" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —事件类型，可连接和可扫描的无向广告(ADV_IND)</li><li id="6c4e" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —地址类型为随机设备地址</li><li id="e2c6" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">e2 1e 4d 3c a8 48</code> —地址(反过来，地址是<code class="fe mu mv mw mx b">48:a8:3c:4d:1e:e2</code>)</li><li id="0891" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">1e</code> —数据长度(十进制30)</li><li id="30e9" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">02 01 06 1a 09 41 70 70 6c 65 20 50 65 6e 63 69 6c 00 00 00 00 00 00 00 00 00 00 00 00 00</code> —广告</li><li id="f561" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">e4</code> — RSSI(十进制228，228–256 =-28 dBM，我把它举得离我的Pi4很近)</li></ul><h2 id="9748" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告有效载荷</h2><p id="5960" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">这是来自广播广告的广告有效载荷。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="d82c" class="nd lx iu mx b gz nt nu l nv nw">02 01 06 1a 09 41 70 70 6c 65 20 50 65 6e 63 69 6c 00 00 00 00 00 00 00 00 00 00 00 00 00</span></pre><p id="ca5e" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们像以前一样分解它，从第一盘开始。</p><ul class=""><li id="78ba" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —数据长度(2)</li><li id="0c35" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —广告数据类型为标志</li><li id="07c4" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">06</code> —标志以位为单位，所以翻译成二进制就是(<code class="fe mu mv mw mx b">0110</code>)。由此我们可以看出这是LE通用可发现模式，BR/EDR不支持。</li></ul><p id="52b0" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们继续下一盘。</p><ul class=""><li id="c9ea" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">1a</code> —数据长度(26)</li><li id="f760" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">09</code> —类型是完整的本地名称</li><li id="33ea" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">41 70 70 6c 65 20 50 65 6e 63 69 6c 00 00 00 00 00 00 00 00 00 00 00 00 00</code> —这个简单的单词写着“Apple Pencil ”,后面跟着许多<code class="fe mu mv mw mx b">00</code></li></ul><p id="55b5" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我用我的第一代Apple Pencil和第二代Apple Pencil都试过这个，它只在第一代上有效。一个有趣的观察——每次Apple Pencil被激活(通过移动它或将其Lightning连接器连接到Lightning端口)，它都会广播一个不同的地址！每次我把Lightning连接器插到Lightning端口上，BlueBlue都会弹出一个新的Apple Pencil，这总是让我笑破肚皮。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj oq"><img src="../Images/4acca8e1eb123adf3bf4b22e7ddefaad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UvMgeaymVAEyZBjOt0fnpA.png"/></div></div></figure><h1 id="02af" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">欧姆龙7系列腕带血压计(型号BP654)</h1><p id="e2ff" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">我不会深入探讨程序员和高血压之间的关系，但是如果你正在阅读这篇文章，你可能知道这是真的。所以毫不奇怪，我碰巧附近有一个也触发了蓝蓝。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nb"><img src="../Images/6fed1df0b8357785296fcb5fb4227371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8u_XbbyPBigBe94KR44j2w.jpeg"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">我的血压计(鸣谢:张秀雄)</p></figure><p id="bc6d" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">实际上，血压计只会在按下数据传输按钮时发出广告。</p><h2 id="08c0" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广播广告</h2><p id="e192" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">让我们看看广播广告。这是从BlueBlue捕捉到的。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="8412" class="nd lx iu mx b gz nt nu l nv nw">02 01 00 01 00 d0 7a 08 07 d1 18 02 01 06 11 06 1b c5 d5 a5 02 00 bd b1 e1 11 a2 c9 80 39 be ec 02 0a 00 bf</span></pre><p id="1535" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这种崩溃不足为奇。</p><ul class=""><li id="ba0c" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code>—<code class="fe mu mv mw mx b">HCI_LE_Advertising_Report</code>事件的子事件代码</li><li id="f373" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —报告数量</li><li id="65ce" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00</code> —事件类型，可连接和可扫描的无向广告(ADV_IND)</li><li id="9052" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">01</code> —地址类型为随机设备地址</li><li id="b3d6" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00 d0 7a 08 07 d1 </code> —反向地址(<code class="fe mu mv mw mx b">d1:07:08:7a:d0:00</code>)</li><li id="0b5b" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">18</code> —数据长度(十进制24)</li><li id="7b54" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">02 01 06 11 06 1b c5 d5 a5 02 00 bd b1 e1 11 a2 c9 80 39 be ec 02 0a 00</code> —广告有效载荷</li><li id="e78c" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">bf</code> — RSSI(十进制191，191–256 =-65 dBM)</li></ul><h2 id="1286" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">广告数据</h2><p id="2791" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">好了，让我们更深入地了解广告有效载荷。</p><ul class=""><li id="00c3" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02 01 06</code> — ( <code class="fe mu mv mw mx b">0110</code> ) — LE通用可发现模式，不支持BR/EDR。</li><li id="d9b3" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">11</code> —数据长度(十进制17)</li><li id="a75e" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">06</code>—128位服务UUIDs的不完整列表</li><li id="1e7c" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">1b c5 d5 a5 02 00 bd b1 e1 11 a2 c9 80 39 be ec</code>—128位服务UUID</li></ul><p id="a749" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我们再次看到了一个不完整的服务UUID。就像之前一样，这告诉我们，如果我们连接，会有更多的服务可用，这只是其中之一。但是16位和128位的服务UUIDs有什么区别呢？</p><p id="ecee" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">当然，16位服务UUIDs更短，正因为如此，它节省了传输它们的功率(这也是为什么不是所有的服务都被广告的原因)。蓝牙SIG有一个官方16位服务UUIDs列表，你可以付费为自己或公司创建一个。</p><ul class=""><li id="315b" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">02</code> —数据长度</li><li id="dc76" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">0a</code> —发射功率水平</li><li id="97ac" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">00 </code> —发射功率电平为0</li></ul><h2 id="18c5" class="nd lx iu bd ly ne nf dn mc ng nh dp mg ks ni nj mi kw nk nl mk la nm nn mm no bi translated">扫描响应</h2><p id="5778" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">由此得到的扫描响应非常简单，本质上只是设备的名称。</p><pre class="lh li lj lk gu np mx nq nr aw ns bi"><span id="c467" class="nd lx iu mx b gz nt nu l nv nw">1e 09 42 4c 45 73 6d 61 72 74 5f 30 30 30 30 30 31 31 39 31 31 30 37 30 38 37 41 44 30 30 30</span></pre><ul class=""><li id="9443" class="ny nz iu kl b km kn kp kq ks oa kw ob la oc le od oe of og bi translated"><code class="fe mu mv mw mx b">1e</code> —数据长度(十进制30)</li><li id="da43" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">09</code> —类型是完整的本地名称</li><li id="73fd" class="ny nz iu kl b km oh kp oi ks oj kw ok la ol le od oe of og bi translated"><code class="fe mu mv mw mx b">42 4c 45 73 6d 61 72 74 5f 30 30 30 30 30 31 31 39 31 31 30 37 30 38 37 41 44 30 30 30 </code> —翻译为“BLEsmart_000001191107087AD000”</li></ul><p id="3f56" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">仅此而已。</p><h1 id="3737" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">很有趣！</h1><p id="920d" class="pw-post-body-paragraph kj kk iu kl b km mo jv ko kp mp jy kr ks mq ku kv kw mr ky kz la ms lc ld le in bi translated">在过去的几周里，我看到了以前从未见过的东西，这给了我一种奇怪的惊奇和发现的感觉。你应该试试！</p></div></div>    
</body>
</html>