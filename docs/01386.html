<html>
<head>
<title>Identifying High-Risk Groups Using SHAP Values on Healthcare Data.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用医疗保健数据的SHAP值识别高危人群。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/identifying-high-risk-groups-using-shap-values-on-healthcare-data-e3e7198f30f6?source=collection_archive---------16-----------------------#2020-02-07">https://towardsdatascience.com/identifying-high-risk-groups-using-shap-values-on-healthcare-data-e3e7198f30f6?source=collection_archive---------16-----------------------#2020-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="225f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">了解如何使用shap值进行更好的聚类。</strong></h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b14c53ab8d01c16619f4bf0b681b627c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wnTXS4cPw-Tw_oC79VweTQ.jpeg"/></div></div></figure><h1 id="b5ae" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">动机</h1><p id="583e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">机器学习在过去几年取得了相当大的进展，这主要归功于我们可以获得的大量数据和可以从数据中提取一些结构和意义的复杂算法。一方面，这些复杂的模型提供了最先进的结果，但另一方面，它们也是一种难以理解和解释的谜。从法律和医疗保健的角度来看，模型的可解释性非常重要，因为它可以增加医疗保健中人工智能的信任和采用。</p><p id="4a51" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">例如，在医疗保健行业，预测患者何时死亡可能是有用的，但更重要的是，了解我们的模型输出可以帮助我们识别那些具有任何不良结果高风险的聚类集(具有相似属性的患者)。这最终将导致在早期阶段更好和适当的干预。</p><h1 id="13b7" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">模型可解释性</h1><p id="92c3" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">有相当多的方法可以帮助我们理解模型的结果。然而，我将讨论SHAP价值观，以及如何用它们来解释全球和地方层面的模型。</p><h1 id="8eb8" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">得体的附加解释(SHAP)</h1><p id="150f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Shap值基本上给出了每个特征对我们最终预测的平均贡献。它帮助我们更直观地分析和解释我们的模型。为了更好地理解什么是shap值以及它们是如何计算的，本文有一些非常好的内容<a class="ae mk" href="https://medium.com/@gabrieltseng/interpreting-complex-models-with-shap-values-1c187db6ec83" rel="noopener">https://medium . com/@ Gabriel Tseng/interpreting-complex-models-with-shap-values-1c 187 db 6 EC 83</a>。</p><p id="2b90" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">通过shap值，我们可以了解我们的模型在微观层面上为每个预测做了什么，这可以帮助我们确定哪些特征对我们的最终预测有多大贡献。</p><p id="e56a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在这里，我们将使用shap值来创建聚类，看看它们是否有助于识别心脏病风险较高的患者。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/c739955d1bf747a1a2e3a9893982a807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*f-8gcHddBOJT-spCriJo8w.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">通过聚类识别高危患者</p></figure><p id="e1f3" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">正如你从上面的管道中看到的，这篇文章的目的首先是将XGboost这样的复杂模型拟合到数据中，然后使用SHAP库获得数据中每个例子的SHAP值，然后对它们进行聚类，以找到可以导致早期干预或更好地治疗患者的模式。本例的数据集由许多预测患者是否患有心脏病的特征组成。</p><h1 id="d5d2" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">为什么我们使用SHAP值进行聚类？</h1><p id="072b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">使用shap值进行聚类的优点是所有要素的shap值都在相同的范围内(二进制xgboost的对数概率)。这有助于我们生成有意义的集群。这里的目标是聚集那些具有相同预测心脏病风险的shap值。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="e528" class="mv ks iq mr b gy mw mx l my mz">#importing the required dependencies.<br/>import pandas as pd<br/>from xgboost import XGBClassifier<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.cluster import KMeans<br/>from sklearn.metrics import silhouette_score<br/>import pylab as pl<br/>import shap<br/>shap.initjs()</span></pre><p id="b901" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们导入<a class="ae mk" href="https://archive.ics.uci.edu/ml/datasets/Heart+Disease" rel="noopener ugc nofollow" target="_blank">数据集</a>并将其分成训练集和测试集。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="6502" class="mv ks iq mr b gy mw mx l my mz"># loading the data set<br/>data = pd.read_csv("D:/RnD/heart.csv")<br/>#Seperating the target from the features<br/>X = data.drop("target", axis  = 1)<br/>#setting y as the target variable<br/>y = data.target<br/>#Splitting the dataset into train and test<br/>X_train, X_test, y_train, y_test = train_test_split(X,y, random_state = 100)</span></pre><p id="3855" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">接下来，我们训练一个Xgboost模型用于分类。这里的重点不是获得一个高度精确的模型，而是我想向您展示shap值如何用于聚类。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="0bfa" class="mv ks iq mr b gy mw mx l my mz">model = XGBClassifier(objective = "binary:logistic")<br/>model.fit(X_train,y_train)</span></pre><p id="477f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">好了，我们已经训练好了模型，现在我们可以使用SHAP库来获得模型的shap值。下面的代码块首先在训练好的模型上使用Tree explainer方法创建一个Explainer对象。然后使用explainer对象来获取测试数据的shap值。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="d214" class="mv ks iq mr b gy mw mx l my mz">explainer = shap.TreeExplainer(model)<br/>shap_values = explainer.shap_values(X_test)</span></pre><p id="f36c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用肘方法来决定有多少个分类适合我们的数据。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="b371" class="mv ks iq mr b gy mw mx l my mz">#convert shap_values array to dataframe<br/>s = pd.DataFrame(shap_values, columns = X_test.columns)<br/>#Use Elbow method to decide the optimal number of clusters<br/>sse = []<br/>for k in range(2,15):<br/>    kmeans = KMeans(n_clusters = k)<br/>    #fit the k-means model on the shap values<br/>    kmeans.fit(s)<br/>    #appent the error of each iteration<br/>    sse.append(kmeans.inertia_)<br/>   <br/>pl.plot(range(2,15), sse)<br/>pl.title("Elbow Curve")<br/>pl.show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi na"><img src="../Images/08557b24fcd700aab1cf6d1299a9fdec.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*mTEZ28lIC4EX3dRh16H6jQ.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">x轴=聚类数，y轴=错误率(sse)</p></figure><p id="3e3c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我在这里选择6作为期望的集群数。接下来，我们再次将K-Means模型拟合到测试集的shap值，聚类数为6。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="c5ea" class="mv ks iq mr b gy mw mx l my mz">kmeans = KMeans(n_clusters = 7, random_state = 100).fit(s)<br/>#selecting cluster centres<br/>centroids = kmeans.cluster_centers_</span></pre><p id="615c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，我们为每个患者(数据点)映射基于其训练分配给它的聚类。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="793b" class="mv ks iq mr b gy mw mx l my mz">patient = pd.DataFrame(X_test.index)<br/>cluster_no = pd.DataFrame(kmeans.labels_)<br/>df= pd.DataFrame()</span><span id="6df0" class="mv ks iq mr b gy nb mx l my mz">#Concatenating the patient ids with the assigned cluster lables</span><span id="152c" class="mv ks iq mr b gy nb mx l my mz">df = pd.concat([patient,cluster_no], axis =1)<br/>df.columns = ["patient", "cluster no"]</span></pre><p id="cf87" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">基于我们之前训练的xgboost模型的学习，我们现在将为剩余的测试数据生成预测并评估它们。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="f3df" class="mv ks iq mr b gy mw mx l my mz">y_pred = model.predict(X_test)<br/>y_pred = pd.DataFrame(y_pred, index= X_test.index, columns = ["target"])</span><span id="3064" class="mv ks iq mr b gy nb mx l my mz">df = df.set_index("patient")<br/>cluster_df = pd.concat([df, y_pred], axis = 1)</span></pre><p id="ef14" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">用它们各自的患者id(索引)对聚类进行分组，以识别具有较高疾病检测百分比的聚类。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="8826" class="mv ks iq mr b gy mw mx l my mz">group = (100 * cluster_df[cluster_df["target"]==1].groupby(by = ["cluster no","target"]).size()/len(df.index))<br/>group = group.reset_index(level = 1, drop = True)<br/>group = pd.DataFrame(group, columns  = ["Disease Percentage"])<br/>group</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/cef638ae94ee7ebdeefa1e1754d74cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:410/format:webp/1*DHuHsoiNJEyB81g3_hiL6w.png"/></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">疾病百分比</p></figure><p id="ce96" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">从图中，我们可以看到，我们的聚类中的疾病百分比有所不同。注意:这里没有显示没有疾病的集群。</p><h1 id="565a" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">我们从这些星团中发现了什么吗？</h1><p id="11ce" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">所以让我们试着推理一下，我们是否能从已经生成的集群中得到一些东西。下图包含心脏病检测的百分比以及每个聚类的每个特征的平均值。为了简洁起见，我对值进行了四舍五入。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/0f104b34fd28fda9e8826cbede22ea6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*brVAkFppbjn2VLkHN85BlA.png"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">使用shap值的聚类分析</p></figure><p id="be03" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="ne"> cp =胸彩——从上表可以明显看出，cp越高，患心脏病的几率越大</em></p><p id="20c7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="ne"> restecg =静息心电图结果——心脏病发病率较高的聚类往往具有较高的restecg平均值</em></p><p id="5792" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="ne">具有较高thalach平均值的聚类具有较高的心脏病检测百分比。</em></p><p id="5a3d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们所做的推理帮助我们识别数据中的模式，我们现在可以寻找可能的干预措施或解决方案来帮助预防心脏病。</p><h1 id="891c" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">下一步是什么？</h1><p id="534a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">到目前为止，本笔记本中描述的方法有些天真。例如，仅从肘方法中选择聚类的数量不是一个很好的主意，我们还需要看看其他一些措施来解释该算法如何很好地对我们的数据进行聚类。剪影分数就是这样一种测量方法，它可以帮助定义我们对数据进行聚类的程度。</p><blockquote class="nf ng nh"><p id="56a1" class="lj lk ne ll b lm mf jr lo lp mg ju lr ni mh lu lv nj mi ly lz nk mj mc md me ij bi translated">事实仍然是，有许多聚类指标可以帮助我们了解我们的聚类的拟合度，但这都是相对于我们认为好的指标而言的。此处进一步解释<a class="ae mk" href="https://www.researchgate.net/post/How_can_we_say_that_a_clustering_quality_measure_is_good" rel="noopener ugc nofollow" target="_blank">https://www . research gate . net/post/How _ can _ we _ say _ that _ a _ clustering _ quality _ measure _ is _ good</a></p><p id="ca57" class="lj lk ne ll b lm mf jr lo lp mg ju lr ni mh lu lv nj mi ly lz nk mj mc md me ij bi translated">“问题是，我们不能真的说什么聚类质量度量是好的还是不好的。“好的集群”的概念是相对的，是一个观点的问题。这同样适用于质量措施。这取决于你想评价什么。”</p></blockquote><p id="db3f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">因此，从这里得出的结论是，我们需要测试不同的集群，并决定哪个指标可以很好地适应我们的问题，并有效地解释我们所拥有的集群。</p><p id="2b30" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">参考资料:</p><p id="a5e4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">[1]https://shap.readthedocs.io/en/latest/<a class="ae mk" href="https://shap.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"/></p><p id="3485" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">[2]https://github.com/slundberg/shap<a class="ae mk" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"/></p><p id="747e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">[3]<a class="ae mk" href="https://www.youtube.com/watch?v=vA_czRcCpvQ" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=vA_czRcCpvQ</a></p><p id="5d08" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">[4]数据来源:<a class="ae mk" href="https://archive.ics.uci.edu/ml/datasets/Heart+Disease" rel="noopener ugc nofollow" target="_blank">https://archive.ics.uci.edu/ml/datasets/Heart+Disease</a></p></div></div>    
</body>
</html>