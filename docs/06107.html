<html>
<head>
<title>Airflow: how and when to use it</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流:如何以及何时使用它</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/airflow-how-and-when-to-use-it-2e07108ac9f5?source=collection_archive---------11-----------------------#2020-05-18">https://towardsdatascience.com/airflow-how-and-when-to-use-it-2e07108ac9f5?source=collection_archive---------11-----------------------#2020-05-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ed5e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">除了知道如何使用气流，知道何时使用气流也很重要。</h2></div><p id="3b52" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Airflow </a>是一款用于管理和监控工作流程的流行工具。对于我们在<a class="ae lb" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Bluecore </a>的大多数数据科学工作流来说，它工作得很好，但也有一些其他工具表现更好的用例。除了知道<em class="lc">如何</em>使用气流，知道<em class="lc">何时</em>使用气流也很重要。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/792f1c7ec9675edbea92a1971b7350d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_XqyBHq7HoiisVMio_45rg.png"/></div></div></figure><h1 id="58aa" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">关于气流</h1><blockquote class="mh mi mj"><p id="021a" class="kf kg lc kh b ki kj jr kk kl km ju kn mk kp kq kr ml kt ku kv mm kx ky kz la ij bi translated"><strong class="kh ir">“Airflow 是一个以编程方式创作、安排和监控工作流的平台。”— </strong> <a class="ae lb" href="https://airflow.apache.org/docs/stable/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">气流文件</strong> </a></p></blockquote><p id="e0ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">听起来很有用，对吧？嗯，确实是！Airflow 使得在它们的 UI 中监控管道的状态变得容易，并且您可以使用任务之间复杂的扇入和扇出关系来构建 Dag。他们还补充道:</p><blockquote class="mh mi mj"><p id="d734" class="kf kg lc kh b ki kj jr kk kl km ju kn mk kp kq kr ml kt ku kv mm kx ky kz la ij bi translated"><strong class="kh ir">“丰富的命令行实用程序使在 Dag 上执行复杂的手术变得轻而易举。”</strong></p></blockquote><p id="2e6d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这让我笑了，因为有时与气流一起工作感觉像是脑部手术，而其他时候它工作了，感觉像是第二天回家的那种。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi mn"><img src="../Images/ede16ec96f7a9aa94b3275328f252433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YFmn3CSt7yKcIETRCIw4dg.png"/></div></div></figure><h2 id="8758" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">基本组件</h2><p id="524e" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">在我们进入气流的更复杂的方面之前，让我们回顾几个核心概念。</p><h2 id="6bae" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">熟练的技艺</h2><blockquote class="mh mi mj"><p id="4ae2" class="kf kg lc kh b ki kj jr kk kl km ju kn mk kp kq kr ml kt ku kv mm kx ky kz la ij bi translated"><a class="ae lb" href="https://airflow.apache.org/docs/stable/concepts.html" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">DAG 是您想要运行的所有任务的集合，以反映它们的关系和依赖性的方式组织。</strong>T19】</a></p></blockquote><p id="f6d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DAG 或有向无环图是流水线中所有任务、工作单元的集合。这些任务是按照它们之间的关系和依赖关系来组织的。例如，如果要查询数据库一，然后将结果加载到数据库二，则需要在将结果加载到数据库二的任务之前直接运行查询数据库一的任务。有向<em class="lc">非循环</em>图暗示你的管道只能向前，不能向后。一个任务可以重试，但是在完成一个任务并且下游的另一个任务已经开始之后，该任务不能重新运行。</p><p id="6f4b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DAG 页面是 Airflow UI 中的主页。显示 DAG 计划，并且可以打开/关闭。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nf"><img src="../Images/1a1d42550db93025d5f1a46a9ab82a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rlLASorB4xSjI_PrFqhEXQ.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">气流 UI DAG 视图</p></figure><h2 id="47df" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">DAG 管道示例</h2><p id="0eac" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">气流之所以如此有用，是因为它能够处理任务之间的复杂关系。您可以轻松地构造扇入和扇出的任务。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nk"><img src="../Images/361f5271afb038d785369a5c08b69fb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zCaJ1GzHtnseNPGeXaiMQA.png"/></div></div></figure><p id="9640" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是我们在 Bluecore 使用的一个工作流程示例。这是一个非常简单的 DAG，它使用 AppEngineOperator 调用我们在 AppEngine 中创建的命令，该命令进行查询并返回 Bluecore 的活动合作伙伴列表。接下来，我们使用 PythonOperator 来更新 Airflow 变量。如果更新任务成功或失败，我们将向<a class="ae lb" href="https://www.datadoghq.com/product/" rel="noopener ugc nofollow" target="_blank"> datadog </a>发送适当的度量。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nl"><img src="../Images/a2557d5791e79b9ab7e621eb4124369c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-8SVhDCsaj6F1OuVaXR0ow.png"/></div></div></figure><h2 id="868d" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">任务/操作员</h2><blockquote class="mh mi mj"><p id="b25d" class="kf kg lc kh b ki kj jr kk kl km ju kn mk kp kq kr ml kt ku kv mm kx ky kz la ij bi translated"><strong class="kh ir">“实例化操作员对象时生成任务。”-气流文件</strong></p></blockquote><p id="99af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">说快 10 倍。</p><p id="329b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任务是理想的独立部分，不依赖于来自另一个任务的信息。操作员类对象在运行时会变成任务。可以导入操作符类，实例化该类会产生类对象。该对象的实例化(运行操作符代码)是<strong class="kh ir">任务</strong>。一开始，任务和操作符之间的细微差别可能会令人困惑，所以我发现制作这个图表很有帮助。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nm"><img src="../Images/fbc404b8a21707d4200c87ab1f74d07c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tEyBS9hTHQw1cLxA_m9HwQ.png"/></div></div></figure><h2 id="d7ae" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">在 DAG 文件中定义 DAG 和任务</h2><p id="2ee2" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">概念很好，但是你可能会问自己，我实际上如何编写代码来创建 DAG？嗯，在 Bluecore，我们有一个专门用于定义 Dag 的 python 文件的<a class="ae lb" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> Github </a>库。例如，您可以创建 example_dag.py，并从定义 dag 对象开始。您将从 Airflow 导入 DAG 类，并定义您需要的参数。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nn"><img src="../Images/7d5654cb8802e38ab08779c0f36fcec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*coPbHqQ7_aL8-vzrYQ2l3w.png"/></div></div></figure><p id="69ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，写下每个任务。将 dag 参数设置为 dag 对象会将任务与 DAG 相关联。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi no"><img src="../Images/206a9c3f21801ebd33e780b835b6c2e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFGWiEr_Nu4pd3v3EoZdFw.png"/></div></div></figure><p id="4d32" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，定义任务之间的关系。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi np"><img src="../Images/73e169ce2a0ee6b655931f379972278b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*9e0CSNp-3MHhNEM8fRXWmg.png"/></div></figure><p id="bdef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将 DAG 和任务定义以及定义上游/下游任务放在一起会产生一个 DAG 定义文件。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nq"><img src="../Images/b85aa5120b8d975794658b99b4fe7284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AD7LJg9sJxLL4nm3OUvemQ.png"/></div></div></figure><h2 id="5821" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">变量</h2><p id="648f" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">变量是气流的另一个有用组成部分。我们使用变量有两个基本目的:<strong class="kh ir">与环境相关的</strong>和<strong class="kh ir">特定于模型的参数</strong>。可以在 DAG 文件中访问变量，例如，可以更新项目 id 或图像标签，而无需对 DAG 进行任何更改。如果您有多个环境，例如 QA 和生产环境，这将特别有用。此外，我们的一些模型并不面向所有合作伙伴，而是面向一组特定的合作伙伴。我们有一个单独的 DAG，它更新包含特定于模型的伙伴的变量，然后当模型运行时，它从变量中提取它的伙伴列表。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nr"><img src="../Images/a99fe00d79508a8eb1a1d88e4d883290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9w0kXRm515EVtU0BT4e4ag.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">气流 UI 可变视图</p></figure><h2 id="7607" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">泳池</h2><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ns"><img src="../Images/3b5e39f32ac585a968489f4a009dddcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBvzPwMqV4rLDEiUglA2Yw.png"/></div></div></figure><p id="cf72" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">池控制允许 DAG 一次消耗的资源数量。应该根据任务完成的速度和 DAG 需要完成的速度来定义池。确保在使用池时，您没有使用其他人的池，否则两个 Dag 可能不会像预期的那样快速完成。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nt"><img src="../Images/e23207c14fe27727a3c57eebef979a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jm0eb06rYD9C3urNc9bdaA.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">气流 UI 池视图</p></figure><h2 id="fa77" class="mo lq iq bd lr mp mq dn lv mr ms dp lz ko mt mu mb ks mv mw md kw mx my mf mz bi translated">XComs</h2><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nu"><img src="../Images/19d2186ac0629daaf4defc281f50f2fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6sBfWe8l1tGc0htuVomMHg.png"/></div></div></figure><p id="5a48" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">理想情况下，任务是相互独立的，但有时这是不可能的，任务需要相互通信。这种相互通信是由 xcom 完成的。XComs 可以在任务之间“推”(发送)或“拉”(接收)。</p><p id="9fc9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，您可能需要将一个任务的返回值推送到 xcom 表中，以便在下一个任务中从 xcom 表中提取该值，并将其用作参数。在前面 DAGs 部分描述的简单 DAG 示例中，第一个任务将活动伙伴列表推送到 xcom 表，第二个任务从 xcom 表中取出伙伴列表，并将该列表设置为气流变量。</p><h1 id="119d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">摘要</h1><p id="19aa" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">我们回顾了何时使用气流(当您的管道需要支持扇入/扇出时)，如何构建 DAG，DAG 为什么有用，以及各种气流组件。总之，我们了解了</p><ul class=""><li id="9c80" class="nv nw iq kh b ki kj kl km ko nx ks ny kw nz la oa ob oc od bi translated">熟练的技艺</li><li id="d340" class="nv nw iq kh b ki oe kl of ko og ks oh kw oi la oa ob oc od bi translated">任务/操作员</li><li id="0256" class="nv nw iq kh b ki oe kl of ko og ks oh kw oi la oa ob oc od bi translated">如何构建 DAG 和设置任务关系</li><li id="54c0" class="nv nw iq kh b ki oe kl of ko og ks oh kw oi la oa ob oc od bi translated">变量</li><li id="2272" class="nv nw iq kh b ki oe kl of ko og ks oh kw oi la oa ob oc od bi translated">泳池</li><li id="9961" class="nv nw iq kh b ki oe kl of ko og ks oh kw oi la oa ob oc od bi translated">Xcoms</li></ul><p id="0d2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您已经有了开始创建 DAG 所需的工具，可以在其中构建复杂的数据管道了！如果您有兴趣了解更多信息，请参见<a class="ae lb" href="https://medium.com/@alexagriffith/airflow-how-and-when-to-use-it-advanced-238ea6b63f13" rel="noopener"> Airflow:如何以及何时使用它(高级)</a>了解有关操作符、结构化 Dag 以及 Airflow 缩放问题的更多信息。</p></div></div>    
</body>
</html>