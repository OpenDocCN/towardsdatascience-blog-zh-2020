<html>
<head>
<title>Predicting Apple Stock in times of COVID-19</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预测新冠肺炎时代的苹果股票</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-apple-stock-in-times-of-coronavirus-ca434bd2f788?source=collection_archive---------21-----------------------#2020-04-02">https://towardsdatascience.com/predicting-apple-stock-in-times-of-coronavirus-ca434bd2f788?source=collection_archive---------21-----------------------#2020-04-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fcd7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">简单是关键。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2f38d99f5b4def5e65f8c01a73c12d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SxfYshtv47IJ10EDWe3MDQ.png"/></div></div></figure><h1 id="4664" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="cfad" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">2 月 13 日，我发表了一篇关于“<a class="ae mi" rel="noopener" target="_blank" href="/making-a-continual-ml-pipeline-to-predict-apple-stock-with-global-news-python-90e5d6610b21">使用连续 ML </a>预测苹果股票的杰出成果”的文章。</p><p id="ed86" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">有人建议<strong class="lo iu">在<strong class="lo iu">“不受欢迎”的场景</strong>中尝试一下</strong>，所以我重新运行了一个改进的练习<strong class="lo iu">，包括最后几周</strong>，看看它在这些<strong class="lo iu">艰难时期</strong>的表现。</p><h1 id="3da1" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">我们要做什么</h1><ul class=""><li id="7bd7" class="mo mp it lo b lp lq ls lt lv mq lz mr md ms mh mt mu mv mw bi translated">步骤 1:定义并理解 ML 的<strong class="lo iu">目标</strong></li><li id="f8f2" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">步骤 2:设置技术<strong class="lo iu">先决条件</strong></li><li id="2b90" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">第三步:<strong class="lo iu">获取数据</strong></li><li id="0b1a" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">步骤 4: <strong class="lo iu">准备</strong>我们的数据<strong class="lo iu"> </strong>和<strong class="lo iu">应用 ML </strong>运行模拟</li><li id="df97" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">步骤 5:测量和分析<strong class="lo iu">结果</strong></li></ul><h1 id="78c7" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">第一步。定义和理解目标</h1><p id="9558" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"><em class="nc">*免责声明:</em> </strong> <em class="nc">本次演习中有交易、做空佣金等费用未考虑在内。</em> <strong class="lo iu"> <em class="nc">作者不分担使用本文所带来的风险或利益</em> </strong> <em class="nc">。</em></p><p id="add3" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">苹果价格一直在上涨，但也在下跌，比如最近几周。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/85bfecfcacd8ee7ab53594c2c2a88f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OuA34jDYyQiF9KOP"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">截图取自 Investing.com</p></figure><p id="050e" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">我们想要的是检测第二天的<em class="nc">价格是否会<strong class="lo iu">上涨</strong>或<strong class="lo iu">下跌</strong>，这样我们就可以<strong class="lo iu">在前一天</strong>买入或做空。</em></p><p id="d38a" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">我们还希望变化率<strong class="lo iu">高于 0.5% </strong>，这样交易就值得了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/90cc913ab30825dd328f29eaca8c49c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wT14kRHx7vXjr0fq"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">随着时间而改变</p></figure><p id="7039" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">上面是随着时间的变化，绿点是价格上涨超过 0.5%的天数，红点是相反的。</p><p id="b885" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们<strong class="lo iu">定义我们的目标变量</strong>:</p><p id="7192" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">阳性 POC: </strong>“变化”增加超过 0.5%</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/bcc4f3f62b9bc547ffa2f793b6b6a0c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*hzFYfHDDn52tcZO7mEO0Gg.png"/></div></figure><p id="7151" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">阴性 POC: </strong>“变化”下降超过 0.5%</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/1d4c2e11c0c743613a3899b3ef19a2b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*gDcmkKnp4w_91JvURqSsIw.png"/></div></figure><p id="5f75" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">在最后一篇文章中，我们创建了一个 ML 模型，使用新闻来预测第二天的<strong class="lo iu">起义</strong>以及随后的<strong class="lo iu">表现</strong>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/2923920db1ef430743891399a021f5b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:350/format:webp/0*VxGgVK8skTSSTpIP.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/0f18843e08b0a8968596993bf852a23a.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*jD7Acwwb-EX8ldA75zHpZg.png"/></div></figure><p id="f7d8" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这意味着，从所有的观察来看，这个<strong class="lo iu">模型预测</strong>第二天价格将<strong class="lo iu">上涨 0.5% </strong>或更多(82 倍)，这是<strong class="lo iu">正确 72% </strong> <strong class="lo iu">倍</strong> (62 倍)。</p><p id="df73" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这个比率(也就是<strong class="lo iu">精度:</strong> TP / TP &amp; FP)是<strong class="lo iu">一个重要的指标</strong>，因为对于这个实验，每次预测为“将上升”(或者预测为下降时为“短”】时，我们都会“<strong class="lo iu">投资”，所以我们通常会优先考虑正确与否，即使我们会失去一些机会。</strong></p><p id="0ebe" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在让我们现在<strong class="lo iu">制作一个模型来预测上涨和下跌</strong>在“牛市”和“熊市”的时候。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/88b3e00a1d472d707d190c4681fa155c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fy009CljOYqqr5mMghtWVw.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">苹果价格过去几个月受到石油和新冠肺炎的影响</p></figure><h1 id="fef5" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">第二步。先决条件</h1><ul class=""><li id="f8cf" class="mo mp it lo b lp lq ls lt lv mq lz mr md ms mh mt mu mv mw bi translated">安装 Python 2.6+或 3.1+版本</li><li id="2890" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">安装熊猫、sklearn 和 openblender(带 pip)</li></ul><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="0bfc" class="nt kv it np b gy nu nv l nw nx">$ pip install pandas OpenBlender scikit-learn</span></pre><h1 id="1080" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">第二步。获取数据</h1><p id="b599" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><em class="nc">注意:这一步重复了第一篇文章中所做的，所以如果你已经做了，你可以跳过它。</em></p><p id="ebde" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们从每日<a class="ae mi" href="https://www.openblender.io/#/dataset/explore/5d4c39d09516290b01c8307b/or/38" rel="noopener ugc nofollow" target="_blank">苹果股票数据集中提取</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/41012033f278c69610d2d9d9fa90d8fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EnQ5cLhNKiDMkOuQ.png"/></div></div></figure><p id="c209" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">它在那一天有百分之<strong class="lo iu">的变化</strong>。</p><p id="5194" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">所以让我们<strong class="lo iu">通过 OpenBlender API <strong class="lo iu">拉数据</strong>。</strong></p><p id="a1e8" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">在 Python 上运行以下代码:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="66b6" class="nt kv it np b gy nu nv l nw nx"># Import the libraries</span><span id="3f3e" class="nt kv it np b gy nz nv l nw nx">from sklearn.ensemble import RandomForestRegressor<br/>from sklearn.metrics import accuracy_score<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn import metrics<br/>import pandas as pd<br/>import OpenBlender<br/>import json<br/>%matplotlib inline</span><span id="9e03" class="nt kv it np b gy nz nv l nw nx"><em class="nc"># Specify the action<br/></em>action = 'API_getObservationsFromDataset'</span><span id="25b7" class="nt kv it np b gy nz nv l nw nx"><em class="nc"># Specify your Token <br/>token = </em>'<strong class="np iu">YOUR_TOKEN_HERE</strong>'</span><span id="7dca" class="nt kv it np b gy nz nv l nw nx"><em class="nc"><br/># Specify the 'Apple Inc. Price' id_dataset</em></span><span id="10bd" class="nt kv it np b gy nz nv l nw nx">parameters = { <br/>      'token' : token,<br/>      'id_dataset':'<strong class="np iu">5d4c39d09516290b01c8307b</strong>',<br/>      'consumption_confirmation' : 'on',<br/>      'date_filter':{"start_date":"2017-01-01T06:00:00.000Z",<br/>                     "end_date":"2020-03-29T06:00:00.000Z"}<br/>}</span><span id="9990" class="nt kv it np b gy nz nv l nw nx"><em class="nc"># Pull the data into a Pandas Dataframe<br/></em>df = pd.read_json(json.dumps(OpenBlender.call(action, parameters)['sample']), convert_dates=False, convert_axes=False).sort_values('timestamp', ascending=False)<br/>df.reset_index(drop=True, inplace=True)</span></pre><p id="c6a3" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">注意:</strong>要获得令牌，你<em class="nc">需要</em>在<a class="ae mi" href="https://www.openblender.io/#/dataset/explore/5d4c39d09516290b01c8307b/or/38" rel="noopener ugc nofollow" target="_blank"> openblender.io </a>(免费)上创建一个帐户，你可以在你个人资料图标的“帐户”标签中找到它。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="6622" class="nt kv it np b gy nu nv l nw nx">#Let's take a look<br/>df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/85e87718ce736e5ad36207cb48349c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/0*viJaVGnoXtpDhL-K.png"/></div></figure><p id="f92b" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">为了融合商业新闻，我们需要:</p><ol class=""><li id="992a" class="mo mp it lo b lp mj ls mk lv ob lz oc md od mh oe mu mv mw bi translated">与我们的目标相关的有用的新闻数据</li><li id="05fe" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh oe mu mv mw bi translated"><strong class="lo iu">将它</strong>融合到我们的数据中，使<strong class="lo iu">消息与第二天的价格</strong>“变化”(这样模型就可以学习预测第二天的价格)</li><li id="0f8e" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh oe mu mv mw bi translated">将它转换成<strong class="lo iu">数字特征</strong>，这样它就可以遍历一个 ML 模型。</li></ol><p id="9d45" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们来看看这个<a class="ae mi" href="https://www.openblender.io/#/dataset/explore/5e2ef74e9516294390e810a9/or/38" rel="noopener ugc nofollow" target="_blank">华尔街日报新闻</a>数据集:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/ad26199ba0bced55259470da33232c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MfrDlCIWaG6sf5iv.png"/></div></div></figure><p id="ab14" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">以及<a class="ae mi" href="https://www.openblender.io/#/dataset/explore/5e32fd289516291e346c1726/or/38" rel="noopener ugc nofollow" target="_blank">今日美国</a>推特新闻。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/898ee059b0e6a719f20855113df6d569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QhH0-PcRU-tv41Dh.png"/></div></div></figure><ul class=""><li id="efa8" class="mo mp it lo b lp mj ls mk lv ob lz oc md od mh mt mu mv mw bi translated">注意:我选择这些是因为它们有意义，但你可以搜索数百个其他的。</li></ul><p id="b15b" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在，让我们创建一个文本矢量器，这是 OpenBlender 上的一个模型，它能够<strong class="lo iu">将令牌(矢量化文本)作为特征</strong>，就像它是另一个数据集一样:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="4cc3" class="nt kv it np b gy nu nv l nw nx">action = 'API_createTextVectorizerPlus'</span><span id="cd2f" class="nt kv it np b gy nz nv l nw nx">parameters = {<br/>    'token' : token,<br/>    'name' : 'Wall Street and USA Today Vectorizer',<br/>    'sources':[<br/>              {'id_dataset':"5e2ef74e9516294390e810a9", <br/>               'features' : ["text"]},<br/>              {'id_dataset' : "5e32fd289516291e346c1726", <br/>               'features' : ["text"]}<br/>    ],<br/>    'ngram_range' : {'min' : 1, 'max' : 2},<br/>    'language' : 'en',<br/>    'remove_stop_words' : 'on',<br/>    'min_count_limit' : 2<br/>}</span><span id="4431" class="nt kv it np b gy nz nv l nw nx">response = OpenBlender.call(action, parameters)<br/>response</span></pre><p id="fafe" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">根据上述内容，我们指定了以下内容:</p><ul class=""><li id="91eb" class="mo mp it lo b lp mj ls mk lv ob lz oc md od mh mt mu mv mw bi translated"><strong class="lo iu">名称:</strong>我们将其命名为“华尔街和今日美国矢量器”</li><li id="223b" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu"> sources </strong>:作为源包含的数据集的 id 和源列(在这种情况下，两者都只有一个名为“text”)</li><li id="4971" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu"> ngram_range </strong>:将被分词的单词集的最小和最大长度</li><li id="2f66" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu">语言</strong>:英语</li><li id="797f" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu"> remove_stop_words </strong>:这样就从源头上消除了停用词</li><li id="0e90" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu"> min_count_limit </strong>:被认为是令牌的最小重复次数(出现一次很少有帮助)</li></ul><p id="f7fc" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在，如果我们转到 OpenBlender 的仪表板，我们可以看到矢量器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/64f86a47766739af159f6c394068d0d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tEuSOIygjUJmrFEQ.png"/></div></div></figure><p id="53e0" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">它生成了 4999 个 n-gram，这些 n-gram 是最多 2 个单词的令牌的<strong class="lo iu">二进制特征</strong>，如果提到了<strong class="lo iu"> n-gram 则为“1”</strong>否则为“0”。</p><h1 id="7d58" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">第三步。准备数据</h1><p id="3716" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">现在<strong class="lo iu">我们希望矢量化数据</strong>在<strong class="lo iu"> 24 小时时滞</strong>内压缩，并与第二天的<strong class="lo iu">苹果股票价格一致。</strong></p><p id="704f" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">你需要添加你的<strong class="lo iu">矢量器的 id </strong>(它是由 API 返回的，或者你可以在 OpenBlender 中得到它。</p><p id="1dae" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><em class="nc">*注:要下载</em> <strong class="lo iu"> <em class="nc">所有的矢量化数据</em> </strong> <em class="nc">你需要支付大约 6 美元升级到 OpenBlender 的“现收现付”。您仍然可以继续处理一小部分数据，从而缩短日期间隔。</em></p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="90a4" class="nt kv it np b gy nu nv l nw nx">action = 'API_getObservationsFromDataset'</span><span id="8e53" class="nt kv it np b gy nz nv l nw nx">interval = 60 * 60 * 24 # One day</span><span id="0914" class="nt kv it np b gy nz nv l nw nx">parameters = { <br/>      'token' : token,<br/>      'id_dataset':'5d4c39d09516290b01c8307b',<br/>      'date_filter':{"start_date":"2017-01-01T06:00:00.000Z",<br/>                     "end_date":"2020-03-29T06:00:00.000Z"},<br/>      'aggregate_in_time_interval' : {<br/>              'time_interval_size' : interval, <br/>              'output' : 'avg', <br/>              'empty_intervals' : 'impute'<br/>      },<br/>      'blends' :<br/>       [{"id_blend" : "<strong class="np iu">5e46c8cf9516297ce1ada712</strong>",<br/>         "blend_class" : "closest_observation", <br/>         "restriction":"None",<br/>         "blend_type":"text_ts",<br/>         "specifications":{"time_interval_size" : interval}<br/>       }],<br/>       'lag_feature' : {'feature' : 'change', 'periods' : [-1]}<br/>}</span><span id="18d7" class="nt kv it np b gy nz nv l nw nx">df = pd.read_json(json.dumps(OpenBlender.call(action, parameters)['sample']), convert_dates=False, convert_axes=False).sort_values('timestamp', ascending=False)<br/>df.reset_index(drop=True, inplace=True)</span></pre><p id="3834" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这是与之前相同的服务调用，但是有一些新的参数:</p><ul class=""><li id="abb5" class="mo mp it lo b lp mj ls mk lv ob lz oc md od mh mt mu mv mw bi translated"><strong class="lo iu">aggregate _ in _ time _ interval</strong>:以 24 小时为间隔平均汇总数据，如果有间隔没有观测值，则进行估算</li><li id="94f8" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu">混合</strong>:按时间加入聚合的新闻 24 小时数据</li><li id="b1b3" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated"><strong class="lo iu"> lag_feature </strong>:我们希望“变化”功能与过去 24 小时内发生的新闻保持一致</li></ul><p id="a3ac" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们来看看最上面的数据:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="d996" class="nt kv it np b gy nu nv l nw nx">print(df.shape)<br/>df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/461bb32748273a65bcb75e45eacaadd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgXZCIGmsLbb_rSVuA3WTQ.png"/></div></div></figure><p id="6fdb" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">我们有<strong class="lo iu"> 1122 </strong>观察和<strong class="lo iu"> 4908 </strong>特征。其中大部分是来自矢量器的<strong class="lo iu"> n-grams </strong>，我们也有我们原始的<strong class="lo iu">苹果股票</strong>数据集。</p><p id="3428" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">“<strong class="lo iu"> lag-1_change </strong>”简单地说就是<strong class="lo iu">将</strong>“change”值与“<strong class="lo iu">前一天的数据</strong>对齐，这正是我们所需要的。最后一个观察是 NaN，因为那是“明天”将要发生的事情。</p><p id="6513" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在让<strong class="lo iu">按照之前的定义创建我们的目标特征</strong>:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="b2ce" class="nt kv it np b gy nu nv l nw nx"># Where ‘change’ <strong class="np iu">decreased</strong> more than 0.5%<br/>df['negative_poc'] = [1 if val &lt; 0.5 else 0 for val in df['lag-1_change']]</span><span id="30d0" class="nt kv it np b gy nz nv l nw nx"># Where ‘change’ <strong class="np iu">increased</strong> more than 0.5%<br/>df['positive_poc'] = [1 if val &gt; 0.5 else 0 for val in df['lag-1_change']]</span><span id="5af1" class="nt kv it np b gy nz nv l nw nx">df[['lag-1_change', 'positive_poc', 'negative_poc']].head()</span></pre><h1 id="e435" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">步骤 3.5 应用 ML 并运行模拟</h1><p id="809c" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们想要<strong class="lo iu"> 2 个模型</strong>，一个将预测价格是否会<strong class="lo iu">上涨</strong>(高于 0.5%)，一个将预测等量的下跌，然后<strong class="lo iu">将两者结合到交易策略</strong>。</p><p id="28d8" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">此外，我们希望通过时间来训练和测试，以便模型学习相关信息。</p><p id="e8cf" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">最后，我们希望<strong class="lo iu">模拟</strong>，如果我们以<strong class="lo iu">1000 美元开始，</strong>我们会以<strong class="lo iu"> </strong>结束。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="860f" class="nt kv it np b gy nu nv l nw nx"># First we create separeate dataframes for positive and negative</span><span id="3d7a" class="nt kv it np b gy nz nv l nw nx">df_positive = df.select_dtypes(['number']).iloc[::-1]<br/>for rem in ['negative_poc']:<br/>    df_positive = df_positive.loc[:, df_positive.columns != rem]</span><span id="4746" class="nt kv it np b gy nz nv l nw nx">df_negative = df.select_dtypes(['number']).iloc[::-1]<br/>for rem in ['positive_poc']:<br/>    df_negative = df_negative.loc[:, df_negative.columns != rem]</span></pre><p id="fc3c" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">给定一个数据帧和一个目标，下一个函数将返回应用 ML 的<strong class="lo iu">结果和一个带有预测与结果的数据帧。</strong></p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="077e" class="nt kv it np b gy nu nv l nw nx">def getMetricsFromModel(target, df):<br/>    # Create train/test sets<br/>    X = df.loc[:, df.columns != target]<br/>    X = X.loc[:, X.columns != 'lag-1_change'].values<br/>    y = df.loc[:,[target]].values<br/>    <br/>    # Create X and y.<br/>    div = int(round(len(X) * 0.89))<br/>    <br/>    real_values = df[div:].loc[:,['lag-1_change']].values<br/>    <br/>    X_train = X[:div]<br/>    y_train = y[:div]</span><span id="eeba" class="nt kv it np b gy nz nv l nw nx">    X_test = X[div:]<br/>    y_test = y[div:]<br/>    <br/>    # Perform ML<br/>    rf = RandomForestRegressor(n_estimators = 1000, random_state = 1)<br/>    rf.fit(X_train, y_train)<br/>    y_pred = rf.predict(X_test)<br/>    <br/>    # Get Metrics<br/>    print("AUC score:")<br/>    auc = roc_auc_score(y_test, y_pred)<br/>    print(auc)<br/>    print('---')</span><span id="ae32" class="nt kv it np b gy nz nv l nw nx">    preds = [1 if val &gt; 0.6 else 0 for val in y_pred]<br/>    print('Confusion Matrix:')<br/>    conf_matrix = metrics.confusion_matrix(y_test, preds)<br/>    print(metrics.confusion_matrix(y_test, preds))<br/>    print('---')<br/>    <br/>    print('Acurracy:')<br/>    acc = accuracy_score(y_test, preds)<br/>    print(acc)<br/>    print('---')<br/>    <br/>    df_compare = pd.DataFrame({'real_values' : real_values.ravel(), 'y_test' : y_test.ravel(), 'preds' : y_pred})<br/>    <br/>    return auc, conf_matrix, acc, df_compare</span></pre><p id="3af6" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">我们希望通过 300 次观察和<strong class="lo iu">预测在接下来的 50 个</strong>跳跃日进行时间<strong class="lo iu">迭代学习，因此我们<strong class="lo iu">在每次跳跃</strong>时进行再训练。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/18b8329150edc48c7f258c40d5075d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/0*xnQ5d_riTdP_Gfaq.png"/></div></figure><p id="1662" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">当我们这样做时，我们希望<strong class="lo iu">从我们的两个模型中收集建议</strong>(负面/正面)。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="7073" class="nt kv it np b gy nu nv l nw nx">df_compare_acc = None<br/>for i in range(0, df_positive.shape[0] - 450, 50):<br/>    print(i)<br/>    print(i + 450)<br/>    print('-')<br/>    auc, conf_matrix, acc, df_compare_p = getMetricsFromModel('positive_poc', df_positive[i : i + 450])<br/>    auc, conf_matrix, acc, df_compare_n = getMetricsFromModel('negative_poc', df_negative[i : i + 450])<br/>    df_compare = df_compare_p[['y_test', 'real_values']]<br/>    df_compare.rename(columns={'y_test':'price_rised_5'}, inplace=True)<br/>    df_compare['F_p'] = df_compare_p['preds']<br/>    df_compare['price_dropped_5'] = df_compare_n['y_test']<br/>    df_compare['F_n'] = df_compare_n['preds']<br/>    df_compare<br/>    if df_compare_acc is None:<br/>        df_compare_acc = df_compare<br/>    else:<br/>        df_compare_acc = pd.concat([df_compare_acc, df_compare], ignore_index=True)</span></pre><p id="2e98" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们来看看结果。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="121f" class="nt kv it np b gy nu nv l nw nx">df_compare_acc</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/08b9b4624a4ab96529ac0255c36eddb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qyUX0SE4dDLqPF5Le9YG_Q.png"/></div></div></figure><blockquote class="ol om on"><p id="3e65" class="lm ln nc lo b lp mj ju lr ls mk jx lu oo ml lx ly op mm mb mc oq mn mf mg mh im bi translated"><strong class="lo iu">实际值</strong> =价格的实际百分比变化</p><p id="748d" class="lm ln nc lo b lp mj ju lr ls mk jx lu oo ml lx ly op mm mb mc oq mn mf mg mh im bi translated"><strong class="lo iu"> price_rised_5 </strong> =如果变化&gt; 0.5</p><p id="b872" class="lm ln nc lo b lp mj ju lr ls mk jx lu oo ml lx ly op mm mb mc oq mn mf mg mh im bi translated">F_p  =上升区间(0，1)内的预测</p><p id="0c58" class="lm ln nc lo b lp mj ju lr ls mk jx lu oo ml lx ly op mm mb mc oq mn mf mg mh im bi translated"><strong class="lo iu">价格 _ 下降 _5 </strong> =如果变化&gt; -0.5</p><p id="8582" class="lm ln nc lo b lp mj ju lr ls mk jx lu oo ml lx ly op mm mb mc oq mn mf mg mh im bi translated"><strong class="lo iu"> F_n </strong> =下降范围(0，1)内的预测</p></blockquote><p id="d2df" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">我们的组合模型很简单，如果<strong class="lo iu">一个模型推荐，另一个不反对</strong>，我们买入/做空:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/8e4a99adf87308e016a583114581547e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4aiDAR8z008jRUooi50nQ.png"/></div></div></figure><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="1d9a" class="nt kv it np b gy nu nv l nw nx"># This function will run a simulation on all the tested data <br/># given an invested 'starting_sum' and will return its<br/># trayectory.</span><span id="f9d2" class="nt kv it np b gy nz nv l nw nx">def runSimulation(include_pos, includle_neg, starting_sum): <br/>    sum_lst = []<br/>    actual_sum = starting_sum<br/>    for index, row in df_compare_acc.iterrows():</span><span id="4b56" class="nt kv it np b gy nz nv l nw nx">        if row['F_p'] &gt; 0.5 and row['F_n'] &lt; 0.5 and include_pos:<br/>            actual_sum = actual_sum + (actual_sum * (row['real_values'] / 100))</span><span id="f859" class="nt kv it np b gy nz nv l nw nx">        if row['F_n'] &gt; 0.5 and row['F_p'] &lt; 0.5 and includle_neg:<br/>            actual_sum = actual_sum - (actual_sum * (row['real_values'] / 100))</span><span id="e78b" class="nt kv it np b gy nz nv l nw nx">        sum_lst.append(actual_sum)<br/>    return sum_lst</span></pre><p id="c01c" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们首先运行模型<strong class="lo iu">，只有“积极的”预测</strong>。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="777a" class="nt kv it np b gy nu nv l nw nx">sum_lst = runSimulation(<strong class="np iu">True</strong>, <strong class="np iu">False</strong>, 1000)<br/>df_compare_acc['actual_sum'] = sum_lst<br/>print(sum_lst[len(sum_lst)-1])<br/>df_compare_acc.plot(y = ['actual_sum'])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/6124adc6b5c54560da8286c7a40cb9e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Y-tE-2J78gFZBekm6LNyg.png"/></div></div></figure><p id="2ed8" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">在当前的 COVID/oil/recession 形势下，它绝对暴跌，失去了近一半的收益。</p><p id="5a07" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在让我们只使用<strong class="lo iu">负面预测</strong>来尝试一下。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="b3d7" class="nt kv it np b gy nu nv l nw nx">sum_lst = runSimulation(<strong class="np iu">False</strong>, <strong class="np iu">True</strong>, 1000)<br/>df_compare_acc['actual_sum'] = sum_lst<br/>print(sum_lst[len(sum_lst)-1])<br/>df_compare_acc.plot(y = ['actual_sum'])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/80434487bac6ad7124dc2dc1ece30ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YarChmndg4zu13XY5kMH_A.png"/></div></div></figure><p id="726a" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">因此，它的整体表现不如正面，但它<strong class="lo iu">现在真的表现很好</strong>在 covid 时间。</p><p id="8396" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在，让我们一起运行。</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="8988" class="nt kv it np b gy nu nv l nw nx">sum_lst = runSimulation(<strong class="np iu">True</strong>, <strong class="np iu">True</strong>, 1000)<br/>df_compare_acc['actual_sum'] = sum_lst<br/>print(sum_lst[len(sum_lst)-1])<br/>df_compare_acc.plot(y = ['actual_sum'])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/bbad5e281acf2d87c561ddd6b96f5547.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uIJTl2IG-GoBFeDnJ5_9sw.png"/></div></div></figure><p id="6011" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这是<strong class="lo iu">迄今为止表现最好的模型</strong>，以 574.4%的回报率结束了 3 年期，但<strong class="lo iu">这些天仍然非常不稳定</strong>。</p><p id="a87b" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">至此，自 1 月 20 日结束以来，其<strong class="lo iu">损失了近 25% </strong>，而苹果价格<strong class="lo iu">仅暴跌 20% </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/9a65b8ec361a86d1f03519c272b72ced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWFMMrtbxJE5CvVPIX0bow.png"/></div></div></figure><p id="e58f" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">需要做的是<strong class="lo iu">根据情况优先考虑</strong>正面或负面建议<strong class="lo iu">。</strong></p><p id="671a" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">几天后，我将发表一篇<strong class="lo iu">后续文章</strong>，介绍一个模型的结果，该模型的<strong class="lo iu">根据<strong class="lo iu">增加或减少</strong>多长时间来最大化回报，在正/负</strong>建议之间切换。</p></div></div>    
</body>
</html>