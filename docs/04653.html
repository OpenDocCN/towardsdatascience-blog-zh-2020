<html>
<head>
<title>Breaking Down Geocoding in R: A Complete Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分解R中的地理编码:完全指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/breaking-down-geocoding-in-r-a-complete-guide-1d0f8acd0d4b?source=collection_archive---------4-----------------------#2020-04-25">https://towardsdatascience.com/breaking-down-geocoding-in-r-a-complete-guide-1d0f8acd0d4b?source=collection_archive---------4-----------------------#2020-04-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="6f94" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">可视化|地图</h2><div class=""/><div class=""><h2 id="5c13" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何使用API找到您感兴趣的地方，并在地图上可视化其位置</h2></div><p id="7dfc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果您想知道如何构建类似于您在应用程序中经常看到的地图，这可能是一个好的起点。在本教程中，我们将介绍如何根据描述或坐标找到一个地方，以及如何根据这些信息构建一个简单的地图。</p><p id="f51d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请注意，本文假设读者对R语言有一定的了解:数据结构、操作符、条件语句、函数等等。本教程的所有代码都可以在<a class="ae ln" href="https://github.com/s-titoo/Geocoding-in-R" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><p id="b81d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">所以，让我们开始吧！</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lv"><img src="../Images/46b0bbb0079b537d4c9343c310cbe120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tmowlorlys3f3NYl"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">照片由<a class="ae ln" href="https://unsplash.com/@julensan09?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Julentto摄影</a>在<a class="ae ln" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h1 id="736f" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated"><strong class="ak">什么是地理编码？</strong></h1><blockquote class="nd ne nf"><p id="ca74" class="kr ks ng kt b ku kv kd kw kx ky kg kz nh lb lc ld ni lf lg lh nj lj lk ll lm im bi translated"><strong class="kt jd">地理编码</strong>是将一个地方的地址或名称转换成其坐标的过程。<strong class="kt jd">反向地理编码</strong>执行相反的任务:根据一个地方的坐标返回该地方的地址或描述。</p></blockquote><p id="8e21" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">仅此而已，就这么简单。因此，通过使用地理编码，您必须能够说在法国巴黎的<em class="ng">埃菲尔铁塔</em>可以在(48.858568，2.294513)纬度、经度坐标找到。在你的地图应用上输入(41.403770，2.174379)，你将到达西班牙巴塞罗那的<em class="ng">圣家族教堂</em>罗马天主教堂。你可以自己核实——只需在谷歌地图上输入这些信息。</p><h1 id="f2f0" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">有哪些地理编码工具可用？</h1><p id="c0d0" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">当谈到在线免费地理编码工具时，其中一个选项是专门的网站。比如上面提到的<a class="ae ln" href="https://www.google.com/maps" rel="noopener ugc nofollow" target="_blank">谷歌地图</a>。稍微搜索一下，就能找到其他的。</p><p id="21b8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如果你只需要找到几个地址，所有这些都是非常好的工具。但是想象一下有几百个呢？那成千上万呢？这项任务很快变得相当令人头痛。</p><p id="bfb0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于批量请求，API是更合适的选择。而这里最明显的选择大概就是<a class="ae ln" href="https://developers.google.com/maps/documentation" rel="noopener ugc nofollow" target="_blank">谷歌地图API </a> <strong class="kt jd"> </strong>。为了能够使用谷歌服务，你需要在谷歌云平台上创建帐户，并获得你的API密钥。谷歌在他们的网站上提供了关于如何做的详细的<a class="ae ln" href="https://developers.google.com/maps/gmp-get-started" rel="noopener ugc nofollow" target="_blank">说明</a>。</p><p id="718a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">另一个选择是使用来自<a class="ae ln" href="http://www.openstreetmap.org" rel="noopener ugc nofollow" target="_blank"> OpenStreetMap </a>的一个名为<a class="ae ln" href="http://nominatim.org/release-docs/latest/api/Overview/" rel="noopener ugc nofollow" target="_blank">nomim</a>的公共API。OpenStreetMap是一个合作项目，其目标是为公众创建一个免费的地图服务。正如其网站所说:</p><blockquote class="nd ne nf"><p id="ebd2" class="kr ks ng kt b ku kv kd kw kx ky kg kz nh lb lc ld ni lf lg lh nj lj lk ll lm im bi translated">OpenStreetMap是由一个地图绘制者社区构建的，该社区贡献并维护世界各地的道路、小径、咖啡馆、火车站等更多信息。</p></blockquote><p id="7441" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">基本上，nomist是一个在OpenStreetMap网站上进行搜索的工具。与谷歌地图不同，Nominatim不需要你注册任何账户，也不需要你获得一个API密匙。但如果你想在应用程序中使用它的服务，你需要提供一个电子邮件地址，这样你的应用程序的活动就可以被跟踪，并在需要时受到限制——OSM服务器的能力是有限的。</p><h1 id="ef7f" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">法律考虑</h1><p id="f349" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">你可能会奇怪，如果Google提供了类似的功能，为什么我首先要告诉你关于Nominatim API的事情。你的第一个猜测可能是成本——与OpenStreetMap基金会不同，谷歌是一家私人公司，对其服务收费。这是事实，但只是部分事实。</p><p id="fadb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，如果你现在在<a class="ae ln" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>上注册，你将获得12个月的免费试用，你的账户上有300美元的信用来了解它的功能。其次，即使在那之后，谷歌也免费提供一些最常用服务的有限访问权限，作为<a class="ae ln" href="https://cloud.google.com/free/docs/gcp-free-tier" rel="noopener ugc nofollow" target="_blank">永远免费<strong class="kt jd"> </strong> </a>套餐的一部分。如果你的唯一目的是学习，那么这个包里的限制就足够了。要了解更多关于谷歌地图API定价的信息，请访问谷歌的帮助页面。</p><p id="14ba" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">那么，你会问我什么问题？谷歌地图平台<a class="ae ln" href="https://cloud.google.com/maps-platform/terms" rel="noopener ugc nofollow" target="_blank">服务条款</a>，其中声明:</p><blockquote class="nd ne nf"><p id="d1b5" class="kr ks ng kt b ku kv kd kw kx ky kg kz nh lb lc ld ni lf lg lh nj lj lk ll lm im bi translated">3.2.4对滥用服务的限制。<br/> <strong class="kt jd">【一】</strong> <strong class="kt jd">无刮。</strong>客户不得提取、导出或以其他方式抓取谷歌地图内容用于服务之外。<br/> <strong class="kt jd"> (c)不从谷歌地图内容创建内容。</strong><br/><strong class="kt jd">【e】非谷歌地图不使用。</strong></p></blockquote><p id="c4dc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我不是法律界人士，不知道谷歌如何对待非商业目的使用其服务。但是我没有在这些服务条款中看到任何条款说明上述限制只适用于商业用途。所以，在你决定在你的应用中使用谷歌地图API之前，请注意这些限制。</p><p id="2e25" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">与谷歌地图不同，OpenStreetMap数据是在开放数据共享开放数据库许可证(ODbL)下获得许可的。正如作者自己所说，下面是ODbL 1.0的<a class="ae ln" href="https://opendatacommons.org/licenses/odbl/summary/index.html" rel="noopener ugc nofollow" target="_blank">人类可读摘要</a> <strong class="kt jd"> </strong>:</p><blockquote class="nd ne nf"><p id="28c4" class="kr ks ng kt b ku kv kd kw kx ky kg kz nh lb lc ld ni lf lg lh nj lj lk ll lm im bi translated">您可以自由:<br/> <strong class="kt jd"> *分享:</strong>复制、分发和使用数据库。<br/> * <strong class="kt jd">创作:</strong>从数据库中产生作品。<br/> * <strong class="kt jd">适应:</strong>对数据库进行修改、改造和建设。</p><p id="3416" class="kr ks ng kt b ku kv kd kw kx ky kg kz nh lb lc ld ni lf lg lh nj lj lk ll lm im bi translated">只要你:<br/> * <strong class="kt jd">属性:</strong>给原数据库做参考。<br/>*<strong class="kt jd">Share-like:</strong>在相同的许可下分发由原数据库改编的数据库。<br/> * <strong class="kt jd">保持开放:</strong>向公众开放对适配数据库的访问。</p></blockquote><p id="600a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一个<strong class="kt jd"> </strong> <a class="ae ln" href="https://www.opendatacommons.org/licenses/odbl/1.0/" rel="noopener ugc nofollow" target="_blank">全长许可</a>，如果你想看的话，可以在开放数据共享网站上找到。</p><p id="a655" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">说了这么多，现在让我们继续编码！</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi np"><img src="../Images/63c17a37916a784f66625411ebfae585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ola85QkIpDcmmmaq"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">照片由<a class="ae ln" href="https://unsplash.com/@ffstop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">福蒂斯·福托普洛斯</a>在<a class="ae ln" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><h1 id="acd1" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">安装软件包</h1><p id="2f18" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">让我们先安装并加载本教程中用到的所有包，所以以后不用担心。每个包的用途将在文章的相应部分描述。另外请注意，我们使用的是适用于Windows的软件版本R 3.6.2。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="5524" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># install packages</em></strong><br/>install.packages("ggmap")<br/>install.packages("tmaptools")<br/>install.packages("RCurl")<br/>install.packages("jsonlite")<br/>install.packages("tidyverse")<br/>install.packages("leaflet")</span><span id="57a4" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># load packages</em></strong><br/>library(ggmap)<br/>library(tmaptools)<br/>library(RCurl)<br/>library(jsonlite)<br/>library(tidyverse)<br/>library(leaflet)</span></pre><h1 id="3679" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用R包进行地理编码</h1><p id="a9ee" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">R社区创建了几个包，可以用来访问Google Maps和nomist API。让我们看看它们。</p><h2 id="c4ba" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">包ggmap</h2><p id="d105" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">第一个包叫做<a class="ae ln" href="https://cran.r-project.org/web/packages/ggmap/ggmap.pdf" rel="noopener ugc nofollow" target="_blank"> ggmap </a>，它允许你连接到谷歌地图API。在开始使用这个包之前，您需要向R提供您的API密钥。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="673b" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># replace "api_key" with your API key<br/></em></strong>register_google(key = api_key)</span></pre><p id="0e5e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们在12家伦敦酒吧的样本上使用这个包中的<code class="fe ol om on nr b">geocode</code>函数来演示它是如何工作的。该函数接受以下任一参数作为其<code class="fe ol om on nr b">output</code>参数:</p><ul class=""><li id="6fe6" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><em class="ng"> latlon </em> —经纬度；</li><li id="1606" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng"> latlona </em> —以上所有加地址；</li><li id="fff9" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng">更多</em> —以上所有加地点的类型和地理界限；</li><li id="3009" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng">全部</em> —以上全部加上一些附加信息。</li></ul><p id="bbf7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">每个选项对应于生成的信息类型。一般来说，我们不需要比<em class="ng">更多的</em>选项提供的信息。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行ggmap地理编码功能</p></figure><p id="8930" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们看看我们的结果。正如你所看到的，我们有一个酒吧的名字，它的坐标，地点的类型，结果的精度(<em class="ng"> rooftop </em>意味着谷歌能够找到一个具体的建筑)和它的地址。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/e2e344430d70025eab326af21084df54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l-hQkx3IOrR8nqaBd0HCzQ.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行ggmap地理编码功能的结果</p></figure><p id="58f4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，让我们用刚刚找到的坐标对它们所属的地方进行反向地理编码。</p><p id="ef77" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><code class="fe ol om on nr b">revgeocode</code>函数允许这样做。它需要两个参数:<code class="fe ol om on nr b">location</code> —经度/纬度的数值向量和<code class="fe ol om on nr b">output</code> —或者<em class="ng">地址</em>或者<em class="ng">全部</em>。选项<em class="ng"> all </em> for <code class="fe ol om on nr b">output</code>返回的信息比我们需要的多得多，所以让我们坚持使用<em class="ng">地址</em>。</p><p id="17f2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这次我们将把结果存储在一个列表中，而不是数据框中。这个列表的每个元素将包含另一个列表，其中包含关于酒吧的名称、坐标和地址的信息。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行ggmap反向地理编码功能</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/580f24c813645981310bf8ee1fc7a317.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*3FCMtSvIvcnnyPs2hnvxGg.jpeg"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行ggmap反向地理编码功能的结果</p></figure><p id="6973" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">ggmap到此为止。现在让我们进入下一个项目。</p><h2 id="a2c6" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">打包tmaptools</h2><p id="87f0" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">tmaptools是一个包，它提供了一套读取和处理空间数据的工具。它促进了另一个名为<a class="ae ln" href="https://cran.r-project.org/web/packages/tmap/tmap.pdf" rel="noopener ugc nofollow" target="_blank"> tmap </a>的R包的功能，该包是为可视化专题地图而构建的。许多tmaptools函数依赖于Nominatim API。</p><p id="1c25" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，让我们试着从tmaptools获得与使用ggmap提取的信息相同的信息。我不得不稍微修改一些搜索请求，因为Nominatim无法找到基于它的位置。尽管我尽了最大努力，还是找不到其中一家酒吧——荣耀酒吧。因此，请注意，不同的服务提供商的数据质量和完整性可能会有所不同。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行tmaptools地理编码功能</p></figure><p id="b03f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们在最终表中只包括坐标和完整地址。这是它的样子。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/545b7b46f7a2cedffac66af268ff0c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_h1I3HpCxQWQmzCXb9aFw.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行tmaptools地理编码函数的结果</p></figure><p id="0be2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，是反向地理编码的时候了。在我们的输出中，我们将显示与来自ggmap的反向地理编码请求完全相同的信息。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行tmaptools反向地理编码功能</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pg"><img src="../Images/d2552c3e1960fe5015e20705d8bb2d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RbORcPZasB2hfEvjf8HLmw.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行tmaptools反向地理编码功能的结果</p></figure><p id="01aa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这是我们讨论R地理编码包的最后一段代码。在这里你可以读完这篇文章，然后自己练习上面描述的一些技巧。除非…除非你想了解更多！如果是这样，那我们继续！</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ph"><img src="../Images/df1586b65f6ae2a22a197e093cbb965f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_0awe9U-_G3Teygs"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">由<a class="ae ln" href="https://unsplash.com/@martinadams?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马丁·亚当斯</a>在<a class="ae ln" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="5dac" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用API进行地理编码</h1><p id="5863" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">使用包是一种非常方便快捷的完成事情的方式。对于您想要完成的大多数任务，这些包提供的功能已经足够了。然而，如果你需要一些额外的东西，或者你对其他API函数感兴趣，或者你只是想学习如何使用API，你需要去Google/nomist帮助页面做一些阅读。或者在网上搜索一些像这样的视频/教程，提供简短的总结。或者更好——双管齐下。</p><h1 id="d0ec" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">谷歌地图API</h1><p id="b868" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">看了ggmap包之后，现在让我们尝试直接使用Google Maps API来获取这个地方的位置、地址以及它的电话号码和网站。为了完成这个任务，我们需要<a class="ae ln" href="https://developers.google.com/maps/documentation/geocoding/start" rel="noopener ugc nofollow" target="_blank">地理编码API </a>和<a class="ae ln" href="https://developers.google.com/places/web-service/intro" rel="noopener ugc nofollow" target="_blank">位置API </a>。</p><h2 id="8520" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">地理编码API</h2><p id="74f3" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">地理编码API是一种提供地址和地点的地理编码和反向地理编码功能的服务。您可以通过web浏览器发送HTTP请求来访问地理编码API，并获得JSON或XML格式的响应。虽然，在我们的例子中，我们将从r。</p><p id="557a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">地理编码API请求采用以下格式。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="a037" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># format</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/geocode/outputFormat?parameters" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/geocode/outputFormat?parameters</a></span><span id="fea9" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># geocoding example</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/geocode/json?address=The+Churchill+Arms,+Notting+Hill&amp;key=YOUR_API_KEY" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/geocode/json?address=The+Churchill+Arms,+Notting+Hill&amp;key=YOUR_API_KEY</a></span><span id="5ec5" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># reverse geocoding example</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/geocode/json?latlng=51.5069117,-0.194801&amp;key=YOUR_API_KEY" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/geocode/json?latlng=51.5069117,-0.194801&amp;key=YOUR_API_KEY</a></span></pre><p id="1d0f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">因此，您发送的web请求由几个部分组成API url后跟<code class="fe ol om on nr b">outputFormat</code> (json或xml)和列表<code class="fe ol om on nr b">parameters</code>。<code class="fe ol om on nr b">outputFormat</code>和<code class="fe ol om on nr b">parameters</code>之间隔着一个问号(？)和<code class="fe ol om on nr b">parameters</code>本身被一个&amp;符号(&amp;)彼此分开。</p><p id="1c97" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请求所需的参数包括:</p><ul class=""><li id="f985" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated">对于地理编码:<code class="fe ol om on nr b">address</code> —地址或地名形式的搜索查询和<code class="fe ol om on nr b">key</code> — API关键字；</li><li id="c243" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">对于反向地理编码:<code class="fe ol om on nr b">latlng</code> —您搜索的地点的纬度和经度，以及<code class="fe ol om on nr b">key</code> — API关键字。</li></ul><p id="d772" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们不会在查询中使用任何可选参数。</p><p id="ab04" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">你可以在这里和这里阅读更多关于如何构造API请求<a class="ae ln" href="https://developers.google.com/maps/documentation/geocoding/intro#GeocodingRequests" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="982b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">值得一提的是，如果你正在构建自己的应用程序，需要实时访问谷歌地图服务，你可以检查谷歌客户端(<a class="ae ln" href="https://developers.google.com/maps/documentation/javascript/geocoding" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>)或服务器端(<a class="ae ln" href="https://developers.google.com/maps/documentation/geocoding/client-library" rel="noopener ugc nofollow" target="_blank"> Java，Python，Go，Node.js </a> ) API。</p><h2 id="ee14" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">地点API</h2><p id="5bb1" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">如果您不想只局限于地点的地址和坐标，您可以使用Places API。例如，要查找某个地方的电话号码和网址，我们需要使用<a class="ae ln" href="https://developers.google.com/places/web-service/search" rel="noopener ugc nofollow" target="_blank">地点搜索</a> <strong class="kt jd"> </strong>来获取<a class="ae ln" href="https://developers.google.com/places/web-service/place-id" rel="noopener ugc nofollow" target="_blank">地点ID </a>，并在以后使用它从<a class="ae ln" href="https://developers.google.com/places/web-service/details" rel="noopener ugc nofollow" target="_blank">地点详细信息</a>中检索该信息。</p><p id="8990" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在进行API调用时，确保提供您想要提取的<code class="fe ol om on nr b">fields</code>的列表。否则，谷歌将发送所有这些邮件，并向您收取相应费用。在我们的情况下，这并不重要，因为我们不会超过免费限额，但是如果您计划 <strong class="kt jd">对大量请求使用API，您可能会因此而被收费</strong>。</p><p id="5f1e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于Place Search/Place Details API调用，您还需要提供<code class="fe ol om on nr b">outputFormat</code> (json或xml)，后跟一个列表<code class="fe ol om on nr b">parameters</code>。</p><p id="12ba" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于地点搜索，所需的参数包括:<code class="fe ol om on nr b">input</code> —姓名、地址或电话号码(坐标不起作用)；<code class="fe ol om on nr b">inputtype</code> — <em class="ng">文本查询</em>或<em class="ng">电话号码</em>；<code class="fe ol om on nr b">key</code> — API键。</p><p id="80f7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于地点细节，需要的参数是:<code class="fe ol om on nr b">place_id</code> —可以通过使用地点搜索找到；<code class="fe ol om on nr b">key</code> — API键。</p><p id="84f3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于地点搜索和地点详细信息，我们将使用可选参数<code class="fe ol om on nr b">fields</code>——我们希望Google返回的附加信息的逗号分隔列表。您可以在前面提供的相应帮助页面上阅读有关可能选项的更多信息。但是在我们的例子中，我们只需要来自地点搜索的字段<em class="ng"> place_id </em>和来自地点详细信息的<em class="ng"> formatted_phone_number </em>加上<em class="ng">网站</em>。<strong class="kt jd">请记得阅读有关账单的信息！</strong></p><p id="60e4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">API调用的格式如下所示。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="2c3c" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># PLACE SEARCH</em></strong></span><span id="1b24" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># format</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/place/findplacefromtext/outputFormat?parameters" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/findplacefromtext/outputFormat?parameters</a></span><span id="d072" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># example</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/place/findplacefromtext/json?input=The+Churchill+Arms,+Notting+Hill&amp;inputtype=textquery&amp;fields=photos,formatted_address,name,place_id&amp;key=YOUR_API_KEY" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/findplacefromtext/json?input=The+Churchill+Arms,+Notting+Hill&amp;inputtype=textquery&amp;fields=photos,formatted_address,name,place_id&amp;key=YOUR_API_KEY</a></span><span id="fedc" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># PLACE DETAILS</em></strong></span><span id="b727" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># format</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/place/details/outputFormat?parameters" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/details/outputFormat?parameters</a></span><span id="bd6b" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># example</em></strong><br/><a class="ae ln" href="https://maps.googleapis.com/maps/api/place/details/json?place_id=ChIJGTDVMfoPdkgROs9QO9Kgmjc&amp;fields=formatted_phone_number,website&amp;key=YOUR_API_KEY" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/details/json?place_id=ChIJGTDVMfoPdkgROs9QO9Kgmjc&amp;fields=formatted_phone_number,website&amp;key=YOUR_API_KEY</a></span></pre><p id="f9f5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">同样，如果您考虑构建一个实际的应用程序，那么值得看看用于服务器端应用程序的<a class="ae ln" href="https://developers.google.com/places/web-service/client-library" rel="noopener ugc nofollow" target="_blank"> Java/Python/Go/Node.js </a>客户端或用于Android的<a class="ae ln" href="https://developers.google.com/places/android-sdk/intro" rel="noopener ugc nofollow" target="_blank">Places SDK</a>、用于iOS的<a class="ae ln" href="https://developers.google.com/places/ios-sdk/intro" rel="noopener ugc nofollow" target="_blank">Places SDK</a>和用于客户端应用程序的<a class="ae ln" href="https://developers.google.com/maps/documentation/javascript/places" rel="noopener ugc nofollow" target="_blank"> Places Library、Maps JavaScript API </a>。</p><h1 id="5957" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用谷歌地图API进行地理编码</h1><p id="dbca" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">说了这么多，现在让我们来编写代码本身。</p><p id="1ea0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们的代码由七个函数组成:</p><ul class=""><li id="4f8a" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated">一个主要功能；</li><li id="63f6" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">用于生成API调用的三个函数；</li><li id="7935" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">从JSON输出中提取数据的三个函数。</li></ul><p id="e3c3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们的主函数有三个参数:</p><ul class=""><li id="343c" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><code class="fe ol om on nr b">search_query</code> —搜索请求(地址或地点)；</li><li id="8a91" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">fields</code> —提取信息(<em class="ng">坐标</em>，<em class="ng">地址</em>，<em class="ng">联系人</em>或<em class="ng">全部</em>)；</li><li id="0266" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">key </code> —谷歌地图的API键。</li></ul><p id="8fa5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第一个和最后一个是必需的，第二个是可选的，默认<em class="ng">坐标</em>。</p><p id="6bf4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这些参数可以是以下类型:</p><ul class=""><li id="30dd" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><code class="fe ol om on nr b">search_query</code> —字符串、字符向量、字符列表、一维矩阵或带有字符串数据的数据帧；</li><li id="8b3f" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">fields</code> —字符串、字符向量、字符列表；</li><li id="909e" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">key</code> —弦。</li></ul><p id="17fb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">根据<code class="fe ol om on nr b">fields</code>的值，该函数返回一个数据帧，其中包含:</p><ul class=""><li id="3d28" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><em class="ng">坐标</em> —经纬度；</li><li id="4d1d" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng">地址</em> —完整的地址和城市；</li><li id="1b3e" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng">联系人</em> —电话号码和网址；</li><li id="9db1" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><em class="ng">全部</em> —以上全部。</li></ul><p id="9ac7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们来详细看看这个函数的每个组件。</p><h2 id="32b8" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">正在生成API调用</h2><p id="e463" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">一旦熟悉了我前面提供的信息，API调用函数就非常简单了。</p><p id="c133" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">它分三步工作:</p><p id="a04a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">1.将搜索查询转换为列表。<br/> 2。对搜索查询进行百分比编码。<br/> 3。构造API调用字符串。</p><p id="1e1d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第一步是必需的，因为处理公共数据结构(在我们的例子中是一个列表)总是更容易。对于百分比编码，我们使用<a class="ae ln" href="https://cran.r-project.org/web/packages/RCurl/RCurl.pdf" rel="noopener ugc nofollow" target="_blank"> RCurl </a>包中的<code class="fe ol om on nr b">URLencode</code>函数。如果你不知道它是什么，访问这个<a class="ae ln" href="https://developers.google.com/maps/documentation/geocoding/web-service-best-practices#BuildingURLs" rel="noopener ugc nofollow" target="_blank">页面</a>有详细的解释。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">谷歌地图API调用函数</p></figure><h2 id="5f95" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">从JSON中提取数据</h2><p id="aadf" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">Google可以返回两种格式的数据——JSON和XML。在我们的例子中，我们使用JSON输出。这个输出需要转换成R对象，所以我们可以很容易地操作它包含的数据。一旦完成，我们的任务就是从格式化的列表中挑选我们需要的元素。</p><p id="4e52" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">原始JSON输出及其格式化版本如下所示。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Google Maps API的原始JSON输出</p></figure><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Google Maps API的格式化JSON输出</p></figure><p id="11dc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">那么，我们的函数是如何工作的呢？首先，使用<a class="ae ln" href="https://cran.r-project.org/web/packages/jsonlite/jsonlite.pdf" rel="noopener ugc nofollow" target="_blank"> jsonlite </a>包中的<code class="fe ol om on nr b">fromJSON</code>函数将JSON输出转换成R列表。之后，我们的函数检查API调用是否成功(<code class="fe ol om on nr b">status = "OK"</code>)，如果成功，它从列表中只提取我们需要的元素来构建最终的数据帧。检索一个<em class="ng">城市</em>名称有点棘手，因为首先我们需要找出它存储在<code class="fe ol om on nr b">address_components</code>中的序列号。对于<em class="ng">联系人</em>来说，将所有<code class="fe ol om on nr b">NULL</code>替换为<code class="fe ol om on nr b">NA</code>也很重要，如果谷歌没有关于电话号码或网站的信息，就会出现所有的<code class="fe ol om on nr b">NULL</code>，这样我们在生成最终数据帧时就不会出错。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">将JSON输出转换成R对象的函数</p></figure><h2 id="7004" class="nv mm it bd mn ob oc dn mr od oe dp mv la of og mx le oh oi mz li oj ok nb iz bi translated">主要功能</h2><p id="8f8c" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">我们已经提供了我们的主要功能的描述。现在让我们解释一下它是如何工作的。</p><p id="84c9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，该函数从谷歌地图获取坐标和地址。它检查用户是否真的想要这个信息(即<code class="fe ol om on nr b">fields</code>参数中存在<em class="ng">坐标</em>和/或<em class="ng">地址</em>)，如果是，它调用<code class="fe ol om on nr b">url_google_geocoding</code>函数来构建API调用，并从RCurl包中调用<code class="fe ol om on nr b">getURL</code>函数来实际创建它。</p><p id="8984" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在我们收到Google的响应后，我们需要使用<code class="fe ol om on nr b">get_geodata_from_json_google</code>函数将其从JSON格式转换成R列表。一旦完成，结果将存储在<code class="fe ol om on nr b">geodata_df</code>数据帧中。</p><p id="9524" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">之后，对联系人重复相同的程序(即<em class="ng">电话号码</em>和<em class="ng">网站</em>)。仅此而已。</p><p id="421f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这是代码。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">使用Google Maps API进行地理编码的主要功能</p></figure><p id="0128" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，我们终于可以调用我们的函数并检查结果了。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="3422" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># replace "api_key" with your API key</em></strong><br/>pubs_google &lt;- geocode_google(pubs, "all", api_key)</span><span id="9799" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># check results</em></strong><br/>pubs_google</span></pre><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/f71a266ddaa62eea64023bdc27ecdc9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKS_DktjeeY1pBVrh5iNxw.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码功能的结果—Google Maps API[第1-5列]</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/5218eb2befb29142fa05b25442f0d178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xLK6EldrDk9h-m3NtnyRng.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码功能的结果—Google Maps API[第6–7列]</p></figure><h1 id="6df4" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用谷歌地图API进行反向地理编码</h1><p id="536d" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">下面是几乎相同的功能，但反向地理编码。这一次，它只返回基于地点坐标的地址。我在这里没有给出任何详细的解释，因为到现在为止，你已经能够自己理解代码了。</p><p id="9777" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">除了<code class="fe ol om on nr b">key</code>参数，主函数还需要<code class="fe ol om on nr b">coordinates</code>作为输入，可以是:</p><ul class=""><li id="9de5" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated">带有纬度和经度的向量(单个请求)；</li><li id="8ff1" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">纬度/经度向量的列表；</li><li id="ae86" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">有两列的矩阵——纬度和经度；</li><li id="980c" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">包含两列(纬度和经度)的数据框。</li></ul><p id="ec4e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该函数接受数值和字符串值作为<code class="fe ol om on nr b">coordinates</code>。</p><p id="134c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请注意，每次我们调用时，Google可能会返回几个结果，但我们只使用第一个结果— <code class="fe ol om on nr b">results[[1]]</code> —它对应于Google认为的最佳匹配。</p><p id="4e49" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">另外，对要从R列表中提取的元素的硬编码引用也要小心。例如，在我们的例子中，第5个元素<code class="fe ol om on nr b">$address_components[[5]]$long_name</code>可能指的是城市—伦敦(<code class="fe ol om on nr b">$address_components$types = "postal_town"</code>)、二级行政区—大伦敦(<code class="fe ol om on nr b">$address_components$types = "administrative_area_level_2"</code>)或一级行政区—英国(<code class="fe ol om on nr b">$address_components$types = "administrative_area_level_1"</code>)。因此，在这种情况下，我们必须遍历R列表，找到我们需要的信息的<code class="fe ol om on nr b">types</code>，并提取相应的<code class="fe ol om on nr b">long_name</code>。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">反向地理编码功能(谷歌地图API)</p></figure><p id="5fd8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面是在伦敦酒吧样本上运行这个函数的结果，我们之前从同一个API获得了这些酒吧的坐标。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="a54e" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># extract coordinates from pubs_google</em></strong><br/>pubs_google_crd &lt;- pubs_google[ , c("lat", "lng")]</span><span id="b25f" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># replace "api_key" with your API key</em></strong><br/>pubs_rev_google &lt;- rev_geocode_google(pubs_google_crd, api_key)</span><span id="3e57" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># check results</em></strong><br/>pubs_rev_google &lt;- cbind(pubs_df, pubs_rev_google)<br/>pubs_rev_google</span></pre><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/67191fd8e6599a8314f04834f9717652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w3fpRyOBNHlJqjunGp-0Rg.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行反向地理编码功能的结果— Google Maps API</p></figure><h1 id="e671" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">命名API</h1><p id="9d78" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">现在让我们把注意力转向OSM的提名API。</p><p id="db9f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">nomim<a class="ae ln" href="http://nominatim.org/release-docs/latest/api/Search/" rel="noopener ugc nofollow" target="_blank">search</a>API允许您根据描述或地址查找特定位置。它支持结构化请求和自由文本请求。搜索查询还可以包含对应于特定OpenStreetMap标签的<a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Nominatim/Special_Phrases/EN" rel="noopener ugc nofollow" target="_blank">特殊短语</a>、<strong class="kt jd">、</strong>。在我们的例子中，这个特殊短语是一个“<em class="ng">pub”</em>。</p><p id="25a7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><a class="ae ln" href="http://nominatim.org/release-docs/latest/api/Reverse/" rel="noopener ugc nofollow" target="_blank">反向</a>地理编码API从一个地方的纬度和经度生成一个地址。</p><p id="5b5e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">API调用的格式如下所示。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="3a80" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># geocoding format<br/></em></strong><a class="ae ln" href="https://nominatim.openstreetmap.org/search/" rel="noopener ugc nofollow" target="_blank">https://nominatim.openstreetmap.org/search/</a>&lt;query&gt;?&lt;params&gt;</span><span id="f847" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># geocoding example<br/></em></strong><a class="ae ln" href="https://nominatim.openstreetmap.org/search/The%20Churchill%20Arms,%20Notting%20Hill?format=json&amp;polygon=1&amp;addressdetails=1" rel="noopener ugc nofollow" target="_blank">https://nominatim.openstreetmap.org/search/The%20Churchill%20Arms,%20Notting%20Hill?format=json&amp;polygon=1&amp;addressdetails=1</a></span><span id="1465" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># reverse geocoding format<br/></em></strong><a class="ae ln" href="https://nominatim.openstreetmap.org/reverse" rel="noopener ugc nofollow" target="_blank">https://nominatim.openstreetmap.org/reverse</a>?&lt;query&gt;</span><span id="aa9e" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># reverse geocoding example<br/></em></strong><a class="ae ln" href="https://nominatim.openstreetmap.org/reverse?format=json&amp;lat=51.5068722&amp;lon=-0.1948221&amp;zoom=18&amp;addressdetails=1" rel="noopener ugc nofollow" target="_blank">https://nominatim.openstreetmap.org/reverse?format=json&amp;lat=51.5068722&amp;lon=-0.1948221&amp;zoom=18&amp;addressdetails=1</a></span></pre><p id="27ec" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一些参数对于地理编码和反向地理编码调用都是通用的:</p><ul class=""><li id="dcac" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><code class="fe ol om on nr b">format</code>=[html | XML | JSON | JSON v2 | geo JSON | geocode JSON]—输出格式；</li><li id="5577" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">addressdetails</code> = [0|1] —将地址分解成元素；</li><li id="bd40" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">extratags</code> = [0|1] —附加信息(维基页面、开放时间等)。);</li><li id="8f96" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">accept-language</code> —以何种语言显示搜索结果(English = en)；</li><li id="41b1" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">email</code> —除非您提供一个允许跟踪您活动的电子邮件地址，否则您将无法在您的应用中使用API(会出现错误消息)。</li></ul><p id="9fe5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">有些参数是每个API特有的。</p><p id="d2dd" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">搜索:</p><ul class=""><li id="0cc4" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><code class="fe ol om on nr b">query</code> —自由文本或地址；</li><li id="4322" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">countrycodes</code> —通过<a class="ae ln" href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2" rel="noopener ugc nofollow" target="_blank"> ISO 3166-1 alpha-2 </a>国家代码(英国= gb)限制搜索；</li><li id="e089" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">limit</code> —限制返回结果的数量。</li></ul><p id="cf2f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">反转:</p><ul class=""><li id="a092" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><code class="fe ol om on nr b">query</code> = lat，lon — in <a class="ae ln" href="https://en.wikipedia.org/wiki/World_Geodetic_System" rel="noopener ugc nofollow" target="_blank"> WGS 84 </a>格式；</li><li id="8ad7" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">namedetails</code> = [0|1] —在结果中包含替代名称列表；</li><li id="3b7d" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><code class="fe ol om on nr b">zoom</code>=[0–18]—地址所需的详细程度(默认值为18，即特定的建筑物)。</li></ul><p id="ba4a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><code class="fe ol om on nr b">query</code>、<code class="fe ol om on nr b">format</code>和<code class="fe ol om on nr b">email</code>为必选参数，其余为可选参数。我们不会在我们的函数中使用<code class="fe ol om on nr b">namedetails</code>参数，也不会改变<code class="fe ol om on nr b">zoom</code>参数的默认值——我提供它们只是供您参考。</p><p id="afc2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这里一个重要的方面是标签<a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Tags" rel="noopener ugc nofollow" target="_blank">的使用，它指向OpenStreeMap mappers提供的特定信息。这些标签中有一些是重复的(像</a><a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Key:email" rel="noopener ugc nofollow" target="_blank">电子邮件</a>和<a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Key:phone" rel="noopener ugc nofollow" target="_blank">电话</a>和<a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Key:website" rel="noopener ugc nofollow" target="_blank">网站</a>与<a class="ae ln" href="https://wiki.openstreetmap.org/wiki/Key:contact" rel="noopener ugc nofollow" target="_blank">联系人</a>名称空间中的类似标签)，所以不同的人可能会用不同的标签来标记同一类信息，你需要在你的应用程序中说明这一点。</p><p id="f3bf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">还有一些<a class="ae ln" href="https://operations.osmfoundation.org/policies/nominatim/" rel="noopener ugc nofollow" target="_blank">要求</a>，您必须遵守这些要求才能使用提名服务:</p><ul class=""><li id="a125" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated">限制同一网站/应用程序发送的请求数量——每个应用程序每秒一个请求；</li><li id="6cfa" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">不鼓励对大量数据进行批量地理编码，但允许较小的一次性任务(我们的例子)；</li><li id="f7ad" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated">搜索结果必须被缓存，所以不要多次发送相同的请求。</li></ul><h1 id="e098" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用命名API进行地理编码</h1><p id="b2cf" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">下面的函数复制了我们为Google Maps API构建的函数，所以我们不会详细描述它。</p><p id="184f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">唯一显著的区别是我们添加了两个额外的可选参数:<code class="fe ol om on nr b">country</code>，它对应于API调用的<code class="fe ol om on nr b">countrycodes</code>参数，用于将您的搜索限制在某些县(默认情况下不使用)和<code class="fe ol om on nr b">language</code>，它对应于<code class="fe ol om on nr b">accept-language</code>参数，允许您选择显示结果的语言(默认为英语)。两个参数都需要以字符串的形式提供:<code class="fe ol om on nr b">country</code>作为逗号分隔的代码列表(例如“gb，dr，fr”)，而<code class="fe ol om on nr b">language</code>作为单个值(例如“es”)。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">地理编码功能(命名API)</p></figure><p id="8282" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们看看运行这个函数的结果。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="1f0e" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># replace "email" with your email address<br/></em></strong>pubs_nominatim &lt;- geocode_nominatim(pubs_m, country = "gb", fields = "all", email = email)</span><span id="740e" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># let's now see the results</em></strong><br/>pubs_nominatim[, c(1:4)]<br/>pubs_nominatim[, c(1, 5:10)]<br/>pubs_nominatim[, c(1, 11:13)]<br/>pubs_nominatim[, c(1, 14:17)]</span></pre><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/08291658bb68188c5e11f298cfcd2cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDLo9l94MTTTWiMrrIcEgw.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码函数的结果-命名API[第1–4列]</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/53aafa52ee5555f5bd33a21d610b3798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wgkhadyM-x57lZMmbFa1iw.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码函数的结果-命名API[第5–10列]</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/56fb6e912d516b11a3a1ea9a9d97deb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICQNAKqK03HFHtJonavOQg.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码函数的结果-命名API[第11–13列]</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/a3686959d7632d31975636be5742c3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUOU0znSkvjoGlejQknaMQ.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码函数的结果-命名API[第14–17列]</p></figure><h1 id="5063" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用命名API进行反向地理编码</h1><p id="4550" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">类似地，下面的反向地理编码函数在很大程度上类似于我们为Google Maps API构建的函数。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">反向地理编码功能(命名API)</p></figure><p id="887e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面是在12家伦敦酒吧的样本上运行这个函数的结果。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="7497" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># extract coordinates from geocoding results<br/></em></strong>pubs_nominatim_crd &lt;- pubs_nominatim[, c("lat", "lng")]</span><span id="c9e3" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># replace "email" with your email address<br/></em></strong>pubs_rev_nominatim &lt;- rev_geocode_nominatim(pubs_nominatim_crd, email = email)<br/>pubs_rev_nominatim &lt;- cbind(pubs_m_df, pubs_rev_nominatim)</span><span id="5c66" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># let's now see the results</em></strong><br/>pubs_rev_nominatim[, 1:4]<br/>pubs_rev_nominatim[, c(1, 5:11)]</span></pre><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pe"><img src="../Images/a51d377303d126ed6e64f6ec89c7e43d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJKxLa2OOs7B7gwoqEzJ0g.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码反向函数-命名API的结果[第1–4列]</p></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pi"><img src="../Images/8d179103d4bf39bf064abe19f70aad9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n8beSGpJMGOjvvkFMFzJZQ.jpeg"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行地理编码反向函数-命名API的结果[第5–11列]</p></figure><h1 id="21c6" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">使用传单库构建地图</h1><p id="2c0e" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">普遍的事实是，只有当培训材料辅以实际应用的例子时，才能引起对该主题的真正兴趣。我向你们承诺过，基于我们从API获得的信息，我们将建立一个交互式地图，我打算兑现这个承诺。</p><p id="f0fa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">轻松构建地图的方法之一是使用JavaScript <a class="ae ln" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank">传单</a>库。传单在其网站上被描述为:<em class="ng">“[……]领先的移动友好互动地图开源JavaScript库。”许多大型科技公司、一些媒体甚至政府机构都在使用它:GitHub、脸书、Pinterest、金融时报、华盛顿邮报、Data.gov、欧盟委员会都在使用它。在我们的例子中，我们将依赖RStudio的<a class="ae ln" href="https://rstudio.github.io/leaflet/" rel="noopener ugc nofollow" target="_blank">传单</a>包，这使得在r中集成和控制传单地图变得很容易。</em></p><p id="1d4c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我不会在这里描述这个伟大工具提供的所有特性，因为这是另一篇完整文章的主题。相反，让我们把注意力集中在最重要的事情上。</p><p id="42c3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">因此，在传单中创建地图的过程包括三个基本步骤:</p><ol class=""><li id="a090" class="oo op it kt b ku kv kx ky la oq le or li os lm pj ou ov ow bi translated">创建地图微件。</li><li id="2fa2" class="oo op it kt b ku ox kx oy la oz le pa li pb lm pj ou ov ow bi translated">向地图添加图层。</li><li id="d8c8" class="oo op it kt b ku ox kx oy la oz le pa li pb lm pj ou ov ow bi translated">显示地图。</li></ol><p id="4374" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">微件本质上是地图的主干或容器。</p><p id="90eb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">图层允许您向地图添加以下元素:</p><ul class=""><li id="a5c9" class="oo op it kt b ku kv kx ky la oq le or li os lm ot ou ov ow bi translated"><a class="ae ln" href="https://rstudio.github.io/leaflet/basemaps.html" rel="noopener ugc nofollow" target="_blank">图块</a> —本质上是地图的“皮肤”，它定义了地图的外观和细节层次。更多关于<a class="ae ln" href="https://en.wikipedia.org/wiki/Tiled_web_map" rel="noopener ugc nofollow" target="_blank">平铺地图</a>；</li><li id="f861" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><a class="ae ln" href="https://rstudio.github.io/leaflet/markers.html" rel="noopener ugc nofollow" target="_blank">标记</a> —可用于显示地图上的特定位置；</li><li id="3018" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><a class="ae ln" href="https://rstudio.github.io/leaflet/popups.html" rel="noopener ugc nofollow" target="_blank">弹出窗口和标注</a> —可用于向地图添加标注。例如，显示与某个位置相关联的地址或联系信息；</li><li id="a7b5" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><a class="ae ln" href="https://rstudio.github.io/leaflet/shapes.html" rel="noopener ugc nofollow" target="_blank">多边形</a>——特定的区域或面积。例如，一个州内的一个区；</li><li id="04de" class="oo op it kt b ku ox kx oy la oz le pa li pb lm ot ou ov ow bi translated"><a class="ae ln" href="https://rstudio.github.io/leaflet/legends.html" rel="noopener ugc nofollow" target="_blank">图例</a>等。</li></ul><p id="dfb0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于我们的地图，我们将使用OpenStreetMap中的图块(传单的默认图块),并根据我们从Nominatim中提取的坐标绘制酒吧的位置。此外，我们将在标记弹出窗口中添加关于酒吧名称、地址和联系方式的信息。由于Nominatim没有返回每个酒吧的详细信息，我自己搜索了这些信息。我们没有在我们的可视化中使用任何多边形或图例，我添加的链接仅供参考。</p><p id="67ca" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">因此，在我们继续之前，让我们做一些数据准备。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">构建地图的数据准备</p></figure><p id="ec2a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在我们可以继续构建地图本身。</p><p id="9786" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，让我们准备要在弹出消息中显示的文本:酒吧的名称、地址和电话号码。网站将不会单独显示，而是作为一个超链接添加到酒吧的名称。我们将使用一些html来以我们想要的格式呈现我们的文本。这里有一个提示。仅当您单击弹出消息所附着的对象时，才会显示弹出消息。如果您想在光标悬停在标记上时显示一些信息，您需要使用标签。然而，与弹出窗口不同，标签不会自动识别HTML语法——你需要先使用<a class="ae ln" href="https://cran.r-project.org/web/packages/htmltools/htmltools.pdf" rel="noopener ugc nofollow" target="_blank"> htmltools </a>包中的<code class="fe ol om on nr b">HTML</code>函数来转换你的消息。一旦完成，我们可以“画”我们的地图。</p><p id="8ff4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">小叶功能是不言自明的。您可能唯一不熟悉的是管道操作符<code class="fe ol om on nr b">%&gt;%</code>，它是由<a class="ae ln" href="https://www.tidyverse.org/" rel="noopener ugc nofollow" target="_blank"> tidyverse </a> packages集合引入的。基本上，它允许您通过将一个函数的输出作为另一个函数的参数来传递，从而轻松地链接函数调用。更多关于那个<a class="ae ln" href="https://magrittr.tidyverse.org/" rel="noopener ugc nofollow" target="_blank">的信息在这里</a>。</p><pre class="lw lx ly lz gt nq nr ns nt aw nu bi"><span id="45a3" class="nv mm it nr b gy nw nx l ny nz"><strong class="nr jd"><em class="ng"># text to be diplayed on pop-ups<br/></em></strong>website &lt;- paste0("&lt;a href='", pubs_map$website, "'&gt;", pubs_map$pub_name, "&lt;/a&gt;")<br/>center &lt;- "&lt;div style='text-align:center'&gt;"<br/>name &lt;- paste0(center, "&lt;b&gt;", website, "&lt;/b&gt;", "&lt;/div&gt;")<br/>address &lt;- paste0(center, pubs_map$address_display, "&lt;/div&gt;")<br/>phone &lt;- paste0(center, pubs_map$phone, "&lt;/div&gt;")</span><span id="b851" class="nv mm it nr b gy oa nx l ny nz"><strong class="nr jd"><em class="ng"># building the map<br/></em></strong>pubs_map %&gt;%<br/>    leaflet() %&gt;%<br/>    addTiles() %&gt;%<br/>    addMarkers(~lng, ~lat, popup = paste0(name, address, phone))</span></pre><p id="2118" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">最后看看结果吧。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi pk"><img src="../Images/6710d1318c163a5811c0e0c7150a539e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*G91BlsQE1AZ1HrGsarzRmw.gif"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">用传单包装制作的地图</p></figure><h1 id="45d0" class="ml mm it bd mn mo mp mq mr ms mt mu mv ki mw kj mx kl my km mz ko na kp nb nc bi translated">结论</h1><p id="36a7" class="pw-post-body-paragraph kr ks it kt b ku nk kd kw kx nl kg kz la nm lc ld le nn lg lh li no lk ll lm im bi translated">在本教程中，我们介绍了使用Google Maps和Nominatim检索地理编码数据的不同方法，并展示了如何使用JavaScript传单库将这些数据用于在地图上绘制特定位置。我希望本指南将作为您探索所有不同种类的API和映射工具的起点。</p></div></div>    
</body>
</html>