<html>
<head>
<title>Building a monorepo for Data Science with Pantsbuild</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Pantsbuild 为数据科学构建 monorepo</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-monorepo-for-data-science-with-pantsbuild-2f77b9ee14bd?source=collection_archive---------18-----------------------#2020-09-03">https://towardsdatascience.com/building-a-monorepo-for-data-science-with-pantsbuild-2f77b9ee14bd?source=collection_archive---------18-----------------------#2020-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="55eb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">并了解它的好处</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8ea54362827ecd62d5e64d3b238d63bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_a82XUCMLWb3I-3taCperQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">塞尔吉奥·索萨在<a class="ae kv" href="https://unsplash.com/@serjosoza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7d09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="http://housinganywhere.com/" rel="noopener ugc nofollow" target="_blank"> HousingAnywhere </a>，我们在扩展数据团队时必须面对的第一个主要障碍是建立一个包含我们不断增长的机器学习应用程序的集中式存储库。在这些项目之间，许多项目相互依赖，这意味着代码重构可能会成为一种痛苦，并消耗大量时间。此外，由于我们非常反对数据科学家复制/粘贴代码的倾向，我们需要一个统一的位置来存储可以轻松访问的可重用函数。</p><p id="667a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们用例的完美解决方案是构建一个 monorepo。在本文中，我将介绍如何使用构建自动化系统<a class="ae kv" href="https://www.pantsbuild.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> Pantsbuild </strong> </a>构建一个简单的 monorepo。</p><h1 id="958c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是单向回购？</h1><p id="954e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">monorepo 是一个存储库，其中存储了许多项目的代码。为您的团队建立一个集中的存储库有很多好处:</p><ul class=""><li id="32de" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><strong class="ky ir">复用性</strong>:允许项目共享功能，在数据科学的情况下，预处理数据、<em class="my">计算度量</em>甚至<em class="my">绘制图形</em>的代码可以跨项目共享。</li><li id="72f1" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated"><strong class="ky ir">原子变更</strong>:只需要一个操作就可以跨多个项目进行变更。</li><li id="8536" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated">大规模的重构 : <strong class="ky ir"> </strong>可以简单快速地完成，确保项目在之后仍然有效。</li></ul><p id="f386" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，Monorepo 并不是一个适合所有人的解决方案，因为它有许多缺点:</p><ul class=""><li id="6fb7" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><strong class="ky ir">安全问题</strong>:没有办法只暴露存储库的一部分。</li><li id="f699" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated">大代码库:随着回购规模的增长，它会带来问题，因为开发人员必须检查整个存储库。</li></ul><p id="c98f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在 HousingAnywhere，我们的数据科学家团队发现 monorepo 是我们数据团队用例的完美解决方案。我们的许多机器学习应用程序都有从中派生出来的较小的项目。monorepo 使我们能够快速地将这些新项目整合到 CI/CD 管道中，减少了为每个新项目单独设置管道的时间。</p><p id="9b57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们尝试了许多构建自动化系统，我们坚持使用的是<a class="ae kv" href="https://www.pantsbuild.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"/></a>。<strong class="ky ir"> </strong> Pants 是为数不多的原生支持 Python 的系统，是 Twitter、Toolchain、Foursquare、square、Medium 广泛使用的开源项目。</p><p id="f3a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近 Pants 已经更新到了 v2，目前只支持 Python，但是对于数据科学项目来说并没有太大的限制。</p><h1 id="2c99" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">一些基本概念</h1><p id="600d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有几个关于裤子的概念你应该事先了解:</p><ul class=""><li id="8d1d" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><strong class="ky ir">目标</strong>帮助用户告诉裤子采取什么行动，例如<code class="fe ne nf ng nh b">test</code></li><li id="7638" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated"><strong class="ky ir">任务</strong>是运行动作的裤子模块</li><li id="341a" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated"><strong class="ky ir">目标</strong>描述对哪些文件采取这些操作。这些目标是在构建文件中定义的</li><li id="6a8b" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated"><strong class="ky ir">目标类型</strong>定义可在目标上执行的操作类型，例如，您可以在测试目标上执行测试</li><li id="5611" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated"><strong class="ky ir">地址</strong>描述回购中目标的位置</li></ul><p id="ec22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要了解更多信息，我强烈推荐阅读这篇文档，裤子的开发者在详细解释这些概念方面做得非常好。</p><h1 id="cb10" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">示例存储库</strong></h1><p id="3283" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本节中，我将介绍如何使用 Pants 轻松设置 monorepo。首先，确保满足以下安装裤子的要求:</p><ul class=""><li id="eff3" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">Linux 或者 macOS。</li><li id="008b" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated">Python 3.6+可在您的<code class="fe ne nf ng nh b">PATH</code>上发现。</li><li id="b19c" class="mp mq iq ky b kz mz lc na lf nb lj nc ln nd lr mu mv mw mx bi translated">互联网接入(这样裤子就可以完全自举了)。</li></ul><p id="3ed4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们建立一个新的存储库:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="2d4d" class="nm lt iq nh b gy nn no l np nq">mkdir monorepo-example<br/>cd monorepo-example<br/>git init</span></pre><p id="6677" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者，您可以通过以下方式克隆示例<a class="ae kv" href="https://github.com/uiucanh/monorepo-example" rel="noopener ugc nofollow" target="_blank">回购</a>:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="9209" class="nm lt iq nh b gy nn no l np nq">git clone <a class="ae kv" href="https://github.com/uiucanh/monorepo-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/uiucanh/monorepo-example.git</a></span></pre><p id="3628" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，运行以下命令下载安装文件:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="3504" class="nm lt iq nh b gy nn no l np nq">printf '[GLOBAL]\npants_version = "1.30.0"\nbackend_packages = []\n' &gt; pants.toml<br/>curl -L -o ./pants https://pantsbuild.github.io/setup/pants &amp;&amp; \ chmod +x ./pants</span></pre><p id="0ad9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，通过奔跑<code class="fe ne nf ng nh b">./pants --version</code>拉起裤子。您应该收到<code class="fe ne nf ng nh b">1.30.0</code>作为输出。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="fa1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们向回购中添加几个简单的应用程序。首先，我们将创建一个<code class="fe ne nf ng nh b">utils/data_gen.py</code>和一个<code class="fe ne nf ng nh b">utils/metrics.py</code>，它们包含几个实用函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="fa1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将添加一个应用程序<code class="fe ne nf ng nh b">first_app/app.py</code>来导入这些代码。应用程序使用来自<code class="fe ne nf ng nh b">generate_linear_data</code>的数据，将它们传递给线性回归模型，并输出<em class="my">平均绝对百分比误差。</em></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="d92f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个应用程序<code class="fe ne nf ng nh b">second_app/app.py</code>使用第一个应用程序代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="a06e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们为这些应用程序添加了几个简单的测试，例如:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="89f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在每个目录中，我们都需要一个构建文件。这些文件包含关于目标及其依赖项的信息。在这些文件中，我们将声明这些项目需要什么需求，以及声明测试目标。</p><p id="956f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们从存储库的根开始:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1498" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个构建文件包含一个宏<code class="fe ne nf ng nh b">python_requirements()</code>，它创建了多个目标来从同一个目录下的<code class="fe ne nf ng nh b">requirements.txt</code>中提取第三方依赖项。它节省了我们为每个需求手工操作的时间:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="fb48" class="nm lt iq nh b gy nn no l np nq">python_requirement_library(<br/>    name="numpy",<br/>    requirements=[<br/>        python_requirement("numpy==1.19.1"),<br/>    ],<br/>)</span></pre><p id="5f89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ne nf ng nh b">utils</code>中的构建文件如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="3f5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里我们有两个目标:第一个是 Python 库，包含在<code class="fe ne nf ng nh b">source</code>中定义的 Python 代码，即我们的两个实用程序文件。它还指定了运行这些代码所需的需求，这是<code class="fe ne nf ng nh b">numpy</code>，我们在根构建文件中定义的第三方依赖项之一。</p><p id="3435" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第二个目标是我们之前定义的测试集合，它们依赖于之前的 Python 库。要运行这些测试，只需从 root 运行<code class="fe ne nf ng nh b">./pants test utils:utils_test</code>或<code class="fe ne nf ng nh b">./pants test utils::</code>即可。第二个<code class="fe ne nf ng nh b">:</code>告诉 Pants 运行构建文件中的所有测试目标。输出应该如下所示:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="71eb" class="nm lt iq nh b gy nn no l np nq">============== test session starts ===============<br/>platform darwin -- Python 3.7.5, pytest-5.3.5, py-1.9.0, pluggy-0.13.1<br/>cachedir: .pants.d/test/pytest/.pytest_cache<br/>rootdir: /Users/ducbui/Desktop/Projects/monorepo-example, inifile: /dev/null<br/>plugins: cov-2.8.1, timeout-1.3.4<br/>collected 3 items<br/>                     <br/>utils/data_gen_test.py .                   [ 33%]<br/>utils/metrics_test.py ..                   [100%]</span></pre><p id="b9f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似地，我们将为<code class="fe ne nf ng nh b">first_app</code>和<code class="fe ne nf ng nh b">second_app</code>创建两个构建文件</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="78e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ne nf ng nh b">second_app</code>构建文件中，我们将上面<code class="fe ne nf ng nh b">first_app</code>中的库声明为这个库的依赖项。这意味着来自该库的所有依赖项，连同它的源，将成为<code class="fe ne nf ng nh b">first_app</code>的依赖项。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="a90d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似地，我们也向这些构建文件添加一些测试目标，它们可以用<code class="fe ne nf ng nh b">./pants test first_app::</code>或<code class="fe ne nf ng nh b">./pants test second_app::</code>运行。</p><p id="c8f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终的目录树应该如下所示:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="dbcd" class="nm lt iq nh b gy nn no l np nq">.<br/>├── BUILD<br/>├── first_app<br/>│   ├── BUILD<br/>│   ├── app.py<br/>│   └── app_test.py<br/>├── pants<br/>├── pants.toml<br/>├── requirements.txt<br/>├── second_app<br/>│   ├── BUILD<br/>│   ├── app.py<br/>│   └── app_test.py<br/>└── utils<br/>    ├── BUILD<br/>    ├── data_gen.py<br/>    ├── data_gen_test.py<br/>    ├── metrics.py<br/>    └── metrics_test.py</span></pre><p id="3824" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Pants 的强大之处在于它能够跟踪受变更影响的项目和测试目标之间的可传递依赖关系。Pants 的开发人员为我们提供了这个漂亮的 bash 脚本，可以用来追踪受影响的测试目标:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="094c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了展示它的威力，让我们运行一个例子。我们将创建一个新分支，对<code class="fe ne nf ng nh b">data_gen.py</code>进行修改(例如，更改<code class="fe ne nf ng nh b">generate_linear_data</code>的默认参数)并提交:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="e1e8" class="nm lt iq nh b gy nn no l np nq">git checkout -b "example_1"<br/>git add utils/data_gen.py<br/>git commit -m "support/change-params"</span></pre><p id="e3a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，运行 bash 脚本，我们将看到一个<code class="fe ne nf ng nh b">minimized.txt</code>，它包含所有受影响的项目和将要执行的测试目标:</p><pre class="kg kh ki kj gt ni nh nj nk aw nl bi"><span id="4350" class="nm lt iq nh b gy nn no l np nq">first_app:app_test<br/>second_app:app_test<br/>utils:utils_test</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/68089398596c05dd914e5cbea99cf2e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*8pvOSXLtwdK3UIWcw29oRQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">传递依赖性</p></figure><p id="c90c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看上图，我们可以清楚地看到，更改<code class="fe ne nf ng nh b">utils</code>会影响它上面的所有节点，包括<code class="fe ne nf ng nh b">first_app</code>和<code class="fe ne nf ng nh b">second_app</code>。</p><p id="e5ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们再做一个例子，这次我们只修改<code class="fe ne nf ng nh b">second_app/app.py</code>。切换分支，提交并再次运行脚本。在<code class="fe ne nf ng nh b">minimized.txt</code>内部，我们只会得到<code class="fe ne nf ng nh b">second_app:app_test</code>，因为它是最顶层的节点。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="9450" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就这样，希望我已经成功地向你们展示了 Pantsbuild 对于数据科学 monorepos 是多么有用。加上正确实现的 CI/CD 管道，开发的速度和可靠性可以大大提高。</p></div></div>    
</body>
</html>