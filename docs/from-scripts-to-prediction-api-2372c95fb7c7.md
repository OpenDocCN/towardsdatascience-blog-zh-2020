# ä»è„šæœ¬åˆ°é¢„æµ‹ API

> åŸæ–‡ï¼š<https://towardsdatascience.com/from-scripts-to-prediction-api-2372c95fb7c7?source=collection_archive---------32----------------------->

## submission.csvï¼Ÿä¸ç”¨äº†ï¼Œè°¢è°¢ï¼

è¿™æ˜¯æˆ‘ä¸Šä¸€ç¯‡æ–‡ç« çš„å»¶ç»­:

[ä» Jupyter ç¬”è®°æœ¬åˆ°è„šæœ¬](/from-jupyter-notebook-to-sc-582978d3c0c)

ä¸Šæ¬¡æˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•å°† Jupyter Notebook è½¬æ¢æˆè„šæœ¬ï¼Œä»¥åŠå„ç§åŸºæœ¬çš„å·¥ç¨‹å®è·µï¼Œå¦‚ CIã€å•å…ƒæµ‹è¯•ã€åŒ…ç¯å¢ƒã€é…ç½®ã€æ—¥å¿—è®°å½•ç­‰

å³ä½¿æ˜¯è„šæœ¬å½¢å¼ï¼Œå®ƒä»ç„¶éœ€è¦æˆ‘ä»¬æ›´æ”¹é…ç½®å¹¶è¿è¡Œè„šæœ¬ï¼Œè¿™å¯¹äº Kaggle æ¯”èµ›æ¥è¯´æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºä½ æ‰€éœ€è¦çš„åªæ˜¯ **submission.csv** ï¼Œä½†æ˜¯ä½ å¯èƒ½ä¸æƒ³å…¨å¤©å€™ååœ¨è®¡ç®—æœºåé¢ï¼Œæ¯å½“ç”¨æˆ·å‘ä½ å‘é€é¢„æµ‹è¯·æ±‚æ—¶å°±ç‚¹å‡»è¿è¡ŒğŸ™

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•åˆ©ç”¨æˆ‘ä»¬ä¸Šæ¬¡æ„å»ºçš„æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ FastAPI åˆ›å»ºé¢„æµ‹ API æ¥æä¾›æ¨¡å‹æœåŠ¡ï¼

> å¯¹äº ML/DL çš„ä¹¡äº²ä»¬ï¼Œæˆ‘ä»¬è¯´çš„æ˜¯ [FastAPI](https://fastapi.tiangolo.com/) ï¼Œä¸æ˜¯ [fast.ai](https://www.fast.ai/) ï¼ï¼ï¼

# èƒŒæ™¯:FastAPI

Python ç”Ÿæ€ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šé’ˆå¯¹ API çš„æ¡†æ¶ï¼Œæˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯ç”¨ Flaskã€‚ä½†æ˜¯æˆ‘å¯¹ FastAPI çš„ç®€å•å’Œç›´è§‚å°è±¡æ·±åˆ»ï¼Œå¹¶ä¸”å–œæ¬¢åœ¨è¿™ä¸ªè¿·ä½ é¡¹ç›®ä¸­å°è¯•å®ƒï¼

â€œå†°å†»ä¸‰å°ºï¼Œéä¸€æ—¥ä¹‹å¯’â€ï¼ŒFastAPI ä» Djangoã€Flaskã€APIStar ç­‰ä¹‹å‰çš„æ¡†æ¶ä¸­å­¦åˆ°äº†å¾ˆå¤šï¼Œæˆ‘æ— æ³•æ¯”åˆ›ä½œè€…æœ¬äººæ›´å¥½çš„è§£é‡Š[è¿™ç¯‡æ–‡ç« ](https://fastapi.tiangolo.com/history-design-future/)å¤ªæ£’äº†ï¼

# æ— èŠä½†å¿…è¦çš„è®¾ç½®

ä¸œè¥¿éƒ½åœ¨ [one repo](https://github.com/G-Hung/model-productization_article) è¿™å¤§æ¦‚ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼Œåº”è¯¥æ˜¯çœŸå®ç”¨ä¾‹ä¸­ä¸åŒçš„ GitHub repoï¼Œå¯èƒ½æˆ‘ä»¥åä¼š*é‡æ„*ã€ä¸“ä¸šçš„è¯´æ³•â€œæ¸…ç†æˆ‘ä»¥å‰çš„ sxxtâ€ã€‘ï¼

*CS çš„äººæ€»æ˜¯è¯´*å•ä¸€è´£ä»»åŸåˆ™*ï¼Œè€Œä¸æ˜¯è¯´â€œä¸è¦æŠŠä¸åŒåŠŸèƒ½çš„ä»£ç æ”¾åœ¨ä¸€èµ·â€ï¼Œä¸‹æ¬¡ä¹Ÿè®¸ä½ å¯ä»¥è¯´â€œæˆ‘ä»¬åº”è¯¥éµå¾ªå•ä¸€è´£ä»»åŸåˆ™ï¼â€

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç”¨æ–°çš„åŒ…æ›´æ–° requirements.txtï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šæ¬¡æåˆ°çš„ï¼Œæˆ‘ä»¬åº”è¯¥æŒ‡å®š**ç¡®åˆ‡çš„ç‰ˆæœ¬**ï¼Œè¿™æ ·å…¶ä»–äººå°±å¯ä»¥å¤åˆ¶è¿™ä¸ªä½œå“äº†ï¼

```
# for last article
pytest==6.0.1
pandas==1.0.1
Click==7.0
scikit-learn==0.22.1
black==19.10b0
isort==4.3.21
PyYAML==5.2# for FastAPI
fastapi==0.61.0
uvicorn==0.11.8
chardet==3.0.4
```

åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ conda env ä¸­å†æ¬¡å®‰è£… requirements.txt å› ä¸ºæˆ‘ä»¬æœ‰äº†æ–°çš„åŒ…]

```
*# You can skip the line below if you have created conda env*
conda create - name YOU_CHANGE_THIS python=3.7 -yconda activate YOU_CHANGE_THISpip install â€“r requirements.txt
```

# æ¸¸æˆè®¡åˆ’

è®©æˆ‘ä»¬æƒ³æƒ³å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ API ç«¯ç‚¹æ¥åšé¢„æµ‹ï¼Œå…·ä½“æ¥è¯´ï¼Œå¦‚æœç”¨æˆ·ç»™ **us** è¾“å…¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ¨¡å‹æ¥é¢„æµ‹å¹¶è¿”å›é¢„æµ‹ã€‚

æˆ‘ä»¬æ²¡æœ‰è®©**us**ã€humanã€‘å¤„ç†ä¼ å…¥çš„è¯·æ±‚ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª API æœåŠ¡å™¨æ¥ç­‰å¾…è¯·æ±‚ã€è§£æè¾“å…¥ã€è¿›è¡Œé¢„æµ‹å¹¶è¿”å›ç»“æœã€‚API åªæ˜¯ä¸æˆ‘ä»¬çš„è®¡ç®—æœºå¯¹è¯å¹¶è¯·æ±‚æœåŠ¡çš„ç»“æ„åŒ–æ–¹å¼[åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯é¢„æµ‹]

![](img/79c61de3b2d0e17cfad5be1c7a0296e6.png)

é«˜å±‚æ­£åœ¨å‘ç”Ÿä»€ä¹ˆ

ä¸‹é¢æ˜¯ä¼ªä»£ç :

```
*# Load trained model*
trained_model = load_model(model_path)*# Let's create a API that can receive user request*
api = CreateAPI()*# If user send us the request to `predict` endpoint*
when user sends request to `api`.`predict`:
    input = api[`predict`].get(input) # get input
    prediction = trained_model(input) # apply model
    return prediction                 # return prediction
```

è¿™å¯¹å¿«ä¹æµæœ‰å¥½å¤„ï¼ä½†æ˜¯æˆ‘ä»¬åº”è¯¥*æ°¸è¿œä¸è¦*ç›¸ä¿¡ç”¨æˆ·ï¼Œé—®é—®ä½ è‡ªå·±ï¼Œä½ ä¼šåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­é˜…è¯»ç”¨æˆ·æ‰‹å†Œå—ï¼Ÿ

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœŸæœ›ä»ç”¨æˆ·é‚£é‡Œå¾—åˆ°{'a': 1ï¼Œ' b': 2ï¼Œ' c': 3}ï¼Œä½†æ˜¯æˆ‘ä»¬å¯èƒ½å¾—åˆ°:

*   é¡ºåºé”™è¯¯{'b': 2ï¼Œ' a': 1ï¼Œ' c': 3}ï¼Œæˆ–
*   é”™è¯¯çš„é”®{'a': 1ï¼Œ' b': 2ï¼Œ' d': 3}ï¼Œæˆ–è€…
*   ç¼ºå°‘å¯†é’¥{'a': 1ï¼Œ' b': 2}ï¼Œæˆ–è€…
*   è´Ÿå€¼{'a': -1ï¼Œ' b': 2ï¼Œ' c': 3}ï¼Œæˆ–
*   é”™è¯¯çš„ç±»å‹{ ' a ':' HELLO WORLD 'ï¼Œ' b': 2ï¼Œ' c': 3}ï¼Œæˆ–è€…
*   ç­‰ç­‰ç­‰ç­‰

è¿™å¯¹æˆ‘ä»¬çš„ API æ˜¯è‡´å‘½çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ¨¡å‹ä¸çŸ¥é“å¦‚ä½•å¯¹æ­¤åšå‡ºå“åº”ã€‚æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€äº›è¾“å…¥ç»“æ„æ¥ä¿æŠ¤æˆ‘ä»¬ï¼å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥æ›´æ–°æˆ‘ä»¬çš„ä¼ªä»£ç ï¼

```
**# Define input schema
input_schema = {......}***# Load trained model*
trained_model = load_model(model_path)*# Let's create a API that can receive user request*
api = CreateAPI()*# If user send us the request to `predict` endpoint*
when user sends request to `api`.`predict`:
    input = api[`predict`].get(input) # get input **transformed_input = apply(input_schema, input)
    if not transformed_input.valid(): return Error**    prediction = trained_model(**transformed_input**) # apply model
    return prediction                 # return prediction
```

# ä»£ç 

æˆ‘ç°åœ¨è§‰å¾—ä¸é”™ï¼è®©æˆ‘ä»¬ç”¨ FastAPI ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°ç¿»è¯‘å®ƒä»¬å§ï¼

**è¾“å…¥æ¨¡å¼**

çœ‹èµ·æ¥æœ‰å¾ˆå¤šè¡Œï¼Œä½†äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œæ­£å¦‚ä½ æ‰€çŒœæµ‹çš„ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸ºâ€œSampleâ€çš„ç±»ï¼Œå®ƒå°†æ¯ä¸ªé¢„æµ‹å™¨å®šä¹‰ä¸º *float* å’Œ*å¤§äº[gt] zeroï¼*

**è´Ÿè½½æ¨¡å‹**

ç„¶åæˆ‘ä»¬åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå—¯å—¯ä»€ä¹ˆæ˜¯â€˜é¢„æµ‹å™¨â€™ï¼Ÿå®ƒåªæ˜¯ä¸€ä¸ªç”¨ä¸åŒæ–¹æ³•åŒ…è£…æ¨¡å‹çš„å®šåˆ¶ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œä¸æ˜¯åœ¨ API æœåŠ¡å™¨ä¸­å®ç°é€»è¾‘

**åˆ›å»ºä¸€ä¸ª API æœåŠ¡å™¨**

ç„¶åæˆ‘ä»¬ä½¿ç”¨ FastAPI åˆ›å»º API ä¼ªä»£ç å‡ ä¹å·²ç»æ˜¯ä»£ç äº†

**é¢„æµ‹ç»ˆç‚¹**

è¿™çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†æ˜¯éå¸¸ç®€å•

ä¸æ˜¯è¯´*â€œå½“ç”¨æˆ·å‘â€˜APIâ€™å‘é€è¯·æ±‚æ—¶ã€‚â€˜predictâ€™â€*

æˆ‘ä»¬è¯´:*"å˜¿ï¼Œappï¼Œå¦‚æœæœ‰äººå‘é€"****GET****è¯·æ±‚"ä¸ºäº†`é¢„æµ‹'ï¼Œè¯·è¿è¡Œå‡½æ•° predict_itemï¼Œæˆ‘ä»¬æœŸæœ›è¾“å…¥éµå¾ªæˆ‘ä»¬åœ¨`ç¤ºä¾‹`ä¸­å®šä¹‰çš„æ¨¡å¼"*

*predict_item* æ‰€åšçš„åªæ˜¯è½¬æ¢è¾“å…¥å½¢çŠ¶ï¼Œé¦ˆé€ç»™è®­ç»ƒå¥½çš„æ¨¡å‹å¹¶è¿”å›é¢„æµ‹ï¼Œç®€å•çš„ Python å‡½æ•°

> å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº [HTTP è¯·æ±‚æ–¹æ³•](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)

ä½†æ˜¯ä½ å¯èƒ½ä¼šé—®:å“ï¼å°‘äº†ä¸€è¡Œï¼ï¼ï¼è¾“å…¥éªŒè¯åœ¨å“ªé‡Œï¼Ÿå¦‚æœç”¨æˆ·æä¾›äº†é”™è¯¯çš„æ•°æ®ç±»å‹/é”®æˆ–è€…é—æ¼äº†ä¸€ä¸ªå­—æ®µï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

å—¯â€¦â€¦è¿˜è®°å¾—æˆ‘ä»¬å·²ç»ä¸ºè¾“å…¥æ¨¡å¼å®šä¹‰äº†â€œSampleâ€ç±»å—ï¼Ÿå¿«é€Ÿ API **è‡ªåŠ¨**æ ¹æ®æ¨¡å¼ä¸ºæˆ‘ä»¬éªŒè¯å®ƒï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªï¼ï¼ï¼è¿™ä¸ºæ„å»ºä¸€ä¸ªå¥å£®çš„ã€ç»è¿‡è‰¯å¥½æµ‹è¯•çš„ API èŠ‚çœäº†å¤§é‡çš„è„‘åŠ›å’Œä»£ç ï¼

# å°è¯•ä½¿ç”¨

```
# At project root, we can run this
# --reload is for development, API server autorefresh
# when you change the codeuvicorn prediction_api.main:app --reload
```

ä½ åº”è¯¥èƒ½çœ‹åˆ°è¿™äº›ï¼ŒAPI æœåŠ¡å™¨ç°åœ¨è¿è¡Œåœ¨â€œhttp://127.0.0.1:8000â€ä¸Šï¼

![](img/45cad740f37e2165bf5b3175f533f754.png)

æ ¹æ®æ‚¨çš„ç¯å¢ƒï¼Œæœ‰ä¸åŒçš„æ–¹æ³•æ¥è¯•éªŒ APIï¼Œæ‚¨å¯ä»¥åœ¨ Python ä¸­ä½¿ç”¨*è¯·æ±‚ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨*æˆ– *cURLã€‚* BTW æœ‰ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·å«åš[é‚®å·®](https://www.postman.com/)ï¼Œè¯•è¯•å§ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç›´è§‚å’Œäººæ€§åŒ–çš„ API å·¥å…·ï¼

æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ä½¿ç”¨ Python è¯·æ±‚ï¼Œä½ å¯ä»¥åœ¨[è¿™æœ¬ç¬”è®°æœ¬](https://github.com/G-Hung/model-productization_article/blob/master/notebook/prediction_API_test.ipynb)ä¸­çœ‹åˆ°å®ƒä»¬ã€æœ‰æ—¶ Jupyter æ˜¯æœ‰å¸®åŠ©çš„ğŸ˜]

> ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨äº†ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥:è€¶ï¼ğŸ˜æˆ‘ä»¬æˆåŠŸäº†ï¼ç«¯ç‚¹è¿”å›é¢„æµ‹ï¼ï¼ï¼

```
payload = {
    "fixed_acidity": 10.5,
    "volatile_acidity": 0.51,
    "citric_acid": 0.64,
    "residual_sugar": 2.4,
    "chlorides": 0.107,
    "free_sulfur_dioxide": 6.0,
    "total_sulfur_dioxide": 15.0,
    "density": 0.9973,
    "pH": 3.09,
    "sulphates": 0.66,
    "alcohol": 11.8,
}result = requests.get("[http://127.0.0.1:8000/predict](http://127.0.0.1:8000/predict)", data = json.dumps(payload))print(result.json())**Output**
{'prediction': 1, 'utc_ts': 1597537570, 'model': 'RandomForestClassifier'}
```

> ä¸‹é¢çš„ä¾‹å­é—æ¼äº†ä¸€ä¸ªå­—æ®µï¼ŒFastAPI å¸®åŠ©æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬å®šä¹‰çš„æ¨¡å¼æ¥å¤„ç†å®ƒï¼Œé™¤äº†æ¨¡å¼ç±»ï¼Œæˆ‘ä»€ä¹ˆä¹Ÿæ²¡å†™

```
payload = {
    "volatile_acidity": 0.51,
    "citric_acid": 0.64,
    "residual_sugar": 2.4,
    "chlorides": 0.107,
    "free_sulfur_dioxide": 6.0,
    "total_sulfur_dioxide": 15.0,
    "density": 0.9973,
    "pH": 3.09,
    "sulphates": 0.66,
    "alcohol": 11.8,
}result = requests.get("[http://127.0.0.1:8000/predict](http://127.0.0.1:8000/predict)", data = json.dumps(payload))print(result.json())**Output**
{'detail': [{'loc': ['body', 'fixed_acidity'], 'msg': 'field required', 'type': 'value_error.missing'}]}
```

åªæ˜¯ä¸ºäº†å¥½ç©ï¼Œæˆ‘è¿˜å®ç°äº†ä¸€ä¸ª *update_model* PUT API æ¥äº¤æ¢æ¨¡å‹ï¼Œä¾‹å¦‚ï¼Œæœ€åˆæˆ‘ä»¬ä½¿ç”¨éšæœºæ£®æ—ï¼Œæˆ‘å°†å…¶æ›´æ–°ä¸ºæ¸å˜ Boostingâ˜ºï¸

```
result = requests.put("[http://127.0.0.1:8000/update_model](http://127.0.0.1:8000/update_model)")print(result.json())**Output**
{'old_model': 'RandomForestClassifier', 'new_model': 'GradientBoostingClassifier', 'utc_ts': 1597537156}
```

# è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£

å…¶ä¸­ä¸€ä¸ªå¾ˆé…·çš„ FastAPI ç‰¹æ€§æ˜¯ auto-documentï¼Œåªéœ€è¿›å…¥[http://127 . 0 . 0 . 1:8000/docs #/](http://127.0.0.1:8000/docs#/)å³å¯è·å¾—å¼€ç®±å³ç”¨çš„äº¤äº’å¼å¼ºå¤§ API æ–‡æ¡£ï¼å¦‚æ­¤ç›´è§‚ï¼Œæˆ‘ä¸éœ€è¦ç»†è¯´

![](img/4f200ed783a50850459d4e9f60900043.png)

# é‡è®¿ pytest

æˆ‘å†æ€ä¹ˆå¼ºè°ƒå•å…ƒæµ‹è¯•çš„é‡è¦æ€§ä¹Ÿä¸ä¸ºè¿‡ï¼Œå®ƒéªŒè¯äº†å‡½æ•°æ­£åœ¨åšæˆ‘ä»¬æœŸæœ›å®ƒä»¬åšçš„äº‹æƒ…ï¼Œè¿™æ ·ä½ å°±ä¸ä¼šä¸å°å¿ƒå¼„åä¸œè¥¿äº†ï¼

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘è¯•å›¾æ¶µç›–æ¯ä¸€ä¸ªæµ‹è¯•ï¼Œè¿™å°†æ˜¯å¤ªæ— èŠå’Œå†—é•¿ã€‚æˆ‘æ‰“ç®—åœ¨è¿™é‡Œåˆ†äº«ä¸€äº›æˆ‘ä¼šæ— è„‘æµ‹è¯•çš„é¢†åŸŸ&ä¸€äº›[å¯èƒ½æœ‰ç”¨çš„]æ–‡ç« ã€‚ç„¶åæˆ‘ä¼šè®²ä¸€ä¸ªå«å‚æ•°åŒ–å•å…ƒæµ‹è¯•çš„ pytest ç‰¹æ€§ï¼Œä»¥åŠ pytest ä¸­çš„ä¸€äº›æµ‹è¯•é€‰é¡¹ã€‚æ¿€åŠ±è‡ªå·±å­¦ä¹ å•å…ƒæµ‹è¯•æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å°è¯•é‡æ„ä½ ä¹‹å‰çš„ä»£ç ï¼Œè¶Šå¤§è¶Šå¥½ï¼

**å•å…ƒæµ‹è¯•**

æ¯å½“ä½ å‘ç°ç¼–å†™/ç†è§£å•å…ƒæµ‹è¯•æœ‰å›°éš¾æ—¶ï¼Œä½ å¯èƒ½éœ€è¦é¦–å…ˆå›é¡¾ä½ çš„ä»£ç ç»“æ„ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä¼šä¸å‡æ€ç´¢è€ƒè™‘çš„ 4 ä¸ªæ–¹é¢:

1.  è¾“å…¥æ•°æ®:dimension [eg: df.shape]ï¼Œtype [eg: str]ï¼Œå€¼åŸŸ[eg: -/0/+]
2.  è¾“å‡ºæ•°æ®:dimension [eg: df.shape]ï¼Œtype [eg: str]ï¼Œå–å€¼èŒƒå›´[eg: -/0/+]
3.  æ¯”è¾ƒ:è¾“å‡ºå’Œé¢„æœŸç»“æœ
4.  æˆ‘è°ƒè¯•åï¼Œé˜²æ­¢å®ƒå†æ¬¡å‘ç”Ÿ

ä¾‹å¦‚ï¼Œæˆ‘éå¸¸å…³æ³¨ä¸‹é¢çš„è¾“å‡ºç»´åº¦ã€ç±»å‹å’Œå€¼èŒƒå›´ã€‚è¿™ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†å¦‚æœä½ ä¿®æ”¹ä»»ä½•è¾“å‡ºæ ¼å¼ï¼Œå®ƒä¼šæé†’ä½ ä»€ä¹ˆæ˜¯é¢„æœŸçš„æ ¼å¼ï¼

FYR çš„ä¸€äº›æ–‡ç« :

[æ•°æ®ç§‘å­¦å®¶çš„å•å…ƒæµ‹è¯•](/unit-testing-for-data-scientists-dc5e0cd397fb)

[å¦‚ä½•å•å…ƒæµ‹è¯•æœºå™¨å­¦ä¹ ä»£ç ](https://medium.com/@keeper6928/how-to-unit-test-machine-learning-code-57cf6fd81765)ã€æ·±åº¦å­¦ä¹ ã€‘

**å‚æ•°åŒ–å•å…ƒæµ‹è¯•**

å‡è®¾æ‚¨æœ‰ 100 ä¸ªæ¨¡æ‹Ÿæ•°æ®[ç”¨ D_iï¼Œi: 1 æ ‡æ³¨..100]å¹¶ä¸”ä½ æƒ³ä¸ºå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªè¿è¡Œç›¸åŒçš„å•å…ƒæµ‹è¯•ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ

> *è›®åŠ›å¤§æ³•*

```
def test_d1():
    assert some_operation(D_1)def test_d2():
    assert some_operation(D_2)def test_d3():
    assert some_operation(D_3)......def test_d100():
    assert some_operation(D_100)
```

ä½†æ˜¯å¦‚æœä½ éœ€è¦ä¿®æ”¹â€œsome_operation â€,ä½ éœ€è¦ä¿®æ”¹ 100 æ¬¡ LOLâ€¦â€¦è™½ç„¶ä½ å¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä¸ªå®ç”¨å‡½æ•°ï¼Œä½†è¿™ä½¿å¾—æµ‹è¯•å¾ˆéš¾é˜…è¯»ï¼Œè€Œä¸”éå¸¸å†—é•¿

> *æ›´å¥½çš„æ–¹æ³•ä¹Ÿè®¸æ˜¯ for-loopï¼Ÿ*

```
def test_d():
    for D in [D_1, D_2, D_3, ..., D_100]:
        assert some_operation(D)
```

ä½†æ˜¯ä½ ä¸èƒ½ç¡®åˆ‡åœ°çŸ¥é“å“ªäº›æµ‹è¯•å¤±è´¥äº†ï¼Œå› ä¸ºè¿™ 100 ä¸ªæµ‹è¯•éƒ½åœ¨ä¸€ä¸ªæµ‹è¯•ä¸­

> *pytest ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåä¸º* ***å‚æ•°åŒ–*** çš„ç‰¹æ€§

```
[@pytest](http://twitter.com/pytest).mark.parametrize("test_object", [D_1, D_2, ..., D_100])
def test_d(test_object):
    assert some_operation(test_object)
```

**å¸¸è§ pytest é€‰é¡¹**

> **pytest æ–‡ä»¶å¤¹**

ä¸Šæ¬¡æˆ‘ä»¬æåˆ°æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ`**pytest**', pytest ä¼šåœ¨æ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°æ‰€æœ‰çš„**æµ‹è¯•ã€‚ä½†æ˜¯æœ‰æ—¶æˆ‘ä»¬å¯èƒ½ä¸æƒ³åœ¨å¼€å‘è¿‡ç¨‹ä¸­è¿è¡Œæ‰€æœ‰çš„å•å…ƒæµ‹è¯•[ä¹Ÿè®¸ä¸€äº›æµ‹è¯•èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´ï¼Œä½†æ˜¯ä¸æ‚¨å½“å‰çš„ä»»åŠ¡æ— å…³]**

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç®€å•åœ°è¿è¡Œ **pytest æ–‡ä»¶å¤¹**ï¼Œä¾‹å¦‚:` pytestã€‚/scripts 'æˆ–' pytestã€‚æ¼”ç¤ºä¸­çš„/prediction_api '

> **å¹¶è¡Œ pytest**

æœ‰æ—¶ä½ çš„æµ‹è¯•ç”¨ä¾‹å¤ªé‡ï¼Œå¹¶è¡Œè¿è¡Œå¯èƒ½æ˜¯ä¸ªå¥½ä¸»æ„ï¼æ‚¨å¯ä»¥å®‰è£… **pytest-xdist** å¹¶åœ¨æ‚¨çš„å‘½ä»¤ä¸­ç”¨ py.test æ›¿æ¢ pytestï¼Œä¾‹å¦‚:py.test -n 4

> **pytest -v**

è¿™æ˜¯ä¸ªäººå–œå¥½ï¼Œæˆ‘æ›´å–œæ¬¢å†—é•¿çš„è¾“å‡ºï¼Œçœ‹åˆ°ç»¿è‰²é€šè¿‡âœ…å¼€å§‹æˆ‘çš„ä¸€å¤©

![](img/113346765a25413b3ad39e145a2b82f2.png)

pytest

![](img/607c7d1b096e83f3f3562543fd209a47.png)

pytest -v

> æ‚¨å¯ä»¥ä»ä»¥ä¸‹ææ–™ä¸­äº†è§£æ›´å¤šä¿¡æ¯:
> 
> [https://docs.pytest.org/en/stable/](https://docs.pytest.org/en/stable/)
> 
> [https://www.guru99.com/pytest-tutorial.html#5](https://www.guru99.com/pytest-tutorial.html#5)

## æœ€åï¼Œæˆ‘å¸Œæœ›ä½ èƒ½å’Œæˆ‘ä¸€æ ·å–œæ¬¢è¿™ä¸ª 1 åˆ†é’Ÿçš„ Youtube è§†é¢‘ğŸ˜†

# ç»“è®º

Yoooâœ‹:æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªä½¿ç”¨æˆ‘ä»¬æ¨¡å‹çš„é¢„æµ‹ APIï¼Œç”¨æˆ·ç°åœ¨å¯ä»¥å‘é€è¯·æ±‚å¹¶è·å¾—é¢„æµ‹ï¼Œè€Œæ— éœ€äººå·¥å‚ä¸ï¼Œè¿™è¿‡åº¦ç®€åŒ–äº†ç°å®[ååé‡ã€å»¶è¿Ÿã€æ¨¡å‹ç®¡ç†ã€èº«ä»½éªŒè¯ã€AB æµ‹è¯•ç­‰]ï¼Œä½†è¿™å°±æ˜¯æˆ‘ä»¬çš„æƒ³æ³•ï¼

è‡³å°‘å¦‚æœä½ çš„åŸå‹è¾¾åˆ°äº†è¿™ä¸ªæ°´å¹³ï¼Œå·¥ç¨‹å¸ˆä»¬ä¼šæ›´ä¹æ„æ¥æ‰‹ï¼Œä»è€ŒåŠ å¿«æ•´ä¸ªè¿‡ç¨‹ï¼Œä½ å¯ä»¥å‘ä»–ä»¬å±•ç¤ºä½ çŸ¥é“ä¸€äº›ä¸œè¥¿ğŸ˜ˆ

æœ€åï¼Œæˆ‘ä»¬:

```
a. Update conda env [requirements.txt]
b. Brainstorm pseudocode and convert to code [FastAPI, uvicorn]
c. Utilize API [cURL, requests, Postman]
d. Talk about Auto-generated documents by FastAPI
e. Some pytest techniques [parallel, parameterized, -v]
```

ä¸‹é¢çš„æ–‡ä»¶æ ‘æ˜¾ç¤ºäº†å¼€å‘æ­¥éª¤

```
.
â”œâ”€â”€ notebook
â”‚   â”œâ”€â”€ prediction-of-quality-of-wine.ipynb
â”‚   â””â”€â”€ prediction_API_test.ipynb           [c] <-consume API
â”œâ”€â”€ prediction_api
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api_utility.py                      [b] <-wrap up methods
â”‚   â”œâ”€â”€ main.py                             [b] <-modify demo
â”‚   â”œâ”€â”€ mock_data.py                        [e] <-Unit test
â”‚   â”œâ”€â”€ test_api_utility.py                 [e] <-Unit test
â”‚   â””â”€â”€ test_main.py                        [e] <-Unit test
â”œâ”€â”€ requirements.txt                        [a] <-FastAPI doc
.
.
.
```

**ä½†æ˜¯**(è¿˜æ˜¯é‚£å¥è¯ï¼Œåæ¶ˆæ¯é€šå¸¸ä»¥ BUT å¼€å¤´)å®ƒä»¬è¿˜åœ¨æˆ‘çš„**æœ¬åœ°**ç”µè„‘ä¸Šã€‚

å°½ç®¡æˆ‘ä»¬ä¸éœ€è¦ååœ¨åé¢ç‚¹å‡» Runï¼Œä½†æ˜¯ç”¨æˆ·è¯·æ±‚ä¸èƒ½åˆ°è¾¾ API ç«¯ç‚¹ã€‚å³ä½¿ä»–ä»¬è¿™æ ·åšäº†ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä¸èƒ½å…³é—­æˆ‘çš„ Macbookï¼Œè¿™æ„å‘³ç€å¦‚æœæœ‰è®¸å¤šä¼ å…¥çš„é¢„æµ‹è¯·æ±‚ï¼Œæˆ‘å°±ä¸èƒ½æ‰©å±•ğŸ˜±ï¼ï¼ï¼

æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ï¼Œé€ƒç¦»è¿™ä¸ªåœ°ç‹±çš„æ–¹æ³•æ˜¯ï¼Œè¦ä¹ˆè´­ä¹°å¦ä¸€å°è®¡ç®—æœºï¼Œè¦ä¹ˆä» AWS ç­‰äº‘æä¾›å•†é‚£é‡Œç§Ÿç”¨æœåŠ¡å™¨

ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¡®ä¿ä»£ç åœ¨é‚£é‡Œå·¥ä½œæ­£å¸¸ï¼æ€ä¹ˆä¼šï¼Ÿ

ç®€ç­”:Docker

**æ—ç™½:**

è™½ç„¶æˆ‘æ²¡æœ‰å°è¯•è¿‡ï¼Œä½†æœ‰ä¸€å®¶åä¸º [Cortex](https://docs.cortex.dev/) çš„åˆåˆ›å…¬å¸ä¸“æ³¨äºå¼€æºæœºå™¨å­¦ä¹  API æ¡†æ¶ï¼Œä»–ä»¬[ä¹Ÿåœ¨å¹•åä½¿ç”¨ FastAPI](/why-we-switched-from-flask-to-fastapi-for-production-machine-learning-765aab9b3679) ï¼

åˆ°ç°åœ¨ï¼Œä½ åº”è¯¥èƒ½ç†è§£ä»–ä»¬çš„æ•™ç¨‹äº†ï¼Œç®€è€Œè¨€ä¹‹ï¼Œä»–ä»¬åœ¨å¹•åè§£å†³äº†æ»šåŠ¨æ›´æ–°ã€DL æ¨¡å‹æ¨ç†ã€ä¸ AWS é›†æˆã€è‡ªåŠ¨ç¼©æ”¾ç­‰è®¸å¤šç”Ÿäº§å±‚é¢çš„é—®é¢˜â€¦â€¦è¿™äº›éƒ½æ˜¯ *DevOps* å…³å¿ƒçš„é—®é¢˜ï¼Ÿæˆ–è€…ç”¨ä¸€ä¸ªæ›´å¥½çš„æœ¯è¯­: *MLOps*

ä½†æ˜¯ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œä»–ä»¬ä½¿ç”¨å£°æ˜æ€§çš„ yml éƒ¨ç½² APIs ç±»ä¼¼äºæˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­é…ç½®æ¨¡å‹çš„æ–¹å¼]ï¼Œæœ‰ä¸€ä¸ªé¢„æµ‹å™¨ç±»[ç±»ä¼¼äºæˆ‘ä»¬çš„é¢„æµ‹å™¨ç±»]ï¼Œtrainer . py[ç±»ä¼¼äºä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„ train.py

ç¼–å†™ä»£ç ç›¸å¯¹å®¹æ˜“ï¼Œä½†æ˜¯ä¸ºä»£ç å†™ä¸€ç¯‡æ–‡ç« å´å¾ˆéš¾ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œä½ å¯ä»¥ç•™ä¸‹ä¸€äº›è¯„è®º

æˆ–è€…ä½ å¯ä»¥å¼€å§‹æˆ‘çš„[å›è´­](https://github.com/G-Hung/model-productization_article)ï¼

æˆ–è€…[æˆ‘çš„ LinkedIn](https://www.linkedin.com/in/geoffreyhung/) ã€æ¬¢è¿ä½†è¯·ç•™è¯è¡¨ç¤ºä½ ä¸æ˜¯åƒµå°¸ã€‘ï¼