<html>
<head>
<title>Inequality: How to plot a Lorenz curve with SQL, BigQuery, and Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不等式:如何用SQL、BigQuery和Data Studio绘制洛伦兹曲线</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/inequality-how-to-draw-a-lorenz-curve-with-sql-bigquery-and-data-studio-c70824b0748d?source=collection_archive---------21-----------------------#2020-01-24">https://towardsdatascience.com/inequality-how-to-draw-a-lorenz-curve-with-sql-bigquery-and-data-studio-c70824b0748d?source=collection_archive---------21-----------------------#2020-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/0c43720169258f79ae3a973925fa24fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZpNU856GFeVAWn_3tcRw0w.png"/></div></div></figure><div class=""/><div class=""><h2 id="b529" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">所有维基百科页面中排名前0.1%的页面获得了25%的浏览量。最底层的99%只获得了42%的浏览量。而底层的80% —只得到4%。这只是一个例子——在本帖中，我们将回顾如何获得这个数据集和任何其他数据集的这些数字。</h2></div><p id="1aaf" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们如何从SQL表中获取这些数字呢？</p><h1 id="8821" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">第0步:什么是BigQuery？</h1><p id="140e" class="pw-post-body-paragraph kq kr jb ks b kt me kc kv kw mf kf ky kz mg lb lc ld mh lf lg lh mi lj lk ll ij bi translated">如果这是您第一次使用BigQuery，请准备好体验一次有趣的旅程。看看这篇文章:</p><div class="ip iq gp gr ir mj"><a rel="noopener follow" target="_blank" href="/bigquery-without-a-credit-card-discover-learn-and-share-199e08d4a064"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">没有信用卡的BigQuery:发现、学习和分享</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">如果你在注册BigQuery时遇到了困难，不用担心——现在注册和开始使用比以往任何时候都容易</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">towardsdatascience.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx ix mj"/></div></div></a></div><h1 id="efe2" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">步骤1:您的数据、BigQuery和SQL</h1><p id="be34" class="pw-post-body-paragraph kq kr jb ks b kt me kc kv kw mf kf ky kz mg lb lc ld mh lf lg lh mi lj lk ll ij bi translated">首先，我们需要定义数据集。在这种情况下，它是2019年12月期间英文维基百科中的所有浏览量-在删除所有特殊页面后:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="2e60" class="nh ln jb nd b gy ni nj l nk nl">WITH wiki_prefixes AS (<br/>  SELECT ['File:', 'Draft:', 'Help:', 'en:', '...'] x<br/>)<br/>  <br/>, data AS (<br/>  SELECT *<br/>  FROM `fh-bigquery.wikipedia_extracts.201912_en_totals`<br/>  WHERE title NOT IN ('-', 'Main_Page')<br/>  AND (<br/>    title NOT LIKE '%:%'<br/>    OR REGEXP_EXTRACT(title, '[^:]*:') <br/>      NOT IN UNNEST((SELECT(x) FROM wiki_prefixes))<br/>  )<br/>)</span></pre><p id="ae1e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">您需要为此数据集中的每一行提供一个连续的行号，按页面浏览量排序:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="2927" class="nh ln jb nd b gy ni nj l nk nl">SELECT title, views, ROW_NUMBER() OVER (ORDER BY views) rn<br/>FROM data</span></pre><p id="8467" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在，您可以使用该行号将所有页面分成1，000个不同的存储桶:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="af43" class="nh ln jb nd b gy ni nj l nk nl">SELECT 1+fhoffa.x.int(rn/(SELECT (1+COUNT(*))/1000 FROM data)) bucket<br/>  , COUNT(*) pages<br/>  , SUM(views) views<br/>  , STRING_AGG(title ORDER BY views DESC LIMIT 3) sample_titles<br/>FROM (<br/>  SELECT title, views, ROW_NUMBER() OVER (ORDER BY views) rn<br/>  FROM data<br/>)<br/>GROUP BY 1</span></pre><p id="6d4f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">为了得到一个桶，我在第一行有一个子查询:<code class="fe nm nn no nd b">(SELECT (1+COUNT(*))/1000 FROM data)</code>。这得到了一个基于我的数据集中的总行数的数字，通过将每个行号除以这个值，我们得到了1k个不同的桶，从0到999。这些桶中的每一个都有其页面的<code class="fe nm nn no nd b">SUM(views)</code>，<code class="fe nm nn no nd b">STRING_AGG(title ORDER BY views DESC LIMIT 3)</code>用来保存一些样本标题以识别每个桶。</p><p id="f6dd" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在，我们将用一个新的查询来包围这个查询，该查询计算我们遍历1k个存储桶时的累计浏览量，以及所有这些页面的总浏览量:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="57e6" class="nh ln jb nd b gy ni nj l nk nl">SELECT SUM(views) OVER(ORDER BY bucket) cum_views<br/>  , SUM(views) OVER() total_views<br/>FROM (<br/>...<br/>)</span></pre><p id="3f96" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">获得每一行的累计值和总计值的方法是<code class="fe nm nn no nd b">OVER(ORDER BY bucket)</code>对仅仅是<code class="fe nm nn no nd b">OVER()</code>。</p><p id="592e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">下一步:获取视图的累积数量，然后除以总数:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="0049" class="nh ln jb nd b gy ni nj l nk nl">SELECT ROUND(100*cum_views/total_views,3) cum_percent<br/>FROM (<br/>  ...<br/>)</span></pre><p id="f8d3" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在我们有了一个可以在Data Studio中绘制的累计百分比。让我们将所有内容放在一起，创建一个新表:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="f5f6" class="nh ln jb nd b gy ni nj l nk nl">CREATE TABLE `wikipedia_extracts.201912_lorenz_curve`<br/>AS<br/>WITH wiki_prefixes AS (SELECT ['File:', 'Talk:', 'Template_talk:', 'Wikipedia:', 'Category:', 'User_talk:', 'Page:', 'Template:', 'Category_talk:' , 'User:', 'Author:', 'Portal:', 'Wikipedia_talk:', 'Portal_talk:', 'File_talk:', 'Draft:', 'Help:', 'Draft_talk:', 'en:', 'Book_talk:', 'Module:', 'MOS:', 'Special:', 'Book:'] x)<br/>  <br/>, data AS (<br/>  SELECT *<br/>  FROM `fh-bigquery.wikipedia_extracts.201912_en_totals`<br/>  WHERE title NOT IN ('-', 'Main_Page')<br/>  AND (<br/>    title NOT LIKE '%:%'<br/>    OR REGEXP_EXTRACT(title, '[^:]*:') NOT IN UNNEST((SELECT(x) FROM wiki_prefixes))<br/>  )<br/>)</span><span id="89ad" class="nh ln jb nd b gy np nj l nk nl">SELECT ROUND(100*cum_views/total_views,3) cum_percent, *<br/>FROM (<br/>  SELECT SUM(views) OVER(ORDER BY bucket) cum_views, *, SUM(views) OVER() total_views<br/>  FROM (<br/>    SELECT 1+fhoffa.x.int(rn/(SELECT (1+COUNT(*))/1000 FROM data)) bucket, COUNT(*) pages, SUM(views) views<br/>      , STRING_AGG(title ORDER BY views DESC LIMIT 3) sample_titles<br/>    FROM (<br/>      SELECT title, views, ROW_NUMBER() OVER (ORDER BY views) rn<br/>      FROM data<br/>    )<br/>    GROUP BY 1<br/>  ) <br/>)</span><span id="3293" class="nh ln jb nd b gy np nj l nk nl"># 34.1 sec elapsed, 805.8 MB processed)</span></pre><figure class="my mz na nb gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/9efc25c396386f59ead8173d7872392b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Jj6HWANfUBONeXkmEd_1w.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">存储桶#991到#1000，前1%</p></figure><h1 id="0bb8" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">步骤2:在Data Studio中可视化</h1><p id="be5f" class="pw-post-body-paragraph kq kr jb ks b kt me kc kv kw mf kf ky kz mg lb lc ld mh lf lg lh mi lj lk ll ij bi translated">转到刚刚在BigQuery中创建的新表，按照以下步骤操作:</p><blockquote class="nv nw nx"><p id="b54a" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">使用Data Studio探索</p><p id="5317" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→保存</p><p id="6d95" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→创建新报告并共享</p></blockquote><div class="my mz na nb gt ab cb"><figure class="oc is od oe of og oh paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/6ddcc6537973a5e52fb2db8b27cad26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:422/format:webp/1*SOrDtFqBDY9tXzzIoJUCSA.png"/></div></figure><figure class="oc is oi oe of og oh paragraph-image"><img src="../Images/fdeac22582a0db3e6be00e489d415e5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:322/format:webp/1*nPAz4X8B8s_yQzmqfXdqFQ.png"/></figure><figure class="oc is oj oe of og oh paragraph-image"><img src="../Images/8858878cd1c31d8ac81f1b86560ace13.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/format:webp/1*Fm-vzWfT__5TFe9y4c-6wA.png"/><p class="nr ns gj gh gi nt nu bd b be z dk ok di ol om translated">使用Data Studio浏览→保存→创建新报告并共享</p></figure></div><blockquote class="nv nw nx"><p id="d93f" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→添加到报告中</p><p id="6988" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→添加图表</p><p id="4564" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→分散</p><p id="a258" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated">→ X:时段Y:累计百分比</p></blockquote><figure class="my mz na nb gt is gh gi paragraph-image"><div class="gh gi on"><img src="../Images/bffad2aa26a446961ede49c4f36ea1b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:316/format:webp/1*3iCyVUEptqH-Xe-K-BXIeQ.png"/></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">添加到报表→添加图表→散点图→ X:时段Y:累计百分比</p></figure><p id="491e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这就是如何使用Data Studio和BigQuery通过几个步骤获得漂亮的洛伦兹曲线:</p><figure class="my mz na nb gt is"><div class="bz fp l di"><div class="oo op l"/></div><p class="nr ns gj gh gi nt nu bd b be z dk translated"><a class="ae oq" href="https://datastudio.google.com/s/orrjF5Dsv6Y" rel="noopener ugc nofollow" target="_blank">互动数据工作室报告</a></p></figure><h1 id="8b18" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">笔记</h1><p id="244d" class="pw-post-body-paragraph kq kr jb ks b kt me kc kv kw mf kf ky kz mg lb lc ld mh lf lg lh mi lj lk ll ij bi translated">维基百科刚刚公布了他们的第600万篇文章，在这份报告中，我们统计了超过1100万页。这份报告是基于维基百科报告每小时的页面浏览量，来自他们的日志(加载在BigQuery中)——这些查询已经删除了我能找到的大多数“特殊”页面。<a class="ae oq" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank">如果你知道更好的清理这些日志的方法，请告诉我。</a></p><p id="335c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">为了平衡这一点，我没有计算任何在12月份获得0浏览量的页面——我们在这里查看浏览量日志，所以零不会出现。</p><div class="ip iq gp gr ir mj"><a href="https://en.wikipedia.org/wiki/Wikipedia:Six_million_articles" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">维基百科:六百万篇文章</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">英语维基百科已经有600万篇文章，作者是19世纪加拿大学校的玛丽亚·伊莉斯·特纳·劳德…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">en.wikipedia.org</p></div></div><div class="ms l"><div class="or l mu mv mw ms mx ix mj"/></div></div></a></div><div class="ip iq gp gr ir mj"><a href="https://en.m.wikipedia.org/wiki/Wikipedia:What_is_an_article%3F" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">维基百科:什么是文章？</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">“文章”属于维基百科页面的主命名空间(也称为“文章命名空间”或简称“主空间”)…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">en.m.wikipedia.org</p></div></div></div></a></div><div class="ip iq gp gr ir mj"><a href="https://en.wikipedia.org/wiki/Pareto_distribution" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">帕累托分布</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">以意大利土木工程师、经济学家和社会学家维尔弗雷多·帕累托[1]的名字命名的帕累托分布是一种…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">en.wikipedia.org</p></div></div><div class="ms l"><div class="os l mu mv mw ms mx ix mj"/></div></div></a></div><div class="ip iq gp gr ir mj"><a href="https://en.wikipedia.org/wiki/Lorenz_curve" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">罗伦兹曲线</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">在经济学中，洛伦茨曲线是收入或财富分布的图形表示。那是…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">en.wikipedia.org</p></div></div><div class="ms l"><div class="ot l mu mv mw ms mx ix mj"/></div></div></a></div><blockquote class="nv nw nx"><p id="193e" class="kq kr ny ks b kt ku kc kv kw kx kf ky nz la lb lc oa le lf lg ob li lj lk ll ij bi translated"><a class="ae oq" href="https://en.wikipedia.org/wiki/Lorenz_curve" rel="noopener ugc nofollow" target="_blank">洛伦兹曲线</a>是一个图表，显示了底层<em class="jb"> x </em> %的人承担的总收入或财富的比例，尽管这对于有限的人口来说并不严格成立(见下文)。它通常用于表示收入分配，显示底层家庭占总收入的百分比。家庭的百分比标绘在x轴上，收入的百分比标绘在y轴上。它也可以用来显示资产的分布。在这种用法中，许多经济学家认为它是衡量社会不平等的一种手段。</p></blockquote><h1 id="7428" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">后续步骤</h1><ul class=""><li id="a739" class="ou ov jb ks b kt me kw mf kz ow ld ox lh oy ll oz pa pb pc bi translated">要用BigQuery计算基尼系数，查看来自<a class="pd pe ep" href="https://medium.com/u/b6a4cbbd2e57?source=post_page-----c70824b0748d--------------------------------" rel="noopener" target="_blank"> Evgeny Medvedev </a>的帖子:</li></ul><div class="ip iq gp gr ir mj"><a href="https://medium.com/google-cloud/calculating-gini-coefficient-in-bigquery-3bc162c82168" rel="noopener follow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">在BigQuery中计算基尼系数</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">下面是在给定每日余额的情况下输出每天的基尼系数的查询:</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">medium.com</p></div></div><div class="ms l"><div class="pf l mu mv mw ms mx ix mj"/></div></div></a></div><ul class=""><li id="8462" class="ou ov jb ks b kt ku kw kx kz pg ld ph lh pi ll oz pa pb pc bi translated">要通过BigQuery和Data Studio 互动查看<a class="ae oq" rel="noopener" target="_blank" href="/interactive-the-top-2019-wikipedia-pages-d3b96335b6ae">2019年顶级维基百科浏览量，请查看我的帖子:</a></li></ul><div class="ip iq gp gr ir mj"><a rel="noopener follow" target="_blank" href="/interactive-the-top-2019-wikipedia-pages-d3b96335b6ae"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd jc gy z fp mo fr fs mp fu fw ja bi translated">互动:2019年维基百科页面排行榜</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">维基媒体公布了他们2019年最受欢迎的页面——但我们能更深入吗？当然，这里有BigQuery和…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">towardsdatascience.com</p></div></div><div class="ms l"><div class="pj l mu mv mw ms mx ix mj"/></div></div></a></div><h1 id="5e0f" class="lm ln jb bd lo lp lq lr ls lt lu lv lw kh lx ki ly kk lz kl ma kn mb ko mc md bi translated">想要更多吗？</h1><p id="6b19" class="pw-post-body-paragraph kq kr jb ks b kt me kc kv kw mf kf ky kz mg lb lc ld mh lf lg lh mi lj lk ll ij bi translated">我是Felipe Hoffa，谷歌云的开发者倡导者。在<a class="ae oq" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank"> @felipehoffa </a>上关注我，在【medium.com/@hoffa】的<a class="ae oq" href="https://medium.com/@hoffa" rel="noopener">上找到我之前的帖子</a>，在<a class="ae oq" href="https://reddit.com/r/bigquery" rel="noopener ugc nofollow" target="_blank">的【reddit.com/r/bigquery】上找到所有关于BigQuery的帖子</a>。</p></div></div>    
</body>
</html>