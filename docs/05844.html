<html>
<head>
<title>SQL-like window functions in Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pandas 中类似 SQL 的窗口函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-window-functions-in-python-pandas-data-science-dc7c7a63cbb4?source=collection_archive---------6-----------------------#2020-05-14">https://towardsdatascience.com/sql-window-functions-in-python-pandas-data-science-dc7c7a63cbb4?source=collection_archive---------6-----------------------#2020-05-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0c7a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">所有熊猫窗口功能的单一位置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5b6dccc9efc61802a083ee011cdc6619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1A9Y7son_0U0bNqC"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/s/photos/row-number?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@waldemarbrandt67w?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Waldemar Brandt </a>拍照</p></figure><p id="f82d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 SQL 世界中，窗口函数非常强大。然而，没有一个写得很好的和统一的熊猫的地方。在熊猫网站的<a class="ae ky" href="https://pandas.pydata.org/docs/getting_started/comparison/comparison_with_sql.html" rel="noopener ugc nofollow" target="_blank">上非常详细地介绍了用熊猫编写类似 SQL 代码的基础知识。然而，Pandas 指南缺乏对 SQL 及其 Pandas 对等物的分析应用程序的良好比较。</a></p><p id="b50a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将介绍一些窗口函数的 SQL 等价物，并带你了解熊猫的窗口函数。</p><h1 id="73bf" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">。groupby 是你的朋友</h1><p id="2d22" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果你做大数据分析，并且发现自己需要使用 Pandas，那么可能很难从富有表现力的 SQL 语言过渡到 Pandas 的数据操作方式。</p><p id="7bf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我打算这篇文章简短而甜蜜，主要关注实现的战术方面，而不是细节。这篇文章假设你熟悉窗口和分区函数。让我们把最常见的 SQL 分析函数翻译成熊猫。</p><h2 id="73ec" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">每个组(分区)中的行号</h2><p id="1786" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Pandas 相当于每个分区中的行号，带有多个 sort by 参数:</p><blockquote class="ne nf ng"><p id="9f6c" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">SQL:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="8adc" class="ms lw it nm b gy nq nr l ns nt">ROW_NUMBER() over (PARTITION BY ticker ORDER BY date DESC) as days_lookback<br/>---------<br/>ROW_NUMBER() over (PARTITION BY ticker, exchange ORDER BY date DESC, period) as example_2</span></pre><blockquote class="ne nf ng"><p id="0ccb" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">熊猫:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="ea72" class="ms lw it nm b gy nq nr l ns nt">df['<!-- -->days_lookback<!-- -->'] = df.sort_values(['<!-- -->date<!-- -->'], ascending=False)\<br/>             .groupby(['<!-- -->ticker<!-- -->'])\<br/>             .cumcount() + 1<br/>---------<br/>df['<!-- -->example_2<!-- -->'] = df.sort_values(['<!-- -->date<!-- -->', '<!-- -->period'<!-- -->], \<br/>             ascending=[False, True])\<br/>             .groupby(['<!-- -->ticker<!-- -->', '<!-- -->exchange'<!-- -->])\<br/>             .cumcount() + 1</span></pre><h2 id="943a" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">每个组(分区)中的最后/下一个记录</h2><p id="6eac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">熊猫相当于超前和滞后窗口功能:</p><blockquote class="ne nf ng"><p id="0733" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">SQL:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="9e9f" class="ms lw it nm b gy nq nr l ns nt">LAG(price) over (PARTITION BY ticker ORDER BY date) as last_day_px<br/>---------<br/>LEAD(price) over (PARTITION BY ticker ORDER BY date) as next_day_px</span></pre><blockquote class="ne nf ng"><p id="7651" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">熊猫:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="ddd9" class="ms lw it nm b gy nq nr l ns nt">df['<!-- -->last_day_px<!-- -->'] = df.sort_values(by=['date'], ascending=True)\<br/>                       .groupby(['<!-- -->ticker<!-- -->'])['<!-- -->price<!-- -->'].shift(1)<br/>---------<br/>df['<!-- -->next_day_px<!-- -->'] = df.sort_values(by=['date'], ascending=True)\<br/>                       .groupby(['<!-- -->ticker<!-- -->'])['<!-- -->price<!-- -->'].shift<strong class="nm iu">(-1)</strong></span></pre><h2 id="18a9" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">各组内的百分位数等级</h2><p id="f4eb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">百分比等级/密集等级或等级窗口函数的 Pandas 等价物:</p><blockquote class="ne nf ng"><p id="92cb" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">SQL:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="e44b" class="ms lw it nm b gy nq nr l ns nt">PERCENT_RANK() OVER (PARTITION BY ticker, year ORDER BY price) as <!-- -->perc_price</span></pre><blockquote class="ne nf ng"><p id="e74a" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">熊猫:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="9785" class="ms lw it nm b gy nq nr l ns nt">df['perc_price'] = df.groupby(['ticker', 'year'])['price']\<br/>                        .rank(pct=True)</span></pre><h2 id="0332" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">每组内的运行总和</h2><p id="1228" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Pandas 相当于滚动求和、运行求和、求和窗口函数:</p><blockquote class="ne nf ng"><p id="6cd9" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">SQL:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="3324" class="ms lw it nm b gy nq nr l ns nt">SUM(trade_vol) OVER (PARTITION BY ticker ORDER BY date ROWS BETWEEN 3 PRECEEDING AND CURRENT ROW) as volume_3day<br/>---------<br/>SUM(trade_vol) OVER (PARTITION BY ticker ORDER BY date ROWS BETWEEN UNBOUNDED PRECEEDING AND CURRENT ROW) as cum_total_vol<br/>---------<br/>SUM(trade_vol) OVER (PARTITION BY ticker) as total_vol</span></pre><blockquote class="ne nf ng"><p id="7aa9" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">熊猫:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="4812" class="ms lw it nm b gy nq nr l ns nt">df['volume_3day'] = df.sort_values(by=['date'], ascending=True)\<br/>                       .groupby(['ticker'])['trade_vol']\<br/>                       .rolling(3, min_periods = 1).sum()\<br/>                       .reset_index(drop=True, level=0)<br/>---------<br/>df['<!-- -->cum_total_vol<!-- -->'] = df.sort_values(<!-- -->by=['date'], ascending=True<!-- -->)\<br/>                       .groupby(['ticker'])['trade_vol']\<br/>                       .cumsum()<br/>---------<br/>df['total_vol'] = df.groupby(['ticker', 'year'])['trade_vol']\<br/>                        .transform('sum')</span></pre><h2 id="d853" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">每组内的平均值</h2><p id="9f5c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Pandas 相当于平均线、移动平均线(移动平均线)窗口函数:</p><blockquote class="ne nf ng"><p id="39a2" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">SQL:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="88e6" class="ms lw it nm b gy nq nr l ns nt">AVG(trade_vol) OVER (PARTITION BY ticker) as avg_trade_vol,<br/>---------<br/>AVG(price) OVER (PARTITION BY ticker ORDER BY date ROWS BETWEEN 19 PRECEDING AND CURRENT ROW) as ma20</span></pre><blockquote class="ne nf ng"><p id="fa85" class="kz la nh lb b lc ld ju le lf lg jx lh ni lj lk ll nj ln lo lp nk lr ls lt lu im bi translated">熊猫:</p></blockquote><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="3209" class="ms lw it nm b gy nq nr l ns nt">df['avg_trade_vol'] = df.groupby(['ticker', 'year'])['trade_vol']\<br/>                        .transform('mean')<br/>---------<br/>df['ma20'] = df.sort_values(by=['date'], ascending=True)\<br/>                    .groupby('ticker')['price']\<br/>                    .rolling(20, min_periods = 1).mean()\<br/>                    .reset_index(drop=True, level=0)</span></pre></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="6e53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/groupby.html#transformation" rel="noopener ugc nofollow" target="_blank"> <em class="nh">。transform </em> </a> <em class="nh"> </em>是 Pandas 中一个强大的命令，我邀请您在这里了解更多信息——</p><div class="ob oc gp gr od oe"><a rel="noopener follow" target="_blank" href="/pandas-groupby-aggregate-transform-filter-c95ba3444bbb"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd iu gy z fp oj fr fs ok fu fw is bi translated">熊猫小组详细解释了</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">了解如何掌握所有熊猫的分组功能，如聚集(聚合)，转换和过滤-代码指南…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">towardsdatascience.com</p></div></div><div class="on l"><div class="oo l op oq or on os ks oe"/></div></div></a></div><p id="4984" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！上面的例子应该给你提供了一个 Pandas 窗口函数的参考。</p><p id="29e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为便于测试，上述示例的数据集示例如下:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="9c3e" class="ms lw it nm b gy nq nr l ns nt">import pandas as pd<br/>data = {<br/>    'year':[2019, 2019, 2020, 2020, 2020, 2020, 2019, 2020, 2020, 2020],<br/>    'date':['2019-12-30', '2019-12-31', '2020-01-02', '2020-01-03', '2020-01-06', '2020-01-07', '2019-12-31', '2020-01-02', '2020-01-03', '2020-01-06'],<br/>    'ticker':['BYND', 'BYND', 'BYND', 'BYND', 'BYND', 'BYND', 'FB', 'FB', 'FB', 'FB'],<br/>    'exchange':['Q', 'Q', 'Q', 'Q', 'Q', 'Q', 'N', 'N', 'N', 'N'],<br/>    'price':[74.15, 75.60, 75.64, 75.41, 74.59, 83.89, 205.25, 209.78, 208.67, 212.60],<br/>    'trade_vol':[2548100, 2002000, 2221700, 1628700, 2324700, 12044600, 8953500, 12077100, 11188400, 17058900],<br/>}<br/>df = pd.DataFrame(data)</span></pre></div></div>    
</body>
</html>