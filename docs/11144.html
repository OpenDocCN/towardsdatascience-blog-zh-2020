<html>
<head>
<title>Introduction to hierarchical modeling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分层建模简介</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-hierarchical-modeling-a5c7b2ebb1ca?source=collection_archive---------9-----------------------#2020-08-03">https://towardsdatascience.com/introduction-to-hierarchical-modeling-a5c7b2ebb1ca?source=collection_archive---------9-----------------------#2020-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="86b1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用贝叶斯分层模型对自然聚集的数据建模</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/796c958a9f6e66cada5a1a992234a9a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nHlkKm96-nHjMvA7J52TcQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此分析中不同组之间的系数分布</p></figure><h1 id="f9c8" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">介绍</h1><p id="39f6" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在我们的数据集中发现不完全独立的样本并不罕见。数据集中的样本通常形成聚类或组，在这些聚类或组中共享一些属性。这通常需要在建模时特别注意，以构建可靠的模型，原因有两个。首先，对于像最大似然估计这样的统计分析过程，样本的独立性是一个重要的假设。第二，我们希望在我们的模型中捕捉预测因素对不同群体的影响的变化，这种变化被称为背景效应。</p><p id="c273" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">一个常用的例子，我发现足以理解这种情况是学生在学校的表现。在有多个班级学生的学校里，学生的学业表现受到他们个人能力(称为固定效应)和他们所在班级(称为随机效应)的影响。也许被分配到某个班级的老师比其他人教得更好，或者班级中高比例的聪明学生为学生创造了一个竞争环境，让他们表现得更好。</p><p id="92d2" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">处理这种情况的一种方法是为每个类构建多个模型，称为<strong class="ls iu">池</strong>。但是这种方法并不总能产生可靠的结果。比如学生很少的班级对应的模型，会很误导人。一个单独的<strong class="ls iu">非 pooled </strong>模型可能无法充分拟合数据。我们想在这两个极端之间找到一个折中的中间地带——部分统筹。这就把我们带到了<strong class="ls iu">贝叶斯分层建模，</strong>也称为多级建模。</p><p id="0fbd" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在这种方法中，参数在不同级别的组中相互嵌套。粗略地说，它给出了未汇集和汇集模型估计的加权平均值。分层建模是贝叶斯推理和统计建模中最强大而简单的技术之一。在这篇文章中，我将用一个实际的例子来介绍这个想法。注意，这篇文章并没有涉及贝叶斯分析的基础。该示例的源代码可以在<a class="ae mr" href="https://github.com/SuryaThiru/hierarchical-model-blog" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的笔记本中找到。</p><h1 id="590b" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">数据</h1><p id="08e4" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">用于说明的数据集类似于上面的学生示例，只是我们试图找到来自不同学校的学生的数学成绩。在我们的例子中，我们使用作业完成情况作为预测指标。你可以在这里找到原始数据<a class="ae mr" href="https://stats.idre.ucla.edu/stat/examples/imm/imm10.dta" rel="noopener ugc nofollow" target="_blank">，在这里</a>找到 csv 版本<a class="ae mr" href="https://github.com/SuryaThiru/hierarchical-model-blog/blob/master/mlmldata.csv" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="ddf7" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">第一眼</h1><p id="97d7" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">绘制学生相对于家庭作业的数学成绩，以及<strong class="ls iu">的未拟合</strong>的 OLS 回归拟合给了我们这个结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/46d81c458e22847de3fcb9060e7bc973.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*gVjMdU4z5p8J9usBflRBoQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">具有非 pooled 回归拟合的数据样本</p></figure><p id="cdb7" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">可视化学校层面的数据揭示了一些有趣的模式。我们还绘制了适合每个学校的<strong class="ls iu">汇集的</strong>回归线和未汇集的回归线，以供参考。为了简单起见，我们使用 OLS 回归。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/4444f174c46ef64b3434fce88b844f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kJxp4vuJBK0t-HBTqegHDw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">合并回归的数据样本适合不同的组</p></figure><p id="b3c0" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">该图显示了各组之间关系的变化。我们还注意到，在某些组中，作业完成率较高的少数数据点(可能的异常值)对估计值有很大影响。</p><h1 id="a9e4" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated"><strong class="ak">层次模型</strong></h1><p id="ace5" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我们将使用 PyMC3 构建我们的贝叶斯层次模型。我们将在我们的组级参数上构建<strong class="ls iu">超优先级</strong>，以允许模型在组间共享学生的个人属性。</p><p id="9454" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">该模型可以表示为 yᵢ = αⱼᵢ + βⱼᵢxᵢ + εᵢ，</p><p id="f018" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">或者用概率符号表示为 y∞n(αⱼ+βⱼx，ε)。</p><p id="329e" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">对于这个模型，我们将使用随机斜率β和截距α。这意味着它们将随每组而变化，而不是整个数据的恒定斜率和截距。概率模型的图示如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/94b23f09793ba433acba997c7eeceb62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QxAXLmkRX00KfOCDe53dAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本例中使用的分层模型的图形表示</p></figure><p id="8d5d" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">虽然我在这里通过目测样本的总体分布来选择我的先验，但是使用无信息的先验也会导致类似的结果。下面的代码片段定义了所使用的 PyMC3 模型。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="19f0" class="na kz it mw b gy nb nc l nd ne">with pm.Model() as model:<br/>    # Hyperpriors<br/>    mu_a = pm.Normal('mu_a', mu=40, sigma=50)<br/>    sigma_a = pm.HalfNormal('sigma_a', 50)<br/>    <br/>    mu_b = pm.Normal('mu_b', mu=0, sigma=10)<br/>    sigma_b = pm.HalfNormal('sigma_b', 5)<br/>    <br/>    # Intercept<br/>    a = pm.Normal('a', mu=mu_a, sigma=sigma_a, shape=n_schools)</span><span id="37a8" class="na kz it mw b gy nf nc l nd ne">    # Slope<br/>    b = pm.Normal('b', mu=mu_b, sigma=sigma_b, shape=n_schools)<br/>    <br/>    # Model error<br/>    eps = pm.HalfCauchy('eps', 5)<br/>    <br/>    # Model<br/>    y_hat = a[school] + b[school] * homework<br/>    <br/>    # Likelihood<br/>    y_like = pm.Normal('y_like', mu=y_hat, sigma=eps, observed=math)</span></pre><p id="40e7" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们将使用 NUTS 采样器从后验分布中抽取样本。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="460e" class="na kz it mw b gy nb nc l nd ne">with model:<br/>    step = pm.NUTS()<br/>    trace = pm.sample(2000, tune=1000)</span></pre><p id="7f15" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">对应于每个学校的轨迹图以及斜率和截距的后验分布如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/ee1903ea6ffb0335c59336612df56554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6cqM5KQUmIdoYbcVeF599Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">分层模型的轨迹图</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/da7b2a8fd70d5f07729af5e1c5f26484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*kIPHNC9zjcJfEcH6HAhmVg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">每组截距和斜率的后验分布</p></figure><p id="9bf0" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们可以看到不同学校系数估计值的差异。我们还可以清楚地解释与分布估计相关的不确定性。下面的后验预测回归(灰色)线是从每组估计值的后验分布中取样的，给出了关于数据的模型的更好的图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/326c4ed64e43fa5aba73ec62da5f820b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T-Ry_iiCoOFN7ytL_TpLcg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">分层模型的后验预测拟合</p></figure><p id="60ea" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">请注意，显示负斜率的组通常具有更高的不确定性。该模型在群体级别的噪声敏感度和学生级别的全局估计值之间找到了一个折衷点(在 IDs 7472、7930、25456、25642 中很明显)。这意味着我们必须对从这些群体的模型中得出的决定更加谨慎。我们还观察到，随着更多的数据和更小的偏差，贝叶斯模型收敛到该组(ID 62821)的 OLS 模型，如预期的那样。我们还可以通过绘制从<code class="fe ni nj nk mw b">mu_a</code>到<code class="fe ni nj nk mw b">mu_b</code>的回归线来检查学生级别关系(这里我省略了)。</p><p id="6220" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">不同模型的交叉验证将显示层次建模方法的优越性。交叉验证可以在两个级别执行:</p><ol class=""><li id="c01d" class="nl nm it ls b lt mm lw mn lz nn md no mh np ml nq nr ns nt bi translated">在一个小组中找出学生，并根据其预测进行评估。</li><li id="6929" class="nl nm it ls b lt nu lw nv lz nw md nx mh ny ml nq nr ns nt bi translated">支持整个团队并评估其预测。请注意，这在池模型中是不可能的。</li></ol><p id="b368" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我在这里不进行验证，因为这里使用的频率主义者和贝叶斯模型不能进行公平(或简单)的比较。但是 CV 可以通过用贝叶斯线性回归代替 OLS 回归并比较它们的模型的均方根偏差(RMSD)来执行。</p><h1 id="004e" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">结论</h1><p id="bb7f" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">贝叶斯分层建模可以用自然聚集的数据产生健壮的模型。它们通常允许我们建立简单和可解释的模型，而不是像集成或神经网络这样常用于这种复杂数据的频繁技术。尽管模型中的参数数量增加了，它们也防止了过度拟合。这篇文章仅仅是对层次模型的介绍，其固有的简单性允许我们实现特定于我们的数据的模型的不同变体(例如:添加子组，使用更多的组级预测器)并进行不同类型的分析(例如:寻找级别之间的相关性)。</p><h1 id="c132" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">资源</h1><div class="nz oa gp gr ob oc"><a href="https://docs.pymc.io/notebooks/GLM-hierarchical.html" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd iu gy z fp oh fr fs oi fu fw is bi translated">GLM:分级线性回归- PyMC3 3.8 文档</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">本教程改编自达内·埃尔伯斯和托马斯·威奇的博客文章《两全其美…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">docs.pymc.io</p></div></div><div class="ol l"><div class="om l on oo op ol oq ks oc"/></div></div></a></div><div class="nz oa gp gr ob oc"><a href="https://docs.pymc.io/notebooks/GLM.html" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd iu gy z fp oh fr fs oi fu fw is bi translated">pymc 3-pymc 3.8 文档中的(广义)线性和分层线性模型</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">让我们生成一些斜率已知的数据，截取并拟合一个简单的线性 GLM。glm.linear_component()函数…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">docs.pymc.io</p></div></div></div></a></div><div class="nz oa gp gr ob oc"><a href="https://mc-stan.org/docs/2_24/stan-users-guide/hierarchical-logistic-regression.html" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd iu gy z fp oh fr fs oi fu fw is bi translated">1.9 分层逻辑回归| Stan 用户指南</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">最简单的多级模型是分层模型，其中数据被分组到不同的类别(或…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">mc-stan.org</p></div></div></div></a></div><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="3a99" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">A.Gelman 等人，《贝叶斯数据分析》(2013 年)，第 5 章，CRC 出版社</p></div><div class="ab cl ot ou hx ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="im in io ip iq"><p id="ad7d" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">感谢您的阅读！我将感谢任何关于这个帖子的反馈。</p><p id="7412" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">你可以在<a class="ae mr" href="https://www.linkedin.com/in/surya-krishnamurthy/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>上联系我，在<a class="ae mr" href="https://github.com/SuryaThiru" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上关注我。</p></div></div>    
</body>
</html>