# 使用深度学习从 X 射线图像中检测由 NCOV-19 引起的肺炎

> 原文：<https://towardsdatascience.com/using-deep-learning-to-detect-ncov-19-from-x-ray-images-1a89701d1acd?source=collection_archive---------9----------------------->

## 开发一个初步的诊断模型，有可能对抗疫情病毒

![](img/802e8d7236a59dc07c2d3ffed828253b.png)

[左图:新冠肺炎正面 x 光片。](https://radiopaedia.org/cases/covid-19-pneumonia-14) [右图:链球菌感染。](https://radiopaedia.org/cases/streptococcus-pneumoniae-pneumonia-temporal-evolution-1)(均以 CC-NC-SA 授权)。两幅图像都显示肺炎。什么能把他们区分开来？图像是作为正在建设的[开源数据集的一部分收集的。](https://github.com/ieee8023/covid-chestxray-dataset)

3 月 11 日，在本文撰写的四天前，世界卫生组织(W.H.O .)宣布冠状病毒疾病 2019 (NCOV-19)为疫情，其特征是这种新型冠状病毒在全球范围内快速和全球性传播。由于各国政府争相关闭边境，实施接触者追踪，并提高个人卫生意识，以努力控制病毒的传播，不幸的是，由于每个国家实施这些政策的标准不同，在开发和部署疫苗之前，预计病毒的传播仍会增加。

由于预计全球每天的实际病例将会增加，限制诊断的一个重要因素是病毒病理学测试的持续时间，这些测试通常在市中心的实验室进行，需要耗时的精确度。这导致了严重的问题，主要是携带者不能更早地被隔离，因此他们能够在无限制流动的关键时期感染更多的人。另一个问题是当前诊断程序的高成本大规模实施。可以说，最脆弱的是发展中国家偏远地区的人们，他们通常拥有较差的医疗保健和诊断服务。单一感染可能对这些社区有害，获得诊断至少会给他们对抗病毒的机会。

![](img/dcc7f04bbb83fc37ece7a8bf04d12117.png)![](img/27847ce4389326b557a16b8e758a72f2.png)

城市和农村地区的差别不仅仅在于人口数量，还在于获得医疗资源的机会。在疫情的这个时代，这种接触的缺乏可能是致命的。(左:[高波](https://www.flickr.com/photos/gaobo/) via [Flickr](https://www.flickr.com/photos/gaobo/3259978197/) 。右:[danboard](https://www.flickr.com/photos/danboarder/)via[Flickr](https://www.flickr.com/photos/41894167721@N01/3365071856/))(都被-NC-ND 2.0 授权为 CC)

[王等人的一项新研究。艾尔。](https://www.medrxiv.org/content/10.1101/2020.02.14.20023028v3)展示了在计算机断层扫描(CT)扫描中使用深度学习来扫描新冠肺炎的前景，[并且它已经被推荐为预先存在的诊断系统的实用组件。](https://pubs.rsna.org/doi/10.1148/radiol.2020200490)该研究在 1，119 次 CT 扫描中使用了初始卷积神经网络(CNN)的迁移学习。该模型的内部和外部验证准确率分别为 89.5%和 79.3%。主要目标是允许模型提取新冠肺炎的放射性特征。

虽然这项研究在他们的模型上取得了惊人的准确性，但我决定使用不同的架构来训练和实现一个模型，希望提高准确性。我决定使用胸片图像(CXR)而不是 CT 扫描，原因有三:

1.  **对人们来说，接受 CXRs 比接受 CT 扫描更容易，尤其是在农村和偏远地区。还会有更多的潜在数据可用。**
2.  **在放射科医生和医疗专业人员无法控制病毒的情况下(例如，如果他们自己生病)，人工智能系统对于继续实施诊断至关重要。**
3.  **当该模型生效时，它可以通过测试初始阴性病例来最小化现有基于实验室的诊断中的假 negatives⁴问题。**

与作为诊断来源的 CT 扫描相比，使用 CXRs 的主要障碍是缺乏来自新冠肺炎的可以视觉验证的细节。很难看到新冠肺炎症状，如肺结节，这在 CT 扫描中很容易看到。我想测试一个有足够层数的模型是否能检测出质量较低但更实用的图像中的特征。因此，我的模型是一个关于 Resnet CNN 模型是否可以使用相对便宜的 cxr 有效检测新冠肺炎的概念验证。

新冠肺炎肺部扫描数据集目前是有限的，但我发现的最好的数据集，我用于这个项目，来自新冠肺炎开源数据集。它包括从公开可用的研究中废弃的新冠肺炎图像，以及不同肺炎引起的疾病(如 SARS、链球菌和肺囊虫)的肺部图像。**如果你有任何知识库可以接受的合适的扫描图像，以及它们的引用和元数据，** [**请贡献**](https://josephpcohen.com/w/) **来建立数据集，以改善依赖它的人工智能系统。**

我只训练我的模型查看 cxr 的**后前视图(PA)** ，这是最常见的 x 射线扫描类型。我在一台 [Resnet 50 CNN model](https://www.mathworks.com/help/deeplearning/ref/resnet50.html) 上使用了迁移学习(我的损失在 Resnet 34 上的几个时代后爆发)，我总共使用了 339 张图像进行训练和验证。所有的实现都是使用 fastai 和 Pytorch 完成的。

![](img/6e46089f1bca9a59a68c585e775e5dc8.png)

预期警告:由于缺乏新冠肺炎图像，数据严重失真。数据被随机分成 25%后拍摄。测试集从一开始就设置为 78。图片作者。

在撰写本文时，由于缺乏可用的公共数据，数据严重失真(新冠肺炎有 35 张图像，非新冠肺炎有 226 张图像，包括正常和患病肺的图像)。我决定将所有非新冠肺炎图像组合在一起，因为我只有不同疾病的稀疏图像。在将数据随机分成 25%之前，我继续使用来自这个 [Kaggle 数据集](https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia)的健康肺部的 x 射线图像来增加标记为“其他”的 x 射线扫描的大小。训练集由 196 幅图像组成，验证集由 65 幅图像组成，测试集由 78 幅图像组成(完全由额外的数据集组成)。已验证外部数据集不包含开源数据集中的任何重复图像。所有图像都被调整为 512 x 512 像素，因为根据我构建不同分类器的经验，它的性能优于 1024 x 1024 像素的图像[。](https://github.com/ajsanjoaquin/Pneumothorax)

![](img/662dc3be73879c8675d1cb49a900f319.png)![](img/30a9f9548edc221b56854ee2c5d7c080.png)

左:第一次迭代的训练有两个时代。培训损失远远高于验证损失，这是不适应的明显迹象。右图:训练的第二次迭代。所有列都与左边的列相同。我运行了 30 个纪元。图片作者。

使用 fastai 的 fit_one_cycle 策略的实现运行最初的几个纪元表明，拟合不足从一开始就是一个问题。我决定增加历元的数量，并得到一个学习率的范围。在其余的训练中，我采用了一种积极的策略，即训练大量的周期，使用 fastai 的 **lrfinder，**重新调整学习率，然后继续训练更多的周期，直到训练损失下降到与验证损失相当。

![](img/833498352dd1db4007872a7ff5479de2.png)

图片作者。

最后，在几十次迭代之后，我设法将训练损失降低到与验证损失相似的水平，同时保持高精度。模型的最终内部验证准确率记录为 93.8%。

![](img/aa5704970eb40ed95da122c211df2e86.png)![](img/373e122c70efffaa48cfb22a04569348.png)

左图:模型在验证集上运行良好，有一些假阳性(FP)和假阴性(FN)；右图:该模型在测试集上运行，fn 为零，但 FPs 为三。偏斜分布确实会影响真阳性的结果，需要更多的数据来验证。列表示与左混淆矩阵相同的标签。图片作者。

正如上面的混淆矩阵所示，该模型在验证集上的表现非常好，只有两种情况分别出现假阳性和假阴性。转到测试数据，在 78 个图像中，75 个被正确预测，这是 96.2%的外部验证准确性。虽然我们在测试数据中得到三个假阳性，但模型对所有这些情况的预测接近 50%。这表明它混淆了 x 射线图像的一些特征，但它并不能非常决定性地得出对新冠肺炎有利的结论。**然而，当它预测出正确的阳性病例时，最令人惊讶的事情发生了。** [**该模型从未在这些图像上训练过，但仍然成功地以 99%的确定性预测出图像中的肺是新冠肺炎阳性**。](https://github.com/ajsanjoaquin/COVID-19-Scanner/blob/master/NCOV_test_results.csv)

这是深度学习模型在分类新冠肺炎扫描时前所未有的准确性，**但这只是一个明显缺乏 x 射线数据的初步实验，并且尚未得到外部健康组织或专业人士的验证。我将在未来针对假阴性对模型进行调优，尽管我更关心假阳性，目前数据的稀缺阻止了进一步的调优。**

# 同样，该模型是一个概念验证，但如果进一步开发，这将有巨大的潜力来解决现有的有限诊断范围和未来可能的人力短缺。它可以帮助阻止这种疫情的传播，并创造新的方法来防止未来的。

为此，[我让我的代码、模型和结果可供研究人员使用](https://github.com/ajsanjoaquin/COVID-19-Scanner)。我计划在更多的数据公开后，通过在更平衡的数据集上测试来更新模型。我还计划实现一个 GRAD-CAM 来直观地查看模型关注的特性。我希望我的模型能够在外部得到验证，并且不仅仅是一个宠物项目，尤其是在这个非常紧急的时候。[如果有任何问题，或者如果你能帮我联系上某个组织或专业人士，可以让**从这个模式中受益并改进这个模式**，请随时联系我](https://www.linkedin.com/in/ajsanjoaquin/)。

*   *我在训练后意识到，很大一部分训练和测试图像来自儿科患者，这可能会影响模型在成人扫描上的性能。但其性能仍需更多数据验证。该模型还可以通过未来的培训进行改进。*
*   *我发现其中一个新冠肺炎阳性图像也在训练集中，这意味着结果的准确性是无效的。然而，它仍然给出了其他三个新冠肺炎图像 99%的可能性。*
*   [*最近，我用细菌性和病毒性肺炎的图片测试了这个模型。*](https://github.com/ajsanjoaquin/COVID-19-Scanner/tree/master/Test_v2) *我目前正在等待更多的数据来进一步训练它。*
*   ⁴ [*梅奥诊所:假阴性新冠肺炎检测结果可能导致虚假安全感*](https://www.sciencedaily.com/releases/2020/04/200409144805.htm)
*   *注:我应该对阳性病例进行上采样，以解决这些图像的缺乏，我应该包括更多细菌性和病毒性肺炎的图像，以使其更加有力。如果你想改进这个模型，请这样做。*
*   注意:由于研究新冠肺炎的放射性标志物是一个活跃的研究领域，还有许多有待发现，我提醒大家不要解读结果，该模型已经确定了新冠肺炎独有的正确特征。