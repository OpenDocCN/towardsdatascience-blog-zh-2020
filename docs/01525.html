<html>
<head>
<title>Python + Azure Cosmos DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python + Azure Cosmos DB</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-azure-cosmos-db-f212c9a8a0e6?source=collection_archive---------6-----------------------#2020-02-11">https://towardsdatascience.com/python-azure-cosmos-db-f212c9a8a0e6?source=collection_archive---------6-----------------------#2020-02-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="91ff" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建数据集和容器。查询数据。用Python探索Cosmos DB。</h2></div><p id="bfd0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">额外收获:Azure CLI命令。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/bc3dd21185950cb8a645389e76b19c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_LR3VOmyF27OIapw2C7hg.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">布兰登·肖在<a class="ae lu" href="https://unsplash.com/s/photos/galaxy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="0012" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Azure Cosmos DB是什么？</h1><p id="8b80" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">Azure Cosmos DB是一个<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction" rel="noopener ugc nofollow" target="_blank">全球分布式、多模型的数据库服务</a>，具有弹性可伸缩性和极快的速度。事实上，它是全球分布的，这意味着它是数据需要靠近用户的应用程序的优秀解决方案，并且能够针对峰值使用快速扩展。它被作为web、移动、游戏和IOT应用程序的解决方案进行营销，这些应用程序具有海量输入数据和全球实时即时查询的需求。作为一个例子，它是光晕5的<a class="ae lu" href="https://azure.microsoft.com/en-us/blog/how-halo-5-guardians-implemented-social-gameplay-using-azure-documentdb/" rel="noopener ugc nofollow" target="_blank">社交游戏的数据库！</a></p><h1 id="7e55" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">本文的目标</h1><p id="d100" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">在本文中，我们将创建一个Azure Cosmos DB帐户，并使用<a class="ae lu" href="https://pypi.org/project/azure-cosmos/" rel="noopener ugc nofollow" target="_blank"> Azure Cosmos Python SDK </a>创建一个数据库，创建一个容器，用数据填充容器，并使用SQL API查询容器。我们将使用的数据来自<a class="ae lu" href="https://globaldatalab.org/shdi/download_files/" rel="noopener ugc nofollow" target="_blank">联合国人类发展指数——国家以下一级指数</a>,因此人类发展指数的前缀是资源。</p><p id="458f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lu" href="https://github.com/rchardptrsn/Cosmos-DB-and-Python" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu">查看本文的Github repo</strong></a>，您可以使用Jupyter笔记本查看可执行的python脚本。</p><h1 id="f2dd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建一个Azure Cosmos DB帐户</h1><p id="e591" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">使用Azure时，将资源放在一个资源组中总是一个好主意。最简单的方法是从<a class="ae lu" href="https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create" rel="noopener ugc nofollow" target="_blank"> Azure CLI或云shell: </a></p><p id="0c3a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，使用以下命令登录Azure CLI:</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="bd49" class="mx lw it mt b gy my mz l na nb">az login</span></pre><p id="0fed" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，使用<a class="ae lu" href="https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"><strong class="kk iu">az Group create</strong></a>命令创建一个名为<em class="nc"> HDI-cosmosdb-group </em>的资源组。</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="94b2" class="mx lw it mt b gy my mz l na nb">az group create --location eastus \<br/>                --name HDI-cosmosdb-group \<br/>                --subscription MySubscription</span></pre><p id="0071" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用<a class="ae lu" href="https://docs.microsoft.com/en-us/cli/azure/cosmosdb?view=azure-cli-latest#az-cosmosdb-create" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> az cosmosdb create </strong> </a>命令创建一个名为<em class="nc"> hdicosmosdb(必须全小写)</em>的Cosmos DB。这大约需要10分钟才能完成。</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="62b4" class="mx lw it mt b gy my mz l na nb">az cosmosdb create --name hdicosmosdb \<br/>                   --resource-group HDI-cosmosdb-group \<br/>                   --locations regionName=eastus \<br/>                   --subscription MySubscription</span></pre><p id="211b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，您将在新创建的资源组中看到一个Cosmos DB资源。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nd"><img src="../Images/ca1ee3df04d1448dc8cd91992e1ed4e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Ta9XYUM9pe_265_VYPrSA.png"/></div></div></figure><p id="4284" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在已经创建了Cosmos DB帐户，我们需要URI端点和主键来与我们的帐户进行交互。你可以找到你的URI和访问密钥，方法是进入你的Cosmos DB账户，在左边向下滚动找到设置&gt;&gt;密钥。将URI和主键复制到安全文件中。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ne"><img src="../Images/f4ddaa89baf8983e9c8de5ba256fe9fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1aECT6OEjnB5cPwaoWZ9Ug.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">自该屏幕截图以来，新密钥已重新生成。</p></figure><h1 id="d41c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置Python环境</h1><p id="73e5" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">将我们需要的两个包安装到您的python环境中。</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="0f6d" class="mx lw it mt b gy my mz l na nb">pip install azure-cosmos<br/>pip install pandas</span></pre><h1 id="8ad4" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">导入包并初始化Cosmos客户机</h1><p id="6df5" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">现在，从azure-cosmos-python github示例和微软官方文档<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/cosmos-db/create-sql-api-python" rel="noopener ugc nofollow" target="_blank">中获取技巧，我们将开始使用python与我们的Cosmos DB进行交互。我们将从导入必要的包和创建Cosmos客户机开始。通过用我们的URI端点和访问密钥初始化Cosmos客户端，我们将能够使用azure-cosmos API与我们的Cosmos DB帐户进行交互。</a></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="7042" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建数据库</h1><p id="9b24" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">使用初始化为我们的帐户的客户机，创建一个Cosmos DB数据库。这个数据库将存放容器，容器存放物品。项目是组成数据库的单个文档或记录/行。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="3f03" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建一个容器</h1><p id="fcf6" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">容器，也称为集合，存放构成数据库记录的项目(文档)。分区键路径('/country ')是容器的一个属性，Cosmos DB将使用它在后台对数据集进行分组和分区。<a class="ae lu" href="https://www.c-sharpcorner.com/article/partitioning-in-cosmos-db/" rel="noopener ugc nofollow" target="_blank">这篇C#Corner </a>文章很好地解释了如何使用分区键按“部门”对记录进行分组在我们的数据集中，列“country”将用于对分区中的记录进行分组，分区由记录的“country”值定义。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="8132" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">下载并准备要上传的数据</h1><p id="b3c5" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">现在，下载人类发展指数——使用熊猫的地方指数。Azure Cosmos DB需要一列来标识每个记录/行的唯一id。我们将基于熊猫数据帧的索引创建一个列“id”。此外，由于每一行在Cosmos DB中都以json文档的形式结束，我们需要将“id”列转换为string类型。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="c2f2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">将数据上传到宇宙数据库</h1><p id="0dd5" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">这里，我们将迭代熊猫数据帧的行，并为每一行创建一个字典。该字典已经为json提取进行了良好的格式化，这是通过<strong class="kk iu"> <em class="nc"> json.dumps()完成的。</em> </strong>当for循环执行时，每一行都被写入Cosmos DB。对于一个45，000条记录的数据集，这大约需要15分钟。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="a8bd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">查询宇宙数据库</h1><p id="79b6" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">既然我们的数据集已经植入了数据，让我们运行一个测试查询。</p><p id="f09d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们想要查询阿富汗国家的所有国家级数据。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="462c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们所有的努力都得到了回报。<strong class="kk iu"> <em class="nc">。head() </em> </strong>方法显示数据已经成功返回，并且在一个pandas DataFrame中。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nh"><img src="../Images/e572409267e4fc96dc1961e5655d4bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YAqPXVDbpXron8kbPdhlyw.png"/></div></div></figure><p id="ecd9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们用三个主要指数——健康、收入和教育指数——的折线图来庆祝一下。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nf ng l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ni"><img src="../Images/f6dde1b96a79e23e0cdc4cbe1798c0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sskO-8tY9u0RW5rdAWnUuA.png"/></div></div></figure><p id="9631" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢你远道而来！Azure Cosmos DB非常容易设置，它面向json的记录对于python和pandas来说轻而易举。</p></div></div>    
</body>
</html>