<html>
<head>
<title>How to Integrate a Segmentation Network Model with Your iPhone App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将细分网络模型与您的iPhone应用程序集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-integrate-a-segmentation-network-model-with-your-iphone-app-5c11736b95a?source=collection_archive---------56-----------------------#2020-05-11">https://towardsdatascience.com/how-to-integrate-a-segmentation-network-model-with-your-iphone-app-5c11736b95a?source=collection_archive---------56-----------------------#2020-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/807bbe2cea7a640a0f718c54f05a4a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXqpz0Vmxh_6UHCeRtkQyg.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">Arnel Hasanovic 在<a class="ae kf" href="https://unsplash.com/s/photos/iphone?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="341f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">分割图像中的感兴趣区域(ROI)是计算机视觉中的一个关键问题。随着深度学习的兴起，许多网络架构被提出来克服语义分割的挑战。几年前，在智能手机中部署一个经过训练的细分网络模型还远远不现实。然而，由于最近智能手机中的强大硬件加上我们可以使用的强大软件工具，在您的智能手机应用程序中部署一个分段网络只需要几行代码！</p><p id="497f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文将带您完成将一个经过训练的细分模型与您的iPhone应用程序集成的过程。这个过程包括两个步骤:(1) <strong class="ki iu">将模型转换为。mlmodel格式</strong>和(2) <strong class="ki iu">使用转换后的模型分割ROI。</strong>为了让我们自己熟悉这两个步骤，我们将使用(使用Keras框架)训练的U-Net模型来分割外部眼睛图像的巩膜区域。</p><h2 id="e8d4" class="ln lo it bd lp lq lr dn ls lt lu dp lv kr lw lx ly kv lz ma mb kz mc md me mf bi translated"><strong class="ak">第一步:将模型转换为移动兼容格式</strong></h2><p id="34ab" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">将keras模型转换为。mlmodel格式，我们可以使用<code class="fe ml mm mn mo b">coremltools</code> python库。可以使用以下命令安装它。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="330d" class="ln lo it mo b gy mx my l mz na">pip install coremltools</span></pre><p id="80ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装库之后，下面的代码片段允许您执行转换，并将转换后的模型保存在指定的位置。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">将. h5模型文件转换为. ml模型文件</p></figure><h2 id="06a4" class="ln lo it bd lp lq lr dn ls lt lu dp lv kr lw lx ly kv lz ma mb kz mc md me mf bi translated"><strong class="ak">步骤2:使用转换后的模型分割ROI </strong></h2><p id="8a5d" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">在获取。mlmodel文件，将其拖放到Xcode导航区域的项目文件夹中。swift中的<code class="fe ml mm mn mo b">Vision</code> <strong class="ki iu"> </strong>库允许您使用。mlmodel文件，当您将它与应用程序集成时。</p><p id="1bad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们首先将库——在本例中是<code class="fe ml mm mn mo b">UIKit</code>和<code class="fe ml mm mn mo b">Vision</code>——导入我们的代码，如下所示。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="81aa" class="ln lo it mo b gy mx my l mz na">import UIKit <br/>import Vision</span></pre><p id="8dcd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们用<code class="fe ml mm mn mo b">UIImagePickerControllerDelegate</code>定义我们的<code class="fe ml mm mn mo b"> <strong class="ki iu">class</strong> ViewController</code>，允许我们从我们的照片库中挑选一张图片。为了简单起见，我们不会在应用程序中添加任何文本字段或标签。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="06d6" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">class</strong> ViewController: UIViewController, <br/>                      UIImagePickerControllerDelegate,<br/>                      UINavigationControllerDelegate {<br/></span><span id="d9bb" class="ln lo it mo b gy nd my l mz na">}</span></pre><p id="c651" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个类中，我们可以开始定义构建我们的应用程序的函数。首先，我们定义<code class="fe ml mm mn mo b">UIImageView</code>属性，该属性将显示从照片库中选择的外部眼睛图像和分割结果。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="f956" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">@IBOutlet</strong> <strong class="mo iu">weak</strong> <strong class="mo iu">var</strong> photoImageView: UIImageView!</span></pre><p id="41ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以通过下面的命令来定义分割模型。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="641f" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">let</strong> SegmentationModel = ScleraUNet()</span></pre><p id="8f77" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们定义视觉属性<code class="fe ml mm mn mo b">request</code>和<code class="fe ml mm mn mo b">visionModel</code>。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="b57c" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">var</strong> request: VNCoreMLRequest?<br/><strong class="mo iu">var</strong> visionModel: VNCoreMLModel?</span></pre><p id="2a75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们写一个设置<code class="fe ml mm mn mo b"> SegmentationModel</code>和<code class="fe ml mm mn mo b">request</code>的函数。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">建立模型</p></figure><p id="adca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里你可以注意到<code class="fe ml mm mn mo b">VNCoreMLRequest</code>的<code class="fe ml mm mn mo b">completionHandler</code>被设置为一个我们还没有定义的叫做<code class="fe ml mm mn mo b">visionRequestDidComplete</code>的函数。在<code class="fe ml mm mn mo b">visionRequestDidComplete</code>功能中，我们可以包括在<code class="fe ml mm mn mo b">request</code>使用分割模型输出分割掩模后应该执行的动作。我们将在本文后面定义<code class="fe ml mm mn mo b">visionRequestDidComplete</code>函数。</p><p id="785e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了在应用程序加载后设置模型，我们在<code class="fe ml mm mn mo b"><strong class="ki iu">class</strong> ViewController</code>中添加了以下代码片段</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="1d5d" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">override</strong> <strong class="mo iu">func</strong> viewDidLoad() {</span><span id="0093" class="ln lo it mo b gy nd my l mz na"><strong class="mo iu">super</strong>.viewDidLoad()</span><span id="de93" class="ln lo it mo b gy nd my l mz na">print("Setting up model...")<br/>setupModel()<br/>print("Model is ready")</span><span id="c23e" class="ln lo it mo b gy nd my l mz na">nameTextField.delegate = <strong class="mo iu">self</strong></span><span id="645b" class="ln lo it mo b gy nd my l mz na">}</span></pre><p id="d3df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以编写函数，让我们从照片库中选择一个外部眼睛图像。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="d10d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样，我们可以通过<code class="fe ml mm mn mo b">photoImageView.image</code>访问所选图像。</p><p id="8714" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们希望有一个交互式按钮，将执行按下分割过程。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="2f1d" class="ln lo it mo b gy mx my l mz na"><strong class="mo iu">@IBAction</strong> <strong class="mo iu">func</strong> segementImage(<strong class="mo iu">_</strong> sender: UIButton){</span><span id="8351" class="ln lo it mo b gy nd my l mz na">print("Segmenting... ")</span><span id="bb3c" class="ln lo it mo b gy nd my l mz na"><strong class="mo iu">let</strong> input_image = photoImageView.image?.cgImage</span><span id="fdef" class="ln lo it mo b gy nd my l mz na">predict(with: input_image!)</span><span id="4276" class="ln lo it mo b gy nd my l mz na">}</span></pre><p id="42c7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按下按钮时，上述功能激活并运行<code class="fe ml mm mn mo b">predict</code>功能。我们将在后面定义这个<code class="fe ml mm mn mo b">predict</code>函数。</p><p id="4ed9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将上述代码片段添加到我们的代码中后，它会是这样的:</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1fba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们的代码差不多完成了。但是我们必须定义前面留下的<code class="fe ml mm mn mo b">visionRequestDidComplete</code>和<code class="fe ml mm mn mo b">predict</code>函数。我们将它们定义在<code class="fe ml mm mn mo b"><strong class="ki iu">class </strong>ViewController</code>下面的<code class="fe ml mm mn mo b"><strong class="ki iu">extension </strong>ViewController</code>中，如下所示。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f9b0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe ml mm mn mo b">visionRequestDidComplete</code>中，我们定义了模型预测分割结果后必须完成的任务。在这种情况下，我们希望将分割结果二值化并显示在我们之前定义的<code class="fe ml mm mn mo b">photoView</code>上。</p><p id="515d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的代码中添加了<code class="fe ml mm mn mo b"><strong class="ki iu">extension</strong> ViewController</code>之后，它看起来会如下所示。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="e26c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了进一步完善我们的工作，我们可以在UI中添加一些标签、按钮和文本字段。在本例中，我们添加了几个标签、一个清除按钮和一个文本字段，该字段接受外部眼睛图像所属的主题名称。这里有一些我们新创建的简单应用程序运行的截图，它可以从给定的外部眼睛图像中分割巩膜区域。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/23d5eecd5fb510a1901d26a7fbd88e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3A3AMwp57zKchJIS9GusQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">左:应用程序的打开视图，中:从照片库中选择外部眼睛图像后的视图，右:巩膜区域被分割后的视图。(图片由作者提供)</p></figure><p id="5586" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也可以在原始图像上叠加分割蒙版，但不包括在这项工作中。</p><p id="246e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文到此结束！希望它能帮助你将一个细分模型恰当地整合到你的iPhone应用中。</p></div></div>    
</body>
</html>