<html>
<head>
<title>Deep dive into Redshift Spectrum and its internals</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究红移光谱及其内部结构</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/redshift-spectrum-f7ad968db6ef?source=collection_archive---------20-----------------------#2020-07-29">https://towardsdatascience.com/redshift-spectrum-f7ad968db6ef?source=collection_archive---------20-----------------------#2020-07-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="accc" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">完整的图片</h2><div class=""/><div class=""><h2 id="004e" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">红移光谱的内部功能以及何时在 Athena、Spectrum 或 s3 之间选择-选择通过 s3 查询数据</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/af42216e8409f9bc5adb79c6f8f179a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e9mtKamweWkt3Cgr"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e7ef" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">AWS 在 2013 年推出了红移，在红移成功后，出现了清理被冷数据占据的簇的需求。但是，如果您也想访问您的冷数据呢？不经常，但可能一年一次。但是，您愿意为在您的集群中保存冷数据而支付集群空间费用吗？您很少使用这些冷数据，而且这些冷数据的大小会随着时间的推移而不断增加。</p><p id="35aa" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">不，没错，没有人想用冷数据填满他们的集群。因此，红移星团最大的问题是以最小的代价查询冷数据。为了解决这个问题，AWS 在 2017 年推出了红移频谱，允许您查询存储在 s3 上的数据，并提供将 s3 数据(即冷数据)与红移数据(即热数据)连接起来的功能。</p><p id="8afc" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这节省了大量的集群空间，可以帮助您节省集群的总体成本，并且有了更多的可用空间，您可以提高查询性能，并为查询的执行提供更多的空间。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="fc37" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">红移光谱的内部结构:</h2><p id="3d76" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">AWS Redshift 的查询处理引擎对于内部表(即位于 Redshift 集群或热数据中的表)和外部表(即位于 s3 存储桶或冷数据上的表)的工作方式是相同的。</p><p id="3be7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要使用频谱访问驻留在 S3 的数据，我们需要执行以下步骤:</p><ol class=""><li id="db3b" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">创建胶水目录。</li><li id="b113" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">创建指向 s3 数据的外部表。</li></ol><blockquote class="nw nx ny"><p id="6d17" class="li lj nz lk b ll lm kd ln lo lp kg lq oa ls lt lu ob lw lx ly oc ma mb mc md im bi translated">没有必要运行爬虫，如果你想更新分区信息，只需运行 msck 修复表 table_name。 </p></blockquote><p id="ac5e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当我们使用 spectrum 查询外部表时，查询的生命周期是这样的:</p><ol class=""><li id="69f2" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">查询在集群的领导者节点中被触发，在该节点中查询被优化，并且领导者节点确定是否在本地运行哪个部分来访问热数据，以及什么进入频谱。</li><li id="a745" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">查询计划被发送到计算节点，其中的表对信息和元数据进行分区(如果从粘合目录中提取的话)。</li><li id="7cd3" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">称为<strong class="lk jd"> Spectrum Fleet </strong>的多个受管计算节点与集群相关联，用于对外部数据集执行查询。</li><li id="9b77" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">Spectrum fleet 处理数据并将其发送回 leader 节点，在那里与热数据进行连接。</li><li id="18ec" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">leader 节点为我们提供了所需的输出。</li></ol><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi od"><img src="../Images/4e381db4bdd7d664a9941b44e3fb427a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*na2BaKlNHRRcRpVr.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">红移谱中的查询生命周期</p></figure><h2 id="d056" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">光谱车队</h2><p id="89b0" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">Spectrum fleet 有点棘手，我们需要了解它，以便为我们的工作负载管理选择最佳策略。</p><p id="9713" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">spectrum 机群由位于 VPC 内的多个托管计算节点组成，仅当您对外部数据执行查询时才可用。因此，这些计算节点完全由 AWS 在幕后管理。</p><p id="0d55" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在问题来了，有多少计算节点可用于运行查询？如果您有 2 个节点红移集群，您能运行超过 10 TB 数据的频谱查询吗？对于外部表，计算节点的数量是无限的吗？</p><p id="5dd8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">所以答案是<strong class="lk jd">不</strong></p><blockquote class="nw nx ny"><p id="604f" class="li lj nz lk b ll lm kd ln lo lp kg lq oa ls lt lu ob lw lx ly oc ma mb mc md im bi translated"><strong class="lk jd"> <em class="it">你没有得到无限的计算，但分配给特定频谱查询的节点数等于你的红移集群大小的 10 倍。</em> </strong></p></blockquote><p id="7b1c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您使用 2 节点红移集群，那么 AWS 将分配不超过 20 个节点来运行您的光谱查询。同样，对于 20 个节点的集群，您最多可以获得 200 个节点。</p><p id="e831" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">节点数量的分配通过以下方式确定:</p><ol class=""><li id="d7f3" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">当我们查询外部数据时，leader 节点将生成一个优化的逻辑计划，并由此生成一个物理计划。</li><li id="4a91" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">现在，基于这个物理计划，redshift 确定处理结果所需的计算量，并分配必要的计算节点来处理查询。</li><li id="95fd" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">如果您的查询需要的节点数超过最大限制，redshift 将分配允许的最大节点数，如果这不能满足您的计算要求，查询将失败。</li></ol><h2 id="911f" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">S3 文件格式和压缩</h2><p id="b2ec" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">红移谱可以查询超过<strong class="lk jd"> <em class="nz"> orc </em> </strong>，<strong class="lk jd"> <em class="nz"> rc </em> </strong>，<strong class="lk jd"> <em class="nz"> avro </em> </strong>，<strong class="lk jd"> <em class="nz"> json </em>，<strong class="lk jd"> <em class="nz"> csv </em> </strong>，<strong class="lk jd"> <em class="nz"> sequencefile </em> </strong>，<strong class="lk jd"> <em class="nz"> parquet，</em> </strong>和</strong>的数据 Amazon 建议使用分栏文件格式，因为它占用的存储空间更少，处理和过滤数据的速度更快，我们可以始终只选择所需的栏。要了解有关支持的文件格式、压缩和加密的更多信息，请访问<a class="ae lh" href="https://docs.aws.amazon.com/redshift/latest/dg/c-spectrum-data-files.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h2 id="bb33" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">查询优化</h2><p id="c092" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">要优化查询性能，您应该考虑以下几点:</p><ol class=""><li id="f254" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">使用分栏文件格式，这将防止对分栏进行不必要的扫描。</li><li id="8624" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">用正确的分区数量更新您的 glue 目录。</li><li id="4933" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">编写您的查询以使用有资格被推送到红移光谱图层的过滤器和聚合。下面是一些可以通过子句、比较条件和模式匹配条件推送到红移谱层<strong class="lk jd">的操作的例子，比如 LIKE </strong>、<strong class="lk jd">聚合函数，比如 COUNT、SUM、AVG、MIN、MAX。</strong></li><li id="5345" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">避免无法推至红移光谱图层的操作，包括 DISTINCT 和 ORDER BY。</li></ol><p id="a9a7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要了解更多关于查询优化的信息，请访问<a class="ae lh" href="https://docs.aws.amazon.com/redshift/latest/dg/c-spectrum-external-performance.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="bcc2" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">监视</h2><p id="5a1e" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">redshift 提供了两种系统视图来查看外部查询的性能:</p><ol class=""><li id="9547" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated"><strong class="lk jd">SVL _ S3 查询</strong>:提供段和节点切片级别的频谱查询细节。</li><li id="7fea" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated"><strong class="lk jd"> SVL_S3QUERY_SUMMARY </strong>:跟踪集群上迄今为止触发的所有频谱查询，包括处理的文件数、扫描的字节数(有助于确定查询产生的成本)</li></ol><p id="7553" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要了解更多关于查询优化的信息，请访问<a class="ae lh" href="https://docs.aws.amazon.com/redshift/latest/dg/c-spectrum-metrics.html" rel="noopener ugc nofollow" target="_blank">这里</a>。要解决查询错误，请访问此处的<a class="ae lh" href="https://docs.aws.amazon.com/redshift/latest/dg/c-spectrum-troubleshooting.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="cdac" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">费用</h2><p id="22e6" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">根据扫描的数据量收取频谱费，即每 TB 数据 5 美元。</p><blockquote class="nw nx ny"><p id="3cc9" class="li lj nz lk b ll lm kd ln lo lp kg lq oa ls lt lu ob lw lx ly oc ma mb mc md im bi translated"><em class="it">欲了解红移光谱性能详情，请访问本博客</em><a class="ae lh" href="https://aws.amazon.com/blogs/aws/amazon-redshift-spectrum-exabyte-scale-in-place-queries-of-s3-data/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://AWS . Amazon . com/blogs/AWS/Amazon-Redshift-Spectrum-exabyte-scale-in-place-queries-of-S3-data/</em></a></p></blockquote></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="0236" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">选择光谱，雅典娜和 S3-选择</h2><h2 id="405a" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">雅典娜:</h2><p id="1307" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">当没有红移集群正在运行，并且您想要对驻留在 s3 中的数据执行分析查询时，应该考虑 Athena。或者您的数据与红移集群中的数据不相关，并且您不想对集群数据执行任何连接。与雅典娜相关的一些要点是:</p><ol class=""><li id="8010" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">雅典娜是无服务器的。</li><li id="c9cd" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">Athena 使用 Presto 查询引擎来优化查询。</li><li id="d905" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">Athena 要求首先使用 glue 爬虫对数据进行爬行，这增加了它的总体成本。</li><li id="c263" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">Athena 的总成本为每 TB 扫描的数据 5 美元+使用 glue crawlers 对数据进行爬行的每小时每 DPU 0.44 美元。</li></ol><h2 id="f2e0" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">S3-选择:</h2><p id="1f66" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">如果您只想过滤掉一个 s3 对象的数据，S3 选择非常有用。这提供了仅查询单个 s3 对象的功能，并且能够过滤数据。S3 选择功能包括:</p><ol class=""><li id="ead2" class="ni nj it lk b ll lm lo lp lr nk lv nl lz nm md nn no np nq bi translated">不需要服务器来运行对 s3 对象的查询。</li><li id="66c1" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">一次只能查询一个对象。</li><li id="be7c" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">可以在 Spark 应用程序中使用，以应用谓词下推。(相信我，如果您正在读取 csv 数据，这将提高您的速度)</li><li id="ee78" class="ni nj it lk b ll nr lo ns lr nt lv nu lz nv md nn no np nq bi translated">费用为返回数据 0.8 美元/TB，扫描数据 2.23 美元/TB。</li></ol><h2 id="1ca1" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">红移光谱:</h2><p id="0693" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">红移光谱只有在你已经是红移用户的情况下才应该考虑。如果您已经在红移集群上运行工作负载，那么应该使用红移频谱。红移谱填补了查询驻留在 s3 上的数据以及集群数据的空白。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oe"><img src="../Images/9c3d40cdfb5174929766aae55bca3a5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7wKTd-OEIRj90S_O.png"/></div></div></figure><p id="b626" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Spectrum、Athena 和 s3-select 之间的比较</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="abf8" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">摘要</h2><p id="e5e3" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">如果您希望查询驻留在 s3 上的数据并在 s3 和红移集群数据之间建立关系，红移光谱是一个很好的选择。它速度快、功能强大，而且非常经济高效。可以使用 BI 工具或 SQL workbench 查询 s3 数据。</p><p id="9c49" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">红移光谱是一个非常强大的工具，但却被每个人忽略了。</p><p id="39d6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我希望你喜欢这篇文章。</p><p id="3d10" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">敬请关注更多内容。</p><p id="9714" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">参考资料:</p><p id="4caf" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[1] <a class="ae lh" href="https://docs.aws.amazon.com/redshift/latest/dg/c-using-spectrum.html" rel="noopener ugc nofollow" target="_blank">红移光谱文档</a></p></div></div>    
</body>
</html>