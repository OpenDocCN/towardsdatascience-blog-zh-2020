<html>
<head>
<title>How to do text similarity search and document clustering in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 BigQuery 中进行文本相似性搜索和文档聚类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65?source=collection_archive---------9-----------------------#2020-08-22">https://towardsdatascience.com/how-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65?source=collection_archive---------9-----------------------#2020-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a3e9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在 BigQuery 中使用文档嵌入进行文档相似性和聚类任务</h2></div><p id="e471" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery 提供了加载 TensorFlow SavedModel 并执行预测的能力。这个功能是在数据仓库上添加基于文本的相似性和聚类的一个很好的方式。</p><p id="4341" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接着从 GitHub 中的<a class="ae lb" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb" rel="noopener ugc nofollow" target="_blank"> my notebook 复制粘贴查询。你可以在 BigQuery 控制台或人工智能平台 Jupyter 笔记本中尝试这些查询。</a></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/f196e7fae5ffa253bd9884d89b7d2eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNsrQaEHlWSM0MjLlOpfyg.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">文本嵌入对于文档相似性和聚类任务是有用的。图片来自<a class="ae lb" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1151405" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae lb" href="https://pixabay.com/users/kerttu-569708/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1151405" rel="noopener ugc nofollow" target="_blank"> kerttu </a></p></figure><h2 id="bb83" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">风暴报告数据</h2><p id="78a4" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">作为一个例子，我将使用一个由“风暴观察者”打电话到国家气象局的风报告组成的数据集。这是 BigQuery 中的公共数据集，可以按如下方式查询:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="77c0" class="ls lt iq mr b gy mv mw l mx my">SELECT <br/>  EXTRACT(DAYOFYEAR from timestamp) AS julian_day,<br/>  ST_GeogPoint(longitude, latitude) AS location,<br/>  comments<br/>FROM `bigquery-public-data.noaa_preliminary_severe_storms.wind_reports`<br/>WHERE EXTRACT(YEAR from timestamp) = 2019<br/>LIMIT 10</span></pre><p id="4aa0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果看起来像这样:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/1dadd9a3731e4a2801ce30dcef574199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*zHAk-siH4t6N5UJFBruElw.png"/></div></figure><p id="fefb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我们想要构建一个 SQL 查询来搜索看起来像“一个家庭的电源线断了”的评论。</p><p id="ae92" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">步骤:</p><ul class=""><li id="8362" class="na nb iq kh b ki kj kl km ko nc ks nd kw ne la nf ng nh ni bi translated">加载一个机器学习模型，创建一些文本的嵌入(本质上是一个紧凑的数字表示)。</li><li id="155a" class="na nb iq kh b ki nj kl nk ko nl ks nm kw nn la nf ng nh ni bi translated">使用该模型来生成我们的搜索词的嵌入。</li><li id="1fa7" class="na nb iq kh b ki nj kl nk ko nl ks nm kw nn la nf ng nh ni bi translated">使用该模型生成风报表中每个注释的嵌入。</li><li id="488d" class="na nb iq kh b ki nj kl nk ko nl ks nm kw nn la nf ng nh ni bi translated">寻找两个嵌入彼此接近的行。</li></ul><h2 id="612c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">将文本嵌入模型加载到 BigQuery</h2><p id="a16d" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated"><a class="ae lb" href="https://tfhub.dev/" rel="noopener ugc nofollow" target="_blank"> TensorFlow Hub </a>有很多文本嵌入模型。为了获得最佳结果，您应该使用一个模型，该模型已根据与您的数据集相似的数据进行了训练，并且具有足够数量的维度以捕捉文本的细微差别。</p><p id="75e3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个演示，我将使用在 Google News 上训练过的有 20 个维度的<a class="ae lb" href="https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1" rel="noopener ugc nofollow" target="_blank">旋转</a>嵌入(也就是说，它相当粗糙)。这对我们需要做的事情来说已经足够了。</p><p id="ab83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Swivel 嵌入层已经以 TensorFlow SavedModel 格式提供，因此我们只需下载它，从 tarred、gzipped 文件中提取它，并将其上传到 Google 云存储:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="3cae" class="ls lt iq mr b gy mv mw l mx my">FILE=swivel.tar.gz<br/>wget --quiet -O tmp/swivel.tar.gz  <a class="ae lb" href="https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1?tf-hub-format=compressed" rel="noopener ugc nofollow" target="_blank">https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1?tf-hub-format=compressed</a><br/>cd tmp<br/>tar xvfz swivel.tar.gz<br/>cd ..<br/>mv tmp swivel<br/>gsutil -m cp -R swivel gs://${BUCKET}/swivel</span></pre><p id="d645" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦模型文件在 GCS 上，我们可以将它作为 ML 模型加载到 BigQuery 中:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="58b3" class="ls lt iq mr b gy mv mw l mx my">CREATE OR REPLACE MODEL advdata.swivel_text_embed<br/>OPTIONS(model_type='tensorflow', model_path='gs://BUCKET/swivel/*')</span></pre><h2 id="b480" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">尝试在 BigQuery 中嵌入模型</h2><p id="b160" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">要在 BigQuery 中试用这个模型，我们需要知道它的输入和输出模式。这些将是导出时 Keras 层的名称。我们可以通过转到 BigQuery 控制台并查看模型的“Schema”选项卡来获得它们:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi no"><img src="../Images/e5cb8b74c86c5d3e258c50ba8c6a25ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*Zf6INjhEyjz4UjS8e_0vQA.png"/></div></figure><p id="839b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过获得一个著名的 August 演讲的嵌入来尝试这个模型，将输入文本作为句子调用，并且知道我们将获得一个名为 output_0 的输出列:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="48ad" class="ls lt iq mr b gy mv mw l mx my">SELECT <strong class="mr ir">output_0</strong> FROM<br/>ML.PREDICT(MODEL advdata.swivel_text_embed,(<br/>SELECT "Long years ago, we made a tryst with destiny; and now the time comes when we shall redeem our pledge, not wholly or in full measure, but very substantially." AS <strong class="mr ir">sentences</strong>))</span></pre><p id="b742" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果有 20 个数字，如下所示:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi np"><img src="../Images/2beae9f6ef2d3e3ef95c048a43607ac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:396/format:webp/1*XsgVt-2R-UOShZVdNyA3RQ.png"/></div></figure><h2 id="d78f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">文档相似性搜索</h2><p id="e216" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">定义一个函数来计算一对嵌入之间的欧几里德平方距离:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="ae2a" class="ls lt iq mr b gy mv mw l mx my">CREATE TEMPORARY FUNCTION td(a ARRAY&lt;FLOAT64&gt;, b ARRAY&lt;FLOAT64&gt;, idx INT64) AS (<br/>   (a[OFFSET(idx)] - b[OFFSET(idx)]) * (a[OFFSET(idx)] - b[OFFSET(idx)])<br/>);</span><span id="52a7" class="ls lt iq mr b gy nq mw l mx my">CREATE TEMPORARY FUNCTION term_distance(a ARRAY&lt;FLOAT64&gt;, b ARRAY&lt;FLOAT64&gt;) AS ((<br/>   SELECT SQRT(SUM( td(a, b, idx))) FROM UNNEST(GENERATE_ARRAY(0, 19)) idx<br/>));</span></pre><p id="2f8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，计算我们的搜索词的嵌入:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="5f97" class="ls lt iq mr b gy mv mw l mx my">WITH search_term AS (<br/>  SELECT output_0 AS term_embedding FROM ML.PREDICT(MODEL advdata.swivel_text_embed,(SELECT "power line down on a home" AS sentences))<br/>)</span></pre><p id="e8c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并计算每个评论的嵌入和搜索词的 term_embedding 之间的距离(如上):</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="c880" class="ls lt iq mr b gy mv mw l mx my">SELECT<br/>  term_distance(term_embedding, output_0) AS termdist,<br/>  comments<br/>FROM ML.PREDICT(MODEL advdata.swivel_text_embed,(<br/>  SELECT comments, LOWER(comments) AS sentences<br/>  FROM `bigquery-public-data.noaa_preliminary_severe_storms.wind_reports`<br/>  WHERE EXTRACT(YEAR from timestamp) = 2019<br/>)), search_term<br/>ORDER By termdist ASC<br/>LIMIT 10</span></pre><p id="2ce8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果是:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/f436bebcdb6c6d0008ec43ace634efc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*k0Zi0boUJ-SlnxxkFu-71Q.png"/></div></figure><p id="dfb7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还记得我们搜索了“家里的电线坏了”吗？请注意，最上面的两个结果是“house 上的 power line down”——文本嵌入有助于识别 home 和 house 在此上下文中是相似的。下一组最佳匹配都是关于电力线的，这是我们搜索词中最独特的一对词。</p><h2 id="11ec" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">文档聚类</h2><p id="d9a0" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">文档聚类包括使用嵌入作为聚类算法(如 K-Means)的输入。我们可以在 BigQuery 中实现这一点，为了让事情变得更有趣，我们将使用位置和日期作为聚类算法的附加输入。</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="e092" class="ls lt iq mr b gy mv mw l mx my">CREATE OR REPLACE MODEL advdata.storm_reports_clustering<br/>OPTIONS(model_type='kmeans', NUM_CLUSTERS=10) AS</span><span id="27df" class="ls lt iq mr b gy nq mw l mx my">SELECT<br/>  arr_to_input_20(output_0) AS comments_embed,<br/>  EXTRACT(DAYOFYEAR from timestamp) AS julian_day,<br/>  longitude, latitude<br/>FROM ML.PREDICT(MODEL advdata.swivel_text_embed,(<br/>  SELECT timestamp, longitude, latitude, LOWER(comments) AS sentences<br/>  FROM `bigquery-public-data.noaa_preliminary_severe_storms.wind_reports`<br/>  WHERE EXTRACT(YEAR from timestamp) = 2019<br/>))</span></pre><p id="e265" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嵌入(output_0)是一个数组，但 BigQuery ML 当前需要命名输入。解决方法是将数组转换为结构:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="17be" class="ls lt iq mr b gy mv mw l mx my">CREATE TEMPORARY FUNCTION arr_to_input_20(arr ARRAY&lt;FLOAT64&gt;)<br/>RETURNS <br/>STRUCT&lt;p1 FLOAT64, p2 FLOAT64, p3 FLOAT64, p4 FLOAT64,<br/>       p5 FLOAT64, p6 FLOAT64, p7 FLOAT64, p8 FLOAT64, <br/>       p9 FLOAT64, p10 FLOAT64, p11 FLOAT64, p12 FLOAT64, <br/>       p13 FLOAT64, p14 FLOAT64, p15 FLOAT64, p16 FLOAT64,<br/>       p17 FLOAT64, p18 FLOAT64, p19 FLOAT64, p20 FLOAT64&gt;</span><span id="3c96" class="ls lt iq mr b gy nq mw l mx my">AS (<br/>STRUCT(<br/>    arr[OFFSET(0)]<br/>    , arr[OFFSET(1)]<br/>    , arr[OFFSET(2)]<br/>    , arr[OFFSET(3)]<br/>    , arr[OFFSET(4)]<br/>    , arr[OFFSET(5)]<br/>    , arr[OFFSET(6)]<br/>    , arr[OFFSET(7)]<br/>    , arr[OFFSET(8)]<br/>    , arr[OFFSET(9)]<br/>    , arr[OFFSET(10)]<br/>    , arr[OFFSET(11)]<br/>    , arr[OFFSET(12)]<br/>    , arr[OFFSET(13)]<br/>    , arr[OFFSET(14)]<br/>    , arr[OFFSET(15)]<br/>    , arr[OFFSET(16)]<br/>    , arr[OFFSET(17)]<br/>    , arr[OFFSET(18)]<br/>    , arr[OFFSET(19)]    <br/>));</span></pre><p id="9761" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生成的十个集群可以在 BigQuery 控制台中可视化:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ns"><img src="../Images/30449c1b27c373d2535712aead1968e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k7O8Zk8bTbyH64U9ZBWuug.png"/></div></div></figure><p id="c9dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">集群#1 中的评论看起来像什么？该查询是:</p><pre class="ld le lf lg gt mq mr ms mt aw mu bi"><span id="b221" class="ls lt iq mr b gy mv mw l mx my">SELECT sentences <br/>FROM ML.PREDICT(MODEL `ai-analytics-solutions.advdata.storm_reports_clustering`, <br/>(<br/>SELECT<br/>  sentences,<br/>  arr_to_input_20(output_0) AS comments_embed,<br/>  EXTRACT(DAYOFYEAR from timestamp) AS julian_day,<br/>  longitude, latitude<br/>FROM ML.PREDICT(MODEL advdata.swivel_text_embed,(<br/>  SELECT timestamp, longitude, latitude, LOWER(comments) AS sentences<br/>  FROM `bigquery-public-data.noaa_preliminary_severe_storms.wind_reports`<br/>  WHERE EXTRACT(YEAR from timestamp) = 2019<br/>))))<br/>WHERE centroid_id = 1</span></pre><p id="a1cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果显示，这些大多是简短的、没有信息的评论:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/2c0e6ef6b5c48f3a0f3d537f941ba29f.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*UWj4t2wZoWQ9JIjhttFcBQ.png"/></div></figure><p id="9c10" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第三组怎么样？这些报道大部分好像都和雷达验证有关！！！</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nu"><img src="../Images/510a39daf41c72a539fe05ef7c09775d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_dno-BxuU_hbvzfjQ2j8Q.png"/></div></div></figure><p id="02ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><h2 id="5387" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">链接</h2><p id="da13" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated"><a class="ae lb" href="https://tfhub.dev/" rel="noopener ugc nofollow" target="_blank"> TensorFlow Hub </a>有几种文本嵌入模型。你不必使用<a class="ae lb" href="https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1" rel="noopener ugc nofollow" target="_blank">旋转</a>，虽然旋转是一个很好的通用选择。</p><p id="7e13" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的问题在 GitHub 上的<a class="ae lb" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb" rel="noopener ugc nofollow" target="_blank">我的笔记本里。你可以在 BigQuery 控制台或人工智能平台 Jupyter 笔记本中尝试这些查询。</a></p></div></div>    
</body>
</html>