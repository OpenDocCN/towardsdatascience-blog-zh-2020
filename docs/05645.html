<html>
<head>
<title>Generating Test Data Using SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 SQL 生成测试数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/generating-test-data-using-sql-2a1162f5ef16?source=collection_archive---------28-----------------------#2020-05-11">https://towardsdatascience.com/generating-test-data-using-sql-2a1162f5ef16?source=collection_archive---------28-----------------------#2020-05-11</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><figure class="it iu gq gs iv iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj is"><img src="../Images/22dd0912d106bc33e9a7188aff8ed1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sP2ERWQfyRMRC4gm6IRMXQ.jpeg"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated"><a class="ae jh" href="https://unsplash.com/@nci?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">国立癌症研究所</a>在<a class="ae jh" href="https://unsplash.com/s/photos/test-data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h2 id="3f08" class="ji jj jk bd b dl jl jm jn jo jp jq dk jr translated" aria-label="kicker paragraph">数据工程</h2><div class=""/><div class=""><h2 id="a77e" class="pw-subtitle-paragraph kq jt jk bd b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dk translated">使用 SQL 支持应用程序测试和开发</h2></div><p id="0a74" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">开发人员在开发和测试应用程序时需要测试数据。测试数据对于应用程序开发至关重要，因为这是开发人员能够领先模仿 API 响应一步的唯一方法。生成测试数据涉及两种不同的方法。两者都应该用来使应用程序变得更好。</p><ul class=""><li id="20ff" class="me mf jk lk b ll lm lo lp lr mg lv mh lz mi md mj mk ml mm bi translated">使用应用程序期望的数据进行测试(高质量的数据)</li><li id="dd67" class="me mf jk lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated">使用应用程序不期望的数据进行测试(质量差的数据)</li></ul><p id="cb79" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">质量差的数据通常由不支持的字符、较长的字符串、高精度浮点数等组成。了解坏数据通过系统时会发生什么总是很有帮助的。</p><h1 id="3e32" class="ms mt jk bd mu mv mw mx my mz na nb nc kz nd la ne lc nf ld ng lf nh lg ni nj bi translated"><a class="ae jh" href="https://linktr.ee/kovid" rel="noopener ugc nofollow" target="_blank">你需要知道什么</a></h1><p id="ed78" class="pw-post-body-paragraph li lj jk lk b ll nk ku ln lo nl kx lq lr nm lt lu lv nn lx ly lz no mb mc md in bi translated">用 SQL 生成数据非常容易。要编写测试数据生成查询，只需要了解一些事情</p><ul class=""><li id="1177" class="me mf jk lk b ll lm lo lp lr mg lv mh lz mi md mj mk ml mm bi translated">cte 和递归 cte-公用表表达式是命名的结果集。假设查询的输出有一个表名。它的工作原理和熊猫的数据框架非常相似。</li><li id="fb7e" class="me mf jk lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated">rand()，md5()函数— <code class="fe np nq nr ns b">rand()</code>用于生成随机数，<code class="fe np nq nr ns b">md5()</code>不用于加密数据。</li><li id="1071" class="me mf jk lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated">基本字符串操作—基本字符串操作主要用于限制字段长度。</li><li id="8bc7" class="me mf jk lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated">子查询—使用简单的子查询为给定行生成列值。请记住，本质上，这些既不是内联子查询，也不是相关子查询。</li></ul><h1 id="1b79" class="ms mt jk bd mu mv mw mx my mz na nb nc kz nd la ne lc nf ld ng lf nh lg ni nj bi translated">使用 cte</h1><p id="f447" class="pw-post-body-paragraph li lj jk lk b ll nk ku ln lo nl kx lq lr nm lt lu lv nn lx ly lz no mb mc md in bi translated">递归 cte 很棒。它们可用于生成系列数据。类似的事情可以在 PostgreSQL 中使用<code class="fe np nq nr ns b">generate_series</code>，在 Oracle 中使用<code class="fe np nq nr ns b">connect by level</code>，在 MySQL 中使用会话变量<code class="fe np nq nr ns b">@id := @id + 1</code>来完成。几乎所有的数据库都有生成数字序列的变通方法。其中一些变通办法比其他的更好。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/b139f4e9e34637c982b353b1e06edb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sH2-NdmPQ9bILqz_LYRu5Q.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">使用 MariaDB 的递归 cte。在 MySQL 中，您可以使用会话变量来模拟这种情况。在 Oracle 中，您可以使用“按级别连接”来实现这一点。</p></figure><h1 id="d62f" class="ms mt jk bd mu mv mw mx my mz na nb nc kz nd la ne lc nf ld ng lf nh lg ni nj bi translated">SQL 函数— rand()和 md5()</h1><p id="81f8" class="pw-post-body-paragraph li lj jk lk b ll nk ku ln lo nl kx lq lr nm lt lu lv nn lx ly lz no mb mc md in bi translated"><code class="fe np nq nr ns b">rand()</code>函数给你一个 0 到 1 之间的数字。如果我们想要一个介于 0 和 100 之间的数字，我们只需将<code class="fe np nq nr ns b">rand()</code>函数的输出乘以 100。在下面分享的例子中，我正在生成一个介于 12 和 100 之间的数字。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/b166a7223b22caed8507ba8bcac821c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*APelU-slZH7XdFPPh2psEA.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">生成一个介于 12 和 100 之间的数字，用于生成一个人的随机年龄数字</p></figure><p id="75bd" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">使用另一个 CTE 将城市列表用作表格。CTE 上的<code class="fe np nq nr ns b">order by rand()</code>将从城市列表中随机选择一个城市。请注意两个后续查询的结果是不同的。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/ee5ff07a65b451ce22650711fb45fa0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KsW0BmMQybChKEud4yy0Nw.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">从城市列表中随机选择一个城市</p></figure><p id="af9e" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">类似地，还有两个 cte，一个用于常见的名，另一个用于常见的姓。随机选取的这两个字段的任意组合将生成一个新名称。显然，由于<code class="fe np nq nr ns b">order by rand()</code>条款和提供给 CTE 的名称数量有限，名称可能会重复。</p><p id="79e4" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">如果你不在乎名字看起来有多真实，你可以使用<code class="fe np nq nr ns b">substring(md5(rand()),1,6)</code>生成随机的字符串。这会给你一个包含六个字符的随机字符串。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/fbb2f1e4a6c10960936711c6b887046b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gluNxIREMdkSTOI6Tzk8jg.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">从名和姓的列表中生成随机名称</p></figure><h1 id="1157" class="ms mt jk bd mu mv mw mx my mz na nb nc kz nd la ne lc nf ld ng lf nh lg ni nj bi translated">生成随机日期</h1><p id="8828" class="pw-post-body-paragraph li lj jk lk b ll nk ku ln lo nl kx lq lr nm lt lu lv nn lx ly lz no mb mc md in bi translated">一旦你想好了在给定范围内生成随机数，那么生成一个随机日期就很容易了。以下示例显示了如何生成 1919 年 1 月 1 日到 2019 年 12 月 28 日之间的随机日期。唯一的警告是，这涵盖了任何给定月份的 1 日至 28 日之间的天数。我们完全可以编写一个查询，通过添加一些条件来覆盖所有日期。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/c07c403ef536511ed45bddae9677ca75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gv_D_Ma158UfzXLEcIZ_7Q.png"/></div></div></figure><p id="bfae" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">最后，我们来看一个仅由 SQL 查询生成的样本数据集。用自动生成的真实数据获取数十万条记录只需要几秒钟的执行时间。</p><p id="032e" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">下面是生成以下数据的脚本</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/e8ec8d060a391259b92c7ed19e0a9398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ct8xg0g9Qnk2vFloFI6nWw.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">样本人口统计数据集</p></figure><figure class="nu nv nw nx gu iw"><div class="bz fq l di"><div class="ny nz l"/></div><p class="jd je gk gi gj jf jg bd b be z dk translated">不使用任何外部依赖项生成测试数据的 SQL 脚本</p></figure><p id="d696" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">显然，下一步是将查询参数化，并使其成为存储函数或存储过程。您可以传递要生成的记录的数量、出生日期的范围等等。</p><h1 id="5960" class="ms mt jk bd mu mv mw mx my mz na nb nc kz nd la ne lc nf ld ng lf nh lg ni nj bi translated">快速修复</h1><p id="0f71" class="pw-post-body-paragraph li lj jk lk b ll nk ku ln lo nl kx lq lr nm lt lu lv nn lx ly lz no mb mc md in bi translated">您可能会看到一个错误，如下图所示。请注意，我试图获取 100000 条记录—在开始时在递归 CTE 中定义— <code class="fe np nq nr ns b">id &lt; 100000</code>。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/dd5d759569038981e3cd5688215fb18a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tbFK83fzz0nzdQLmUwwacQ.png"/></div></div></figure><p id="782f" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">配置变量<code class="fe np nq nr ns b">cte_max_recursion_depth</code>需要设置为 100000 或更大，以获取这些记录。</p><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/3017adbb4b47d131cb7f8b253156aca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KKIFKixl3Sv1FTg69CHPoQ.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">将会话变量 cte_max_recursion_depth 设置为 100001</p></figure><figure class="nu nv nw nx gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/e480bcbe6348bc52b1141e9cf3dfef73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mOeSkqgA1cVkFvEXRUtG8w.png"/></div></div><p class="jd je gk gi gj jf jg bd b be z dk translated">获取 100K 条记录</p></figure><p id="3486" class="pw-post-body-paragraph li lj jk lk b ll lm ku ln lo lp kx lq lr ls lt lu lv lw lx ly lz ma mb mc md in bi translated">在这之后，你应该可以走了。</p></div></div>    
</body>
</html>