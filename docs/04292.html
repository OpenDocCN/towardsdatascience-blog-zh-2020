<html>
<head>
<title>Plotting Google Sheets data in Python with Folium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Folium 在 Python 中绘制 Google Sheets 数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/plotting-crowdsourced-data-with-google-sheets-and-folium-6c9edbef2bb8?source=collection_archive---------32-----------------------#2020-04-18">https://towardsdatascience.com/plotting-crowdsourced-data-with-google-sheets-and-folium-6c9edbef2bb8?source=collection_archive---------32-----------------------#2020-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b11f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 Flask 在 web 应用程序上实时绘制 Google 工作表数据</h2></div><p id="9fbb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这段代码中，我们将尝试模拟世界各地的志愿者通过 Google Sheet 报告地震的工作流程，数据将在 web 地图上实时更新。</p><p id="588f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将使用用于<strong class="kh ir"> Python </strong>的<strong class="kh ir"> <em class="lb"> Flask </em> </strong> web 框架创建 web 平台，并使用优秀的<strong class="kh ir"><em class="lb">leaf</em></strong>库绘制数据，该库是用于<strong class="kh ir">leaf JS 的 Python 包装器。</strong>将使用<strong class="kh ir"><em class="lb">gspread</em></strong><em class="lb"/>库从谷歌工作表中检索数据，该库是<strong class="kh ir">谷歌工作表 API 的 python 包装器。</strong></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/94c6ce0f1584d08728e4b88e1522287c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ihWPszfK7q_auRVFV7AiQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">1900-2017 年世界地震地图(来源:维基共享资源)</p></figure><p id="0e5e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这段代码应该可以在 Linux 和 macOS 系统上正常工作。对于使用 Windows 系统的用户，只需要修改终端中正在运行的命令。</p><h1 id="8b8d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置虚拟环境并安装必要的软件包</h1><ul class=""><li id="1303" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la mr ms mt mu bi translated">创建项目文件夹:<code class="fe mv mw mx my b">mkdir flask_webmap</code></li><li id="8759" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated"><code class="fe mv mw mx my b">cd</code>进入文件夹并设置虚拟环境</li><li id="6848" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">我们将使用 virtualenv 作为我们选择的虚拟环境工具。在项目目录中运行<code class="fe mv mw mx my b">virtualenv venv</code>，创建一个名为 venv 的环境</li><li id="8f21" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">通过运行<code class="fe mv mw mx my b">source venv/bin/activate</code>激活环境</li><li id="805a" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">通过运行<code class="fe mv mw mx my b">python -m pip install -U Flask folium gspread</code>安装所需的模块</li></ul><h1 id="019e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">向 Google 注册我们的应用程序以使用 Google Sheets API</h1><p id="6823" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">要访问来自 Google sheets 的数据，我们需要向 Google Sheets API 注册我们的应用程序。为此，请遵循以下步骤</p><ul class=""><li id="15a2" class="mk ml iq kh b ki kj kl km ko nh ks ni kw nj la mr ms mt mu bi translated">从网络浏览器打开这个<a class="ae nk" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌控制台链接</a></li><li id="c8dd" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">在 Google 控制台仪表板中，单击顶部栏中的新项目链接</li><li id="ff55" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">给你的项目命名，然后点击创建</li><li id="282f" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">点击<strong class="kh ir">启用 API 和服务</strong></li><li id="1f92" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">在打开的列出各种可用 API 的新页面中，选择 Google Sheets API 并启用它</li><li id="8de9" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">启用 API 后，单击出现的<strong class="kh ir">创建凭证</strong>警报</li><li id="9678" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">填写必要的细节:对于问题<strong class="kh ir">选择<strong class="kh ir"> Web 服务器</strong>您将从哪里调用 API？</strong></li><li id="3d4d" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">在下一部分中，输入<strong class="kh ir">服务帐户</strong>的任何名称。角色选项可以留空，但选择<strong class="kh ir"> JSON </strong>作为您的密钥类型，然后单击继续</li><li id="eef2" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">将下载一个包含您的凭证的新 JSON 文件</li><li id="62a4" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">将 JSON 文件复制到项目目录中</li></ul><h1 id="64a5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置一个最小的烧瓶应用程序</h1><ul class=""><li id="d40d" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la mr ms mt mu bi translated">通过运行<code class="fe mv mw mx my b">touch app.py</code>创建一个新的 Python 文件</li><li id="abbe" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">在您选择的编辑器中打开 python 文件，并创建一个最小的 Flask 应用程序</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><ul class=""><li id="d4f2" class="mk ml iq kh b ki kj kl km ko nh ks ni kw nj la mr ms mt mu bi translated">在您的终端中，通过运行<code class="fe mv mw mx my b">export FLASK_APP=app</code>导出 Flask app 环境变量</li><li id="c4f2" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">默认环境设置为生产。通过运行<code class="fe mv mw mx my b">FLASK_ENV=development flask run</code>将此更改为开发</li><li id="e900" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">运行<code class="fe mv mw mx my b">flask run</code>启动应用程序</li><li id="0d0a" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">新的应用程序现在应该可以在<em class="lb"> localhost:5000/ </em>获得</li><li id="56e7" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">该页面应该打印“Hello World”消息</li></ul><h1 id="68d1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">用种子数据创建 Google 表单</h1><ul class=""><li id="6adb" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la mr ms mt mu bi translated">创建新的 google 工作表</li><li id="f270" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">为了这个练习的目的，USGS 的地震位置数据的一个子集被保存在一个表中。要查看原始数据，请访问此<a class="ae nk" href="https://www.kaggle.com/usgs/earthquake-database#database.csv" rel="noopener ugc nofollow" target="_blank">链接</a>。要下载谷歌表单，请点击此<a class="ae nk" href="https://docs.google.com/spreadsheets/d/1x2bVUzH5cnzcDJXnleGteT5zCEytczDAghcRe0Z9WuU/edit?usp=sharing" rel="noopener ugc nofollow" target="_blank">链接</a></li></ul><h1 id="ead1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">访问 Google 工作表数据</h1><p id="c44f" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">使用<em class="lb"> gspread </em>库访问这些数据</p><ul class=""><li id="fea2" class="mk ml iq kh b ki kj kl km ko nh ks ni kw nj la mr ms mt mu bi translated">创建一个新的 python 文件:<code class="fe mv mw mx my b">touch read_sheet.py</code></li><li id="9867" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">并复制以下代码</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="0198" class="nn lt iq bd lu no np dn ly nq nr dp mc ko ns nt me ks nu nv mg kw nw nx mi ny bi translated">理解代码</h2><ol class=""><li id="72ac" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la nz ms mt mu bi translated">首先，我们定义授权的全局变量。用从 Google API 控制台下载的 JSON 文件的名称替换“带凭证的 JSON 文件的名称”。</li><li id="b25c" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">然后，我们打开 google 工作表，使用它的 URL 存储数据</li><li id="120c" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">接下来，我们使用索引位置获取存储数据的特定工作表。第一页索引为“0”</li><li id="6e1f" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">最后，我们定义了一个新函数，该函数从特定的工作表中获取所有记录并将其返回</li></ol><h1 id="0fb2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">测试 Google 工作表访问</h1><ul class=""><li id="7da1" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la mr ms mt mu bi translated">重新打开<em class="lb"> app.py </em>并用以下代码替换代码</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><ul class=""><li id="6e5d" class="mk ml iq kh b ki kj kl km ko nh ks ni kw nj la mr ms mt mu bi translated"><code class="fe mv mw mx my b">flask run</code>从您的终端</li><li id="cca7" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">localhost:5000 现在应该返回数据的 JSON 表示</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oa"><img src="../Images/38d4585c69a27e835f6d54e440977345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7blQovk4Dzb0McFa.png"/></div></div></figure><h1 id="5269" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">绘制地图</h1><p id="cc86" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">现在我们已经验证了对 Google Sheets 数据的访问，让我们在地图上绘制数据。</p><ul class=""><li id="1328" class="mk ml iq kh b ki kj kl km ko nh ks ni kw nj la mr ms mt mu bi translated"><code class="fe mv mw mx my b">touch plot_map.py</code>从您的终端</li><li id="6e22" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">打开<em class="lb"> plot_map.py </em>文件，复制以下代码</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="0926" class="nn lt iq bd lu no np dn ly nq nr dp mc ko ns nt me ks nu nv mg kw nw nx mi ny bi translated">理解代码</h2><ol class=""><li id="5485" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la nz ms mt mu bi translated">首先，我们定义了 basemap_layer 函数，它使用<code class="fe mv mw mx my b">folium.Map()</code>绘制了一个基本地图。除了设置为 2 的<strong class="kh ir"> min_zoom </strong>属性外，地图设置为使用所有默认值</li><li id="db59" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">接下来，我们使用<code class="fe mv mw mx my b">folium.Marker()</code>定义一个函数来绘制地震位置，并将其添加到上一步生成的父地图中</li></ol><h1 id="c270" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">从 Flask 应用程序渲染地图</h1><p id="7f7e" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">打开<code class="fe mv mw mx my b">app.py</code>文件并复制以下代码</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="4988" class="nn lt iq bd lu no np dn ly nq nr dp mc ko ns nt me ks nu nv mg kw nw nx mi ny bi translated">理解代码</h2><ol class=""><li id="8019" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la nz ms mt mu bi translated">从之前创建的<em class="lb"> plot_map.py </em>文件中，我们导入了<strong class="kh ir"> basemap_layer </strong>和<strong class="kh ir">地震 _plot </strong>函数</li><li id="d1f8" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">首先在 flask 应用程序视图中，我们通过调用<code class="fe mv mw mx my b">basemap_layer()</code>函数来创建地图</li><li id="d841" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">对于步骤 2 中生成的地图，我们添加了通过调用<code class="fe mv mw mx my b">earthquake_plot()</code>函数生成的地震位置。步骤 2 中的地图和地震数据作为参数提供</li><li id="782b" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">地图在<em class="lb">模板</em>文件夹中保存为<em class="lb">map.html</em></li><li id="d919" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">最后，我们返回<em class="lb">index.html</em></li></ol><h1 id="adac" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建 index.html 文件</h1><ul class=""><li id="fba1" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la mr ms mt mu bi translated"><code class="fe mv mw mx my b">mkdir templates</code>和<code class="fe mv mw mx my b">touch templates/index.html</code></li><li id="3512" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la mr ms mt mu bi translated">打开<em class="lb">index.html</em>并复制以下代码</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="7716" class="nn lt iq bd lu no np dn ly nq nr dp mc ko ns nt me ks nu nv mg kw nw nx mi ny bi translated">理解代码</h2><ol class=""><li id="4e0e" class="mk ml iq kh b ki mm kl mn ko mo ks mp kw mq la nz ms mt mu bi translated">我们在<em class="lb">模板</em>文件夹中创建<em class="lb">index.html</em>文件</li><li id="7599" class="mk ml iq kh b ki mz kl na ko nb ks nc kw nd la nz ms mt mu bi translated">在 HTML 样板文件的主体中，我们包含了使用 Jinja 模板引擎从 flask 视图生成的<em class="lb">map.html</em></li></ol><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ob"><img src="../Images/5c30d90004f14c2193c5c70d2c4b19ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TQfK5nx_EOJhMNqn.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">Flask 应用程序生成的地图视图</p></figure><h1 id="8948" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">该地图如何帮助绘制众包数据？</h1><p id="48da" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">此应用程序的有趣之处在于，由于映射函数是从 Flask 视图中调用的，因此每次在浏览器中刷新 web 地图时，都会对数据进行 API 调用。因此，任何添加到 Google sheet 的新记录都由应用程序在页面刷新时实时呈现。</p><p id="09d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以让我们试试这个功能。我们都知道 2015 年的尼泊尔地震。让我们更新工作表中的数据。</p><p id="91be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要查找尼泊尔的坐标，请访问 latlong.net 并在搜索框中输入尼泊尔。将纬度和经度值复制到 Google 工作表中。</p><p id="1021" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae nk" href="https://en.wikipedia.org/wiki/April_2015_Nepal_earthquake" rel="noopener ugc nofollow" target="_blank">维基百科</a>也暗示这次地震的震级为 7.8 级。因此，用这个值填充<strong class="kh ir">幅度</strong>列。</p><p id="4b6e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在返回地图视图并刷新页面。您会发现新位置的标记已添加到地图上。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ob"><img src="../Images/905512b28718da9a92ad66bc21eff32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xJ7JM6dMbslkwHDI.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">添加新数据后刷新的地图视图</p></figure><p id="7d56" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这段代码到此结束。如果你觉得这篇文章很有用，请留下你的赞赏或评论。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="b63d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">原载于 2020 年 4 月 18 日</em><a class="ae nk" href="https://www.sourav90.in/2020/04/18/plotting-crowdsourced-data-with-google-sheets-and-folium.html" rel="noopener ugc nofollow" target="_blank"><em class="lb">https://www . sourav 90 . in</em></a><em class="lb">。</em></p></div></div>    
</body>
</html>