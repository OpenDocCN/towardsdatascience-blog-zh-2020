<html>
<head>
<title>Virtual Drum Set using OpenCV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenCV的虚拟鼓组</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/virtual-drum-set-using-opencv-ebcb1553c778?source=collection_archive---------48-----------------------#2020-05-25">https://towardsdatascience.com/virtual-drum-set-using-opencv-ebcb1553c778?source=collection_archive---------48-----------------------#2020-05-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1a65" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">学习使用OpenCV和Python的计算机视觉概念构建虚拟架子鼓</h2></div><p id="1826" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你是计算机视觉的新手，或者你有强烈的打鼓冲动，但没有鼓，那么你来对地方了！</p><p id="139d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，我们将使用OpenCV的计算机视觉的基本概念建立一个虚拟鼓组。如果你是OpenCV的初学者，这将是一个很好的尝试教程。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/e00ee2345fe02795fec5f1ed137c85df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9fM0ltnoAU5pL1UE5SHGw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">虚拟鼓在行动</p></figure><p id="bfa2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将从头开始构建项目，最终你会有一个很酷的项目来炫耀！</p><p id="a12c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有的源代码都可以在<a class="ae lr" href="https://github.com/navendu-pottekkat/virtual-drums" rel="noopener ugc nofollow" target="_blank">这个GitHub资源库</a>中找到。首先，在您的本地机器上派生并克隆<a class="ae lr" href="https://github.com/navendu-pottekkat/virtual-drums" rel="noopener ugc nofollow" target="_blank">存储库</a>。</p><p id="4077" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ls lt lu lv b">git clone link_to_your_forked_repo</code></p><h1 id="9d23" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">装置</h1><p id="ae77" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated"><a class="ae lr" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank">你的设备应该安装Python 3.6+ </a>。</p><p id="dd26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到您的分叉目录(您下载的文件夹)。</p><p id="4ad4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过在终端中运行以下命令，可以在您的环境中安装项目所需的包。</p><p id="c1b4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ls lt lu lv b">pip install -r requirements.txt</code></p><h1 id="210a" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">运行文件</h1><p id="3b6a" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">在项目文件夹中运行以下命令。</p><p id="a738" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ls lt lu lv b">python virtual_drums.py</code></p><p id="8146" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将在屏幕上看到添加了鼓的网络摄像头的输出。你可以用一根绿色的棍子敲鼓(钢笔或铅笔都可以)。</p><p id="86ba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">需要绿色棒，因为我们使用了一个检测窗口来检测绿色。</p><p id="3d65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在遮光罩下，当窗口(图像中有鼓的部分)检测到绿色物体时，它会将其解释为鼓被击打并播放节拍。</p><p id="ddff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在来看看实现这一点的代码。</p><h1 id="6bda" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">代码</h1><p id="a8ec" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">在您喜欢的文本编辑器中打开<code class="fe ls lt lu lv b">virtual_drums.py</code>文件。</p><p id="cf32" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以继续构建您自己的文件，或者编辑您下载的文件。我们现在来看看这一切是如何工作的！</p><p id="ff2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从导入必要的库开始。如果没有运行<code class="fe ls lt lu lv b">pip install -r requirements.txt</code>，你需要在你的环境中安装这些</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="1d75" class="mx lx iq lv b gy my mz l na nb"># Importing the necessary libraries<br/>import numpy as np<br/>import time<br/>import cv2<br/>from pygame import mixer</span></pre><p id="a0bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们定义一个函数，当在窗口上检测到绿色对象时播放鼓声。</p><p id="c518" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果检测到的颜色在我们设定的范围内，我们就播放声音。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="4492" class="mx lx iq lv b gy my mz l na nb"># This function plays the corresponding drum beat if a green color object is detected in the region<br/>def play_beat(detected,sound):</span><span id="499a" class="mx lx iq lv b gy nc mz l na nb"># Checks if the detected green color is greater that a preset value <br/> play = (detected) &gt; hat_thickness[0]*hat_thickness[1]*0.8</span><span id="2a4d" class="mx lx iq lv b gy nc mz l na nb"># If it is detected play the corresponding drum beat<br/> if play and sound==1:<br/> drum_snare.play()<br/> <br/> elif play and sound==2:<br/> drum_hat.play()<br/> time.sleep(0.001)</span></pre><p id="2e2b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们定义一个函数来检测绿色是否出现在我们的窗口中。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="d600" class="mx lx iq lv b gy my mz l na nb"># This function is used to check if green color is present in the small region<br/>def detect_in_region(frame,sound):<br/>	<br/>	# Converting to HSV<br/>	hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)<br/><br/>	# Creating mask<br/>	mask = cv2.inRange(hsv, greenLower, greenUpper)<br/>	<br/>	# Calculating the number of green pixels<br/>	detected = np.sum(mask)<br/>	<br/>	# Call the function to play the drum beat<br/>	play_beat(detected,sound)<br/><br/>	return mask</span></pre><p id="6e87" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们导入我们的鼓点并存储它。</p><p id="d32d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们设置应该检测的绿色的上限和下限。你可以把它改变到你想要的颜色的极限。</p><p id="1023" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们启动网络摄像头并从中读取输入。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="ed0d" class="mx lx iq lv b gy my mz l na nb"># A flag variable to choose whether to show the region that is being detected<br/>verbose = False<br/><br/># Importing drum beats<br/>mixer.init()<br/>drum_hat = mixer.Sound('./sounds/high_hat_1.ogg')<br/>drum_snare = mixer.Sound('./sounds/snare_1.wav')<br/><br/><br/># Set HSV range for detecting green color <br/>greenLower = (25,52,72)<br/>greenUpper = (102,255,255)<br/><br/># Obtain input from the webcam <br/>camera = cv2.VideoCapture(0)<br/>ret,frame = camera.read()<br/>H,W = frame.shape[:2]<br/><br/>kernel = np.ones((7,7),np.uint8)</span></pre><p id="e7d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将导入要添加到视频输出中的鼓的图像。在这个例子中，我下载并添加了一顶高帽和一个小鼓。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="a5f2" class="mx lx iq lv b gy my mz l na nb"># Read the image of High Hat and the Snare drum</span><span id="8929" class="mx lx iq lv b gy nc mz l na nb">hat = cv2.resize(cv2.imread('./images/high_hat.png'),(200,100),interpolation=cv2.INTER_CUBIC)</span><span id="48e5" class="mx lx iq lv b gy nc mz l na nb">snare = cv2.resize(cv2.imread('./images/snare_drum.png'),(200,100),interpolation=cv2.INTER_CUBIC)</span></pre><p id="02cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在将设置应该检测绿色的区域或窗口。在本例中，我们有两个鼓，因此我们创建了两个窗口。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="6e36" class="mx lx iq lv b gy my mz l na nb"># Set the region area for detecting green color <br/>hat_center = [np.shape(frame)[1]*2//8,np.shape(frame)[0]*6//8]<br/>snare_center = [np.shape(frame)[1]*6//8,np.shape(frame)[0]*6//8]<br/><br/>hat_thickness = [200,100]<br/>hat_top = [hat_center[0]-hat_thickness[0]//2,hat_center[1]-hat_thickness[1]//2]<br/>hat_btm = [hat_center[0]+hat_thickness[0]//2,hat_center[1]+hat_thickness[1]//2]<br/><br/>snare_thickness = [200,100]<br/>snare_top = [snare_center[0]-snare_thickness[0]//2,snare_center[1]-snare_thickness[1]//2]<br/>snare_btm = [snare_center[0]+snare_thickness[0]//2,snare_center[1]+snare_thickness[1]//2]<br/><br/>time.sleep(1)</span></pre><p id="234b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们运行一个无限循环，当我们按下键盘上的“Q”时，这个循环就会中断。</p><p id="209f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用函数在屏幕上显示鼓声，并调用函数检测是否有绿色物体击中窗口。</p><p id="0116" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们必须在按“Q”退出后清理打开的窗口。</p><pre class="lc ld le lf gt mt lv mu mv aw mw bi"><span id="88eb" class="mx lx iq lv b gy my mz l na nb">while True:<br/>	<br/>	# Select the current frame<br/>	ret, frame = camera.read()<br/>	frame = cv2.flip(frame,1)<br/><br/>	if not(ret):<br/>	    break<br/>    <br/>	# Select region corresponding to the Snare drum<br/>	snare_region = np.copy(frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]])<br/>	mask = detect_in_region(snare_region,1)<br/><br/>	# Select region corresponding to the High Hat<br/>	hat_region = np.copy(frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]])<br/>	mask = detect_in_region(hat_region,2)<br/><br/>	# Output project title<br/>	cv2.putText(frame,'Virtual Drums',(10,30),2,1,(20,20,20),2)<br/>    <br/>	# If flag is selected, display the region under detection<br/>	if verbose:<br/>		frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]] = cv2.bitwise_and(frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]],frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]], mask=mask[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]])<br/>		frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]] = cv2.bitwise_and(frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]],frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]],mask=mask[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]])<br/>    <br/>	# If flag is not selected, display the drums<br/>	else:<br/>		frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]] = cv2.addWeighted(snare, 1, frame[snare_top[1]:snare_btm[1],snare_top[0]:snare_btm[0]], 1, 0)<br/>		frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]] = cv2.addWeighted(hat, 1, frame[hat_top[1]:hat_btm[1],hat_top[0]:hat_btm[0]], 1, 0)<br/>    <br/>    <br/>	cv2.imshow('Output',frame)<br/>	key = cv2.waitKey(1) &amp; 0xFF<br/>	# 'Q' to exit<br/>	if key == ord("q"):<br/>		break</span><span id="f9e9" class="mx lx iq lv b gy nc mz l na nb"># Clean up the open windows<br/>camera.release()<br/>cv2.destroyAllWindows()</span></pre><p id="89c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！现在你可以用你的虚拟架子鼓演奏了。尝试更换鼓或将更多鼓添加到项目中。</p><p id="c43c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以利用这些知识，通过OpenCV构建自己的计算机视觉应用程序。</p><p id="1ce4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编码快乐！</p></div></div>    
</body>
</html>