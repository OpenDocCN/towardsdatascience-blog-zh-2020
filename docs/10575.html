<html>
<head>
<title>Using Facebook’s Prophet to Forecast Sales of over 30000 Wallmart Products (Kaggle Bronze Medal)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用脸书的预言家预测超过 30000 件沃尔玛产品的销售(Kaggle 铜牌)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-facebooks-prophet-to-forecast-sales-of-over-30000-wallmart-products-kaggle-bronze-medal-c47aba5a5bc2?source=collection_archive---------31-----------------------#2020-07-24">https://towardsdatascience.com/using-facebooks-prophet-to-forecast-sales-of-over-30000-wallmart-products-kaggle-bronze-medal-c47aba5a5bc2?source=collection_archive---------31-----------------------#2020-07-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/dff5e8c0978f8f0c795af218ee1bffd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M-79Q9XHQqjxjPm9GW9IHA.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">用脸书预言家预测沃尔玛的销售。亨特·哈里特在<a class="ae kf" href="https://unsplash.com/s/photos/data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="ccbd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我将解释我是如何使用脸书的开源预测模型 Prophet 在 T4 M5 预测大赛上获得铜牌的。</p><h1 id="fd28" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">什么是脸书先知？</h1><p id="a7fa" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">很久以前我就想尝试一下脸书的先知。引用脸书的文档:<em class="mh">“Prophet 是一种基于加法模型预测时间序列数据的程序，其中非线性趋势符合每年、每周和每天的季节性，加上假日效应。它最适用于具有强烈季节效应的时间序列和几个季节的历史数据。Prophet 对缺失数据和趋势变化具有稳健性，通常能很好地处理异常值。</em></p><p id="699d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简而言之，它是一个自动化的时间序列生成器。由于在这场 Kaggle 比赛中有超过 30，000 个时间序列，这个自动化方面真的很棒:数据太大了，无法单独查看每个时间序列。</p><p id="3daa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您想跟随完整的笔记本，这里有两个链接:</p><ul class=""><li id="bd93" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated"><em class="mh"/><a class="ae kf" href="https://jooskorstanje.com/prophet-with-defaults.html" rel="noopener ugc nofollow" target="_blank"><em class="mh">先知笔记本带有默认的</em> </a>和</li><li id="11a5" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated"><a class="ae kf" href="https://jooskorstanje.com/prophet-with-hyperparameter-tuning.html" rel="noopener ugc nofollow" target="_blank"> <em class="mh">先知笔记本带超参数调</em> </a> <em class="mh">。</em></li></ul><h1 id="2cd5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">卡格尔竞赛和数据</h1><p id="01da" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">M5 预测竞赛为我们提供了沃尔玛的分层销售数据。目标是预测美国三个州(加利福尼亚州、德克萨斯州和威斯康星州)商店未来 28 天的日销售额。数据包括项目级别、部门、产品类别和商店详细信息。此外，我们还有解释变量，如价格、促销、星期几和特殊事件。</p><h2 id="5c71" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">销售数据</h2><p id="330a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我将销售数据放在每列一个产品和每行一天的格式中。</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="cb29" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">训练数据包含每个产品/商店组合的 30490 列，行是日期:</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/35a90039d88478e3be62ac0fbc953316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kV6MqMa11vvIKD7wZrjtfg.png"/></div></div></figure><p id="f105" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">测试数据的格式与列车数据相同，但包含连续的 28 天:</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/797347c5c33acf9a44aabe9f7a97e748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f6F_TEdQMKLqXQzqogui5Q.png"/></div></div></figure><h2 id="1581" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">在 Prophet 中添加假日和事件数据</h2><p id="f290" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我准备了假期和事件数据，以符合 Prophet 的<em class="mh">假期</em>论点。格式必须是固定列<em class="mh">假日</em>和<em class="mh"> ds </em>的数据帧。在 ds 中，你给出了这个假期发生的日期的列表，包括过去和将来(直到你的预测发生)。</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="87bc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假日的 Kaggle 数据看起来像这样，每天一天的格式。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/7fd5a527576c864431ff6cdc8ec395ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rDwdqaMVE2kKFYwDux6Z2Q.png"/></div></div></figure><p id="bc51" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了将该数据传递给 Prophet，必须对其进行重新格式化，以仅包含节假日，并为每个节假日列出该节假日发生的日期:</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="3006" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">在 Prophet 中添加更多独立变量</h2><p id="c1ce" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">还提供了价格数据。我没有把它包括在内，尽管在 Prophet 中添加更多数据是可能的。我相信它可以取得更好的结果，但由于时间限制，我没有尝试</p><h1 id="c9bc" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">脸书先知超参数</h1><p id="8113" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我用不同的方法对超参数做了两次尝试:第一次尝试使用默认的超参数，第二次尝试使用小的优化。我很想用更大的优化做第三次尝试，但是我没有计算时间来运行 30，000 次。</p><h2 id="423b" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">1.具有所有默认超参数的 Prophet</h2><p id="22e1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">用 Prophet 运行 30，000 个时间序列花了我大量的时间(我有 6 个 Kaggle 笔记本，每个运行 5000 个时间序列，仍然花了我几个小时)。第一次提交使用了 Prophet 的所有默认设置。</p><p id="6e55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">如何使用 Prophet 的基础知识:</strong></p><ul class=""><li id="0075" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated">使用假期数据(以准备好的形式)初始化 Prophet</li><li id="8b53" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">让先知适应训练数据</li><li id="2758" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">制作一个未来的数据框架</li><li id="34fa" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">使用 Prophet 对未来数据框架进行预测</li></ul><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="bd27" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以将此应用于所有超过 30000 个时间序列，其中包括使用 imap，如下所示:</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="4e79" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一次提交给我的分数是 0.83(加权均方根误差)。虽然它在排行榜上是最差的 30%，但我对它的第一个结果很满意。</p><h2 id="6f1d" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">2.具有超参数调谐的 Prophet</h2><p id="8fad" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我使用超参数调整进行了第二次提交。已经花了几个小时来运行默认值，并且有许多超参数和设置可以在 Prophet 中修复。</p><h2 id="fdcc" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">要在 Prophet 中调谐的超参数</h2><p id="907c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">经过一些尝试后，以下超参数似乎有所不同:</p><ul class=""><li id="4f7d" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated">每周季节性的傅立叶顺序</li><li id="edc9" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">月度季节性的傅立叶顺序</li><li id="bfd9" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">年度季节性的傅立叶顺序</li><li id="9f28" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">季节性 _ 先验 _ 标度</li><li id="e138" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">假日 _ 先验 _ 标度</li><li id="7995" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">变点 _ 先验 _ 标度</li></ul><p id="b1f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对所有这些进行调优会使代码太慢。作为一个解决方案，我通过网格搜索只对 4 种不同的组合进行了调整，如下所示:</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="d8a5" class="mw lf it bd lg mx my dn lk mz na dp lo kr nb nc ls kv nd ne lw kz nf ng ma nh bi translated">Prophet 中的交叉验证</h2><p id="3b8c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Prophet 中有一种交叉验证的方法。然而，我更喜欢使用如下的列车验证测试方法:</p><ul class=""><li id="1864" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated">拟合训练数据的所有超参数组合</li><li id="5da5" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">测量验证数据的误差并选择最佳模型</li><li id="7795" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">使用最佳模型的超参数对添加到验证数据的训练数据重新拟合模型</li><li id="46ea" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">使用此模型对测试数据进行预测</li></ul><p id="2157" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用超参数构建一个模型的代码:</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="2dc9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在一列上进行预测的代码，包括训练-验证-测试方法:</p><figure class="ni nj nk nl gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9112" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我使用和上面写的一样的 imap 方法来拟合所有的预测。</p><h1 id="6a4f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="e859" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">网格搜索法让我有了显著的提高，新的分数是 0.68。这种方法用相对少的时间让我在比赛中获得了铜牌(5558 名中的第 501 名)。</p><p id="8af8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">记得看一下完整的笔记本:<em class="mh">带默认值的</em> <a class="ae kf" href="https://jooskorstanje.com/prophet-with-defaults.html" rel="noopener ugc nofollow" target="_blank"> <em class="mh">先知笔记本</em> </a>和带超参数调优的<a class="ae kf" href="https://jooskorstanje.com/prophet-with-hyperparameter-tuning.html" rel="noopener ugc nofollow" target="_blank"> <em class="mh">先知笔记本</em> </a> <em class="mh">。</em></p><p id="b2a4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当然还有改进的空间，但我已经很乐意分享我所能做到的。希望这对你也有用。感谢阅读，不要犹豫，继续关注更多！</p></div></div>    
</body>
</html>