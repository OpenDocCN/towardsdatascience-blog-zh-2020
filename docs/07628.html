<html>
<head>
<title>Implementing a Trading Algorithm with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 R 实现一个交易算法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/implementing-a-trading-algorithm-with-r-315a175538bd?source=collection_archive---------25-----------------------#2020-06-08">https://towardsdatascience.com/implementing-a-trading-algorithm-with-r-315a175538bd?source=collection_archive---------25-----------------------#2020-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0cbc7f3a3fc2fd1817be2275557161cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHSuUIWAF95oZhFBvF_IKQ.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">克里斯·利维拉尼在<a class="ae kf" href="https://unsplash.com/s/photos/stocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="aba2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个故事解释了如何用 r 实现移动平均线交易算法。如果你对建立你的自动交易管道感兴趣，你应该首先阅读<a class="ae kf" rel="noopener" target="_blank" href="/automated-stock-trading-with-r-part-1-5a1020831096?source=social.tw">这篇</a>文章。这个故事是一个纯粹的技术指南，侧重于编程和统计，而不是财务建议。</p><p id="cce6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在整个故事中，我们将构建一个 R 函数，它将历史股票数据和任意阈值作为输入，并基于它来决定是否是购买给定股票的好时机。我们会看看苹果股票。这篇文章可能需要一定程度的统计知识。大学水平的统计学模块介绍应该足够了。</p><h1 id="aed4" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak"> 1。移动平均算法</strong></h1><p id="6878" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">移动平均交易算法利用了股票趋势的波动。我们首先确定给定时间序列的斜率是否为正。为了简单起见，我们设计的这个算法只适用于积极趋势的股票。然后我们取消历史时间序列的趋势，检查最近的波动是高于还是低于移动平均线。如果当前价格低于移动平均线，并且我们手中没有该股票，我们就买入该股票。如果它高于移动平均线，并且股票目前在我们的持股范围内，我们就卖出股票。</p><p id="9972" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">图 1 代表苹果股票在过去 50 天的收盘价。我们对这个时间序列进行去趋势化，这样红色虚线就与 x 轴对齐了。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/2bae1fab7cc2be3dd0849ab800c49a31.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*jw4DzaOoJkbv43zfpdB4DQ.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图 1:苹果股票收盘价(美元)</p></figure><p id="2b03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">图 2 显示了苹果股票在过去 50 天的走势。去趋势时间序列看起来是平稳的，即它具有恒定的均值和方差。如果我们想要非常严格，我们可以测试平稳性，以确保它具有理想的属性。我们选择任意阈值为+-5%。如果股票的 5 天平均价格比去趋势时间序列低 5%，我们就买入，如果比去趋势时间序列高 5%，我们就卖出。如果交易成功，在此期间，我们将获得 10%以上的收益。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/a75ea4a2616d9dbe4b90dc8cad038768.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*UE-Hdk7iVMmLn4O1ztf8EA.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图 2:去除趋势后的 APPL 股票时间序列残差</p></figure><h1 id="4d88" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">2.代码实现</h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/6f0fbaf454fb9ccd93f354766e7f0156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ctRjv5OAkdAFtLCHLhblVw.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">凯文·Ku 在<a class="ae kf" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="afe2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该函数有两个输入。雅虎 API 的历史数据和买卖股票的任意阈值。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="cc27" class="mt lf it mp b gy mu mv l mw mx">moving_average_model &lt;- function(</span><span id="5e9f" class="mt lf it mp b gy my mv l mw mx">data,</span><span id="c792" class="mt lf it mp b gy my mv l mw mx">trend_deviation_treshold = -5) {</span><span id="e20c" class="mt lf it mp b gy my mv l mw mx">…</span><span id="1dd5" class="mt lf it mp b gy my mv l mw mx">}</span></pre><p id="749a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们访问当前持有的股票，以检查我们在过去购买了哪些股票。下面，我们检查一下我们的投资组合中目前是否持有苹果股票。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="c21e" class="mt lf it mp b gy mu mv l mw mx">holdings &lt;- current_holdings()</span><span id="c075" class="mt lf it mp b gy my mv l mw mx">if ((holdings %&gt;% filter(stock == "APPL"))$stock == "APPL") {</span><span id="e478" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio = TRUE</span><span id="e897" class="mt lf it mp b gy my mv l mw mx">} else {</span><span id="e363" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio = FALSE</span><span id="0c95" class="mt lf it mp b gy my mv l mw mx">}</span></pre><p id="2723" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们将历史数据声明为一个数据框，将包含日期的行名称转换为一个单独的列，只考虑过去 70 天(股票市场开放时大约 50 个工作日)的收盘价和日期。最后，我们创建一个额外的列，为每一天提供一个数字。最近一天的数字最高。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="85f3" class="mt lf it mp b gy mu mv l mw mx">data &lt;- as.data.frame(data) %&gt;%</span><span id="27d1" class="mt lf it mp b gy my mv l mw mx">tibble::rownames_to_column("date")</span><span id="8862" class="mt lf it mp b gy my mv l mw mx">data_close &lt;- data %&gt;%</span><span id="2364" class="mt lf it mp b gy my mv l mw mx">select(date, close = AAPL.Close) %&gt;%</span><span id="12d5" class="mt lf it mp b gy my mv l mw mx">filter(date &gt; as.Date(Sys.Date() - 70)) %&gt;%</span><span id="1d20" class="mt lf it mp b gy my mv l mw mx">arrange(date) %&gt;%</span><span id="246d" class="mt lf it mp b gy my mv l mw mx">mutate(day_number = row_number())</span></pre><p id="1e78" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是消除时间序列的趋势。我们已经为上面的每个日期创建了一个数字递增的变量。如果我们把它作为一个独立的变量，用日期来绘制，这将会形成一条直线。因此，我们可以使用这个变量来消除趋势。如果我们回归这个变量上的股票价格，这将使时间序列趋向。然后，我们可以处理回归的残差，以确定当前价格是高于还是低于移动平均线。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="0809" class="mt lf it mp b gy mu mv l mw mx">formula &lt;- close ~ day_number</span><span id="4aef" class="mt lf it mp b gy my mv l mw mx">regression_model &lt;- lm(</span><span id="013c" class="mt lf it mp b gy my mv l mw mx">formula = formula,</span><span id="8fc8" class="mt lf it mp b gy my mv l mw mx">data = data_close</span><span id="7aca" class="mt lf it mp b gy my mv l mw mx">)</span></pre><p id="d36a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能会注意到，我们不抑制常数项，也不考虑在进一步的分析。我们只关心当前价格相对于平均价格的位置。因此，我们只能分析残差。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="6bdb" class="mt lf it mp b gy mu mv l mw mx">recent_5 &lt;- residual_values %&gt;%</span><span id="63d2" class="mt lf it mp b gy my mv l mw mx">rename("residual" = "regression_model$residuals") %&gt;%</span><span id="e471" class="mt lf it mp b gy my mv l mw mx">filter(day_number &gt; max(day_number) - 6) %&gt;%</span><span id="7938" class="mt lf it mp b gy my mv l mw mx">summarise(close_mean = mean(residual, na.rm = TRUE))</span></pre><p id="1dfd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们计算最近 5 个工作日的平均收盘均值。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="038f" class="mt lf it mp b gy mu mv l mw mx">recent_5_50 &lt;- residual_values %&gt;%</span><span id="fa1f" class="mt lf it mp b gy my mv l mw mx">rename("residual" = "regression_model$residuals") %&gt;%</span><span id="64dd" class="mt lf it mp b gy my mv l mw mx">filter(day_number &lt;=  max(day_number) - 6) %&gt;%</span><span id="1267" class="mt lf it mp b gy my mv l mw mx">summarise(close_mean = mean(residual, na.rm = TRUE))</span></pre><p id="14ea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们计算过去 5 到 50 个工作日的平均值。接下来，我们计算最近 5 天的平均值与 6 到 50 个工作日平均值的偏差。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="1d27" class="mt lf it mp b gy mu mv l mw mx">trend_deviation &lt;- (</span><span id="46fe" class="mt lf it mp b gy my mv l mw mx">(recent_5$close_mean - recent_5_50$close_mean) /</span><span id="f9d6" class="mt lf it mp b gy my mv l mw mx">recent_5_50$close_mean</span><span id="2043" class="mt lf it mp b gy my mv l mw mx">) * 100</span></pre><p id="0127" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果过去 5 天的当前偏差低于 5 到 50 天，我们就买入股票。如果我们已经持有苹果股票，如果偏离超过阈值，我们就卖出。我们也检查每一次给定股票的时间序列有一个正斜率。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="7bc0" class="mt lf it mp b gy mu mv l mw mx">if (</span><span id="aea2" class="mt lf it mp b gy my mv l mw mx">trend_deviation &lt; trend_deviation_treshold &amp;</span><span id="b237" class="mt lf it mp b gy my mv l mw mx">regression_model$coefficients[[2]] &gt; 0 &amp;</span><span id="3611" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio == FALSE</span><span id="cc1b" class="mt lf it mp b gy my mv l mw mx">) {</span><span id="b549" class="mt lf it mp b gy my mv l mw mx">decision_sell &lt;-  FALSE</span><span id="60c9" class="mt lf it mp b gy my mv l mw mx">decision_buy &lt;- TRUE</span><span id="6eb2" class="mt lf it mp b gy my mv l mw mx">} else if (</span><span id="61ad" class="mt lf it mp b gy my mv l mw mx">trend_deviation &gt; -trend_deviation_treshold &amp;</span><span id="83ab" class="mt lf it mp b gy my mv l mw mx">regression_model$coefficients[[2]] &gt; 0 &amp;</span><span id="a1ce" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio == TRUE</span><span id="c849" class="mt lf it mp b gy my mv l mw mx">) {</span><span id="1799" class="mt lf it mp b gy my mv l mw mx">decision_sell &lt;-  TRUE</span><span id="5eae" class="mt lf it mp b gy my mv l mw mx">decision_buy &lt;- FALSE</span><span id="44b0" class="mt lf it mp b gy my mv l mw mx">}</span></pre><p id="8c75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一步是创建一个数据框，记录算法所做决策的细节。我们创建一个唯一的 id，包括股票名称和日期，记录运行日期，访问股票价格的日期，股票名称，给定股票的收盘价，计算的趋势偏差，我们选择的阈值，5 天和 45 天的平均值，买入决定和卖出决定。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="dff3" class="mt lf it mp b gy mu mv l mw mx">output &lt;- data.frame(</span><span id="773a" class="mt lf it mp b gy my mv l mw mx">id = paste0("APPL-", Sys.Date()),</span><span id="e67e" class="mt lf it mp b gy my mv l mw mx">run_time = as.character(Sys.time()),</span><span id="ffac" class="mt lf it mp b gy my mv l mw mx">stock_date = (data %&gt;% filter(date == max(date)))$date,</span><span id="008f" class="mt lf it mp b gy my mv l mw mx">stock = "APPL",</span><span id="1214" class="mt lf it mp b gy my mv l mw mx">close_price = (data %&gt;% filter(date == max(date)))$AAPL.Close,</span><span id="ca84" class="mt lf it mp b gy my mv l mw mx">trend_deviation = trend_deviation,</span><span id="8b71" class="mt lf it mp b gy my mv l mw mx">threshold = trend_deviation_treshold,</span><span id="10a2" class="mt lf it mp b gy my mv l mw mx">recent_5_avg = recent_5$close_mean,</span><span id="3b7f" class="mt lf it mp b gy my mv l mw mx">recent_5_50_avg = recent_5_50$close_mean,</span><span id="e6b5" class="mt lf it mp b gy my mv l mw mx">decision_buy = decision_buy,</span><span id="c791" class="mt lf it mp b gy my mv l mw mx">decision_sell = decision_sell</span><span id="b23b" class="mt lf it mp b gy my mv l mw mx">)</span></pre><h1 id="c867" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">3.摘要</h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/bd7dad50afa1d0c27b9d04b045f47995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-Rsob3HmkLmRs0g5fV-FQ.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@markusspiske?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马库斯·斯皮斯克</a>在<a class="ae kf" href="https://unsplash.com/s/photos/economy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="afa1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们已经使用 r 实施了移动平均线交易策略。我们只是查看给定股票的历史数据，检查它是否有正趋势，计算当前平均趋势偏差，并基于此做出决策。</p><p id="974a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们在主<a class="ae kf" rel="noopener" target="_blank" href="/automated-stock-trading-with-r-part-1-5a1020831096?source=social.tw">交易管道</a>中调用这个算法，并将这个决定的细节记录到 google sheets 中。</p><p id="cb5d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将来，我会将上述算法扩展到多只股票，这样我们就可以提供我们感兴趣的股票列表，算法/管道会自动交易它们。我们还可以对输入进行额外的健全性检查，并进行平稳性检查，以确保消除趋势的时间序列具有理想的属性。</p><p id="2a71" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> <em class="na">来自《走向数据科学》编辑的提示:</em> </strong> <em class="na">虽然我们允许独立作者根据我们的</em> <a class="ae kf" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="na">规则和指导方针</em> </a> <em class="na">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae kf" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="na">读者术语</em> </a> <em class="na">。</em></p><p id="7330" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">附录</strong></p><p id="7b98" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">移动平均交易函数的完整代码</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="ca05" class="mt lf it mp b gy mu mv l mw mx">moving_average_model &lt;- function(</span><span id="2eac" class="mt lf it mp b gy my mv l mw mx">data,</span><span id="47be" class="mt lf it mp b gy my mv l mw mx">trend_deviation_treshold = 3) {</span><span id="6d5c" class="mt lf it mp b gy my mv l mw mx">holdings &lt;- current_holdings()</span><span id="9b00" class="mt lf it mp b gy my mv l mw mx">if ((holdings %&gt;% filter(stock == "APPL"))$stock == "APPL") {</span><span id="2fc2" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio = TRUE</span><span id="546b" class="mt lf it mp b gy my mv l mw mx">} else {</span><span id="6206" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio = FALSE</span><span id="c8d1" class="mt lf it mp b gy my mv l mw mx">}</span><span id="c035" class="mt lf it mp b gy my mv l mw mx">data &lt;- as.data.frame(data) %&gt;%</span><span id="c6bd" class="mt lf it mp b gy my mv l mw mx">tibble::rownames_to_column("date")</span><span id="e972" class="mt lf it mp b gy my mv l mw mx">data_close &lt;- data %&gt;%</span><span id="ee23" class="mt lf it mp b gy my mv l mw mx">select(date, close = AAPL.Close) %&gt;%</span><span id="2141" class="mt lf it mp b gy my mv l mw mx">filter(date &gt; as.Date(Sys.Date() - 70)) %&gt;%</span><span id="c3d8" class="mt lf it mp b gy my mv l mw mx">arrange(date) %&gt;%</span><span id="9471" class="mt lf it mp b gy my mv l mw mx">mutate(day_number = row_number())</span><span id="74f3" class="mt lf it mp b gy my mv l mw mx">formula &lt;- close ~ day_number</span><span id="5eff" class="mt lf it mp b gy my mv l mw mx">regression_model &lt;- lm(formula = formula,</span><span id="ad2f" class="mt lf it mp b gy my mv l mw mx">data = data_close)</span><span id="55f0" class="mt lf it mp b gy my mv l mw mx">residual_values &lt;- bind_cols(</span><span id="8897" class="mt lf it mp b gy my mv l mw mx">as.data.frame(regression_model$residuals),</span><span id="50aa" class="mt lf it mp b gy my mv l mw mx">data_close)</span><span id="2dfc" class="mt lf it mp b gy my mv l mw mx">recent_5 &lt;- residual_values %&gt;%</span><span id="e126" class="mt lf it mp b gy my mv l mw mx">rename("residual" = "regression_model$residuals") %&gt;%</span><span id="7b03" class="mt lf it mp b gy my mv l mw mx">filter(day_number &gt; max(day_number) - 6) %&gt;%</span><span id="3b04" class="mt lf it mp b gy my mv l mw mx">summarise(close_mean = mean(residual, na.rm = TRUE))</span><span id="d70f" class="mt lf it mp b gy my mv l mw mx">recent_5_50 &lt;- residual_values %&gt;%</span><span id="667e" class="mt lf it mp b gy my mv l mw mx">rename("residual" = "regression_model$residuals") %&gt;%</span><span id="a1de" class="mt lf it mp b gy my mv l mw mx">filter(day_number &lt;= max(day_number) - 6) %&gt;%</span><span id="8c60" class="mt lf it mp b gy my mv l mw mx">summarise(close_mean = mean(residual, na.rm = TRUE))</span><span id="de89" class="mt lf it mp b gy my mv l mw mx">trend_deviation &lt;- (</span><span id="f6a0" class="mt lf it mp b gy my mv l mw mx">(recent_5$close_mean - recent_5_50$close_mean) /</span><span id="89f3" class="mt lf it mp b gy my mv l mw mx">recent_5_50$close_mean</span><span id="b9e3" class="mt lf it mp b gy my mv l mw mx">) * 100</span><span id="a848" class="mt lf it mp b gy my mv l mw mx">if (</span><span id="db0a" class="mt lf it mp b gy my mv l mw mx">trend_deviation &lt; trend_deviation_treshold &amp;</span><span id="b5dc" class="mt lf it mp b gy my mv l mw mx">regression_model$coefficients[[2]] &gt; 0 &amp;</span><span id="604d" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio == FALSE</span><span id="0e71" class="mt lf it mp b gy my mv l mw mx">) {</span><span id="2586" class="mt lf it mp b gy my mv l mw mx">decision_sell &lt;-  FALSE</span><span id="e724" class="mt lf it mp b gy my mv l mw mx">decision_buy &lt;- TRUE</span><span id="f781" class="mt lf it mp b gy my mv l mw mx">} else if (</span><span id="06ef" class="mt lf it mp b gy my mv l mw mx">trend_deviation &gt; -trend_deviation_treshold &amp;</span><span id="d55a" class="mt lf it mp b gy my mv l mw mx">regression_model$coefficients[[2]] &gt; 0 &amp;</span><span id="34f8" class="mt lf it mp b gy my mv l mw mx">stock_in_portfolio == TRUE</span><span id="514c" class="mt lf it mp b gy my mv l mw mx">) {</span><span id="d9cb" class="mt lf it mp b gy my mv l mw mx">decision_sell &lt;-  TRUE</span><span id="ad42" class="mt lf it mp b gy my mv l mw mx">decision_buy &lt;- FALSE</span><span id="7429" class="mt lf it mp b gy my mv l mw mx">}</span><span id="9d89" class="mt lf it mp b gy my mv l mw mx">output &lt;- data.frame(</span><span id="b596" class="mt lf it mp b gy my mv l mw mx">id = paste0("APPL-", Sys.Date()),</span><span id="5f3f" class="mt lf it mp b gy my mv l mw mx">run_time = as.character(Sys.time()),</span><span id="6f7d" class="mt lf it mp b gy my mv l mw mx">stock_date = (data %&gt;% filter(date == max(date)))$date,</span><span id="05dc" class="mt lf it mp b gy my mv l mw mx">stock = "APPL",</span><span id="751f" class="mt lf it mp b gy my mv l mw mx">close_price = (data %&gt;% filter(date == max(date)))$AAPL.Close,</span><span id="050b" class="mt lf it mp b gy my mv l mw mx">trend_deviation = trend_deviation,</span><span id="f2eb" class="mt lf it mp b gy my mv l mw mx">threshold = trend_deviation_treshold,</span><span id="9b94" class="mt lf it mp b gy my mv l mw mx">recent_5_avg = recent_5$close_mean,</span><span id="2c4e" class="mt lf it mp b gy my mv l mw mx">recent_5_50_avg = recent_5_50$close_mean,</span><span id="8f4d" class="mt lf it mp b gy my mv l mw mx">decision_buy = decision_buy,</span><span id="c0e2" class="mt lf it mp b gy my mv l mw mx">decision_sell = decision_sell</span><span id="f0be" class="mt lf it mp b gy my mv l mw mx">)</span><span id="6135" class="mt lf it mp b gy my mv l mw mx">output</span><span id="2735" class="mt lf it mp b gy my mv l mw mx">}</span></pre></div></div>    
</body>
</html>