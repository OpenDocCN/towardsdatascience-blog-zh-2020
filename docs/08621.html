<html>
<head>
<title>Picking the right tool for geospatial data enrichment (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为地理空间数据丰富选择合适的工具(第 2 部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/picking-the-right-tool-for-geospatial-data-enrichment-part-2-6417e97db394?source=collection_archive---------41-----------------------#2020-06-22">https://towardsdatascience.com/picking-the-right-tool-for-geospatial-data-enrichment-part-2-6417e97db394?source=collection_archive---------41-----------------------#2020-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9a0fc18c41b2850f10dbd1cd3e24c3ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WO7hbuY6iPcIti-fkJPMMg.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">作者图片</p></figure><h2 id="4fbd" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">本文是系列文章的第二部分。它重点介绍了这些工具，<em class="ky">解释了它们如何被用来解决我们的地理空间数据处理/丰富</em>。</h2><p id="c988" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated"><em class="lu">如果没看过介绍，可以在</em> <a class="ae lv" rel="noopener" target="_blank" href="/picking-the-right-tool-for-geospatial-data-enrichment-part-1-59a5842c55ca"> <em class="lu"> part 1 </em> </a> <em class="lu">中找到。</em></p><p id="cbe3" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">提醒一下，本系列第 1 部分中选择的工具是:Geopandas、PostGIS 和 BigQuery。我们来说说它们的利弊。</p><p id="4015" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir">地质公园</strong></p><ul class=""><li id="34cc" class="mb mc iq lb b lc lw lg lx kl md kp me kt mf lt mg mh mi mj bi translated">熊猫的地理空间扩展使用 Shapely (Python 库来操作和分析几何对象)。</li><li id="ef48" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">支持最重要的空间功能，足以解决非常复杂的问题。</li><li id="d5bb" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">如果你熟悉熊猫，相对容易掌握。</li><li id="5193" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">比波斯特吉斯慢。</li><li id="8bec" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">与 Pandas 类似，在单核上运行，但与 Dask(dask.org)一起可以并行化。</li><li id="fe42" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">内置绘图功能(直接在 jupyter 笔记本中),对于非常简单的数据可视化/验证案例来说已经足够。</li><li id="485e" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">支持最常见的输入/输出格式。</li></ul><p id="0320" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir"> PostGIS </strong></p><ul class=""><li id="c221" class="mb mc iq lb b lc lw lg lx kl md kp me kt mf lt mg mh mi mj bi translated">PostGIS 用空间函数扩展了标准(PostgreSQL) SQL 语言。</li><li id="a224" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">熟悉一些概念需要时间，但是编写实际的查询非常简单。</li><li id="0561" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">可以解决几乎任何类似地理空间的问题，甚至支持像最近邻的功能。</li><li id="6cc1" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">许多数据加载和转换功能。</li><li id="da93" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">快速，但查询执行仅限于一个内核。</li><li id="00d9" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">像任何 RDB 一样，可以处理比内存查询更大的数据，但在处理真正的“大数据”时，这可能还不够。</li><li id="1146" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">有许多相关的开源工具，可以帮助你，例如可视化你的数据(QGIS 是我的最爱)。</li><li id="bd11" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">伟大的文档和在线社区。</li><li id="d224" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">当与 PostgreSQL 过程语言(PL/pgSQL)连接在一起时，提供了一个非常强大的管道来处理查询，而不会“离开”数据库。</li></ul><p id="61c7" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir"> BigQuery 的地理空间功能</strong></p><ul class=""><li id="2afb" class="mb mc iq lb b lc lw lg lx kl md kp me kt mf lt mg mh mi mj bi translated">在谷歌云中处理查询，如果你懂 SQL，你会有宾至如归的感觉。</li><li id="df1a" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">谷歌云生态系统的一部分，可以使用各种 API 轻松加载、转换和导出数据。</li><li id="b4af" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">可以在几秒钟内处理数十亿字节的数据。</li><li id="3af5" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">支持的输入格式:包含 WKT 格式的地理空间列和 JSON 格式的 GeoJSON 列的 CSV(换行符分隔)。</li><li id="d69b" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">内置绘图工具，大数据就绪。</li><li id="1815" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">按数据存储和查询运行时间收费，这可以大大降低您的成本，即使您正在处理数 TB 的数据。</li><li id="5775" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">在单个查询中支持 BigQuery 数据和 Cloud SQL(也可以使用 PostgreSQL 作为引擎)数据之间的连接。</li><li id="57db" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">GIS 后的功能较少，但所有必要的操作和分析相关的功能已经存在。</li><li id="95ee" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">没有像 PL/pgSQL 这样的过程语言，但是(一般的 BigQuery)可以在某种程度上使用(SQL) WITH function 来模拟它。</li></ul><h1 id="744f" class="mp kd iq bd ke mq mr ms kh mt mu mv kk mw mx my ko mz na nb ks nc nd ne kw nf bi translated"><strong class="ak"> TLDR？</strong></h1><h2 id="97ea" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">选择 Geopandas if: </strong></h2><ul class=""><li id="9c4e" class="mb mc iq lb b lc ld lg lh kl ng kp nh kt ni lt mg mh mi mj bi translated">你对熊猫很熟悉，而 SQL 不是你的强项。</li><li id="0387" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">想要快速浏览/预处理地理空间数据，并且不打算进行复杂的转换。</li><li id="2008" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">您的地理空间数据框架不会包含数百万条记录(Geopandas 可以处理“大数据”,但您将等待结果；Dask 可以在某种程度上缓解该问题)。</li><li id="1961" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">您的用例相当简单，并且您希望尽快投入使用。</li></ul><p id="cce0" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir">选择波斯特吉斯如果:</strong></p><ul class=""><li id="ff27" class="mb mc iq lb b lc lw lg lx kl md kp me kt mf lt mg mh mi mj bi translated">Geopandas 还不够。要么是因为你的问题对 Geopandas 来说太难了，要么是它让你等了太久才得到结果。</li><li id="5e39" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">您最终可能会操作更多(大于内存)的记录。</li><li id="9658" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">你需要一套完整的地理空间功能。</li><li id="efb8" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">您有更多的时间来熟悉比 Geopandas 更复杂的工具。</li></ul><p id="71ae" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir">如果</strong> …您必须处理大数据，请选择 BigQuery！🙂</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="c5da" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">好了，我们终于准备好做一些真正的工作了。想象一下下面的问题:<br/>你的公司有一个<strong class="lb ir">应用</strong>，每天<strong class="lb ir">生成大量用户与之交互的位置</strong>(经度和纬度)。给了你三个不同的案子。</p><p id="a626" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">给定用户坐标:<br/> 1。分配到全市的区<br/> 2。查找到最近的购物中心、公交车站和医院的距离(单位:米)(直线距离)。生成汇总统计数据，例如每个地区的应用交互次数</p><figure class="nr ns nt nu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/86b6fbe39af825080793120db7ec7dc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6hX_pUfM65j4yFWGu9BFkA.png"/></div></div><p class="jy jz gj gh gi ka kb bd b be z dk translated">我们的数据处理/浓缩任务</p></figure><h2 id="bb7b" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">地理数据的大小</h2><p id="b44e" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated">请注意，在<strong class="lb ir">任务 1 </strong>中，形状(城市区域)的数量可能不会超过数据库中的 100 条记录。<br/> <strong class="lb ir">第二个任务</strong>是第一个任务的派生物，其中计算的输出具有与城市地区数量一样多的记录。<br/>至于<strong class="lb ir">第三项任务</strong>，你可能需要对照用户的位置检查超过 100，000 个兴趣点(POI ),但实际的 POI 不会经常改变，可以每周更新一次。</p><p id="d5db" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">所有这些实际上都是好消息，因为这意味着地理空间数据预处理可以直接在笔记本电脑上使用 Geopandas 或 PostGIS 进行。</p><h2 id="3402" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">地理数据加载和预处理</h2><p id="c02b" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated">在与我们的用户位置合并之前，需要什么样的预处理步骤？当然，这很大程度上取决于你的情况，但让我们谈谈最常见的。</p><p id="a9ff" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">首先，你需要<strong class="lb ir">获取</strong>实际的地理数据(例如代表城市区域的 shapefile 或 GeoJSON ),然后<strong class="lb ir">将文件</strong>导入到你的工具中(假设它在你的笔记本电脑上)。使用 Geopandas 是一行程序:</p><figure class="nr ns nt nu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/96ce880aaebbfa5e085521458c9d5593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBZIER2fpI_yztkCr1ro9g.png"/></div></div></figure><p id="778d" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">注意，在上面的例子中，我使用了 bbox(边界框)参数来“丢弃”定义区域之外的所有数据。函数 read_file()可以做更多的事情，例如直接从互联网上加载 ZIP 格式的文件(详情见<a class="ae lv" href="https://geopandas.org/io.html" rel="noopener ugc nofollow" target="_blank">https://geopandas.org/io.html</a>)。</p><p id="5658" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">下一步是<strong class="lb ir">清理数据</strong>和<strong class="lb ir">改变 SRID </strong>如果需要。</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="f50b" class="kc kd iq nx b gy ob oc l od oe"># Changing SRID (projection) <strong class="nx ir">in Geopandas</strong><br/># (where "df" is you geodataframe)<br/>df.to_crs("EPSG:4326")</span><span id="f9b4" class="kc kd iq nx b gy of oc l od oe"># Changing SRID <strong class="nx ir">in PostGIS<br/></strong><em class="lu">UPDATE my_table<br/>SET geometry=ST_Transform(geometry, 4326)</em></span></pre><p id="abcf" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">然后，一个好的实践(特别是如果数据是从互联网上下载的)是<strong class="lb ir">检查形状是否有效</strong>(例如，线不与自身相交的多边形)。</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="dd21" class="kc kd iq nx b gy ob oc l od oe"># Checking if shapes are valid <strong class="nx ir">in Geopandas</strong><br/># (where "geometry" is your geometry column)<br/>df.geometry.is_valid.all()</span><span id="2475" class="kc kd iq nx b gy of oc l od oe"># If it's invalid, you can try following fix:<br/>df.geometry.buffer(0.00001)</span><span id="9167" class="kc kd iq nx b gy of oc l od oe"># Checking if shapes are valid <strong class="nx ir">in PostGIS<br/></strong># Returns number of valid and invalid geometries<br/><em class="lu">SELECT count(1), ST_IsValid(geometry)<br/>FROM my_table<br/>GROUP BY ST_IsValid(geometry)</em></span></pre><p id="cfd5" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">有时缓冲功能不会修复它，或者您不能使用它，因为您的多边形/多重多边形内部是中空的(使用缓冲功能会删除它们)。在这种情况下，您需要采取额外的步骤，例如导出到 PostGIS 并尝试修复:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="b02d" class="kc kd iq nx b gy ob oc l od oe"># Geopandas supports saving geometry directly to PostGIS but from my experience this is safer solution:<br/><strong class="nx ir"># 1. Create additional column with geometry converted to WKT</strong><br/>df['geom_wkt'] = df.geometry.apply(lambda x: x.wkt)</span><span id="b665" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># 2. Save dataframe to table "my_table" but export geometry in WKT format instead of actual "geometry" column</strong><br/>connection_str='postgres://&lt;username&gt;:&lt;password&gt;@localhost:&lt;port&gt;/&lt;db_name&gt;'<br/>df.drop('geometry', axis=1).to_sql(<br/>    'my_table', con=connection_str, if_exists='replace',<br/>    dtype={'geometry': Geometry})</span><span id="0eb3" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># 3. (Inside PostreSQL database) fix the geometry<br/></strong># Function ST_GeomFromEWKT translates WKT back to geometry<br/># Function ST_MakeValid fixes geometry<br/><em class="lu">INSERT INTO my_table_fixed<br/>SELECT ST_MakeValid(ST_GeomFromEWKT(geom_wkt)), &lt;other columns&gt;<br/>FROM my_table</em></span><span id="b5e9" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># 4. Load it back into Geopandas dataframe</strong><br/>sql = 'SELECT * FROM my_table_fixed'<br/>new_df = pd.read_postgis(sql=sql, con=connection_str)</span></pre><p id="6153" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">除了学习如何修复几何图形，现在您知道在这两个系统之间移动数据有多快多容易了。因此，在任何情况下，如果您在 Geopandas 中遗漏了某个函数，您都可以在 PostGIS 中这样做。</p><p id="939a" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">最后是问答过程，你可以用<strong class="lb ir">可视化数据</strong>来检查是否一切正常。在 Geopandas 中，您可以简单地使用。绘图() :</p><figure class="nr ns nt nu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/0a6092d118431f33d1bfbf887f100d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qLlm1YgNfNZy77dr82uqyQ.png"/></div></div></figure><p id="9ed5" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">如果这还不够，您可能需要将数据保存回 SHP 或 GeoJSON，并使用 QGIS 等外部应用程序加载它们。</p><h2 id="0f1c" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">合并数据</h2><p id="e8ee" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated">在 Geopandas 中，我们需要将用户数据框架转换为地理数据框架:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="5c6b" class="kc kd iq nx b gy ob oc l od oe">import geopandas as gpd</span><span id="fcdf" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># Load users data into Pandas dataframe</strong><br/>users_df = &lt;function that loads the data&gt;</span><span id="b52d" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># Convert to geodataframe</strong><br/>users_gdf = gpd.GeoDataFrame(users_df, <br/>    geometry=gpd.points_from_xy(<br/>        users_df.longitude, users_df.latitude))</span></pre><p id="d682" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">现在，数据已经准备好与您的用户位置合并。<br/>对于我们的<strong class="lb ir">任务 1 </strong>来说，简单来说就是:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="e8b9" class="kc kd iq nx b gy ob oc l od oe"><strong class="nx ir"># Perform spatial join</strong><br/>gpd.sjoin(users_gdf, geo_dataframe, how="inner", op='intersects')</span></pre><p id="99b2" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">PostGIS 中的类似操作(<strong class="lb ir">任务 1 </strong>):</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="2eee" class="kc kd iq nx b gy ob oc l od oe"><em class="lu">INSERT INTO merged_table<br/>SELECT * FROM geo_table g, users_table u<br/>ST_Intersects(<br/>    ST_SetSRID(ST_MakePoint(u.longitude, u.latitude), 4326),<br/>    g.geometry<br/>)</em></span><span id="65e1" class="kc kd iq nx b gy of oc l od oe"># In this line :<strong class="nx ir"><br/></strong># <em class="lu">ST_SetSRID(ST_MakePoint(u.longitude, u.latitude), 4326)</em><br/># we are converting our users coordinates to POINT and setting SRID</span></pre><p id="7b7a" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir">任务 2 </strong>同样简单:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="7fe4" class="kc kd iq nx b gy ob oc l od oe"><em class="lu">INSERT INTO count_interactions_by_districts_table<br/>SELECT COUNT(1) user_count, geo_table.district_name<br/>FROM geo_table g, users_table u<br/>ST_Intersects(<br/>    ST_SetSRID(ST_MakePoint(u.longitude, u.latitude), 4326),<br/>    g.geometry<br/>)<br/>GROUP BY geo_table.district_name</em></span></pre><p id="6cce" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">任务 3 更具挑战性:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="e4cf" class="kc kd iq nx b gy ob oc l od oe"><em class="lu">WITH poi_with_point as (<br/>    SELECT *, ST_SetSRID(<br/>        ST_MakePoint(<br/>            u.longitude, u.latitude), 4326)::geography AS geog<br/>    FROM poi<br/>    WHERE p.poi_type='shopping mall'<br/>)</em><strong class="nx ir"><em class="lu"><br/>SELECT p.id, p.longitude, p.latitude, <br/>       min(ST_Distance(p.geog, u.geog)) shopping_mall_min_distance <br/>FROM users u, poi_with_point p <br/>WHERE ST_DWithin(p.geog, u.geog, 8000)<br/>GROUP by p.id, p.longitude, p.latitude</em></strong></span></pre><p id="74f7" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">其中:</p><ul class=""><li id="17c3" class="mb mc iq lb b lc lw lg lx kl md kp me kt mf lt mg mh mi mj bi translated">带有的顶部<strong class="lb ir">查询部分正在生成名为 poi_with_point 的“临时视图”。它通过添加名为“geog”的点列来扩展原始表 poi(包含我们所有的 POI 位置)。它还会过滤掉所有不是商场的兴趣点。</strong></li><li id="b7e8" class="mb mc iq lb b lc mk lg ml kl mm kp mn kt mo lt mg mh mi mj bi translated">ST_DWithin 可以显著加快查询的执行速度。它通过增加每个用户与每个购物中心之间的最大距离(任意)8 公里来防止检查每个用户的位置:</li></ul><figure class="nr ns nt nu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/d6950b22b99d2bac60cb5592896d259c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VUVQ97gtWiT1GZTj0P4USg.png"/></div></div></figure><h2 id="689e" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">用户数据库的大小</h2><p id="adab" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated">当我们的用户数据库的大小是千兆字节时，事情就变得有趣了。</p><p id="d82a" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">使用<strong class="lb ir"> GeoPandas </strong>(默认情况下在单线程上)将会花费很长时间，如果数据集超出了您的工作内存，您需要批量处理它。如果您碰巧有 Dask 集群运行在多个 workers 上，那么您可能会考虑使用它，但它可能仍然不是最佳解决方案。</p><p id="a4ac" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><em class="lu">旁注:我已经在我的另一篇文章“丰富你的熊猫数据框架的最简单的方法”中解释了批处理和在集群上运行，这两种解决方案都只需要几行代码。</em></p><p id="7a0c" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><em class="lu">提示:对于 Dask 集群中的批处理，使用 map_partitions 函数，并在每个分区中分别:加载您的地理空间数据，并对“映射”的用户数据块执行空间连接操作。</em></p><p id="9b70" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir"> PostGIS </strong>将能够处理数据，但执行时间可能不是最优的。如果您的 PostGIS 服务器不是生产环境的一部分，并且您不介意等待，那么您应该使用它。如果没有，我们最后的选择是…大查询</p><h2 id="1186" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">用 BigQuery 做大</h2><p id="580e" class="pw-post-body-paragraph kz la iq lb b lc ld le lf lg lh li lj kl lk ll lm kp ln lo lp kt lq lr ls lt ij bi translated">首先我们将做几个假设:<br/> 1。您已经注册了谷歌云账户并激活了谷歌云存储(GCS) <br/> 2。您的用户数据已经加载到 BigQuery 表<br/> 3 中。您已经在笔记本电脑上安装了 Google“tool belt ”,命令“gsutil”和“bq”在您的终端<br/> 4 中可用。您拥有在 BigQuery <br/> 5 中创建数据集和表的权限。您已经设置了(在终端中，使用 Google“tool belt”)您的默认项目<br/> <em class="lu">提示:将 GCS 和所有 BigQuery 数据集保存在同一区域，否则您可能无法加载它或执行 JOIN 操作。</em></p><p id="6aa6" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">正如我们已经知道的，BigQuery 可以导入 GeoJSON 或 WKT 格式的地理数据。我们已经学习了如何将它转换为 WKT，所以让我们将它保存为 CSV 格式并传输到 BigQuery。首先，我们将它保存为 CSV 格式:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="4805" class="kc kd iq nx b gy ob oc l od oe"># Assuming your geography is already in WKT<br/>df.to_csv('output_file.csv')</span></pre><p id="5866" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">从笔记本电脑直接加载到 BigQuery 是可能的，但有一些限制，所以我们将首先把它发送到 GCS:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="ded2" class="kc kd iq nx b gy ob oc l od oe"># (In your terminal)<br/>gsutil cp output_file.csv gs://your_bucket_name_in_gcs</span></pre><p id="7684" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">创建数据集，即存储数据并从 GCS 填充数据的表:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="1058" class="kc kd iq nx b gy ob oc l od oe"># (In your terminal<strong class="nx ir">)<br/># Create dataset</strong><br/>bq --location=US mk --dataset your_dataset</span><span id="0517" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># Create table</strong><br/>bq mk --table your_dataset.geo_table \<br/>id:INTEGER,geom_wkt:STRING,<em class="lu">&lt;other columns&gt;</em></span><span id="0549" class="kc kd iq nx b gy of oc l od oe"><strong class="nx ir"># Load CSV into BigQuery table</strong><br/>bq load \<br/>--source_format=CSV \<br/>your_dataset.geo_table \<br/>gs://<!-- -->your_bucket_name_in_g<!-- -->cs/output_file.csv \<br/>id:INTEGER,geom_wkt:STRING,<em class="lu">&lt;other columns&gt;</em></span></pre><p id="2e75" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">BigQuery 语法与 PostGIS 几乎相同:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="736b" class="kc kd iq nx b gy ob oc l od oe"><strong class="nx ir"><em class="lu"># Task 1 in BigQuery</em></strong><em class="lu"><br/>INSERT INTO merged_table<br/>SELECT * FROM <br/>    </em>your_users_dataset<em class="lu">.users_table u, <br/>    your_dataset.</em>geo<em class="lu">_table g<br/>WHERE ST_Intersects(<br/>    </em>ST_GEOGPOINT<em class="lu">(u.longitude, u.latitude),<br/>    g.geometry<br/>)</em></span></pre><p id="6360" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated"><strong class="lb ir">任务 2 </strong>在 BigQuery 和 PostGIS 中几乎相同，所以我将跳过这个片段。</p><p id="3baf" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">至于我们的第三个任务，请注意得到的行数非常少。不超过区的数量。在这种情况下(或类似情况下，您知道数据将适合您的计算机的工作内存)，您可以使用 BigQuery Python 客户端并将结果直接下载到 Pandas dataframe:</p><pre class="nr ns nt nu gt nw nx ny nz aw oa bi"><span id="a06d" class="kc kd iq nx b gy ob oc l od oe">from google.cloud import bigquery<br/>client = bigquery.Client()</span><span id="73ba" class="kc kd iq nx b gy of oc l od oe">sql = """<br/><em class="lu">SELECT COUNT(1) as user_count, g.district FROM <br/></em><em class="lu">    </em><em class="lu">your_users_dataset</em><em class="lu">.users_table u, <br/>    your_dataset.</em><em class="lu">geo</em><em class="lu">_table g<br/></em><em class="lu">WHERE </em><em class="lu">ST_Intersects(<br/>    </em>ST_GEOGPOINT<em class="lu">(u.longitude, u.latitude),<br/>    g.geometry<br/>)</em><em class="lu"><br/>GROUP BY g.district<br/></em>"""</span><span id="9e3c" class="kc kd iq nx b gy of oc l od oe">df = client.query(sql).to_dataframe()</span></pre></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="6dcf" class="pw-post-body-paragraph kz la iq lb b lc lw le lf lg lx li lj kl ly ll lm kp lz lo lp kt ma lr ls lt ij bi translated">本系列的目标是展示如何使用外部地理空间信息处理或丰富您的数据。我想向您展示如何混合和搭配可用的工具，轻松地在它们之间传输数据，以及哪一个对快速完成您的工作最有用。</p></div></div>    
</body>
</html>