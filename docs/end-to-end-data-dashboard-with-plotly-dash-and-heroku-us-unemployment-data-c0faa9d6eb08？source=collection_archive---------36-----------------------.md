# 端到端数据仪表板，包含 Plotly Dash 和 Heroku:美国失业数据

> 原文：<https://towardsdatascience.com/end-to-end-data-dashboard-with-plotly-dash-and-heroku-us-unemployment-data-c0faa9d6eb08?source=collection_archive---------36----------------------->

![](img/0d6aeca05b44b7ab315010ac80e7720b.png)

此处显示的仪表板的第一个选项卡

## 数据科学

有很多经济数据来自不同的部门，劳工部，经济分析署，BLS，弗雷德，NBER，美国人口普查局——我们如何把这些数据放在一起，看看这些数字背后的人们？

在过去的几个月里，我们已经看到令人厌恶的大数字都以同样的方式显示——通过直线图和条形图，有一个大的跳跃。当然，这是展示变化的好方法，但很难理解或真正理解仅仅一句台词。台词让你觉得“哦，哇，不寻常”，就是这样。我认为，这些数据需要以一种与个人相关的方式呈现(呈现给他们知道的人、地方和行业)，以帮助用户比较美国各地的统计数据。

这需要一个数据仪表板，具体来说，它的**目标是:**

> *允许用户轻松地比较和查看美国劳动力中的问题和模式，最终导致更深入的“为什么”问题和后续研究。*

GitHub 仓库中的一些代码和数据在[这里](https://github.com/andrewhong5297/US-Dashboard-Files)，仪表盘可以在[usa-data-dashboard.herokuapp.com](https://usa-data-dashboard.herokuapp.com/)找到。如果你在手机上，去[usa-data-dashboard-mobile.herokuapp.com](http://usa-data-dashboard-mobile.herokuapp.com)获得更好的观看体验。总的来说，这个项目花了四天时间，大概有 1000 行代码。这个应用程序本身有 500 行代码。

## 这个应用程序分三步完成

1.  获取和清理数据
2.  创建 Plotly 图表和 Dash 应用程序
3.  部署到 Heroku 并进行优化

## 获取和清理数据

为了开始了解数据背后的人，以及我们如何帮助他们，我们需要向我们展示地点、人员和原因的图表。我决定尽可能细化，并决定使用美国县(人口普查区)级数据来显示失业、社会人口统计和行业依赖。美国在人口普查中报告了 3000 多个县。正如人们所料，这是 4 天中最长也是最艰难的部分，大约 2.5 天，可能有点干。我选定的数据集是由于更新的准确性和一致性:

1.  匹配以下内容的一整套标识符:联邦信息处理标准(FIPS)、基于核心的统计区域(CBSA)、大都市区域名称、县名称、州名称 ***大约 2020 年***
2.  2010-2020 年 BLS 各县失业情况
3.  *BLS 按行业分列的就业人数(州和市区)***2019–2020****
4.  *美国人口普查局数据:人口统计和平均收入 ***2018****

*考虑到相似数据的来源数量之多，协调 ID 和更新频率，项目的开始非常混乱。我花了大约半天时间来梳理副标题中列出的每个网站，看看在哪里可以找到最一致的数据和标识符。虽然它在我的数据集上被列为第一名，但直到最后我才真正把它拼凑起来。这很困难，原因有三:*

1.  *各种数据源之间，县和城市地区的分组或拼写通常略有不同。*
2.  *我发现的数据集和键都来自不同的日期，所以映射中的细微变化导致了额外的四五个小时来检查工作表中的名称，以找到最佳的组合。*
3.  *美国的县名不是唯一的*

*本质上，它都与美国人口普查局的代码相关联，其中 FIPS 匹配县名，CBS 匹配大都市地区，FIPS 匹配 CBSA(如果该县是大都市地区的一部分)。您可以在我的`FIPS to CBSA.xlsx`文件中找到这个映射。这是用 [NBER](https://data.nber.org/data/cbsa-msa-fips-ssa-county-crosswalk.html) 以及 [BLS](https://www.bls.gov/sae/additional-resources/metropolitan-statistical-area-definitions.htm) 键的组合创建的。这都是 USCB 人用的，他们是这样分解的:*

*![](img/1b08afa46a36e7a59325c5139604e878.png)*

*这里的 FIPS 应该是 06067*

*下面是它是如何连接的:我从他们的[数据库](https://data.bls.gov/PDQWeb/la)中的本地失业系列 ID 数据开始(这是 3200 次查询/每次拉动的最大 200 次= 16 次拉动)，并使用他们的`area_code`到`area_text`的转换来获得县名和列名(这在我的`US BLS Codes.xlsx`文件中)。这些可以追溯到 1990 年，但我只从 2010 年非调整。*

*然后，我看了州和大都市地区经济概览，得到了行业就业月度数据。这只能追溯到 2019 年 12 月。我能够从 EAG 的每一页得到行业分类，就像这一页一样。*

*USCB 的人口普查数据也很难在县一级找到，所以我过去常常在地区一级的[司法地图](http://www.energyjustice.net/justice/data.php)上找到数据文件，这是一个 1.2GB 的`postgreSQL` 文本转储文件。我必须下载`postgreSQL`，安装`postGIS`插件，然后`pd_dump`将文件存入数据库。我使用`psycopg2` 库将数据库表读入 Python，然后使用这种[方法](https://www.indeed.com/career-advice/career-development/how-to-calculate-average-percentage)获取县平均比赛细目。在用公正地图核对百分比数据时，我去掉了“其他种族”,因为这个领域似乎没有包括在总人口中。*

*如果你对我如何清理文件感到好奇，请查看[回购](https://github.com/andrewhong5297/US-Dashboard-Files)和这个[脚本](https://github.com/andrewhong5297/US-Dashboard-Files/blob/master/Labor%20Data%20Prep.py)。我还没有清理脚本，但我认为它非常简单，所有读取的文件都在存储库中。忽略第 18–21 行，由于名称不一致，我没有使用那个代码文件。*

## *创建 Plotly 图表和 Dash 应用程序*

*现在我们将深入研究代码，特别是应用程序布局是如何制作的。作为参考，[以下是截至 2020 年 6 月 16 日的 app 代码](https://github.com/andrewhong5297/US-Dashboard-Files/blob/master/app_6162020.py)。我删除了大约 150 行数据读取和操作，这些内容看起来会很混乱，我们将在后面讨论。Dash 实现从第 83 行开始。*

*我假设你对布局和回调有一个基本的了解，如果没有，那么请查看 Plotly Dash [文档。](https://dash.plotly.com/layout)*

*提醒一下，任何图表都可以被绘制成图表——它只是静态的。对于这个仪表板**，我使用了四种类型的图:***

***Plotly 图形对象:go。“美国-各州”定位模式的 choropleth***

*![](img/377cbec14881a647f27e5af8c206abd2.png)*

*左栏，标签 1*

*这个示例使用了三个回调函数，一个选择要显示的行业类型，两个选择日期。滑块还不接受`datetime`对象，所以这是唯一的解决方法。*

*plot_unemploy_choro_state()是我在脚本前面第 64 行定义的函数。*

***plot ly Express:px . choropleth _ map box 一个县(FIPS)级地块***

*![](img/a776df2d073aa22e54a82f6bd6422615.png)*

*左栏，标签 1*

*现在我们变得有点复杂了，我使用了一个链式回调在一个下拉列表中选择数据集(人口普查数据或 BLS 县失业数据),然后在第二个下拉列表中显示要绘制的值。*

*这看起来很可怕，但如果你慢慢来，这很简单。第一个回调选择在第二个下拉列表中显示的标签，第二个回调通过“数据类型”过滤相关的数据集 df，并将其设置为要返回的`fig`。*

***Plotly Express: px.line 和 px.bar***

*![](img/5f1d8d1596a00bb28287efdca3321f2d.png)*

*右栏，标签 1*

*好了，现在是整个右侧。本质上，这里所发生的是县选择照顾所有的图表。一旦我有了一个县，我就用 BLS 失业县的数据绘制一个线图，从美国人口普查局 2018 年的数据中提取该县的人口统计数据，然后使用州数据(来自图表 1)和 CBSA 大都市区数据(这两个数据都来自 EAG 数据源)更新行业就业。*

*county 是 state 的连锁回调，因为 county 的名称在美国不是唯一的。因为我有一个映射文件设置，我可以很容易地使用 dict 从后端的所有其他工作表中提取。*

*一步一步来看，第一个回调设置了 counties 下拉列表。如果选择了 not county，第二次回调会弹出一个警告。第三次、第四次、第五次回调都是以类似的方式使用 px.bar。最后回调的是历史折线图。这里有一堆操作在进行，但是不要太担心那些。*

***第二页签:比较视图***

*在我构建了第一个选项卡之后，我才设计第二个选项卡。我希望第一个帮助用户找到奇怪的县和州，然后第二个在你找到感兴趣的州/县后，一次比较尽可能多的县/州。*

*各州的比较如下所示:*

*![](img/250db95662f7fbc81b02c256528fc037.png)*

*左栏，标签 2*

*县与县的比较如下:*

*![](img/a1f1a1ba0af87d8a57cece425e014a64.png)*

*右栏，标签 2*

*图像中有一个收入图表，但你可以自己看一下。这基本上是相同的代码，但我使用了 px.bar 的不同版本，并在下拉列表中启用了`multi=True`,这样就可以根据需要填充尽可能多的行或条。*

*你不必这样做，但是我使用了 [Dash Bootstrap 组件](https://dash-bootstrap-components.opensource.faculty.ai/docs/components/alert/)，而不是布局、标签和卡片的标准样式表(在特定区域设置边界)。它们有很好的文档，确实有助于简化应用程序代码的组织，所以如果你还没有尝试过，我建议你尝试一下。我首先创建了空白标签和卡片布局，然后开始填充。你会看到我的`app.layout`很短，在第 297-304 行。*

## *部署到 Heroku 并进行优化*

*如果你做到了这一步，那么恭喜你！理解别人所做的数据流程和仪表板构建并不是一件容易的事情。我这么说是为了避免你的痛苦——一旦你有了一两个本地运行的基本图表， [*部署到 Heroku*](https://dashboard.heroku.com/apps) *。* Heroku 有一个所谓的 [R15 限制](https://devcenter.heroku.com/articles/limits#dynos)，基本上意味着如果你的应用超过 512mb X 2 workers =1024mb 的内存使用量，它就会崩溃(使用`heroku logs --tail`检查崩溃)。[此链接](https://dash.plotly.com/deployment)底部有一个部署基本 dash 应用程序的分步指南。如果你运行的是 Windows，使用`venv\Scripts\activate`而不是`source`命令。*

*随着你的进展，你可以添加更多的图表和测试功能——如果你带来的不仅仅是基本的 dash/pandas/numpy 包，这一点尤其重要，因为你可能已经做出了一些花哨的东西，但在推送到 heroku 时，pip 由于这样或那样的原因不工作。这真的很像使用任何软件时的提示:*“早存，常存”*。*

*对于大多数简单的应用程序，你不需要关心优化，但对于这一个，我有超过 1GB 的数据和脚本中一些昂贵的操作。为了解决这个问题，我试图限制像`.unstack()`这样的操作来保存行，并将较大的文件分割成多个 csv 文件，然后在`app.py` 文件中执行大多数位于`Labor Data Prep.py` 文件中的操作。这就是为什么在进入 dash 应用程序之前有将近 200 行，一些文件在操作后从 csv 中的 3000 行变成了`app.py`文件中的 1，600，000 行。*

*我经常遇到 R15 错误，持续使用大约 1100 多 mb 的内存，即使应用程序上只有两个图表。我把`procfile` 改成了包含`preload`，以牺牲一些性能为代价节省了内存。*

```
*web: gunicorn app:server --preload*
```

*此外，它有助于了解不同的[动态类型](https://www.heroku.com/dynos/scaling) (web、worker、clock 等)以及水平和垂直缩放。你可能需要为更多的内存扩展应用付费。*

*![](img/af63a034200d42e64c2adfe96f9256af.png)*

*在这里你可以看到我的测试和内存使用历史。这些错误显示在 H10-R15 中，严重错误导致应用程序崩溃。*

*对于企业来说，还有一整套从每月 5 美元到 1000 美元以上的附加服务。我花了一些时间研究缓存，看看性能是否会更快，但最终决定没有必要。我在回调之前缓存了尽可能多的变量——尽量避免太多的 dataframe 操作(比如 df[df["column"]==var])，尤其是对于链式回调。*

*经过大量的测试和修改(确切地说是 40 个版本)，我已经让我的应用程序始终运行在 600mb。*

## *最终仪表板*

*我们完事了。总而言之，数据仪表板不应该是您进行数据分析的首选，但是当有太多视图需要显示或探索时，它是一个不错的选择。*

***要记住的事情:***

1.  *从**一个**仪表板的关键目标/目的开始*
2.  *花点时间收集和核对数据，看看已经取得了什么成果。*
3.  *仔细挑选你的图表和回拨设计，在开始之前做好布局！*
4.  *按需部署，不要在最后批量部署。一下子优化完会很痛苦。*

*在我们有越来越多的开放数据可用的时候，我鼓励每个人开始用更人性化的视角探索数据——而不是只关注你能或不能预测什么。祝你好运！*

*这里表达的所有观点都是我个人的，并不代表我所属的那些人的观点。*