<html>
<head>
<title>Speak to the Dead with Deep Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用深度学习对死人说话</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/speak-to-the-dead-with-deep-learning-a336ef88425d?source=collection_archive---------43-----------------------#2020-07-06">https://towardsdatascience.com/speak-to-the-dead-with-deep-learning-a336ef88425d?source=collection_archive---------43-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a477" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何训练聊天机器人听起来像任何有电话的人，包括你已故的亲人。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2393d02a5a4cede426c27cae4d7431da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5GO3IEAMZ_Nadomba3K2Aw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@manea-catalin-1839309?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">马尼亚·卡塔林</a>从<a class="ae ky" href="https://www.pexels.com/photo/snow-covered-pine-trees-and-mountains-4504068/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</p></figure><h1 id="d5a7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="fee4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我是看着科幻小说长大的，在科幻小说中，人们试图将他们的意识植入机器。我总是觉得这些故事很吸引人。有意识是什么意思？如果我把自己的一个完美副本放进一台机器里，哪一个是我？如果生物的我死了，而机械的复制我活了下来，那我死了吗？我仍然喜欢这样的故事，最近一直在阅读格雷格·伊根，如果你认为这些是有趣的问题，我强烈推荐他的书 D <a class="ae ky" href="https://www.amazon.com/Diaspora-Greg-Egan-ebook/dp/B00E83YOEI/ref=sr_1_1?dchild=1&amp;keywords=diaspora&amp;qid=1592672413&amp;sr=8-1" rel="noopener ugc nofollow" target="_blank"> iaspora </a>(只要 3 美元)。</p><p id="afe4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是我跑题了。以今天的技术，只用几行代码就可以粗略地模拟一个人的说话风格。随着新冠肺炎在世界各地被烧毁，我开始担心我生活中的老年人，并想知道是否有可能在某个地方保留他们的一部分。这篇教程是我微弱的尝试，试图捕捉和保持一个人死后的一些对话方面。</p><h1 id="f0d0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">TLDR</h1><p id="40f9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">你可以把你的文本带给任何人，用它们来训练一个简单的聊天机器人，只需要几行代码。本教程的所有代码都可以在这里找到<a class="ae ky" href="https://github.com/nbertagnolli/texts-to-chat" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="d5c0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">获取数据</h1><p id="6525" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在当今世界，人们在网上发布了如此多的东西，你只需稍微搜索一下，就可以找到关于大多数人的海量数据，无论是好是坏。不幸的是，或者说幸运的是，收集老年人数据的现实是，他们没有强大的在线存在。我奶奶没有推特和脸书。如果他们这样做了，他们就不会经常发帖，以至于我无法提取任何有意义的信号。所以我求助于他们的电话。</p><p id="2c99" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">每个人都有电话。我们一直用它们来交流，它们记录了我们过去的对话和互动。它们是捕捉某人谈话风格初始模型的完美工具。在这个项目中，我将创建一个我父亲的对话短信模型。他让我借他的手机一天，把里面所有的短信都擦掉。对于这些文本，我们将以一种深度对话模型可以理解的方式对其进行格式化，并根据他的短信模式对其进行微调。</p><h1 id="913f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">提取文本</h1><p id="e16a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我爸爸和我都有 iPhone，所以本教程将围绕如何从 iPhone 中提取和处理文本。你可以用 iTunes 给你的设备做一个备份，但是查看和操作这个备份有点麻烦。我发现从 iPhone 中提取和处理文本的最好方法是<a class="ae ky" href="http://imazing.o67m.net/E4402" rel="noopener ugc nofollow" target="_blank">图像化</a>,本教程将带你了解如何使用这个工具。您不需要购买 iMazing 来执行此演练。他们有 30 天的免费试用期，应该可以让你通过这个项目没有问题，但如果你最终购买它，这是我的附属链接，所以如果你点击这个链接后购买，我会得到一点回扣:)。如果附属链接对你来说是奉承话，就点击<a class="ae ky" href="https://imazing.com/?gclid=CjwKCAjw57b3BRBlEiwA1Imytlg1d5-kQax93PYmE9dnTGXf1tpVU7flwJRXtN5MdKIeTCXbel8S5xoCnQAQAvD_BwE" rel="noopener ugc nofollow" target="_blank">这个</a>。它去他们正常的网站，没有回扣。他们永远不会知道是我派你去的。</p><h2 id="0897" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">机器人</h2><p id="ddc0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果你运行的是 Android，看起来有一些软件选项可以帮助你提取和备份文本。<a class="ae ky" href="https://play.google.com/store/apps/details?id=com.riteshsahu.SMSBackupRestore&amp;hl=en" rel="noopener ugc nofollow" target="_blank">这个免费的应用程序</a>似乎能帮上忙。我还在这里找到了一个描述如何做的帖子<a class="ae ky" href="https://www.digitaltrends.com/mobile/how-to-save-text-messages/" rel="noopener ugc nofollow" target="_blank"/>。不幸的是，因为我没有安卓手机，所以我无法测试这些方法。不过，如果你在格式化数据时遇到困难，我很乐意和你聊天，帮你调试。</p><h2 id="1009" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">苹果手机</h2><h2 id="7c97" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">步骤 1:使用 iMazing 创建备份</h2><p id="e2b8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">插入你的 iPhone，打开 iMazing。你应该在右上角看到你的手机。右键单击并选择“备份”。这将像在 iTunes 中一样备份您的手机，但在这里您可以轻松地访问和导出您的数据。可能需要五到十分钟才能完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/78596dde650dab38b2223452c797cb70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x11LfE1dUX7yvleh5LfYCQ.png"/></div></div></figure><h2 id="5643" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">步骤 2:下载 CSV 格式的数据</h2><p id="e3b8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">备份完成后，我们可以通过以下方式访问短信:</p><ol class=""><li id="579a" class="nf ng it lt b lu mn lx mo ma nh me ni mi nj mm nk nl nm nn bi translated">点击信息图标</li><li id="e90a" class="nf ng it lt b lu no lx np ma nq me nr mi ns mm nk nl nm nn bi translated">选择我们想要提取的对话</li><li id="fd8c" class="nf ng it lt b lu no lx np ma nq me nr mi ns mm nk nl nm nn bi translated">点击导出到 CSV 按钮</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/f4ce4731dd140d13928d6a5301fb7f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fMAZFOl6JlFZqJKjcqj0aQ.png"/></div></div></figure><p id="c181" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将提取一个 CSV 格式的所有过去的文本保存在你的手机之间，你和每个人的对话。正如你在下面看到的，CSV 有许多字段，但我们只需要其中的三个用于这个项目<strong class="lt iu">消息日期</strong>、<strong class="lt iu">文本</strong>和<strong class="lt iu">发送者姓名</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/b4b79aff82e3d40ce7f7877f42c01138.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jsVsgkVYxv7XoUNZZOkNSA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图 3</p></figure><h1 id="f077" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">为培训准备数据</h1><p id="dcca" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们的任务是构建示例对话来训练我们的聊天机器人。第一件事是载入数据。下面的代码片段会解决这个问题。这段代码非常简单。我们加载 CSV，做一些重命名和数据格式化，以便于使用，瞧。需要注意的一点是，我在 speaker 列的空条目中填入了一个提供的<code class="fe nv nw nx ny b">receiver_name.</code> iMazing 并不能很好地写下通话中谁是电话的主人。它会将该位置留空。所以无论哪里有丢失的值，我们都可以用拥有手机的人来填充。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="8c7d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">随着数据的加载，我们现在需要将来自同一说话者的文本压缩成一行。请注意，在图 3 的数据集的前三行中，我是如何两次发送文本来完成一个想法的。我们需要将所有这些内容汇集在一起，以便我们的数据帧的每一行都是不同的发言人。这将使数据处理更容易。我们可以使用下面的代码来做到这一点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="dd30" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这有点棘手，让我来解释一下。我们使用<code class="fe nv nw nx ny b">shift()</code>来复制数据帧，但是偏移一行。然后，我们可以将每一行的发送方名称与其偏移发送方名称进行比较。如果它们不同，那么我们知道我们已经转换了扬声器。我们创建了一个<code class="fe nv nw nx ny b">group_key</code>来代表这些不同的文本跨度。然后，我们可以根据这个键、日期和发件人姓名进行分组，以获得我们编译的文本范围。</p><p id="f60d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们需要做的最后一件事是拆分数据。在训练时，有一个小的验证集来获得一种概括的感觉是很有用的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="4d83" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这里我们得到所有不同的日期，然后将它们分成训练集或验证集。然后，我们将这些分割合并回原始数据帧。这确保了在同一对话中出现的文本不会同时出现在训练集和验证集中。</p><h1 id="74b9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">格式化拥抱脸部模型的数据</h1><p id="6b6a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将在这个项目中使用优秀的<a class="ae ky" href="https://github.com/huggingface/transfer-learning-conv-ai" rel="noopener ugc nofollow" target="_blank">拥抱面部对话人工智能</a>。脸书刚刚发布了<a class="ae ky" href="https://ai.facebook.com/blog/state-of-the-art-open-source-chatbot/" rel="noopener ugc nofollow" target="_blank"> Blender </a>，如果你有一台超级计算机，这将是作为你的基本聊天机器人的另一个很酷的选择，但我没有，所以我将坚持使用我可以在有限时间内微调的模型:)。</p><p id="aaf2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">拥抱脸变形模型的数据格式起初看起来有点混乱，但是它很容易生成。训练数据需要是具有以下签名的 JSON 文件:</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="ba42" class="ms la it ny b gy of og l oh oi">{<br/>  "train": [<br/>    {<br/>      "personality": [<br/>        "sentence",<br/>        "sentence"<br/>      ],<br/>      "utterances": [<br/>        {<br/>          "candidates": [<br/>            "candidate 1",<br/>            "candidate 2",<br/>            "true response"<br/>          ],<br/>          "history": [<br/>            "response 1",<br/>            "response 2",<br/>            "etc..."<br/>          ]<br/>        }<br/>      ]<br/>    }<br/>  ],<br/>  "valid": ...<br/>}</span></pre><p id="47f3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们稍微分解一下。较大的 JSON 对象有两个主键。“训练”和“有效”。训练是训练数据，并且是个性、话语对的列表。除了验证集之外，Valid 是相同的。个性是定义说话者个性的句子列表。更多细节请看拥抱脸教程。对于我的模型，我把人格作为我父亲与之交谈的人的名字。候选项部分包含对输入的可能响应的列表。此列表包含对对话历史的一些非最佳响应，其中最后一句是基本事实响应。最后，我们必须定义对话的历史。这是一个字符串列表，其中每个位置包含一个新的话轮。如果你想要另一个如何格式化数据的例子，拥抱脸在资源库中有一个很好的例子，你可以在这里找到<a class="ae ky" href="https://github.com/huggingface/transfer-learning-conv-ai/blob/master/example_entry.py" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="1241" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">训练模型</h1><p id="205a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">拥抱脸的优秀员工为我们组装了一个 docker 容器，因此设置模型培训轻而易举！只需运行<code class="fe nv nw nx ny b">make build</code>来构建 convai docker 容器，然后运行<code class="fe nv nw nx ny b">make run</code>以交互模式进入容器。</p><p id="8842" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从容器内部，我们可以训练我们的模型。我们只需从 docker 内部导航到我们的项目文件夹并运行:</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="17ce" class="ms la it ny b gy of og l oh oi">python3 train.py --dataset_path {data-path}.json --gradient_accumulation_steps=4 --lm_coef=2.0 --max_history=4 --n_epochs=3 --num_candidates=4 --train_batch_size=2 --personality_permutations 2</span></pre><p id="6287" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这花了大约 10 个小时在我的 CPU 上训练。它应该在 GPU 上进行训练，但由于整夜运行它对我来说足够方便，我还没有在我的 GPU 上设置它。</p><h1 id="8ef6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">与死者对话(或者在这种情况下不那么死)</h1><p id="d035" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">最后一步是与我们的对话代理交互。convai 存储库再次为我们完成了大部分繁重的工作。我用 make 对它做了一个方便的包装，这样我们就可以简单地运行:</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="1c1d" class="ms la it ny b gy of og l oh oi">make interact CHECKPOINT_DIR={path-to-checkpoint} DATA={path-to-training-data}</span></pre><p id="d577" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将打开一个交互式终端，您可以在这里与您新创建的机器人聊天。只需确保您的模型和数据位于 Makefile 所在的目录或子目录中。我所了解到的是，我和我爸爸并没有通过短信进行真正有意义的对话。看起来我们主要是分享一些信息，聊聊我们的一天，或者安排一些事情。模型超级擅长调度。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/09c30e5d1bd29b657d0d04553199b4d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*smdWuQc1o-VnATkl1Z61Wg.png"/></div></figure><p id="858d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">它不太擅长进行真诚的对话，但它确实准确地捕捉到了我父亲写短信的风格。如果谈话很短，而且是在我们通常会发短信谈论的领域，那感觉仍然像是在和他简短地聊天。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/186859dcccf403d809139ee753d23f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*o6TFqh6P0XKbnyCDk4cPBA.png"/></div></figure><p id="a254" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">有时候它会让我吃惊。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/6ced25d3457b0a1a4e21073c4abdd831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J5HDYxHRHQSZEl_viOvwfg.png"/></div></div></figure><h1 id="4ba7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">后续步骤</h1><p id="633e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们正常的短信交流中，这个聊天机器人有点像我父亲。我打算在接下来的一年里尝试通过文本进行一些更深入的对话，然后在明年秋天重复这个实验。我希望通过更长更复杂的基于文本的对话，我能捕捉到更多的信息。作为一个替代项目，你可以试着训练一个你自己的聊天机器人。有了 you-bot，使用 Twilio 之类的东西来自动化简单的文本对话可能会很有趣。</p></div></div>    
</body>
</html>