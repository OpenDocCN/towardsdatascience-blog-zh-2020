<html>
<head>
<title>How to deploy Airflow on AWS: best practices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 AWS 上部署气流:最佳实践</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-airflow-on-aws-best-practices-63778d6eab9e?source=collection_archive---------10-----------------------#2020-09-10">https://towardsdatascience.com/how-to-deploy-airflow-on-aws-best-practices-63778d6eab9e?source=collection_archive---------10-----------------------#2020-09-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3681" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在 AWS 上部署气流对于没有 DevOps 经验的人，也就是几乎所有从事数据工作的人来说，都是一个相当大的挑战。</h2></div><h2 id="2cf5" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">TL；DR；</h2><p id="682c" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">我创建了一个<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs" rel="noopener ugc nofollow" target="_blank"> repo，按照软件工程最佳实践在 AWS </a>上部署气流。如果你不想读这篇文章，你可以直接去<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs" rel="noopener ugc nofollow" target="_blank">那里</a>。但我确实描述了一些你可能会觉得有用的东西。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/262695eea4097841f25a4e5501e3eddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GIakfY0zoT-9K1Enr3P_dw.jpeg"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated"><a class="ae lx" href="https://unsplash.com/s/photos/zaanse-schans%2C-zaandijk%2C-netherlands" rel="noopener ugc nofollow" target="_blank">荷兰 Zaandijk Zaanse Schans</a>|照片由<a class="ae lx" href="https://unsplash.com/@wimvanteinde?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Wim van 't Einde </a>在<a class="ae lx" href="https://unsplash.com/s/photos/mill?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="7ebf" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">运行 docker-compose 命令和 voíla，您就有了在本地环境中运行的 Airflow，并且您已经准备好开发一些 Dag 了。一段时间后，您已经为在生产环境中部署 Dag(和气流)做好了准备。然后你开始搜索如何在 AWS 上部署气流的说明。以下是您可能会发现的内容:</p><ul class=""><li id="fe31" class="na nb it lg b lh mv lk mw kr nc kv nd kz ne lw nf ng nh ni bi translated">没有关于气流文件的说明。</li><li id="07d0" class="na nb it lg b lh nj lk nk kr nl kv nm kz nn lw nf ng nh ni bi translated">有些帖子，<a class="ae lx" rel="noopener" target="_blank" href="/how-to-deploy-apache-airflow-with-celery-on-aws-ce2518dbf631">像这个</a>，教你如何在 AWS ECS 上部署。相当有趣的方法。问题是，整个教程都是基于通过在 AWS 控制台上点击来创建资源。相信我；您不希望在生产环境中部署时走这条路。想象一下创建三个不同的环境(开发、试运行和生产)并不得不重复该过程三次的噩梦。现在想象一下更新环境并使它们保持同步。想象一下，你可以很容易地花一整个星期来修复一个错误，这个错误是由一个被错误删除的资源引起的。</li><li id="35cc" class="na nb it lg b lh nj lk nk kr nl kv nm kz nn lw nf ng nh ni bi translated"><a class="ae lx" href="https://medium.com/swlh/deploy-and-run-apache-airflow-on-aws-ecs-following-software-development-best-practices-613173f3b70d" rel="noopener">另一篇文章</a>相对较新，采用了更好的方法，但它仍然使用 AWS CLI 创建资源(如 ECS 集群)。比控制台上的点击式稍好一点，但仍不能用于生产。</li><li id="38be" class="na nb it lg b lh nj lk nk kr nl kv nm kz nn lw nf ng nh ni bi translated">其他文章，可能会提到使用基础设施作为代码，这将解决上述问题。但是，它们在技术细节和实现上都非常肤浅。因此，尽管提供了很好的概述和最佳实践，但对于没有 DevOps 经验的人来说，它们并不实用。</li><li id="8d89" class="na nb it lg b lh nj lk nk kr nl kv nm kz nn lw nf ng nh ni bi translated"><a class="ae lx" href="https://github.com/nicor88/aws-ecs-airflow" rel="noopener ugc nofollow" target="_blank">GitHub</a>上的这个回购可能是你在遵循软件工程最佳实践的 AWS 上正确实现 Airflow 的最接近的方式。但它仍然缺乏一些基本的东西，如 web 服务器和工作人员的自动缩放，或者配置设置的方法，如 RDS 实例类型，而不必挖掘 Terraform 代码。</li></ul><p id="dd77" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">你可能会在你的<a class="ae lx" href="https://www.google.com/search?q=deploy+airflow+on+aws" rel="noopener ugc nofollow" target="_blank">谷歌搜索</a>的第二页上看一下，但是如果一个好的结果没有出现在第一页上，那么这可能意味着它不存在。</p><h1 id="b605" class="no kj it bd kk np nq nr kn ns nt nu kq jz nv ka ku kc nw kd ky kf nx kg lc ny bi translated">入门指南</h1><p id="6025" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">只需<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs" rel="noopener ugc nofollow" target="_blank">克隆 repo </a>，遵循一些说明并安装<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>中描述的要求，然后运行:</p><pre class="lz ma mb mc gt nz oa ob oc aw od bi"><span id="18f5" class="ki kj it oa b gy oe of l og oh">make airflow-deploy</span></pre><p id="eea8" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">这将向您的 AWS 帐户部署一个 Airflow 实例！</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi oi"><img src="../Images/4df548e5ab554abfbf846606366d0d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X8Pd_DDI0CVeLlAX.png"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">搞定了。您将在启用自动缩放的 AWS ECS 上部署 Airflow。图片由作者提供，气流用户界面的打印屏幕。</p></figure><h1 id="d025" class="no kj it bd kk np nq nr kn ns nt nu kq jz nv ka ku kc nw kd ky kf nx kg lc ny bi translated">它如何帮助您遵循最佳实践？</h1><h2 id="0e8a" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">service.yml 文件</h2><p id="db2e" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">该回购使用<a class="ae lx" href="https://aws.amazon.com/pt/cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS Cloudformation </a>实现所有基础设施。在<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/tree/master/cloudformation" rel="noopener ugc nofollow" target="_blank"><em class="oj">/cloud formation</em></a><em class="oj"/>目录中，您将找到创建运行 Airflow 所需的基础设施的所有模板。好的一面是你不需要担心学习 Cloudformation 来做简单的部署，因为在根中有一个<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml" rel="noopener ugc nofollow" target="_blank"><strong class="lg iu">service . yml</strong></a><strong class="lg iu"/>来帮助你。</p><p id="aa3f" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">假设您想要将特定 IP(如您的办公室 IP)列入白名单，以便访问 Airflow UI。您唯一需要做的事情就是修改<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml" rel="noopener ugc nofollow" target="_blank"> service.yml </a>中的几行代码:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ok ol l"/></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">添加要加入白名单的 IP 地址列表。默认情况下，所有服务将对所有 IP 开放(0.0.0.0/0)。</p></figure><p id="a017" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">如果你想改变气流数据库实例类型，你也可以去<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml" rel="noopener ugc nofollow" target="_blank"> service.yml </a>:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ok ol l"/></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">很容易改变你的气流的元数据数据库引擎版本，更新实例类型等。</p></figure><p id="6419" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">你要的只是气流工作者的 CPU 和内存？微调自动缩放？<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml" rel="noopener ugc nofollow" target="_blank"> service.yml </a>是一站式商店。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ok ol l"/></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">轻松微调气流服务的自动缩放规则。</p></figure><h2 id="956a" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">在 AWS Secrets Manager 中管理密码</h2><p id="ccca" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">不要硬编码你的密码是软件工程 101。但是有时候，如果没有硬编码，很难在运行时自动部署和创建密码。在这个气流回购中，我们使用 AWS Secrets Manager 来帮助我们解决这个问题。</p><ul class=""><li id="5f9a" class="na nb it lg b lh mv lk mw kr nc kv nd kz ne lw nf ng nh ni bi translated"><strong class="lg iu">气流元数据数据库</strong></li></ul><p id="b3c5" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">我们的 Postgres 数据库将保存气流元数据，是需要管理员用户名和密码的资源之一。使用 AWS Secrets Manager，在部署时会创建一个强随机密码，并将其附加到集群。要获得密码值，您必须登录到您的 AWS 帐户，并转到 Secrets Manager。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ok ol l"/></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">Cloudformation 代码将为您创建一个强数据库密码。创建数据库时会引用用户名和密码。</p></figure><p id="a8b8" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">也可以用 Secrets Manager 实现自动密码轮换，但是这个项目没有实现。</p><ul class=""><li id="bd31" class="na nb it lg b lh mv lk mw kr nc kv nd kz ne lw nf ng nh ni bi translated"><strong class="lg iu">费尔内键</strong></li></ul><p id="956e" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">Airflow 使用 Fernet 密钥对保存在元数据数据库中的密码(如连接凭证)进行加密。该部署在部署时生成一个随机的 Fernet 密钥，并将其添加到 Secrets Manager 中。然后，它在气流容器中作为环境变量被引用。</p><h2 id="ee9c" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">自动缩放已启用</h2><p id="2c85" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">将气流投入生产的最大挑战之一是处理资源管理。如果出现使用高峰，如何避免 web 服务器崩溃？或者，如果某个特定的日常工作需要更多的 CPU/内存，该怎么办？</p><p id="c5bb" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">自动缩放为您解决了这些问题。在这个存储库中，您可以轻松地配置阈值，并且可以放心，您的基础架构将根据需求进行伸缩。</p><h2 id="e403" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">轻松部署到不同的环境</h2><p id="ea78" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">在生产设置中，您会希望将代码部署到不同的环境中。假设你需要:制作，舞台和开发。</p><p id="927b" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">这个 repo 允许您通过更改一个环境变量将相同的代码部署到不同的环境中，这可以在您的 CI/CD 管道上自动推断出来。要改变环境，请执行以下操作:</p><pre class="lz ma mb mc gt nz oa ob oc aw od bi"><span id="860f" class="ki kj it oa b gy oe of l og oh">export ENVIRONMENT=dev; # this will deploy airflow to dev environment<br/>make airflow-deploy;</span></pre><h2 id="0fb1" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">更新 Dag 而不触及基础架构</h2><p id="8dab" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">Airflow 的美妙之处在于能够将工作流写成代码。这意味着您更改 DAGs 代码的频率要比更改基础设施的频率高得多。通过这种气流部署，您将向 Dag 提交更改，它不会尝试为您重新部署基础架构。</p><p id="b092" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">您唯一想做的事情是构建一个新的气流图像，将其推送到 ECR，然后更新您的 ECS 服务以加载最新的图像。为此，只需运行:</p><pre class="lz ma mb mc gt nz oa ob oc aw od bi"><span id="2aa0" class="ki kj it oa b gy oe of l og oh">make airflow-push-image;</span></pre><p id="0432" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">这里的情况并非如此，但是您甚至可以将 Dag 放在单独的存储库中。这将使基础设施与软件更加分离。</p><h2 id="2c0b" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">标记您的资源</h2><p id="e408" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">标记资源将使我们能够轻松地创建自动警报、确定所有权和跟踪基础架构成本。这就是为什么这个气流储存库会标记所有资源。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ok ol l"/></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">当在云上运行多个服务时，标记资源是一个关键的实践。</p></figure><h1 id="7c71" class="no kj it bd kk np nq nr kn ns nt nu kq jz nv ka ku kc nw kd ky kf nx kg lc ny bi translated">你这边应该怎么做？</h1><p id="3877" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">您应该将部署流程添加到 CI/CD 管道中。为了运行一些自动化测试，我使用 GitHub Actions(但是您的公司可能使用其他工具，如 CircleCI 或 Jenkins)。</p><p id="a0b6" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">您可以遵循类似的过程来自动化您的部署和测试。看看<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/.github/workflows/run_tests.yml" rel="noopener ugc nofollow" target="_blank">测试工作流程</a>来获得一些灵感。</p><h1 id="443e" class="no kj it bd kk np nq nr kn ns nt nu kq jz nv ka ku kc nw kd ky kf nx kg lc ny bi translated">这要花多少钱？</h1><p id="7fe2" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">在采用默认配置的 AWS 上运行气流(同时考虑到集群没有纵向扩展)<strong class="lg iu">每天应该花费 5 到 7 美元</strong>。这取决于您正在部署的区域。</p><p id="c917" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">通过降低 service.yml 上的<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml#L42-L43" rel="noopener ugc nofollow" target="_blank"> CPU 和内存</a>以及<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs/blob/master/service.yml#L60-L63" rel="noopener ugc nofollow" target="_blank">改变工人的最小数量</a>，可以进一步降低成本。默认设置将允许气流在需要增加资源之前运行相当多的 Dag。微调并找到最适合您的用例的方法。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="07a7" class="pw-post-body-paragraph le lf it lg b lh mv ju lj lk mw jx lm kr mx lo lp kv my lr ls kz mz lu lv lw im bi translated">我希望这篇文章(<a class="ae lx" href="https://github.com/andresionek91/airflow-autoscaling-ecs" rel="noopener ugc nofollow" target="_blank">和资源库</a>)能帮助你轻松地生产气流。如果您有任何问题、建议或要求，请通过<a class="ae lx" href="https://www.linkedin.com/in/andresionek/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我，或在回购上打开问题。此外，欢迎您打开 PRs 并与该项目合作！</p></div></div>    
</body>
</html>