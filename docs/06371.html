<html>
<head>
<title>How To Benchmark an HTAP Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对HTAP数据库进行基准测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-get-real-time-analytics-by-consolidating-databases-85791066d20c?source=collection_archive---------46-----------------------#2020-05-21">https://towardsdatascience.com/how-to-get-real-time-analytics-by-consolidating-databases-85791066d20c?source=collection_archive---------46-----------------------#2020-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a23f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">整合数据库以降低成本并变得实时</h2></div><p id="3408" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">塞尔吉奥·费拉古特和蒙特·兹韦本</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/a6fc8d372ba9f883ca3d17954e9bbf6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zeexZApkIgrpHUxd"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">如何在不崩溃的情况下整合您的RDBMS和数据仓库(图片:<a class="ae lu" href="https://stock.adobe.com/contributor/206791252/sawitre?load_type=author&amp;prev_url=detail" rel="noopener ugc nofollow" target="_blank"> Sawitre </a></p></figure><p id="fffa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你曾经为了昨天的销售报告等了一夜吗？或者，您可能渴望通过实时销售点和订单管理数据预测库存需求的最新需求预测。我们总是在等待我们的分析。更糟糕的是，要求修改我们的报告通常需要几周时间。雪上加霜的是，您一直在为专用分析数据库不断增加的成本缴税。</p><p id="196c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是如果这不再是必要的呢？如果您可以整合分析，使其与运营工作负载在同一个数据库上运行，会怎么样？你的第一反应可能是，“你疯了。我们将分析从数据库中移走，因为它永远不够快。”过去是这样，但现在不是了。现在，通过将您的分析整合到一种称为混合事务分析平台(HTAP)的不同类型的SQL RDBMS上，可以降低您的数据库成本。一些HTAP数据库可以是专门的工程系统，可能花费数百万美元。但是在一个<strong class="kk iu">横向扩展</strong>架构上有一种新的HTAP。这种架构将数据分布在多个服务器上，并在每个服务器上的不同引擎上执行计算，以实现混合工作负载的规模和性能。</p><p id="7f75" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">HTAP是Gartner创造的一个术语，用来描述新兴的数据库技术和应用程序，这些技术和应用程序可以提供在线事务处理(OLTP)和分析处理(OLAP)，从而产生更丰富的应用程序体验和更多的商业价值。Forrester称之为Translytical数据平台。如果没有这种平台，企业将被迫通过利用运营数据存储、数据仓库和数据集市的复杂管道来转换数据并将其移出应用数据库，以便最终实现分析和数据科学。这非常耗时，并导致以下方面的延迟:</p><ol class=""><li id="66b9" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld ma mb mc md bi translated">生成报告</li><li id="722c" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">更新已部署的机器学习模型的特征，从而对旧数据进行预测</li><li id="aab8" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">机器学习模型重新训练，导致模型不太准确。</li></ol><p id="8e7c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客中，我们展示了如何测量HTAP工作负载的性能。为此，我们将在同一组表上同时运行的TPC-C和TPC-H基准组合起来。TPC-C模拟批发零售企业用户接受销售订单、处理付款、进行库存水平检查，并在大量交易数据上以高并发性记录交付。TPC-H基准测试由22个复杂的分析查询组成，这些查询以相对较低的并发性扫描大量历史数据。</p><p id="3242" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们在这里使用开源基准测试项目<a class="ae lu" href="https://github.com/splicemachine/htap-benchmark/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">来驱动最初发表在</a><a class="ae lu" href="https://dl.acm.org/doi/pdf/10.1145/1988842.1988850" rel="noopener ugc nofollow" target="_blank">The mixed workload CH-benCHmark，Richard Cole等人，db test’11，Athens，Greece </a>中的测试。基准测试依赖于<a class="ae lu" href="http://www.vldb.org/pvldb/vol7/p277-difallah.pdf" rel="noopener ugc nofollow" target="_blank"> OLTP-Bench中提供的代码:一个用于对关系数据库进行基准测试的可扩展测试床</a>，D. E. Difallah，A. Pavlo，C. Curino和P. Cudre-Mauroux在2014年VLDB大会上。这种处理HTAP工作负载的方法从TPC-C作为基线开始，然后覆盖修改后的针对TPC-C模式的TPC-H查询。我们已经让位于<a class="ae lu" href="https://cloud.splicemachine.io/?utm_source=medium&amp;utm_medium=blogpost&amp;utm_campaign=htap" rel="noopener ugc nofollow" target="_blank">这里</a>的集群免费试用。</p><p id="34ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> TPC-C新订单交易</strong></p><p id="01e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们测试的工作负载运行中测量的事务不是单个SQL语句，而是实际上复杂的应用程序逻辑，由一系列打包在ACID事务中的select、insert和update语句组成，这些语句要么作为一个整体提交，要么作为一个整体回滚。每个新订单事务平均由十个不同的行项目组成，平均需要46条SQL语句来处理。</p><p id="db18" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的实验是在AWS上的开源RDBMS平台即服务的拼接机器上进行的。(声明:两位作者都在Splice Machine工作，一位是CEO)。Splice Machine为数据工程师和数据科学家提供集成开发环境的“笔记本”。这些笔记本包括用于多语言编程的JupyterLab和BeakerX，跨单元格的变量共享，以及许多其他很酷的编码和可视化API。下面一组Jupyter笔记本单元格显示了构成新订单事务的SQL语句。为了简化这里给出的代码，我们对示例事务的一些元素进行了硬编码:我们在订单中使用了一个商品，并将订单保存在同一个仓库的本地。基准并不局限于此。</p><p id="8635" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">新订单交易从客户和地区查找开始，以便获得折扣、信用和税收信息，并保留订单id，这些都是处理新订单所需要的。我们在这里使用一个python单元来存储SQL的结果，并为多语言访问设置一些BeakerX变量:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/2aa9b389dcca7c6b4277e1057d57dda5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qRPWmq8ATqkKV0Sc"/></div></div></figure><p id="7c3d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们更新该地区递增的下一个订单id，在order和NEW_ORDER表中创建一个新的订单条目，并检查所订购商品的仓库库存水平:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/553e365b2ec473dc6dccb37062990ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4UqnTfdf-S2EzkLv"/></div></div></figure><p id="683d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，应用程序逻辑计算订单中每个项目的订单总数和补货需求，更新库存记录，并创建订单行记录。在示例代码中，我们只做一次，但是在实际的基准测试中，订单中的每个行项目都会发生一次，平均每个订单10次。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/f9c4d6ddb26a8fc8761358582927b4e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jfovNxuI2RHc1orU"/></div></div></figure><p id="f8cb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> TPC-H查询</strong></p><p id="e817" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">TPC-H基准旨在测试决策支持系统，为业务运营提供见解。在这里，TPC-H查询#2搜索欧洲的供应商，这些供应商具有尺寸为15的黄铜零件的最低欧洲价格:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mj"><img src="../Images/0d01d7525c6c3987896b26c0bf692ab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o6vmBYiymBH1jPdK"/></div></div></figure><p id="46e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这要求我们首先计算整个欧洲当前的最低价格，然后找到在欧洲以最低价格供应的15号黄铜零件。这需要跨大型数据集的多个连接和聚合。这种查询通过使用并行分布式处理进行水平扩展来实现更高的吞吐量。</p><p id="c33f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">拼接机RDBMS有单独的工作人员负责OLTP和OLAP工作负载。为了实现以下结果，我们利用了一个由8个m5.2x大型节点组成的AWS集群，该集群由4个OLTP工作线程和4个OLAP工作线程组成，同时运行100个并发TPC-C用户和8个并发TPC-H用户。Splice Machine提供了一个免费的试用集群，利用相同的硬件配置和附带的HTAP笔记本，让您可以轻松地试验其他并发配置。我们运行了10分钟长的HTAP工作负载，按工作负载的事务类别测量总计数，并记录所有响应时间。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mk"><img src="../Images/98f427d306a69e991cc9180fcc5da91e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cug7Dev1KfU-JO-m"/></div></div></figure><p id="2661" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前两个图表是已完成交易的累计计数。X轴以秒为单位测量经过的测试时间。在TPC-C图表中，计数按请求类型划分，其中测量的每个事务是许多SQL语句的集合；图例中的2I 3U 4S表示2次插入、3次更新、4次选择作为最小操作计数。在许多事务中，SQL语句计数随着订单中项目计数的增长而增长，平均订单大小为10个项目。在TPC-H查询图表中，我们统计了已执行查询的总数。这些是复杂的查询，涉及表扫描、大型连接和聚合、子查询以及其他开销很大的查询结构。</p><p id="bb1a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">延迟图表向我们展示了事务响应时间在整个工作负载执行过程中是如何变化的。第99百分位线显示，99%的事务运行时间不到一秒钟。第50百分位线显示50%的查询持续运行不到一秒。</p><p id="b5a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总之，在一个4x4拼接机数据库上，在100个TPC-C用户和8个TPC-H用户的情况下，运行10分钟，我们看到完成了191，789个TPC-C事务和14个TPC-H查询，99%的查询的SLA都在1.085秒内运行，但由于测试初始化开销，只有一个3.3秒的初始峰值。</p><p id="eef2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们想了解如果我们将资源翻倍，这将如何扩展。我们建立了一个8 OLTP x 8 OLAP拼接机数据库，并对100个TPC-C用户和8个TPC-H用户重新运行了10分钟的相同测试:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ml"><img src="../Images/812b50f9524231c60752f0a752b77814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S3dPcjPQ_kC-MS5T"/></div></div></figure><p id="072b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更多计算资源这导致两种工作负载的吞吐量显著增长:</p><ul class=""><li id="def2" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld mm mb mc md bi translated">TPC-C交易= 279，480 (+46%)</li><li id="95bb" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld mm mb mc md bi translated">TPC-H查询= 32次(+128%)</li></ul><p id="5b10" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SLA也更好，99%的事务运行时间不到0.79秒。</p><p id="faf3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">TPC-H的增长似乎好于预期，而TPC-C没有预期的那么多，因此我们进行了另一项测试，试图更好地理解这一点。我们的理论是100个TPC-C用户不会使拼接机OLTP工作线程饱和，因此我们将TPC-C上的并发数增加到200，并再运行10分钟:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mn"><img src="../Images/1716891142721b9b7512e7df0b2a0c0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fw7AGhSFa0BOzi2t"/></div></div></figure><p id="a50e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该测试的结果是:</p><ul class=""><li id="1c2a" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld mm mb mc md bi translated">TPC-C交易= 330，728(与第一次相比增加了72%)</li><li id="bbd1" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld mm mb mc md bi translated">TPC-H查询= 24次(与第一次相比增加了71%)</li><li id="ce82" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld mm mb mc md bi translated">SLA—99%的交易在1.3秒内完成</li></ul><p id="90a5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确认我们仍然可以通过请求更多事务来增加8x8的吞吐量。</p><h2 id="e49f" class="mo mp it bd mq mr ms dn mt mu mv dp mw kr mx my mz kv na nb nc kz nd ne nf ng bi translated">结论</h2><p id="9f6c" class="pw-post-body-paragraph ki kj it kk b kl nh ju kn ko ni jx kq kr nj kt ku kv nk kx ky kz nl lb lc ld im bi translated">我们能够运行并发的TPC-C和TPC-H工作负载，同时保持稳定的事务响应时间。我们还通过将OLTP和OLAP工作人员增加一倍来测试增加的资源，并看到两种工作负载都有近乎线性的提高。然而，最终测试中TPC-H成绩的下降促使我们调查为什么会发生这种情况。</p><p id="3085" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过检查所有服务的资源消耗，我们意识到使用CPU请求的默认Kubernetes配置(相对于CPU限制)允许一个服务通过抓取分配给其他服务的未使用的CPU来消耗超过其分配量的CPU。</p><p id="ca4c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可变资源分配可能是一件好事，也可能是一件坏事，这取决于你的需求。考虑到可变的工作负载，我们可能希望动态地将OLTP工作线程的资源用于OLAP工作，就像我们在第二个测试中看到的那样，或者当我们增加OLTP端的工作时，回收分配给OLAP工作的CPU。另一方面，为了保证OLTP SLAs，我们可能希望为OLAP工作人员尝试固定的CPU限制。关于可用配置、如何调整它们以及它们的影响的更多信息将在以后的博客文章中进行深入探讨。</p><p id="4d34" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要执行您自己的测试，可以从<a class="ae lu" href="https://cloud.splicemachine.io/?utm_source=medium&amp;utm_medium=blogpost&amp;utm_campaign=htap" rel="noopener ugc nofollow" target="_blank">这里</a>获得基准。数据库启动后，只需点击数据库快速启动页面上的“运行HTAP基准”链接。</p></div></div>    
</body>
</html>