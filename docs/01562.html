<html>
<head>
<title>User Defined Functions in Redshift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">红移中的用户定义函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/user-defined-functions-in-redshift-54bb297e1927?source=collection_archive---------10-----------------------#2020-02-12">https://towardsdatascience.com/user-defined-functions-in-redshift-54bb297e1927?source=collection_archive---------10-----------------------#2020-02-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="92ed" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">红移中用户定义函数的快速入门</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/58bec621c7a94673f0a58411e02c61a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vovYUj2SDVfwSYwd.png"/></div></div></figure><p id="7506" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">亚马逊红移是一个云数据仓库，有自己的红移 SQL 方言(PostgreSQL 的变种)。由于其低成本和与其他亚马逊网络服务的兼容性，这项服务变得越来越受欢迎。我最喜欢的红移集成是能够从 S3 卸载数据和拷贝数据。</p><p id="bcda" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我们将重点介绍<a class="ae lq" href="https://docs.aws.amazon.com/redshift/latest/dg/user-defined-functions.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">用户自定义函数</strong> </a> <strong class="kw iu"> (UDFs) </strong>。</p><h1 id="6e4a" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">什么是用户定义函数？</h1><p id="e8ea" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">UDF 是可以从红移数据仓库定制和创建的标量函数。每个函数可以接受固定数量的参数来返回一个<em class="mo">单个</em>输出。UDF 可以像内置的红移函数一样执行，比如<code class="fe mp mq mr ms b">replace</code>或<code class="fe mp mq mr ms b">lower</code>。</p><h2 id="e149" class="mt ls it bd lt mu mv dn lx mw mx dp mb ld my mz md lh na nb mf ll nc nd mh ne bi translated">命名规格</h2><p id="e9f9" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">亚马逊推荐所有 UDF 名字都以<code class="fe mp mq mr ms b">f_</code>开头。例如，用于计算两个日期之间的营业天数的 UDF 可以命名为<code class="fe mp mq mr ms b">f_calculate_business_days</code>。这将防止 UDF 名字和新红移函数之间的冲突——<code class="fe mp mq mr ms b">f_</code>前缀是专门为 UDF 保留的。</p><h2 id="d523" class="mt ls it bd lt mu mv dn lx mw mx dp mb ld my mz md lh na nb mf ll nc nd mh ne bi translated">UDF 语言</h2><p id="c1ec" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">可以使用 SQL <code class="fe mp mq mr ms b">select</code>语句或 Python 函数创建 UDF。用 SQL 编写的 UDF 性能更高，但是 Python UDFs 具有内置库的优势。除了 Python 标准库之外，Python UDFs 还支持 pandas、scipy、numpy 等函数。还有一个选项，通过从保存在 S3 的代码创建一个库来导入额外的 Python 库。</p><h1 id="136b" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">创造一个 UDF</h1><p id="8e78" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">所有的 UDF 都是使用<code class="fe mp mq mr ms b">CREATE FUNCTION</code>命令创建的。或者，我们可以使用<code class="fe mp mq mr ms b">CREATE OR REPLACE FUNCTION</code>来更新现有的 UDF。</p><p id="23b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">任何 UDF 最多只能有 32 个参数。</p><h1 id="3ba1" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">SQL UDF</h1><p id="d755" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">这是 SQL UDF 的结构:</p><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="d211" class="mt ls it ms b gy nj nk l nl nm">create function f_sql_udf ([arg1 data type], ...)   <br/>returns [return data type] <br/>stable as $$   </span><span id="59b1" class="mt ls it ms b gy nn nk l nl nm">select ...</span><span id="1385" class="mt ls it ms b gy nn nk l nl nm">$$ language sql;</span></pre><p id="7b90" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">UDF 体由<em class="mo">一个</em>选择语句组成。SQL UDF 中的参数不能命名。它们必须被引用(按照它们被定义的顺序)为$1、$2 等等。参数可以采用任何红移数据类型。</p><h1 id="4d82" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">蟒蛇 UDF</h1><p id="33f3" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">这是 Python UDF 的结构:</p><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="dbad" class="mt ls it ms b gy nj nk l nl nm">create function f_python_udf (arg_name [arg1 data type], ...)   returns [return data type] <br/>stable as $$   </span><span id="e311" class="mt ls it ms b gy nn nk l nl nm">[Python code here]</span><span id="9c4c" class="mt ls it ms b gy nn nk l nl nm">$$ language plpythonu;</span></pre><p id="787f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">与 SQL UDFs 不同，Python UDFs 需要参数名。已安装的库也可以作为 Python 代码的一部分导入。参考<a class="ae lq" href="https://docs.amazonaws.cn/en_us/redshift/latest/dg/udf-data-types.html" rel="noopener ugc nofollow" target="_blank">本页</a>了解支持的 Python UDF 数据类型。</p><h1 id="9c99" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">UDF 和用法示例</h1><p id="b9cd" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">考虑一个非常简单的 UDF 清洗字符串。我们希望这个 UDF 将输入转换成小写，并用空格替换下划线。虽然这些清理步骤可以内置到 SQL 查询本身中，但是我们也可以使用 UDF 来使查询更加一致和易读。</p><h2 id="8dac" class="mt ls it bd lt mu mv dn lx mw mx dp mb ld my mz md lh na nb mf ll nc nd mh ne bi translated">结构化查询语言</h2><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="d7c2" class="mt ls it ms b gy nj nk l nl nm">create function f_clean_text (varchar)   <br/>returns varchar<br/>stable as $$</span><span id="2e37" class="mt ls it ms b gy nn nk l nl nm">select replace(lower($1), '_', ' ')</span><span id="fdff" class="mt ls it ms b gy nn nk l nl nm">$$ language sql;</span></pre><h2 id="9149" class="mt ls it bd lt mu mv dn lx mw mx dp mb ld my mz md lh na nb mf ll nc nd mh ne bi translated">计算机编程语言</h2><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="ac3e" class="mt ls it ms b gy nj nk l nl nm">create function f_clean_text (text varchar)   <br/>returns varchar<br/>stable as $$</span><span id="7aa9" class="mt ls it ms b gy nn nk l nl nm">return text.lower().replace('_', ' ')</span><span id="b00a" class="mt ls it ms b gy nn nk l nl nm">$$ language plpythonu;</span></pre><h2 id="8dea" class="mt ls it bd lt mu mv dn lx mw mx dp mb ld my mz md lh na nb mf ll nc nd mh ne bi translated">使用</h2><p id="fc48" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">我们可以用这个语句来测试我们的新 UDF。</p><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="371e" class="mt ls it ms b gy nj nk l nl nm">select f_clean_text('eRROR_BAD_input')</span></pre><p id="f224" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以将这个 UDF 应用于一个名为<code class="fe mp mq mr ms b">error_messages</code>的列</p><pre class="kj kk kl km gt nf ms ng nh aw ni bi"><span id="d4e4" class="mt ls it ms b gy nj nk l nl nm">select f_clean_text(error_messages) from schema.table</span></pre><h1 id="0238" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">多方面的</h1><ul class=""><li id="51af" class="no np it kw b kx mj la mk ld nq lh nr ll ns lp nt nu nv nw bi translated">要查看用于创建现有 UDF 的代码，请查询<code class="fe mp mq mr ms b">pg_proc</code>表</li><li id="c6c5" class="no np it kw b kx nx la ny ld nz lh oa ll ob lp nt nu nv nw bi translated">UDF 支持 Python 日志库，这允许我们<a class="ae lq" href="https://docs.amazonaws.cn/en_us/redshift/latest/dg/udf-logging-messages.html" rel="noopener ugc nofollow" target="_blank">在 UDF 中记录警告和错误</a></li><li id="4b06" class="no np it kw b kx nx la ny ld nz lh oa ll ob lp nt nu nv nw bi translated">数据库管理员可以使用 GRANT 和 REVOKE 来自定义<a class="ae lq" href="https://docs.amazonaws.cn/en_us/redshift/latest/dg/udf-security-and-privileges.html" rel="noopener ugc nofollow" target="_blank"> UDF 特权</a></li><li id="c7be" class="no np it kw b kx nx la ny ld nz lh oa ll ob lp nt nu nv nw bi translated">要删除 UDF，运行<code class="fe mp mq mr ms b">drop function udf_name(arguments)</code></li></ul></div><div class="ab cl oc od hx oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="im in io ip iq"><p id="1dd1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是一个练习和应用 SQL 的 Coursera 课程。</p><div class="oj ok gp gr ol om"><a href="https://click.linksynergy.com/link?id=J2RDo*Rlzkk&amp;offerid=759505.17916350380&amp;type=2&amp;murl=https%3A%2F%2Fwww.coursera.org%2Fspecializations%2Fdata-science-fundamentals-python-sql" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">Python 和 SQL 的数据科学基础</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">IBM 是通过开放的混合云平台和人工智能进行业务转型的全球领导者，为客户提供…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">click.linksynergy.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div><h1 id="2524" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">感谢您的阅读！</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://ko-fi.com/mandygu#checkoutModal"><div class="gh gi pb"><img src="../Images/c2fcf86bbf79d7f57582562b51819c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IED-LbhRFh_vET8NWDCIew.png"/></div></a></figure><p id="23a3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你喜欢这篇文章，可以考虑给我买杯咖啡——每一点小小的贡献都帮助我找到更多的时间在这个博客上工作。<a class="ae lq" href="https://medium.com/@mandygu" rel="noopener">通过 Medium </a>关注我的最新更新。😃</p><p id="cf11" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">作为一个业余爱好项目，我还在<a class="ae lq" href="http://www.dscrashcourse.com/" rel="noopener ugc nofollow" target="_blank">www.dscrashcourse.com</a>建立了一套全面的<strong class="kw iu">免费</strong>数据科学课程和练习题。</p><p id="4805" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">再次感谢您的阅读！📕</p></div></div>    
</body>
</html>