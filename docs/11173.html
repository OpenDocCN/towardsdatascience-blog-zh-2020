<html>
<head>
<title>How to use Machine Learning Models to make Predictions directly from Snowflake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用机器学习模型直接从雪花中进行预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-machine-learning-models-to-make-prediction-directly-from-snowflake-2471b2f71b68?source=collection_archive---------38-----------------------#2020-08-03">https://towardsdatascience.com/using-machine-learning-models-to-make-prediction-directly-from-snowflake-2471b2f71b68?source=collection_archive---------38-----------------------#2020-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="03a7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用雪花存储过程、Snowpipe、流和任务，允许用户通过 SQL 调用机器学习推理</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a3da34b6eb68cda25eb6dbbaace7ec2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X4UkASZhPt2LMW-J"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae ky" href="https://unsplash.com/@kennyzhang29" rel="noopener ugc nofollow" target="_blank"> kennyzhang29 </a>来自<a class="ae ky" href="https://unsplash.com/photos/5LyYqPEv8w0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="8ed3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，我们会面临这样的场景(最近我也是)，数据科学家部署的模型按计划运行，无论是每小时一次、每天一次还是每周一次…您都明白这一点。然而，有时需要超出计划的结果来为会议或分析做出决策。</p><p id="1b6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，有几种方法可以得到超出计划的预测…</p><h2 id="2b19" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">获得超出计划的预测</h2><ol class=""><li id="5612" class="mo mp it lb b lc mq lf mr li ms lm mt lq mu lu mv mw mx my bi translated">用户可以使用一个笔记本实例，连接到数据存储，将数据卸载到 S3，引用数据进行预测，并将结果复制回数据存储。</li><li id="58b5" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">开发人员可以构建一个模型托管 API，其中用户可以使用数据存储来提取数据，并发布到托管 API 上进行预测。</li><li id="f7e7" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">构建一个管道，允许用户使用 SQL 调用批处理预测来直接卸载数据。</li></ol><p id="be33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，即使 Data Scientist &amp; Co 可以为其他人实现一个批量预测应用程序，用于计划外的情况，也可以直观地让非技术用户更接近模型本身，并赋予他们从 SQL 运行预测的能力。</p><h2 id="2f0e" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">弥合在雪花上运行预测和 SQL 之间的差距</h2><p id="fee2" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">受亚马逊 Aurora 机器学习的启发，我花了几天时间思考如何弥合这一差距，并构建了一个架构，允许非技术用户舒适地使用 SQL 执行批量预测。这都是在 Snowflake 中使用存储过程、Snowpipe、流和任务以及 SageMaker 的批量预测作业(Batch Transform)来创建批量推理数据管道。</p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="122f" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">雪花机器学习-建筑设计</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/66251c22a03597b8c67addb0bbb5c0fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CtZms-z7TmRzLttt5ZiMg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">建筑结构图</p></figure><ol class=""><li id="96f8" class="mo mp it lb b lc ld lf lg li oa lm ob lq oc lu mv mw mx my bi translated">用户以所需的格式将数据卸载到 S3，这将触发 Lambda。</li><li id="73e1" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">调用 SageMaker 批处理转换作业是为了使用训练好的模型对数据进行批处理预测。</li><li id="532f" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">预测的结果被写回到 S3 桶中</li><li id="8ea7" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">SQS 被设置在 S3 桶上，以将预测结果自动摄取到雪花上</li><li id="9d64" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">一旦数据到达雪花，流和任务被调用。</li></ol></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="0717" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">卸载到 S3 —使用存储过程</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/5b561577a1c79d6bbe987ce33f0a9310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-RtY8XGQo89DD3DZD6klA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">S3 卸货流程图</p></figure><h2 id="6adb" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">创建输入表</h2><p id="9c5f" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">为了让用户调用 Batch Transform，用户需要创建一个包含模型数据和强制字段的输入表，<code class="fe oe of og oh b">predictionid</code>是作业的 uuid，<code class="fe oe of og oh b">record_seq</code>是到达输入行的唯一标识符，一个空的<code class="fe oe of og oh b">prediction</code>列是感兴趣的目标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/9d4a36329fcb47f7eb53749fb36eb9a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EqdjeLYAUWkIwb1tzOSLJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">输入数据:酒店 _ 取消</p></figure><h2 id="2542" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">卸到 S3</h2><p id="9ed8" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated"><code class="fe oe of og oh b">call_ml_prediction</code>存储过程接受一个用户定义的作业名和输入表名。调用它会将文件(使用<code class="fe oe of og oh b">predictionid</code>作为名字)卸载到<code class="fe oe of og oh b">/input</code>路径的 S3 桶中，并在<code class="fe oe of og oh b">prediction_status</code>表中创建一个条目。从那里，将调用批处理转换来预测输入的数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="dccb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ol">为了确保不提交多个请求，一次只能运行一个作业。为了简单起见，我还确保只有一个文件被卸载到 S3 上，但是 Batch Transform 可以处理多个输入文件。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/98debe7226f95a04d8c9d1538e9c8f52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kA4ZOOQfBxhhQ8tDN0TSEg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">预测状态表</p></figure></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="b1d4" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">预测—使用 SageMaker 批量转换</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/ff2e99bd2d2a91bb10e2f781b72413a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xJDiVZoyDv8P0JuLZOzbqg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">触发批量转换的流程图</p></figure><h2 id="9aeb" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">触发 SageMaker 批量转换</h2><p id="e52a" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">一旦数据被卸载到 S3 存储桶<code class="fe oe of og oh b">/input</code>，Lambda 就会被触发，从而调用 SageMaker 批处理转换来读入输入数据并将推理输出到<code class="fe oe of og oh b">/sagemaker</code>路径。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="112e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ol">如果您熟悉批量转换，您可以根据自己的喜好为输出预测文件设置 input_filter、join 和 output_filter。</em></p><h2 id="cffa" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">批量转换输出</h2><p id="1641" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">一旦批量转换完成，它就将结果作为<code class="fe oe of og oh b">/sagemaker</code>路径中的<code class="fe oe of og oh b">.csv.out</code>输出。另一个 Lambda 被触发，它将文件复制并重命名为<code class="fe oe of og oh b">.csv</code>到<code class="fe oe of og oh b">/snowflake</code>路径，在那里 SQS 被设置为 Snowpipe 自动摄取。</p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="ad8e" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">结果——雪管、流和任务的使用</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/06f5cd9c568475528cd508006142ff9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vtt0tNAULwCvpDw3wCNqcg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将数据绘制成雪花的流程图</p></figure><h2 id="88a2" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">通过雪管摄入</h2><p id="493b" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">一旦数据被放到<code class="fe oe of og oh b">/snowflake</code>路径上，它就通过 Snowpipe 被插入到<code class="fe oe of og oh b">prediction_result</code>表中。为简单起见，由于 SageMaker 批处理转换保持了预测的顺序，因此行号被用作连接到输入表的标识符。您可以在批处理转换本身中执行后处理步骤。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="5dc5" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">数据流和触发任务</h2><p id="d8c9" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在 Snowpipe 传送数据后，在<code class="fe oe of og oh b">prediction_result</code>表上创建了一个流，它将填充<code class="fe oe of og oh b">prediction_result_stream</code>。这个流，确切地说是<code class="fe oe of og oh b">system$stream_has_data('prediction_result_stream</code>，将被调度任务<code class="fe oe of og oh b">populate_prediction_result</code>用来调用存储过程<code class="fe oe of og oh b">populate_prediction_result</code>来填充<code class="fe oe of og oh b">hotel_cancellation</code>表上的预测数据，前提是有一个流。唯一标识符<code class="fe oe of og oh b">predictionid</code>也被设置为任务会话变量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oj ok l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/24b174df078eb52073325b09713fc5ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QhpeizoIm4-MtIa9GmYk1g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">批量转换的结果</p></figure><h2 id="4f3a" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">完成工作</h2><p id="c8f1" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在作业结束时，并且在<code class="fe oe of og oh b">populate_prediction_result</code>完成之后，使用系统任务会话变量，下一个任务<code class="fe oe of og oh b">update_prediction_status </code>将预测状态从<em class="ol">提交</em>更新为<em class="ol">完成</em>。这就结束了整个“使用 SQL 运行批量预测”管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/efb244f30487b148b6878578aeb6e4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qSwjSVTpss1XEUgAfQ1onw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">更新的预测状态</p></figure></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="d8c8" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">做得更好</h1><p id="bcc2" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Snowflake 通过 Snowpipe、Streams、Stored Procedure 和 Task 提供了强大的功能，创建了一个可用于不同应用程序的数据管道。当与 SageMaker 结合使用时，用户将能够直接从雪花发送输入，并与预测结果进行交互。</p><p id="3d08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管如此，还是有一些愿望清单项目可以改善整体体验，那就是:</p><ol class=""><li id="c87a" class="mo mp it lb b lc ld lf lg li oa lm ob lq oc lu mv mw mx my bi translated">对于雪花:手动触发，或在 Snowpipe 摄取完成后触发任务的能力。这将保证任务向上完成流。</li><li id="7fda" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">对于管道:能够从 AWS 端更新雪花的状态，让用户知道批量转换的进度</li></ol><p id="009d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你觉得这篇文章有用，并喜欢阅读。</p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="5fe8" class="no lw it bd lx np nq nr ma ns nt nu md jz nv ka mg kc nw kd mj kf nx kg mm ny bi translated">关于我</h1><blockquote class="or os ot"><p id="986a" class="kz la ol lb b lc ld ju le lf lg jx lh ou lj lk ll ov ln lo lp ow lr ls lt lu im bi translated">我喜欢写中型文章，并与大家分享我的想法和学习。我的日常工作包括帮助企业构建可扩展的云和数据解决方案，以及尝试新的食物食谱。请随时与我联系，随便聊聊，只要让我知道你来自媒体</p><p id="4259" class="kz la ol lb b lc ld ju le lf lg jx lh ou lj lk ll ov ln lo lp ow lr ls lt lu im bi translated">— <a class="ae ky" href="https://www.linkedin.com/in/cyamma/" rel="noopener ugc nofollow" target="_blank">李帝努·亚玛</a></p></blockquote></div></div>    
</body>
</html>