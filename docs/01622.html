<html>
<head>
<title>Dockerize your Python script and connect to external SQL Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">整理您的 Python 脚本并连接到外部 SQL Server</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-python-script-to-docker-container-and-connect-to-external-sql-server-in-10-minutes-225ff4c19ce5?source=collection_archive---------9-----------------------#2020-02-14">https://towardsdatascience.com/deploying-python-script-to-docker-container-and-connect-to-external-sql-server-in-10-minutes-225ff4c19ce5?source=collection_archive---------9-----------------------#2020-02-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="6fba" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">Docker、Python 和 SQL Server</h2><div class=""/><div class=""><h2 id="97b2" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">查看了许多链接和教程后，我决定编写一个简单的指南，介绍如何将 Python 脚本部署到 Docker 容器，然后连接到外部 SQL Server 实例，并使用<a class="ae ko" href="https://docs.microsoft.com/en-us/sql/connect/python/pyodbc/python-sql-driver-pyodbc?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> <em class="kp"> pyodbc </em> </a>执行简单的插入命令。</h2></div><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/8546c8fd724c71da1de0b1f926965690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WnAVipFG3GSJRIYE"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">照片由<a class="ae ko" href="https://unsplash.com/@arifriyanto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿里夫·里扬托</a>在<a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="1112" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">编写本指南时，假设您已经具备:</p><ul class=""><li id="82ae" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">Docker 安装完毕，转而使用 Linux 容器</li><li id="1675" class="mc md iq li b lj ml lm mm lp mn lt mo lx mp mb mh mi mj mk bi translated">SQL Server 实例正在运行</li></ul><p id="1785" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">您需要创建 3 个文件:</p><ul class=""><li id="5228" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">Dockerfile 文件</li><li id="b26b" class="mc md iq li b lj ml lm mm lp mn lt mo lx mp mb mh mi mj mk bi translated">main.py(这是您的主要 Python 代码)</li><li id="8460" class="mc md iq li b lj ml lm mm lp mn lt mo lx mp mb mh mi mj mk bi translated">requirements.txt</li></ul></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="a9d8" class="mx my iq bd mz na nb dn nc nd ne dp nf lp ng nh ni lt nj nk nl lx nm nn no iw bi translated">Dockerfile 文件</h2><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="c56d" class="mx my iq nq b gy nu nv l nw nx">FROM python:3</span><span id="785a" class="mx my iq nq b gy ny nv l nw nx">WORKDIR /app</span><span id="f1cf" class="mx my iq nq b gy ny nv l nw nx">ADD requirements.txt .<br/>ADD main.py .</span><span id="6af7" class="mx my iq nq b gy ny nv l nw nx">#Optional<br/>ENV https_proxy=<a class="ae ko" href="http://proxy1.uk.webscanningservice.com:3128" rel="noopener ugc nofollow" target="_blank">http://[</a>proxy]:[port]<br/>ENV http_proxy=<a class="ae ko" href="http://proxy1.uk.webscanningservice.com:3128" rel="noopener ugc nofollow" target="_blank">http://[</a>proxy]:[port]</span><span id="3960" class="mx my iq nq b gy ny nv l nw nx"># install FreeTDS and dependencies<br/>RUN apt-get update \<br/> &amp;&amp; apt-get install unixodbc -y \<br/> &amp;&amp; apt-get install unixodbc-dev -y \<br/> &amp;&amp; apt-get install freetds-dev -y \<br/> &amp;&amp; apt-get install freetds-bin -y \<br/> &amp;&amp; apt-get install tdsodbc -y \<br/> &amp;&amp; apt-get install --reinstall build-essential -y</span><span id="ddf8" class="mx my iq nq b gy ny nv l nw nx"># populate "ocbcinst.ini" as this is where ODBC driver config sits<br/>RUN echo "[FreeTDS]\n\<br/>Description = FreeTDS Driver\n\<br/>Driver = /usr/lib/x86_64-linux-gnu/odbc/libtdsodbc.so\n\<br/>Setup = /usr/lib/x86_64-linux-gnu/odbc/libtdsS.so" &gt;&gt; /etc/odbcinst.ini</span><span id="f190" class="mx my iq nq b gy ny nv l nw nx">#Pip command without proxy setting<br/>RUN pip install -r requirements.txt</span><span id="a962" class="mx my iq nq b gy ny nv l nw nx">#Use this one if you have proxy setting<br/>RUN pip --proxy <a class="ae ko" href="http://proxy1.uk.webscanningservice.com:3128" rel="noopener ugc nofollow" target="_blank">http://</a>[proxy:port] install -r requirements.txt</span><span id="834b" class="mx my iq nq b gy ny nv l nw nx">CMD ["python","-i","main.py"]<br/></span></pre></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="0d87" class="mx my iq bd mz na nb dn nc nd ne dp nf lp ng nh ni lt nj nk nl lx nm nn no iw bi translated">main.py</h2><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nz oa l"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">main.py 可能的样子示例</p></figure><h2 id="e60d" class="mx my iq bd mz na nb dn nc nd ne dp nf lp ng nh ni lt nj nk nl lx nm nn no iw bi translated">requirements.txt</h2><ul class=""><li id="562a" class="mc md iq li b lj ob lm oc lp od lt oe lx of mb mh mi mj mk bi translated"><strong class="li ja">选项 1 </strong></li></ul><p id="d0e0" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">创建一个文本文件并添加一行，如下所示:</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="d4ef" class="mx my iq nq b gy nu nv l nw nx">pyodbc==4.0.28</span></pre><ul class=""><li id="e0f2" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated"><strong class="li ja">选项 2 </strong></li></ul><p id="079f" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果您使用<a class="ae ko" href="https://www.jetbrains.com/pycharm/" rel="noopener ugc nofollow" target="_blank"> PyCharm </a>或任何终端并运行<a class="ae ko" href="https://pip.pypa.io/en/stable/reference/pip_freeze/" rel="noopener ugc nofollow" target="_blank"> <em class="og"> pip freeze </em> </a>命令，请使用 Python 终端:</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="b2a5" class="mx my iq nq b gy nu nv l nw nx">pip freeze &gt; requirements.txt</span></pre><p id="465e" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这将产生一个包含所有必需模块的文件。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="61db" class="oh my iq bd mz oi oj ok nc ol om on nf kf oo kg ni ki op kj nl kl oq km no or bi translated">构建并运行 Docker 映像</h1><p id="4bd2" class="pw-post-body-paragraph lg lh iq li b lj ob ka ll lm oc kd lo lp os lr ls lt ot lv lw lx ou lz ma mb ij bi translated">最后，我们希望构建并运行映像。</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="9733" class="mx my iq nq b gy nu nv l nw nx">#Build the image<br/>docker build -t my-app .<br/>#Run it<br/>docker run my-app<br/>#Find container name<br/>docker ps --last 1<br/>#Check logs<br/>docker logs &lt;container name&gt;</span></pre><p id="de76" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果您想浏览容器并手动运行脚本，那么修改<em class="og"> Dockerfile 的最后一行，</em>构建并再次运行<em class="og"/>:</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="9577" class="mx my iq nq b gy nu nv l nw nx">#CMD ["python","-i","main.py"]</span><span id="77e6" class="mx my iq nq b gy ny nv l nw nx">CMD tail -f /dev/null</span></pre><p id="d9a0" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这将使容器长时间运行，使您能够使用以下命令打开 bash shell:</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="d1cf" class="mx my iq nq b gy nu nv l nw nx">docker exec -ti &lt;container name&gt; bash</span></pre><p id="57fa" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">然后您将能够浏览容器并手动执行<em class="og"> main.py </em>。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/ad9ed49ebee7c720dc29572ea3623b16.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*oF_2RSBuq3acqOTO8PIhyw.png"/></div><p class="lc ld gj gh gi le lf bd b be z dk translated">打开 bash shell 后容器的屏幕截图</p></figure><p id="2cc3" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果要停止或移除容器，请使用:</p><pre class="kr ks kt ku gt np nq nr ns aw nt bi"><span id="c5f0" class="mx my iq nq b gy nu nv l nw nx">#List all containers<br/>docker ps -a</span><span id="b5db" class="mx my iq nq b gy ny nv l nw nx">#List all container id<br/>docker ps -aq</span><span id="21af" class="mx my iq nq b gy ny nv l nw nx">#Stop container<br/>docker stop &lt;container_name&gt;</span><span id="fef3" class="mx my iq nq b gy ny nv l nw nx">#Will remove all your containers<br/>docker rm -f $(docker ps -aq)</span></pre></div></div>    
</body>
</html>