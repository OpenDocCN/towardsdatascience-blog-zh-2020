<html>
<head>
<title>Training Networks to Identify X-rays with Pneumonia</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">训练网络识别X射线与肺炎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/training-networks-to-identify-x-rays-with-pneumonia-c98932e47da3?source=collection_archive---------50-----------------------#2020-05-16">https://towardsdatascience.com/training-networks-to-identify-x-rays-with-pneumonia-c98932e47da3?source=collection_archive---------50-----------------------#2020-05-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/fdc0eecc320e0fe335e82ec80056342c.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*qVyYLRARzH_AVxCuJqNCAg.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">来源:图片由<a class="ae jc" href="https://unsplash.com/@nci?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> NCI </a>在<a class="ae jc" href="https://unsplash.com/s/photos/chest-x-ray?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><div class=""/><div class=""><h2 id="3240" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">迁移学习如何在有限的数据和时间内领先</h2></div><p id="8b13" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw jg"> <em class="lq">编者按:</em> </strong> <em class="lq"> </em> <a class="ae jc" href="http://towardsdatascience.com/" rel="noopener" target="_blank"> <em class="lq">走向数据科学</em> </a> <em class="lq">是一份以数据科学和机器学习研究为主的中型刊物。我们不是健康专家或流行病学家，本文的观点不应被解释为专业建议。想了解更多关于疫情冠状病毒的信息，可以点击</em> <a class="ae jc" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports" rel="noopener ugc nofollow" target="_blank"> <em class="lq">这里</em> </a> <em class="lq">。</em></p><p id="42da" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">2020年，新冠肺炎疫情爆发，整个世界陷入停滞。科学界一直致力于在潜在的治疗方法上取得医学突破。这已经成为与这种病毒快速传播的竞赛，这也是为什么我们看到有史以来进展最快的临床试验。世界各地的数据科学家一直在通过利用数据来帮助这一过程。但是新冠肺炎患者的数据收集是一个持续的过程。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/c3d509cd1d1869e59b56f2bbfe14221a.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*JDKDNSYkNmS4yeXIDji2mw.gif"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">来源:<a class="ae jc" href="https://giphy.com/gifs/troy-landry-GgcusW5RLS9Nu" rel="noopener ugc nofollow" target="_blank">吉菲</a>。</p></figure><p id="60a2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有限的时间和数据是当今的一个挑战，迁移学习似乎是一个很好的解决方案。它将使我们能够使用根据具有相似结构的数据预先训练的模型。例如，使用已经在患有类似疾病的患者身上预先训练的模型。这也让我们有机会利用深度神经网络的学习能力，如果从头开始训练，将需要大量的数据和计算资源。</p><h1 id="b91d" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated"><strong class="ak">关于数据</strong></h1><p id="82b8" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated">数据来源于<a class="ae jc" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>。它包含从广州市妇女儿童医疗中心的1至5岁儿童患者回顾队列中选择的胸部X射线图像(前-后)。目标是将这些x光图像分类为肺炎正常或阳性。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ca"><img src="../Images/4e51cbf2979a25342bd7337315515a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5q1K5QjZNbssVrPs"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">数据集目录结构。来源:作者。</p></figure><p id="97dc" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用Kaggle API将全部数据直接导入Google Colaboratory。所有的分析都是在相同的GPU上完成的。代码可以在<a class="ae jc" href="https://github.com/MS1997/X-ray-classification.git" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/c62ed65f004bcaf9e6a8cdf5ac6b4b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sR6GYWEcURdfm7P9"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">从训练集中随机选择的患者的x射线。来源:<a class="ae jc" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>。</p></figure><h1 id="5b4e" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated"><strong class="ak">了解剩余网络或resnet</strong></h1><p id="365e" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated">残差网络(ResNets)是卷积网络，它是作为使用“普通”卷积网络<em class="lq">时通常面临的退化问题</em>的<em class="lq">解决方案而引入的。网络使用“跳过”连接来跳过深层网络的层。</em></p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div class="gh gi my"><img src="../Images/7c24d1dc798100984a18ee5f9ecf2009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*XcQ8BH9UjIlkWekgpsmM6A.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">网络就像天桥连接。来源:照片由<a class="ae jc" href="https://unsplash.com/@jaredmurray?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">贾里德·默里</a>在<a class="ae jc" href="https://unsplash.com/s/photos/multilevel-interchange?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="89e7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">跳过连接也可以被视为将先前层的输出添加到后面层的身份映射或功能。在前向传播中，ResNets将被跳过的子网的输出(称为“残余”)推至零(T15)。这使得真实输出几乎等于从其开始跳跃连接的子网的输出，从而由于更深的架构而减少了可观的信息损失。</p><p id="491d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">ResNets的一个<em class="lq">额外的</em>好处是，在反向传播期间，跳跃连接也传播梯度流。跳过具有非线性激活函数的层使得初始梯度(来自较高层)更快地到达较早的层，这解决了消失梯度的问题。</p><p id="829f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本项目实施了ResNet50。</p><blockquote class="mz na nb"><p id="a06e" class="ku kv lq kw b kx ky kg kz la lb kj lc nc le lf lg nd li lj lk ne lm ln lo lp im bi translated"><a class="ae jc" href="https://arxiv.org/abs/1512.03385" rel="noopener ugc nofollow" target="_blank"><strong class="kw jg">ResNet 50架构:</strong></a><strong class="kw jg"/>ResNet 50是一个50层的ResNet，使用了“瓶颈设计”来提高计算效率。瓶颈设计表明他们使用3层堆栈。这三层分别是1x1，3x3，1x1卷积。两侧的1x1回旋用于减小然后恢复尺寸。因此，3x3层变得像一个具有较小输入&amp;输出尺寸的瓶颈。ResNet50拥有超过2300万个可训练参数。该网络已经在由1000个类组成的ImageNet数据集上、在128万幅图像的训练数据集上进行了预训练，在50k幅图像上进行了验证，并在另外100k幅图像上进行了测试。</p></blockquote><p id="4fd6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw jg"> <em class="lq">【跳过】到建模… </em> </strong></p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/4baf2a3469442e72ed7053619fda8400.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/1*0zfhKMaH2TANPFUDnamBqg.gif"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">资料来源:<a class="ae jc" href="https://giphy.com/gifs/happy-crazy-homer-simpson-kEKcOWl8RMLde" rel="noopener ugc nofollow" target="_blank"> GIPHY </a></p></figure><h1 id="3e44" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated">调整数据集的预训练模型</h1><p id="1748" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated">这些数据呈现出二元分类问题，具有以下两个类别:<em class="lq">正常</em> &amp; <em class="lq">肺炎</em>。由于最初的ResNet50网络用于将图像分类到1000个类别中的一个，为了利用预先训练的架构及其权重，该网络的顶部被移除。因此，最初的全连接图层被替换为全局平均池图层，随后是全连接图层密集图层和输出图层。尝试了其他组合，但这给出了最好的测试集性能。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ng"><img src="../Images/9ef0eef03f3cb4fcf05dd3a27aa97b56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bkBsrOjEDrkh8EofAII2zg.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">调整后的模型架构。来源:作者。</p></figure><h1 id="3edb" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated"><strong class="ak">模型预处理</strong></h1><p id="396f" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated"><strong class="kw jg"> <em class="lq">增加更多通道:</em> </strong>使用Keras中的图像数据生成器函数对图像进行预处理。数据的胸部X射线图像是灰度图像，其由单个通道组成。而ResNet50模型是在具有3个通道的ImageNet数据集的RGB图像上训练的。使用生成器函数的<em class="lq">颜色模式</em>参数，灰度图像被转换为具有3个通道。</p><p id="2ef0" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw jg"> <em class="lq">更多图像变换:</em> </strong>此外，使用水平翻转、缩放、高度/宽度移动和剪切变换来增强训练集中的图像。ResNet50预处理功能也应用于增强的训练图像、原始验证&amp;测试图像。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nh"><img src="../Images/87e9639af67cba337153af659c910ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F2-I2ae2JFyCeAdhd0768Q.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">训练集的9幅增强图像的样本。注意颜色的变化。来源:作者。</p></figure><p id="198e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用上述模型，达到的最佳测试精度为83% ！</p><h1 id="443f" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated">进一步微调</h1><ul class=""><li id="a709" class="ni nj jf kw b kx mo la mp ld nk lh nl ll nm lp nn no np nq bi translated"><strong class="kw jg">Keras中批处理规范化的争论:</strong>一些文献表明，由于Keras中的批处理规范化层在训练和推理阶段的工作方式不同，它可能会造成准确性度量的差异。因此，通过冻结除ResNet50基础模型的批标准化层之外的所有层，模型被<a class="ae jc" rel="noopener" target="_blank" href="/how-to-utilize-transfer-learning-to-classify-images-with-state-of-the-art-deep-learning-models-d8e5d5bb35d4">训练</a>。然后训练所有剩余的未冻结层(批量标准化层&amp;附加层)。</li></ul><pre class="ls lt lu lv gt nr ns nt nu aw nv bi"><span id="d0c1" class="nw lx jf ns b gy nx ny l nz oa">base_model = ResNet50(weights='imagenet',include_top=False,input_shape=(150,150,3))</span><span id="5114" class="nw lx jf ns b gy ob ny l nz oa">x = base_model.output #adding the resnet model</span><span id="830e" class="nw lx jf ns b gy ob ny l nz oa"># freezing all layers except the batch normalization layers<br/>for layer in base_model.layers:<br/>    if isinstance(layer, BatchNormalization):<br/>       layer.trainable = True<br/>    else:<br/>        layer.trainable = False </span></pre><ul class=""><li id="5def" class="ni nj jf kw b kx ky la lb ld oc lh od ll oe lp nn no np nq bi translated"><strong class="kw jg">超参数的调整:</strong>为了改善初始模型中的缓慢收敛，尝试了Adam优化器的不同学习速率和β_ 1值。选择0.01的学习率和0.9的β_ 1。查看批量大小，尝试了2的不同幂。32的批量给出了最好的测试结果。</li><li id="babe" class="ni nj jf kw b kx of la og ld oh lh oi ll oj lp nn no np nq bi translated"><strong class="kw jg">自定义回调函数:</strong>此外，观察到当训练模型期间的验证损失低于 0.1时，模型给出最佳测试精度。为了实现这一点，创建了一个自定义回调函数来训练模型，直到验证损失降到0.1以下，耐心参数为2。</li></ul><pre class="ls lt lu lv gt nr ns nt nu aw nv bi"><span id="5b7f" class="nw lx jf ns b gy nx ny l nz oa">#early stopping with custom call back<br/>class EarlyStoppingByLossVal(Callback):<br/>    def __init__(self, monitor=['val_loss'],patience=0, value=0.00001, verbose=0):<br/>        super(Callback, self).__init__()<br/>        self.monitor = monitor<br/>        self.value = value<br/>        self.verbose = verbose<br/>        self.patience = patience</span><span id="abea" class="nw lx jf ns b gy ob ny l nz oa">    def on_train_begin(self, logs=None):<br/>    # the number of epoch the model has waited when loss is below  the required value<br/>        self.wait = 0</span><span id="df2f" class="nw lx jf ns b gy ob ny l nz oa">    def on_epoch_end(self, epoch, logs={}):<br/>        current = logs.get(self.monitor)<br/>        if current is None:<br/>            warnings.warn("Early stopping requires %s available!" % self.monitor, RuntimeWarning)<br/>        if current &lt; self.value:<br/>            self.wait +=1<br/>            if self.wait &gt;= self.patience:<br/>                if self.verbose &gt; 0:<br/>                    print("Epoch %05d: early stopping" % epoch)<br/>                    self.model.stop_training = True</span></pre><p id="5a67" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">微调后达到的最佳测试精度为<strong class="kw jg"> 93.75% </strong>。AUROC曲线为<strong class="kw jg"> 0.98 </strong>。</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ok"><img src="../Images/b27f12c6d0291d942c5ac1728df82127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0OoJwXpEbqYezpnli9AnTQ.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">最佳测试集性能的混淆矩阵和ROC曲线。来源:作者。</p></figure><h1 id="91fc" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated"><strong class="ak">未来范围</strong></h1><p id="227c" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated">同时，该模型在测试集上表现良好，增加了代表不同地区和人口统计学的患者数据，并且进一步的超参数调整可以改善模型结果。使用专门针对X射线图像预先训练的模型，如<a class="ae jc" href="https://stanfordmlgroup.github.io/projects/chexnet/" rel="noopener ugc nofollow" target="_blank"> ChestXNet </a>也可以给出更好的结果。这个项目的目的不是做出任何官方声明，而是帮助未来的研究。任何诊断都只能由专业医疗人员做出！</p><figure class="ls lt lu lv gt iv gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/129c2873a34e33992d922489b1d2eac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/1*5EcfgtzCwEi0JXiVT-XJBQ.gif"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">资料来源:吉菲。</p></figure><h1 id="374d" class="lw lx jf bd ly lz ma mb mc md me mf mg kl mh km mi ko mj kp mk kr ml ks mm mn bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="82e9" class="pw-post-body-paragraph ku kv jf kw b kx mo kg kz la mp kj lc ld mq lf lg lh mr lj lk ll ms ln lo lp im bi translated">根据世界卫生组织的消息，“重症新冠肺炎患者最常见的诊断是重症肺炎”。本文展示了一个与新冠肺炎相关的迁移学习的使用案例。一个预先训练的ResNet模型已被用于将患者的x光片分类为“正常”或感染了肺炎。</p></div></div>    
</body>
</html>