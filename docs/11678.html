<html>
<head>
<title>Chaining Multiple SQL Queries in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 BigQuery 中链接多个 SQL 查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/chaining-multiple-sql-queries-in-bigquery-8498d8885da5?source=collection_archive---------15-----------------------#2020-08-13">https://towardsdatascience.com/chaining-multiple-sql-queries-in-bigquery-8498d8885da5?source=collection_archive---------15-----------------------#2020-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="57d6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在 BigQuery 中依次执行多个查询</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2fe78f3b257bd8ba1678aadac8b52a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PuwAyg9hSnGwUg9y_2UKGw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://pixabay.com/users/dakub-8222964/" rel="noopener ugc nofollow" target="_blank"> Dakub </a>，Souce <a class="ae ky" href="https://pixabay.com/photos/duck-goose-march-series-queue-3217049/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="9144" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Bigquery 是一个非常棒的工具！它可以让你使用类似 SQL 的语法进行非常强大的分析工作。</p><p id="2bfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是它缺少对 SQL 查询的链接。我们不能在一个 SQL 完成后立即运行另一个。在许多实际应用中，一个查询的输出依赖于另一个查询的执行。我们希望运行多个查询来获得结果。</p><p id="513a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个场景，假设您正在使用 BigQuery ML 进行<a class="ae ky" rel="noopener" target="_blank" href="/rfm-analysis-using-bigquery-ml-bfaa51b83086"> RFM 分析。首先，您必须计算所有用户的 RFM 值，然后将 k-means 聚类应用于第一个查询的结果，然后合并第一个查询和第二个查询的输出，以生成最终的数据表。</a></p><p id="c64e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的场景中，每个下一个查询都依赖于前一个查询的输出，并且每个查询的输出也需要存储在数据中以供其他用途。</p><p id="e93c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本指南中，我将展示如何在 BigQuery 中一个接一个地执行尽可能多的 SQL 查询，创建一个链接效果来获得想要的结果。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a16d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">方法</strong></h1><p id="af0e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我将演示链接查询的两种方法</p><ol class=""><li id="028c" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><strong class="lb iu">第一种使用云发布/订阅和云函数:</strong>这是一种更复杂的方法，因为它确保在执行下一个查询之前完成当前查询的执行。这种方法也需要一点编程经验，所以最好联系公司里有技术背景的人。</li><li id="eecf" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">第二种使用 BigQuery 自己的调度器:</strong>然而，查询调度器不能确保一个查询的执行在下一个查询被触发之前完成，所以我们必须使用查询执行时间来破解它。稍后将详细介绍。</li></ol><p id="75ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">如果你想弄脏自己的手，那么</em> <a class="ae ky" href="https://bit.ly/2X4kefM" rel="noopener ugc nofollow" target="_blank"> <em class="nn">这里有一个极好的课程</em> </a> <em class="nn">可以开始。</em></p><p id="0e1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:我们将继续上面讨论的 RFM 的例子，让你了解这个过程。但是这同样适用于任何需要触发多个 SQL 查询的场景。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="520e" class="no md it bd me np nq dn mi nr ns dp mm li nt nu mo lm nv nw mq lq nx ny ms nz bi translated">方法 1</h2><p id="3fb4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">方法 1 使用云功能和发布/订阅的组合来链接整个流程。该过程由查询调度器开始，该查询调度器在执行第一个查询之后向发布/订阅主题发送消息，该消息触发负责触发第二个查询的云功能，并且一旦完成，就向另一个发布/订阅主题发送消息，以启动另一个云功能。这个过程一直持续到云函数执行最后一个查询。</p><p id="215e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过 RFM 分析用例来理解这个过程。</p><p id="8792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们有三个需要依次运行的查询来执行 RFM 分析。<br/> <strong class="lb iu"> <em class="nn">首先是</em> </strong> <em class="nn">，这样计算出的 RFM 值，我们就称之为</em> <code class="fe oa ob oc od b"><em class="nn">RFM Values</em></code> <em class="nn">。<br/> </em> <strong class="lb iu"> <em class="nn">第二个</em> </strong> <em class="nn">，这就产生了模型，我们就称之为</em> <code class="fe oa ob oc od b"><em class="nn">RFM Model</em></code> <em class="nn">。<br/> </em> <strong class="lb iu"> <em class="nn">第三个</em> </strong> <em class="nn">，即将模型输出与用户 RFM 值合并，我们称之为</em> <code class="fe oa ob oc od b"><em class="nn">RFM Final</em></code>。</p><p id="181a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是数据管道的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/8a50bff9a7ad541de1853c6fe80a4493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lBIZl6PD8dIfPPpWDK9jkA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过 Muffaddal 在 BigQuery 数据管道中链接查询</p></figure><p id="ec15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong> : <em class="nn">我假设已经为所有三个查询创建了表。</em></p><p id="1bfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1-我们首先创建一个发布/订阅主题，因为在创建<code class="fe oa ob oc od b"><em class="nn">RFM Values</em></code>查询调度器时会用到它。我将它命名为<code class="fe oa ob oc od b">RFM_Model_Topic</code>，因为它将触发负责执行我们的模型查询的云函数(即<code class="fe oa ob oc od b"><em class="nn">RFM Model</em></code>)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/2b5db4c0addacbf195ee8a71d30490d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btfITm6_pNwhuLxuUJVYUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">RFM _ 模型<code class="fe oa ob oc od b">_Topic</code>发布/订阅主题，作者 Muffaddal</p></figure><p id="c4a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">复制创建</em> <code class="fe oa ob oc od b"><em class="nn">RFM Values</em></code> <em class="nn"> schedular 时需要的主题名称。</em></p><p id="8c3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2-接下来，转到 BigQuery，在查询编辑器中粘贴为我们的用户计算 RFM 值的<code class="fe oa ob oc od b"><em class="nn">RFM Values</em></code>查询，然后单击“Schedule query”按钮创建一个新的查询调度器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/71a77b3184d0bd89cf74d8241884bed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BwK4BXDO_iGZxyUymhZaJA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过 Muffaddal 创建计划查询</p></figure><p id="07f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3-在调度程序创建菜单中输入所需的值，以创建调度程序</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/a09f59e3877831a40deeb01972cfc7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*weoqOfntr6K7KgUuZpQD1g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查询日程创建菜单，按 Muffaddal</p></figure><p id="d3dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个调度程序将在指定的时间执行，计算用户的最近次数、频率和货币值，并将其存储在上述 BigQuery 表中。一旦调度完成执行查询，它将向我们的<code class="fe oa ob oc od b">RFM_Model_Topic</code>发送一条消息，这将触发一个云函数来触发我们的模型查询。接下来让我们创建一个云函数。</p><p id="9490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4-进入<code class="fe oa ob oc od b">RFM_Model_Topic</code>发布/订阅主题，点击屏幕顶部的“触发云功能”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/d05874364abf2b7d879f7bdd185ef888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FBf28iRHff4IWYTur0kQXw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由 Muffaddal 从发布/订阅主题创建云函数</p></figure><p id="a996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">5-进入如下所示的设置，并将云功能命名为<code class="fe oa ob oc od b">RFM_Model_Function</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/950bb50139fdd1cf7615e99784fe16d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*8SMgPcMPEZ2CrvuXA_MT7g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云功能设置，由 Muffaddal</p></figure><p id="95cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">6-并将下面的代码粘贴到<code class="fe oa ob oc od b">index.js </code>文件中</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由 Muffaddal 触发 RFM 模型查询的云函数</p></figure><p id="4952" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦查询被执行，云函数向名为<code class="fe oa ob oc od b">RFM_Final</code>的新发布/订阅主题发送发布消息，这触发了负责将 RFM 值和模型结果组合在一个数据集中的最后查询的云函数。</p><p id="3687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">7-因此，接下来，在发布/订阅中创建<code class="fe oa ob oc od b">RFM_Model</code>主题和一个云函数，就像我们在上一步中做的那样。将下面的代码复制粘贴到云函数中，这样它就可以运行最后一个查询。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">触发 RFM 最终查询的云函数</p></figure><p id="86f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！</p><p id="4ef1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用任意多的发布/订阅和云函数来链接任意多的 SQL 查询。</p><h2 id="8abf" class="no md it bd me np nq dn mi nr ns dp mm li nt nu mo lm nv nw mq lq nx ny ms nz bi translated">方法 2</h2><p id="f938" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在第一种方法是健壮的，但是需要一点编程背景，并且说这不是你的强项。您可以使用方法 2 来链接 BigQuery 查询。</p><p id="df51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery 的查询调度器可以用来一个接一个地运行查询。</p><p id="dbd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想法是我们像方法 1 一样开始这个过程，即使用调度程序触发第一个查询，并估计它的完成时间。假设第一个查询需要 5 分钟来完成。我们要做的是在第一个查询开始时间后 10 分钟触发第二个查询。这样，我们可以确保第二个查询在第一个查询完全执行后被触发。</p><p id="daa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过例子来理解这一点</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/15641640dbbc6b66107faba2c764ad0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YaOkSezYz2RmYAvrBwoEPA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用查询调度器的链式查询，由 Muffaddal</p></figure><p id="8b00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们将第一次查询安排在凌晨 12:30。需要 10 分钟才能完成。因此我们知道在凌晨 12:40 第一个查询应该完成。我们将第二个查询调度器设置为在 12:50 am 执行(为了以防万一，在两个调度器之间保持 10 分钟的间隔)。我们将在凌晨 1:10 触发第三次查询，依此类推。</p><p id="ea84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">方法 2 也可以与方法 1 结合使用。这意味着我们使用云函数来触发查询调度程序。这样做还有一个额外的好处，那就是您不必遇到云函数的执行时间限制，并且您的查询可以执行所需的时间。<br/> PS:由</em> <a class="on oo ep" href="https://medium.com/u/5ecbb8c195df?source=post_page-----8498d8885da5--------------------------------" rel="noopener" target="_blank"> <em class="nn">西蒙汤姆森</em> </a> <em class="nn">建议用云功能触发按需查询调度器。</em></p><p id="ffde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:由于查询调度器不能与 BigQuery ML 一起工作，因此，方法 2 不能用于我们的 RFM 分析案例，但是它应该让您了解如何使用调度器来链接查询。</p><p id="3322" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">其他方法</strong></p><p id="877f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你能处理更复杂的管道<a class="on oo ep" href="https://medium.com/u/c81ac22e20c7?source=post_page-----8498d8885da5--------------------------------" rel="noopener" target="_blank">塞巴斯蒂安·莫兰</a>提出了<a class="ae ky" href="https://medium.com/@seb.morand/i-propose-two-other-methods-with-no-time-limitation-615c6e10c0a4" rel="noopener">另外两种方法</a>供你使用。</p><h1 id="a0ec" class="mc md it bd me mf op mh mi mj oq ml mm jz or ka mo kc os kd mq kf ot kg ms mt bi translated"><strong class="ak">总结</strong></h1><p id="db64" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一个接一个地执行查询有助于获得非常好的结果，特别是当一个查询的结果依赖于另一个查询的输出，并且所有的查询结果都需要表格格式时。开箱即用的 BigQuery 不支持这一功能，但使用 GCP 的组件，我们可以简化流程以获得结果。</p><p id="7014" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们通过两种方法做到了这一点。首先使用 cloud pub/sub 和 cloud 函数，另一个使用 BigQuery 自己的查询调度器。</p><p id="5ed7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这篇文章，我希望我能够向您传达这个过程的想法，以便您能够根据您的特定业务案例来选择和定制它。</p><h1 id="74d5" class="mc md it bd me mf op mh mi mj oq ml mm jz or ka mo kc os kd mq kf ot kg ms mt bi translated">阅读关于 BigQuery 的更多信息:</h1><div class="ou ov gp gr ow ox"><a rel="noopener follow" target="_blank" href="/rfm-analysis-using-bigquery-ml-bfaa51b83086"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd iu gy z fp pc fr fs pd fu fw is bi translated">使用 BigQuery ML 进行 RFM 分析</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">使用 BigQuery ML 中的 RFM 分析和 Data Studio 中的可视化进行用户细分。</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">towardsdatascience.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl ks ox"/></div></div></a></div><div class="ou ov gp gr ow ox"><a rel="noopener follow" target="_blank" href="/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd iu gy z fp pc fr fs pd fu fw is bi translated">向 BigQuery 发送标准的 Google Analytics 点击量数据</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">如何发送标准的谷歌分析点击量数据到 BigQuery？</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">towardsdatascience.com</p></div></div><div class="pg l"><div class="pm l pi pj pk pg pl ks ox"/></div></div></a></div><div class="ou ov gp gr ow ox"><a rel="noopener follow" target="_blank" href="/automate-data-import-to-google-analytics-471de2c3fc76"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd iu gy z fp pc fr fs pd fu fw is bi translated">自动将数据导入 Google Analytics。</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">建立一个数据管道，使用 Google Cloud Platfrom 将数据导入 google analytics。</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">towardsdatascience.com</p></div></div><div class="pg l"><div class="pn l pi pj pk pg pl ks ox"/></div></div></a></div></div></div>    
</body>
</html>