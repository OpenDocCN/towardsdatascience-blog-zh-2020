<html>
<head>
<title>Deploy a .NET API to Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将. NET API 部署到 Azure</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-a-net-api-to-azure-84ea79d42d1a?source=collection_archive---------17-----------------------#2020-03-21">https://towardsdatascience.com/deploy-a-net-api-to-azure-84ea79d42d1a?source=collection_archive---------17-----------------------#2020-03-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4a8a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建一个 SQL 数据库，并在云中提供您的 API！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/92efdcf7ed619b043657d41854fda939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_unUdjxsq89YNdRTf-Xfyg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@rollnik?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">罗尔尼克</a>在<a class="ae ky" href="https://unsplash.com/s/photos/cloud?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="9d6c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="80f2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">本文是致力于为英雄视角之旅教程构建. NET API 的系列文章的第四篇。</p><p id="e005" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">到目前为止，我们已经:</p><ol class=""><li id="06ca" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/net-core-api-for-the-angular-tour-of-heroes-app-5895a36d2129">设置我们的环境。</a></li><li id="dd4e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/build-a-mssql-docker-container-800166ecca21">构建了一个 MSSQL Docker 容器数据库</a>用于本地开发。</li><li id="dcf2" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/net-core-api-dive-into-c-27dcd4170066">为英雄角游 app 写了一个. NET API </a>。</li></ol><p id="6695" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以使用 Angular 应用程序的本地开发版本。NET API，以及一个来自于<a class="ae ky" href="https://github.com/rchardptrsn/TourOfHeroes-dotNETCore" rel="noopener ugc nofollow" target="_blank"> my GitHub repo </a>的<a class="ae ky" href="https://github.com/rchardptrsn/MSSQL-Docker-Container" rel="noopener ugc nofollow" target="_blank"> Docker MSSQL </a>数据库，或者按照本系列的前一篇文章自己构建。</p><p id="141b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，让我们部署我们的。NET API 到 Azure！我必须感谢<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/app-service/containers/quickstart-dotnetcore" rel="noopener ugc nofollow" target="_blank">这个棒极了的微软教程</a>，它详细介绍了这个过程。</p><h1 id="881d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">文章大纲</h1><ol class=""><li id="a308" class="ms mt it lt b lu lv lx ly ma ng me nh mi ni mm mx my mz na bi translated">设置环境</li><li id="7f13" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">创建 Azure SQL server</li><li id="5d36" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">展开。NET API 到 Azure</li></ol><h1 id="18c8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设置您的环境</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/4031a8c43b9a80bfcd25cf14b6563912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oxVosTLouvCADf3276e9Gw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@cassiesmart19?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卡西·斯马特</a>在<a class="ae ky" href="https://unsplash.com/s/photos/sahara?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="9a5d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你需要两个关键的软件:</p><ol class=""><li id="3439" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><a class="ae ky" href="https://docs.microsoft.com/bs-latn-ba/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure 命令行界面</a></li><li id="8e3c" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><a class="ae ky" href="https://dotnet.microsoft.com/download/dotnet-core" rel="noopener ugc nofollow" target="_blank">。NET Core </a> —我用的是 3.0.2 版本</li></ol><p id="e6b5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当这些都被安装后，把本地版本的。我的 GitHub repo 中的. NET API。从命令行导航到<code class="fe nk nl nm nn b">Heroes.API</code>目录并运行。NET 核心程序通过运行<code class="fe nk nl nm nn b">dotnet run</code>。一旦你确认它在你的系统上运行，停止程序。</p><h2 id="33f5" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">初始化 git 储存库</h2><p id="c55e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">因为你从 GitHub 下载了这个项目，它带有一个. git 隐藏文件夹，我们需要删除它。从<code class="fe nk nl nm nn b">Heroes.API</code>向上一层，这样你就可以看到组成整个应用程序的所有 3 个文件夹。显示隐藏的文件夹<code class="fe nk nl nm nn b">.git</code>文件夹，并从 linux 或 mac 系统中删除或运行<code class="fe nk nl nm nn b">sudo rm -r .git</code>。</p><p id="92fb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，导航回英雄。API 目录。运行<code class="fe nk nl nm nn b">ls</code>以确保您看到所有预期的文件夹。</p><p id="c6d7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们需要初始化一个新的 git 存储库，并将它推送到 Azure 远程存储库。从<code class="fe nk nl nm nn b">Heroes.API</code>目录运行:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="753f" class="no la it nn b gy oe of l og oh">git init <br/>git add . <br/>git commit -m "first commit"</span></pre><h1 id="2859" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">创建 Azure SQL 数据库</h1><p id="b880" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">通过运行<code class="fe nk nl nm nn b">az login</code>登录到 Azure CLI。</p><p id="f199" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用<a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> az group </a>命令创建一个名为<code class="fe nk nl nm nn b">HeroesAPIgroup</code>的资源组来存放您的资源。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="c204" class="no la it nn b gy oe of l og oh">az group create --name HeroesAPIgroup --location eastus</span></pre><p id="38ef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过运行以下命令，在您的资源组名称<code class="fe nk nl nm nn b">heroesSQLdb</code>中创建一个 SQL server</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="b5c3" class="no la it nn b gy oe of l og oh">az sql server create \<br/>--name heroapisqlserver \<br/>--resource-group HeroesAPIgroup \<br/>--location eastus \<br/>--admin-user sqlAdmin \<br/>--admin-password Mystrongpassw0rd</span></pre><p id="57e4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">完成后，您将获得部署细节的 JSON 输出。</p><p id="fef3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过运行以下命令为您的服务器配置防火墙:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="a965" class="no la it nn b gy oe of l og oh">az sql server firewall-rule create \<br/>--resource-group HeroesAPIgroup \<br/>--server heroapisqlserver  \<br/>--name AllowAllIps \<br/>--start-ip-address 0.0.0.0 \<br/>--end-ip-address 0.0.0.0</span></pre><p id="07ee" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在新创建的 SQL server 上创建一个<code class="fe nk nl nm nn b">heroes</code>数据库。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="d14f" class="no la it nn b gy oe of l og oh">az sql db create \<br/>--resource-group HeroesAPIgroup \<br/>--server heroapisqlserver   \<br/>--name heroes \<br/>--service-objective S0</span></pre><p id="b87d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要向您的<code class="fe nk nl nm nn b">heroes</code>数据库添加一个表，我们需要登录 Azure 门户，找到您的<strong class="lt iu"> HeroesAPIgroup </strong>资源组，然后点击您的<strong class="lt iu"> heroes </strong> SQL 数据库。</p><p id="5ab8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">转到查询编辑器，尝试使用创建 SQL server 时的用户名和密码输入您的 SQL 数据库。它应该会失败，因为根据您的防火墙规则，您的本地 IP 地址没有被授予访问服务器的权限。</p><p id="ff0b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">返回到您的<code class="fe nk nl nm nn b">heroes</code>数据库概述。点击<strong class="lt iu">设置服务器防火墙</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/8485ab2ffcdc7d9fb6efe25847cd982a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e8Zt3vBmOkIKc4SQNGzDhA.png"/></div></div></figure><p id="1e81" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从防火墙设置中，单击添加客户端 IP。现在，您应该能够从您的家庭或办公室 IP 地址位置访问 SQL server。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/4fa523fbabd886abb1a4fc8d531969f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K4IM7YcCxiwKT-SsqXTLuw.png"/></div></div></figure><p id="d081" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，使用查询编辑器中的用户名和密码进入 SQL 数据库。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/e68f53c671ff0af882955ad1e6eff45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CRn2SSls8rbSsBqfCfHrKA.png"/></div></div></figure><p id="522b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">登录到 SQL Server 后，运行下面的查询来添加一个表，并将示例数据插入到数据库中。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="4b39" class="no la it nn b gy oe of l og oh">CREATE TABLE HeroValue( id int, name VARCHAR(50) );<br/>INSERT INTO HeroValue (id, name)<br/>VALUES <br/>(1, 'Wonder Woman'), <br/>(2, 'Spiderman'), <br/>(3, 'Black Widow'), <br/>(4, 'Batman'), <br/>(5, 'Captain Marvel');</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/b5e8af80509a77e4f37435b9c03549a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sUqoTDWX6qcWz514pLe0wQ.png"/></div></div></figure><p id="3b2c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们有数据库！让我们复制出连接字符串以备后用。从 Overview 中，单击连接字符串，并复制。提供了网络连接字符串。我的看起来像这样:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="ea0a" class="no la it nn b gy oe of l og oh">Server=tcp:heroapisqlserver.database.windows.net,1433;Initial Catalog=heroes;Persist Security Info=False;User ID=sqlAdmin;Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</span></pre><p id="9a60" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">用您为管理员选择的密码替换<code class="fe nk nl nm nn b">{your_password}</code>。</p><p id="86e3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们不会将这个连接字符串插入到我们的应用程序中。一旦我们部署了应用程序，我们将使用<code class="fe nk nl nm nn b">az webapp config</code>为应用程序配置一个连接，这将优先于<code class="fe nk nl nm nn b">appsettings.json</code>中的连接字符串。我们将在创建 web 应用程序后创建这个应用程序级的连接字符串，所以请记住这个连接字符串。</p><p id="fab3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们部署该应用程序吧！</p><h1 id="4f33" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">展开。NET API 到 Azure</h1><p id="05fb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将需要配置一个<em class="om">部署用户</em>，授权他将 git 存储库推送到 Azure。立即创建用户:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="87ed" class="no la it nn b gy oe of l og oh">az webapp deployment user set \<br/>--user-name DeploymentUser420 \<br/>--password DeploymentPassw0rd!</span></pre><p id="efa2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果成功，您将获得 JSON 输出。如果你得到错误，<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-dotnetcore-sqldb" rel="noopener ugc nofollow" target="_blank">Azure 文档</a>说:如果你得到一个<code class="fe nk nl nm nn b">'Conflict'. Details: 409</code>错误，改变用户名。如果你得到一个<code class="fe nk nl nm nn b">'Bad Request'. Details: 400</code>错误，使用一个更强的密码。</p><h2 id="58b1" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">创建应用服务计划</h2><p id="7e59" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">应用服务计划将决定为运行应用而创建的虚拟机的大小。我们将使用应用服务计划的免费 linux 层。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="a653" class="no la it nn b gy oe of l og oh">az appservice plan create \<br/>--name HeroesAPIserviceplan \<br/>--resource-group HeroesAPIgroup \<br/>--is-linux \<br/>--sku FREE</span></pre><h2 id="22e4" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">创建 web 应用程序</h2><p id="dfcd" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">创建一个符合应用服务计划条款的 web 应用。</p><p id="53e1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首先，我们需要检查哪些运行时可用。运行:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="80c2" class="no la it nn b gy oe of l og oh">az webapp list-runtimes --linux</span></pre><p id="abe6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">选择适合您代码的<code class="fe nk nl nm nn b">DOTNET|</code>运行时。我们要用<code class="fe nk nl nm nn b">“DOTNETCORE|3.0”</code>。使用<a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/webapp?view=azure-cli-latest#az-webapp-create" rel="noopener ugc nofollow" target="_blank"> az webapp create </a>命令创建 web 应用。我强烈推荐在这个多功能的命令上阅读 Azure 文档。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="f9b4" class="no la it nn b gy oe of l og oh">az webapp create \<br/>--resource-group HeroesAPIgroup \<br/>--plan HeroesAPIserviceplan \<br/>--name heroes-api \<br/>--runtime "DOTNETCORE|3.0" \<br/>--deployment-local-git</span></pre><p id="e8f5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建应用程序后，首先看到的是 git remote 的 URL。保存这个非常重要！我们将需要这个 URL 来将您的本地 git 存储库推送到 Azure。</p><p id="c1bb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我的 git 回购 URL。(不要担心在发布文章之前这个项目会被删除)。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="7b4a" class="no la it nn b gy oe of l og oh">Local git is configured with url of '<a class="ae ky" href="https://DeploymentUser420@heroes-api.scm.azurewebsites.net/heroes-api.git'" rel="noopener ugc nofollow" target="_blank">https://DeploymentUser420@heroes-api.scm.azurewebsites.net/heroes-api.git'</a></span></pre><h2 id="9deb" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">配置连接字符串</h2><p id="48fe" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">还记得设置 SQL server 后保存的连接字符串吗？我们现在将使用它在应用程序级别设置一个连接字符串。这将优先于指向本地 docker mssql 数据库的当前连接字符串。不要忘记将<code class="fe nk nl nm nn b">{your_strong_password}</code>替换为您的管理员密码。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="ad41" class="no la it nn b gy oe of l og oh">az webapp config connection-string set \<br/>--resource-group HeroesAPIgroup \<br/>--name heroes-api \<br/>--settings MyDbConnection="Server=tcp:heroapisqlserver.database.windows.net,1433;Initial Catalog=heroes;Persist Security Info=False;User ID=sqlAdmin;Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;" \<br/>--connection-string-type SQLServer</span></pre><h2 id="015a" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">为数据库使用设置环境变量</h2><p id="7b19" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们需要设置一个环境变量。NET API 知道在生产环境中连接到 Azure SQL 数据库，而不是用于开发的本地 docker 数据库。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="d492" class="no la it nn b gy oe of l og oh">az webapp config appsettings set \<br/>--name heroes-api \<br/>--resource-group HeroesAPIgroup \<br/>--settings ASPNETCORE_ENVIRONMENT="Production"</span></pre><p id="93ad" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，我们需要在。NET API 来读取环境变量，并相应地选择 Azure 数据库或 Docker 数据库。</p><p id="6e34" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">修改<code class="fe nk nl nm nn b">Startup.cs</code>中的<strong class="lt iu"> ConfigureServices </strong>以首先查找环境变量<code class="fe nk nl nm nn b">ASPNETCORE_ENVIRONMENT</code>，如果没有该变量，则选择本地 Docker 数据库。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="e1bb" class="no la it nn b gy oe of l og oh">// Use SQL Database if in Azure, otherwise, use SQLite<br/>if(Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Production")<br/>    services.AddDbContext&lt;HeroesContext&gt;(options =&gt;<br/>        options.UseSqlServer(<br/>            Configuration.GetConnectionString("MyDbConnection")));<br/>else<br/>    services.AddDbContext&lt;HeroesContext&gt;(options =&gt;<br/>        options.UseSqlServer(<br/>            Configuration.GetConnectionString("DockerDB")));</span></pre><p id="61f0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">保存您的更改，不要忘记提交 git repo。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="d1cc" class="no la it nn b gy oe of l og oh">git add .<br/>git commit -m "connect to SQLDB in Azure"</span></pre><h2 id="4972" class="no la it bd lb np nq dn lf nr ns dp lj ma nt nu ll me nv nw ln mi nx ny lp nz bi translated">从本地 git repo 推送到 Azure</h2><p id="3687" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您的应用程序已准备好进行生产部署。让我们将 git 存储库推送到远程 Azure 存储库，我们的 web 应用程序正在寻找该存储库来提供代码。添加创建 web 应用程序后保存的 git repo URL。</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="d5ae" class="no la it nn b gy oe of l og oh">git remote add azure &lt;deploymentLocalGitUrl-from-create-step&gt;</span></pre><p id="4305" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">将您的 git repo 推送到 Azure remote repo 来部署您的应用程序。当您运行以下命令时，它会要求您提供凭据。<strong class="lt iu">输入我们创建的部署用户的密码，而不是您的 Azure 登录名！</strong></p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="d10c" class="no la it nn b gy oe of l og oh">git push azure master</span></pre><p id="42ae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你做到了！您部署了您的应用程序！现在让我们来测试一下。浏览 heroes-api 应用服务概述，并复制 API URL 端点。它应该是这样的:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="0d7e" class="no la it nn b gy oe of l og oh">https://heroes-api.azurewebsites.net</span></pre><h1 id="7cb0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">测试来自 Postman 的 API</h1><p id="1d4d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">向<code class="fe nk nl nm nn b"><a class="ae ky" href="https://heroes-api.azurewebsites.net/api/Heroes" rel="noopener ugc nofollow" target="_blank">https://heroes-api.azurewebsites.net/api/Heroes</a></code>发送一个<strong class="lt iu"> GET </strong>请求，观察所有预装英雄的 JSON 输出！成功！</p><h1 id="868d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">来自英雄角游 App 的测试</h1><p id="ddc3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">打开<a class="ae ky" href="https://medium.com/swlh/deploy-an-angular-app-to-azure-955f0c750686?source=friends_link&amp;sk=170255924d9bc3f99a9e5ab13878a4ba" rel="noopener">英雄之旅 app </a>进入<code class="fe nk nl nm nn b">src/app/hero.service.ts</code>。</p><p id="b70a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在 HeroService 类下，注释掉本地的 URL。NET API，并用 Azure 的 API URL 端点替换 localhost:5000。您的连接字符串将如下所示:</p><p id="3a1d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nk nl nm nn b"><em class="om">private</em> heroesUrl = ‘https://heroes-api.azurewebsites.net/api/Heroes';</code></p><p id="ca0e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过运行以下命令启动 angular 应用程序:</p><pre class="kj kk kl km gt oa nn ob oc aw od bi"><span id="c9d8" class="no la it nn b gy oe of l og oh">ng serve --open</span></pre><p id="a87a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你做到了！你有一个前端，后端和一个数据库！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/fa088a523fce9efd86e77255ff722d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*acyOEJBcpN55g0jueAGrSQ.png"/></div></div></figure><h1 id="3380" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">将您的 Angular 应用程序部署到 Azure</h1><p id="c531" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要将你的 Angular app 部署到 Azure，可以跳转到<a class="ae ky" href="https://medium.com/swlh/deploy-an-angular-app-to-azure-955f0c750686" rel="noopener">我的文章！</a></p><p id="b9e6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">确保您记得在 HeroService 中交换连接字符串。</p><p id="9810" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">谢谢你读到这里！我希望这篇文章能让你轻松部署到 Azure，如果你需要更多的解释，<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-dotnetcore-sqldb" rel="noopener ugc nofollow" target="_blank">这篇 Azure 教程</a>真的很详细！</p></div></div>    
</body>
</html>