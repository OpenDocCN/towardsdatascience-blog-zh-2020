<html>
<head>
<title>Causal Impact R Package in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中的因果影响 R 包</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/causal-impact-r-package-in-python-bc005f63f4c2?source=collection_archive---------20-----------------------#2020-08-28">https://towardsdatascience.com/causal-impact-r-package-in-python-bc005f63f4c2?source=collection_archive---------20-----------------------#2020-08-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="f4e4" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">因果关系</h2><div class=""/><div class=""><h2 id="5654" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何在您的 Python 环境中运行 Google 的 CausalImpact R 包</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/c3dfac5782d25e231e1737505749d6ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zD1lJcoib1Sf_mXHSWbPJQ.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">斯蒂芬·菲利普斯-Hostreviews.co.uk 在 Unsplash<a class="ae lh" href="https://unsplash.com/s/photos/google?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">拍摄的照片</a></p></figure><p id="f087" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">CausalImpact 是 Google 开发的一个 R 包，用于使用贝叶斯结构时间序列模型进行因果推断。这里可以找到 R 版<a class="ae lh" href="http://google.github.io/CausalImpact/CausalImpact.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="228d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">简而言之，这个软件包所做的是做出反事实的预测。换句话说，如果干预从未发生，在平行宇宙中会发生什么？这里有一个直接来自谷歌网站的快速示例:“给定一个响应时间序列(例如，点击量)和一组控制时间序列(例如，在未受影响的市场上的点击量或在其他网站上的点击量)，该软件包构建了一个贝叶斯结构时间序列模型。然后，该模型被用于尝试和预测反事实，即，如果干预从未发生，那么干预后的反应指标将如何演变。”</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi me"><img src="../Images/de4fb47d6e4bcf394f98ff72e0e1e097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x83yUeaDf63Ci_kw"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">因果影响 1.2.1，Brodersen 等人，《应用统计学年鉴》(2015)。<a class="ae lh" href="http://google.github.io/CausalImpact/" rel="noopener ugc nofollow" target="_blank">http://google.github.io/CausalImpact/</a></p></figure><p id="9595" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">图像描述:图像(原始)的 A 部分用连续的黑线显示了我们正在监控的事物的时间序列。蓝色虚线部分是反事实预测。垂直灰线是进行干预的时刻。我们可以观察到，从那时起，蓝线和黑线逐渐分开。B 部分(逐点)说明了这些线随时间的差异，这实质上是我们感兴趣的因果效应，而 C 部分(累积)是随时间的累积差异。</p><p id="d948" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我知道您可以使用 R，但是对于 Python 爱好者来说，我不知道有什么等价的包。当然，有一些库实现了原始论文的一部分。通过检查一些 Python 实现，我注意到了结果的不同。长话短说，在这里您可以查看如何从 python 运行这个包。类似地，这种方法可以推广到任何 R 包。</p><p id="3071" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对我有用的是创建一个新的 Conda 环境，预装了 Python 库和 core R 包。这里有一个例子:<code class="fe mf mg mh mi b">conda create -n r_env numpy pandas statsmodels r-essentials r-base</code></p><p id="e428" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">创造环境需要一些时间。另外，请注意，Jupyter notebook 需要进一步配置，所以我倾向于在任何编程编辑器中编辑代码，并从命令行运行。</p><p id="42ee" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们还需要的是为我们做所有工作的<code class="fe mf mg mh mi b">rpy2</code>。它是 R 语言的 python 接口。<code class="fe mf mg mh mi b">pip install rpy2</code>就行。</p><p id="b904" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如下加载所有库:</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="81d5" class="mn mo it mi b gy mp mq l mr ms"><strong class="mi jd">#rpy2 lib</strong><br/>from rpy2.robjects.packages import importr<br/>import rpy2.robjects as robjects<br/>from rpy2.robjects import pandas2ri<br/>from rpy2.robjects import Formula<br/>import rpy2.robjects.packages as rpackages<br/>import rpy2.robjects.vectors as StrVector<br/>from rpy2.ipython.ggplot import image_png</span><span id="a694" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#typical python libs</strong><br/>import numpy as np<br/>import pandas as pd<br/>import datetime</span><span id="7f19" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#arma</strong><br/>from statsmodels.tsa.arima_process import ArmaProcess</span></pre><p id="4cab" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">创建一个至少有 3 列的 Pandas dataframe，1 列用于<code class="fe mf mg mh mi b">datetime</code>(下面我们将使其成为一个索引)，一个预测值<code class="fe mf mg mh mi b">x1</code>或更多(<code class="fe mf mg mh mi b">x2,x3,x4,…,xn</code>)和一个响应变量<code class="fe mf mg mh mi b">y</code>。这假定您已经准备好数据供使用，否则，您可以如下创建一些数据:</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="ccf3" class="mn mo it mi b gy mp mq l mr ms"><strong class="mi jd"># Creating synthetic data - skip this if you are running it on your # own data - The data generation is taken from #</strong><a class="ae lh" href="https://github.com/dafiti/causalimpact" rel="noopener ugc nofollow" target="_blank"><strong class="mi jd">https://github.com/dafiti/causalimpact</strong></a></span><span id="44b4" class="mn mo it mi b gy mt mq l mr ms">ar = np.array([1, 0.9])<br/>ma = np.array([1])<br/>arma_process = ArmaProcess(ar, ma)<br/>X = 100 + arma_process.generate_sample(nsample=100)<br/>y = 1.2 * X + np.random.normal(size=100)<br/>y[70:] += 5</span><span id="697d" class="mn mo it mi b gy mt mq l mr ms">base = datetime.datetime.today()<br/>dt = [base - datetime.timedelta(days=x) for x in range(100)]</span><span id="30b0" class="mn mo it mi b gy mt mq l mr ms">df = pd.DataFrame({'y': y, 'x1': X,'date':dt}, columns=['y', 'x1','date'])</span></pre><p id="9581" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如上所述，确保将<code class="fe mf mg mh mi b">datetime</code>作为索引。</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="9f31" class="mn mo it mi b gy mp mq l mr ms"><strong class="mi jd">#make datetime an index to the df</strong><br/>df.set_index('date',inplace=True)</span></pre><p id="9eea" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">根据<code class="fe mf mg mh mi b">dataframe</code>中的索引<code class="fe mf mg mh mi b">datetime</code>定义干预前的时间段和干预后的时间段。</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="9982" class="mn mo it mi b gy mp mq l mr ms"><strong class="mi jd">#Set pre and post intervention periods</strong><br/>pre_period = [0, 69]<br/>post_period = [70, 99]</span><span id="215a" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#R conversion</strong><br/>pre_period=robjects.FloatVector(pre_period)<br/>post_period=robjects.FloatVector(post_period)</span></pre><p id="b4e3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这将为您提供从周期开始到干预(pre_period)和从干预到数据中最后一天(post_period)之间的时间间隔。</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="b94a" class="mn mo it mi b gy mp mq l mr ms"><strong class="mi jd">#Load R libraries from within Python - R interface<br/></strong>utils=rpackages.importr('utils')<br/>utils.chooseCRANmirror(ind=1)<br/>packnames=('CausalImpact','bsts') # any other R library required<br/>names_to_install = [x for x in packnames if not rpackages.isinstalled(x)]</span><span id="7bc7" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#Load package required to install R packages</strong><br/>from rpy2.robjects.vectors import StrVector</span><span id="35df" class="mn mo it mi b gy mt mq l mr ms">if len(names_to_install) &gt; 0:<br/>    utils.install_packages(StrVector(names_to_install))</span></pre><p id="728c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这可能需要一些时间；喝点咖啡，再来点。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><p id="5472" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是现在我们在这里。准备对我们的数据进行因果推断。</p><pre class="ks kt ku kv gt mj mi mk ml aw mm bi"><span id="527e" class="mn mo it mi b gy mp mq l mr ms">robjects.numpy2ri.activate()<br/>pandas2ri.activate()<br/>rdf=robjects.conversion.py2rpy(df)<br/>causalimpact=importr('CausalImpact')<br/>impact=causalimpact.CausalImpact(rdf,pre_period,post_period)</span><span id="f728" class="mn mo it mi b gy mt mq l mr ms">summary_func=robjects.r('function(x) summary(x)')<br/>summary_func(impact)</span><span id="f05b" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#Summary with descriptive report</strong><br/>summary_report_func=robjects.r('function(x) summary(x,"report")')<br/>summary_report_func(impact)</span><span id="def6" class="mn mo it mi b gy mt mq l mr ms"><strong class="mi jd">#Create causality plot</strong><br/>img_file='causalimpact.png'<br/>rstr="""<br/>library(ggplot2)<br/>function(x,y){<br/>p&lt;-plot(x)<br/>ggsave(y,plot=p)<br/>}</span><span id="e133" class="mn mo it mi b gy mt mq l mr ms">"""</span><span id="d3df" class="mn mo it mi b gy mt mq l mr ms">rfunc=robjects.r(rstr)<br/>rfunc(impact,img_file)</span></pre><p id="160d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">有关因果影响包的更多选项和讨论，请参见以下内容:</p><div class="nb nc gp gr nd ne"><a href="https://stats.stackexchange.com/search?q=causalimpact" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd jd gy z fp nj fr fs nk fu fw jc bi translated">包含“因果影响”的帖子</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">搜索类型搜索语法标签[tag]确切的“单词在此”作者用户:1234 用户:我(你的)得分得分:3 (3+)得分:0…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">stats.stackexchange.com</p></div></div><div class="nn l"><div class="no l np nq nr nn ns lb ne"/></div></div></a></div><div class="nb nc gp gr nd ne"><a href="http://google.github.io/CausalImpact/CausalImpact.html" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd jd gy z fp nj fr fs nk fu fw jc bi translated">因果影响</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">这个包是做什么的？这个 R 包实现了一种方法来估计因果效应的设计…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">google.github.io</p></div></div></div></a></div><p id="dbf5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nt">喜欢这篇文章吗？成为</em> <a class="ae lh" href="https://azenresearchlabs.medium.com/membership" rel="noopener"> <em class="nt">中等会员</em> </a> <em class="nt">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p></div></div>    
</body>
</html>