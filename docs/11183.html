<html>
<head>
<title>Get a Fully Configured Apache Airflow Docker Dev Stack with Bitnami</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Bitnami 获得完全配置的 Apache Airflow Docker 开发堆栈</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/get-a-fully-configured-apache-airflow-docker-dev-stack-with-bitnami-ed1671d63ea0?source=collection_archive---------48-----------------------#2020-08-03">https://towardsdatascience.com/get-a-fully-configured-apache-airflow-docker-dev-stack-with-bitnami-ed1671d63ea0?source=collection_archive---------48-----------------------#2020-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f94b63f6041508c71dbc7d541cf1172f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gR3JFYCpIj_OiNpR.jpg"/></div></div></figure><p id="014e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经使用它大约两年了，来构建定制的工作流界面，如用于实验室信息管理系统(LIMs)、计算机视觉预处理和后处理管道的界面，以及设置和忘记其他基因组学管道。</p><p id="a2fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我最喜欢的气流特征是，它对你正在做的工作或工作发生的地点完全不可知。它可以发生在本地、Docker 映像上、Kubernetes 上、任意数量的 AWS 服务上、HPC 系统上等等。使用 Airflow 可以让我专注于我试图完成的业务逻辑，而不会在实现细节上陷入太多。</p><p id="98f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在那段时间里，我采用了一套系统，通过 Docker 和 Docker Compose 快速构建主开发堆栈，使用了<a class="ae kw" href="https://github.com/bitnami/bitnami-docker-airflow" rel="noopener ugc nofollow" target="_blank">Bitnami Apache air flow stack</a>。一般来说，我要么使用相同的 Docker compose 堆栈(如果它是一个足够小的独立实例)将堆栈部署到生产环境中，要么在我需要与其他服务或文件系统交互时使用 Kubernetes。</p><h1 id="56a2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">比特纳米 vs 滚自己的</h1><p id="7017" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我曾经用康达卷自己的气流容器。我仍然对我的大多数其他容器使用这种方法，包括与我的气流系统交互的微服务，但是配置气流不仅仅是安装包。此外，即使只是安装这些软件包也是一件痛苦的事情，我很少能指望一个没有痛苦的重建工作。然后，在包的顶部，您需要配置数据库连接和消息队列。</p><p id="9d03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在来了<a class="ae kw" href="https://github.com/bitnami/bitnami-docker-airflow" rel="noopener ugc nofollow" target="_blank"> Bitnami 阿帕奇气流 docker 组成栈</a>为开发和<a class="ae kw" href="https://bitnami.com/stack/apache-airflow/helm" rel="noopener ugc nofollow" target="_blank"> Bitnami 阿帕奇气流舵图</a>为生产！</p><p id="3123" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用他们自己的话说:</p><blockquote class="ma mb mc"><p id="2df1" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated"><em class="iq"> Bitnami 使您可以轻松地在任何平台上安装和运行您最喜爱的开源软件，包括您的笔记本电脑、Kubernetes 和所有主要的云。除了流行的社区产品之外，现已成为 VMware 一部分的 Bitnami 还为 IT 组织提供了一种安全、合规、持续维护且可根据组织策略进行定制的企业产品。</em><a class="ae kw" href="https://bitnami.com/" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://bitnami.com/</em></a></p></blockquote><p id="21a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Bitnami 堆栈(通常)从 Docker 构建堆栈到舵图的工作方式完全相同。这意味着我可以使用我的 compose 栈进行本地测试和开发，构建新的映像、版本、包等，然后部署到 Kubernetes。配置、环境变量和其他一切都是一样的。从头开始做这一切将是一项相当大的任务，所以我使用 Bitnami。</p><p id="bcfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">他们有大量的企业产品，但这里包含的所有东西都是开源的，不涉及付费墙。</p><p id="3666" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不，我不属于 Bitnami，虽然我的孩子吃得很多，对出卖没有任何特别的道德厌恶。；-)我刚刚发现他们的产品非常棒。</p><h1 id="721c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目结构</h1><p id="f65f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我喜欢把我的项目组织起来，这样我就可以运行<code class="fe mh mi mj mk b">tree</code>并且对正在发生的事情有一个大概的了解。</p><p id="dcd4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Apache Airflow 有 3 个主要组件，应用程序、工作程序和调度程序。每个都有自己的 Docker 映像来区分服务。此外，还有一个数据库和一个消息队列，但是我们不会对它们进行任何定制。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="1389" class="mt ky iq mk b gy mu mv l mw mx">.<br/>└── docker<br/>    └── bitnami-apache-airflow-1.10.10<br/>        ├── airflow<br/>        │   └── Dockerfile<br/>        ├── airflow-scheduler<br/>        │   └── Dockerfile<br/>        ├── airflow-worker<br/>        │   └── Dockerfile<br/>        ├── dags<br/>        │   └── tutorial.py<br/>        ├── docker-compose.yml</span></pre><p id="9ace" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我们这里有一个名为<code class="fe mh mi mj mk b">bitnami-apache-airflow-1.10.10</code>的目录。这就引出了非常重要的一点！钉住你的版本！它会让你省去那么多的痛苦和挫折！</p><p id="c6b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么我们有一个 docker 文件每个气流件。</p><p id="1b31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下内容创建此目录结构:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="fb93" class="mt ky iq mk b gy mu mv l mw mx">mkdir -p docker/bitnami-apache-airflow-1.10.10/{airflow,airflow-scheduler,airflow-worker,dags}</span></pre><h1 id="ca6c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Docker 撰写文件</h1><p id="f62e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这是我对<code class="fe mh mi mj mk b">docker-compose.yml</code>文件的偏好。我根据自己的喜好做了一些更改，主要是我<em class="md">固定版本</em>，构建我自己的 docker 映像，我为<code class="fe mh mi mj mk b">dags</code>、<code class="fe mh mi mj mk b">plugins</code>和<code class="fe mh mi mj mk b">database backups</code>安装了卷，并添加了 Docker 插槽，这样我就可以在我的堆栈中运行<code class="fe mh mi mj mk b">DockerOperators</code>。</p><p id="a64f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你随时可以去抢原文<code class="fe mh mi mj mk b">docker-compose</code> <a class="ae kw" href="https://github.com/bitnami/bitnami-docker-airflow/blob/master/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="6818" class="mt ky iq mk b gy mu mv l mw mx">version: '2'<br/><br/>services:<br/>  postgresql:<br/>    image: 'docker.io/bitnami/postgresql:10-debian-10'<br/>    volumes:<br/>      - 'postgresql_data:/bitnami/postgresql'<br/>    environment:<br/>      - POSTGRESQL_DATABASE=bitnami_airflow<br/>      - POSTGRESQL_USERNAME=bn_airflow<br/>      - POSTGRESQL_PASSWORD=bitnami1<br/>      - ALLOW_EMPTY_PASSWORD=yes<br/>  redis:<br/>    image: docker.io/bitnami/redis:5.0-debian-10<br/>    volumes:<br/>      - 'redis_data:/bitnami'<br/>    environment:<br/>      - ALLOW_EMPTY_PASSWORD=yes<br/>  airflow-scheduler:<br/>#    image: docker.io/bitnami/airflow-scheduler:1-debian-10<br/>    build:<br/>      context: airflow-scheduler<br/>    environment:<br/>      - AIRFLOW_DATABASE_NAME=bitnami_airflow<br/>      - AIRFLOW_DATABASE_USERNAME=bn_airflow<br/>      - AIRFLOW_DATABASE_PASSWORD=bitnami1<br/>      - AIRFLOW_EXECUTOR=CeleryExecutor<br/>      # If you'd like to load the example DAGs change this to yes!<br/>      - AIRFLOW_LOAD_EXAMPLES=no<br/>      # only works with 1.10.11<br/>      #- AIRFLOW__WEBSERVER__RELOAD_ON_PLUGIN_CHANGE=true<br/>      #- AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False<br/>    volumes:<br/>      - airflow_scheduler_data:/bitnami<br/>      - ./plugins:/opt/bitnami/airflow/plugins<br/>      - ./dags:/opt/bitnami/airflow/dags<br/>      - ./db_backups:/opt/bitnami/airflow/db_backups<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>  airflow-worker:<br/>#    image: docker.io/bitnami/airflow-worker:1-debian-10<br/>    build:<br/>      context: airflow-worker<br/>    environment:<br/>      - AIRFLOW_DATABASE_NAME=bitnami_airflow<br/>      - AIRFLOW_DATABASE_USERNAME=bn_airflow<br/>      - AIRFLOW_DATABASE_PASSWORD=bitnami1<br/>      - AIRFLOW_EXECUTOR=CeleryExecutor<br/>      - AIRFLOW_LOAD_EXAMPLES=no<br/>      # only works with 1.10.11<br/>      #- AIRFLOW__WEBSERVER__RELOAD_ON_PLUGIN_CHANGE=true<br/>      #- AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False<br/>    volumes:<br/>      - airflow_worker_data:/bitnami<br/>      - ./plugins:/opt/bitnami/airflow/plugins<br/>      - ./dags:/opt/bitnami/airflow/dags<br/>      - ./db_backups:/opt/bitnami/airflow/db_backups<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>  airflow:<br/>#    image: docker.io/bitnami/airflow:1-debian-10<br/>    build:<br/>      # You can also specify the build context<br/>      # as cwd and point to a different Dockerfile<br/>      context: .<br/>      dockerfile: airflow/Dockerfile<br/>    environment:<br/>      - AIRFLOW_DATABASE_NAME=bitnami_airflow<br/>      - AIRFLOW_DATABASE_USERNAME=bn_airflow<br/>      - AIRFLOW_DATABASE_PASSWORD=bitnami1<br/>      - AIRFLOW_EXECUTOR=CeleryExecutor<br/>      - AIRFLOW_LOAD_EXAMPLES=no<br/>      # only works with 1.10.11<br/>      #- AIRFLOW__WEBSERVER__RELOAD_ON_PLUGIN_CHANGE=True<br/>      #- AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False<br/>    ports:<br/>      - '8080:8080'<br/>    volumes:<br/>      - airflow_data:/bitnami<br/>      - ./dags:/opt/bitnami/airflow/dags<br/>      - ./plugins:/opt/bitnami/airflow/plugins<br/>      - ./db_backups:/opt/bitnami/airflow/db_backups<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>volumes:<br/>  airflow_scheduler_data:<br/>    driver: local<br/>  airflow_worker_data:<br/>    driver: local<br/>  airflow_data:<br/>    driver: local<br/>  postgresql_data:<br/>    driver: local<br/>  redis_data:<br/>    driver: local</span></pre><h1 id="bed7" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">锁定您的版本</h1><p id="1027" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里用的阿帕奇气流的版本是<code class="fe mh mi mj mk b">1.10.10</code>。<code class="fe mh mi mj mk b">1.10.11</code>有一些我想加入的很酷的更新，所以我会继续关注它！</p><p id="59f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过查看主站点上的<a class="ae kw" href="https://airflow.apache.org/docs/stable/changelog.html" rel="noopener ugc nofollow" target="_blank">变更日志</a>来随时了解最新的 Apache Airflow 版本。</p><p id="0859" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在使用 Bitnami，它的机器人可以在新版本发布时自动构建和更新它们的映像。</p><p id="c7f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然这种方法对机器人来说很棒，但我不推荐<em class="md">仅仅希望最新版本能够向后兼容并与你的设置兼容。</em></p><p id="eb12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，固定一个版本，当新版本出现时，在您的开发堆栈中测试它。在写这篇文章的时候，最新的版本是<code class="fe mh mi mj mk b">1.10.11</code>，但是它不能开箱即用，所以我们使用<code class="fe mh mi mj mk b">1.10.10</code>。</p><h1 id="61f2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">比特纳米阿帕奇气流码头标签</h1><p id="0c36" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一般来说，一个 docker 标签对应一个应用版本。有时也有其他变体，如基本操作系统。在这里，我们可以只使用应用程序版本。</p><p id="c5e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://hub.docker.com/r/bitnami/airflow-scheduler/tags" rel="noopener ugc nofollow" target="_blank">Bitnami Apache air flow Scheduler 图像标签</a></p><p id="f4b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://hub.docker.com/r/bitnami/airflow-worker/tags" rel="noopener ugc nofollow" target="_blank"> Bitnami Apache 气流工人图片标签</a></p><p id="48ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://hub.docker.com/r/bitnami/airflow/tags" rel="noopener ugc nofollow" target="_blank"> Bitnami Apache Airflow 网页图片标签</a></p><h1 id="1056" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建自定义图像</h1><p id="eeb9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在我们的<code class="fe mh mi mj mk b">docker-compose</code>中，我们有占位符来构建自定义图像。</p><p id="dfc6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在只创建一个最小的 Docker 文件。稍后我将展示如何用额外的系统或 python 包定制 docker 容器。</p><h1 id="532d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">气流应用</h1><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c2a2" class="mt ky iq mk b gy mu mv l mw mx">echo "FROM docker.io/bitnami/airflow:1.10.10" &gt; docker/bitnami-apache-airflow-1.10.10/airflow/Dockerfile</span></pre><p id="69b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">会给你这个气流申请 docker 文件。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="a41a" class="mt ky iq mk b gy mu mv l mw mx">FROM docker.io/bitnami/airflow:1.10.10</span></pre><h1 id="a4aa" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">气流调度程序</h1><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="fd0b" class="mt ky iq mk b gy mu mv l mw mx">echo "FROM docker.io/bitnami/airflow-scheduler:1.10.10" &gt; docker/bitnami-apache-airflow-1.10.10/airflow-scheduler/Dockerfile</span></pre><p id="e912" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">会给你这个气流调度 docker 文件。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="5863" class="mt ky iq mk b gy mu mv l mw mx">FROM docker.io/bitnami/airflow-scheduler:1.10.10</span></pre><h1 id="1c5e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">气流工人</h1><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="405f" class="mt ky iq mk b gy mu mv l mw mx">echo "FROM docker.io/bitnami/airflow-worker:1.10.10" &gt; docker/bitnami-apache-airflow-1.10.10/airflow-worker/Dockerfile</span></pre><p id="f4ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">会给你这个气流工 docker 文件。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="8011" class="mt ky iq mk b gy mu mv l mw mx">FROM docker.io/bitnami/airflow-worker:1.10.10</span></pre><h1 id="895f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">调出堆栈</h1><p id="6b68" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">抓住上面的<code class="fe mh mi mj mk b">docker-compose</code>文件，让我们开始吧！</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c859" class="mt ky iq mk b gy mu mv l mw mx">cd docker/bitnami-apache-airflow-1.10.10 <br/>docker-compose up</span></pre><p id="af10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果这是您第一次运行该命令，这将需要一些时间。Docker 将获取它还没有的任何图像，并构建所有的 airflow-*图像。</p><h1 id="cb6b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">导航到用户界面</h1><p id="c131" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一旦一切就绪并开始运行，导航到位于<code class="fe mh mi mj mk b"><a class="ae kw" href="http://localhost:8080." rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></code> <a class="ae kw" href="http://localhost:8080." rel="noopener ugc nofollow" target="_blank">的 UI。</a></p><p id="d1e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除非您更改了配置，否则您的默认<code class="fe mh mi mj mk b">username/password</code>是<code class="fe mh mi mj mk b">user/bitnami</code>。</p><p id="8e5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录查看您的气流网络用户界面！</p><h1 id="2e5b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">添加自定义 DAG</h1><p id="92e1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里有一个我从<a class="ae kw" href="https://airflow.apache.org/docs/stable/tutorial.html" rel="noopener ugc nofollow" target="_blank">阿帕奇气流教程中抓取的 DAG。为了完整起见，我把它包括在这里。</a></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c510" class="mt ky iq mk b gy mu mv l mw mx">from datetime import timedelta<br/><br/># The DAG object; we'll need this to instantiate a DAG<br/>from airflow import DAG<br/># Operators; we need this to operate!<br/>from airflow.operators.bash_operator import BashOperator<br/>from airflow.utils.dates import days_ago<br/># These args will get passed on to each operator<br/># You can override them on a per-task basis during operator initialization<br/>default_args = {<br/>    'owner': 'airflow',<br/>    'depends_on_past': False,<br/>    'start_date': days_ago(2),<br/>    'email': ['airflow@example.com'],<br/>    'email_on_failure': False,<br/>    'email_on_retry': False,<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>    # 'queue': 'bash_queue',<br/>    # 'pool': 'backfill',<br/>    # 'priority_weight': 10,<br/>    # 'end_date': datetime(2016, 1, 1),<br/>    # 'wait_for_downstream': False,<br/>    # 'dag': dag,<br/>    # 'sla': timedelta(hours=2),<br/>    # 'execution_timeout': timedelta(seconds=300),<br/>    # 'on_failure_callback': some_function,<br/>    # 'on_success_callback': some_other_function,<br/>    # 'on_retry_callback': another_function,<br/>    # 'sla_miss_callback': yet_another_function,<br/>    # 'trigger_rule': 'all_success'<br/>}<br/>dag = DAG(<br/>    'tutorial',<br/>    default_args=default_args,<br/>    description='A simple tutorial DAG',<br/>    schedule_interval=timedelta(days=1),<br/>)<br/><br/># t1, t2 and t3 are examples of tasks created by instantiating operators<br/>t1 = BashOperator(<br/>    task_id='print_date',<br/>    bash_command='date',<br/>    dag=dag,<br/>)<br/><br/>t2 = BashOperator(<br/>    task_id='sleep',<br/>    depends_on_past=False,<br/>    bash_command='sleep 5',<br/>    retries=3,<br/>    dag=dag,<br/>)<br/>dag.doc_md = __doc__<br/><br/>t1.doc_md = """\<br/>#### Task Documentation<br/>You can document your task using the attributes `doc_md` (markdown),<br/>`doc` (plain text), `doc_rst`, `doc_json`, `doc_yaml` which gets<br/>rendered in the UI's Task Instance Details page.<br/>![img](http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png)<br/>"""<br/>templated_command = """<br/>{% for i in range(5) %}<br/>    echo "{{ ds }}"<br/>    echo "{{ macros.ds_add(ds, 7)}}"<br/>    echo "{{ params.my_param }}"<br/>{% endfor %}<br/>"""<br/><br/>t3 = BashOperator(<br/>    task_id='templated',<br/>    depends_on_past=False,<br/>    bash_command=templated_command,<br/>    params={'my_param': 'Parameter I passed in'},<br/>    dag=dag,<br/>)<br/><br/>t1 &gt;&gt; [t2, t3]</span></pre><p id="9b27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不管怎样，把这个文件放到你的<code class="fe mh mi mj mk b">code/bitnami-apache-airflow-1.10.10/dags</code>文件夹里。文件名本身并不重要。DAG 名称将是您在文件中设置的名称。</p><p id="b81d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">气流会自动重启，如果你刷新用户界面，你会看到新的<code class="fe mh mi mj mk b">tutorial</code> DAG 列表。</p><h1 id="c393" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">建立自定义气流码头集装箱</h1><p id="4054" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果你想添加额外的系统或 python 包，你可以这样做。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d4bd" class="mt ky iq mk b gy mu mv l mw mx"># code/bitnami-apache-airflow-1.10.10/airflow/Dockerfile<br/>FROM docker.io/bitnami/airflow:1.10.10<br/># From here - https://github.com/bitnami/bitnami-docker-airflow/blob/master/1/debian-10/Dockerfile<br/><br/>USER root<br/><br/>RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y vim &amp;&amp; \<br/>    rm -r /var/lib/apt/lists /var/cache/apt/archives<br/><br/>RUN bash -c "source /opt/bitnami/airflow/venv/bin/activate &amp;&amp; \<br/>    pip install flask-restful &amp;&amp; \<br/>    deactivate"</span></pre><p id="f607" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">明确地说，我不再特别赞同这种方法，除了我喜欢添加<code class="fe mh mi mj mk b">flask-restful</code>来创建定制的 REST API 插件。</p><p id="8722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我喜欢像对待 web 应用程序一样对待 Apache Airflow。我已经被<em class="md">烧了太多次</em>，所以现在我的 web 应用程序只负责路由和渲染视图，其他的什么都不管。</p><p id="60a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了它处理我的工作流的业务逻辑之外，气流几乎是一样的。如果我有一些疯狂的熊猫/tensor flow/opencv/任何我需要做的东西，我会将它们构建到一个单独的微服务中，而不会触及我的主要业务逻辑。我喜欢把气流想象成盘踞在网中的蜘蛛。</p><p id="e9ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不过，我有足够的偏执，我喜欢建立自己的图像，这样我就可以把它们推到我自己的 docker repo。</p><h1 id="a362" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">总结和从这里去哪里</h1><p id="95f9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在您已经有了基础，是时候构建您的数据科学工作流了！添加一些自定义 Dag，创建一些自定义插件，一般<em class="md">构建东西</em>。</p><p id="dafb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想要一个教程，请随时联系我，在 jillian@dabbleofdevops.com 或者在推特上。</p><h1 id="119f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">小抄</h1><p id="8574" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里是一些有希望帮助的命令和资源。</p><h1 id="505a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">登录到 Apache Airflow 实例</h1><p id="2fc4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">默认的用户名和密码是<code class="fe mh mi mj mk b">user</code>和<code class="fe mh mi mj mk b">bitnami</code>。</p><h1 id="8bbe" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Docker 编写命令</h1><p id="02a1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">建设</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="44bf" class="mt ky iq mk b gy mu mv l mw mx">cd code/bitnami-apache-airflow-1.10.10/ <br/>docker-compose build</span></pre><p id="0ea0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">拿出你的筹码！运行<code class="fe mh mi mj mk b">docker-compose up</code>会让您的所有日志出现在 STDERR/STDOUT 上。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="90b7" class="mt ky iq mk b gy mu mv l mw mx">cd code/bitnami-apache-airflow-1.10.10/ <br/>docker-compose build &amp;&amp; docker-compose up</span></pre><p id="8042" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想在后台运行，请使用<code class="fe mh mi mj mk b">-d</code>。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c970" class="mt ky iq mk b gy mu mv l mw mx">cd code/bitnami-apache-airflow-1.10.10/ <br/>docker-compose build &amp;&amp; docker-compose up -d</span></pre><h1 id="3d59" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">比特纳米阿帕奇气流配置</h1><p id="d55f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您可以使用传递到 docker-compose 文件中的环境变量来进一步定制气流实例。查看<a class="ae kw" href="https://github.com/bitnami/bitnami-docker-airflow/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>了解详情。</p><h1 id="677d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">加载 DAG 文件</h1><p id="26c0" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">定制的 DAG 文件可以挂载到<code class="fe mh mi mj mk b">/opt/bitnami/airflow/dags</code>或者在 Docker 构建阶段复制。</p><h1 id="afcb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用 Docker Compose 指定环境变量</h1><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d3d6" class="mt ky iq mk b gy mu mv l mw mx">version: '2'<br/><br/>services:<br/>  airflow:<br/>    image: bitnami/airflow:latest<br/>    environment:<br/>      - AIRFLOW_FERNET_KEY=46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=<br/>      - AIRFLOW_EXECUTOR=CeleryExecutor<br/>      - AIRFLOW_DATABASE_NAME=bitnami_airflow<br/>      - AIRFLOW_DATABASE_USERNAME=bn_airflow<br/>      - AIRFLOW_DATABASE_PASSWORD=bitnami1<br/>      - AIRFLOW_PASSWORD=bitnami123<br/>      - AIRFLOW_USERNAME=user<br/>      - AIRFLOW_EMAIL=user@example.com</span></pre><h1 id="ebe3" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">码头后清理</h1><p id="1115" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Docker 会在你的文件系统上占据很多空间。</p><p id="00d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您只想清理气流通道，那么:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c693" class="mt ky iq mk b gy mu mv l mw mx">cd code/docker/bitnami-apache-airflow-1.10.10 <br/>docker-compose stop <br/>docker-compose rm -f -v</span></pre><p id="20ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行<code class="fe mh mi mj mk b">docker-compose rm -f</code>会强制删除所有容器，<code class="fe mh mi mj mk b">-v</code>也会删除所有数据卷。</p><h1 id="59d9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">移除所有 docker 图像</h1><p id="1e1a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这将停止所有正在运行的容器并删除它们。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="e9a5" class="mt ky iq mk b gy mu mv l mw mx">docker container stop $(docker container ls -aq) <br/>docker system prune -f -a</span></pre><p id="9b43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将删除所有容器和数据卷</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="9d4f" class="mt ky iq mk b gy mu mv l mw mx">docker system prune -f -a --volumes</span></pre></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><p id="9838" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="md">最初发表于</em><a class="ae kw" href="https://www.dabbleofdevops.com/blog/get-a-fully-configured-apache-airflow-docker-dev-stack-with-bitnami" rel="noopener ugc nofollow" target="_blank"><em class="md">【https://www.dabbleofdevops.com】</em></a><em class="md">。</em></p></div></div>    
</body>
</html>