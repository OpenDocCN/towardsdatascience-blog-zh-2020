<html>
<head>
<title>A Data Scientist Approach: Running Postgres SQL using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据科学家的方法:使用 Docker 运行 Postgres SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-data-scientist-approach-running-postgres-sql-using-docker-1b978122e5e6?source=collection_archive---------17-----------------------#2020-07-04">https://towardsdatascience.com/a-data-scientist-approach-running-postgres-sql-using-docker-1b978122e5e6?source=collection_archive---------17-----------------------#2020-07-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ea95" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">面向数据科学家的 Docker 应用程序</h2><div class=""/><div class=""><h2 id="8487" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">面向数据科学家的 Postgres docker 容器</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi kr"><img src="../Images/2a1c3d20a89590f9f06ba98a185fbf06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*OYWyz60046mNK4wzFzt-wg.png"/></div></figure><p id="97fc" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇简短的教程中，我解释了设置在 Docker 中运行的 PostgreSQL 本地实例并使用 python 与数据库交互的步骤。已采取以下步骤来设置流程。</p><p id="6378" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1.为 PostgreSQL <br/> 2 设置 docker。用 Pgadmin4 <br/> 3 连接 Postgres。使用 Python 与 Postgresql 交互</p><blockquote class="lv lw lx"><p id="791a" class="kz la ly lb b lc ld kd le lf lg kg lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">我用过 Ubuntu 18.04 和 Python 3.7</p></blockquote><h2 id="6116" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt iz bi translated">Docker 中的 Postgres</h2><p id="e10a" class="pw-post-body-paragraph kz la it lb b lc mu kd le lf mv kg lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Postgres 是一个流行的开源数据库，被从网络应用到数据科学项目的数据库应用广泛使用。</p><blockquote class="lv lw lx"><p id="2835" class="kz la ly lb b lc ld kd le lf lg kg lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">Postgress 是现代数据相关应用的主干</p></blockquote><p id="dca3" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多数据库框架可供数据科学家选择。在为您的目标应用程序选择最佳框架时，需要考虑的一些因素可能是</p><ul class=""><li id="f77a" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">您的应用程序需要关系数据库吗？</li><li id="ead7" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">数据库和表计数的大小是多少？</li><li id="ce9e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">数据库将驻留在哪里？</li><li id="e91b" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">开源很重要吗？</li><li id="6a2a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">您的前端有与 DB 交互的工具吗？</li></ul><p id="fb0b" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为这里的目标受众是热爱开源的数据科学家，所以使用 Python 的 Postgres 是事实上的选择。</p><p id="aa6f" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在过去的几年中，Docker 在开发人员和数据科学家中变得非常流行。Docker 帮助数据科学家共享开发环境，以便在任何机器上重现结果。此外，扩大生产规模是码头工人使用的额外好处。</p><p id="aa79" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我用的是由【bitnami】(<a class="ae nn" href="https://bitnami.com/" rel="noopener ugc nofollow" target="_blank">https://bitnami.com/</a>)和<code class="fe no np nq nr b">docker-compose</code>开发维护的 Postgres docker。下面是我在 docker 中运行 Postgress 的内容。</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="6c54" class="mc md it nr b gy nw nx l ny nz">version: '2'</span><span id="166c" class="mc md it nr b gy oa nx l ny nz">services:<br/>  postgresql12:<br/>    image: 'bitnami/postgresql:12'<br/>    ports:<br/>      - '5432:5432'<br/>    volumes:<br/>      - 'postgresql_data_12:/bitnami/postgresql12'<br/>    environment:<br/>      - POSTGRESQL_USERNAME=postgres<br/>      - POSTGRESQL_PASSWORD=pwd0123456789<br/>      - POSTGRESQL_DATABASE=my_database<br/>      - ALLOW_EMPTY_PASSWORD=yes</span><span id="f793" class="mc md it nr b gy oa nx l ny nz">volumes:<br/>  postgresql_data_12:<br/>    driver: local</span></pre><p id="162e" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们在 python 中连接这个实例时，这些信息非常有用。按照以下步骤运行<code class="fe no np nq nr b">docker-compose</code>。</p><ol class=""><li id="bf71" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ob nf ng nh bi translated">如果之前没有安装 Docker(<a class="ae nn" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">为 Ubuntu 安装 Docker</a>)。</li><li id="2eaf" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ob nf ng nh bi translated">如果之前没有安装<code class="fe no np nq nr b">docker-compose</code>(<a class="ae nn" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank">安装 Docker-Compose for Ubuntu </a>)</li><li id="dabc" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ob nf ng nh bi translated">从<code class="fe no np nq nr b">docker-compose.yml</code>所在的目录运行<code class="fe no np nq nr b">docker-compose up</code>。</li></ol><p id="0a58" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照以上步骤操作后，可以去<a class="ae nn" href="http://localhost:5434/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5432/ </a>。</p><p id="d533" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于通过 Python 连接到 Postgres，我们使用<code class="fe no np nq nr b">docker-compose.yml.</code>中定义的信息</p><h2 id="8c9a" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt iz bi translated">连接到 Postgres</h2><p id="d696" class="pw-post-body-paragraph kz la it lb b lc mu kd le lf mv kg lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们已经通过 docker 成功剥离了 Postgress 服务器，可以通过 post 5432 的 localhost 访问。连接到 Postgres 服务器的一些最常见的方法是</p><ol class=""><li id="c8e3" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ob nf ng nh bi translated"><a class="ae nn" href="https://medium.com/better-programming/connect-from-local-machine-to-postgresql-docker-container-f785f00461a7" rel="noopener">使用 PgAdmin4 </a></li><li id="e2aa" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ob nf ng nh bi translated"><a class="ae nn" href="https://medium.com/better-programming/connect-from-local-machine-to-postgresql-docker-container-f785f00461a7" rel="noopener">使用 psql 客户端工具</a></li><li id="ea35" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ob nf ng nh bi translated">使用 Python</li></ol><p id="836f" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们的重点是使用 Python 连接 Postgres 服务器，所以我们不打算讨论 1 和 2。</p><h2 id="d233" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt iz bi translated">使用 Python 与 Postgres 交互</h2><p id="9ced" class="pw-post-body-paragraph kz la it lb b lc mu kd le lf mv kg lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在本节中，我们将学习如何使用 python 与本地运行的 Postgres 进行交互。</p><blockquote class="lv lw lx"><p id="2264" class="kz la ly lb b lc ld kd le lf lg kg lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">code snip pts Credits:<a class="ae nn" href="https://auth0.com/blog/sqlalchemy-orm-tutorial-for-python-developers/" rel="noopener ugc nofollow" target="_blank">https://auth 0 . com/blog/sqlalchemy-ORM-tutorial-for-python-developers/</a></p></blockquote><p id="f232" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照上面的链接，一行一行地详细描述下面的代码。</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="aa39" class="mc md it nr b gy nw nx l ny nz"># To install sqlalchemy<br/>! pip install sqlalchemy</span></pre><p id="9c30" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装完上面的包后，让我们连接到 Postgres 引擎。</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="6a15" class="mc md it nr b gy nw nx l ny nz">```python<br/># Import objects<br/>from sqlalchemy import create_engine<br/>from sqlalchemy.ext.declarative import declarative_base<br/>from sqlalchemy.orm import sessionmaker</span><span id="ffe8" class="mc md it nr b gy oa nx l ny nz">from datetime import date</span><span id="f178" class="mc md it nr b gy oa nx l ny nz"># Settings as shown in docker-compose.yml<br/>engine = create_engine('postgresql://postgres:pwd0123456789@localhost:5432/my_database')<br/>Session = sessionmaker(bind=engine)</span><span id="147a" class="mc md it nr b gy oa nx l ny nz">Base = declarative_base()</span><span id="5703" class="mc md it nr b gy oa nx l ny nz">from sqlalchemy import Column, String, Integer, Date, Table, ForeignKey, Boolean<br/>from sqlalchemy.orm import relationship, backref<br/># from base import Base<br/>```</span></pre><p id="3834" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一些表格</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="6ab5" class="mc md it nr b gy nw nx l ny nz">movies_actors_association = Table(<br/>    'movies_actors', Base.metadata,<br/>    Column('movie_id', Integer, ForeignKey('movies.id')),<br/>    Column('actor_id', Integer, ForeignKey('actors.id'))<br/>)</span><span id="597e" class="mc md it nr b gy oa nx l ny nz">class Movie(Base):<br/>    __tablename__ M= 'movies'</span><span id="06a2" class="mc md it nr b gy oa nx l ny nz">id = Column(Integer, primary_key=True)<br/>    title = Column(String)<br/>    release_date = Column(Date)<br/>    actors = relationship("Actor", secondary=movies_actors_association)</span><span id="6263" class="mc md it nr b gy oa nx l ny nz">def __init__(self, title, release_date):<br/>        self.title = title<br/>        self.release_date = release_date</span><span id="aae0" class="mc md it nr b gy oa nx l ny nz">class Actor(Base):<br/>    __tablename__ = 'actors'</span><span id="0bdd" class="mc md it nr b gy oa nx l ny nz">id = Column(Integer, primary_key=True)<br/>    name = Column(String)<br/>    birthday = Column(Date)</span><span id="75ca" class="mc md it nr b gy oa nx l ny nz">def __init__(self, name, birthday):<br/>        self.name = name<br/>        self.birthday = birthday</span><span id="67f9" class="mc md it nr b gy oa nx l ny nz">class Stuntman(Base):<br/>    __tablename__ = 'stuntmen'</span><span id="68e4" class="mc md it nr b gy oa nx l ny nz">id = Column(Integer, primary_key=True)<br/>    name = Column(String)<br/>    active = Column(Boolean)<br/>    actor_id = Column(Integer, ForeignKey('actors.id'))<br/>    actor = relationship("Actor", backref=backref("stuntman", uselist=False))</span><span id="9501" class="mc md it nr b gy oa nx l ny nz">def __init__(self, name, active, actor):<br/>        self.name = name<br/>        self.active = active<br/>        self.actor = actor</span><span id="b6e0" class="mc md it nr b gy oa nx l ny nz">class ContactDetails(Base):<br/>    __tablename__ = 'contact_details'</span><span id="4734" class="mc md it nr b gy oa nx l ny nz">id = Column(Integer, primary_key=True)<br/>    phone_number = Column(String)<br/>    address = Column(String)<br/>    actor_id = Column(Integer, ForeignKey('actors.id'))<br/>    actor = relationship("Actor", backref="contact_details")</span><span id="79b3" class="mc md it nr b gy oa nx l ny nz">def __init__(self, phone_number, address, actor):<br/>        self.phone_number = phone_number<br/>        self.address = address<br/>        self.actor = actor</span></pre><p id="3dcb" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照下面的代码块将数据插入到使用上面的代码片段创建的数据库中。</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="50d2" class="mc md it nr b gy nw nx l ny nz">from datetime import date</span><span id="b948" class="mc md it nr b gy oa nx l ny nz"># 2 - generate database schema<br/>Base.metadata.create_all(engine)</span><span id="bd9d" class="mc md it nr b gy oa nx l ny nz"># 3 - create a new session<br/>session = Session()</span><span id="965c" class="mc md it nr b gy oa nx l ny nz"># 4 - create movies<br/>bourne_identity = Movie("The Bourne Identity", date(2002, 10, 11))<br/>furious_7 = Movie("Furious 7", date(2015, 4, 2))<br/>pain_and_gain = Movie("Pain &amp; Gain", date(2013, 8, 23))</span><span id="b95d" class="mc md it nr b gy oa nx l ny nz"># 5 - creates actors<br/>matt_damon = Actor("Matt Damon", date(1970, 10, 8))<br/>dwayne_johnson = Actor("Dwayne Johnson", date(1972, 5, 2))<br/>mark_wahlberg = Actor("Mark Wahlberg", date(1971, 6, 5))</span><span id="56e4" class="mc md it nr b gy oa nx l ny nz"># 6 - add actors to movies<br/>bourne_identity.actors = [matt_damon]<br/>furious_7.actors = [dwayne_johnson]<br/>pain_and_gain.actors = [dwayne_johnson, mark_wahlberg]</span><span id="f18d" class="mc md it nr b gy oa nx l ny nz"># 7 - add contact details to actors<br/>matt_contact = ContactDetails("415 555 2671", "Burbank, CA", matt_damon)<br/>dwayne_contact = ContactDetails("423 555 5623", "Glendale, CA", dwayne_johnson)<br/>dwayne_contact_2 = ContactDetails("421 444 2323", "West Hollywood, CA", dwayne_johnson)<br/>mark_contact = ContactDetails("421 333 9428", "Glendale, CA", mark_wahlberg)</span><span id="e367" class="mc md it nr b gy oa nx l ny nz"># 8 - create stuntmen<br/>matt_stuntman = Stuntman("John Doe", True, matt_damon)<br/>dwayne_stuntman = Stuntman("John Roe", True, dwayne_johnson)<br/>mark_stuntman = Stuntman("Richard Roe", True, mark_wahlberg)</span><span id="1896" class="mc md it nr b gy oa nx l ny nz"># 9 - persists data<br/>session.add(bourne_identity)<br/>session.add(furious_7)<br/>session.add(pain_and_gain)</span><span id="9cfe" class="mc md it nr b gy oa nx l ny nz">session.add(matt_contact)<br/>session.add(dwayne_contact)<br/>session.add(dwayne_contact_2)<br/>session.add(mark_contact)</span><span id="88e7" class="mc md it nr b gy oa nx l ny nz">session.add(matt_stuntman)<br/>session.add(dwayne_stuntman)<br/>session.add(mark_stuntman)</span><span id="cfec" class="mc md it nr b gy oa nx l ny nz"># 10 - commit and close session<br/>session.commit()<br/>session.close()</span></pre><p id="8389" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是从 Postgres 服务器提取/读取数据的 python 代码片段。如果失去连接，请重新连接。</p><pre class="ks kt ku kv gt ns nr nt nu aw nv bi"><span id="c2cf" class="mc md it nr b gy nw nx l ny nz">movies = session.query(Movie) \<br/>    .filter(Movie.release_date &gt; date(2015, 1, 1)) \<br/>    .all()</span><span id="87ec" class="mc md it nr b gy oa nx l ny nz">print('### Recent movies:')<br/>for movie in movies:<br/>    print(f'{movie.title} was released after 2015')<br/>print('')</span><span id="d67d" class="mc md it nr b gy oa nx l ny nz"># 6 - movies that Dwayne Johnson participated<br/>the_rock_movies = session.query(Movie) \<br/>    .join(Actor, Movie.actors) \<br/>    .filter(Actor.name == 'Dwayne Johnson') \<br/>    .all()</span><span id="a2c1" class="mc md it nr b gy oa nx l ny nz">print('### Dwayne Johnson movies:')<br/>for movie in the_rock_movies:<br/>    print(f'The Rock starred in {movie.title}')<br/>print('')</span><span id="8f74" class="mc md it nr b gy oa nx l ny nz"># 7 - get actors that have house in Glendale<br/>glendale_stars = session.query(Actor) \<br/>    .join(ContactDetails) \<br/>    .filter(ContactDetails.address.ilike('%glendale%')) \<br/>    .all()</span><span id="59c4" class="mc md it nr b gy oa nx l ny nz">print('### Actors that live in Glendale:')<br/>for actor in glendale_stars:<br/>    print(f'{actor.name} has a house in Glendale')<br/>print('')</span></pre><h2 id="4eef" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt iz bi translated">结论</h2><p id="59e8" class="pw-post-body-paragraph kz la it lb b lc mu kd le lf mv kg lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这个简短的教程中，我们学习了如何使用 docker 设置一个本地 Postgres 服务器，并使用 python 与之交互。</p><p id="8bca" class="pw-post-body-paragraph kz la it lb b lc ld kd le lf lg kg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于 Postgres 运行在 docker 中，我们可以将这个 docker 部署到任何云上，只需做很少的更改。我们必须用主机的 IP 地址替换本地主机，这样一切都可以正常工作了。</p></div></div>    
</body>
</html>