<html>
<head>
<title>10 Minutes to Deploying a Deep Learning Model on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10 分钟在谷歌云平台上部署深度学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/10-minutes-to-deploying-a-deep-learning-model-on-google-cloud-platform-13fa56a266ee?source=collection_archive---------9-----------------------#2020-06-20">https://towardsdatascience.com/10-minutes-to-deploying-a-deep-learning-model-on-google-cloud-platform-13fa56a266ee?source=collection_archive---------9-----------------------#2020-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8690" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何在 GCP 部署深度学习模型，完全免费，永远免费</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/78979b3153d5d3a084458c2b4765ab28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*iLM7XiIsqbvuoxCTeWA4dQ.jpeg"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">部署一个蒲公英和草的图像分类器到网络上，通过谷歌云平台！来源:<a class="ae kr" href="https://pixabay.com/photos/dandelion-sky-flower-nature-seeds-463928/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="f663" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">所以你训练了一个令你欣喜若狂的机器学习模型，现在，你想和全世界分享它。所以你建立了一个 web 应用程序来服务这个模型，却发现你不知道如何在互联网上 24/7 托管这个 web 应用程序。<em class="lo">毕竟，如果没有人能看到你生产的 ML 模型，它真的存在吗？</em>本教程源于分享一种简单且<strong class="ku ir">免费的</strong>方法的需求，该方法使用其<em class="lo">始终免费的</em>计算服务、f1-micro 在<a class="ae kr" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">谷歌云平台上将深度学习模型部署到生产中。例如，我们将部署一个使用</a><a class="ae kr" href="https://github.com/fastai/fastai" rel="noopener ugc nofollow" target="_blank"> FastAI 深度学习库</a>构建的蒲公英和草分类器。我希望你能够在 30 分钟之内，无缝地、毫不费力地将你训练好的模型部署到世界上。</p><p id="4e3c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">要求</strong>:你只需要你现在拥有的电脑和一个谷歌账户！</p><p id="1e8a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">本教程将分为 4 个步骤:</p><ol class=""><li id="20bc" class="lp lq iq ku b kv kw ky kz lb lr lf ls lj lt ln lu lv lw lx bi translated">登录 Google Cloud 并在计算引擎上创建一个 f1-micro 实例</li><li id="074e" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">从 Github 中提取训练好的模型</li><li id="6e86" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">添加交换内存</li><li id="3a5f" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">使用 Starlette 将模型发布到 web 上</li><li id="38be" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">在 Docker 容器中构建 web 应用程序</li><li id="396c" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">运行 Docker 容器</li></ol><h1 id="297c" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">1.登录 Google Cloud 并创建 f1-micro 实例</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/5faee988617c02cc1d601834cc4c22e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*Xc1DvIz4TQqX9QouYe5OWg.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">注册谷歌云平台是免费的</p></figure><p id="d702" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果你还没有，通过你的谷歌账户注册谷歌云平台。你必须输入你的信用卡，但注册时不会收取任何费用。您还将获得价值 300 美元的免费积分，有效期为 12 个月！你将利用 GCP 的免费层，所以你不必支付遵循本教程。</p><p id="592b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">进入控制台后，转到计算引擎并创建一个实例。您需要:</p><ol class=""><li id="349d" class="lp lq iq ku b kv kw ky kz lb lr lf ls lj lt ln lu lv lw lx bi translated">将实例命名为<code class="fe mw mx my mz b">greenr</code></li><li id="ed83" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">将计算实例设置为<code class="fe mw mx my mz b">f1-micro</code></li><li id="772a" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">将操作系统设置为 Ubuntu 16.04</li><li id="9f4d" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">将硬盘内存提升至 25GB</li><li id="b68a" class="lp lq iq ku b kv ly ky lz lb ma lf mb lj mc ln lu lv lw lx bi translated">允许云访问 API 和 HTTP/HTTPS 流量</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">如何创建虚拟机实例</p></figure><p id="be34" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">当您的实例已经创建并正在运行时，通过单击屏幕右侧的 SSH 按钮进入您的实例。</p><h1 id="be2c" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">2.从 Github 中提取训练好的模型</h1><p id="6ae2" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">首先，让我们从 Github 获取已经训练过的导出模型。如果你有兴趣学习如何使用 FastAI 训练一个蒲公英和草的图像分类器，<a class="ae kr" href="https://www.kaggle.com/btphan/greenr-an-image-classifier-in-fastai?scriptVersionId=33945487" rel="noopener ugc nofollow" target="_blank">跟随 Kaggle 上的这个笔记本</a>！如果你对深度学习感兴趣，我建议你使用图书馆并学习 FastAI 课程。</p><p id="70cb" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从包含导出模型的 Github 上的<a class="ae kr" href="https://github.com/btphan95/greenr" rel="noopener ugc nofollow" target="_blank"> greenr repo 中克隆这个存储库，<code class="fe mw mx my mz b">export.pkl</code>:</a></p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="8225" class="nl me iq mz b gy nm nn l no np">git clone <a class="ae kr" href="https://github.com/btphan95/greenr-tutorial" rel="noopener ugc nofollow" target="_blank">https://github.com/btphan95/greenr-tutorial</a></span></pre><h1 id="35a7" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">3.向我们的计算实例添加交换内存</h1><p id="5f65" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">这是它变得有点 hacky。我们的<code class="fe mw mx my mz b">f1-micro</code>实例只支持高达<em class="lo"> 0.6GB </em>的 RAM，这意味着它非常脆弱，无法安装我们所需的所有深度学习库，这些库的大小超过 750MB。我们将为我们的小朋友添加交换内存，以利用其现有的硬盘空间作为 RAM 来实现这一切。幸运的是，我把所有这些都放到了一个脚本中，所以只需从我们的 greenr repo 运行<code class="fe mw mx my mz b">swap.sh</code>,向我们的机器添加 4GB 的交换内存:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="3264" class="nl me iq mz b gy nm nn l no np">cd greenr-tutorial<br/>sudo bash swap.sh</span></pre><p id="5a14" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">注意，如果您使用的是一个更强的 VM 实例，那么您就不必遵循这个步骤</p><h1 id="1e53" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">4.使用 Starlette 将模型发布到 Web 上</h1><p id="1266" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">现在，我们将使用 Starlette ASGI web 框架构建一个 Python 脚本来为我们的模型提供推理服务。为什么是斯达莱特而不是弗拉斯克？两者都是用 Python 编写的 web 框架，但是 Starlette 和 Uvicorn 比 Flask 快得多，并且在生产中更具可伸缩性。</p><p id="94e2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">使用您最喜欢的文本编辑器，将以下代码复制到 greenr-tutorial 目录下名为 app.py 的 python 脚本中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nb l"/></div></figure><p id="78e2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这将在端口 8008 上创建一个 Starlette 服务器，其中有一个用户可以上传图像并获得结果的网页(是蒲公英还是草？)</p><p id="f922" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在继续之前，我们还将添加一个名为<code class="fe mw mx my mz b">requirements.txt</code>的文件，它将允许 Docker 在构建容器时安装我们需要的所有库。并将以下文本复制到 greenr-tutorial 文件夹中的<code class="fe mw mx my mz b">requirements.txt</code>:</p><h1 id="21de" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">5.使用 Docker 容器化应用程序</h1><p id="930b" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">使用 Docker 可以让我们构建紧凑的容器化环境，只包含我们需要的库和数据。</p><p id="fe3d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先，我们将使用 Docker 构建一个容器，我们的应用程序将在其中运行。这让我们可以在任何地方，在自己的环境中运行应用程序。</p><p id="f98f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先，<a class="ae kr" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">安装 Docker </a>:</p><p id="d326" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">卸载旧版本:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="4fe3" class="nl me iq mz b gy nm nn l no np">sudo apt-get remove docker docker-engine docker.io containerd runc</span></pre><p id="e73c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">设置存储库:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="77b3" class="nl me iq mz b gy nm nn l no np">sudo apt-get update<br/>sudo apt-get install \<br/>    apt-transport-https \<br/>    ca-certificates \<br/>    curl \<br/>    gnupg-agent \<br/>    software-properties-common</span></pre><p id="049f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">添加 Docker 官方 GPG 键:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="9473" class="nl me iq mz b gy nm nn l no np">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span></pre><p id="46c6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">添加稳定存储库:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="634b" class="nl me iq mz b gy nm nn l no np">sudo add-apt-repository \<br/>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \<br/>   $(lsb_release -cs) \<br/>   stable"</span></pre><p id="72d2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">安装 Docker 引擎:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="f92c" class="nl me iq mz b gy nm nn l no np">sudo apt-get update<br/>sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre><p id="275e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">通过运行 hello-world 映像来验证安装(它应该打印一条信息性消息，验证安装成功):</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="1698" class="nl me iq mz b gy nm nn l no np">sudo docker run hello-world</span></pre><p id="c14c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，在 greenr-tutorial 目录中，您将需要创建一个 Docker 文件，为 Docker 提供构建容器的指令。首先，vim 进入<code class="fe mw mx my mz b">Dockerfile</code>并添加以下几行:</p><p id="69dd" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这个 Dockerfile 将在 Python3.6 环境中安装所需的库，向容器中添加必要的文件，并在 app.py 中运行 Starlette 服务器。</p><p id="afcf" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在 greenr 目录中，使用以下命令构建 Docker 容器:</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="21fa" class="nl me iq mz b gy nm nn l no np">sudo docker image build -t app:latest .</span></pre><h1 id="bde1" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">6.运行 Docker 容器</h1><p id="380a" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">现在，我们要做的就是运行我们的 Docker 容器！</p><pre class="kg kh ki kj gt nh mz ni nj aw nk bi"><span id="d1a6" class="nl me iq mz b gy nm nn l no np">sudo docker run -d -p 80:8008 app:latest</span></pre><p id="ff6b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，让我们访问我们机器的外部 IP 地址，您可以在 Compute Engine 上找到它。确保当你在你的浏览器中输入它时，它的格式是这样的(对于我的例子):<a class="ae kr" href="http://34.68.160.231/" rel="noopener ugc nofollow" target="_blank">http://34.68.160.231/</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/fea153b3af7b79725fd8dd3e7a6ee53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*Pyij17XF6T5CPB2tykbi_g.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">最终部署在网上的模型！</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/34bac00a893bdc8a98b0426ef6f293aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUMt6eC-8kOsbs0fSf6NIg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">最后的结果！</p></figure><p id="c773" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果你看到了以上内容，那么你已经坚持到了最后。恭喜你。🎉现在，你可以永远运行你的机器，因为它是谷歌永远免费层的一部分。</p></div></div>    
</body>
</html>