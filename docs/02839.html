<html>
<head>
<title>How to use Cypher projection in Neo4j Graph Data Science library on a Lord of the Rings social network</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在指环王社交网络上的Neo4j图形数据科学库中使用Cypher投影</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-cypher-projection-in-neo4j-graph-data-science-library-on-a-lord-of-the-rings-social-b3459138c4f1?source=collection_archive---------39-----------------------#2020-03-18">https://towardsdatascience.com/how-to-use-cypher-projection-in-neo4j-graph-data-science-library-on-a-lord-of-the-rings-social-b3459138c4f1?source=collection_archive---------39-----------------------#2020-03-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8a86" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解有关cypher projection的所有信息，以及如何使用它来投影虚拟图形</h2></div><p id="93c1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续介绍<a class="ae lb" rel="noopener" target="_blank" href="/exploring-the-graph-catalog-feature-of-neo4j-graph-data-science-plugin-on-a-lord-of-the-rings-d2de0d0a023">上一篇博文</a>中的<a class="ae lb" href="https://github.com/neo4j/graph-data-science" rel="noopener ugc nofollow" target="_blank"> Neo4j Graph数据科学库</a> graph catalog特性，其中我们深入研究了<a class="ae lb" href="https://neo4j.com/docs/graph-data-science/1.0/management-ops/native-projection/" rel="noopener ugc nofollow" target="_blank">原生投影</a>，我们将在这篇博文中了解一下<a class="ae lb" href="https://neo4j.com/docs/graph-data-science/1.0/management-ops/cypher-projection/" rel="noopener ugc nofollow" target="_blank"> Cypher投影</a>。它是图形投影的更具表现力的变体，也允许我们投影虚拟图形。</p><h1 id="94ab" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">图形导入</h1><p id="0614" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们将在import语句中使用APOC库<a class="ae lb" href="https://github.com/neo4j-contrib/neo4j-apoc-procedures/" rel="noopener ugc nofollow" target="_blank">中的一些程序。我已经习惯了总是有APOC在身边，我甚至很少单独提到它。它包含了许多令人敬畏的程序，很难想象没有它的生活。</a></p><h1 id="8d38" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">导入节点</h1><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="709a" class="mi ld iq me b gy mj mk l ml mm">LOAD CSV WITH HEADERS FROM<br/>"https://raw.githubusercontent.com/morethanbooks/projects/master/LotR/ontologies/ontology.csv" as row FIELDTERMINATOR "\t"<br/>WITH row, CASE row.type WHEN 'per' THEN 'Person'<br/>                        WHEN 'gro' THEN 'Group'<br/>                        WHEN 'thin' THEN 'Thing'<br/>                        WHEN 'pla' THEN 'Place' END as label<br/>CALL apoc.create.nodes(['Node',label], [apoc.map.clean(row,['type','subtype'],[null,""])]) YIELD node<br/>WITH node, row.subtype as class<br/>MERGE (c:Class{id:class})<br/>MERGE (node)-[:PART_OF]-&gt;(c);</span></pre><h1 id="a428" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">导入关系</h1><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b9e8" class="mi ld iq me b gy mj mk l ml mm">UNWIND ['1','2','3'] as book<br/>LOAD CSV WITH HEADERS FROM <br/>"https://raw.githubusercontent.com/morethanbooks/projects/master/LotR/tables/networks-id-volume" + book + ".csv" AS row<br/>MATCH (source:Node{id:coalesce(row.IdSource,row.Source)})<br/>MATCH (target:Node{id:coalesce(row.IdTarget,row.Target)})<br/>CALL apoc.create.relationship(source, "INTERACTS_" + book,<br/>{weight:toInteger(row.Weight)}, target) YIELD rel<br/>RETURN distinct true;</span></pre><h1 id="80aa" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">Cypher投影</h1><p id="952f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">使用密码投影的一般语法是:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="0394" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.create.cypher(<br/>    graphName: String,<br/>    nodeQuery: String,<br/>    relationshipQuery: String,<br/>    configuration: Map<br/>)</span></pre><p id="387d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">节点查询是一个cypher语句，用于描述我们想要投影的节点。它必须返回节点的内部id，并且可选地返回它们的任何属性。另一方面，关系查询描述了我们想要投射的关系。cypher语句应该返回关系的源和目标节点的内部id，以及可选的它们的类型和它们的任何属性。</p><h1 id="c154" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">整个图表</h1><p id="4bfa" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们将从一个简单的场景开始，并在内存中投影整个图形。在关系查询中添加列<strong class="kh ir">类型</strong>允许数据科学引擎区分关系类型，这反过来为我们提供了一个在执行算法时过滤关系的选项。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f79c" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.create.cypher(<br/>    'whole-graph',<br/>    // nodeQuery<br/>    'MATCH (n) RETURN id(n) AS id',<br/>    // relationshipQuery<br/>    'MATCH (n)-[r]-&gt;(m) RETURN id(n) AS source, id(m) AS target, type(r) as type'</span></pre><p id="6d55" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和之前的博文一样，我们将从弱连通分量算法开始。它用于检查我们的图中有多少孤岛或不连接的组件，这将帮助我们更好地理解不同图算法的结果。此外，有时我们可能希望只在最大的连通分量上运行其他图算法。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="bd78" class="mi ld iq me b gy mj mk l ml mm">CALL gds.wcc.stream('whole-graph')<br/>YIELD nodeId, componentId<br/>RETURN componentId, count(*) as size<br/>ORDER BY size DESC limit 10</span></pre><p id="f3a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="bd42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为在我们的图中只有一个连通分量，所以我们不必担心来自其他图算法的扭曲结果。</p><h2 id="cf2a" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">从目录中删除投影图</h2><p id="53f9" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">每次分析后，我们将从内存中释放投影图。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="0b46" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.drop('whole-graph');</span></pre><h1 id="3dc9" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">无向加权关系图</h1><p id="0624" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">接下来，我们将投影一个无向加权图。让我们看看<a class="ae lb" href="https://neo4j.com/docs/graph-data-science/1.0/management-ops/native-projection/" rel="noopener ugc nofollow" target="_blank">原生投影</a>是如何处理无向关系的:</p><ul class=""><li id="fad7" class="nb nc iq kh b ki kj kl km ko nd ks ne kw nf la ng nh ni nj bi translated"><code class="fe nk nl nm me b">UNDIRECTED</code>:每种关系都以自然和相反的方向投射</li></ul><p id="0fc6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了使用cypher projection生成一个无向关系，我们在两个方向上投影一个关系，有效地允许图形数据科学引擎在两个方向上遍历它。让我们看一下下面的例子，以便更好地理解。我们创建了两个节点，它们之间只有一个连接。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="eabe" class="mi ld iq me b gy mj mk l ml mm">CREATE (:Test)-[:REL]-&gt;(:Test);</span></pre><p id="fb13" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了向两个方向投射关系，我们只需在我们的<strong class="kh ir">匹配</strong>语句中省略关系的方向，就这样。一个微小但至关重要的细节！</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3d91" class="mi ld iq me b gy mj mk l ml mm">MATCH (n:Test)-[r]-(m:Test)<br/>RETURN id(n) as source, id(m) as target;</span></pre><p id="ff93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="9296" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还将展示一种在节点查询中使用<strong class="kh ir"> UNION </strong>语句来投影多个节点标签的有利方式。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f4a0" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.create.cypher(<br/>    'undirected_interactions',<br/>    // nodeQuery<br/>    'MATCH (n:Person) RETURN id(n) AS id<br/>     UNION<br/>     MATCH (n:Thing) RETURN id(n) as id',<br/>    // relationshipQuery (notice no direction on relationship)<br/>   'MATCH (n)-[r:INTERACTS_1|:INTERACTS_2|:INTERACTS_3]-(m)<br/>    RETURN id(n) AS source, id(m) AS target, <br/>           type(r) as type, r.weight as weight')</span></pre><h2 id="3e58" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">随机行走算法</h2><p id="34c6" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">为了摆脱PageRank或Louvain等常见的图算法，让我们使用<a class="ae lb" href="https://neo4j.com/docs/graph-data-science/1.0/alpha-algorithms/random-walk/" rel="noopener ugc nofollow" target="_blank">随机行走算法</a>。本质上，它模拟了一个喝醉的人如何穿过我们的图表。它通常用于node2vec算法中。我们定义佛罗多为起始节点，然后随机走五步两次。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="a8e5" class="mi ld iq me b gy mj mk l ml mm">MATCH (n:Node{Label:'Frodo'})<br/>CALL gds.alpha.randomWalk.stream('undirected_interactions',<br/>    {start:id(n), steps:5, walks:2})<br/>YIELD nodeIds<br/>RETURN [nodeId in nodeIds | gds.util.asNode(nodeId).Label] as result</span></pre><p id="2f7e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="419a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你会得到不同的结果，因为这毕竟是一个随机游走算法。</p><h2 id="8167" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">三角形计数和聚类系数</h2><p id="35b0" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">另一个分析社交网络的有用算法是<a class="ae lb" href="https://neo4j.com/docs/graph-data-science/1.0/algorithms/triangle-counting-clustering-coefficient/" rel="noopener ugc nofollow" target="_blank">三角形计数和聚类系数算法</a>。三角形由三个节点组成，其中每个节点都与另外两个节点有关系。聚集系数是对图中节点聚集程度的度量。这使我们能够估计图表中节点的紧密程度。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="080e" class="mi ld iq me b gy mj mk l ml mm">CALL gds.alpha.triangleCount.write('undirected_interactions',<br/>    {relationshipTypes:['INTERACTS_1'],<br/>     writeProperty:'triangles',<br/>     clusteringCoefficientProperty:'clustering'})<br/>YIELD nodeCount, triangleCount, averageClusteringCoefficient</span></pre><p id="209f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="aed1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">全局或平均聚类系数是0.54，这意味着我们图表中的人非常紧密。我们也可以看看个体和他们的局部聚类系数。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="44c8" class="mi ld iq me b gy mj mk l ml mm">MATCH (p:Person)<br/>RETURN p.Label as person, <br/>       p.clustering as coefficient, <br/>       p.triangles as triangles<br/>ORDER BY coefficient DESC LIMIT 5</span></pre><p id="7ee2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="d4de" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们想象一下特伦和他的关系，观察他们是如何形成一个紧密的社区的。</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/3506810bd725577cf7fb089a0416b23d.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/0*uAqVLMbWdfoIezr1"/></div></figure><p id="52b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Thrain的所有联系人也相互影响，因此聚类系数的值为1.0。</p><h2 id="a342" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">从目录中删除投影图</h2><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="d7df" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.drop('undirected_interactions');</span></pre><h1 id="98f4" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">分类页面排名</h1><p id="19d8" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">到目前为止，所有上述图形分析都可以用本地投影来完成。Cypher projection可以投影仅在查询时存在的图形，或者当我们希望使用比节点标签或关系类型更高级的过滤时。</p><p id="5980" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">分类页面排名(Categorical PageRank)是由肯尼·巴斯塔尼(Kenny Bastani)在他的<a class="ae lb" href="https://neo4j.com/blog/categorical-pagerank-using-neo4j-apache-spark/" rel="noopener ugc nofollow" target="_blank">博客文章</a>中首次提出的概念。我还用图算法库写了一篇关于它的<a class="ae lb" href="https://tbgraph.wordpress.com/2018/01/14/neo4j-categorical-pagerank/" rel="noopener ugc nofollow" target="_blank">博文</a>。现在是时候用图形数据科学库来展示它了。</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/727fc42a4a98bc46bacf597af4cd5b24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/0*ZXuB_ujrYcNVXsd5"/></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">来源:<a class="ae lb" href="https://www.kennybastani.com/2015/01/categorical-pagerank-neo4j-spark.html" rel="noopener ugc nofollow" target="_blank">Kenny Bastani<a class="ae lb" href="https://twitter.com/kennybastani" rel="noopener ugc nofollow" target="_blank">发布的</a>分类页面排名</a></p></figure><p id="6685" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">背后的想法很简单。如上例所示，我们有一个页面图，这些页面之间有链接，并且可能属于一个或多个类别。为了更好地理解网络中节点的全局pagerank分数，我们可以将我们的图分解成几个子图，每个子图对应一个类别，并对每个子图执行pagerank算法。我们将结果存储为类别和页面之间的关系属性。这样，我们可以分解哪些类别对page的全球pagerank得分有贡献。</p><p id="4144" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们会从假设每一次互动都是积极的背书开始(我知道其实不是，我们就假装吧)。我们将根据角色所属的类别(人类，精灵)把我们的图表分解成几个子图表。例如，在计算男性类别的pagerank时，将考虑所有节点。然而，只有来自属于男人阶层的角色的关系才会被考虑。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="ac01" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.create.cypher(<br/>    'categorical_men',<br/>    // nodeQuery<br/>    'MATCH (n:Person) RETURN id(n) AS id<br/>     UNION<br/>     MATCH (n:Thing) RETURN id(n) as id',<br/>    // relationshipQuery<br/>    'MATCH (c:Class)&lt;-[:PART_OF]-(n)-[r:INTERACTS_1|:INTERACTS_2|:INTERACTS_3]-(m)<br/>     // Use the parameter<br/>     WHERE c.id = $class<br/>     RETURN id(n) AS source, id(m) AS target, <br/>            r.weight as weight,type(r) as type',<br/>    {parameters: { class: 'men' }})</span></pre><p id="a072" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们在这张图上运行加权pageRank。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="425a" class="mi ld iq me b gy mj mk l ml mm">CALL gds.pageRank.stream('categorical_men',<br/>    {relationshipWeightProperty:'weight'})<br/>YIELD nodeId, score<br/>RETURN gds.util.asNode(nodeId).Label as name, score<br/>ORDER BY score DESC LIMIT 5</span></pre><p id="5ee8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="e624" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">甘道夫名列第一，阿拉贡紧随其后。我想知道阿拉贡在第三部中是否得到了大多数人的支持，因为他在最后成为了他们的国王。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="dc9d" class="mi ld iq me b gy mj mk l ml mm">CALL gds.pageRank.stream('categorical_men',<br/>    {relationshipTypes:['INTERACTS_3'],<br/>     relationshipWeightProperty:'weight'})<br/>YIELD nodeId, score<br/>RETURN gds.util.asNode(nodeId).Label as name, score<br/>ORDER BY score DESC LIMIT 5</span></pre><p id="2d3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="dcda" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不出所料，阿拉贡领先。佛罗多已经不在名单上了，因为他在第三部中与所有人都隔离开来，独自和山姆一起走向末日火山。老实说，如果有山姆在你身边，你永远不会感到孤独。</p><h2 id="2e5b" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">从目录中删除投影图</h2><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f7b8" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.drop('categorical');</span></pre><h1 id="4e9b" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">虚拟分类图</h1><p id="0609" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们只研究了男人的类别，并计算了特定子图的分类pagerank。如果我们分别为每个类投影一个子图，这将非常耗时。这就是为什么我们将使用虚拟关系类型在单个命名图中为每个类投影一个子图。在关系查询中，我们可以选择以列<strong class="kh ir">类型</strong>的形式返回我们想要的任何内容。我们将返回原始的关系类型，并结合人的类来创建虚拟的关系类型。这将允许我们计算每个类的分类pagerank。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6205" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.create.cypher(<br/>    'categorical_virtual',<br/>    'MATCH (n:Person) RETURN id(n) AS id<br/>     UNION<br/>     MATCH (n:Thing) RETURN id(n) as id',<br/>    'MATCH (c:Class)&lt;-[:PART_OF]-(n)-[r:INTERACTS_1|:INTERACTS_2|:INTERACTS_3]-(m)<br/>     RETURN id(n) AS source, id(m) AS target, <br/>            type(r) + c.id as type, r.weight as weight')</span></pre><p id="ad28" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在可以计算精灵类的分类pagerank。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3cb4" class="mi ld iq me b gy mj mk l ml mm">CALL gds.pageRank.stream('categorical_virtual', <br/>    {relationshipTypes:['INTERACTS_1elves','INTERACTS_2elves','INTERACTS_3elves'],<br/>     relationshipWeightProperty:'weight'})<br/>YIELD nodeId, score <br/>RETURN gds.util.asNode(nodeId).Label as name, score <br/>ORDER BY score DESC LIMIT 5</span></pre><p id="70e8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="93bd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想要计算每个类的分类pagerank并存储结果，我们可以使用与<a class="ae lb" href="https://tbgraph.wordpress.com/2018/01/14/neo4j-categorical-pagerank/" rel="noopener ugc nofollow" target="_blank">最初的博客文章</a>中相同的方法，我们将结果保存在类和人之间的关系中。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="5a2c" class="mi ld iq me b gy mj mk l ml mm">MATCH (c:Class)<br/>CALL gds.pageRank.stream('categorical_virtual',<br/>    {relationshipTypes:['INTERACTS_1'+c.id,'INTERACTS_2'+c.id,'INTERACTS_3'+c.id],<br/>     relationshipWeightProperty:'weight'}) <br/>YIELD nodeId, score<br/>WITH c, gds.util.asNode(nodeId) as node, score<br/>// 0.15 is the default value for nodes with no incoming links<br/>WHERE score &gt; 0.151<br/>CREATE (c)-[:PAGERANK{score:score}]-&gt;(node)</span></pre><p id="f1da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们可以根据类别pagerank得分获得每个类的前三名成员。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4894" class="mi ld iq me b gy mj mk l ml mm">MATCH (c:Class)-[s:PAGERANK]-&gt;(p:Person)<br/>WITH c, p, s.score as pagerank<br/>ORDER BY pagerank DESC<br/>RETURN c.id as class,<br/>       collect(p.Label)[..3] as top_3_members</span></pre><p id="2616" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><figure class="lz ma mb mc gt mn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="7f4a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">佛罗多以四个第一领先，甘道夫三个第一，山姆两个第一。大多数结果都是不言自明的，就像甘道夫领导的矮人班的支持，吉姆利自己是个矮人排在第二位，所以他可能和所有其他矮人都有互动。因为勒苟拉斯经常和吉姆利在一起，所以他排在第三位。另一方面，山姆和弗罗多独自冒险进入兽人土地的中心，与兽人的互动最多(不是真正的代言)。</p><h2 id="602d" class="mi ld iq bd le mq mr dn li ms mt dp lm ko mu mv lo ks mw mx lq kw my mz ls na bi translated">从目录中删除投影图</h2><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="eefe" class="mi ld iq me b gy mj mk l ml mm">CALL gds.graph.drop('categorical_virtual');</span></pre><h1 id="f0df" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">结论</h1><p id="8655" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Cypher projection非常有表现力，它允许我们投影存储图的任何子图以及只在查询时存在的任何虚拟图。我们大多只是被我们的想象力所限制。亲自尝试一下<a class="ae lb" href="https://github.com/neo4j/graph-data-science" rel="noopener ugc nofollow" target="_blank">图形数据科学库</a>，如果您有任何建议或反馈，请告诉我们。</p><p id="17e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和往常一样，代码可以在<a class="ae lb" href="https://github.com/tomasonjo/blogs/blob/master/lotr_graph_data_science_catalog/Cypher%20projection%20of%20the%20Graph%20Catalog%20feature%20on%20a%20Lord%20of%20the%20Rings%20network.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div></div>    
</body>
</html>