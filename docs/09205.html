<html>
<head>
<title>Road to the first marathon with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 首次马拉松之路</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/road-to-the-first-marathon-with-python-c78b2eee4e47?source=collection_archive---------49-----------------------#2020-07-01">https://towardsdatascience.com/road-to-the-first-marathon-with-python-c78b2eee4e47?source=collection_archive---------49-----------------------#2020-07-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e19f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一位数据科学家讲述了他与 Strava API、熊猫等的马拉松之旅。</h2></div><p id="8448" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">跑步对我来说不仅仅是一种锻炼。这让我成为一个更快乐的人。2019 年 3 月，我在洛杉矶第一次跑马拉松。那时，我写了第一篇关于那次经历的媒体文章。</p><p id="1961" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一名数据科学家，我知道我可以做更多的事情来记住这段旅程。但是，我拖了一年多。由于新冠肺炎，我们外出跑步和参加比赛的能力非常有限。这让我更加怀念过去的时光。多亏了 Strava，我记录了我第一次马拉松前的所有跑步。我决定埋头研究这些数据。</p><p id="cc9c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">这篇文章不是关于什么的？</strong></p><p id="b53a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这不是关于如何更好地跑步。为此，我推荐《丹尼尔的跑步公式》这本书。</p><p id="3e78" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">这篇文章是关于什么的？</strong></p><p id="db68" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一本技术入门书，介绍了如何使用 Python 连接 Strava 的 activities API，并使用常见的 Python 库对我在 2019 年洛杉矶马拉松之前的跑步进行探索性分析。这揭示了数据是如何偏离直觉的。还提供了代码片段。</p><p id="8634" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> Strava API </strong></p><p id="4ef2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在过去的 5 年里，我一直在使用 Strava。我喜欢这个应用程序的简单性和功能性。直到最近，我才开始探索<a class="ae le" href="https://developers.strava.com/" rel="noopener ugc nofollow" target="_blank"> Strava API </a>。在高层次上，Strava API 要求开发人员使用 OAuth 2.0 身份验证来访问用户的数据。并且每次用户发起认证时，都会创建一个认证码来交换临时访问令牌。开发人员可以使用这个访问令牌来获取用户的数据。</p><p id="69c4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我首先发送一个 post 请求来获取我的访问令牌。这个访问令牌允许我访问我的活动数据。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="72ba" class="lo lp it lk b gy lq lr l ls lt">import pandas as pd<br/>import requests<br/>import configparser<br/>import os.path<br/>import json<br/>from collections import defaultdict<br/>import datetime<br/>import matplotlib.pyplot as plt</span><span id="5084" class="lo lp it lk b gy lu lr l ls lt">config = configparser.ConfigParser()<br/>config.read('/Users/LG/Documents/key_files/strava/strava.cfg')<br/>client_id = config.get('USER','CLIENT_ID')<br/>client_secret = config.get('USER','SECRET')<br/>auth_url = config.get('OAUTH','AUTH_URL')<br/>auth_code = config.get('OAUTH','AUTH_CODE')<br/>params = {'client_id':client_id,'client_secret':client_secret,'code':auth_code,'grant_type':'authorization_code'}<br/>headers = {'content-type': 'application/json'}<br/>r =requests.post(auth_url,data=params)</span></pre><p id="464a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我使用访问令牌发送 get 请求，从 Strava 提取我的所有活动数据。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="0634" class="lo lp it lk b gy lq lr l ls lt"># retrieve access token<br/>access_token = "access_token=" + str(r.json()['access_token'])<br/># url for getting activities<br/>activity_url = "<a class="ae le" href="https://www.strava.com/api/v3/activities" rel="noopener ugc nofollow" target="_blank">https://www.strava.com/api/v3/activities</a>"<br/># only select variables of interest<br/>cols = ['average_heartrate','average_speed','distance','moving_time',\<br/>        'start_date','start_latitude','start_longitude','suffer_score','total_elevation_gain',<br/>       'type'<br/>       ]<br/># write a loop to retrieve all the activities and store in a dictionary indexed by activitiy id.<br/>page = 1<br/>d = defaultdict()<br/>while True:<br/>    string = activity_url + '?'+ access_token + '&amp;per_page=50' + '&amp;page=' + str(page)<br/>    # get the page of activities<br/>    r = requests.get(string)<br/>    r = r.json()<br/>    if not r:<br/>        break<br/>    for i in range(len(r)):<br/>        if r[i]['id'] not in d:<br/>            d[r[i]['id']] = defaultdict()<br/>            for key,value in r[i].items():<br/>                if key in cols:<br/>                    d[r[i]['id']][key] = value<br/>        else: <br/>            continue<br/>    page += 1</span></pre><p id="3a23" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">嘣，我把我所有的活动数据都保存在一个 Python 字典里了。现在，让我们做一些数据管理。</p><ul class=""><li id="4663" class="lv lw it kk b kl km ko kp kr lx kv ly kz lz ld ma mb mc md bi translated">仅过滤正在运行的活动。我有时也骑自行车。</li><li id="5dee" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">Strava 记录的跑步距离是米，我需要把它转换成英里。</li><li id="d3cf" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">Strava 记录的速度是米每秒，我需要把它转换成分钟每英里。</li><li id="b983" class="lv lw it kk b kl me ko mf kr mg kv mh kz mi ld ma mb mc md bi translated">我过滤了 2017-12 和 2019-03 之间的日期，当时我正在为马拉松比赛进行实际训练。</li></ul><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="c2b0" class="lo lp it lk b gy lq lr l ls lt">my_strava = pd.DataFrame.from_dict(d,orient='index')<br/># filter only run activities<br/>my_strava = my_strava[my_strava['type']=='Run']<br/># meter to mile translation<br/>def meter_to_mile(meter):<br/>    return meter * 0.000621371192<br/># average speed meter per second to Minutes Per Mile<br/>def speed_converter(speed):<br/>    return 1 / (meter_to_mile(speed) * 60)</span><span id="b538" class="lo lp it lk b gy lu lr l ls lt"># translate my distance into miles, and moving time into hours/minutes, <br/># and start_date into date/time, speed into Minutes per Mile<br/>my_strava['distance'] = my_strava['distance'].apply(meter_to_mile)<br/>my_strava['moving_time'] = my_strava['moving_time'].apply(lambda x:str(datetime.timedelta(seconds=x)))<br/>my_strava['start_date'] = my_strava['start_date'].apply(lambda x:datetime.datetime.strptime(x,'%Y-%m-%dT%H:%M:%SZ'))<br/>my_strava['average_speed'] = my_strava['average_speed'].apply(speed_converter)<br/># filter dates between 2017-12-01 and 2019-03-24<br/>first_run_date = '2017-12-01'<br/>last_run_date = '2019-03-25'<br/>mar = (my_strava['start_date'] &gt; first_run_date) &amp; (my_strava['start_date'] &lt; last_run_date)<br/>my_marathon = my_strava.loc[mar]<br/>my_marathon.head()</span></pre><p id="9659" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">数据如下表所示，似乎可以进行一些探索性分析。</p><figure class="lf lg lh li gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mj"><img src="../Images/23d022708b2b064677d9b4d155e8d7d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9G9rDpNFTZMlmfqjBichgw.png"/></div></div></figure><p id="92c2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">分析</strong></p><p id="629e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这绝对是关键时刻之一。只有当我看数据的时候，我才意识到我跑的比我想象的要少得多。在洛杉矶马拉松之前的一年里，我的跑步距离实际上是下降的。它不符合任何在线马拉松训练计划。反而是长达一年多的训练之旅，建立了我的信心和抵抗力。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="a141" class="lo lp it lk b gy lq lr l ls lt">fig,ax = plt.subplots(figsize=(10,7))<br/>ax.set_title('Running Distance (Miles)')<br/>ax.plot('start_date','distance','bo--',data=my_marathon)<br/>arrowprops=dict(arrowstyle='&lt;-', color='red')<br/># add annotations for 2018-07-29 for SF half, 2019-03-24 for LA full.<br/>ax.annotate(s='SF half marathon',xy=((datetime.datetime.strptime('2018-07-29','%Y-%m-%d')),13.1),\<br/>           xytext=((datetime.datetime.strptime('2018-08-01','%Y-%m-%d')),15.0),\<br/>           arrowprops=arrowprops);<br/>ax.annotate(s='LA marathon',xy=(datetime.datetime.strptime('2019-03-24','%Y-%m-%d'),26.2),\<br/>           xytext=(datetime.datetime.strptime('2019-01-15','%Y-%m-%d'),20.0),\<br/>           arrowprops=arrowprops);</span></pre><figure class="lf lg lh li gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mr"><img src="../Images/d5573b07bdd4d50df7f53dfa9734a496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*pgm4A6D-M0roiTirh7SBGg.png"/></div></div></figure><p id="bb98" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的跑步大多集中在 3-7 英里，每英里 10 分钟。这种水平的表现就是所谓的“轻松步伐”。偶尔，我会跑个门槛。洛杉矶马拉松是我唯一一次跑超过 15 英里。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="b1d6" class="lo lp it lk b gy lq lr l ls lt">fig,ax = plt.subplots(figsize=(10,7))<br/>ax.set_title('Speed (Minutes Per Mile) vs Distance (Miles)')<br/>ax.scatter('average_speed','distance',data=my_marathon,color='blue',marker='D')<br/>ax.set_xlabel('Minutes Per Mile')<br/>ax.set_ylabel('Miles')<br/>plt.show()</span></pre><figure class="lf lg lh li gt mk gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/f0125fd3a8ac25102c5f7e19e27b8238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*qrvuycRaEet2qfarbY3c8Q.png"/></div></figure><p id="ba5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的巅峰月份是 2018–07 年训练和参加旧金山半程马拉松时的 50 多英里。事件发生后，情况急转直下。然而有趣的是，低于 15 英里的最低表现出现在 2019 年 2 月洛杉矶马拉松比赛之前。同样，只有当我们看数据时才会感到惊讶！</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="62fe" class="lo lp it lk b gy lq lr l ls lt">fig,ax = plt.subplots(nrows=1,ncols=2,figsize=(15,5))<br/>ax[0].set_title('Training Frequency: Number of Runs Per Month')<br/>ax[0].plot('month','count','bo--',data=monthly_run)<br/>ax[1].set_title('Training Intensity: Total Miles Per Month')<br/>ax[1].plot('month','total_distance','ro--',data=monthly_mile)<br/>plt.show()</span></pre><figure class="lf lg lh li gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mt"><img src="../Images/f877d0dcb20bdea8ac7db104d4a0cb80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcwcdxGANVhO4j2JV_LNLA.png"/></div></div></figure><p id="620f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">给你。简而言之，这是我第一次用 Python 请求、字典、pandas 和 matplotlib 进行马拉松式的体验。</p></div></div>    
</body>
</html>