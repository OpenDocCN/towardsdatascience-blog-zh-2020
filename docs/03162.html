<html>
<head>
<title>Step-by-step guide on how to train GPT-2 on books using Google Colab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用谷歌Colab在书籍上训练GPT-2的逐步指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/step-by-step-guide-on-how-to-train-gpt-2-on-books-using-google-colab-b3c6fa15fef0?source=collection_archive---------8-----------------------#2020-03-26">https://towardsdatascience.com/step-by-step-guide-on-how-to-train-gpt-2-on-books-using-google-colab-b3c6fa15fef0?source=collection_archive---------8-----------------------#2020-03-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="b161" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我是如何成为一名共产党员的</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7767d5e2515c15255cafe5ea4325bb70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KyvZ48phBvlKy1PA7I9b_A.png"/></div></div></figure><p id="5f5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">共产主义者的人工智能是用GPT-2训练的。它阅读马克思、法农、葛兰西、列宁和其他革命作家的书籍。该项目旨在看看GPT-2能理解多深的哲学思想和概念。<br/>结果相当有趣，也很有希望，因为我们见证了A。我合乎逻辑地扭曲了我们给它的任何句子，使之成为抨击资本主义和为“工人”而斗争的借口。只要有可能，它就呼吁革命。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lb lc l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">这是使用无条件生成的样本生成的——没有人的输入</p></figure><p id="093d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，在介绍了无政府共产主义作家克鲁泡特金之后，我注意到“共产主义人工智能”倾向于使用更具攻击性的词语。另一方面，当我们介绍德·波伏娃的《第二性》(The Second Sex)时，《共产主义者人工智能》(The Communist A.I)有点错过了这本书的重点，在某些时候谈到了资本家的恋物癖——或者说它错过了重点？</p><p id="30f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而讨论人工智能的话语和哲学很有趣，比如回答“一个人如何变得自由”的问题，这篇文章旨在展示一个简单的分步指南，告诉你如何只用GPT-2、谷歌Colab和你的谷歌硬盘创建你自己的人工智能角色。那我们开始吧。<br/>如果你想<a class="ae la" href="https://medium.com/@mhd.ali.nasser/how-this-a-i-became-a-communist-ddf9146bc147?sk=f443a5b02bcf1156c510d021f4628445" rel="noopener">阅读更多关于共产主义人工智能的信息，请点击此链接</a></p></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="6c97" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">准备您的Google Colab笔记本</h1><p id="daca" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">我们将使用Google Drive来保存我们的检查点(检查点是我们最后保存的训练模型)。一旦我们训练好的模型被保存，我们就可以在任何时候加载它来生成有条件和无条件的文本。</p><p id="1ec9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，把你的Colab的运行时间设置为GPU，以后你会感谢我的。<br/>使用以下代码连接您的Google Drive:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="5a07" class="mx lq it mt b gy my mz l na nb">from google.colab import drive<br/>drive.mount('/content/drive')</span></pre><p id="c0de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在您已经连接了Google Drive，让我们创建一个检查点文件夹:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="a6c6" class="mx lq it mt b gy my mz l na nb">%cd drive<br/>%cd My\ Drive<br/>%mkdir NAME_OF_FOLDER<br/>%cd /content/<br/>!ls</span></pre><p id="9c55" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们克隆我们将使用的GPT-2存储库，它来自nnsheperd的awesome存储库(它来自OpenAI，但添加了令人敬畏的train.py)，我添加了一个conditional_model()方法，该方法允许我们一次传递多个句子，并返回一个包含相关模型输出样本的字典。它还让我们避免使用bash代码。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="94bc" class="mx lq it mt b gy my mz l na nb"><a class="ae la" href="https://github.com/mohamad-ali-nasser/gpt-2.git" rel="noopener ugc nofollow" target="_blank">!git clone </a><a class="ae la" href="https://github.com/mohamad-ali-nasser/gpt-2.git" rel="noopener ugc nofollow" target="_blank">https://github.com/mohamad-ali-nasser/gpt-2.git</a></span></pre><p id="f095" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们下载我们选择的模型。我们将使用相当不错的345M型号。我们将使用该型号而不是774M或1558M的原因是训练时Colab中可用的GPU内存有限。也就是说，如果我们想使用预训练的GPT-2，而不需要对我们的语料库进行任何微调或训练，我们可以使用774M和1558M。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="6077" class="mx lq it mt b gy my mz l na nb">%cd gpt-2<br/>!python3 download_model.py 345M</span></pre><p id="41c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在模型已经安装好了，让我们准备好语料库并加载检查点，以防我们之前已经训练过模型。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="4db3" class="mx lq it mt b gy my mz l na nb"># In Case I have saved checkpoints<br/>!cp -r /content/drive/My\ Drive/communist_ai/gpt-2/checkpoint/run1/* /content/gpt-2/models/345M</span></pre><h1 id="f214" class="lp lq it bd lr ls nc lu lv lw nd ly lz ma ne mc md me nf mg mh mi ng mk ml mm bi translated">下载文本并将其合并到一个语料库中</h1><p id="60e2" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">让我们创建并移动到我们的语料库文件夹，并获得这些文本。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="cddd" class="mx lq it mt b gy my mz l na nb">%cd src<br/>%mkdir corpus<br/>%cd corpus/<br/>!export PYTHONIOENCODING=UTF-8</span></pre><p id="76a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在Github存储库中有我的文本，但是您可以用您需要的任何链接替换url变量。你也可以手动将你的文本文件上传到Google Colab，或者如果你的Google Drive中有文本文件，那么只需将cd放入该文件夹即可。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="f29d" class="mx lq it mt b gy my mz l na nb">import requests<br/>import os</span><span id="85fe" class="mx lq it mt b gy nh mz l na nb">file_name = "NAME_OF_TEXT.txt"</span><span id="85d1" class="mx lq it mt b gy nh mz l na nb">if not os.path.isfile(file_name):<br/>    url = "https://raw.githubusercontent.com/mohamad-ali-nasser/the-<br/>           communist-ai/master/corpus/manifesto.txt?<br/>           token=AJCVVAFWMDCHUIOOUDSD2FK6PYTN2"<br/>    data = requests.get(url)</span><span id="ef60" class="mx lq it mt b gy nh mz l na nb">with open(file_name, 'w') as f:<br/>         f.write(data.text)<br/>f.close()</span></pre><p id="257b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在文本已经下载完毕，使用下面的代码将多个文本文件合并成一个文件。如果您将只使用一个文本文件，请忽略此代码。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="fff8" class="mx lq it mt b gy my mz l na nb"># Get list of file Names</span><span id="935f" class="mx lq it mt b gy nh mz l na nb">import glob<br/>filenames = glob.glob("*.txt") </span><span id="d8a7" class="mx lq it mt b gy nh mz l na nb"># Add all texts into one file</span><span id="ee74" class="mx lq it mt b gy nh mz l na nb">with open('corpus.txt', 'w') as outfile:<br/>       for fname in filenames:<br/>            with open(fname) as infile:<br/>                  outfile.write(infile.read())<br/>outfile.close()</span></pre><h1 id="f8c4" class="lp lq it bd lr ls nc lu lv lw nd ly lz ma ne mc md me nf mg mh mi ng mk ml mm bi translated">下载库和CUDA</h1><p id="5e2c" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">现在我们已经准备好了一切，让我们准备环境。我们将从安装需求文件开始。(如果你碰巧用你本地的Jupyter笔记本来使用GPT-2，那么在使用download_model.py之前安装需求文件)</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="8f96" class="mx lq it mt b gy my mz l na nb"># Move into gpt-2 folder<br/>%cd /content/gpt-2</span><span id="a695" class="mx lq it mt b gy nh mz l na nb">!pip3 install -r requirements.txt</span></pre><p id="3ae1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，以下是可选的，因为如果您想使用774M型号和1558M型号，它们是必需的。我使用过没有这些的334M，但我还是建议这样做，尤其是CUDA，因为你的模型会运行得更快，这些可能会修复一些你可能会遇到的随机错误。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="66c9" class="mx lq it mt b gy my mz l na nb">!pip install tensorflow-gpu==1.15.0<br/>!pip install 'tensorflow-estimator&lt;1.15.0rc0,&gt;=1.14.0rc0' --force-reinstall</span></pre><p id="1ec3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在安装Cuda v9.0:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="3b36" class="mx lq it mt b gy my mz l na nb">!wget <a class="ae la" href="https://developer.nvidia.com/compute/cuda/9.0/Prod/local_installers/cuda-repo-ubuntu1604-9-0-local_9.0.176-1_amd64-deb" rel="noopener ugc nofollow" target="_blank">https://developer.nvidia.com/compute/cuda/9.0/Prod/local_installers/cuda-repo-ubuntu1604-9-0-local_9.0.176-1_amd64-deb</a><br/>!dpkg -i cuda-repo-ubuntu1604-9-0-local_9.0.176-1_amd64-deb<br/>!apt-key add /var/cuda-repo-*/7fa2af80.pub<br/>!apt-get update<br/>!apt-get install cuda-9-0</span><span id="3b21" class="mx lq it mt b gy nh mz l na nb">!export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda-9.0/lib64/</span></pre><p id="d6b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重启运行时并移回GPT2文件夹</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="5cac" class="mx lq it mt b gy my mz l na nb">%cd gpt-2</span></pre><h1 id="b9ca" class="lp lq it bd lr ls nc lu lv lw nd ly lz ma ne mc md me nf mg mh mi ng mk ml mm bi translated">让我们训练模型:</h1><p id="38b3" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">现在是我们一直在等待的时刻，对模型进行微调。复制下面的一行程序并运行它。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="fe94" class="mx lq it mt b gy my mz l na nb">!PYTHONPATH=src ./train.py --dataset src/corpus/corpus.txt --model_name '345M'</span></pre><p id="b17d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该模型将加载最新的检查点，并从那里开始训练(似乎加载以前训练过的检查点并添加到其中会导致您在使用Colab中的345M时遇到内存问题)。<br/>还可以指定批次数和学习率。批次数量真正的整体好处是训练的速度，默认的批次大小是1，增加批次大小会导致你遇到内存问题，所以要小心你增加多少，特别是当你在一个GPU上运行时，我使用的批次大小是1，尝试2或4，并在评论中添加你的结果。</p><p id="fa41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然提高学习率可以提高训练的速度，但它可能会导致模型卡在局部最小值(梯度)甚至超调，因此我建议保持学习率不变，或者如果<em class="lh">损失</em>停止下降，则降低学习率。默认学习率为0.00001。</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="bd0a" class="mx lq it mt b gy my mz l na nb">!PYTHONPATH=src ./train.py --dataset src/corpus/corpus.txt --model_name '345M' --batch_size 1 --learning_rate 0.00001</span></pre><p id="2efa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该模型将每1000步保存一个检查点。你可以持续运行它几分钟、几小时或几天，这完全取决于你，只要确保如果你有一个小文本，你不要过度拟合模型。<br/>要停止模型，只需“停止”它，它将保存最后一个训练步骤(因此，如果您在步骤1028停止，您将有两个检查点1000和1028)。<br/>注意:当在训练Colab时停止模型时，它可能看起来没有反应并保持训练，为了避免这种情况，在它训练时，清除输出，然后停止它，这将节省您的几次点击。</p><p id="9a74" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在模型已经训练好了，让我们将检查点保存在Google Drive中:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="bcb0" class="mx lq it mt b gy my mz l na nb">!cp -r /content/gpt-2/checkpoint/ /content/drive/My\ Drive/checkpoint</span></pre><p id="b870" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将新保存的检查点复制到模型的目录中</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="13ec" class="mx lq it mt b gy my mz l na nb">!cp -r /content/gpt-2/checkpoint/run1/* /content/gpt-2/models/345M/</span></pre><h1 id="6c2e" class="lp lq it bd lr ls nc lu lv lw nd ly lz ma ne mc md me nf mg mh mi ng mk ml mm bi translated">生成条件文本</h1><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="f501" class="mx lq it mt b gy my mz l na nb">import os<br/>%cd src<br/>from conditional_model import conditional_model<br/>%cd ..</span></pre><p id="51e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行下面的代码，了解该方法的参数是什么:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="b0cb" class="mx lq it mt b gy my mz l na nb">conditional_model??</span></pre><p id="e809" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我建议设置一个种子，这样你可以得到一些可重复的结果。参数语句接受一个字符串或字符串列表，并返回一个字典，其中输入作为键，输出样本作为值。</p><p id="74df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在来看看魔术:</p><pre class="kp kq kr ks gt ms mt mu mv aw mw bi"><span id="dae6" class="mx lq it mt b gy my mz l na nb">conditional_model(seed=1,sentences=['How are you today?', 'Hi i am here'])</span></pre><p id="8fed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你现在已经根据你选择的书籍对你的GPT-2进行了微调，并且创建了你自己的人工智能，祝贺你！！</p><p id="a645" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你觉得这个教程有帮助，请分享并开始GitHub repo—<a class="ae la" href="https://github.com/mohamad-ali-nasser/gpt-2" rel="noopener ugc nofollow" target="_blank">https://github.com/mohamad-ali-nasser/gpt-2</a>。谢谢</p><p id="07bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">别忘了跟着<a class="ae la" href="https://twitter.com/CommunistAI" rel="noopener ugc nofollow" target="_blank">共产主义者A.I </a>。</p><p id="b0bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<a class="ae la" href="https://www.linkedin.com/in/mohamad-ali-nasser-data-scientist/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系，在<a class="ae la" href="https://twitter.com/mhd_ali_nasser" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注。</p><p id="45bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您也可以查看我的<a class="ae la" href="https://www.mohamadalinasser.com" rel="noopener ugc nofollow" target="_blank">组合</a>网站，了解更多项目。</p><p id="f23a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">编码快乐！</p></div></div>    
</body>
</html>