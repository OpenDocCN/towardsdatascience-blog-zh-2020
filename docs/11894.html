<html>
<head>
<title>How to use Deep Learning to shoo pigeons from the balcony</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用深度学习把鸽子从阳台上赶走</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-deep-learning-to-shoo-pigeons-from-the-balcony-31a2704f2160?source=collection_archive---------38-----------------------#2020-08-17">https://towardsdatascience.com/how-to-use-deep-learning-to-shoo-pigeons-from-the-balcony-31a2704f2160?source=collection_archive---------38-----------------------#2020-08-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="b9fe" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">鸽子回避系统</h2><div class=""/><div class=""><h2 id="aa1e" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">基于 Keras 的迁移学习和树莓 Pi 的生产部署</h2></div><p id="8946" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">免责声明:你正在阅读的第三部分是关于如何训练鸽子识别模型的。 <a class="ae lo" href="https://medium.com/@tatianasennikova/how-artificial-intelligence-helped-me-to-win-the-war-against-the-pigeons-9458293983a1" rel="noopener"> <em class="ln">第 1 部分</em> </a> <em class="ln">提供了架构概述，</em> <a class="ae lo" href="https://medium.com/@tatianasennikova/how-to-set-up-data-collection-for-the-pigeon-avoidance-system-eba572fe6dc9" rel="noopener"> <em class="ln">第 2 部分</em> </a> <em class="ln">描述了技术设置。</em></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/00d8b3d3c368af4960071b389fb8b775.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OkJOZsQGyiVRv9qwe7RsGw.jpeg"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">我在鸽子回避系统实施后喝着早晨的咖啡</p></figure><p id="f0dc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在这一部分，我详细介绍了训练鸽子分类模型的过程。本文由四个部分组成:</p><ol class=""><li id="1b8f" class="mf mg it kt b ku kv kx ky la mh le mi li mj lm mk ml mm mn bi translated">塑造数据集</li><li id="61ec" class="mf mg it kt b ku mo kx mp la mq le mr li ms lm mk ml mm mn bi translated">模特培训</li><li id="cc30" class="mf mg it kt b ku mo kx mp la mq le mr li ms lm mk ml mm mn bi translated">推理</li><li id="92be" class="mf mg it kt b ku mo kx mp la mq le mr li ms lm mk ml mm mn bi translated">观点</li></ol><h1 id="145b" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">塑造数据集</h1><p id="b075" class="pw-post-body-paragraph kr ks it kt b ku nl kd kw kx nm kg kz la nn lc ld le no lg lh li np lk ll lm im bi translated">前一部分我在阳台上搭了个树莓派，开始采集图像。与此同时，我正在用鸽子 Tinder 给图片贴标签，这是一个自制的网络应用程序，它可以帮助我将图片分类到指定的类别文件夹中:“鸽子”、“人类”和“什么都没有”。显然，我拍了很多没有鸽子的照片。这是因为传感器是由树枝的运动和光线变化触发的。在风平浪静、阳光明媚的日子，我得到的图像通常比阴天和刮风的日子要少。鸽子每天都停在我的阳台上，总共在那里呆 5-10 分钟。这导致了我的数据集中高度不平衡的类。我正在通过增加鸽子和人类的职业来解决这个问题。遗憾的是，我不能应用很多不同的增强技术，因为垂直或水平翻转鸽子没有意义，因为阳台的布局是恒定的，鸽子很少倒着落在上面。这同样适用于随机裁剪，因为鸽子经常出现在图像的边缘，因此将它们裁剪掉的风险很高。这给我留下了一些增强技术，处理模糊和清晰。我使用以下代码进行数据扩充:</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">数据扩充类</p></figure><p id="0d8f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">仅增加训练数据是至关重要的。另一个重要方面是时间因素。当我第一次训练模型时，我通过从标签照片的桶中随机(没有替换)挑选图像来生成训练和测试数据集。我很快在验证和训练数据上获得了 100%的准确性，这些数据看起来已经很可疑了，但是当我将模型投入生产时，它的表现并不好。分类看起来非常随意。然后，我决定按照时间戳分割数据，并在前十天的数据上训练模型，在接下来的三天进行验证，在最后两天进行测试。这产生了一个更健壮的模型，并且防止了如果我们随机分割数据所发生的数据泄露。在训练数据集中，我总共有 200 张鸽子图像。应用数据增强后，我把它增加到 600。我还将增强应用到人类图片以达到 600 张，并且大多数“无”类包含 600 张没有人类或鸽子的图片。在验证数据集中，每个类有 50/50/50 个图像，在测试中有 30/30/30 个图像。正如我们将在后面看到的，通过利用迁移学习的力量，每个班级只需要 200 幅图像就足以训练一个非常准确的模型。</p><h1 id="aa57" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">模特培训</h1><p id="5690" class="pw-post-body-paragraph kr ks it kt b ku nl kd kw kx nm kg kz la nn lc ld le no lg lh li np lk ll lm im bi translated">由于训练神经网络是一项计算量很大的任务，所以我没有在 Raspberry 上执行它。目前，我在本地培训模型，但考虑在不久的将来切换到云解决方案之一。</p><p id="6e91" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">Keras 是我几年来深度学习的默认选择，主要是针对 LSTMs。然而，完成这个项目后，我现在认为 PyTorch 可能是迁移学习的更好选择，原因如下。最初，我想在预训练的<a class="ae lo" href="https://keras.io/api/applications/resnet/" rel="noopener ugc nofollow" target="_blank"> ResNet50 </a>上使用迁移学习，因为它在图像分类任务上一直显示出非常好的结果。然而，Keras 在 ResNet 架构中有一个非常有线的 BatchNormalisation 层实现。在微调过程中，批量归一化图层被冻结，并使用原始 imagnet 数据集的平均值和标准偏差进行训练。然而，imagenet 的平均值和标准偏差不同于用于微调和推断的新数据集。有多种解决方法，如在微调过程中解冻批量规范化层，以及在训练和推断过程中操作 lerning_phase 标志。然而，我不能仅仅为了应用一个最先进的模型而证明这些变通方法的使用是正确的。因此，我选择了<a class="ae lo" href="https://keras.io/api/applications/vgg/" rel="noopener ugc nofollow" target="_blank"> VGG19 </a>，仅仅经过 30 个时期，它就为我提供了 98%的测试数据集准确率。</p><p id="6dd3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们看看建模部分。首先，我们需要加载数据。我使用 Keras 的 ImageDataGenerator 类来逐步加载图像。它为当前的小批量加载足够的图像到内存中。ImageDataGenerator 类的另一个好处是，它还可以自动缩放像素值，并进行图像预处理，如归一化。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">配置图像数据生成器</p></figure><p id="da5e" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我将训练和测试数据生成器分开保存，以便将来我可以只对训练数据执行数据扩充。注意，我们对两个数据集应用相同的预处理函数，它执行预训练 VGG19 所期望的数据预处理。</p><p id="4586" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">接下来，为了逐步加载数据，我们需要创建一个迭代器。这需要调用 flow_from_directory()方法并指定数据集目录，例如训练、测试或验证目录。该方法允许我们配置多个参数，如 class_mode、target_size 等。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">加载并迭代数据集</p></figure><p id="63b9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们需要为训练和验证迭代器设置每个时期的步骤参数，以便指定有多少批图像定义一个时期。它通常计算为数据集的长度除以批处理大小，但是，它可以设置为一个较小的数字，以允许更频繁的回调。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">计算每个时期的步数</p></figure><p id="9188" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们定义模型架构。使用 Keras 进行迁移学习的步骤顺序是:</p><ol class=""><li id="4270" class="mf mg it kt b ku kv kx ky la mh le mi li mj lm mk ml mm mn bi translated">加载没有顶层的预训练模型。为此，将 include_top 参数设置为 False。</li><li id="e45d" class="mf mg it kt b ku mo kx mp la mq le mr li ms lm mk ml mm mn bi translated">冻结网络，因为我们假设它在之前的训练中学习的基本概念(过滤图)对于广泛的图像分类问题保持不变。</li><li id="dc2a" class="mf mg it kt b ku mo kx mp la mq le mr li ms lm mk ml mm mn bi translated">添加新的可训练层，其中可能包括:展平层，如果您注意到模型过拟合，则删除层，以及带有要预测的类数量的密集输出层。</li></ol><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">指定模型架构</p></figure><p id="c20d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请注意，我在这个任务中使用了相对较小的学习率。这通常适用于所有迁移学习问题。由于我们只是微调顶层，我们应该保持较低，以避免梯度下降跳跃。</p><p id="ee00" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我们去训练循环。为了避免模型过度拟合，我应用了早期停止，并在训练时定期保存模型检查点。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">训练分类模型</p></figure><p id="f98b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在我的鸽子识别问题上运行指定的模型架构 30 个时期，在测试数据集上给了我 98%准确度的预测，这意味着我错误地分类了两幅图像。在这两张照片中，鸽子用尾巴面对镜头，站在一个非常不幸的角度。连我都认不出这团毛绒绒的东西里有一只鸽子。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ns"><img src="../Images/a455dcc83e29e64ce1029851159e86b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vZBMeC-Bw33rmH8oQd5xMQ.jpeg"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">分类错误的鸽子</p></figure><h1 id="f4c4" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">推理</h1><p id="b141" class="pw-post-body-paragraph kr ks it kt b ku nl kd kw kx nm kg kz la nn lc ld le no lg lh li np lk ll lm im bi translated">如前所述，我在本地机器上执行训练，在 Raspberry Pi 上执行推理。由于我使用深度学习进行分类模型，我需要首先安装 TensorFlow。显然，它不像以前在我的本地机器上那样微不足道。Raspberry Pi 上的原子库存在一些问题。因此，我需要经历很多步骤，这里的<a class="ae lo" href="https://qengineering.eu/install-tensorflow-2.2.0-on-raspberry-pi-4.html" rel="noopener ugc nofollow" target="_blank">和</a>都有很好的描述。我将在这里复制主安装脚本，只是为了避免它丢失。但这完全归功于最初推出安装教程的 Q-engineering:</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">TensorFlow 安装脚本</p></figure><p id="0930" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在这之后，我们只需要安装 Keras 通常会顺利进行。</p><p id="d319" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">一切准备就绪后，我们就可以开始实现推理管道了。我们将在本地训练的模型转移到 Raspberry Pi 进行推理。然后我们加载它以备将来使用。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">负载预训练模型</p></figure><p id="8f9f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在 Raspberry 上加载模型大约需要 2 分钟，所以我们只在启动主管道后做一次。然后，我们需要读取检测到运动后拍摄的图像。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">加载要分类的图像</p></figure><p id="985a" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">之后，我们将其提供给预测方法。请注意，我们应用 tensor flow . keras . applications . vgg 19 中的 preprocess_input 方法，该方法以与训练期间相同的方式预处理图像。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">将图像分类</p></figure><p id="1e10" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">最后，我们将预测的类提供给主管道，并通过在末尾添加类名来重命名原始图像。重命名部分是未来评估所必需的。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nq nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">保存图像</p></figure><p id="fc15" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，当我们在 Raspberry 上运行我们的模型时，我们可以检查它在速度和准确性方面的性能。正如我前面提到的，加载模型需要 2 分钟，加载保存的图像需要 0.2 秒，对图像进行分类需要 2 秒。这速度足以吓跑鸽子。然而，模型在生产环境中运行几天后，我开始面临的问题是数据漂移。现实总是比一个阶段性的实验更复杂。现实是狂野的，以前从未发生过的事情会突然发生。我们无法预见它，我们只需要对我们实验室取得的成绩持怀疑态度，并足够灵活地适应不断变化的环境。我所说的是鸽子行为的变化。他们开始在我阳台前的树上筑巢。为什么这是个问题？因为它们开始出现在我的阳台上，嘴里叼着棍子。这是模型还没有准备好处理的事情，因为它从来没有见过一只鸽子拿着一根棍子。因此它断定它不是一只鸽子。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ns"><img src="../Images/eb840d9cd29340e28b3dbe32658b984d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hP5svyBERWCquMz7LPKDrQ.jpeg"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">拿着棍子的鸽子</p></figure><p id="a420" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">接下来的几天，拿着棍子的鸽子成了我阳台上的常客，这让我收集到了新的数据。我重新训练了这个模型，并且已经在庆祝成功了，看着鸽子在着陆后仅仅三秒钟就飞离了我的阳台。然而，我的庆祝太早了。一天，我决定清理阳台上鸽子掉落的树枝，因为它们对我的鸽子回避系统感到惊讶。现在，我惊讶地意识到，系统识别出我是一只鸽子，只是因为我手里拿着棍子。</p><div class="lq lr ls lt gt ab cb"><figure class="nt lu nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><img src="../Images/55c1551175c2644a5cc5f43efe12fb47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*c0BRH_3uHu8BbrUMPmkdcg.jpeg"/></div></figure><figure class="nt lu nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><img src="../Images/0dd0f440568b2a76bfc47227ae278bc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*PY5x32BtoxS_7UVmF5xFRw.jpeg"/></div><p class="mb mc gj gh gi md me bd b be z dk nz di oa ob translated">我被归类为鸽子取决于我手里拿着什么</p></figure></div><p id="5312" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在左边的照片上，我手里拿着棍子，我被归类为一只鸽子。在右边的照片中，同样的手，但是没有棍子，被归类为人类。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oc"><img src="../Images/e81759c7439bd81716d2a8f2b35f1c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R5EUBVx0eMOtFisrQ3NpOw.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">过滤网络第一层的地图</p></figure><p id="bacf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当我们从神经网络的第一层检索激活时，我们可以在右下角观察到手和棍子激活的过滤图。这样，我们可以对如何做出分类决策建立一些直觉。</p><p id="6b59" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我的下一步是收集棍子的图像，我拿着棍子，有棍子和没有棍子的鸽子。然后我根据新数据重新训练了模型。这让我在测试数据集上再次获得了大约 98%的准确率，在生产数据集上也是如此，但只是在接下来的 5 天内。之后，我不得不根据新收集的数据重新训练模型。这让我们了解到这个项目的主要内容:</p><blockquote class="od oe of"><p id="5b3a" class="kr ks ln kt b ku kv kd kw kx ky kg kz og lb lc ld oh lf lg lh oi lj lk ll lm im bi translated">为了开发强大的机器学习产品，数据科学家应该采取端到端的所有权。这不仅意味着在 jupyter 笔记本上培训模型，还意味着生产部署和产品的进一步支持和开发。</p></blockquote><p id="5977" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">不得不说，经过“模型备份→数据采集→数据标注→模型评估→模型再训练→生产部署”几个圈子，模型开始概化图像好了很多。最后，它学会了“鸟”的概念，鸽子回避系统开始从我的阳台上赶走各种各样的鸟，不仅仅是鸽子。</p><p id="21a6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">最后，这就是系统在生产中的工作方式:</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="oj nr l"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">一只鸽子落在阳台上，但几乎立即飞走了，因为它受到了运动的干扰</p></figure><h1 id="e7d3" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">观点</h1><p id="ce36" class="pw-post-body-paragraph kr ks it kt b ku nl kd kw kx nm kg kz la nn lc ld le no lg lh li np lk ll lm im bi translated">正如我们已经看到的，数据漂移对于在生产中运行的机器学习解决方案来说是一个严重的问题。因此，我希望自动化模型备份→数据收集→数据标记→模型评估→模型培训→生产部署的循环。为此，我计划使用云解决方案。这可能是未来文章的主题。</p></div><div class="ab cl ok ol hx om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="im in io ip iq"><p id="8f7b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">保持更新，如果你对这个项目有任何问题，请随时通过 LinkedIn 联系我。</p></div></div>    
</body>
</html>