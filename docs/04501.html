<html>
<head>
<title>Building a Simple ETL Pipeline with Python and Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 和 Google 云平台构建简单的 ETL 管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-simple-etl-pipeline-with-python-and-google-cloud-platform-6fde1fc683d5?source=collection_archive---------6-----------------------#2020-04-22">https://towardsdatascience.com/building-a-simple-etl-pipeline-with-python-and-google-cloud-platform-6fde1fc683d5?source=collection_archive---------6-----------------------#2020-04-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a69f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Google Cloud 函数从 FTP 服务器提取数据并加载到 BigQuery</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bd70d51cb3bc7d2f66810573b3acd726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uq8Am-We32dgc1P7xhDZBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://cloud.google.com/blog/products/gcp" rel="noopener ugc nofollow" target="_blank"> GCP </a></p></figure><p id="82c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有很多 ETL 工具，有时它们可能会让人不知所措，特别是当你只想将文件从 A 点复制到 b 点时。所以今天，我将向你展示如何使用<strong class="lb iu"> python 3.6 </strong>和谷歌云函数从 FTP 服务器提取 CSV 文件(提取)、修改(转换)并自动将其加载到谷歌 BigQuery 表(加载)。</p><p id="394e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文的最后，您将能够从 FTP 服务器提取一个文件，并在 Google Cloud 函数中使用 Python 将其加载到数据仓库中。</p><p id="d3e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将做以下工作:</p><ul class=""><li id="16b6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">设置云功能</li><li id="3561" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">提取数据</li><li id="79c8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">转换数据</li><li id="1cb3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">加载数据</li><li id="87a4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">自动化我们的管道</li></ul><h1 id="0e24" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">首先，什么是 ETL？</h1><blockquote class="nb"><p id="820e" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated">提取、转换、加载(ETL)是将数据从一个或多个源复制到目标系统的一般过程，目标系统以不同于源的方式或在不同于源的上下文中表示数据。—维基百科</p></blockquote><h1 id="c2ba" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz nl ka mv kc nm kd mx kf nn kg mz na bi translated"><strong class="ak">场景</strong></h1><p id="158b" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">在我们开始之前，让我给你一些背景信息。一家第三方服务提供商有一台 FTP 服务器，其中存储了多个 CSV 文件，每个文件都包含一家物流公司的日常交易数据。我们需要数据仓库中的数据，这样我们就可以在内部与利益相关者共享这些数据，并监控性能。</p><p id="238b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这家物流公司的基础设施团队每天从他们的数据库中导出一个 CSV 文件，并将其上传到 FTP 服务器。</p><p id="189c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的工作是每天从服务器上复制这些文件，对其进行清理，然后将其加载到我们的数据仓库中，这样我们就可以将其连接到其他数据源并对其进行分析。</p><p id="fc79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们的 ETL 管道图最终的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/8e853f98b5e7d5b60f9b7e1e479646ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*IodM_VTnXLiQWWmCvOstZg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用<a class="ae ky" href="https://www.lucidchart.com/pages/examples/uml_diagram_tool" rel="noopener ugc nofollow" target="_blank"> Lucidchart </a>创建</p></figure><p id="e91b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">Google Cloud Functions</strong>:<a class="ae ky" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">Cloud Functions</a>(CF)是 Google Cloud 的无服务器平台，用于执行响应特定事件的脚本，如 HTTP 请求或数据库更新。CF 的替代方案是<a class="ae ky" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>或<a class="ae ky" href="https://azure.microsoft.com/en-us/services/functions/" rel="noopener ugc nofollow" target="_blank"> Azure Functions </a>。</p><p id="80d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">设置您的云功能</strong></p><ul class=""><li id="3cf5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">进入云功能概述页面</a>。<br/>确保您启用了云功能的项目被选中。</li><li id="0f4f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">单击创建函数。</li><li id="db27" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">说出你的函数。</li><li id="c082" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在触发器字段中，选择 HTTP 触发器。</li><li id="7128" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在源代码字段中，选择内联编辑器。在本练习中，您将使用我们将要一起处理的<a class="ae ky" href="https://github.com/togobingi/google_cloud_function/blob/master/mysqlToBQ.py" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">代码</strong> </a>，以便您可以在编辑器中删除默认代码。</li><li id="6263" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用运行时下拉列表选择运行时。</li></ul><p id="6c82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保您的运行时设置为“Python 3.7”，并在“高级选项”下将区域更改为离您最近的区域。在撰写本文时，CF 并不是在每个谷歌数据中心区域都可用，所以请点击这里的<a class="ae ky" href="https://cloud.google.com/functions/docs/locations" rel="noopener ugc nofollow" target="_blank">查看哪里启用了云功能。</a></p><p id="ca03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成这些步骤后，您的显示应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/63eda6f772ba5615a57f61461daa2e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*3xqPHholmJqLnlUXQ7GsWg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a>的截图</p></figure><h2 id="7fca" class="nv mk it bd ml nw nx dn mp ny nz dp mt li oa ob mv lm oc od mx lq oe of mz og bi translated">我们的自定义代码</h2><p id="b493" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">一个云函数有两个文件；一个<em class="oh"> main.py </em>和一个<em class="oh"> requirements.txt </em>文件。后者托管我们脚本工作所需的所有文件依赖项，因此单击<em class="oh"> requirements.txt </em>选项卡，并确保编辑器中包含这些依赖项，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="44a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有依赖项的快速摘要:</p><ul class=""><li id="9d55" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">google-cloud-bigquery:这个库允许我们访问 bigquery 并与之交互</li><li id="df61" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">python-csv:这个库用于用 python 操作 csv 文件</li><li id="e522" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">requests:是一个用于发送 HTTP 请求的 HTTP 库，我们将需要它来访问 FTP URL。</li><li id="7ca9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">wget:用于从互联网下载文件</li><li id="10e8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">pytest-shutil:这用于 SSH 访问</li></ul><h1 id="076d" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">提取</h1><p id="84ed" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">现在在<em class="oh"> main.py </em>选项卡中，您可以开始包含下面的代码。看第 1 到 4 行。我们创建了一个名为“ftp_function”的函数，以后用 HTTP 请求访问云函数时会用到这个函数。然后，我们使用必要的凭证登录到 FTP 服务器，并导航到服务器上存储文件的适当目录。</p><p id="d73e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我工作的 FTP 服务器有多个 CSV 代表不同日期的事务数据。所以为了获得目录中最新的文件，我使用了从第 7 行到第 9 行的代码。</p><p id="b84e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其余的代码获取文件并下载它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><blockquote class="nb"><p id="d585" class="nc nd it bd ne nf ok ol om on oo lu dk translated">注意:要通过秘密管理器保护您的凭证，请遵循本<a class="ae ky" href="https://medium.com/geekculture/secure-your-credentials-in-google-cloud-functions-with-secret-manager-22a4a1b3788a" rel="noopener">指南</a>。</p></blockquote><h1 id="7895" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz nl ka mv kc nm kd mx kf nn kg mz na bi translated">改变</h1><p id="5b68" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">为了“转换”数据，我们将对刚刚下载的 CSV 文件做一个简单的更改。我们将简单地将 CSV 文件中每次出现的“FBA”更改为“AMAZON”。下面是代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><blockquote class="op oq or"><p id="62c3" class="kz la oh lb b lc ld ju le lf lg jx lh os lj lk ll ot ln lo lp ou lr ls lt lu im bi translated">这里也要注意，Google Cloud Function 有一个<code class="fe ov ow ox oy b"><em class="it">/tmp</em></code>目录，可以临时存放文件。该目录中的文件存储在实例的 RAM 中，因此写入<code class="fe ov ow ox oy b">/tmp</code>会占用系统内存。一旦实例停止运行，目录中的所有临时文件都将被删除。</p></blockquote><h1 id="64eb" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">负荷</h1><p id="9b45" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">现在，确保你<a class="ae ky" href="https://cloud.google.com/bigquery/docs/tables" rel="noopener ugc nofollow" target="_blank">创建了你的大查询表</a>。然后我们简单地使用下面的代码将转换后的 CSV 文件加载到您创建的 Bigquery 表中。因为我们启用了“<a class="ae ky" href="https://cloud.google.com/bigquery/docs/schema-detect" rel="noopener ugc nofollow" target="_blank">自动检测</a>”，所以 Bigquery 表在创建时不必有模式，因为它将基于 CSV 文件中的数据进行推断。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="6338" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您完成编写脚本时，您可以通过单击“创建”来部署云功能。当云功能部署成功时，您应该会看到一个绿色的复选标记，如下所示…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/52212df93fb1815c007b07c518e31f78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gmLKs7KgTyWLYrWfrsuZOg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://cloud.google.com/functions/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><h1 id="8d55" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">使自动化</h1><p id="e9a9" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">现在剩下要做的就是创建一个 cron 作业(Cloud Scheduler ),它将在某个预定义的时间间隔自动调用 CF。好消息是，在谷歌云平台上创建 cron jobs 非常简单，也是最简单的部分。你可以按照<a class="ae ky" href="https://cloud.google.com/scheduler/docs/creating" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">这里</strong> </a> <strong class="lb iu"> </strong>的指示或者复制下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/02a9c27ad765a353b05adc3f8ca97298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0Xj9KFqWWZ0au88s.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://cloud.google.com/functions/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/33ef24875a9b7202f6e7893ef28a0ce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G-wcUsBOoSsumU_3HpSn5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">截图自 GCP</p></figure><p id="f518" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的“频率”字段将在每天凌晨 1:59 运行我们的脚本。</p><blockquote class="nb"><p id="745b" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated">您可以使用这个很酷的<a class="ae ky" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">站点编辑器</a>来处理简单的 cron 调度表达式。</p></blockquote><p id="7d51" class="pw-post-body-paragraph kz la it lb b lc pc ju le lf pd jx lh li pe lk ll lm pf lo lp lq pg ls lt lu im bi translated">既然我们的数据已经存放在数据仓库中，我们可以将它连接到任何可视化工具并对其进行分析。</p></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><p id="03dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。希望这对你有帮助。这是一种非常简单的开发 ETL 的方法，任何人都可以在其上进行构建。</p></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><blockquote class="nb"><p id="a2fe" class="nc nd it bd ne nf ng nh ni nj nk lu dk translated"><em class="po">你可以</em> <a class="ae ky" href="https://medium.com/@tobisam/membership" rel="noopener"> <em class="po">成为中等会员</em> </a> <em class="po">享受更多这样的故事。</em></p></blockquote><p id="63a8" class="pw-post-body-paragraph kz la it lb b lc pc ju le lf pd jx lh li pe lk ll lm pf lo lp lq pg ls lt lu im bi translated">你可以在<a class="ae ky" href="https://github.com/togobingi/google_cloud_function" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> Github </strong> </a>上找到完整脚本的链接。</p></div></div>    
</body>
</html>