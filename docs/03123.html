<html>
<head>
<title>Building a k-NN Similarity Search Engine using Amazon Elasticsearch and SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon Elasticsearch和SageMaker构建k-NN相似性搜索引擎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-k-nn-similarity-search-engine-using-amazon-elasticsearch-and-sagemaker-98df18d883bd?source=collection_archive---------12-----------------------#2020-03-25">https://towardsdatascience.com/building-a-k-nn-similarity-search-engine-using-amazon-elasticsearch-and-sagemaker-98df18d883bd?source=collection_archive---------12-----------------------#2020-03-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c908" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建高效且可扩展的文档相似性搜索引擎的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/85f14983bb0a17c06ea4120cecd23166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djYJeZ7jVij-EByYnMJOig.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/CXDw96Oy-Yw" rel="noopener ugc nofollow" target="_blank"> NeONBRAND </a>在<a class="ae ky" href="https://unsplash.com/photos/CXDw96Oy-Yw" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="8406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">亚马逊Elasticsearch服务最近增加了对k近邻搜索的支持。它使您能够像运行任何常规的Elasticsearch查询一样轻松地在数千个维度上运行高规模和低延迟的k-NN搜索。</p><blockquote class="lv lw lx"><p id="d25a" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">k-NN相似性搜索由Elasticsearch开放发行版提供支持，这是一个Apache 2.0许可的Elasticsearch发行版。</p></blockquote><p id="5467" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将展示如何使用Amazon Sagemaker、Amazon Elasticsearch、Amazon Elastic File System (EFS)和Amazon ECS构建一个可扩展的相似性问题搜索api。</p><h1 id="6a0c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们将在本例中介绍的内容:</h1><ul class=""><li id="f992" class="mu mv it lb b lc mw lf mx li my lm mz lq na lu nb nc nd ne bi translated">在VPC部署并运行一个Sagemaker笔记本实例。</li><li id="0beb" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">将EFS装载到笔记本实例。</li><li id="7525" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">下载Quora问题对数据集，然后使用DistilBERT模型将数据集中的变长问题映射到定长向量。</li><li id="9804" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">创建下游任务以减少嵌入维数，并将句子嵌入器保存到EFS。</li><li id="e118" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">将问题文本转换为向量，并将所有向量索引到Elasticsearch。</li><li id="73c4" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">将容器化的Flask rest api部署到ECS。</li></ul><p id="cafe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了上述步骤的架构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/9e9a4bd49cab30eb7f2a71fcbf303a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_c2o6l_HqQcrnxIuNwySQ.png"/></div></div></figure><h1 id="5c50" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在VPC部署和运行Sagemaker笔记本实例</h1><p id="f245" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">首先，让我们创建一个连接到Elasticsearch的Sagemaker笔记本实例，并确保它们在同一个VPC中。</p><p id="76d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在<strong class="lb iu"> Sagemaker控制台中配置VPC选项，请在<strong class="lb iu">创建笔记本实例</strong>页面的<strong class="lb iu">网络</strong>部分的</strong>中，设置VPC网络配置详细信息，如VPC子网id和安全组id:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/425315ed52fbe7a2fae6395d49297ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6aaS4CeCnwhKEVQh2_oBg.jpeg"/></div></div></figure><h1 id="95a2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">将EFS安装到笔记本实例</h1><p id="c851" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们将在<strong class="lb iu"> SageMaker笔记本</strong>中完成所有必要的句子转换步骤(代码在 处找到<a class="ae ky" href="https://github.com/yai333/knnelasticsearch/blob/master/knn-search.ipynb" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">)。</strong></a></p><p id="2368" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，将EFS安装到<strong class="lb iu">型号</strong>目录，关于EFS的更多详情，请查看<a class="ae ky" href="https://docs.aws.amazon.com/efs/latest/ug/gs-step-two-create-efs-resources.html" rel="noopener ugc nofollow" target="_blank"> AWS官方文件</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6fc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注</strong>:</p><ul class=""><li id="90b4" class="mu mv it lb b lc ld lf lg li nr lm ns lq nt lu nb nc nd ne bi translated"><code class="fe nu nv nw nx b">fs-xxxxx.efs.ap-southeast-2.amazonaws.com</code>是EFS的DNS名称。</li><li id="afb5" class="mu mv it lb b lc nf lf ng li nh lm ni lq nj lu nb nc nd ne bi translated">EFS山目标和萨格马克在同一个VPC。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/a1e41870fc5b333d62248f26b826b976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pjsz05_yOIMn9AOO8d3sQQ.jpeg"/></div></div></figure><h1 id="01d2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用DistilBERT模型将变长问题映射到定长向量</h1><p id="55a1" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">要运行最近邻搜索，我们必须获得句子和标记嵌入。我们可以使用<a class="ae ky" href="https://github.com/UKPLab/sentence-transformers" rel="noopener ugc nofollow" target="_blank">句子变形器</a>，这是一个用PyTorch使用BERT/RoBERTa/distil BERT/ALBERT/XLNet的句子嵌入。它让我们只用几行代码就能把句子映射成固定长度的表示。</p><p id="7026" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用轻量级<strong class="lb iu"> DistilBERT </strong>模型<strong class="lb iu"> </strong>到<strong class="lb iu"> </strong>生成句子嵌入在这个例子中，请注意<strong class="lb iu"> DistilBERT </strong>的隐藏单元数量是768。这个维度对于Elasticsearch index来说似乎太大了，我们可以通过在合并后添加一个密集层来将维度减少到256:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="7af2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，将句子嵌入器保存到EFS安装的目录中:</p><pre class="kj kk kl km gt nz nx oa ob aw oc bi"><span id="1e0a" class="od md it nx b gy oe of l og oh">transformer.save("model/transformer-v1/")</span></pre><p id="a29c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要确保数据集已经下载，本例中的数据集是<code class="fe nu nv nw nx b"><a class="ae ky" href="https://www.kaggle.com/quora/question-pairs-dataset" rel="noopener ugc nofollow" target="_blank">quora question paris datas</a></code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="ce0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，将每个问题的全文提取到dataframe中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="06b7" class="od md it bd me oi oj dn mi ok ol dp mm li om on mo lm oo op mq lq oq or ms os bi translated">将问题文本转换为向量，并将所有向量编入索引以进行弹性搜索</h2><p id="4384" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">首先，创建一个kNN索引，</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="af24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后将问题向量转换并索引到Elasticsearch。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="f985" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">弹性搜索中的问题具有以下结构:</p><pre class="kj kk kl km gt nz nx oa ob aw oc bi"><span id="cf1b" class="od md it nx b gy oe of l og oh">{'question_vector': [-0.06435434520244598, ... ,0.0726890116930008],<br/>'question': 'How hard is it to learn to play piano as an adult?'}</span></pre><p id="de1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将问题嵌入到固定长度的向量中，并将所有向量编入索引以进行弹性搜索。让我们创建一个连接到Elasticsearch的rest api并进行测试！</p><h1 id="65a4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">部署容器化的Flask rest api</h1><p id="9433" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们将使用示例云形成模板在VPC创建ECS集群和服务(模板和bash脚本在<a class="ae ky" href="https://github.com/yai333/knnelasticsearch/tree/master/cf-templates" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">这里</strong> </a>)。</p><p id="c175" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用带有ECS 的<strong class="lb iu"> EFS卷，搜索流程为<strong class="lb iu"> 1) </strong> Flask应用程序将保存的句子嵌入器加载到EFS卷中，<strong class="lb iu"> 2) </strong>将输入参数句子转换为向量，<strong class="lb iu"> 3) </strong>然后在Elasticsearch中查询K-最近邻居。</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="8a04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经在ECS容器中运行了flask api，让我们使用基本的搜索功能来查找类似的问题，以进行查询:“<strong class="lb iu"> <em class="ly">在线赚钱的最佳方式是什么</em> </strong>？”：</p><pre class="kj kk kl km gt nz nx oa ob aw oc bi"><span id="fa07" class="od md it nx b gy oe of l og oh">$<strong class="nx iu">curl</strong> --data '<strong class="nx iu">question=What is best way to make money online?</strong>' --data '<strong class="nx iu">size=5</strong>' --data '<strong class="nx iu">min_score=0.3</strong>'  -X POST http://knn-s-publi-xxxx-207238135.ap-southeast-2.elb.amazonaws.com/search</span></pre><p id="330d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看结果:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="fed4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，结果是相当惊人的，你也可以微调你自己的句子嵌入方法，这样你就可以为k-NN搜索得到特定任务的句子嵌入。</p><p id="da1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！我们有我们需要的！我希望这篇文章对你有用。</p><p id="3105" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的脚本可以在我的<a class="ae ky" href="https://github.com/yai333/knnelasticsearch" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> GitHub repo </strong> </a>中找到。</p></div></div>    
</body>
</html>