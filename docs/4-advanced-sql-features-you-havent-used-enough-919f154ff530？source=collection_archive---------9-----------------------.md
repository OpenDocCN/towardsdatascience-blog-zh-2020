# 您尚未充分使用的 4 个高级 SQL 特性

> 原文：<https://towardsdatascience.com/4-advanced-sql-features-you-havent-used-enough-919f154ff530?source=collection_archive---------9----------------------->

![](img/d0d83b55cd3d413dde71a0d2f158063f.png)

萨法尔·萨法罗夫在 [Unsplash](https://unsplash.com/s/photos/code?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

## 数据科学

## 从分层查询的能力到 SQL 中过程结构的范围

SQL 是一种强大的语言。SQL 是你将要使用的大部分技术的一部分。对于开发人员来说，SQL 的使用可能仅限于在数据库中插入和检索数据，但对于数据分析师、数据科学家和数据工程师来说，它通常远不止于此。SQL 让您可以直接访问数据库——有大量的分析可以在那里完成——而无需从数据库中获取数据并将其加载到 pandas 或 PySpark 中。显然，由于资源的原因，您在数据库中所能做的事情是有限的。

根据我多年来的观察，使用 R、Julia 或 Python 等统计编程语言的人倾向于用这种语言做几乎所有的事情，而有些事情实际上用 SQL 有时会更有效。除了基本的选择、插入、更新、连接和子查询之外，SQL 还有许多高级特性可用于数据分析，但我们并没有充分利用这些特性。

在 KDNuggets 上有一个帖子说这是[你进行数据分析](https://www.kdnuggets.com/2019/10/last-sql-guide-data-analysis-ever-need.html)需要的最后一个指南。虽然这是一份写得很好的指南，但我认为它绝对是**而不是**你进行数据分析所需的最后一份指南。你需要知道更多。我要说的是，你现在正在阅读的 Medium 帖子也不是你成为 SQL 高手所需的最后指南。这里只讨论了 SQL 的一些被忽视、未被充分利用但却很强大的特性。让我们继续讨论其中的一些。

# 分层查询

像 Oracle 这样的企业关系数据库很久以前就开始支持分层数据的存储和检索。在 MySQL 8 发布之前，MySQL 可能是少数几个不支持直接查询分层数据的数据库之一。在过去的几年里，当我在 MySQL 中实现分层存储时，我不得不多次参考 Mike Hillyer 的这篇文章。这是一本很棒的读物。

想想看，分层数据无处不在——产品的类别和子类别以及进一步的子类别、组织结构、动物和植物物种、家谱等等。普通的 SQL 特性不足以高效地查询分层数据，因为这会导致大量的子查询(和混乱)。在 MySQL 5.7 或更早的版本中，您会使用一种叫做会话变量的东西来进行分层查询，而在 MySQL 8 或更高版本以及其他数据库中，您会使用递归公共表表达式。

> 分层数据无处不在——产品类别和子类别、组织结构、家谱等等。

我会给你一些这方面的背景。一天，一位前同事打电话给我，问我如何在 MySQL 5.7 上运行分层查询——直到这个版本的 MySQL 不支持公共表表达式。所以，下面是这个查询的样子。现在让我们来谈谈 cte😄

MySQL 8.0 之前的 MySQL 中的分层查询示例

# 递归公用表表达式

被亲切地称为 CTE，这是一个非常强大的构造，所有主要的关系数据库(包括大多数关系数据仓库)都支持它。它本质上减少了在一个查询中编写另一个查询的需要，即嵌套子查询。CTE 本质上是在查询范围内定义的视图。CTE 不以数据库对象的形式存在，而是作为查询的一部分存在。cte 对于可读性也非常好(如果做得好的话)。

> CTE 本质上是在查询范围内定义的视图。

不久前，我写了一篇关于使用 SQL 生成随机数据的文章，并在一些查询中使用了 cte。你可以在这里快速浏览一下[。同样，递归 CTE 就像一个调用自身的递归函数或方法。想象一个树形数据结构，开始解析并一直解析到一个叶子节点。也就是使用递归 cte 查询的数据的递归性。](/generating-test-data-using-sql-2a1162f5ef16)

在 MariaDB 中使用递归 cte

# 窗口功能

SQL 中最常用的分析函数是聚合函数。SQL 中的聚合函数与`GROUP BY`子句一起作用于整个数据集或数据集的一部分，而窗口函数扩展了聚合函数的功能，不仅仅是计算基本的聚合。窗口函数提供了对数据集和部分数据集进行二级聚合&汇总操作的能力，可选地具有移动窗口和其他有趣的功能。这给了我们计算的机会，比如

*   过去七个工作日的销售移动平均值
*   月收入累计

这给了我们在 SQL 中分析数据的强大能力，而不需要将数据带到外面的 pandas 或 PySpark 中进行处理。

在没有定义任何窗口的情况下，这里有一些可以加窗的基本分析函数。

> *表定义可以在 dataset 中找到—* [*NASA 喷气推进实验室*](https://www.jpl.nasa.gov/) *编译成* [*GitHub 项目*](https://devstronomy.com/#/) *由*[*devstrology*](https://github.com/devstronomy/)*。*

这里有一篇关于 SQL 中窗口函数的很有深度的文章。如果你感兴趣的话，一定要读一读。

[](https://mode.com/sql-tutorial/sql-window-functions/) [## SQL 窗口函数|高级 SQL 模式分析

### 从这里开始？本课是使用 SQL 进行数据分析的完整教程的一部分。看看开头…

mode.com](https://mode.com/sql-tutorial/sql-window-functions/) 

# 过程语言

在之前的一篇文章中，我写了关于 SQL 的多种风格

> *衡量您的 SQL 风格有多强大的一个方法是，浏览数据库提供的全部特性集，并找出您的* [*SQL 风格是否完全符合*](https://en.wikipedia.org/wiki/Turing_completeness) *。但是，即使是图灵完整的 SQL 也不能保证处理查询 DSL 允许但架构不允许的特定用例。由于这个原因，存在如此多种风格的数据库/SQL。*

一些主要的关系数据库提供的对 SQL 的过程语言扩展使它们变成了完整的语言。一些扩展是 PL/SQL、T-SQL 和 plgsql。过程语言允许您访问成熟编程语言中可用的大量结构，这些结构本身就在数据库中。例如，在 SQL 的过程版本中，您将能够编写循环结构，您将能够使用函数和过程编写结构化程序，您将能够访问许多数据类型和数据结构，您将能够进行面向对象的编程。

您可以想象，使用完整的编程语言的特性，直接在 SQL 中访问数据，而不用将数据推送到外部系统，可以完成很多工作。这样做不仅去除了额外的一层，还节省了移动数据所花费的大量网络时间。

# 结论

[我们可以谈论 SQL 的更多强大功能](https://linktr.ee/kovid)，但是根据我的经验，我觉得我所观察和共事的许多人(和团队)都没有充分利用其中的一些功能，其中也包括数据库工程师！