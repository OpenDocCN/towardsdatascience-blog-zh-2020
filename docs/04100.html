<html>
<head>
<title>Pandas Pivot — The Ultimate Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫支点——终极指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-pivot-the-ultimate-guide-5c693e0771f3?source=collection_archive---------4-----------------------#2020-04-15">https://towardsdatascience.com/pandas-pivot-the-ultimate-guide-5c693e0771f3?source=collection_archive---------4-----------------------#2020-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5d49" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你一直想知道但不敢问的关于熊猫的一切。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eca52ead0ae45a9df02fc91678b94699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cDZPGihPn4ubHsO-"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯蒂安·弗雷南在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="93ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated">andas pivot 是每个数据科学家的必备工具。有些人每天都使用它，有些人避免使用它，因为它看起来很复杂。我在后一组呆了很长时间。在我花时间做了一些研究后，我觉得我浪费了很多时间来编写不必要的代码。令我惊讶的是，我已经知道熊猫的主要组成部分了。这比看起来要简单。</p><p id="e60b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">这里有几个你可能会感兴趣的链接:</strong></p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="a134" class="mj mk it mf b gy ml mm l mn mo">- <a class="ae ky" href="https://trymito.io/" rel="noopener ugc nofollow" target="_blank">Complete your Python analyses 10x faster with Mito</a> [Product]</span><span id="cf78" class="mj mk it mf b gy mp mm l mn mo">- <a class="ae ky" href="https://aigents.co/skills" rel="noopener ugc nofollow" target="_blank">Free skill tests for Data Scientists &amp; ML Engineers</a> [Test]</span><span id="1e41" class="mj mk it mf b gy mp mm l mn mo">- <a class="ae ky" href="https://imp.i115008.net/c/2402645/1116216/11298" rel="noopener ugc nofollow" target="_blank">All New Self-Driving Car Engineer Nanodegree</a><strong class="mf iu"> </strong>[Course]</span></pre><p id="9b53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你愿意阅读更多这样的文章吗？如果是这样，你可以点击上面的任何链接来支持我。其中一些是附属链接，但你不需要购买任何东西。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="b206" class="my mk it bd mz na nb nc nd ne nf ng nh jz ni ka nj kc nk kd nl kf nm kg nn no bi translated"><strong class="ak">什么是数据透视表？</strong></h1><p id="d801" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">数据透视表是一个统计表，它汇总了一个更广泛的表中的数据。实际上，数据透视表是根据值的细分来计算统计数据的。对于第一列，它将值显示为行，第二列显示为列。</p><p id="1e3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看一个数据透视表的例子，它根据水果和顾客的分类来计算总和统计:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/c80290efea3dcd42364d87b333b880bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FgARl-K9AnW3QBlYxeqZ9Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">左边的表是右边数据透视表的基表。</p></figure><h1 id="6192" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">我如何能在熊猫里旋转一张桌子？</h1><p id="9619" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">Pandas 有一个 pivot_table 函数，它在数据帧上应用透视。它还支持 aggfunc，该函数定义旋转时要计算的统计数据(aggfunc 默认为 np.mean，它计算平均值)。我在下面的例子中使用总和。</p><p id="d4d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们定义一个数据帧并应用 pivot_table 函数。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="73d9" class="mj mk it mf b gy ml mm l mn mo">df = pd.DataFrame(<br/>    {<br/>        "fruit": ["apple", "orange", "apple", "avocado", "orange"],<br/>        "customer": ["ben", "alice", "ben", "josh", "steve"],<br/>        "quantity": [1, 2, 3, 1, 2],<br/>    }<br/>)</span></pre><p id="5819" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想有一个水果行(指定索引)和列(指定列)的客户细分。对于每一项，我想计算数量的总和。结果与上表相同。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="75fc" class="mj mk it mf b gy ml mm l mn mo">df.pivot_table(index="fruit", columns="customer", values="quantity", aggfunc=np.sum)</span></pre><h1 id="e81e" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">为什么我在透视时得到一个值错误？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/71f64609bf7b9e7cdd0464cff09b915b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*gsWUUVhC40OSNQao.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Gif 来自<a class="ae ky" href="https://giphy.com/gifs/in-name-last-h4Z6RfuQycdiM" rel="noopener ugc nofollow" target="_blank"> giphy </a></p></figure><p id="8356" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最可能的原因是您使用了 pivot 函数而不是 pivot_table。这让我困惑了很多次。Pandas pivot 函数是一个功能不太强大的函数，它不需要聚合就可以处理非数字数据。</p><p id="2235" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出现错误“值错误:索引包含重复条目，无法重新整形”,因为您的 DataFrame 中有重复条目。如果我要透视上面的数据帧，我会得到同样的错误，因为 apple 和 ben 是重复的，并且透视函数不聚合。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/58b1cba5a89b6e5d9b0bb8bb5cd12466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bHceWHv5Rg0QoXKK.png"/></div></div></figure><p id="6426" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我浏览 pivot 函数的<a class="ae ky" href="https://github.com/pandas-dev/pandas/blob/master/pandas/core/reshape/pivot.py#L427" rel="noopener ugc nofollow" target="_blank"> pandas 源代码时，它帮助我理解了这个问题。基本上，它的功能与下面的命令相同:</a></p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="c040" class="mj mk it mf b gy ml mm l mn mo">df.set_index(["fruit", "customer"])["quantity"].unstack()</span></pre><h1 id="fb21" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">旋转时实际上发生了什么操作？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/75213fadb8f486d9edb2c775d2419e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*1GVfp05xS71s3iZs.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Gif 来自<a class="ae ky" href="https://giphy.com/gifs/gets-smart-question-vQqeT3AYg8S5O" rel="noopener ugc nofollow" target="_blank"> giphy </a></p></figure><p id="e6c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">起初，旋转对你来说似乎是一个难以理解的概念。但是如果我告诉你你一直都在使用它——至少是熊猫旋转的核心命令。让我们看看下面的命令:</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="1427" class="mj mk it mf b gy ml mm l mn mo">df.groupby(['fruit', 'customer']).quantity.sum().unstack()</span></pre><p id="b3b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你在熊猫用过 groupby 功能吗？sum 命令呢？什么事？我想是的。上述命令的输出与 pivot_table 的输出相同。</p><p id="60a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我没有多次使用过拆分，但它基本上可以将多索引拆分成列，如下图所示</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/92ea6499ac7f4a02b5e21ccd32663ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2z0Hs3a1sT3dCDGMfAeQ7A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">拆垛操作</p></figure><h1 id="0e52" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">如何将缺失值设置为 0？</h1><p id="3a0a" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">不要再说了！pivot_table 有一个 fill_value 参数来替换缺少的值。默认情况下没有。让我们试一试。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="ac5d" class="mj mk it mf b gy ml mm l mn mo">df.pivot_table(index="fruit", columns="customer", values="quantity", aggfunc=np.sum, fill_value=0)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/ad88c065a396e03f6f377b1a69e698c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RbHLwkpL9R2rshqkOPyIRA.png"/></div></div></figure><h1 id="6e10" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">我可以同时计算多个统计数据吗？</h1><p id="efbb" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">pivot_table 函数的参数 aggfunc 采用函数列表。让我们用和与平均来试试。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="4866" class="mj mk it mf b gy ml mm l mn mo">df.pivot_table(index="fruit", columns="customer", values="quantity", aggfunc=[np.sum, np.mean], fill_value=0)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/8d35e68c22554ee347d9d058f7b8f866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eBCcZnFUINnw3CDo-BYthQ.png"/></div></div></figure><h1 id="f01c" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">我可以同时聚合多个值吗？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/886a6d541de10243401271df0e67fc4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/0*pdczznQC3YoBdZPx.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Gif 来自<a class="ae ky" href="https://giphy.com/gifs/doctor-who-guitar-peter-capaldi-wCiFka9RsSW9W" rel="noopener ugc nofollow" target="_blank"> giphy </a></p></figure><p id="55f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以！与 aggfunc 参数类似，values 参数接受列名列表。让我们给数据框架添加一个价格列。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="1676" class="mj mk it mf b gy ml mm l mn mo">df['price'] = [0.1, 0.2, 0.1, 0.4, 0.15]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/c3268fb02806de60948d8bc64b75fcc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Frgi3q_uORVR1CC0Z6c0dw.png"/></div></div></figure><p id="01d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有两列值，让我们应用 pivot_table 函数:</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="28c7" class="mj mk it mf b gy ml mm l mn mo">df.pivot_table(index="fruit", columns="customer", values=["quantity", "price"], aggfunc=np.mean, fill_value=0)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/e1865131573050974a426747c727347a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vh8kfoY2CGkH0N8iJuiMFw.png"/></div></div></figure><h1 id="0afb" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">我可以进一步细分行/列吗？</h1><p id="5dba" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">答案还是肯定的。参数 index 和 column 都采用列表。让我们将水果的来源列添加到数据框架中。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="883f" class="mj mk it mf b gy ml mm l mn mo">df['origin'] = ['italy', 'spain', 'spain', 'mexico', 'portugal']</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/9c7dc0be3a418c6449106d171613c4b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_VAIDPZi_skXApXfb-Pf3g.png"/></div></div></figure><p id="591b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们按行和按列对水果和产地进行细分。</p><pre class="kj kk kl km gt me mf mg mh aw mi bi"><span id="d889" class="mj mk it mf b gy ml mm l mn mo">df.pivot_table(<br/>    index=["fruit", "origin"],<br/>    columns=["customer"],<br/>    values=["quantity"],<br/>    fill_value=0,<br/>    aggfunc=np.mean,<br/>)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/52669591395bd6af22563364506b5b84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VYnHiOZvt4rsddMvN5s3XQ.png"/></div></div></figure><p id="85aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它就像一个魔咒！</p><h1 id="c132" class="my mk it bd mz na nv nc nd ne nw ng nh jz nx ka nj kc ny kd nl kf nz kg nn no bi translated">在你走之前</h1><p id="dea3" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">在<a class="ae ky" href="https://twitter.com/romanorac" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，在那里我定期<a class="ae ky" href="https://twitter.com/romanorac/status/1328952374447267843" rel="noopener ugc nofollow" target="_blank">发布关于数据科学和机器学习的</a>消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/b5d426b68cc5a21b1a35d0a157ebc4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*69rP1pwjJi9mLSFE"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@cmhedger?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Courtney hedge</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div></div>    
</body>
</html>