<html>
<head>
<title>Improve your Data Science Pipelines with Config Files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用配置文件改善您的数据科学管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/improve-your-data-science-pipelines-with-config-files-3cadc1ac220d?source=collection_archive---------12-----------------------#2020-02-21">https://towardsdatascience.com/improve-your-data-science-pipelines-with-config-files-3cadc1ac220d?source=collection_archive---------12-----------------------#2020-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/35f12eeee0cd5aec1d6b2d638141fd49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*XFLym3XaVV4mih7wGomwGw.png"/></div></figure><p id="f784" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在过去的几个月里，我一直在用Python编写数据管道，为一个机器学习项目准备训练数据。为了试验不同版本的数据，有必要通过将用户定义的参数传递到管道的不同步骤来使管道尽可能灵活。在本文中，我将向您展示更好地将参数传递到数据管道所需的步骤。</p><p id="6eeb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一个期望的功能是能够容易地使用管道来生成数据集的不同版本。这些版本通常在以下方面有所不同:</p><ul class=""><li id="dcff" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">用于计算特征的操作</li><li id="c2f9" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">要包括在特征计算中的数据子集，以及</li><li id="0d5f" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">将包含最终特征值的目标文件或表。</li></ul><p id="08cd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">管道的早期迭代面临一些挑战:</p><p id="20a1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">1.我如何轻松地指定要设置哪些参数，以确保我以最小的出错几率执行正确的操作？</p><p id="b343" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">2.一旦管道完成执行，我如何快速返回并检查哪个数据集是使用哪个参数创建的？</p><p id="c3c1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我很快意识到最重要的问题是无法跟踪传递给管道组成模块的大量硬编码参数。为了改进我们繁琐而低效的方法，我从软件工程师那里得到了启示(这在处理大规模数据科学项目时非常有用),并修改了管道设计以使用配置文件。</p><p id="42a2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在本文的剩余部分，我将回答以下问题:</p><p id="f0d7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">1.什么是配置文件？</p><p id="3f4c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">2.如何将配置文件加载到Python脚本中？</p><p id="cc5b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">3.我如何利用配置的内容？</p><p id="fb97" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">通过遵循下面的例子并利用配置文件，您将拥有更健壮、更易于维护的代码。</p><h1 id="9295" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">树立一个榜样。</h1><p id="515f" class="pw-post-body-paragraph jx jy it jz b ka mh kc kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku im bi translated">在我们深入技术细节之前，让我描述一下示例场景，它将阐明我们将要讨论的要点。假设我们有一个存储为CSV文件的数据集(参见<a class="ae mm" href="https://github.com/andrew-alberts/config-pipe/blob/master/data.csv" rel="noopener ugc nofollow" target="_blank"> Github </a>中的数据),它详细描述了客户执行的交易，并按项目细分。</p><figure class="mo mp mq mr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mn"><img src="../Images/9ea48dfeea4927710b292d9ad7b6c064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dcSoLC6dbDGEuooKd88ySg.png"/></div></div><p class="mw mx gj gh gi my mz bd b be z dk translated">我们示例数据的前十行。</p></figure><p id="43c0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们希望编写代码，将原始形式的数据处理成具有客户级别功能的记录；我们称之为<em class="na">管道</em>。为了达到这个目标，我们有一些中间阶段。首先，我们需要在事务级别聚合所有项目。其次，我们需要将交易记录聚合到客户级别。</p><p id="0c4e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">除了多个阶段，我们还预计每个阶段的处理会根据业务需求而有所不同。对于事务级别的聚合，我们希望能够过滤掉某个价格范围之外的项目。我们还想以可修改的税率计算这些商品的已付税款。对于客户级别的聚合，我们需要能够根据日期过滤交易。我们还希望能够试验如何通过交易总数或每个客户购买的商品数量来标准化商品的总成本。在管道的两个阶段，我们都需要能够指定源数据以及将结果保存到文件中。</p><figure class="mo mp mq mr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nb"><img src="../Images/dc742a96104d68e59a1e8cb34d29905f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XpPdpZgwCCJsPFCf1ChVeA.png"/></div></div></figure><p id="f1da" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">上述两个阶段是作为Python函数实现的。对于交易阶段:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="13e5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">请注意，该代码包含日期范围的筛选器，并根据tax_rate计算final_price。每个客户交易记录都有日期、总价和交易中购买的商品数量。</p><p id="6392" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">对于客户阶段:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="c183" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这里，计算诸如max_price、total_price和num_items之类的特征。为total_price选择规范化的逻辑也在这里。</p><p id="cac6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">调用管道的代码在脚本的末尾。请注意函数的硬编码参数:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="6241" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">什么是配置文件？</h1><p id="b942" class="pw-post-body-paragraph jx jy it jz b ka mh kc kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku im bi translated">配置文件指定应用程序的参数。这些参数通常以键值对格式编写，本质上是在参数名和该参数的关联值之间创建一个赋值。将参数值放在一个文件中可以提供一个集中的、组织良好的位置来指定应该将什么参数传递给程序。我们希望在配置中包含的数据管道参数示例包括:</p><ul class=""><li id="bbed" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">数据源位置</li><li id="d511" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">阈值和过滤值</li><li id="3069" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">要选择的列列表</li><li id="bd69" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">特殊控制标志。</li></ul><p id="722f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们以<a class="ae mm" href="https://learnxinyminutes.com/docs/json/" rel="noopener ugc nofollow" target="_blank"> JSON </a>的格式描述这两个阶段，以便事务和客户级别的聚合将它们的参数指定为键值对:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f91f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们将把这个文件保存为config.json。</p><p id="7fcc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">请注意，函数参数值与我们在配置中输入的值非常接近。除了<strong class="jz iu"> <em class="na"> None </em> </strong>值变为<strong class="jz iu"> <em class="na"> null </em> </strong>之外，其余参数保持其类型。</p><p id="70d2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">随着我们继续这个例子，我们将使用JSON格式的配置，但是您可以探索其他适合您需要的格式(例如<a class="ae mm" href="https://learnxinyminutes.com/docs/yaml/" rel="noopener ugc nofollow" target="_blank"> YAML </a>或<a class="ae mm" href="https://learnxinyminutes.com/docs/xml/" rel="noopener ugc nofollow" target="_blank"> XML </a>)。</p><h1 id="d6be" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">如何将配置文件加载到Python脚本中？</h1><p id="6046" class="pw-post-body-paragraph jx jy it jz b ka mh kc kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku im bi translated">现在我们已经在配置中为我们的步骤指定了参数，我们将使用两个模块将数据从JSON文件中取出并放入程序中。为此，我们将导入两个Python库:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="8996" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们通过命令行界面运行Python脚本时，argparse库允许我们指定配置文件的名称。</p><p id="5af0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">json库用于将我们的配置内容从JSON格式转换成Python对象。</p><p id="dbc9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在__main__中，我们使用argparse来使用配置文件的绝对路径，并使用json来解码文件内容:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="85e0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">从配置中传递程序设置现在就像运行<em class="na">python pipeline . py-c config . py</em>一样简单</p><h1 id="e11e" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">我如何利用配置的内容？</h1><p id="8aa1" class="pw-post-body-paragraph jx jy it jz b ka mh kc kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku im bi translated">此时，我们已经将JSON文件的内容作为Python字典加载了(在我们的代码中方便地称为“config”)。</p><p id="a4f8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">回想一下，我们拆分了配置，这样管道的每一步都由一个字典来表示，该字典映射处理阶段的名称以及该阶段的相关参数。在管道的Python代码中，我们用一个函数来表示处理的每个阶段。请注意，配置中的阶段参数与函数参数名称相匹配。这很方便，因为对于配置中的每个阶段，我们可以使用**运算符提取每个处理阶段的参数:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="a24c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是一种过于简单的方法，但是您可以将这种设计扩展到更复杂的管道，这些管道可能跨越许多源文件。如果您的管道步骤需要运行多个Python脚本，您仍然可以使用统一的配置文件，但是只选择您在每个步骤中需要的配置部分。</p><p id="a9c3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在本文中，我们研究了一种利用配置文件设计Python管道的方法。尽管它很简单，但这一功能帮助我们更清楚地了解管道的处理过程，并让我们对训练模型所用的数据充满信心。查看本文的代码<a class="ae mm" href="https://github.com/andrew-alberts/config-pipe" rel="noopener ugc nofollow" target="_blank">这里</a>开始在您自己的数据科学管道中实施配置！</p></div></div>    
</body>
</html>