<html>
<head>
<title>Getting started with Apache Avro and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Avro 和 Python 入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-apache-avro-and-python-59239ae7f5e?source=collection_archive---------6-----------------------#2020-08-06">https://towardsdatascience.com/getting-started-with-apache-avro-and-python-59239ae7f5e?source=collection_archive---------6-----------------------#2020-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a53e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何创建和使用基于 Apache Avro 的数据，以便在 Python 应用程序中更好、更高效地传输数据</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9fd66b41f4ef2eff9d45b6935cb7160e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SABnYfT-DtAuwGOgkqs79g.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">https://unsplash.com/photos/LqKhnDzSF-8<a class="ae kv" href="https://unsplash.com/photos/LqKhnDzSF-8" rel="noopener ugc nofollow" target="_blank"/></p></figure><p id="770f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将谈论<a class="ae kv" href="https://avro.apache.org/docs/current/" rel="noopener ugc nofollow" target="_blank"> Apache Avro </a>，这是一个开源数据序列化系统，被 Spark、Kafka 和其他工具用于大数据处理。</p><h1 id="6b10" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是阿帕奇 Avro</h1><p id="8f68" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">根据维基百科:</p><blockquote class="mp mq mr"><p id="13e4" class="kw kx ms ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">Avro 是在 Apache 的 Hadoop 项目中开发的面向行的远程过程调用和数据序列化框架。它使用 JSON 来定义数据类型和协议，并以紧凑的二进制格式序列化数据。它的主要用途是在 Apache Hadoop 中，可以为持久数据提供序列化格式，为 Hadoop 节点之间的通信以及从客户端程序到 Hadoop 服务的通信提供有线格式。Avro 使用一个模式来组织被编码的数据。它有两种不同类型的模式语言；一个用于人工编辑(Avro IDL ),另一个基于 JSON，更适合机器阅读。[3]</p></blockquote><p id="69a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基本上，Avro 是由 Hadoop 之父 Doug Cutting 开发的独立于语言的数据序列化系统。在我进一步讨论 Avro 之前，请允许我简单讨论一下<em class="ms">数据序列化</em>及其优势。</p><h1 id="9cf3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是数据序列化和反序列化</h1><p id="98b2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">数据序列化是将复杂对象(<em class="ms">数组、字典、列表、类对象、JSON 等</em>)转换成字节流的过程，这样它们就可以被存储或转移到其他机器上。在具有不同体系结构、硬件或操作系统的计算机之间传输数据时进行数据序列化的原因。一旦数据在另一端被接收到，它就可以被还原回原来的形式。这个过程被称为<em class="ms">反序列化</em>。</p><p id="1965" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你知道它是关于什么的了，让我们深入研究并使用一些代码。</p><h1 id="d7a3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">开发和安装</h1><p id="dc63" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Python 应用程序中目前使用了两个库。一个简单地叫做<code class="fe mw mx my mz b">avro</code>，你可以在这里访问<a class="ae kv" href="https://avro.apache.org/docs/1.10.0/gettingstartedpython.html" rel="noopener ugc nofollow" target="_blank">。而另一个是</a><a class="ae kv" href="https://github.com/fastavro/fastavro" rel="noopener ugc nofollow" target="_blank"> FastAvro </a>号称比上一个更快。两者的工作原理是一样的。因为我们正在做一个玩具例子，所以前面的库对我们来说已经足够了。因此，总是使用典型的<em class="ms"> pip </em>工具来安装它:</p><p id="e733" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mw mx my mz b">pip install avro</code></p><h1 id="af85" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Avro 模式</h1><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="f261" class="ne lt iq mz b gy nf ng l nh ni">{"namespace": "me.adnansiddiqi",<br/> "type": "record",<br/> "name": "User",<br/> "fields": [<br/>     {"name": "name", "type": "string"},<br/>     {"name": "age",  "type": ["int", "null"]},<br/>     {"name": "gender", "type": ["string", "null"]}<br/> ]<br/>}</span></pre><p id="3b8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Apache Avro 格式实际上是一种 JSON 结构。你可以说 Avro 格式实际上是一个 JSON 数据结构和一个用于验证目的的模式的组合。因此，在我们创建扩展名为<code class="fe mw mx my mz b">.avro</code>的 Avro 文件之前，我们将创建它的模式。</p><p id="0da4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，我已经想出了一个模式，上面是一个 JSON 结构。我们将首先提到名称空间。它只是一个字符串。通常，它遵循 Java 打包命名约定使用的相同格式，这是域名的反码，但不是必需的。这里我提到了我的博客网址的反面。在那之后你提到了你的模式的类型，这里它是<code class="fe mw mx my mz b">record</code>类型。还有其他类型的也像<code class="fe mw mx my mz b">enum</code>、<code class="fe mw mx my mz b">arrays</code>等。之后，我们提到模式的名字，这里是<code class="fe mw mx my mz b">User</code>。下一个是<code class="fe mw mx my mz b">field</code>项，可以是一个或多个。它有必填字段<code class="fe mw mx my mz b">name</code>和<code class="fe mw mx my mz b">type</code>以及可选字段<code class="fe mw mx my mz b">doc</code>和<code class="fe mw mx my mz b">alias</code>。<code class="fe mw mx my mz b">doc</code>字段用于记录您的字段，而<code class="fe mw mx my mz b">alias</code>用于给字段一个不同于<code class="fe mw mx my mz b">name</code>中提到的名称。到目前为止一切顺利。我们创建的模式将保存在一个名为<code class="fe mw mx my mz b">users.avsc</code>的文件中。</p><p id="0a5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将编写从模式文件中读取模式的代码，然后在 Avro 文件中添加一些记录。稍后，我们将检索记录并显示它们。让我们写代码吧！</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="55a8" class="ne lt iq mz b gy nf ng l nh ni">import avro.schema<br/>from avro.datafile import DataFileReader, DataFileWriter<br/>from avro.io import DatumReader, DatumWriter</span><span id="0251" class="ne lt iq mz b gy nj ng l nh ni">schema = avro.schema.parse(open("user.avsc").read())</span><span id="fc2c" class="ne lt iq mz b gy nj ng l nh ni">writer = DataFileWriter(open("users.avro", "wb"), DatumWriter(), schema)<br/>writer.append({"name": "Alyssa", "age": 25,"gender":"female"})<br/>writer.append({"name": "Ahmad", "age": 35,"gender":"male"})<br/>writer.close()</span><span id="a69d" class="ne lt iq mz b gy nj ng l nh ni">reader = DataFileReader(open("users.avro", "rb"), DatumReader())<br/>for user in reader:<br/>    print(user)<br/>    print('===================')<br/>reader.close()</span></pre><p id="0e34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">导入必要的模块后，我要做的第一件事就是读取模式文件。<code class="fe mw mx my mz b">DatumWriter</code>负责将数据翻译成 Avro 格式 w.r.t 输入模式。<code class="fe mw mx my mz b">DataFileWriter</code>负责将数据写入文件。插入几条记录后，我们关闭编写器。<code class="fe mw mx my mz b">DataFileReader</code>的工作方式类似，唯一的区别是<code class="fe mw mx my mz b">DatumReader()</code>负责存储在<code class="fe mw mx my mz b">users.avro</code>中的数据的反序列化，然后使其可用于显示。当您运行代码时，它将显示如下:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="5271" class="ne lt iq mz b gy nf ng l nh ni">python play.py<br/>{'name': 'Alyssa', 'age': 25, 'gender': 'female'}<br/>===================<br/>{'name': 'Ahmad', 'age': 35, 'gender': 'male'}</span></pre><p id="e103" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">到目前为止还好吗？现在让我们对模式做一点改变。我将<code class="fe mw mx my mz b">age</code>字段更改为<code class="fe mw mx my mz b">dob</code>，当我运行时，它显示以下错误:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="efdf" class="ne lt iq mz b gy nf ng l nh ni">python play.py<br/>Traceback (most recent call last):<br/>  File "play.py", line 8, in &lt;module&gt;<br/>    writer.append({"name": "Alyssa", "age": 25,"gender":"female"})<br/>  File "/Users/AdnanAhmad/Data/anaconda3/lib/python3.7/site-packages/avro/datafile.py", line 303, in append<br/>    self.datum_writer.write(datum, self.buffer_encoder)<br/>  File "/Users/AdnanAhmad/Data/anaconda3/lib/python3.7/site-packages/avro/io.py", line 771, in write<br/>    raise AvroTypeException(self.writer_schema, datum)<br/>avro.io.AvroTypeException: The datum {'name': 'Alyssa', 'age': 25, 'gender': 'female'} is not an example of the schema {<br/>  "type": "record",<br/>  "name": "User",<br/>  "namespace": "me.adnansiddiqi",<br/>  "fields": [<br/>    {<br/>      "type": "string",<br/>      "name": "name"<br/>    },<br/>    {<br/>      "type": [<br/>        "int",<br/>        "null"<br/>      ],<br/>      "name": "dob"<br/>    },<br/>    {<br/>      "type": [<br/>        "string",<br/>        "null"<br/>      ],<br/>      "name": "gender"<br/>    }<br/>  ]<br/>}</span></pre><p id="bf3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">很酷，不是吗？同样，如果你改变了数据，它会尖叫着告诉你把事情弄好。</p><h1 id="ba96" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="1916" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我希望您已经了解了一些关于 Apache Avro 的知识，以及 Python 如何让您使用它跨设备和系统传输数据。我只是触及了它的表面，还有更多关于它的内容。Avro 也被阿帕奇 Spark T1 和 T2 Kafka T3 大量用于数据传输。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="1d73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ms">原载于 2020 年 8 月 6 日</em><a class="ae kv" href="http://blog.adnansiddiqi.me/getting-started-with-apache-avro-and-python/" rel="noopener ugc nofollow" target="_blank"><em class="ms">http://blog . adnansiddiqi . me</em></a><em class="ms">。</em></p></div></div>    
</body>
</html>