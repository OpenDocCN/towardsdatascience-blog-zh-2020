<html>
<head>
<title>A quick guide to using Spot instances with Amazon SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Amazon SageMaker使用Spot实例的快速指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68?source=collection_archive---------15-----------------------#2020-04-25">https://towardsdatascience.com/a-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68?source=collection_archive---------15-----------------------#2020-04-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7a2d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过Amazon SageMaker上的托管现场培训，降低您的深度学习培训成本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b471d5a14bbfa368a378fb14dee597b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJWk0mfAdiUjliNCjS-FfQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚马逊SageMaker将自动备份和同步检查点亚马逊S3，让您可以轻松恢复训练</p></figure><p id="92cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">降低机器学习培训成本的最简单方法之一是使用亚马逊EC2 Spot实例。与按需费率相比，Spot实例允许您以高达90%的大幅折扣访问备用Amazon EC2计算能力。那么为什么不总是使用Spot实例呢？好吧，可以，只要你的工作量能容忍突然的打扰。由于Spot实例是备用容量的一部分，因此只需通知2分钟就可以回收它们！</p><p id="07e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">深度学习培训是可以容忍中断的工作负载的一个很好的例子，我以前写过关于使用亚马逊EC2 Spot实例进行深度学习培训的。然而，作为一名机器学习开发人员或数据科学家，您可能不希望管理现场车队请求、轮询容量、轮询终止状态、手动备份检查点、在恢复培训时手动同步检查点，以及在每次想要运行培训作业时设置一切。</p><p id="2de6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">亚马逊SageMaker提供<a class="ae lu" href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-managed-spot-training.html" rel="noopener ugc nofollow" target="_blank">管理的现场培训</a>，这是一种使用亚马逊EC2现场实例为亚马逊SageMaker培训工作降低培训成本的便捷方式。这意味着您现在可以节省高达90%的培训工作量，而无需设置和管理Spot实例。Amazon SageMaker将自动为您提供Spot实例，如果Spot实例被回收，Amazon SageMaker将在容量可用后自动恢复培训！</p><p id="fd11" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博客文章中，我将提供一个分步指南，通过Amazon SageMaker使用Spot实例进行深度学习训练。我将介绍您需要做哪些代码更改来利用Amazon SageMaker的自动检查点备份和同步到Amazon S3特性。我将使用Keras和TensorFlow后端来说明如何利用Amazon SageMaker管理的现场培训。您还可以在另一个框架上实现相同的步骤，比如PyTorch或MXNet。</p><blockquote class="lv lw lx"><p id="3205" class="ky kz ly la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated">GitHub上有一个关于Jupyter笔记本的完整例子:【https://github.com/shashankprasanna/sagemaker-spot-training T4】</p></blockquote><h1 id="256d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">哪些工作负载可以利用Spot实例？</h1><p id="62b5" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了利用Spot实例节省，您的工作负载必须能够容忍中断。在机器学习中，有两种类型的工作负载大致属于这一类别:</p><ol class=""><li id="82c6" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">无状态的微服务，比如模型服务器(TF Serving，TorchServe — <a class="ae lu" href="https://aws.amazon.com/blogs/machine-learning/deploying-pytorch-models-for-inference-at-scale-using-torchserve/" rel="noopener ugc nofollow" target="_blank">读我的博文</a>)，服务推理请求</li><li id="787c" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">有状态作业，如深度学习训练，能够通过频繁的检查点保存其完整状态。</li></ol><p id="8306" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在第一种情况下，如果Spot实例被回收，流量可以被路由到另一个实例，假设您已经为高可用性设置了冗余服务。在第二种情况下，如果Spot实例被中断，您的应用程序必须立即保存其当前状态，并在容量恢复后继续训练。</p><p id="c7c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本指南中，我将涵盖第二种用例，即使用开源深度学习框架(如TensorFlow、PyTorch、MXNet等)的深度学习培训工作的Spot实例。</p><h1 id="52f2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">快速回顾亚马逊SageMaker如何开展深度学习培训</h1><p id="6ac2" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我先说亚马逊SageMaker是如何运行深度学习训练的。这一背景对于理解SageMaker如何管理Spot训练以及备份您的检查点数据和恢复训练非常重要。如果你是亚马逊SageMaker用户，这应该是一个快速提醒。</p><h2 id="d9bf" class="nn md it bd me no np dn mi nq nr dp mm lh ns nt mo ll nu nv mq lp nw nx ms ny bi translated">你的职责:</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/6a384e2d77000b8d81bebd774c0dfa9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yYMz5EltmlRjcgIN"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">开发您的培训脚本并将其提供给SageMaker SDK Estimator函数，Amazon SageMaker会处理剩下的工作</p></figure><ol class=""><li id="97fb" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">使用TensorFlow、PyTorch、MXNet或其他支持的框架编写培训脚本。</li><li id="e0c1" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">编写一个SageMaker Python SDK Estimator函数，指定在哪里可以找到您的训练脚本，在什么类型的CPU或GPU实例上进行训练，在多少个实例上进行训练(对于分布式)，在哪里可以找到您的训练数据集，以及在亚马逊S3的哪里可以保存训练好的模型。</li></ol><h2 id="adb9" class="nn md it bd me no np dn mi nq nr dp mm lh ns nt mo ll nu nv mq lp nw nx ms ny bi translated">亚马逊SageMaker的职责:</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/67f73a1a5a998af014e5036b1676e8e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IKKyiRwaLnryYT3wDqQbgw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚马逊SageMaker培训工作流程</p></figure><p id="c4d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">亚马逊SageMaker将管理基础设施细节，所以你不必这样做。亚马逊SageMaker将:</p><ol class=""><li id="c8da" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">将您的培训脚本和依赖项上传到亚马逊S3</li><li id="2672" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">在完全受管的群集中调配指定数量的实例</li><li id="87ef" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">提取指定的TensorFlow容器映像，并在每个实例上实例化容器。</li><li id="e75d" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">从亚马逊S3下载训练代码到实例中，并使其在容器中可用</li><li id="9260" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">从亚马逊S3下载训练数据集，并使其在容器中可用</li><li id="cdcc" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">跑步训练</li><li id="5b70" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">将训练好的模型复制到亚马逊S3的指定位置</li></ol><h1 id="8e86" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">运行亚马逊SageMaker管理的现场培训</h1><p id="a4c5" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">Spot实例可以被抢占，并且只需2分钟通知就可以终止，因此经常检查训练进度非常重要。谢天谢地，亚马逊SageMaker将管理其他一切。它会自动将您的培训检查点备份到亚马逊S3，如果培训实例因容量不足而终止，它会持续轮询容量，并在容量可用时自动重新开始培训。</p><p id="df68" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Amazon SageMaker会自动将您的数据集和检查点文件复制到新的实例中，并将其提供给docker容器中的训练脚本，以便您可以从最新的检查点恢复训练。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/a5b4b1fadd9a18603a847049b1c3f395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4WzhDEZ3EWrNK5t6jAWBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚马逊SageMaker将自动备份和同步检查点文件到亚马逊S3</p></figure><p id="bf05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们来看一个例子，看看你如何准备你的培训脚本，使现场培训准备就绪。</p><h1 id="7cdc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">亚马逊SageMaker通过TensorFlow和Keras管理现场培训</h1><p id="a55a" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了确保您的训练脚本能够利用SageMaker管理的Spot实例，您需要实现:</p><ol class=""><li id="5165" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">频繁节省检查点和</li><li id="7a69" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">从关卡恢复训练的能力。</li></ol><p id="ebff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将展示如何在Keras中进行这些更改，但是您可以在另一个框架中遵循相同的步骤。</p><h2 id="e042" class="nn md it bd me no np dn mi nq nr dp mm lh ns nt mo ll nu nv mq lp nw nx ms ny bi translated"><strong class="ak">步骤1:保存检查点</strong></h2><p id="ed0d" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">亚马逊SageMaker会自动备份和同步你的训练脚本生成的检查点文件到亚马逊S3。因此，您需要确保您的训练脚本将检查点保存到运行训练的docker容器上的本地检查点目录中。保存检查点文件的默认位置是<code class="fe oc od oe of b">/opt/ml/checkpoints</code>，Amazon SageMaker会将这些文件同步到特定的Amazon S3存储桶。本地和亚马逊S3检查站的位置都是可定制的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/04ad47984ff7907c2de6f89276886d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DLGZo6m7rU0_V4hh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将您的检查点本地保存到/opt/ml/checkpoints(路径是可定制的)，Amazon SageMaker会将其备份到Amazon S3</p></figure><p id="9979" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你正在使用Keras，这是非常容易的。创建ModelCheckpoint回调类的一个实例，并通过将其传递给fit()函数将其注册到模型中。</p><blockquote class="lv lw lx"><p id="1816" class="ky kz ly la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated">完整的实现可以在这个文件中找到:<a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py" rel="noopener ugc nofollow" target="_blank">https://github . com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar 10-training-sagemaker . py</a></p></blockquote><p id="a459" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是相关摘录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="1b37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，我正在通过<code class="fe oc od oe of b">initial_epoch</code>,这是您通常不会在意的。这让我们可以从某个纪元开始恢复训练，当你已经有了检查点文件时，这将会很方便。</p><h2 id="8129" class="nn md it bd me no np dn mi nq nr dp mm lh ns nt mo ll nu nv mq lp nw nx ms ny bi translated"><strong class="ak">步骤2:从检查点文件恢复</strong></h2><p id="2c70" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">当spot容量在中断后重新可用时，Amazon SageMaker将:</p><ol class=""><li id="fa44" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">启动新的spot实例</li><li id="b5ac" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">用您的训练脚本实例化Docker容器</li><li id="658d" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">将数据集和检查点文件从亚马逊S3复制到容器中</li><li id="a39d" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">运行您的培训脚本</li></ol><p id="675a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您的脚本需要实现从检查点文件恢复训练，否则您的训练脚本将从头开始训练。您可以实现如下所示的<code class="fe oc od oe of b">load_checkpoint_mode</code>函数。它接受本地检查点文件路径(<code class="fe oc od oe of b">/opt/ml/checkpoints</code>是缺省值)，并返回从最新检查点加载的模型和相关的纪元编号。</p><p id="634b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有许多方法可以查询目录中的文件列表，从文件名中提取纪元编号，并用最新的纪元编号加载文件名。我使用<code class="fe oc od oe of b">os.listdir()</code>和正则表达式。我相信你能想出更聪明、更优雅的方法来做同样的事情。</p><blockquote class="lv lw lx"><p id="8454" class="ky kz ly la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated">该文件中提供了完整的实现:<a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py" rel="noopener ugc nofollow" target="_blank">https://github . com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar 10-training-sagemaker . py</a></p></blockquote><p id="4518" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是相关摘录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h2 id="ce75" class="nn md it bd me no np dn mi nq nr dp mm lh ns nt mo ll nu nv mq lp nw nx ms ny bi translated"><strong class="ak">第三步:指导亚马逊SageMaker进行现场培训</strong></h2><p id="7982" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">您可以从您的笔记本电脑、台式机、Amazon EC2实例或Amazon SageMaker笔记本实例启动Amazon SageMaker培训工作。只要您安装了Amazon SageMaker Python SDK，并且拥有运行SageMaker培训作业的正确用户权限。</p><p id="583f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要运行托管的现场培训作业，您需要为标准的Amazon SageMaker Estimator函数调用指定几个附加选项。</p><blockquote class="lv lw lx"><p id="915b" class="ky kz ly la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated">该文件中提供了完整的实现:<a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/shashankprasanna/sage maker-spot-training/blob/master/TF-keras-cifar 10-spot-training . ipynb</a></p></blockquote><p id="89ed" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是相关摘录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><ul class=""><li id="27a5" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt oj nf ng nh bi translated"><code class="fe oc od oe of b"><strong class="la iu">train_use_spot_instances</strong></code>:指示亚马逊SageMaker运行托管现场培训</li><li id="8cc7" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt oj nf ng nh bi translated"><code class="fe oc od oe of b"><strong class="la iu">checkpoint_s3_uri</strong></code>:指示Amazon SageMaker将您的检查点文件同步到这个Amazon S3位置</li><li id="6e86" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt oj nf ng nh bi translated"><code class="fe oc od oe of b"><strong class="la iu">train_max_wait</strong></code>:指示Amazon SageMaker在此时间过后终止作业，并且现货产能不可用。</li></ul><p id="4023" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样。这些都是你需要做出的改变，以大幅降低你的培训成本。</p><p id="0b24" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要监控您的培训工作并查看节省情况，您可以查看Jupyter笔记本上的日志或导航至<code class="fe oc od oe of b">Amazon SageMaker Console &gt; Training Job</code>，点击您的培训工作名称。一旦训练完成，你应该看到你节省了多少。例如，在一个<code class="fe oc od oe of b">p3.2xlarge</code> GPU实例上进行30个纪元的培训，我能够节省70%的培训成本！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/281a5de2aeb25ae223fce835da62a696.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JVDR2XUl-w0lI6hu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Amazon SageMaker控制台中显示成本节约和其他有用信息的培训工作截图</p></figure><h1 id="b008" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在亚马逊SageMaker上模拟现场中断</h1><p id="524c" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">如果出现中断，你如何知道你的训练是否能正常恢复？</p><p id="2362" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您熟悉运行Amazon EC2 Spot实例，那么您知道可以通过终止Amazon EC2 Spot实例来模拟应用程序在Spot中断期间的行为。如果有能力，Spot fleet将启动一个新实例来替换您终止的实例。您可以监视您的应用程序，检查它是否处理中断并正常恢复。不幸(还是幸运？)，您不能手动终止Amazon SageMaker培训实例。<strong class="la iu"> </strong>你唯一的选择就是停止整个培训工作。</p><p id="4b54" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">幸运的是，在恢复训练时，您仍然可以测试代码的行为。要做到这一点，首先要运行一个Amazon SageMaker管理的Spot training，如前一节所述。假设你运行了10个纪元的训练。Amazon SageMaker会将您的检查点文件备份到指定的Amazon S3位置10个时期。前往亚马逊S3验证检查点是否可用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/3b5e6437c14fad4763109c4119260224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FeSR296r8EAdM_oXMrec1A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚马逊S3的检查站，由亚马逊SageMaker自动为您备份</p></figure><p id="230e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在运行第二个训练运行，但是这次提供第一个任务的检查点位置给<code class="fe oc od oe of b">checkpoint_s3_uri</code></p><p id="c747" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe oc od oe of b">checkpoint_s3_uri = tf_estimator.checkpoint_s3_uri</code>。</p><p id="1b72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是来自<a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>的相关摘录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/shashankprasanna/sage maker-spot-training/blob/master/TF-keras-cifar 10-spot-training . ipynb</a></p></figure><p id="3eef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过向<code class="fe oc od oe of b">checkpoint_s3_uri</code>提供你之前工作的检查点，你是在告诉Amazon SageMaker将这些检查点复制到你新工作的容器中。然后，您的训练脚本将加载最新的检查点并继续训练。在下图中，你可以看到训练将从第10个纪元开始恢复。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/30edc95a39510b323ef71efd940c98e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vAMmIYpbvvSkCJQZ0qEYww.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从亚马逊S3自动复制的先前工作的最新检查点恢复训练</p></figure><p id="57fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以这种方式模拟中断和Amazon SageMaker如何管理中断之间的关键区别在于，您正在创建一个新的培训任务来测试您的代码。在现场中断的情况下，Amazon SageMaker将简单地恢复现有的中断作业。</p><h1 id="be41" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">拯救快乐！</h1><p id="332e" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我知道我没有必要说服你节约成本是一件好事。希望我已经向您展示了，使用Amazon SageMaker管理的现场培训可以轻松节省培训成本。通过最少的代码更改，您可以节省超过70%的培训成本。你现在可以平静地运行GPU培训工作，而不会破产。</p><p id="10db" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读，我希望你喜欢这个指南。GitHub上的所有代码和示例都可以在这里找到:</p><blockquote class="lv lw lx"><p id="7327" class="ky kz ly la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated"><a class="ae lu" href="https://github.com/shashankprasanna/sagemaker-spot-training" rel="noopener ugc nofollow" target="_blank">https://github.com/shashankprasanna/sagemaker-spot-training</a></p></blockquote><p id="4670" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你对这篇文章有疑问，对如何改进它有建议，或者对新的指南和文章有想法，请在twitter ( <a class="ae lu" href="https://twitter.com/shshnkp" rel="noopener ugc nofollow" target="_blank"> @shshnkp </a>)，<a class="ae lu" href="https://www.linkedin.com/in/shashankprasanna/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我，或者在下面留下评论。拯救快乐！</p></div></div>    
</body>
</html>