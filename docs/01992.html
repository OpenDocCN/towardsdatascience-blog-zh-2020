<html>
<head>
<title>Using Jupyter Notebook to manage your BigQuery analytics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jupyter笔记本管理您的BigQuery分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-jupyter-notebook-to-manage-your-bigquery-analytics-c4dc7b2a4113?source=collection_archive---------12-----------------------#2020-02-25">https://towardsdatascience.com/using-jupyter-notebook-to-manage-your-bigquery-analytics-c4dc7b2a4113?source=collection_archive---------12-----------------------#2020-02-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0a81" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何利用Jupyter Notebook更好地管理您的SQL查询？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/47f8b8e39b3b593078a4a10bee952f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Acs5ZSdUpjSuKpct.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://www.google.com/url?sa=i&amp;url=https%3A%2F%2Fweb.superquery.io%2Fquery-tabs-bigquery%2F&amp;psig=AOvVaw21JNaUReoM0FoRWlsvrtkp&amp;ust=1582695307200000&amp;source=images&amp;cd=vfe&amp;ved=0CA0QjhxqFwoTCKCV3c796-cCFQAAAAAdAAAAABAD" rel="noopener ugc nofollow" target="_blank">图片来源</a>:我们都去过那里…</p></figure><p id="977c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你有打开和不断在一万个BigQuery标签页之间切换的困扰，你并不孤单。作为一名数据专业人员，使用SQL查询是一项日常任务，如果你没有条理，你会很快淹没在Chrome标签中。</p><p id="a49a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是，您可以使用带有几个软件包的Jupyter笔记本，在处理SQL查询时会有更加愉快的体验。在这篇文章中，我将详细介绍设置环境的步骤，并将您的工作流程迁移到Jupyter笔记本上。无论您是数据分析师、数据工程师还是数据科学家，拥有一个有组织的工作流程将有助于显著提高您的工作效率。</p><h1 id="84c7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">环境设置</h1><h2 id="e23b" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">下载并安装Anaconda</h2><p id="c84a" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">安装Python和Jupyter Notebook的最快最简单的方法是使用Anaconda发行版。你可以按照这里的指示<a class="ae le" href="https://docs.anaconda.com/anaconda/install/" rel="noopener ugc nofollow" target="_blank"/>找到在你的操作系统上安装Anaconda的指南。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mu"><img src="../Images/8f94d0fc3650374d85fe85996c78bc3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jq-cqSrzO0lw5egH.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">确保将Anaconda添加到PATH环境变量中。</p></figure><h2 id="f468" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">安装谷歌云Python SDK并认证</h2><p id="315d" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">按照谷歌的<a class="ae le" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">指南</a>为你的特定操作系统安装云SDK。安装并初始化SDK后，您应该通过执行以下操作来设置应用程序默认身份验证:</p><p id="0f05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开终端/Anaconda提示符/命令行，键入以下内容</p><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="72d9" class="md lg it mw b gy na nb l nc nd">gcloud auth application-default login</span></pre><p id="422f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">会弹出一个浏览器，要求你用谷歌账户登录。登录并选择<code class="fe ne nf ng mw b">Allow</code>对云SDK进行认证。</p><h2 id="5c8f" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">安装GCP python库和pandas_gbq</h2><p id="54d1" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">我们鼓励您为每个项目建立一个单独的环境来安装python包。为了简单起见，我将跳过在这里创建不同环境的步骤。</p><p id="db16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装以下Python包:</p><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="af8b" class="md lg it mw b gy na nb l nc nd">pip install --user --upgrade google-api-python-client<br/>pip install --user pandas-gbq -U</span></pre><h1 id="07a5" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Jupyter笔记本中的SQL查询</h1><h2 id="27fd" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">打开Jupyter笔记本或Jupyter实验室</h2><p id="82d2" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">您可以使用以下任一方法从命令行快速启动Jupyter笔记本或Jupyter实验室实例:</p><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="c91f" class="md lg it mw b gy na nb l nc nd">jupyter notebook<br/>jupyter lab</span></pre><p id="31a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个Python 3笔记本，并确保您选择了之前安装软件包的环境。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nh"><img src="../Images/5a0122c1e83bce2706738ec3df84e842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DGkJ6z3DtIWbo9YV.png"/></div></div></figure><h2 id="7c6b" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">导入库</h2><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="5bd9" class="md lg it mw b gy na nb l nc nd">import pandas as pd<br/>import pandas_gbq</span><span id="8531" class="md lg it mw b gy ni nb l nc nd">from google.cloud import bigquery<br/>%load_ext google.cloud.bigquery</span><span id="abee" class="md lg it mw b gy ni nb l nc nd"># Set your default project here<br/>pandas_gbq.context.project = 'bigquery-public-data'<br/>pandas_gbq.context.dialect = 'standard'</span></pre><p id="1a7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">导入所需的库，就大功告成了！不再有无尽的Chrome标签，现在你可以在笔记本上组织你的查询，比默认编辑器有更多的优势。让我们复习一些例子。</p><h2 id="b443" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">在单元格查询中</h2><p id="2097" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">借助<code class="fe ne nf ng mw b">%%bigquery</code>的魔力，您可以编写如下多行单元格内查询:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/962dad0c50293c32df4811918f005ed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*DLtyOumDVKy8IhGo4zv45g.png"/></div></figure><p id="f9ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您也可以使用<code class="fe ne nf ng mw b">%%bigquery df_name</code>将结果存储到熊猫数据框中</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/eaf2417a1dae4eb6752994bb13bbb0e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*i3Lgb5aE2UcqkTE7wgVNgw.png"/></div></figure><p id="63e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">可以使用<code class="fe ne nf ng mw b">— params</code>标志在查询中传递参数:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/8c2f8763db1e28aceaed7dbc022cc85c.png" data-original-src="https://miro.medium.com/v2/resize:fit:538/format:webp/1*J-a5-V-B6RWtc4PgSxf1nA.png"/></div></figure><p id="fbbc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，为了提高性能，一定要限制返回行。IPython Magics for BigQuery的详细文档可以在<a class="ae le" href="https://googleapis.dev/python/bigquery/latest/magics.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="72e3" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">使用pandas_gbq库</h2><p id="1682" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">除了使用IPython Magics，您还可以使用pandas_gbq与BigQuery进行交互。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/02c6c405717de1e7c991f6a58cf23784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*vTqKqeoXY1a-liJQSGQsLw.png"/></div></figure><p id="e62d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将数据写回BigQuery也很简单。您可以运行以下代码:</p><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="f4e5" class="md lg it mw b gy na nb l nc nd">df.to_gbq(df, table_id, project_id = project_id)</span></pre><p id="b9f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ne nf ng mw b">pandas_gbq</code>的文件可以在这里<a class="ae le" href="https://pandas-gbq.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">找到。</a></p><h2 id="bdd6" class="md lg it bd lh me mf dn ll mg mh dp lp kb mi mj lt kf mk ml lx kj mm mn mb mo bi translated">使用Python BigQuery客户端</h2><pre class="kp kq kr ks gt mv mw mx my aw mz bi"><span id="0d88" class="md lg it mw b gy na nb l nc nd">client = bigquery.Client(project = project_id) <br/>query = '''<br/>    SELECT name, SUM(number) as count<br/>    FROM `bigquery-public-data.usa_names.usa_1910_current`<br/>    GROUP BY name<br/>    ORDER BY count DESC<br/>    LIMIT 5<br/>'''<br/>client.query(query).result().to_dataframe()</span></pre><p id="ecf2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这段代码产生的结果与上述方法相同。但是，您可以使用Python客户端与BigQuery进行更高级的交互。诸如创建表、定义模式、定义自定义函数等。BigQuery Python客户端的完整文档可以在<a class="ae le" href="https://googleapis.dev/python/bigquery/latest/reference.html#model" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="113a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="df2d" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">在这篇文章中，我介绍了使用Jupyter Notebook与BigQuery进行更程序化交互的步骤。以下是使用Jupyter Notebook查询数据时可以做的一些高级事情:</p><ul class=""><li id="7940" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated">用Jupyter笔记本上的markdown单元格记录您的代码</li><li id="a902" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">以HTML或PDF格式分享您的分析</li><li id="1fbc" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">参数化您的查询</li><li id="8c55" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">为您的查询编写单元测试</li><li id="fc98" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">使用BigQuery Python客户端将基础设施实现为代码</li><li id="24af" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">构建一个ETL管道。</li></ul><p id="1621" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快乐学习！</p></div></div>    
</body>
</html>