<html>
<head>
<title>Sentiment Analyzer with BERT (build, tune, deploy)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有 BERT 的情感分析器(构建、调整、部署)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sentiment-analyzer-with-bert-build-tune-deploy-da84c0f2366d?source=collection_archive---------52-----------------------#2020-07-24">https://towardsdatascience.com/sentiment-analyzer-with-bert-build-tune-deploy-da84c0f2366d?source=collection_archive---------52-----------------------#2020-07-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b690" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">简要说明我如何开发情感分析器。它涵盖了文本预处理、模型构建、调优、API、前端创建和容器化。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/da68716022d0a93d7993c2d42a194b83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/1*_AQGOWAncIy13B7J8qIcbQ.gif"/></div></figure><h1 id="12af" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">资料组</h1><p id="f8fe" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我使用了斯坦福大学 NLP 小组发布的<a class="ae me" href="https://nlp.stanford.edu/sentiment/" rel="noopener ugc nofollow" target="_blank">数据集。我合并了两个文件，即包括 239，232 个文本片段的“dictionary.txt”和包含分配给各种文本片段的情感分数的“impression _ labels . txt”。</a></p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="ca7f" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">用正则表达式进行文本预处理</h1><p id="c102" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了清理文本，我通常使用一堆包含正则表达式的函数。在<code class="fe mr ms mt mu b">common.py</code>中，您可以找到所有这些，例如下面描述的<code class="fe mr ms mt mu b">remove_nonwords</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="ae27" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">类似的函数也用于空行、特殊符号、数字和 html 代码删除。</p><p id="5402" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">在文本清理之后，是时候创建 BERT 嵌入了。为此，我使用了<a class="ae me" href="https://github.com/hanxiao/bert-as-service" rel="noopener ugc nofollow" target="_blank"> bert-as-service </a>。它非常简单，只包含 3 个步骤:下载一个预先训练好的模型，启动 BERT 服务，使用客户端对指定长度的句子进行编码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="76aa" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">运行服务时，可以设置多个参数。例如，为了定义<code class="fe mr ms mt mu b">max_seq_len</code>，我计算了 0.9 分位数的训练数据长度。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="fd36" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">预处理数据具有包含 768 个特征的数据帧形式。完整代码请上<code class="fe mr ms mt mu b">nlp_preprocess.py</code>。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="763e" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">用 Keras 建模</h1><p id="7498" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这一部分，我们在不同的参数上建立和训练模型。假设我们需要如下 5 层神经网络。我们将参数化 batch_size、历元数、前 4 个密集层和 5 个下降层中的节点数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="58a1" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">用神圣的模型调谐</h1><p id="d276" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在我们可以调整参数了。我们将使用<code class="fe mr ms mt mu b">sacred</code>模块。这里的要点是:</p><p id="6e8e" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated"><strong class="lk iu"> 1。创建一个实验并添加观察者</strong></p><p id="3145" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">首先，我们需要创建一个记录各种信息的实验和观察器。很简单！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="6f80" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">2.<strong class="lk iu">定义主功能</strong></p><p id="7d0c" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">当我们运行 Python 脚本时,<code class="fe mr ms mt mu b">@ex.automain</code>装饰器定义并运行实验的主函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="69e2" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated"><strong class="lk iu"> 3。添加配置参数</strong></p><p id="96e8" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我们将通过配置范围来定义它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="789a" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated"><strong class="lk iu"> 4。添加指标</strong></p><p id="89eb" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">在我们的例子中，我想知道 MAE 和 MSE 分别是<strong class="lk iu">和</strong>和<strong class="lk iu">T21。我们可以为此使用 Metrics API。</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="393f" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated"><strong class="lk iu"> 5。运行实验</strong></p><p id="c832" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">前面步骤的功能存储在<code class="fe mr ms mt mu b">model_experiment.py</code>脚本中。为了对一堆参数运行我们的实验，我们为所有可能的排列创建并运行<code class="fe mr ms mt mu b">run_sacred.py.</code>，MAE 和 MSE 将被保存在 MongoDB 中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="372e" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我得到的最好成绩是 MAE 分数的 9%。这意味着我们的情感分析器工作得非常好。我们可以用<code class="fe mr ms mt mu b">model_inference</code>功能来查看。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="7cfa" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">请注意，分数是标准化的，因此也可以获得异常值。模型保存后，我们可以构建一个 Web API！</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="2ea1" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">用 Flask 创建 Web API</h1><p id="17da" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，我们希望创建一个 API 来运行函数中的代码，并在浏览器中显示返回的结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="3c03" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">语法<code class="fe mr ms mt mu b">@app.route('/score', methods=['PUT'])</code>让 Flask 知道函数<code class="fe mr ms mt mu b">score</code>应该被映射到<em class="nc">端点/分数</em>。<code class="fe mr ms mt mu b">methods</code>列表是一个关键字参数，它告诉我们允许哪种 HTTP 请求。我们将使用<code class="fe mr ms mt mu b">PUT</code>请求来接收用户的句子。在函数<code class="fe mr ms mt mu b">score</code>中，我们得到一个字典形式的分数，因为它可以很容易地转换成 JSON 字符串。完整代码在<code class="fe mr ms mt mu b">api.py</code>中提供。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="db64" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">前端</h1><p id="6bc1" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于 web 界面，创建了三个文件:</p><ul class=""><li id="67c4" class="nd ne it lk b ll mx lo my lr nf lv ng lz nh md ni nj nk nl bi translated"><code class="fe mr ms mt mu b">index.html</code>提供了站点的基本结构:标题、描述、输入文本区和带分数的圆圈。</li><li id="d36a" class="nd ne it lk b ll nm lo nn lr no lv np lz nq md ni nj nk nl bi translated"><code class="fe mr ms mt mu b">style.css</code>用于网站样式。</li><li id="561b" class="nd ne it lk b ll nm lo nn lr no lv np lz nq md ni nj nk nl bi translated"><code class="fe mr ms mt mu b">index.js</code>提供交互性。它负责读取用户输入，处理 API 请求并显示计算出的分数。这里的三个主要功能是:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="703e" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">对于坡度<strong class="lk iu">，使用 HSV </strong>模型。饱和度和值是常量。色调对应于分值。在范围[0；中更改色调；120]产生从红色到黄色到绿色的平滑颜色变化。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="7420" class="kq kr it bd ks kt mm kv kw kx mn kz la jz mo ka lc kc mp kd le kf mq kg lg lh bi translated">码头集装箱化</h1><p id="ecdb" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Docker 的高明之处在于，一旦你将一个应用程序及其所有依赖项打包到容器中，你就能确保它能在任何环境下运行。通常建议通过对每个容器使用一个服务来分隔关注的区域。在我的小应用程序有 3 个部分应该结合起来:伯特即服务，应用程序和前端。帮助您构建 Docker 映像和运行容器的工具是<strong class="lk iu"> Docker Compose </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/4c5e6213297904c1b21525a66f6e0b5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*VzZrdRgWuBWg_e6tgeIuKA.png"/></div></figure><p id="b3c8" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">将我们的代码进行文档化需要做的步骤:</p><ul class=""><li id="7db1" class="nd ne it lk b ll mx lo my lr nf lv ng lz nh md ni nj nk nl bi translated">为 bert-as-service、api 和前端创建单独的文件夹，</li><li id="42b0" class="nd ne it lk b ll nm lo nn lr no lv np lz nq md ni nj nk nl bi translated">把相关文件放在那里，</li><li id="9d4f" class="nd ne it lk b ll nm lo nn lr no lv np lz nq md ni nj nk nl bi translated">将<code class="fe mr ms mt mu b">requirenments.txt</code>和<code class="fe mr ms mt mu b">Dockerfile</code>添加到每个文件夹中。第一个文件应该包含将通过第二个文件中的命令安装的所有需要的库。其格式在 docker <a class="ae me" href="https://docs.docker.com/engine/reference/builder/" rel="noopener ugc nofollow" target="_blank">文档</a>中有描述</li><li id="7465" class="nd ne it lk b ll nm lo nn lr no lv np lz nq md ni nj nk nl bi translated">在 3 个文件夹目录中创建<code class="fe mr ms mt mu b">docker-compose.yaml</code>。在这个文件中定义组成应用程序的 3 个服务，以便它们可以在一个隔离的环境中一起运行。</li></ul><p id="b2de" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">现在我们已经准备好构建和运行我们的应用程序了！请参见下面的输出示例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/f3f0aa64ae97366ada9d0d146a16f3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F51u0SJEBnzAZZeUfN2wGg.png"/></div></div></figure><p id="ac28" class="pw-post-body-paragraph li lj it lk b ll mx ju ln lo my jx lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">像往常一样，请随意查看我的 GitHub 上的完整代码。</p><div class="nx ny gp gr nz oa"><a href="https://github.com/zuzadeu/Sentiment-Analyzer-with-BERT" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd iu gy z fp of fr fs og fu fw is bi translated">GitHub-zuzadeu/带 BERT 的情感分析器</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">github.com</p></div></div><div class="oj l"><div class="ok l ol om on oj oo ko oa"/></div></div></a></div></div></div>    
</body>
</html>