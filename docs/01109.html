<html>
<head>
<title>Understanding Autopilot Mode in Azure Cosmos DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Azure Cosmos DB中的自动驾驶模式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-autopilot-mode-in-azure-cosmos-db-105973083780?source=collection_archive---------27-----------------------#2020-01-31">https://towardsdatascience.com/understanding-autopilot-mode-in-azure-cosmos-db-105973083780?source=collection_archive---------27-----------------------#2020-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f4e2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">有了自动驾驶模式，计算您需要在Cosmos DB中提供多少吞吐量变得更加简单！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/a259dec337a1f57affd4bbe030f04a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/0*OYBaF3hZ0_VtF7Wk.png"/></div></figure><p id="51a2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">2019年11月，Azure Cosmos DB团队<a class="ae lj" href="https://devblogs.microsoft.com/cosmosdb/whats-new-in-azure-cosmos-db-nov-2019/" rel="noopener ugc nofollow" target="_blank">宣布了一系列很酷的功能</a>，使得开发和管理<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cosmos-db/" rel="noopener ugc nofollow" target="_blank"> Cosmos DB </a>应用程序变得更加容易。</p><p id="5d8c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">到目前为止，我最喜欢的功能是<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cosmos-db/provision-throughput-autopilot" rel="noopener ugc nofollow" target="_blank">新的自动驾驶模式</a>。在这篇文章中，我将谈论自动驾驶模式的好处，如何在启用自动驾驶模式的情况下供应数据库和容器，以及当前的限制是什么(毕竟它仍然是一个预览功能！😂)</p><p id="0418" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">开始时</strong></p><p id="7cd6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在Azure Cosmos DB中，您提供吞吐量来管理您的工作负载。在Autopilot出现之前，您必须为一个容器或一个数据库可以拥有的<strong class="kp ir">请求单位/秒(RU/s) </strong>设置一个硬性的最大限制。这是很难做到的，因为您必须猜测您需要多少吞吐量，并期待最好的结果。</p><p id="c405" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">即使你没有达到最高限额，你仍然被收取预订费。因此，您可以将最大吞吐量级别设置为10K RU/s，但在一天中只使用15分钟。</p><p id="e2cb" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们可以使用一些工具来改变所调配的吞吐量。我们可以使用传送门(像穴居人一样)或者使用<a class="ae lj" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.documents.client.requestoptions.offerthroughput?view=azure-dotnet" rel="noopener ugc nofollow" target="_blank">。NET SDK以编程方式更新金额</a>(这只是增加了代码的复杂性😥).</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lk"><img src="../Images/b571e11d8a1970db52f8b73965ed852d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/0*ivLq1ZqYTMaG7KYi.png"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">我试图计算出我需要调配多少吞吐量。来源:<a class="ae lj" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmF4-SGZ3RRAtOQPCV01ZrEYVT83yJ99_tBnnUUsbfmjW4_kDX&amp;s" rel="noopener ugc nofollow" target="_blank">https://encrypted-tbn0.gstatic.com/images?q = tbn:and 9 gcrmf 4-sgz 3 rato qpcv 01 zreyvt 83 yj 99 _ tbnnuusbfmjw 4 _ kDX&amp;s</a></p></figure><p id="9533" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">激活自动驾驶模式！</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/84b26efc22c7a34becd1c44ec05129a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/0*1nn03MWrVGTGIAJh.jpg"/></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">来源:<a class="ae lj" href="https://pics.me.me/thumb_hes-gonna-do-a-superhero-landing-whooo-superhero-landing-13990540.png" rel="noopener ugc nofollow" target="_blank">https://pics . me . me/thumb _ hes-going-do-a-super hero-landing-whoo-super hero-landing-13990540 . png</a></p></figure><p id="9877" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">进入自动驾驶模式😃我们可以在Cosmos DB中的容器和数据库上设置Autopilot，而不是自己手动设置吞吐量，这将自动即时扩展所提供的吞吐量，而无需我们做任何事情，也不会影响我们应用程序的可用性。</p><p id="636d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Autopilot目前在一个分层系统上工作，在这个系统中，您可以设置容器或数据库上不希望超过的最大吞吐量水平。容器或数据库可以在0.1(最大值)到最大值之间瞬间伸缩。目前有4层可供选择:</p><ol class=""><li id="7df0" class="lu lv iq kp b kq kr kt ku kw lw la lx le ly li lz ma mb mc bi translated">4000 RU/s<em class="md">(最大存储容量50GB)</em></li><li id="0685" class="lu lv iq kp b kq me kt mf kw mg la mh le mi li lz ma mb mc bi translated">20，000 RU/s <em class="md"> (200GB最大存储)</em></li><li id="c73d" class="lu lv iq kp b kq me kt mf kw mg la mh le mi li lz ma mb mc bi translated">100，000 RU/s <em class="md"> (1TB最大存储)</em></li><li id="bac0" class="lu lv iq kp b kq me kt mf kw mg la mh le mi li lz ma mb mc bi translated">500，000 RU/s <em class="md">(最大存储容量5TB)</em></li></ol><p id="3713" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">自动驾驶有什么好处？</strong></p><p id="439b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">首先，它更加灵活！我不能告诉你多少次，我不得不打破古老的算盘，计算出我不得不为宇宙(以及某些时候)提供的许多RU。</p><p id="b3bf" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这也使你的代码更加整洁。为了避开429错误。NET SDK确实允许您在达到最大分配吞吐量时升级数据库或容器的吞吐量。但是这并不能避免我必须计算出我需要多少个RU来满足我的应用程序的需求。</p><p id="fab6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">自动驾驶也可以为你节省一些严重的现金！我曾经遇到过这样的情况，我们团队中的一名工程师在Cosmos中做了一些测试，将配置的RU提高到20K。测试成功了，一切都很好，直到我们收到那个月的账单……</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mj"><img src="../Images/c7409a849bde6d1b35ccdab90c8586db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6_O697QT64HTKA9v.jpg"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">来源:<a class="ae lj" href="https://i.kym-cdn.com/entries/icons/original/000/000/554/picard-facepalm.jpg" rel="noopener ugc nofollow" target="_blank">https://I . kym-cdn . com/entries/icons/original/000/000/554/Picard-face palm . jpg</a></p></figure><p id="a828" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">有了Autopilot，你只需为你的Cosmos DB账户按小时使用的资源付费。因此，以20K为例，如果我们使用自动驾驶仪达到RU要求的水平，我们将只需支付我们需要RU水平达到20K的小时数，而不是整个星期，工程师都忘记将它降下来。</p><p id="c690" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">我什么时候会使用自动驾驶？</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/71705793ea535c4291532627ce8591e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/0*2qet4FLRJKyEWJqb"/></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">来源:<a class="ae lj" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9y85xnqXkFVZLys_kPJbBWHnkWf70kGsVnUgVYsEfmVa83Nqs&amp;s" rel="noopener ugc nofollow" target="_blank">https://encrypted-tbn0.gstatic.com/images?q = tbn:and 9 gcr 9y 85 xnqxkfvzlys _ kpjbbbwhnkwf 70 ksvnugvysefmva 83 nqs&amp;s</a></p></figure><p id="8662" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="md">如果您的Cosmos DB帐户收到的工作负载是变化的或不可预测的</em>，启用Autopilot可确保您有足够的吞吐量来满足工作负载的需求。这样就不需要自己更改调配的吞吐量，因为Autopilot会在一个层内为您增减吞吐量。</p><p id="a5b8" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="md">如果您正在开发一个新的应用程序，或者您只是在做一些测试</em>，启用自动驾驶功能可以帮助您评估部署应用程序后需要提供多少吞吐量。</p><p id="051c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">告诉我怎么做！</strong></p><p id="dac2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在自动驾驶的情况下创建数据库和容器是非常简单的。我将假设您知道如何提供一个Cosmos DB帐户，所以为了节省时间，我将跳过这一步。</p><p id="c361" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">让我们创建一个启用了自动驾驶的容器。<em class="md">如果你愿意</em>，你也可以在数据库级别启用自动驾驶，但是我只用容器作为例子。在你的Cosmos DB账户中，点击New Container。</p><p id="9cdb" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就像我们在Cosmos中创建新容器时通常会做的那样，我们会给容器一个名称、分区键值，然后要么创建一个新数据库，要么给它分配一个预先存在的数据库。单击为容器调配专用吞吐量的选项，您应该会看到两个选项:</p><ol class=""><li id="dd35" class="lu lv iq kp b kq kr kt ku kw lw la lx le ly li lz ma mb mc bi translated"><strong class="kp ir">自动驾驶仪(预览)。</strong></li><li id="cae0" class="lu lv iq kp b kq me kt mf kw mg la mh le mi li lz ma mb mc bi translated"><strong class="kp ir">手动。</strong></li></ol><p id="af70" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">因为这是一个关于实现自动驾驶的教程，你可以继续选择那个选项😊</p><p id="e05d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果是这样，你必须为你的容器选择一个自动导航层。现在只需选择4K层，然后单击“确定”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/40c008b0867849ba10d5ea096f5d408b.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*C05ivDpvkxuy0wD5WlYdvA.png"/></div></figure><p id="ab7b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果您稍后需要更改等级，请进入容器的'<em class="md">比例和设置'</em>选项卡，您可以选择一个新的等级。您可以上升或下降一个级别，这取决于哪些需求会影响您的容器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mm"><img src="../Images/845245f81a6d06e39c11d22985192777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlObSTpOlqBTeS5nF_bnFQ.png"/></div></div></figure><p id="f0b0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如您所见，设置起来相当简单😊</p><p id="c30b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">有什么蹊跷？</strong></p><p id="91d9" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就目前的情况而言，当谈到自动驾驶时，你需要注意几个问题。希望当这个特性普遍可用时，这些问题会得到解决，但是如果你不想等那么久…..</p><p id="29eb" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="md">你可以在Cosmos中的容器和数据库上启用自动驾驶的唯一方式是通过门户</em>。如果您使用CLI、Powershell或REST APIs通过CI/CD管道部署这些，您目前将无法做到这一点。</p><p id="edc3" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我设法解决这个问题的一个方法是在门户中提供自动引导的容器，然后测试我的部署脚本，看它们是否恢复到手动提供的容器。好消息是自动驾驶功能仍然存在。这是一个有点黑客，但它的工作🤷‍♂️</p><p id="a7a5" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="md">您不能在现有的容器/数据库上启用自动驾驶</em>😥就像如果你想改变一个容器的分区键，你必须重新创建这个容器。我真的希望当Autopilot正式发布时，我们可以更新这个(提示提示宇宙团队中可能读到这个的任何人😊)</p><p id="ab41" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="md">你可以关闭自动驾驶，切换到手动，但是不能再回去了。</em>再次，有点限制，但我非常希望当Autopilot正式上市时，我们将能够根据需要改变。</p><p id="6974" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Autopilot还会考虑你的容器/数据库当前存储了多少数据。例如，如果我们创建一个最大吞吐量水平为4，000RU/s的容器，我们的最大存储限制也将是50GB。一旦我们在容器中超过50GB存储，我们将自动升级到20，000 RU/s。如果您不需要在Cosmos中存储这些数据，并且希望降低成本，您可能需要考虑如何归档数据，以保持在该自动驾驶层的存储限制内。</p><p id="0969" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">结论……</strong></p><p id="45fb" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">希望在本文中，您看到了在您的Cosmos DB数据库和容器中使用Autopilot的好处。虽然这是到目前为止的结尾，因为它仍然是一个预览功能，所以当它变得普遍可用时，我很确定我将不得不再次写这篇文章！😂</p><p id="1bd5" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在为Cosmos DB开发和管理应用程序时，我不能强调这是多大的游戏改变者。我们不再需要自己花时间摆弄吞吐量调配了！</p><p id="bdc2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一如既往，如果你有任何问题，请在下面的评论区提问！</p></div></div>    
</body>
</html>