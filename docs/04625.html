<html>
<head>
<title>Advanced dataloaders with fastai2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">fastai2的高级数据加载器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/advanced-dataloaders-with-fastai2-ecea62a7d97e?source=collection_archive---------33-----------------------#2020-04-24">https://towardsdatascience.com/advanced-dataloaders-with-fastai2-ecea62a7d97e?source=collection_archive---------33-----------------------#2020-04-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="0cfe" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">快速介绍</h2><div class=""/><div class=""><h2 id="e0d5" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">优雅的fastai2方法创建超出通常的输入-目标对的数据加载器——一个使用Kaggle Bengali的例子。人工智能数据</h2></div><p id="b2e4" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在深度学习项目中，在开始训练任何模型之前，关键的一步是要有一个数据加载器，能够为模型提供批量数据，并执行图像放大等操作。在这个故事中，我将展示一个用于<a class="ae lk" href="https://www.kaggle.com/c/bengaliai-cv19" rel="noopener ugc nofollow" target="_blank">孟加拉语的数据加载器。AI Kaggle竞赛</a>可以使用fastai创建，只需12行干净的代码。<strong class="kq ja"> </strong>贯穿全文，当提到fastai时，我指的是库的最新版本(<a class="ae lk" href="https://github.com/fastai/fastai2" rel="noopener ugc nofollow" target="_blank"> fastai2 </a>)。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/a953d6b4ea24106daa6a0dbba3fc4277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qw2zofzcYkhjKya6PVuWPQ.jpeg"/></div></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">作者照片</p></figure><h2 id="0995" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated"><strong class="ak">为什么是fastai？</strong></h2><p id="fb00" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">引用他们的学术论文:</p><blockquote class="my mz na"><p id="7fed" class="ko kp nb kq b kr ks ka kt ku kv kd kw nc ky kz la nd lc ld le ne lg lh li lj ij bi translated">“fastai是围绕两个主要设计目标组织的:平易近人和快速高效，同时也是高度可黑客化和可配置的。其他库倾向于在简洁性和开发速度，或者灵活性和表达性之间做出选择，但不能两者都选。我们希望获得<a class="ae lk" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank"> Keras </a>的清晰度和开发速度，以及<a class="ae lk" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>的可定制性。”</p></blockquote><p id="d9b2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">fastai的这一核心特征使它能够为更广泛的受众所使用，同时也是有经验的从业者和研究人员的优秀工具。fastai高级API包括两个组件:<strong class="kq ja">数据块</strong>和<strong class="kq ja">学习器</strong>。这个故事着重于数据块组件，我发现这是一个优雅的解决方案，可以轻松地创建一个具有一个输入和三个目标的数据加载器——这是Bengali所需要的。人工智能竞赛。</p><h2 id="ee31" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated">孟加拉语。AI比赛数据</h2><p id="da40" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">用孟加拉语。人工智能竞赛给我们一组手写的字素，目标是用对应于字素不同组成部分的三个分类标签对每个字素进行分类。图像名称和各自的标签存储在一个CSV文件中，该文件可以加载到pandas数据帧:<strong class="kq ja">df = PD . read _ CSV(CSV _ file)</strong>。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/06ce2be2787cb84f93e0431fb4c56006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*Oz0sLZiuTRAH2t0efjnjjw.png"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">五个字素和各自标签的样本。作者使用<a class="ae lk" href="https://www.kaggle.com/c/bengaliai-cv19/data" rel="noopener ugc nofollow" target="_blank">竞赛数据</a>创建的图像。</p></figure><p id="20c0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">dataframe包括image_id、三个不同标签的类别号(grapheme_root、元音_音调符号、辅音_音调符号)、字形的表示以及范围从0到4的折叠号，该折叠号将用于将数据分成训练/验证集。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/d6b7a101bab4c926dee7eadf6ec56b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*M0B3vX68nY_UDu6JMaSGzw.png"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">数据报的前5行。作者使用<a class="ae lk" href="https://www.kaggle.com/c/bengaliai-cv19/data" rel="noopener ugc nofollow" target="_blank">比赛数据</a>和<a class="ae lk" href="https://www.kaggle.com/yiheng/iterative-stratification" rel="noopener ugc nofollow" target="_blank">笔记本</a>中的数据创建的图像。</p></figure><h2 id="16d4" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated"><strong class="ak">用12行代码创建数据加载器</strong></h2><p id="b030" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">要创建数据加载器，包括图像扩充和规范化，只需要下面的12行代码(其中<strong class="kq ja"> df </strong>是数据帧，<strong class="kq ja"> train_path </strong>是存储图像的路径)。</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="ng nh l"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">在fastai中创建一个带有一个图像输入和三个分类目标的数据加载器。</p></figure><ul class=""><li id="218f" class="ni nj iq kq b kr ks ku kv kx nk lb nl lf nm lj nn no np nq bi translated">在前两行中，定义了图像标准化和图像放大。Fastai <strong class="kq ja"> aug_transforms </strong>函数返回一个带有默认扩充的列表。由于字形是水平不对称的，翻转图像可能不是一个好主意，因此参数<strong class="kq ja"> do_flip </strong>被设置为false。</li><li id="cdbb" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated">在第3到10行，创建了数据块。第4行的<strong class="kq ja">块</strong>参数接收一个包含四个元素的元组——一个用于图像输入，三个用于分类目标。用于这些类型数据的fastai块有:用于图像的<strong class="kq ja">图像块</strong>和用于目标标签的<strong class="kq ja">类别块</strong>。由于该数据集中的图像是灰度而不是RGB，因此将<strong class="kq ja">cls = piimagebw</strong>赋予ImageBlock。注意*(3*[CategoryBlock])是写三次CategoryBlock的懒惰方式。</li><li id="4546" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated"><strong class="kq ja"> getters </strong>参数接收定义如何获取每个块的数据的类列表。Fastai <strong class="kq ja"> ColReader </strong>类用于从pandas dataframe的一列中获取数据。在第5行中，第一个ColReader获取图像名称(检查上面的dataframe示例以供参考)，然后对于每个CategoryBlock，给出对应于不同标签的dataframe的一列。</li><li id="cf2f" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated">第9行中的<strong class="kq ja">拆分器</strong>参数定义了如何将数据集拆分为训练/验证。有几种方法来定义分割。在这种情况下，由于我们在数据框中有折叠数，fastai <strong class="kq ja"> IndexSplitter </strong>函数可用于选择哪些样品将出现在验证集中。</li><li id="e906" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated">在第10行中，<strong class="kq ja"> batch_tfms </strong>参数接收一个转换列表，如前两行所定义的。</li><li id="10f8" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated">现在数据块已经完成，在第11行中，使用以下参数创建了数据加载器:dataframe和batch-size。</li><li id="f1e4" class="ni nj iq kq b kr nr ku ns kx nt lb nu lf nv lj nn no np nq bi translated">最后，在第12行，<strong class="kq ja"> n_inp </strong>被设置为1，这意味着只有一个输入——其他三个模块应被视为目标。</li></ul><h2 id="a0b5" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated"><strong class="ak">使用数据加载器</strong></h2><p id="4531" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">调用<strong class="kq ja"> dls.show_batch() </strong>将打印出几个样本，类似于本文中第一幅图所示的内容。</p><p id="aef8" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">不言而喻，数据加载器与fastai <strong class="kq ja"> Learner </strong>类完美集成。然而，可以在一个循环中调用训练和验证数据加载器<strong class="kq ja"> dls.train </strong>和<strong class="kq ja"> dls.valid </strong>来提取批量数据，如下图所示。注意，有四个值要解包，对应于数据块中定义的块。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/bc5d597d9649fe3b7a5cf4498eb65d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*mSYHrqlY5kI8d3Z43k0Pbg.png"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">使用列车数据加载器的循环示例。作者创造的形象。</p></figure><h2 id="33d6" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated"><strong class="ak">这有什么关系</strong></h2><p id="664c" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">fastai库允许为孟加拉语创建数据加载器。人工智能竞赛仅12行干净的代码，包括图像放大和规范化。拥有一个默认情况下提供高效代码的框架，可以让深度学习实践者将更多时间分配给实验，从而增加更好的最终结果的可能性。拥有简洁的代码也减少了小错误的机会，这些小错误可能会悄悄地影响模型的性能。最后，代码在共享时更容易理解。</p><p id="7ff6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">值得注意的是，fastai <strong class="kq ja"> aug_transforms </strong>增量是在GPU中计算的(如果有一个可用的话)。</p><p id="4335" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">像这样的细节很重要。</p><h2 id="313b" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated"><strong class="ak">结束语</strong></h2><p id="5675" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated"><a class="ae lk" href="https://www.kaggle.com/mnpinto/bengali-ai-fastai2-starter-lb0-9598" rel="noopener ugc nofollow" target="_blank">这个Kaggle内核</a>为孟加拉语提供了一个完整的工作示例。人工智能竞赛，包括模型定义和使用<strong class="kq ja">学习者</strong>类的训练，这在本故事中没有涉及。</p><h2 id="4d47" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated">进一步阅读</h2><p id="bb5d" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">在下面的故事中，我将进一步探索fastai数据块:</p><div class="nw nx gp gr ny nz"><a rel="noopener follow" target="_blank" href="/working-with-3d-data-fastai2-5e2baa09037e"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ja gy z fp oe fr fs of fu fw iz bi translated">使用3D数据— fastai2</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">了解fastai数据块并创建用于深度学习的图像序列的构建块…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on lv nz"/></div></div></a></div><h2 id="6832" class="mb mc iq bd md me mf dn mg mh mi dp mj kx mk ml mm lb mn mo mp lf mq mr ms iw bi translated">关于我</h2><div class="nw nx gp gr ny nz"><a rel="noopener follow" target="_blank" href="/my-3-year-journey-from-zero-python-to-deep-learning-competition-master-6605c188eec7"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ja gy z fp oe fr fs of fu fw iz bi translated">我的3年历程:从零Python到深度学习竞赛高手</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">自从2017年开始学习Python以来，我一直遵循的道路是成为一名独自参加Kaggle比赛的大师…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oo l ok ol om oi on lv nz"/></div></div></a></div></div><div class="ab cl op oq hu or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="ij ik il im in"><p id="7c7c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">感谢阅读！</p><p id="1932" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">编辑日志:</p><p id="69fb" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">2020年5月10日:修正了代码中的错误。batch_tfm参数先前已在dataloader中给出。它应该在数据块中给出，而不是如正确的版本所示。</p><p id="e9e5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">2020–06–07:增加了<strong class="kq ja">进一步阅读</strong>部分。</p></div></div>    
</body>
</html>