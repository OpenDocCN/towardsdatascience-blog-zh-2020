# 用 Python 实现 4 步分区统计算法

> 原文：<https://towardsdatascience.com/zonal-statistics-algorithm-with-python-in-4-steps-382a3b66648a?source=collection_archive---------19----------------------->

## 如何汇总面区域的栅格数据

![](img/ca52731daf38411adcd62edc53a2268a.png)

照片由[粘土银行](https://unsplash.com/@claybanks?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

通常需要汇总不规则形状区域内网格化数据集的信息。虽然乍一看这似乎很简单，但调和栅格(格网)和矢量(面)数据类型之间的差异可能会很快变得复杂。本文展示了如何通过 4 个步骤用 Python 实现区域统计算法。

1.  加载栅格数据和矢量多边形
2.  栅格化面要素
3.  将输入数据掩膜到面范围
4.  计算面范围的分区统计数据

# 1.加载栅格数据和矢量多边形

首先导入必要的 Python 模块。

现在设置光栅和矢量数据的文件路径，并使用`gdal`和`ogr`分别加载光栅和矢量数据。从已加载的矢量数据源访问包含面数据的图层。然后获取地理变换信息(定位网格化栅格数据并指定像元大小),而不获取栅格数据的数据值。

我们还要用`gdal`和`ogr`做一些设置，为确定栅格和矢量多边形之间的重叠做准备。让`gdal`和`ogr`驱动程序在内存中创建临时光栅和矢量图层，并为临时 shapefile 设置名称。

# 2.栅格化面要素

加载栅格和矢量数据后，就该确定它们重叠的地方了。这将是算法中最复杂和最密集的部分。首先，从矢量图层读取第一个面要素。然后开始一个`while`循环，只要矢量层中还有另一个特征，循环就会继续。下面是设置循环的基本方法。随着我们的继续，这个循环将被修改。

我们需要创建一些函数来帮助我们创建一个新的栅格来存储栅格化的面要素。当我们用实际数据调用这些函数时，它们会更有意义。现在，在脚本的顶部添加函数定义。首先，我们需要将包含面要素的边界框的坐标转换为与输入栅格相对应的像元坐标或偏移量(行号和列号)。面的边界框是包含整个面要素的矩形，它由最小和最大 X 和 Y 坐标组成。

接下来编写一个函数，用上面函数中计算的像元偏移量创建一个新的 GeoTransform。这两个函数将允许我们创建一个新的更小的栅格，该栅格仅覆盖由面要素重叠的区域。

现在是算法中最复杂的部分:在内存中创建新的空栅格，并将面要素转换为栅格。按照下面代码片段中的注释来理解每一行代码的作用。你可能还会发现查看 [GDAL 和 OGR 文档](https://live.osgeo.org/en/quickstart/gdal_quickstart.html)很有用。

# 3.将输入数据掩膜到面区域

此时我们有两个并发的(重叠的)`numpy`数组:`tr_array`和`r_array`。`tr_array`值为 1，表示多边形已栅格化的位置。`r_array`包含我们要用来计算每个面的分区统计数据的值。

首先，确保输入栅格存在。接下来创建一个遮罩数组。我们希望从`r_array`获取数据，其中不包含无数据值，并且`tr_array`中的相应值等于 1(或`True`)。

现在我们将使用`maskarray`来计算每个面要素的区域统计数据。

# 4.计算每个面范围的分区统计数据

再编写一个函数，它接受一些值作为输入，并创建一个值的字典。将此函数与其他函数一起放在区域统计脚本的顶部。

现在，计算来自`maskarray`的值，并将它们传递给`setFeatureStats`函数。仅当阵列存在时才这样做(`is not None`)。否则，传递 no data 值来设置统计信息。

# 结论

恭喜你！您已经创建了可应用于许多不同应用程序的 Python 区域统计脚本。以下是完整的脚本。使用自定义的区域统计算法可以让您在使用结果时更加灵活。从这一点来看，很容易将字典列表转换为 pandas 数据帧进行分析，导出到 csv，或者在原始 shapefile 中创建新字段并将统计数据直接添加到原始数据中。这可以加快、简化和定制您的工作流程。

*原载于 2020 年 11 月 10 日 https://opensourceoptions.com*[](https://opensourceoptions.com/blog/zonal-statistics-algorithm-with-python-in-4-steps/)**。**