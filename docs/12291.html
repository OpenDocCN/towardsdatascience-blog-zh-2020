<html>
<head>
<title>Generative Adversarial Network: Build a web application that colorizes B&amp;W photos with Streamlit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生成性对抗网络:构建一个用 Streamlit 给 B&amp;W 照片着色的 web 应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/generative-adversarial-network-build-a-web-application-which-colorizes-b-w-photos-with-streamlit-5118bf0857af?source=collection_archive---------46-----------------------#2020-08-24">https://towardsdatascience.com/generative-adversarial-network-build-a-web-application-which-colorizes-b-w-photos-with-streamlit-5118bf0857af?source=collection_archive---------46-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7853" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Streamlit 快速将生成式对抗网络模型转换为 web 应用程序，并部署到 Heroku</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9de658be719aff9e0b5c29d86e89b830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*l256Yu1wAkk8JS2aNfwkAA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">黑白照片彩色化的 Web 应用程序。</p></figure><h1 id="eee9" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">介绍</h1><p id="e838" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">之前我做了一个 GAN 模型，给黑白照片上色。它运行良好，所以我希望与人们分享。在 Jupyter notebook 中编码非常方便开发，但不方便共享，因此我决定制作一个 web 应用程序并部署到 Heroku。</p><div class="mm mn gp gr mo mp"><a rel="noopener follow" target="_blank" href="/colorize-black-and-white-photos-by-ai-cc607e164160"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd iu gy z fp mu fr fs mv fu fw is bi translated">人工智能给黑白照片上色。</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">利用 Fastai 的生成性对抗网络(GAN)使黑白照片变得丰富多彩</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">towardsdatascience.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd ks mp"/></div></div></a></div><p id="20b6" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">我没有网页开发的经验和技能，所以我花了一些时间来弄清楚如何去做。我发现了一个有用的工具 Stremlit，它可以让我用 Python 编码，并快速将其转化为 web 应用程序。</p><p id="b47f" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">我做这个 app 有几个步骤:</p><ol class=""><li id="3856" class="nj nk it ls b lt ne lw nf lz nl md nm mh nn ml no np nq nr bi translated">导出模型</li><li id="4797" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">下载模型</li><li id="32b9" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">为用户创建照片上传工具</li><li id="10fb" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">调整上传照片的大小</li><li id="e460" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">加载模型</li><li id="440f" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">分析上传的照片</li><li id="a5a3" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">显示结果</li><li id="5fb7" class="nj nk it ls b lt ns lw nt lz nu md nv mh nw ml no np nq nr bi translated">把它部署到 Heroku</li></ol><h1 id="9ba4" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">导出模型</h1><p id="436d" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我使用 fastai 训练 GAN 模型，所以我只需使用</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="16c9" class="oc kz it ny b gy od oe l of og">learner.export(export.pkl)</span></pre><p id="8cdb" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">这会将模型导出为 pkl 文件。</p><h1 id="c763" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">下载模型</h1><p id="17ec" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">这个应用程序的第一件事是下载模型。因为模型尺寸太大(&gt; 200MB)，不方便推送到 Github 或者直接推送到 Heroku。因此，我需要应用程序从外部 url 下载文件，以确保模型准备就绪。</p><p id="bd3e" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">我将模型存储在我的 dropbox 账户中，并创建了一个可下载的链接。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="5e44" class="oc kz it ny b gy od oe l of og">EXTERNAL_DEPENDENCIES = {<br/>"export_5.pkl": {<br/>"url": "https://dl.dropboxusercontent.com/s/xxxxxxx/export_5.pkl?dl=0",<br/>"size": 246698366}<br/>}</span></pre><p id="ec69" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后我用 Streamlit 的演示代码(<a class="ae oh" href="https://github.com/streamlit/streamlit" rel="noopener ugc nofollow" target="_blank">https://github.com/streamlit/streamlit</a>)创建了一个带有进度条的下载功能</p><p id="b364" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">我可以调用函数并下载模型</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="9dce" class="oc kz it ny b gy od oe l of og">for filename in EXTERNAL_DEPENDENCIES.keys():<br/>    download_file(filename)</span></pre><h1 id="d602" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">为用户创建上传工具</h1><p id="7bac" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我想有一个工具，允许用户上传他们的 B&amp;W 照片进行分析。</p><p id="46ad" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">Streamlit 提供了一个工具来实现它:st.file_uploader</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="51c0" class="oc kz it ny b gy od oe l of og">uploaded_file = st.file_uploader("upload a black&amp;white photo", type=['jpg','png','jpeg'])</span></pre><p id="a693" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后我将它保存到一个临时位置</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="ba93" class="oc kz it ny b gy od oe l of og">if uploaded_file is not None:<br/>   g = io.BytesIO(uploaded_file.read())  # BytesIO Object<br/>   temporary_location = "image/temp.jpg"<br/>   <br/>   with open(temporary_location, 'wb') as out:  # Open temporary file as bytes<br/>      out.write(g.read())  # Read bytes into file<br/>   <br/>      # close file<br/>      out.close()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/b9e01f802beb841bb0fb2f38efd17c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERHnbDMn8Rkcu5xl-M1BYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片上传工具</p></figure><h1 id="92ba" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">调整上传照片的大小</h1><p id="c6ac" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">由于计算时间和限制，如果上传的照片大于 800 像素，我想把它调整到 800 像素。我用 Opencv 写了一个简单的函数。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="cf4e" class="oc kz it ny b gy od oe l of og">def resize_one(fn,img_size=800):<br/>   dest = 'image/image_bw/temp_bw.jpg'<br/>   <br/>   # Load the image<br/>   img=cv2.imread(str(fn))<br/>   height,width  = img.shape[0],img.shape[1]</span><span id="ebf2" class="oc kz it ny b gy oj oe l of og">if max(width, height)&gt;img_size:<br/>   if height &gt; width:<br/>      width=width*(img_size/height)<br/>      height=img_size<br/>      img=cv2.resize(img,(int(width), int(height)))<br/>   elif height &lt;= width:<br/>      height=height*(img_size/width)<br/>      width=img_size<br/>      img=cv2.resize(img,(int(width), int(height)))</span><span id="3063" class="oc kz it ny b gy oj oe l of og">cv2.imwrite(str(dest),img)</span></pre><h1 id="6a42" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">加载模型</h1><p id="282b" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">如前所述，我使用 fastai 训练模型，所以我使用 fastai 加载模型，我创建了一个函数来加载它。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="7c07" class="oc kz it ny b gy od oe l of og">def create_learner(path,file):<br/>   learn_gen=load_learner(path,file)<br/>   return learn_gen</span></pre><h1 id="4e53" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">分析上传的照片并显示结果</h1><p id="ffe9" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">然后我需要一个函数来预测图像的颜色，并使用 st.image 显示图像，请注意 st.image 无法读取 fastai 生成的张量，所以我需要 image2np()将其转换为 Numpy 数组。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="628d" class="oc kz it ny b gy od oe l of og">def predict_img(fn,learn_gen,img_width=640):<br/>   _,img,b=learn_gen.predict(open_image(fn))<br/>   img_np=image2np(img)<br/>   st.image(img_np,clamp=True,width=img_width)</span></pre><h1 id="08dc" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">把它们放在一起</h1><p id="aab6" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">现在我已经有了我需要的一切，让我们把它们放在主函数中。</p><p id="e1c4" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">首先，我从外部链接下载模型，并制作页面标题</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="632f" class="oc kz it ny b gy od oe l of og">def main():<br/>   for filename in EXTERNAL_DEPENDENCIES.keys():<br/>      download_file(filename)</span><span id="5ca7" class="oc kz it ny b gy oj oe l of og">   st.title("Black&amp;White Photos Colorisation")</span></pre><p id="da5c" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后我制作照片上传器，调整上传照片的大小并显示它</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="89d9" class="oc kz it ny b gy od oe l of og">   uploaded_file = st.file_uploader("upload a black&amp;white photo", type=['jpg','png','jpeg'])<br/>   <br/>   if uploaded_file is not None:<br/>      g = io.BytesIO(uploaded_file.read())  # BytesIO Object<br/>      temporary_location = "image/temp.jpg"<br/>   <br/>      with open(temporary_location, 'wb') as out:  # Open temporary file as bytes<br/>         out.write(g.read())  # Read bytes into file<br/>         # close file<br/>         out.close()</span><span id="4602" class="oc kz it ny b gy oj oe l of og">   resize_one("image/temp.jpg",img_size=800)<br/>   st.image("image/temp.jpg",width=800)</span></pre><p id="fc42" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后，我制作一个按钮来调用创建模型和预测函数</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="138c" class="oc kz it ny b gy od oe l of og">start_analyse_file = st.button('Analyse uploaded file')<br/>if start_analyse_file== True:<br/>   learn_gen=create_learner(path='',file='export_5.pkl')<br/>   predict_img("image/image_bw/temp_bw.jpg",learn_gen,img_width=800)</span></pre><p id="867a" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后最后调用这个主函数</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="6e44" class="oc kz it ny b gy od oe l of og">if __name__ == "__main__":<br/>   main()</span></pre><p id="270d" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">web 应用程序已准备就绪。我可以通过这个命令在我的本地机器上测试它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/b56729a4c50bec1da3e016179e636b16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWCILz1DtrxSM9KRqtAgMA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9de658be719aff9e0b5c29d86e89b830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*l256Yu1wAkk8JS2aNfwkAA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">黑白照片彩色化的 Web 应用程序。</p></figure><h1 id="7dd6" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">部署到 Heroku</h1><p id="69ba" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">部署到 Heroku 非常简单——只需按下它。</p><p id="3c4f" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">我还需要三个文件:requirements.txt、setup.sh 和 Procfile。</p><h2 id="5567" class="oc kz it bd la ol om dn le on oo dp li lz op oq lk md or os lm mh ot ou lo ov bi translated">requirements.txt</h2><p id="b63b" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">它包含 Heroku 需要安装的软件包。就我而言:</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="3fdc" class="oc kz it ny b gy od oe l of og">scikit_image==0.17.2<br/>numpy==1.17.2<br/>opencv_python==4.1.1.26<br/>streamlit==0.64.0<br/>pandas==0.25.1<br/>https://download.pytorch.org/whl/cpu/torch-1.6.0%2Bcpu-cp36-cp36m-linux_x86_64.whl<br/>fastai</span></pre><h2 id="3266" class="oc kz it bd la ol om dn le on oo dp li lz op oq lk md or os lm mh ot ou lo ov bi translated">setup.sh</h2><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="02c8" class="oc kz it ny b gy od oe l of og">mkdir -p ~/.streamlit<br/>echo "[server]<br/>headless = true<br/>port = $PORT<br/>enableCORS = false<br/>" &gt; ~/.streamlit/config.toml</span></pre><h2 id="cdf8" class="oc kz it bd la ol om dn le on oo dp li lz op oq lk md or os lm mh ot ou lo ov bi translated">Procfile</h2><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="4c2e" class="oc kz it ny b gy od oe l of og">web: sh setup.sh &amp;&amp; streamlit run run.py</span></pre><p id="7b2d" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后注册一个免费的 Heroku 账号，下载并安装 Heroku CLI。</p><p id="7d61" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">登录 Heroku，会弹出一个窗口输入账号和密码</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="3bc5" class="oc kz it ny b gy od oe l of og">heroku login</span></pre><p id="e837" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后创建一个 web 应用程序</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="2d76" class="oc kz it ny b gy od oe l of og">heroku create yourapp</span></pre><p id="aefe" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">将显示类似这样的内容</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="64f4" class="oc kz it ny b gy od oe l of og">Creating app… done, ⬢ yourapp<br/>https://yourapp.herokuapp.com/ | <br/>https://git.heroku.com/yourapp.git</span></pre><p id="2436" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">然后把回购推给 Heroku</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="38e5" class="oc kz it ny b gy od oe l of og">git add .<br/>git commit -m "Enter your message here"<br/>git push heroku master</span></pre><p id="f7c1" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">它将开始下载和安装包，过一会儿，它就准备好了。</p><p id="685e" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">现在模型已经上线运行。但是…当我点击分析时，它崩溃了。这可能是由于 Heroku 自由层帐户的计算限制，它提供了 512MB 的内存，这是不够的。所以我不得不将照片的大小调整为 256 以使其运行，结果不是很令人满意，但至少有一些东西在运行。我觉得简单升级账号就能解决。</p><p id="786e" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">有兴趣可以试试。<a class="ae oh" href="https://colorisation.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://colorisation.herokuapp.com/</a></p><p id="537b" class="pw-post-body-paragraph lq lr it ls b lt ne ju lv lw nf jx ly lz ng mb mc md nh mf mg mh ni mj mk ml im bi translated">感谢阅读，随时给我任何建议和意见！</p></div></div>    
</body>
</html>