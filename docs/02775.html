<html>
<head>
<title>Modelling Volatile Time Series with LSTM Networks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 LSTM 网络模拟波动时间序列</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/modelling-volatile-time-series-with-lstm-networks-51250fb7cfa3?source=collection_archive---------19-----------------------#2020-03-17">https://towardsdatascience.com/modelling-volatile-time-series-with-lstm-networks-51250fb7cfa3?source=collection_archive---------19-----------------------#2020-03-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3351" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这是一个长短期记忆网络(LSTM)如何被用来模拟一个不稳定的时间序列的例子。</h2></div><p id="2314" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每年的降雨量数据可能很不稳定。不同于气温，气温通常显示出一个明显的季节趋势，降雨量作为一个时间序列是相当不稳定的。在爱尔兰，夏季和冬季一样多雨并不罕见。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/3ae342912ee79e64d62acc4d0aac6d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y02vAT5FZQ3En_tb8sIWMw.jpeg"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">资料来源:pixabay.com</p></figure><p id="bef1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是爱尔兰纽波特 1959 年 11 月的降雨模式的图解说明:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/eb1cb9dfc07f09dcbd4f00a7ecbad413.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/0*FBGoacPwI7WkpK2G.png"/></div></figure><p id="d97c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一个序列神经网络，LSTM 模型在解释时间序列的波动性方面可以证明是优越的。</p><p id="3c93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用 Ljung-Box 检验，小于 0.05 的 p 值表明该时间序列中的残差呈现随机模式，表明波动性显著:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="4cd2" class="ma mb it lw b gy mc md l me mf">&gt;&gt;&gt; res = sm.tsa.ARMA(tseries, (1,1)).fit(disp=-1)<br/>&gt;&gt;&gt; sm.stats.acorr_ljungbox(res.resid, lags=[10])<br/>(array([78.09028704]), array([1.18734005e-12]))</span></pre><h1 id="ac88" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">数据操作和模型配置</h1><p id="ef09" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">正在讨论的数据集包括 722 个月的降雨数据。爱尔兰新港的降雨量数据来源于英国气象局网站。</p><p id="7cbb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择 712 个数据点用于训练和验证目的，即建立 LSTM 模型。然后，将过去 10 个月的数据用作测试数据，与 LSTM 模型的预测进行比较。</p><p id="44c5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是数据集的一个片段:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/93280fde6d58e383e45fe312ee07fc3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/0*NKSNaoYaenIOFQEV.png"/></div></figure><p id="06c4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后形成数据集矩阵，以便根据过去的值回归时间序列:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="9072" class="ma mb it lw b gy mc md l me mf"># Form dataset matrix<br/>def create_dataset(df, previous=1):<br/>    dataX, dataY = [], []<br/>    for i in range(len(df)-previous-1):<br/>        a = df[i:(i+previous), 0]<br/>        dataX.append(a)<br/>        dataY.append(df[i + previous, 0])<br/>    return np.array(dataX), np.array(dataY)</span></pre><p id="d809" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后用 MinMaxScaler 对数据进行归一化处理:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/7a41f3aa68b0430ea41113b2bd1fb357.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/0*g0tlM6OUAhPXxjAG.png"/></div></figure><p id="8e6d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着<em class="nf">先前的</em>参数被设置为 120，训练和验证数据集被创建。作为参考，<em class="nf"> previous = 120 </em>表示模型使用从<em class="nf"> t — 120 </em>到<em class="nf"> t — 1 </em>的过去值来预测时间<em class="nf"> t </em>的降雨量值。</p><p id="a18c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择<em class="nf">之前的</em>参数需要反复试验，但选择了 120 个时间段，以确保捕捉到时间序列显示的波动性或极值。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="25d5" class="ma mb it lw b gy mc md l me mf">import tensorflow as tf<br/>from tensorflow.keras import layers<br/>from tensorflow.keras.layers import Dense<br/>from tensorflow.keras.layers import LSTM</span><span id="39d4" class="ma mb it lw b gy ng md l me mf"># Training and Validation data partition<br/>train_size = int(len(df) * 0.8)<br/>val_size = len(df) - train_size<br/>train, val = df[0:train_size,:], df[train_size:len(df),:]</span><span id="c5ad" class="ma mb it lw b gy ng md l me mf"># Number of previous<br/>previous = 120<br/>X_train, Y_train = create_dataset(train, previous)<br/>X_val, Y_val = create_dataset(val, previous)</span></pre><p id="b383" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后输入被整形为<em class="nf">样本、时间步长、特征</em>的格式。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d113" class="ma mb it lw b gy mc md l me mf"># reshape input to be [samples, time steps, features]<br/>X_train = np.reshape(X_train, (X_train.shape[0], 1, X_train.shape[1]))<br/>X_val = np.reshape(X_val, (X_val.shape[0], 1, X_val.shape[1]))</span></pre><h1 id="07cb" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">模型训练和预测</h1><p id="d32e" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">该模型跨 100 个时期进行训练，并且指定了 712(等于训练和验证集中的数据点的数量)的批量大小。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="4bd9" class="ma mb it lw b gy mc md l me mf"># Generate LSTM network<br/>model = tf.keras.Sequential()<br/>model.add(LSTM(4, input_shape=(1, previous)))<br/>model.add(Dense(1))<br/>model.compile(loss='mean_squared_error', optimizer='adam')<br/>history=model.fit(X_train, Y_train, validation_split=0.2, epochs=100, batch_size=448, verbose=2)<br/></span><span id="31de" class="ma mb it lw b gy ng md l me mf"># list all data in history<br/>print(history.history.keys())<br/># summarize history for accuracy<br/>plt.plot(history.history['loss'])<br/>plt.plot(history.history['val_loss'])<br/>plt.title('model loss')<br/>plt.ylabel('loss')<br/>plt.xlabel('epoch')<br/>plt.legend(['train', 'val'], loc='upper left')<br/>plt.show()</span></pre><p id="febe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是培训与验证损失的关系图:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/64989a73267a76361cac2824ab525d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/0*KsRLveLHA7R0GCbU.png"/></div></figure><p id="31dd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还生成了预测降雨量与实际降雨量的关系图:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="fd45" class="ma mb it lw b gy mc md l me mf"># Plot all predictions<br/>inversetransform, =plt.plot(scaler.inverse_transform(df))<br/>trainpred, =plt.plot(trainpredPlot)<br/>valpred, =plt.plot(valpredPlot)<br/>plt.xlabel('Days')<br/>plt.ylabel('Rainfall')<br/>plt.title("Predicted vs. Actual Rainfall")<br/>plt.show()</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/af946d70cf9febbacc2fcbecd2e7954d.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/0*qoxUYHAXVx6fEIYJ.png"/></div></figure><p id="68ec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将预测结果与基于平均方向精度(MDA)、均方根误差(RMSE)和平均预测误差(MFE)的验证集进行比较。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="4720" class="ma mb it lw b gy mc md l me mf">&gt;&gt;&gt; def mda(actual: np.ndarray, predicted: np.ndarray):<br/>&gt;&gt;&gt;     """ Mean Directional Accuracy """<br/>&gt;&gt;&gt;     return np.mean((np.sign(actual[1:] - actual[:-1]) == np.sign(predicted[1:] - predicted[:-1])).astype(int))<br/>    <br/>&gt;&gt;&gt; mda(Y_val, predictions)</span><span id="568f" class="ma mb it lw b gy ng md l me mf">0.9090909090909091</span><span id="9715" class="ma mb it lw b gy ng md l me mf">&gt;&gt;&gt; from sklearn.metrics import mean_squared_error<br/>&gt;&gt;&gt; from math import sqrt<br/>&gt;&gt;&gt; mse = mean_squared_error(Y_val, predictions)<br/>&gt;&gt;&gt; rmse = sqrt(mse)<br/>&gt;&gt;&gt; print('RMSE: %f' % rmse)</span><span id="b5c9" class="ma mb it lw b gy ng md l me mf">RMSE: 49.99</span><span id="2d0a" class="ma mb it lw b gy ng md l me mf">&gt;&gt;&gt; forecast_error = (predictions-Y_val)<br/>&gt;&gt;&gt; forecast_error<br/>&gt;&gt;&gt; mean_forecast_error = np.mean(forecast_error)<br/>&gt;&gt;&gt; mean_forecast_error</span><span id="1e1c" class="ma mb it lw b gy ng md l me mf">-1.267682231556286</span></pre><ul class=""><li id="c995" class="ni nj it kk b kl km ko kp kr nk kv nl kz nm ld nn no np nq bi translated">丙二醛: 0.909</li><li id="a42b" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">RMSE:49.99 美元</li><li id="7583" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">MFE:  -1.26</li></ul><h1 id="aa4f" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">根据测试数据进行预测</h1><p id="bb1e" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">虽然验证集的演示结果相当不错，但只有通过将模型预测与测试(或看不见的)数据进行比较，我们才有理由相信 LSTM 模型具有预测能力。</p><p id="0b3c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如前所述，过去 10 个月的降雨量数据用作测试集。然后，使用 LSTM 模型预测未来 10 个月，并将预测值与实际值进行比较。</p><p id="e8c8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">向下到<em class="nf"> t-120 </em>的先前值用于预测时间<em class="nf"> t </em>的值:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="a421" class="ma mb it lw b gy mc md l me mf"># Test (unseen) predictions<br/>Xnew = np.array([tseries.iloc[592:712],tseries.iloc[593:713],tseries.iloc[594:714],tseries.iloc[595:715],tseries.iloc[596:716],tseries.iloc[597:717],tseries.iloc[598:718],tseries.iloc[599:719],tseries.iloc[600:720],tseries.iloc[601:721]])</span></pre><p id="a64c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">获得的结果如下:</p><ul class=""><li id="f2eb" class="ni nj it kk b kl km ko kp kr nk kv nl kz nm ld nn no np nq bi translated"><strong class="kk iu">丙二醛:</strong> 0.8</li><li id="b5d7" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">RMSE:49.57 美元</li><li id="32e9" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated"><strong class="kk iu"> MFE: </strong> -6.94</li></ul><p id="ad7b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于过去 10 个月的平均降雨量为 148.93 毫米，预测精度表现出与验证集相似的性能，相对于测试集计算的平均降雨量，误差较低。</p><h1 id="a296" class="mg mb it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">结论</h1><p id="562e" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">在本例中，您看到了:</p><ul class=""><li id="7b1a" class="ni nj it kk b kl km ko kp kr nk kv nl kz nm ld nn no np nq bi translated">如何准备用于 LSTM 模型的数据</li><li id="6507" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">LSTM 模型的构建</li><li id="3e33" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">如何检验 LSTM 预测的准确性</li><li id="f9df" class="ni nj it kk b kl nr ko ns kr nt kv nu kz nv ld nn no np nq bi translated">使用 LSTM 建模波动时间序列的优势</li></ul><p id="c2d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">非常感谢您的宝贵时间，这个例子的相关库可以在<a class="ae nc" href="https://github.com/MGCodesandStats/weather-modelling" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="f20a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你也可以在 michael-grogan.com<a class="ae nc" href="https://www.michael-grogan.com/" rel="noopener ugc nofollow" target="_blank">找到更多我的数据科学内容。</a></p><p id="9032" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nf">免责声明:本文是在“原样”的基础上编写的，没有任何担保。它旨在提供数据科学概念的概述，不应被解释为专业建议。本文中的发现和解释是作者的观点，不以任何方式得到 Metéire ann 的认可或隶属于 Metéire ann。</em></p></div></div>    
</body>
</html>