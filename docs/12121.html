<html>
<head>
<title>Target Encoding For Multi-Class Classification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多类分类的目标编码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/target-encoding-for-multi-class-classification-c9a7bcb1a53?source=collection_archive---------12-----------------------#2020-08-21">https://towardsdatascience.com/target-encoding-for-multi-class-classification-c9a7bcb1a53?source=collection_archive---------12-----------------------#2020-08-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="06b2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">category_encoders 的 TargetEncoder 有什么问题？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0711c5be4250f089222a4d0f0ca4e4c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NStTtmWMOSy_ZZKr"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@heftiba?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Toa Heftiba </a>拍摄的照片</p></figure><p id="7582" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章是我的上一篇文章<a class="ae kv" rel="noopener" target="_blank" href="/all-about-target-encoding-d356c4e9e82">的延续，我的上一篇文章解释了目标编码实际上是如何工作的</a>。文章通过理论和实例说明了二分类任务的编码方法，以及<a class="ae kv" href="http://contrib.scikit-learn.org/category_encoders/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="ls">类别编码器</em> </a>库如何对多类目标给出不正确的结果。本文展示了当<em class="ls"> category_encoders 的<em class="ls"> TargetEncoder </em>失败时，</em>给出了编码多类目标<em class="ls">、</em>背后的理论，并提供了正确的代码，以及一个示例。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="aac6" class="ma mb iq bd mc md me dn mf mg mh dp mi lf mj mk ml lj mm mn mo ln mp mq mr ms bi translated">TargetEncoder 什么时候失败？</h2><p id="1f0a" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf mv lh li lj mw ll lm ln mx lp lq lr ij bi translated">看看这个数据。颜色是一个特征，目标是好的...目标。我们的目标是基于目标对颜色进行编码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/e076e5aaaf9fb8c9e0102b7690133e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:362/format:webp/1*rUbMHkokB5YOkMslmT6Q1w.png"/></div></figure><p id="d626" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在这上面做通常的目标编码。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="cc71" class="ma mb iq na b gy ne nf l ng nh">import category_encoders as ce</span><span id="30cb" class="ma mb iq na b gy ni nf l ng nh">ce.TargetEncoder(smoothing=0).fit_transform(df.Color,df.Target)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/063dac41b36c95abb89daabcd44aed9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:216/format:webp/1*UhhemFCLP2W939AynpF8kA.png"/></div></figure><p id="d8e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯，这看起来不太对，是吗？所有颜色都被替换为 1。为什么？因为 TargetEncoder 采用每种颜色的所有目标值的平均值，而不是概率。</p><p id="ae2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然 TargetEncoder 适用于二进制目标为 0 和 1 的情况，但它不适用于以下两种情况:</p><ol class=""><li id="90da" class="nk nl iq ky b kz la lc ld lf nm lj nn ln no lr np nq nr ns bi translated">当目标是二进制，而不是 0/1 时。比如 1 和 2s。</li><li id="1378" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">当目标是多类时，如上例所示。</li></ol><p id="cc1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，怎么办！？</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="c83d" class="ma mb iq bd mc md me dn mf mg mh dp mi lf mj mk ml lj mm mn mo ln mp mq mr ms bi translated">该理论</h2><p id="ca44" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf mv lh li lj mw ll lm ln mx lp lq lr ij bi translated">下面是 Daniele Micci-Barreca 的<a class="ae kv" href="https://dl.acm.org/doi/10.1145/507533.507538" rel="noopener ugc nofollow" target="_blank">原始论文</a>中介绍的针对多类目标的均值目标编码。</p><p id="9840" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设标签中有 n 个类。</p><p id="137f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">理论上说，第一步是一次性编码你的标签。这给出了 n 个二进制列，每个列对应于目标的一个类。然而，只有 n-1 个二进制列是线性无关的。因此，这些列中的任何一列都可以删除。现在，使用每个二进制标签对每个分类特征使用通常的目标编码，一次一个。因此，对于一个分类特征，您得到 n-1 个目标编码特征。如果数据集中有 k 个分类要素，则总共会得到 k 倍(n-1)个要素。</p><p id="09f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们用一个例子来理解。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="b700" class="ma mb iq bd mc md me dn mf mg mh dp mi lf mj mk ml lj mm mn mo ln mp mq mr ms bi translated">一个例子</h2><p id="a46f" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf mv lh li lj mw ll lm ln mx lp lq lr ij bi translated">我们继续前面的数据。</p><p id="e262" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步:一键编码标签。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="cb31" class="ma mb iq na b gy ne nf l ng nh">enc=ce.OneHotEncoder().fit(df.Target.astype(str))<br/>y_onehot=enc.transform(df.Target.astype(str))<br/>y_onehot</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/7c14ce5b6ac4dd648716d80a974053c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*9LorUdFygbU4vtQRqiO_5g.png"/></div></figure><p id="acbd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，Target_1 列表示目标中是否存在 0。如果目标中有 0，则为 1，否则为 0。类似地，Target_2 列表示目标中是否存在 1。</p><p id="07b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤 2: </strong>使用每个独热编码目标对颜色进行编码。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="4f50" class="ma mb iq na b gy ne nf l ng nh">class_names=y_onehot.columns</span><span id="8bd3" class="ma mb iq na b gy ni nf l ng nh">for class_ in class_names:</span><span id="7ae5" class="ma mb iq na b gy ni nf l ng nh">  enc=ce.TargetEncoder(smoothing=0)<br/>  print(enc.fit_transform(X,y_onehot[class_]))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/bb52f9d689164bb5db6abff2a275ad3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*hpeS4qs47QCuPXOoAmcURg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对于 0 类</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/6087f1498195b3b706d3f7e7863fd928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*5F7LDKbf1qRw9yvbJ2WJyw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对于 1 类</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/88e57e2fd36e573ab337e891e1d50249.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*Pdgh3PeilvKy04iBNDiNCA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对于二班</p></figure><p id="d712" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步:</strong>如果除了颜色还有更多分类特征，对所有特征重复第一步和第二步。</p><p id="2a3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成了！</p><p id="e0fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，数据集转换为:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/35d9929c7191c460fb8f0c049ae761d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7I73YVG6GoDeqS8IB6tPVg.png"/></div></div></figure><p id="42c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，为了清楚起见，我对所有三个 Color_Target 列进行了编码。如果您知道 one-hot 编码，那么您知道可以删除其中一列而不会丢失任何信息。因此，这里我们可以安全地删除 Color_Target_3 列，而不会丢失任何信息。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="61bb" class="ma mb iq bd mc md me dn mf mg mh dp mi lf mj mk ml lj mm mn mo ln mp mq mr ms bi translated">完整的代码</h2><p id="8813" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf mv lh li lj mw ll lm ln mx lp lq lr ij bi translated">你是来拿密码的，对吧！？</p><p id="36fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在这里给出了一个函数，它将 pandas 数据帧的特征和 pandas 系列的目标标签作为输入。特征 df 可以具有数字和分类特征的混合。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="d467" class="ma mb iq na b gy ne nf l ng nh">def target_encode_multiclass(X,y): #X,y are pandas df and series</span><span id="b5a0" class="ma mb iq na b gy ni nf l ng nh">    y=y.astype(str)   #convert to string to onehot encode<br/>    enc=ce.OneHotEncoder().fit(y)<br/>    y_onehot=enc.transform(y)</span><span id="60c8" class="ma mb iq na b gy ni nf l ng nh">    class_names=y_onehot.columns  #names of onehot encoded columns</span><span id="56e1" class="ma mb iq na b gy ni nf l ng nh">    X_obj=X.select_dtypes('object') #separate categorical columns<br/>    X=X.select_dtypes(exclude='object') </span><span id="cce1" class="ma mb iq na b gy ni nf l ng nh">    for class_ in class_names:<br/>      <br/>        enc=ce.TargetEncoder()<br/>        enc.fit(X_obj,y_onehot[class_]) #convert all categorical <br/>        temp=enc.transform(X_obj)       #columns for class_<br/>        temp.columns=[str(x)+'_'+str(class_) for x in temp.columns]<br/>        X=pd.concat([X,temp],axis=1)    #add to original dataset<br/>      <br/>    return X</span></pre></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="95e7" class="ma mb iq bd mc md me dn mf mg mh dp mi lf mj mk ml lj mm mn mo ln mp mq mr ms bi translated">结论</h2><p id="f4eb" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf mv lh li lj mw ll lm ln mx lp lq lr ij bi translated">在这篇文章中，我指出了 category_encoder 的 TargetEncoder 的问题。我解释了关于目标编码的原始论文对多类标签的看法。我通过一个例子解释了这一点，并为您提供了一个可在应用程序中即插即用的工作模块代码。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="8e03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://www.linkedin.com/in/mohannishant/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系！</p><p id="7723" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://github.com/mohannishant6" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上看看我的一些很酷的项目！</p></div></div>    
</body>
</html>