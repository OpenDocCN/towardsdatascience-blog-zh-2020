<html>
<head>
<title>From Streaming Data to COVID-19 Twitter Analysis: Using AWS Lambda, Kinesis Firehose and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从流数据到新冠肺炎 Twitter 分析:使用 AWS Lambda、Kinesis Firehose 和 Elasticsearch</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/from-streaming-data-to-covid-19-twitter-analysis-using-aws-lambda-kinesis-firehose-and-b71b71279335?source=collection_archive---------14-----------------------#2020-04-21">https://towardsdatascience.com/from-streaming-data-to-covid-19-twitter-analysis-using-aws-lambda-kinesis-firehose-and-b71b71279335?source=collection_archive---------14-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9415" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">释放 AWS 和 Elasticsearch 的力量</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7fe53f225a50cda6fe6c3ff317790826.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XM4PpaeksUOwQiduWmi-_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分析实时推文的仪表板。</p></figure><h1 id="99ef" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">介绍</h1><p id="d3a9" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在我之前的博文<a class="ae mj" rel="noopener" target="_blank" href="/playing-with-data-gracefully-1-a-near-real-time-data-pipeline-using-spark-structured-streaming-409dc1b4aa3a"> <em class="mk">从流数据到新冠肺炎 Twitter 分析:使用 Spark 和 AWS Kinesis </em> </a>中，我涵盖了用 Spark 和 AWS Kinesis 构建的数据管道。在这篇文章中，我将采用另一种方式来达到同样的目的。</p><p id="3750" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">在之前的工作经历中接触过 AWS Lambda 和 Elasticsearch。Lambda 的无服务器、事件触发特性以及与其他 AWS 工具的丰富连接给我留下了深刻的印象。Elasticsearch 向我展示了系统生成的杂乱日志是如何被整齐地处理的，并且在 Kibana 上是可见的。受到这篇文章的启发:<a class="ae mj" href="https://aws.amazon.com/blogs/big-data/building-a-near-real-time-discovery-platform-with-aws/" rel="noopener ugc nofollow" target="_blank"> <em class="mk">用 AWS </em> </a>构建一个接近实时的发现平台，我复制了数据管道并将其应用于 Twitter 上的新冠肺炎分析。为了尊重原创作品的版权，我不会将这个帖子货币化。</p><p id="64c8" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">与<a class="ae mj" href="https://aws.amazon.com/blogs/big-data/building-a-near-real-time-discovery-platform-with-aws/" rel="noopener ugc nofollow" target="_blank"> <em class="mk">参考文章</em> </a>相比，我新增内容如下:</p><ul class=""><li id="c050" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">进行代码更改以与依赖项的最新版本保持一致。</li><li id="0694" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">提供更多关于人们容易遇到的问题的细节，而这些问题在<em class="mk">参考文章</em>中没有涉及。</li><li id="e43a" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">遇到 Lambda 和 Elasticsearch 相关错误时如何调试？</li></ul><p id="bbd2" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">数据管道遵循接近实时流的时尚，从消化实时 Twitter 数据到可视化。组装拼图的大部分碎片来自 AWS 家族:<strong class="lp ir"> AWS Kinesis Firehose </strong>、<strong class="lp ir"> AWS S3 水桶</strong>、<strong class="lp ir"> AWS Lambda </strong>、<strong class="lp ir">亚马逊弹性搜索服务</strong>。架构是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/03b8ac93736766afea3acbe666befcdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5qhWRUvmtQr16ZERlhGxpg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数据管道的体系结构。</p></figure><p id="64a0" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">本文作为参考文章的补充指南，将讨论分为以下步骤:</p><ul class=""><li id="db3a" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">IAM 设置</li><li id="d879" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">创建亚马逊弹性搜索服务集群</li><li id="481f" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">配置 AWS Kinesis 消防软管和 S3</li><li id="fe8a" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">创建 AWS Lambda 函数</li><li id="3cc2" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">代码打包和更改</li><li id="14b4" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">Kibana 可视化和 Twitter 分析</li></ul><p id="fd0c" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">Lambda 函数和<a class="ae mj" href="https://github.com/joking-clock/twitter-capture-python" rel="noopener ugc nofollow" target="_blank"> Twitter 捕获程序</a>的代码已经上传到我的公共回购中。</p><h1 id="597a" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">IAM 设置</h1><p id="a2b3" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在构建数据管道之前，您需要有一个 AWS 帐户和 Twitter API 密钥以及访问令牌，这在参考文章的<em class="mk">的先决条件中也有提及。除此之外，IAM 角色非常重要，必须正确设置。需要两个角色:</em></p><ul class=""><li id="166c" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">Kinesis Firehose 需要一个 IAM 角色，并被授予传送流数据的权限，这将在 Kinesis 和 S3 桶一节中讨论。</li><li id="7f08" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">AWS Lambda 需要权限来访问 S3 事件触发器、添加 CloudWatch 日志以及与 Amazon Elasticserch 服务进行交互。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/5a442c65855d38a2d2c3fc730e76ff26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ObcDUIvw6YRjVPH3oXiokw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">lambda 函数的 IAM 角色 lambda-s3-es-role。</p></figure><p id="e57f" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">如上图所示，我给 Lambda 执行角色<em class="mk"> lambda-s3-es-role </em>附加了三个策略。如果您不确定如何配置策略，我将这些策略附在<a class="ae mj" href="https://github.com/joking-clock/twitter-analysis-bigdata/tree/master/aws_lambda_elasticsearch/Lambda_policies" rel="noopener ugc nofollow" target="_blank"> repo </a>中以供参考。</p><h1 id="885c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">创建亚马逊弹性搜索服务集群</h1><p id="7e04" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我假设读者已经按照参考文章<em class="mk">中的步骤在<a class="ae mj" href="https://console.aws.amazon.com/es/home" rel="noopener ugc nofollow" target="_blank"> Amazon ES 主页</a>创建了一个 Amazon ES 域。对于自由层用户，他们可以选择 t2.micro 或 t2.small 等实例类型，并免费获得 750 小时的 Amazon ES 使用时间。创建 ES 域时需要注意几点:</em></p><ul class=""><li id="b4d2" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">无需设置“专用主节点”。</li><li id="8d83" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">作为演示项目，我在“网络配置”中选择公共接入。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/63f588cfdeb6a774c225abe057908862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zDwVictGyQ6QRHVtXLxYMQ.jpeg"/></div></div></figure><p id="5873" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">事情是这样的。在配置"访问策略"时，选择"客户访问策略"，需要添加以下策略:</p><ol class=""><li id="aaf0" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi nh mw mx my bi translated">选择“ARN”，允许 lambda 执行角色<em class="mk"> lambda-s3-es-role </em>访问 es 服务。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/ed03d3056a97b82b720072b3604c9870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BVmMwwGekCvwovSSixvuhw.png"/></div></div></figure><p id="9e7c" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">我在这里留下一个疑问:<strong class="lp ir">设置是否正确？我们稍后会测试它。</strong></p><h1 id="d110" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">配置 AWS Kinesis 消防软管和 S3</h1><p id="a9b6" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">与<em class="mk">参考文章</em>不同，我选择在<a class="ae mj" href="https://console.aws.amazon.com/firehose/home" rel="noopener ugc nofollow" target="_blank"> Kinesis 消防水龙带流控制台</a>创建一个 Kinesis 消防水龙带。步骤很简单:</p><ul class=""><li id="dfd3" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">填写消防水带流的名称</li><li id="6417" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">来源:直接投资或其他来源</li><li id="0a75" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">目的地:一个 S3 桶，用于存储数据文件(实际上是推文)。在这里，您可以选择一个您已经创建的 S3 桶或创建一个新的飞行。</li><li id="ce75" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">权限。</li></ul><p id="71c2" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">正如在<strong class="lp ir"> IAM 部分</strong>中提到的，一个 Firehose 流需要 IAM 角色来包含所有必要的权限。单击“新建或选择”，并选择“创建新的 IAM 角色”，或使用现有的角色。默认策略将被附加，并应满足需要。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/d82efebe6f72cf48551b5df5fe34097c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*5SKNRFdwPSD-OwG9DoMrxA.png"/></div></figure><p id="b8c4" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">Kinesis Data Firehose Stream (KDF)和 Kinesis Data Stream (KDS)有时可能会让人混淆。KDF 在传输流数据时有额外的功能。在传递到目的地的过程中，源数据可以通过 Lambda 函数进行转换。我的另一个<a class="ae mj" rel="noopener" target="_blank" href="/playing-with-data-gracefully-1-a-near-real-time-data-pipeline-using-spark-structured-streaming-409dc1b4aa3a">帖子</a>涵盖了 KDF 的用法。</p><h1 id="7777" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">创建 AWS Lambda 函数</h1><p id="ca5f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">AWS Lambda 在这个管道中起着核心作用。我们将创建一个 Lambda 函数来完成以下工作:</p><ul class=""><li id="7f12" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">一旦在目标 S3 桶中创建了新的数据文件，Lambda 函数就会被触发。</li><li id="87f4" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">数据将使用指定的结构进行解析，这与文档的映射一致。</li><li id="0cac" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">数据将被加载到 ES 集群中。</li></ul><p id="937f" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">一下子实现这样一个 Lambda 函数很难。将繁琐的过程分成更小的步骤，我首先需要正确设置 Lambda 环境。</p><p id="b43d" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">在<a class="ae mj" href="https://console.aws.amazon.com/lambda/home" rel="noopener ugc nofollow" target="_blank"> AWS Lambda 主页</a>创建功能:</p><ul class=""><li id="7914" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">选择 Python 3.7 运行时。</li><li id="3ef4" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">选择<em class="mk"> lambda-s3-es-role </em>作为执行角色<em class="mk">。</em></li><li id="7de5" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">将内存保持在 128 MB，并将超时设置为 2 分钟。</li><li id="2241" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">为 S3 添加一个触发器。如果任何新文件进入 S3 桶，Lambda 函数将接收事件并被调用。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/74e687b093e0145db4ba12d889d7f286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*MmfhCzoFpJsBA88ERdJUlg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">为 Lambda 函数创建一个 S3 触发器，注意前缀“debug”用于调试，可以根据需要替换。</p></figure><p id="7051" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">现在，我们可以测试 Lambda 函数是否能对 S3 事件做出反应。使用示例代码和配置好的处理程序，我们将一个文件放入 S3 桶<em class="mk"> twitter-stream-sink。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/94112eda503cc4b0adaf5f4ea1a35281.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Aa0WWTfT2OJffOfKkgJskw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个 Lambda 函数，并将一个测试文件放入 S3 桶中。请注意，处理程序名称应该与函数代码中的入口函数相匹配。</p></figure><p id="2433" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">在 Lambda function 面板的“Monitoring”选项卡上，有一个点出现在指标图上。单击“查看 CloudWatch 中的日志”，我们得到了这次调用的<em class="mk"> CloudWatch </em>日志，该日志打印了我们刚刚放入的源 S3 桶和文件名。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/4b4d2b371c590945c06915ef7017cd83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eMUIYy8PlytK02sA0AJ-Lw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">左侧窗口显示了度量图中的一个点，表示对 Lambda 函数的调用。右侧窗口显示了 CloudWatch 日志的详细信息。</p></figure><h1 id="aca4" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">代码打包和更改</h1><p id="b83c" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="mk">参考文章</em>是几年前发表的，所以项目代码需要更新。</p><p id="ad9c" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">项目代码可以从<a class="ae mj" href="https://github.com/joking-clock/twitter-analysis-bigdata/tree/master/aws_lambda_elasticsearch/code_base" rel="noopener ugc nofollow" target="_blank"> repo </a>下载。代码目录包含 4 个 python 文件:<em class="mk"> config.py </em>，<em class="mk"> myhandle.py </em>，<em class="mk"> tweet_utils.py </em>，<em class="mk"> twitter_to_es.py </em>。要将必要的库添加到项目文件夹中，只需键入命令:</p><pre class="kg kh ki kj gt nn no np nq aw nr bi"><span id="517f" class="ns kw iq no b gy nt nu l nv nw">pip install library_name -t .</span></pre><p id="da5d" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">导入到项目目录所需的库如下:</p><pre class="kg kh ki kj gt nn no np nq aw nr bi"><span id="2d50" class="ns kw iq no b gy nt nu l nv nw">requests<br/>requests_aws4auth<br/>elasticsearch<br/>textblob=0.15</span></pre><p id="44de" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">Lambda 函数接受 zip 格式的代码包。将代码目录与库打包需要以下命令:</p><pre class="kg kh ki kj gt nn no np nq aw nr bi"><span id="cec0" class="ns kw iq no b gy nt nu l nv nw">zip -r ../your_package_name.zip * -x "*.git*"</span></pre><p id="37b7" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">关于 Lambda 部署包的教程可以在<a class="ae mj" href="https://docs.aws.amazon.com/lambda/latest/dg/python-package.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda 文档</a>中找到。</p><p id="4738" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">现在让我们看一下每个 python 文件:</p><h2 id="cc9b" class="ns kw iq bd kx nx ny dn lb nz oa dp lf lw ob oc lh ma od oe lj me of og ll oh bi translated">myhandle.py</h2><ul class=""><li id="285b" class="mq mr iq lp b lq lr lt lu lw oi ma oj me ok mi mv mw mx my bi translated">充当 Lambda 函数的入口点。</li><li id="6ba7" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">解析事件信息，获取 JSON 格式的 S3 文件内容。</li></ul><h2 id="9088" class="ns kw iq bd kx nx ny dn lb nz oa dp lf lw ob oc lh ma od oe lj me of og ll oh bi translated">twitter_to_es.py</h2><ul class=""><li id="d10c" class="mq mr iq lp b lq lr lt lu lw oi ma oj me ok mi mv mw mx my bi translated">向 es 集群添加索引和映射。</li><li id="5f55" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">采用<a class="ae mj" href="https://elasticsearch-py.readthedocs.io/en/master/helpers.html" rel="noopener ugc nofollow" target="_blank"> bulk </a>方式将解析后的数据加载到 ES 集群中。</li><li id="73b2" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">授权发送到 ES 集群的请求。</li></ul><h2 id="a2f0" class="ns kw iq bd kx nx ny dn lb nz oa dp lf lw ob oc lh ma od oe lj me of og ll oh bi translated">tweet_utils.py</h2><ul class=""><li id="dddb" class="mq mr iq lp b lq lr lt lu lw oi ma oj me ok mi mv mw mx my bi translated">充当助手模块。</li><li id="1fd4" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">将推文解析到结构化字典中。</li><li id="11d1" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">使用 TextBlob 分析推特上的情绪。</li></ul><h2 id="f5ca" class="ns kw iq bd kx nx ny dn lb nz oa dp lf lw ob oc lh ma od oe lj me of og ll oh bi translated">配置. py</h2><ul class=""><li id="8e64" class="mq mr iq lp b lq lr lt lu lw oi ma oj me ok mi mv mw mx my bi translated">充当共享配置。</li></ul><p id="326e" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">与<em class="mk">参考文章</em>中的<a class="ae mj" href="https://github.com/amazon-archives/aws-big-data-blog/tree/master/aws-blog-firehose-lambda-elasticsearch-near-real-time-discovery-platform" rel="noopener ugc nofollow" target="_blank">原代码</a>相比，我做了一些代码改动:</p><ol class=""><li id="96e2" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi nh mw mx my bi translated">将额外的库添加到包 requests_aws4auth，requests 中。</li></ol><p id="467d" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">2.将源代码从 Python 2 移植到 Python 3。</p><p id="2f1f" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">3.修复错误，因为 Elasticsearch 及其 Python 客户端库与以前的版本不兼容。</p><p id="b75e" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">为了将源代码从 Python 2 移植到 3，我们可以使用库<code class="fe ol om on no b">2to3</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/8c06c9c92e9892443afd3dcabf8628b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KwRzjgk2wLbtBGEz2KUPFw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用<em class="op"> 2to3 命令将 Python 2 代码移植到 Python 3 的例子。</em></p></figure><p id="0be1" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">不兼容问题已修复:</p><ul class=""><li id="17ae" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">自 Elasticsearch 7.0.0 发布以来，<a class="ae mj" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html" rel="noopener ugc nofollow" target="_blank">映射类型被移除</a>。</li><li id="9353" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">Elasticsearch 的<a class="ae mj" href="https://elasticsearch-py.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank"> Python 客户端</a>也经历了以前版本的变化，特别是<em class="mk"> bulk </em>方法的使用。</li></ul><p id="84c8" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">为了熟悉 Elasticsearch 的 Python 客户端，你可以打开一个<em class="mk"> Jupiter 笔记本</em>来测试与 ES 集群的连接。</p><p id="0ac4" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">研究完代码后，我们需要打包代码。为了测试 Lambda 函数，我们将一个捕获的 twitter 文件放入 S3 桶，并查看 tweets 是否被正确解析并加载到 e S 集群中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/9dbf1c337f7cc06d7be627f5134ced67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrhnrnv7WtO6LrATLFRQjw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">左边的窗口显示了 Lambda 函数的面板，右边的窗口显示了将带有 tweets 的样本数据文件放入 S3。</p></figure><p id="485d" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">如果数据成功加载到 ES 集群中，我们可以使用 Kibana 的“Discover”功能来检查它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/34c0ac0a22f8d46c5ef99451a234a6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrgxA_M0zdPe-GTVZaoF6g.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">左侧窗口显示调用 Lambda 函数期间的跟踪日志，右侧窗口显示加载到 es 中的 tweets。</p></figure><p id="7413" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">除了 Lambda 函数上的代码变化，我使用一个运行在 AWS EC2 实例上的 Python 程序来捕获 tweets，可以在这里找到<a class="ae mj" href="https://github.com/joking-clock/twitter-capture-python/blob/master/twitter-firehose.py" rel="noopener ugc nofollow" target="_blank"/>。<em class="mk">参考文章</em>包含一个<a class="ae mj" href="https://github.com/amazon-archives/aws-big-data-blog/tree/master/aws-blog-firehose-lambda-elasticsearch-near-real-time-discovery-platform/firehose-twitter-streaming-nodejs" rel="noopener ugc nofollow" target="_blank"> node.js 程序</a>来捕捉推文，它们都做同样的工作。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/3689e77b85de7401d5806b271a136392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pBgcLy8TM_9vap3jFrzr9A.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">运行 Python tweet 捕获程序</p></figure><p id="5daf" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">这里要注意一点。当我实现管道并尝试将数据加载到 ES 集群时，我在 Lambda 调用和 Kibana 上遇到了身份验证错误:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/879fba6edd4b5ee5f89a0b458f81c361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7X49Q11URsRcFmZBpN_OQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当我将一个数据文件放入 S3 桶时，Lambda 函数报告了这样一个错误。</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/62b64d35fd6818b4277191af885e1c4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3jE24ik8WNYyYCLLh-V-2g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当我在设置了 ES 集群后试图访问 Kibana 时。</p></figure><p id="7ba8" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">为了找出原因，我们需要去指定 Amazon ES 的<a class="ae mj" href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-ac.html" rel="noopener ugc nofollow" target="_blank">身份和访问管理</a>的页面。</p><blockquote class="ov ow ox"><p id="5478" class="ln lo mk lp b lq ml jr ls lt mm ju lv oy mn ly lz oz mo mc md pa mp mg mh mi ij bi translated">基于 IP 的策略的主要吸引力在于，它们允许对 Amazon ES 域的未签名请求，这允许您使用像<a class="ae mj" href="https://curl.haxx.se/" rel="noopener ugc nofollow" target="_blank"> curl </a>和<a class="ae mj" href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-kibana.html#es-managedomains-kibana" rel="noopener ugc nofollow" target="_blank"> Kibana </a>这样的客户端，或者通过代理服务器访问域。</p></blockquote><p id="3560" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated"><em class="mk">所有对 Amazon ES 配置 API 的请求都必须签名</em>。在上面的错误中，即使添加了 Lambda 执行角色，请求还是未签名并被拒绝，尤其是 HTTP 请求。为了解决这个问题，我们可以添加基于 IP 的策略，或者使用<a class="ae mj" href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-request-signing.html#es-request-signing-python" rel="noopener ugc nofollow" target="_blank"> AWS SDK 或请求</a>添加标志。因此，我们需要将基于 IP 的策略添加到 ES 访问策略中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/dfae73863ee81df4f9a0707ccaf175fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfBoGCuPcKPVR6kw47LrMA.png"/></div></div></figure><h1 id="c31e" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Kibana 可视化和 Twitter 分析</h1><p id="e221" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">一旦我们开始运行 twitter 捕获程序，大量的推文将被传入 S3，Lambda 函数将处理数据文件。反映数据的最佳方式是通过 Elasticsearch 中提供的可视化工具<em class="mk"> Kibana </em>。</p><p id="b34a" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">加载到 Elasticsearch 中的所有数据都需要分配索引，因此 Kibana 可以使用<em class="mk">索引模式</em>来检索数据。在<em class="mk"> twitter_to_es.py </em>中，推文用“twitter”做索引。现在我们可以创建一个索引模式“twitter*”，并开始在 Kibana 中发现数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/86279da6e31042a67ac18b8a4d492213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xw4qZzboRzebFvAYw-sOuw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建索引模式“twitter*”，以匹配所有以“twitter”开头的索引。</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pd"><img src="../Images/21f027dfb017d89649e44835dc34875d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UmlBtuksap81XHsyMwCsNg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当我们在 tweet_utils.py 中添加映射时，会指定“timestamp_ms”字段。</p></figure><p id="d4e6" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">创建索引模式后，我们可以通过选择左侧栏上的“Discover”按钮来浏览数据，数据可以按时间序列显示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pe"><img src="../Images/c22ea755f609fd57ffe4a5c0abb7b7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NGtLyg55Begg1qrhTBu1Kg.png"/></div></div></figure><p id="b4b8" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">在这篇文章中，我选择了标签“<strong class="lp ir"> #StayHome </strong>”和“<strong class="lp ir"># social distance</strong>”来挖掘 Twitter。像参考文章<em class="mk">一样，我创建了一个仪表板来可视化推文。仪表板中有三种可视化效果:</em></p><ul class=""><li id="7f83" class="mq mr iq lp b lq ml lt mm lw ms ma mt me mu mi mv mw mx my bi translated">一张坐标地图，展示推文的地理分布，仅当推文包含位置信息时有效。</li><li id="d5e0" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">一个饼图，展示用户发送推文时的情绪受欢迎程度，包括积极、中性和消极三种情绪。</li><li id="984b" class="mq mr iq lp b lq mz lt na lw nb ma nc me nd mi mv mw mx my bi translated">一个数据表，统计每个情绪中包含的表情符号，只列出前 5 个表情符号。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pf"><img src="../Images/7119d0a6ec19ecc5f827acec00335223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*no2vuNo_R-kBu7lg3757OA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在基巴纳创建的仪表板。</p></figure><h1 id="02a7" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">结论</h1><p id="945a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">AWS Lambda 和 Elasticsearch 是非常强大的技术，这篇文章可能只是展示了应用场景中的一个案例。除了实时数据处理，Lambda 还可以与 ETL(提取、转换、加载)和应用后端集成。Elasticsearch 在日志记录/日志分析和全文搜索方面已经建立了声誉。</p><p id="f79d" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated">我希望你在阅读和摆弄大数据技术时能够找到乐趣。这就是大数据让我着迷的地方。</p></div><div class="ab cl pg ph hu pi" role="separator"><span class="pj bw bk pk pl pm"/><span class="pj bw bk pk pl pm"/><span class="pj bw bk pk pl"/></div><div class="ij ik il im in"><p id="9133" class="pw-post-body-paragraph ln lo iq lp b lq ml jr ls lt mm ju lv lw mn ly lz ma mo mc md me mp mg mh mi ij bi translated"><strong class="lp ir"> <em class="mk">编者注:</em> </strong> <em class="mk"> </em> <a class="ae mj" href="http://towardsdatascience.com/" rel="noopener" target="_blank"> <em class="mk">走向数据科学</em> </a> <em class="mk">是一份以数据科学和机器学习研究为主的中型刊物。我们不是健康专家或流行病学家，本文的观点不应被解释为专业建议。想了解更多关于疫情冠状病毒的信息，可以点击</em> <a class="ae mj" href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports" rel="noopener ugc nofollow" target="_blank"> <em class="mk">这里</em> </a> <em class="mk">。</em></p></div></div>    
</body>
</html>