<html>
<head>
<title>Ibis: A Python Data Analysis Framework for Development and Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ibis:用于开发和生产的Python数据分析框架</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ibis-a-framework-to-tie-together-development-and-production-code-588d05e07d11?source=collection_archive---------32-----------------------#2020-04-12">https://towardsdatascience.com/ibis-a-framework-to-tie-together-development-and-production-code-588d05e07d11?source=collection_archive---------32-----------------------#2020-04-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="188d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Ibis通过统一的API将开发和生产阶段结合在一起。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/85ec8632e6c0badebc50c9fbf450b3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SqLmdE9a-9GQT_wC"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@alwig64?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚历克斯·维根</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="d3a1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">训练完你的机器学习模型后，你想投入生产。一旦您的模型被提供并准备好进行预测，您可能需要在将收到的数据发送到模型之前对其进行预处理。这可能是某种类型的要素工程或数据清理，但无论是什么，通常都会使用标准数据框来完成，一次一个样本。</p><p id="a4e5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然而，当您仍处于开发阶段时，您正在处理更大的数据，可能有数百万个训练样本或更多。在这种情况下，使用常规数据帧(例如熊猫)会太慢。所以你求助于其他工具，比如Spark，BigQuery等。</p><p id="b3f4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这就存在一个潜在的问题:这些工具有不同的API。对于Spark，它将是big Spark的DataFrame API对于BigQuery，应该是SQL。诸如此类。要点是:这段代码不同于您将在生产中使用的代码。从长远来看，维护两个不同的代码库并不是一个好主意。</p><p id="7ea7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">有解决这一困境的办法。例如，使用谷歌的数据流，它可以完全消除它，因为数据流可以在训练和预测时使用。另一个解决方案涉及<strong class="lc iu"> TensorFlow Extended </strong>，它的创建正是为了解决深度学习应用的这个问题。或者，您可以尝试尽可能多地提取核心功能，并使其可由定型代码和预测代码重用。</p><p id="46b0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这些解决方案都不完美，尽管Ibis也不完美，但这是一个有趣的提议，因为它从另一个角度处理问题，因此在这个领域非常独特。</p><p id="e2c1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Ibis提议的是一个用于数据操作的api，以及一个核心引擎，它将根据后端把这个高级api翻译成低级代码。因此，如果我们使用一个<strong class="lc iu"> pandas </strong>后端，Ibis将翻译成pandas python代码。如果我们使用一个<strong class="lc iu"> BigQuery </strong>后端，Ibis将转换成SQL。用户使用Ibis api编写代码，只是在训练和预测之间交换后端。</p><p id="7a33" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">目前，Ibis支持相当多的后端:pandas、Spark、BigQuery、PostgreSQL、sqlite等等。在项目健康方面，有一些正在进行的提交和问题，尽管它不是有史以来最活跃的项目。熊猫的创造者韦斯·麦金尼几年前是一名投稿人，但现在不是了。</p><p id="99e4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们看一个具体的例子，因为我是BigQuery的粉丝，所以我就从它开始。我将使用<code class="fe lx ly lz ma b">stackoverflow</code>公共数据集，特别是<code class="fe lx ly lz ma b">posts_questions</code>表。</p><p id="e3ee" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">安装必备组件:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="8a11" class="mf mg it ma b gy mh mi l mj mk">pip install ibis-framework <br/>pip install ibis-framework[bigquery]</span></pre><p id="80c8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了连接到BigQuery，我使用一个凭证文件:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="7684" class="mf mg it ma b gy mh mi l mj mk">from google.cloud import bigquery <br/>from google.oauth2.service_account import Credentials </span><span id="67ea" class="mf mg it ma b gy ml mi l mj mk">credentials = Credentials.from_service_account_file('path_to_file') client = bigquery.Client(credentials=credentials,<br/>                         project=credentials.project_id )</span></pre><p id="a543" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然后连接到表:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="3d56" class="mf mg it ma b gy mh mi l mj mk">import ibis </span><span id="5aa8" class="mf mg it ma b gy ml mi l mj mk">conn = ibis.bigquery.connect(project_id=credentials.project_id,<br/>                             credentials=credentials ) </span><span id="52b8" class="mf mg it ma b gy ml mi l mj mk">table = conn.table('posts_questions', <br/>                   database='bigquery-public-data.stackoverflow')</span></pre><p id="227e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们可以<code class="fe lx ly lz ma b">print(table)</code>:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/97aaa0f03d636ef285ad2fd77c1af226.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/0*RzTyeir8K9VAcVsT.png"/></div></figure><p id="48d3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">现在，我们可以进行一些简单的数据操作(例如，创建新列):</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="698c" class="mf mg it ma b gy mh mi l mj mk">projection = table['title', 'answer_count', 'creation_date'] </span><span id="d8e1" class="mf mg it ma b gy ml mi l mj mk">projection = projection.mutate(<br/>          year=projection.creation_date.year(),<br/>          javascript=projection.title.re_search('(?i)java.?script'),<br/>          answered=projection.answer_count &gt; 0)</span></pre><p id="7a1f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">此时，实际上没有从BigQuery中检索到任何行。Ibis只构建了内部执行图。</p><p id="c454" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">要实际执行查询:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="d3dd" class="mf mg it ma b gy mh mi l mj mk">res = projection.head().execute() <br/>res</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mn"><img src="../Images/acb5b0143d3927b799982f1adc25703c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5EkgUjCKR4TQXnn7.png"/></div></div></figure><p id="663a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">您会注意到，在上面的代码中，我只要求我的投影的头部，所以我只得到5行返回，但是我可以很容易地在整个表上运行查询。为了好玩，我们可以编译我们的投影，并查看Ibis为我们生成的代码:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="6f2b" class="mf mg it ma b gy mh mi l mj mk">ibis.bigquery.compile(projection)</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/54e3d60ad8469b61cccc6e1d21117836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/0*r44Nc1L1EgbJks_k.png"/></div></figure><p id="e815" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">漂亮！</p><p id="7fee" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">再过几个月，我们就可以投入生产了。这意味着，我们需要对小熊猫数据帧进行完全相同的预处理。</p><p id="cfdb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">没问题:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="e46d" class="mf mg it ma b gy mh mi l mj mk">import pandas as pd <br/>from datetime import datetime </span><span id="8f4b" class="mf mg it ma b gy ml mi l mj mk">df_local = pd.DataFrame({<br/>    'title': ['Matlab Function block with Design Verifier'],  <br/>    'answer_count': [1],<br/>    'creation_date': [datetime.now()]<br/>})</span></pre><p id="b998" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Ibis连接到本地数据框的方式如下:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="6ded" class="mf mg it ma b gy mh mi l mj mk">conn = ibis.pandas.connect({'data': df_local}) <br/>projection = conn.table('data')</span></pre><p id="f23f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">下面是我们在BigQuery上使用的几乎完全相同的代码:</p><pre class="kk kl km kn gt mb ma mc md aw me bi"><span id="5fef" class="mf mg it ma b gy mh mi l mj mk">projection = projection.mutate(<br/>    year=projection.creation_date.year(),<br/>    javascript=projection.title.re_search('(?i)java.?script'),   <br/>    answered=projection.answer_count &gt; 0) </span><span id="bba9" class="mf mg it ma b gy ml mi l mj mk">projection.execute()</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mp"><img src="../Images/3244b3d451a8655f3eff911e0be2a0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YOtNr7v8uBF3RdFu.png"/></div></div></figure><p id="6ef2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">美妙之处在于:我们没有被BigQuery所困，甚至没有被熊猫所困。例如，我们可以轻松地切换sqlite(在磁盘上和/或内存中)或Spark，而不需要对我们的代码库做任何修改。最后，值得一提的是，Ibis支持所有典型的数据处理操作:聚合、过滤、连接、应用用户定义的函数等。</p><p id="7b39" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="lw">结论:Ibis是一个非常有趣的项目，值得一看。我希望看到更多关于它的活动，如果时间允许的话，也可以做出贡献，但同时，我会毫不犹豫地使用它，或者向任何寻求统一培训和生产数据处理代码的人推荐它。</em></p><h1 id="dc72" class="mq mg it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">感谢阅读！</h1><p id="8039" class="pw-post-body-paragraph la lb it lc b ld nh ju lf lg ni jx li lj nj ll lm ln nk lp lq lr nl lt lu lv im bi translated"><strong class="lc iu">链接:</strong></p><ul class=""><li id="284f" class="nm nn it lc b ld le lg lh lj no ln np lr nq lv nr ns nt nu bi translated">宜必思首页:<a class="ae kz" href="https://docs.ibis-project.org/index.html" rel="noopener ugc nofollow" target="_blank">https://docs.ibis-project.org/index.html</a></li><li id="7653" class="nm nn it lc b ld nv lg nw lj nx ln ny lr nz lv nr ns nt nu bi translated">如果你想看代码或者投稿:<a class="ae kz" href="https://github.com/ibis-project/ibis" rel="noopener ugc nofollow" target="_blank">https://github.com/ibis-project/ibis</a></li></ul></div></div>    
</body>
</html>