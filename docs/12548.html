<html>
<head>
<title>Twitter Scheduler using Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用气流的 Twitter 调度程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/twitter-data-pipeline-using-apache-airflow-24e0881c214d?source=collection_archive---------25-----------------------#2020-08-29">https://towardsdatascience.com/twitter-data-pipeline-using-apache-airflow-24e0881c214d?source=collection_archive---------25-----------------------#2020-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/279715928a286beb2f7058f820073baf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cASY-mDpSJ_Lv97sGEtaRQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">鸣谢:<a class="ae kf" href="https://dribbble.com/shots/5370290-Website-for-bZx-Metaphor-Design" rel="noopener ugc nofollow" target="_blank">https://dribbble . com/shots/5370290-Website-for-bZx-Metaphor-Design</a></p></figure><p id="2d34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为什么你甚至需要一个 Twitter 调度程序？</p><p id="90b8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有的 Twitter 名人或你在 Twitter 上认识的任何企业，可能都在使用某种调度程序来准时发布他们的推文。</p><p id="6796" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你有一堆各种主题的推文草稿，并且想自动发布它们而不用担心时间问题。这个日程表会让你的生活更轻松。</p><p id="dc2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此在本文中，您将<strong class="ki iu">使用 Apache Airflow 构建一个 Twitter 调度器</strong>。</p><p id="1ad0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，你会有一个运行中的管道，你的推文会在预定的时间段发布。此外，如果您想亲自体验运行在 Docker 上的 Apache Airflow，那么这可能是一个不错的起点。</p><p id="50d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">先说这个 bot 话题。😄</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><h1 id="768b" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">气流到底是什么？</h1><p id="ce6f" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">Apache Airflow 是一个工作流调度器，本质上是一个 python 框架，允许运行 Python 可以执行的任何类型的任务。例如发送电子邮件、运行 Spark 作业、Hadoop 任务以及在 Postgres 数据库上运行 SQL 查询等</p><h1 id="eeaa" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">设置计划程序的先决条件</h1><p id="7f06" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在 docker 上运行 Airflow 是运行应用程序的最佳方式，它消除了各种环境设置错误。我假设你对 docker 的概念比较熟悉，并且你的机器上已经安装了 Docker。在互联网上找到的最好的气流 docker 图像之一是<a class="ae kf" href="https://github.com/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank"> puckel/docker-airflow </a>，你可以克隆这个 repo 并开始构建你的数据管道，但如果你想完成这个项目，那么我会建议你克隆这个 repo<a class="ae kf" href="https://github.com/vjgpt/twitter-pipeline" rel="noopener ugc nofollow" target="_blank"><strong class="ki iu">VJ GPT/Twitter-pipeline</strong></a>，在这里我对之前的 repo 的 docker 文件和 docker-compose 文件进行了更改，以符合这个项目。这个 repo 还包括 Twitter 调度 DAG，这是你对这个项目的所有要求。</p><p id="1cce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你还没有克隆回购协议，👇</p><div class="mn mo gp gr mp mq"><a href="https://github.com/vjgpt/twitter-pipeline" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd iu gy z fp mv fr fs mw fu fw is bi translated">vjgpt/twitter-pipeline</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">在这里，我们将建立一个 Twitter 调度数据管道，这个想法是收集数百条推文在一个文件中…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">github.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne jz mq"/></div></div></a></div><p id="0aae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是在你开始这条管道之前，你需要做两件事:</p><ol class=""><li id="6009" class="nf ng it ki b kj kk kn ko kr nh kv ni kz nj ld nk nl nm nn bi translated">创建一个<strong class="ki iu"> Twitter 开发者 API 账户</strong>。(<a class="ae kf" href="https://developer.twitter.com/en/apply-for-access" rel="noopener ugc nofollow" target="_blank">申请访问— Twitter 开发者| Twitter 开发者</a>)</li><li id="be8d" class="nf ng it ki b kj no kn np kr nq kv nr kz ns ld nk nl nm nn bi translated"><strong class="ki iu">启用 Google Drive v3 </strong>备份你所有的数据。(<a class="ae kf" href="https://developers.google.com/drive/api/v3/quickstart/python" rel="noopener ugc nofollow" target="_blank"> Python 快速入门| Google Drive API | Google 开发者</a>)</li></ol><p id="3765" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建完 Twitter 开发者账户后，确保保存了所需的密钥和凭证，并将其放在<code class="fe nt nu nv nw b"><strong class="ki iu">topic_tweet.py</strong></code>文件中</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="b14b" class="ob ll it nw b gy oc od l oe of">consumer_key = ''           # Add your API key here<br/>consumer_secret = ''        # Add your API secret key here<br/>access_token = ''           # Add your Access Token key here<br/>access_token_secret = ''    # Add your Access Token secret key here</span></pre><p id="501c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要设置 Google Drive API，您需要在本地机器上创建一个 python 环境，并遵循上面的链接。在你允许你的应用后，你会得到两个文件<code class="fe nt nu nv nw b"><strong class="ki iu">credentials.json</strong></code>和<code class="fe nt nu nv nw b"><strong class="ki iu">token.pickle</strong></code>。复制这两个文件，放入 repo <em class="og"> </em> <code class="fe nt nu nv nw b"><em class="og">twitter-pipeline/dags/daglibs</em></code> <em class="og"> </em>文件夹路径。</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="aa3f" class="ob ll it nw b gy oc od l oe of">├── dags<br/>│   ├── daglibs<br/>│   │   ├── <strong class="nw iu">credentials.json</strong><br/>│   │   ├── etl_job.py<br/>│   │   ├── <strong class="nw iu">token.pickle</strong><br/>│   │   ├── topic_tweet.py<br/>│   │   └── upload.py<br/>│   └── post_tweet.py<br/>├── data</span></pre></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><h1 id="b41f" class="lk ll it bd lm ln oo lp lq lr op lt lu lv oq lx ly lz or mb mc md os mf mg mh bi translated">让我们开始码头集装箱🚢</h1><p id="6110" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">我们将在本地执行器模式下运行 Airflow，这意味着合成文件不会构建您的图像，在继续之前，您可以自己在本地构建它。</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="40a5" class="ob ll it nw b gy oc od l oe of">cd twitter-pipeline</span><span id="656a" class="ob ll it nw b gy ot od l oe of">docker build -t aflatest .</span></pre><p id="ff05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是<code class="fe nt nu nv nw b">docker-compose-LocalExecutor.yml</code>的文件。</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="ou lj l"/></div></figure><p id="6230" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在上面的 compose 文件中看到<strong class="ki iu"> <em class="og"> volume </em> </strong>部分，它基本上在本地机器和 docker 容器之间创建了一个桥梁。它有助于在本地卷和 Docker 路径之间持久化数据。您将 dag 文件添加到本地机器，它将反映在您的 docker 容器中，并最终反映在 Airflow UI 中。</p><p id="0b7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您已经准备好启动这些容器并运行 Apache Airflow，确保您位于<code class="fe nt nu nv nw b">twitter-pipeline</code> repo 的主路径中。</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="77ff" class="ob ll it nw b gy oc od l oe of">docker-compose -f docker-compose-LocalExecutor.yml up -d</span></pre><p id="4f20" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> docker-compose up -d </strong>在后台启动你的容器(即分离模式)</p><p id="ffb1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用<strong class="ki iu">拆除</strong>合成设置</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="b17c" class="ob ll it nw b gy oc od l oe of">docker-compose -f docker-compose-LocalExecutor.yml down </span></pre><p id="d3bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用以下命令检查在后台模式下运行的服务的日志</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="679b" class="ob ll it nw b gy oc od l oe of">docker-compose -f docker-compose-LocalExecutor.yml logs</span></pre><p id="c90e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击<a class="ae kf" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">的网页界面 http://localhost:8080 </strong> </a></p><p id="d4d5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该可以看到您放在<code class="fe nt nu nv nw b">./dags</code>目录中的任何 Dag，尽管有时它们可能需要一分钟才能显示出来。</p><p id="0660" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦 DAG 出现，您对 python 文件所做的任何更改将在下次触发 DAG 时立即生效。</p><p id="e3db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">PS:打开 dag 激活它。</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ov"><img src="../Images/123ca2cf72a549cb8090f4f6606b52fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBgHbsztUbqJitvWpaIuew.png"/></div></div></figure><h1 id="10a4" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">Twitter 调度程序管道</h1><p id="2b81" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">好了，现在你的气流在你的码头集装箱上流动，让我们了解一下这条管道是如何工作的。</p><p id="008d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe nt nu nv nw b">data/tweets</code>文件夹中有一些文件，用户把他/她所有起草的推文放在那里。我们把所有的推文都放到一个 CSV 文件中，这是所有推文文件的合并。参照这个 CSV 文件，我们发布推文并做出相应的更改。最后，所有的 CSV 文件和文本文件都备份在 google drive 中，以防发生致命的事情。</p><p id="edc8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这整个过程可以在预定的 DAG 运行时发送你起草的推文。</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ow"><img src="../Images/faa404d4887b6ac6484e0585ca42b501.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*K5r1UXVuYmVuqXiKkuX5tg.gif"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图片来源:【https://dribbble.com/shots/3166602-Twitter T2】</p></figure><h2 id="fe6d" class="ob ll it bd lm ox oy dn lq oz pa dp lu kr pb pc ly kv pd pe mc kz pf pg mg ph bi translated">post_tweet.py</h2><p id="0c02" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">这是主 DAG 文件，显示在你的气流用户界面中，它包含你在这个 python 文件中定义的任务。</p><pre class="le lf lg lh gt nx nw ny nz aw oa bi"><span id="bc0a" class="ob ll it nw b gy oc od l oe of"># DAG is scheduled to run every 8 hours</span><span id="f1f3" class="ob ll it nw b gy ot od l oe of">dag = DAG('PostTweet',schedule_interval=timedelta(hours=8), default_args=default_args)</span></pre><p id="fffe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该 DAG 计划每 8 小时运行一次，您可以根据需要更改运行时间。</p><h2 id="f0c0" class="ob ll it bd lm ox oy dn lq oz pa dp lu kr pb pc ly kv pd pe mc kz pf pg mg ph bi translated">etljob.py</h2><p id="3497" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">这是大部分数据管道发生的地方。它把你从不同文件中起草的推文合并成一个文件。</p><p id="d2aa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该文件中的每个函数都被视为 DAG 中的一个任务。</p><h2 id="bc06" class="ob ll it bd lm ox oy dn lq oz pa dp lu kr pb pc ly kv pd pe mc kz pf pg mg ph bi translated">topic _ tweet.py</h2><p id="91b9" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在这里，我们连接到 Twitter API 并发布推文。这个文件需要在 Twitter 开发人员 API 控制台登录时生成的所有密钥和秘密。</p><h2 id="8050" class="ob ll it bd lm ox oy dn lq oz pa dp lu kr pb pc ly kv pd pe mc kz pf pg mg ph bi translated">上传. py</h2><p id="1561" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">此文件将所有与此管道相关的数据备份到您的 Google Drive 帐户。</p><p id="e61f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">现在，让我们测试这条管道。</strong></p><p id="4cbd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe nt nu nv nw b">data/tweets</code>文件夹中的 txt 文件中添加一些 tweet，你可以添加多个 tweet 到那个文件中，或者创建一个新文件并在其中添加 tweet。然后触发管道，你会发现你的推文发布在你的 Twitter 账户上，所有文件都备份在 Google Drive 上。</p><p id="b2d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干杯！！！🥂</p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><h1 id="6aa4" class="lk ll it bd lm ln oo lp lq lr op lt lu lv oq lx ly lz or mb mc md os mf mg mh bi translated">结束了！！</h1><p id="3e82" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">这只是您刚刚制作的一个演示管道，但是您可以使用同一组基础设施，通过几个用例来制作更多这样的管道。</p><p id="6775" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你有兴趣更深入地研究这个话题，那么试着创建一个比我们现在做的更好的可扩展架构。在这个架构中，我们使用了 LocalExecutor，并且有一个不可伸缩的 singletons 调度程序。尝试使用 CeleryExecutor 模式，在这种模式下，工作从任务队列中分发出去，所有任务都是分布式的。</p><p id="5a81" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">哦，等等..如果这对你有所帮助，请支持我的工作。</p><p id="df7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是这个项目的回购👇</p><div class="mn mo gp gr mp mq"><a href="https://github.com/vjgpt/twitter-pipeline" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd iu gy z fp mv fr fs mw fu fw is bi translated">vjgpt/twitter-pipeline</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">github.com</p></div></div><div class="mz l"><div class="pi l nb nc nd mz ne jz mq"/></div></div></a></div></div></div>    
</body>
</html>