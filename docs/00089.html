<html>
<head>
<title>TensorFlow 2.0: tf.function and AutoGraph</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TensorFlow 2.0: tf.function 和亲笔签名</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tensorflow-2-0-tf-function-and-autograph-af2b974cf4f7?source=collection_archive---------8-----------------------#2020-01-03">https://towardsdatascience.com/tensorflow-2-0-tf-function-and-autograph-af2b974cf4f7?source=collection_archive---------8-----------------------#2020-01-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="919a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">随着 TensorFlow (TF) 2.0 的出现，<code class="fe ko kp kq kr b">tf.function</code>的引入为 TF 1.0 带来了一些有用的改进，最显著的是 AutoGraph 的引入。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/77e9ace481b2b2a371eb388ff3e88a90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAKbluVUsTkIMgCd8tDM6g.png"/></div></div></figure><h1 id="4306" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">TensorFlow 是如何工作的？</h1><p id="1760" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">基本上，TensorFlow 通过计算图运行，即节点图用于表示一系列 TensorFlow 操作。</p><p id="22ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，编译张量流图可能是一个繁琐的过程，因为语法结构与 Python 明显不同，并且图代码比简单的 Python 结构使用更多的资源。</p><p id="af6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">AutoGraph 的目的是通过把用 Python 的经典语法结构编写的代码转换成 TensorFlow 图兼容代码来图形化代码。这使得使用 Python 和 TensorFlow 更加直观，因为它简化了从 Python 代码到图形代码的转换。</p><p id="e701" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更重要的是，<code class="fe ko kp kq kr b">tf.function</code>允许直观地使用急切执行和自动签名，从而可以使用 Python 语法运行一个函数，然后转换成等价的图形代码。</p><p id="4c17" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们举个例子。</p><h1 id="336e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">急切执行:循环函数的区域</h1><p id="a8a7" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">这是一个计算圆面积的 Python 函数。在 TF 2.0 中默认开启急切执行，值<strong class="js iu"> r </strong>(圆的半径)被定义为<code class="fe ko kp kq kr b">tf.Variable</code>。</p><pre class="kt ku kv kw gt mh kr mi mj aw mk bi"><span id="9681" class="ml lf it kr b gy mm mn l mo mp">&gt;&gt;&gt; import tensorflow as tf<br/>&gt;&gt;&gt; tf.executing_eagerly()<br/>&gt;&gt;&gt; r = tf.Variable(10.0, name="r")</span><span id="273e" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; def area(r):<br/>&gt;&gt;&gt;     circle=3.14*(r**2.00)<br/>&gt;&gt;&gt;     return circle</span><span id="3074" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; area(10)</span><span id="aeee" class="ml lf it kr b gy mq mn l mo mp">314.0</span><span id="ff11" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; print('Areas of respective circles: %2.2f, %2.2f, %2.2f' % (area(tf.constant(50.0)), area(tf.constant(100.0)), area(tf.constant(150.0))))</span><span id="e798" class="ml lf it kr b gy mq mn l mo mp">Areas of respective circles: 7850.00, 31400.00, 70650.00</span></pre><h1 id="2745" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">用 tf 签名。会议</h1><p id="7e3f" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">现在，假设有人希望使用 AutoGraph 实现这个代码。使用 TF 1.0 约定，这可能是使用<code class="fe ko kp kq kr b">tf.Session</code>实现的。以前，图形必须在会话中显式启动才能运行。</p><pre class="kt ku kv kw gt mh kr mi mj aw mk bi"><span id="ad61" class="ml lf it kr b gy mm mn l mo mp">&gt;&gt;&gt; r = tf.Variable(10.0, name="r")</span><span id="fc39" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; def area(r):<br/>&gt;&gt;&gt;     circle=3.14*(r**2.00)<br/>&gt;&gt;&gt;     return circle</span><span id="4a33" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; print(tf.autograph.to_code(area))</span><span id="6744" class="ml lf it kr b gy mq mn l mo mp">def tf__area(r):<br/>  do_return = False<br/>  retval_ = ag__.UndefinedReturnValue()<br/>  circle = 3.14 * r ** 2.0<br/>  do_return = True<br/>  retval_ = circle<br/>  cond = ag__.is_undefined_return(retval_)</span><span id="e6b9" class="ml lf it kr b gy mq mn l mo mp">  def get_state():<br/>    return ()</span><span id="cd9b" class="ml lf it kr b gy mq mn l mo mp">  def set_state(_):<br/>    pass</span><span id="f6ce" class="ml lf it kr b gy mq mn l mo mp">  def if_true():<br/>    retval_ = None<br/>    return retval_</span><span id="7036" class="ml lf it kr b gy mq mn l mo mp">  def if_false():<br/>    return retval_<br/>  retval_ = ag__.if_stmt(cond, if_true, if_false, get_state, set_state)<br/>  return retval_</span></pre><p id="3b60" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一个图形格式的代码示例。</p><pre class="kt ku kv kw gt mh kr mi mj aw mk bi"><span id="5631" class="ml lf it kr b gy mm mn l mo mp">&gt;&gt;&gt; tf_area = tf.autograph.to_graph(area)<br/>&gt;&gt;&gt; tf_area</span><span id="c881" class="ml lf it kr b gy mq mn l mo mp">&lt;function __main__.create_converted_entity_factory.&lt;locals&gt;.create_converted_entity.&lt;locals&gt;.tf__area(r)&gt;</span><span id="620d" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; print(tf_area)</span><span id="61d5" class="ml lf it kr b gy mq mn l mo mp">&lt;function create_converted_entity_factory.&lt;locals&gt;.create_converted_entity.&lt;locals&gt;.tf__area at 0x7f7b57f8a620&gt;</span><span id="b5ca" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; with tf.Graph().as_default():<br/>    a1 = tf_area(tf.constant(50.0))<br/>    a2 = tf_area(tf.constant(100.0))<br/>    a3 = tf_area(tf.constant(150.0))<br/>    with tf.compat.v1.Session() as sess:<br/>        print('Areas of respective circles (graph results): %2.2f, %2.2f, %2.2f\n' % (sess.run(a1), sess.run(a2), sess.run(a3)))</span><span id="afde" class="ml lf it kr b gy mq mn l mo mp">Areas of respective circles (graph results): 7850.00, 31400.00, 70650.00</span></pre><p id="8c6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<a class="ae mr" href="https://stackoverflow.com/questions/43530309/what-is-a-tensorflow-session-actually" rel="noopener ugc nofollow" target="_blank">会话</a>意味着上面计算的圆的面积值将只在会话本身内计算。</p><h1 id="4962" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用 tf.function 自动签名</h1><p id="ed40" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">让我们看看如何使用<code class="fe ko kp kq kr b">tf.function</code>来实现这一点。</p><pre class="kt ku kv kw gt mh kr mi mj aw mk bi"><span id="d76a" class="ml lf it kr b gy mm mn l mo mp">&gt;&gt;&gt; r = tf.Variable(10.0, name="r")</span><span id="0032" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; @tf.function<br/>&gt;&gt;&gt; def area(r):<br/>&gt;&gt;&gt;     circle=3.14*(r**2.00)<br/>&gt;&gt;&gt;     return circle</span><span id="3c16" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; print(tf.autograph.to_code(area.python_function))</span><span id="01a7" class="ml lf it kr b gy mq mn l mo mp">def tf__area(r):<br/>  do_return = False<br/>  retval_ = ag__.UndefinedReturnValue()<br/>  circle = 3.14 * r ** 2.0<br/>  do_return = True<br/>  retval_ = circle<br/>  cond = ag__.is_undefined_return(retval_)</span><span id="4230" class="ml lf it kr b gy mq mn l mo mp">  def get_state():<br/>    return ()</span><span id="a7ca" class="ml lf it kr b gy mq mn l mo mp">  def set_state(_):<br/>    pass</span><span id="7392" class="ml lf it kr b gy mq mn l mo mp">  def if_true():<br/>    retval_ = None<br/>    return retval_</span><span id="cd43" class="ml lf it kr b gy mq mn l mo mp">  def if_false():<br/>    return retval_<br/>  retval_ = ag__.if_stmt(cond, if_true, if_false, get_state, set_state)<br/>  return retval_</span><span id="c206" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; area(60)</span><span id="0ec1" class="ml lf it kr b gy mq mn l mo mp">&lt;tf.Tensor: id=13, shape=(), dtype=float32, numpy=11304.0&gt;</span><span id="fb12" class="ml lf it kr b gy mq mn l mo mp">&gt;&gt;&gt; print(area(tf.constant(50.00)), area(tf.constant(100.0)), area(tf.constant(150.0)))</span><span id="5dc1" class="ml lf it kr b gy mq mn l mo mp">tf.Tensor(7850.0005, shape=(), dtype=float32) tf.Tensor(31400.002, shape=(), dtype=float32) tf.Tensor(70650.0, shape=(), dtype=float32)</span></pre><p id="fa3d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从上面可以看出，计算面积值不需要会话。而是用<code class="fe ko kp kq kr b">tf.function</code>指定可以直接转换为 AutoGraph 的函数，然后面积值计算为张量。</p><h1 id="8c57" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="979a" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">在这个例子中，我们看到了 TF 2.0 如何通过使用<code class="fe ko kp kq kr b">tf.function</code>和 AutoGraph 来简化 TensorFlow 中的函数实现。非常感谢您的时间，您还可以在 michael-grogan.com<a class="ae mr" href="https://www.michael-grogan.com/" rel="noopener ugc nofollow" target="_blank">找到更多使用 TensorFlow 和 Keras 的机器学习示例。</a></p><p id="e994" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ms">免责声明:本文是在“原样”的基础上编写的，没有任何担保。本文旨在提供数据科学概念的概述，不应以任何方式解释为专业建议。</em></p></div></div>    
</body>
</html>