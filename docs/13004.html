<html>
<head>
<title>Extracting &amp; Plotting Feature Names &amp; Importance from Scikit-Learn Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从 Scikit-Learn 管道中提取和绘制功能名称和重要性</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/extracting-plotting-feature-names-importance-from-scikit-learn-pipelines-eb5bfa6a31f4?source=collection_archive---------15-----------------------#2020-09-07">https://towardsdatascience.com/extracting-plotting-feature-names-importance-from-scikit-learn-pipelines-eb5bfa6a31f4?source=collection_archive---------15-----------------------#2020-09-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8720" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何解释您的渠道、模式及其特点</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fbdf1a756d00c6aaecaafd26145d60bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vDcD_MCw65prGFVu1qNMDQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/L0oJ4Dlfyuo" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/L0oJ4Dlfyuo</a></p></figure><p id="128b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您曾经承担过生产机器学习模型的任务，您可能知道 Scikit-Learn 库提供了创建生产质量的机器学习工作流的最佳方式之一——如果不是最佳方式的话。生态系统的<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html" rel="noopener ugc nofollow" target="_blank">管道</a>、<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.compose.ColumnTransformer.html" rel="noopener ugc nofollow" target="_blank">列转换器</a>、<a class="ae ky" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.preprocessing" rel="noopener ugc nofollow" target="_blank">预处理程序</a>、<a class="ae ky" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.impute" rel="noopener ugc nofollow" target="_blank">估算器</a>、&amp;、<a class="ae ky" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.feature_selection" rel="noopener ugc nofollow" target="_blank">特征选择</a>类是将原始数据转换为模型就绪特征的强大工具。</p><p id="c22c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在任何人让您部署到生产环境之前，您都需要对新模型的工作原理有一些基本的了解。解释黑盒模型如何工作的最常见方式是绘制要素名称和重要性值。如果您曾经尝试过从 ColumnTransformer 处理的异构数据集中提取特性名称，您就会知道这不是一件容易的事情。详尽的互联网搜索只让我注意到其他人问了<a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/issues/6424" rel="noopener ugc nofollow" target="_blank"/><a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/pull/6431" rel="noopener ugc nofollow" target="_blank"/><a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/pull/12627" rel="noopener ugc nofollow" target="_blank">同样的</a> <a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/pull/13307" rel="noopener ugc nofollow" target="_blank">问题</a>或提供了<a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/issues/12525" rel="noopener ugc nofollow" target="_blank">部分答案</a>，而不是产生一个全面和令人满意的解决方案。</p><p id="fb8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了补救这种情况，我开发了一个名为<code class="fe lv lw lx ly b">FeatureImportance</code>的类，它将从管道实例中提取特性名称和重要性值。然后，它使用 Plotly 库，仅用几行代码来绘制特性的重要性。在这篇文章中，我将加载一个合适的管道，演示如何使用我的类，然后概述它是如何工作的。完整的代码可以在<a class="ae ky" href="https://www.kaggle.com/kylegilde/feature-importance" rel="noopener ugc nofollow" target="_blank">这里</a>或者这篇博文的末尾找到。</p><p id="9f7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:从 scikit-learn 1.0 中的<a class="ae ky" href="https://scikit-learn.org/stable/auto_examples/release_highlights/plot_release_highlights_1_0_0.html#feature-names-support" rel="noopener ugc nofollow" target="_blank">变化开始，我的类可能无法工作。</a></p><p id="2b95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在继续之前，我应该注意两件事:</p><ol class=""><li id="dbaf" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">我相信 Joey Gao 在<a class="ae ky" href="https://github.com/scikit-learn/scikit-learn/issues/12525#issuecomment-436217100" rel="noopener ugc nofollow" target="_blank">这个帖子</a>中的代码展示了解决这个问题的方法。</li><li id="a020" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">我的帖子假设您以前使用过 Scikit-Learn 和 Pandas，并且熟悉 ColumnTransformer、Pipeline 和预处理类如何促进可再现的特征工程过程。如果您需要复习，请查看这个<a class="ae ky" href="https://scikit-learn.org/stable/auto_examples/compose/plot_column_transformer_mixed_types.html" rel="noopener ugc nofollow" target="_blank"> Scikit-Learn 示例</a>。</li></ol><h2 id="cae0" class="mn mo it bd mp mq mr dn ms mt mu dp mv li mw mx my lm mz na nb lq nc nd ne nf bi translated">创建管道</h2><p id="6132" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">出于演示的目的，我编写了一个名为<a class="ae ky" href="https://www.kaggle.com/kylegilde/fit-pipeline-ames" rel="noopener ugc nofollow" target="_blank"> fit_pipeline_ames.py </a>的脚本。它从 Kaggle 加载<a class="ae ky" href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques/data" rel="noopener ugc nofollow" target="_blank"> Ames housing 训练数据，并适合中等复杂的管道。我在下面画出了它的视觉表现。</a></p><pre class="kj kk kl km gt nl ly nm nn aw no bi"><span id="ec62" class="mn mo it ly b gy np nq l nr ns">from sklearn import set_config <br/>from sklearn.utils import estimator_html_repr <br/>from IPython.core.display import display, HTML <br/><br/>from fit_pipeline_ames import <!-- -->pipe<!-- -->   # create &amp; fit pipeline<br/>set_config(display='diagram')<br/>display(HTML(estimator_html_repr(pipe)))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/3fa1ff82331bd4d186ce2fe0ec7a740e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*-I2GH6UYqE3_5QDVGwWwbg.png"/></div></figure><p id="7659" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个<code class="fe lv lw lx ly b">pipe</code>实例包含以下 4 个步骤:</p><ol class=""><li id="b255" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated"><a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.compose.ColumnTransformer.html" rel="noopener ugc nofollow" target="_blank"> ColumnTransformer </a>实例由 3 条管道组成，共包含 4 个 Transformer 实例，包括<a class="ae ky" href="https://contrib.scikit-learn.org/category_encoders/" rel="noopener ugc nofollow" target="_blank"> category_encoders </a>包中的<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html" rel="noopener ugc nofollow" target="_blank"> SimpleImputer </a>、<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OneHotEncoder.html" rel="noopener ugc nofollow" target="_blank">OneHotEncoder</a>&amp;<a class="ae ky" href="http://contrib.scikit-learn.org/category_encoders/glmm.html" rel="noopener ugc nofollow" target="_blank">GLMMEncoder</a>。关于我如何动态构造这个特殊的 ColumnTransformer 的完整解释，请参见我以前的博客文章。</li><li id="12df" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated"><a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.VarianceThreshold.html" rel="noopener ugc nofollow" target="_blank"> VarianceThreshold </a>使用默认阈值 0，这将删除任何仅包含单一值的特征。如果一个特征没有变化，一些模型将会失败。</li><li id="4cda" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated"><a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.SelectPercentile.html" rel="noopener ugc nofollow" target="_blank">选择百分位数</a>使用百分位数阈值为 90 的<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.f_regression.html" rel="noopener ugc nofollow" target="_blank"> f_regression </a>评分函数。这些设置保留了前 90%的功能，而丢弃了后 10%的功能。</li><li id="2a51" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用前面步骤中创建和选择的特征，将<a class="ae ky" href="https://catboost.ai/docs/concepts/python-reference_catboostregressor.html" rel="noopener ugc nofollow" target="_blank"> CatBoostRegressor </a>模型拟合到<code class="fe lv lw lx ly b">SalesPrice</code>因变量。</li></ol><h2 id="cb3c" class="mn mo it bd mp mq mr dn ms mt mu dp mv li mw mx my lm mz na nb lq nc nd ne nf bi translated">绘图功能重要性</h2><p id="9367" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在<code class="fe lv lw lx ly b">FeatureImportance</code>的帮助下，我们可以提取特性名称和重要性值，并用 3 行代码绘制出来。</p><pre class="kj kk kl km gt nl ly nm nn aw no bi"><span id="1e31" class="mn mo it ly b gy np nq l nr ns">from feature_importance import FeatureImportance<br/>feature_importance = FeatureImportance(pipe)<br/>feature_importance.plot(top_n_features=25)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/ed8b151e1c3320196a34f3d250694990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0V_OaYzTDn4tQjEmJ93Wzw.png"/></div></div></figure><p id="dc18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">plot</code>方法接受许多控制绘图显示的参数。最重要的如下:</p><ul class=""><li id="df78" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu nv mf mg mh bi translated"><code class="fe lv lw lx ly b">top_n_features</code>:控制将要绘制的特征数量。默认值为 100。该图的标题将显示该值以及总共有多少个特征。要绘制所有特征，只需将<code class="fe lv lw lx ly b">top_n_features</code>设置为大于总特征的数字。</li><li id="e35d" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nv mf mg mh bi translated"><code class="fe lv lw lx ly b">rank_features</code>:该参数控制是否在特征名称前显示整数等级。默认为<code class="fe lv lw lx ly b">True</code>。我发现这有助于解释，尤其是在比较来自多个模型的特性重要性时。</li><li id="bbaf" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nv mf mg mh bi translated"><code class="fe lv lw lx ly b">max_scale</code>:决定重要性值是否按最大值&amp;乘以 100 进行缩放。默认为<code class="fe lv lw lx ly b">True</code>。我发现这提供了一种直观的方式来比较其他特性和最重要的特性的重要性。例如，在上面的图中，我们可以说<code class="fe lv lw lx ly b">GrLivArea</code>对模型的重要性是顶部特性<code class="fe lv lw lx ly b">OverallQty</code>的 81%。</li></ul><h2 id="9a3e" class="mn mo it bd mp mq mr dn ms mt mu dp mv li mw mx my lm mz na nb lq nc nd ne nf bi translated">它是如何工作的</h2><p id="6032" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">应该使用合适的管道实例来实例化<code class="fe lv lw lx ly b">FeatureImportance</code>类。(如果您想将所有诊断打印到您的控制台，您也可以将<code class="fe lv lw lx ly b">verbose</code>参数更改为<code class="fe lv lw lx ly b">True</code>。)我的类验证这个管道以一个<code class="fe lv lw lx ly b">ColumnTransformer</code>实例开始，以一个具有<code class="fe lv lw lx ly b">feature_importance_</code>属性的回归或分类模型结束。作为中间步骤，流水线可以有任意数量的或没有来自<a class="ae ky" href="https://scikit-learn.org/stable/modules/feature_selection.html" rel="noopener ugc nofollow" target="_blank">sk learn . feature _ selection</a>的类实例。</p><p id="118e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">FeatureImportance</code>类由 4 个方法组成。</p><ol class=""><li id="e271" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">是最难设计的方法。它遍历<code class="fe lv lw lx ly b">ColumnTransformer</code>转换器，使用<code class="fe lv lw lx ly b">hasattr</code>函数来辨别我们正在处理的类的类型，并相应地提取特性名称。(特别注意:如果 ColumnTransformer 包含管道，并且管道中的某个转换器正在添加全新的列，则它必须位于管道的最后。例如，OneHotEncoder，<a class="ae ky" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.MissingIndicator.html" rel="noopener ugc nofollow" target="_blank">MissingIndicator</a>&amp;simple imputr(add _ indicator = True)将之前不存在的列添加到数据集，因此它们应该在管道中排在最后。)</li><li id="75d0" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated"><code class="fe lv lw lx ly b">get_selected_features</code>通话<code class="fe lv lw lx ly b">get_feature_names</code>。然后，基于<code class="fe lv lw lx ly b">get_support</code>方法的存在，它测试主管道是否包含来自 sklearn.feature_selection 的任何类。如果是，此方法将仅返回选择器类保留的要素名称。它存储未在<code class="fe lv lw lx ly b">discarded_features</code>属性中选择的特征。以下是我的管道中的选择器删除的 24 个特性:</li></ol><pre class="kj kk kl km gt nl ly nm nn aw no bi"><span id="47ff" class="mn mo it ly b gy np nq l nr ns">feature_importance.discarded_features</span><span id="9ba8" class="mn mo it ly b gy nw nq l nr ns">['BsmtFinSF2','BsmtHalfBath','Alley_Pave','LandContour_Lvl','Utilities_AllPub','Utilities_NoSeWa','LotConfig_Corner','LotConfig_FR2','Condition1_RRNe','Condition2_RRAe','Condition2_RRAn','HouseStyle_SLvl','RoofStyle_Mansard','RoofMatl_ClyTile','RoofMatl_Metal','RoofMatl_Roll','RoofMatl_Tar&amp;Grv','ExterCond_Ex','Foundation_Stone','Foundation_Wood','BsmtFinType2_GLQ','Electrical_missing_value','FireplaceQu_Fa','GarageCond_Gd','MiscFeature_Gar2','SaleType_ConLI']</span></pre><p id="3560" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.<code class="fe lv lw lx ly b">get_feature_importance</code>调用<code class="fe lv lw lx ly b">get_selected_features</code>然后创建一个熊猫系列，其中值是来自模型的特征重要性值，其索引是由前两种方法创建的特征名称。然后，该系列被存储在<code class="fe lv lw lx ly b">feature_importance</code>属性中。</p><p id="6b33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4.<code class="fe lv lw lx ly b">plot</code>调用<code class="fe lv lw lx ly b">get_feature_importance</code>并根据规格绘制输出。</p><h2 id="ef2d" class="mn mo it bd mp mq mr dn ms mt mu dp mv li mw mx my lm mz na nb lq nc nd ne nf bi translated">密码</h2><p id="fe5f" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">这篇博文的原始笔记本可以在<a class="ae ky" href="https://www.kaggle.com/kylegilde/extracting-scikit-feature-names-importances" rel="noopener ugc nofollow" target="_blank">这里</a>找到。<code class="fe lv lw lx ly b">FeatureImportance</code>的完整代码如下所示，可以在<a class="ae ky" href="https://www.kaggle.com/kylegilde/feature-importance" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="8969" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你创建了一个你认为应该被支持的管道，但是没有，请提供一个可重复的例子，我会考虑做必要的修改。</p><p id="5063" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请继续关注关于使用 Scikit-Learn ColumnTransformers 和 Pipelines 训练和调整模型的更多帖子。如果你觉得这篇文章有帮助或者有任何改进的想法，请告诉我。谢谢！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure></div></div>    
</body>
</html>