<html>
<head>
<title>Learn AI Today 04: Time Series Multi-Step Forecasting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今日学习人工智能 04:时间序列多步预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/learn-ai-today-04-time-series-multi-step-forecasting-6eb48bbcc724?source=collection_archive---------21-----------------------#2020-08-23">https://towardsdatascience.com/learn-ai-today-04-time-series-multi-step-forecasting-6eb48bbcc724?source=collection_archive---------21-----------------------#2020-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="fb21" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/learn-ai-today" rel="noopener" target="_blank">今天学 AI</a></h2><div class=""/><div class=""><h2 id="f8f1" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">创建和训练 1D 卷积神经网络，以预测用 Mackey-Glass 方程生成的混沌时间序列的多个未来时间步长</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/44ddcde59c6848f4bbca2e412aa8f73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H6O8SaolbaaBO2HalLOMoQ.jpeg"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@drew_beamer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">在<a class="ae le" href="https://unsplash.com/s/photos/future?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上绘制的 Beamer </a>照片。</p></figure><p id="3146" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这是<a class="ae le" href="http://learn-ai-today.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">学艾今日</strong> </a> <strong class="lh ja"> </strong>系列的第 4 个故事！如果你还没有，一定要检查以前的故事。</p><div class="mb mc gp gr md me"><a rel="noopener follow" target="_blank" href="/learn-ai-today-03-potato-classification-using-convolutional-neural-networks-4481222f2806"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ja gy z fp mj fr fs mk fu fw iz bi translated">今天学习人工智能:03 —使用卷积神经网络的马铃薯分类</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">在 PyTorch 中创建一个 CNN 模型，并使用 fastai2 训练它识别土豆的类型，以简化代码</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">towardsdatascience.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms ky me"/></div></div></a></div><h1 id="651e" class="mt mu iq bd mv mw mx my mz na nb nc nd kf ne kg nf ki ng kj nh kl ni km nj nk bi translated">你将从这个故事中学到什么:</h1><ul class=""><li id="e327" class="nl nm iq lh b li nn ll no lo np ls nq lw nr ma ns nt nu nv bi translated">创建一个混乱的时间序列</li><li id="f2ad" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">按顺序拆分系列以提供给模型</li><li id="8013" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">定义和训练用于时间序列预测的 1d 卷积神经网络</li><li id="b8a2" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">使用 fastai2 <strong class="lh ja">数据集</strong>和<strong class="lh ja">学习器</strong></li></ul></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="8c10" class="mt mu iq bd mv mw oi my mz na oj nc nd kf ok kg nf ki ol kj nh kl om km nj nk bi translated">1.创建一个混乱的时间序列</h1><p id="a551" class="pw-post-body-paragraph lf lg iq lh b li nn ka lk ll no kd ln lo on lq lr ls oo lu lv lw op ly lz ma ij bi translated">在一个混沌系统中，初始条件的一个非常小的变化就可能导致完全不同的结果。在这样的系统中，即使你知道描述未来的确定性方程，你也无法准确预测未来。为什么？因为你需要一台无限精确的计算机和无限精确的初始条件。事实上，这根本不可能。这就是为什么天气预报只在短期内准确。随着时间的推移，随着动态和统计模型的改进以及计算能力的提高，它们也在不断改进。然而，不可能长期准确地预测每天的天气，因为它是一个混沌系统。</p><p id="010e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了生成一个混沌时间序列，我将使用<a class="ae le" href="http://www.scholarpedia.org/article/Mackey-Glass_equation" rel="noopener ugc nofollow" target="_blank"> Mackey-Glass 方程</a>，参数在这里<a class="ae le" href="http://lab.fs.uni-lj.si/lasin/wp/IMIT_files/neural/nn05_narnet/" rel="noopener ugc nofollow" target="_blank">描述</a>。Python 代码如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="7bce" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">前 500 个样本的结果如下:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi os"><img src="../Images/db77b65c5f0a28de8b6db1142a4c3ecf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*FhgL1J4PCluZ-8Q8SpIhAg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">麦基-格拉斯时间序列。图片由作者提供。</p></figure><p id="1221" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">请注意，时间序列中有一个模式，但有很多变化，无法在很长一段时间内可靠地预测。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="091e" class="mt mu iq bd mv mw oi my mz na oj nc nd kf ok kg nf ki ol kj nh kl om km nj nk bi translated">2.按顺序拆分系列以提供给模型</h1><p id="19da" class="pw-post-body-paragraph lf lg iq lh b li nn ka lk ll no kd ln lo on lq lr ls oo lu lv lw op ly lz ma ij bi translated">用上面的代码生成的数据是一个很长的序列。为了训练一个模型，我将把数据分成 500 个元素的较小序列。<strong class="lh ja">输入数据</strong>将是前 100 个元素，而<strong class="lh ja">目标数据</strong>(未来预测)将是剩余的 400 个元素。此外，数据的前 2/3 将用作<strong class="lh ja">训练数据</strong>，而后 1/3 用作<strong class="lh ja">验证数据</strong>。</p><p id="82e7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">注意:</strong>处理时间序列时，选择序列的最后一部分进行验证通常是个好主意，特别是当您想要预测未来时。否则，该模型可能会学习自相关，并产生误导性的好结果，这将在应用于未来时“打破”实践。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="241d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上面的代码简单地运行长序列，并创建如上所述的输入和目标序列，按照模型所需的格式重新整形。对于图像数据和通常的 2D 卷积神经网络，张量以形状[批量大小，通道，行，列]组织。这里对于<strong class="lh ja"> 1D 卷积神经网络，</strong>也是一样的，但是去掉了最后一个维度。并且实际上有可能具有多个时间序列的输入(表示为几个通道)。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="66d5" class="mt mu iq bd mv mw oi my mz na oj nc nd kf ok kg nf ki ol kj nh kl om km nj nk bi translated"><strong class="ak"> 3。定义和训练模型</strong></h1><p id="77fd" class="pw-post-body-paragraph lf lg iq lh b li nn ka lk ll no kd ln lo on lq lr ls oo lu lv lw op ly lz ma ij bi translated">我为这个实验定义的模型是一个 1D 卷积神经网络，它有 3 个卷积层，然后是 ReLU 激活和<strong class="lh ja">批量归一化</strong>，最后是平均池和两个线性层。基本原理类似于 2D 卷积层。每个连续的层都可以捕获越来越复杂的数据模式。<strong class="lh ja">批量标准化</strong>有助于使训练更快、更稳定，即使在非常深的神经网络中。你可以看这个 10 分钟的视频，吴恩达解释了为什么 Batch Norm 有效。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="6550" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">还注意到，在最后一个线性层之前，我使用了一个<strong class="lh ja">下降</strong>(第 26 行)。漏失(在第 10 行中定义，概率为 0.5)通常是一种成功的正则化方法。它只是随机删除特征图中的一些元素，使数据每次都略有不同。以一幅图像为例。丢弃就像删除图像的一些像素。最有可能的是，您仍然可以识别图像中的对象，因此模型必须学习它，从而产生更健壮的模型。</p><p id="7346" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">注意:</strong>在推断时间内，辍学是不活跃的。这也是你需要在运行推理之前调用<code class="fe ot ou ov ow b">model.eval()</code>的原因之一，否则会应用 dropout。</p><p id="ec31" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">使用 fastai <code class="fe ot ou ov ow b">Datasets</code>类很容易创建数据加载器，然后使用 fastai <code class="fe ot ou ov ow b">Learner</code>将数据加载器与模型结合起来。学习者类处理训练和预测。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oq or l"/></div></figure><ul class=""><li id="09d2" class="nl nm iq lh b li lj ll lm lo ox ls oy lw oz ma ns nt nu nv bi translated">在上面的代码中，<strong class="lh ja">数据集</strong>是通过给出一个项目列表和一个函数来定义输入和其他目标而创建的(第 1 行)。我之前将序列和目标定义为张量<code class="fe ot ou ov ow b">x</code>和<code class="fe ot ou ov ow b">y</code>(这里是<a class="ae le" href="https://www.kaggle.com/mnpinto/learn-ai-today-04-time-series" rel="noopener ugc nofollow" target="_blank">完整代码</a>)，因此我只需要从这些张量中选择元素。你可以在文档<a class="ae le" href="https://docs.fast.ai/data.core.html#Datasets" rel="noopener ugc nofollow" target="_blank">中阅读更多关于 fastai <code class="fe ot ou ov ow b">Datasets</code>的信息。</a></li><li id="211d" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">如您所见，在第 5 行中，我使用<strong class="lh ja">一个周期学习率时间表</strong>训练模型 20 个时期(学习率上升，直到达到<code class="fe ot ou ov ow b">max_lr</code>，然后逐渐衰减)。fastai 提供的又一个好特性！</li></ul><p id="c3b5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在训练过程中，下表打印了结果，您可以看到随着训练的进行，训练和验证损失逐渐下降。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pa"><img src="../Images/e063210f654ba64641cb1c658624b681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*58IFKPZ84AFWrp9r05blhw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">训练进展表。图片由作者提供。</p></figure><p id="e054" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如上表所示，列车损失高于验证损失有几个原因。在这种情况下，一个可能的原因是仅用于培训的辍学本身的使用。你可以试着运行没有脱落的代码，检查一下是不是这样！</p><p id="2493" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在模型已经定型，让我们计算验证的预测。<code class="fe ot ou ov ow b">Learner</code>的<code class="fe ot ou ov ow b">get_preds</code>方法可以如下使用:<code class="fe ot ou ov ow b">ye_valid, y_valid = learn.get_preds().</code>注意，我不需要调用<code class="fe ot ou ov ow b">model.eval()</code>，因为 fastai <code class="fe ot ou ov ow b">get_preds</code>已经处理了这些细节。然而有一点需要记住。</p><p id="1509" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">有了结果，是时候可视化预测了！这是最好玩的部分。下面的代码创建了一个包含 12 个验证序列的可视化图像。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oq or l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pb"><img src="../Images/cb0afda17397d66fa81994b11fa541a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-IwwkmYTIb6o6KBDjo-fQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">结果的可视化。绿线代表真实数据，红线代表预测。输入数据显示在垂直黑条上。图片由作者提供。</p></figure><p id="74a8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如上图所示，模型预测(红色)从紧跟目标(绿色)开始，但随着时间的推移，性能开始下降。事实上，如果我沿着时间轴绘制均方差(MSE ),结果如下:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pc"><img src="../Images/11e91f7b3b0f14a884116f44f77d5e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCEwrXecaE8iZi-RyUsTcQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">MSE 超过 400 的预测序列。图片由作者提供。</p></figure><p id="8301" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">由于数据的混乱性质，这是意料之中的。这个结果还能进一步提高吗？可能是的，我在准备这个故事时尝试了几种不同的选择，真正的学习是查看代码并进行自己的观察和实验。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="4315" class="mt mu iq bd mv mw oi my mz na oj nc nd kf ok kg nf ki ol kj nh kl om km nj nk bi translated">家庭作业</h1><p id="2313" class="pw-post-body-paragraph lf lg iq lh b li nn ka lk ll no kd ln lo on lq lr ls oo lu lv lw op ly lz ma ij bi translated">我可以给你看一千个例子，但如果你能自己做一两个实验，你会学到最多！这个故事的完整代码可以在<a class="ae le" href="https://www.kaggle.com/mnpinto/learn-ai-today-04-time-series" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">这个笔记本</strong> </a>上找到。</p><ul class=""><li id="ed37" class="nl nm iq lh b li lj ll lm lo ox ls oy lw oz ma ns nt nu nv bi translated">尝试改变模型、超参数、优化函数、输入和输出序列的大小，看看它如何影响结果。</li><li id="cf6b" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">将该模型应用于你可能感兴趣的某个问题的另一个时间序列。成绩如何？</li></ul><p id="eaf1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">和往常一样，如果你通过实验创作出了有趣的动画笔记本，那就在 GitHub、Kaggle 上分享吧，或者写一个中型故事！</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="97ba" class="mt mu iq bd mv mw oi my mz na oj nc nd kf ok kg nf ki ol kj nh kl om km nj nk bi translated">结束语</h1><p id="5382" class="pw-post-body-paragraph lf lg iq lh b li nn ka lk ll no kd ln lo on lq lr ls oo lu lv lw op ly lz ma ij bi translated"><strong class="lh ja">今日学 AI</strong>系列第四个故事到此结束！</p><ul class=""><li id="96c2" class="nl nm iq lh b li lj ll lm lo ox ls oy lw oz ma ns nt nu nv bi translated">请考虑<a class="ae le" href="https://docs.google.com/forms/d/e/1FAIpQLSc0IBzdCn7osIjvGno1GjBakI-DfXHE8gDLZ--jNzWsXtRW0g/viewform" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">在这个链接中加入我的邮件列表</strong> </a> <strong class="lh ja"> </strong>，这样你就不会错过我即将发布的任何故事了！</li><li id="b7f1" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">我还会在<a class="ae le" href="http://learn-ai-today.com/" rel="noopener ugc nofollow" target="_blank"><strong class="lh ja">learn-ai-today.com</strong></a><strong class="lh ja">—</strong>我为这次学习之旅创建的页面上列出新的故事，并在<a class="ae le" href="https://github.com/mnpinto/learn_ai_today" rel="noopener ugc nofollow" target="_blank"><strong class="lh ja">GitHub 知识库</strong> </a>列出新的故事！</li><li id="a717" class="nl nm iq lh b li nw ll nx lo ny ls nz lw oa ma ns nt nu nv bi translated">如果你以前错过了，<a class="ae le" href="https://www.kaggle.com/mnpinto/learn-ai-today-04-time-series" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ja">这是 Kaggle 笔记本的链接，上面有这个故事的代码</strong> </a>！</li></ul><p id="b1e2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">欢迎在评论中给我一些反馈。你觉得什么最有用，或者什么可以解释得更好？让我知道！</p><p id="b3eb" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">你可以在下面的故事中了解更多关于我的深度学习之旅！</p><div class="mb mc gp gr md me"><a rel="noopener follow" target="_blank" href="/my-3-year-journey-from-zero-python-to-deep-learning-competition-master-6605c188eec7"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ja gy z fp mj fr fs mk fu fw iz bi translated">我的 3 年历程:从零 Python 到深度学习竞赛高手</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">自从 2017 年开始学习 Python 以来，我一直遵循的道路是成为一名独自参加 Kaggle 比赛的大师…</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">towardsdatascience.com</p></div></div><div class="mn l"><div class="pd l mp mq mr mn ms ky me"/></div></div></a></div><div class="mb mc gp gr md me"><a rel="noopener follow" target="_blank" href="/my-2-year-journey-on-kaggle-how-i-became-a-competition-master-ef0f0955c35d"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ja gy z fp mj fr fs mk fu fw iz bi translated">我在 Kaggle 上的两年旅程:我如何成为竞赛大师</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">描述我的旅程和策略，我遵循成为一个竞赛大师与个人金牌</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">towardsdatascience.com</p></div></div><div class="mn l"><div class="pe l mp mq mr mn ms ky me"/></div></div></a></div><p id="759c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="pf">感谢阅读！祝您愉快！</em></p></div></div>    
</body>
</html>