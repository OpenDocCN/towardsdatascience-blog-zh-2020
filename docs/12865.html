<html>
<head>
<title>Building a Recommendation System with Spark ML and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Spark ML 和 Elasticsearch 构建推荐系统</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-recommendation-system-with-spark-ml-and-elasticsearch-abbd0fb59454?source=collection_archive---------10-----------------------#2020-09-04">https://towardsdatascience.com/building-a-recommendation-system-with-spark-ml-and-elasticsearch-abbd0fb59454?source=collection_archive---------10-----------------------#2020-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4b29" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用交替最小二乘法和余弦相似度的产品推荐</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/cd2077606b608b120f055136739e10c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQzKKLMaREH0-7rYxhZ4nw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="132e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在不同产品公司的搜索团队工作时，总是有为用户建立推荐系统的持续需求。我们与流行的搜索引擎如 Elasticsearch、SOLR 建立了合作关系，并试图完善搜索相关性。但是当涉及到搜索相关性和仅仅用搜索引擎创建推荐系统时，总是有一个限制。我总是惊讶于亚马逊和网飞这样的公司根据我们的兴趣提供推荐。因此，通过使用 Apache spark 机器学习功能和 elasticsearch，我们将建立一个推荐系统。</p><p id="8aac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如上图，如果用户 1 喜欢物品 A、物品 B、物品 C，用户 2 喜欢物品 B、物品 C，那么有很大概率用户 2 也喜欢物品 A，可以向用户 2 推荐物品 A。</p><p id="fb1d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在推荐系统领域，主要有三种用于提供推荐的技术。</p><ul class=""><li id="21fd" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">协同过滤</li><li id="5b17" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">基于内容</li><li id="5659" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">混合技术</li></ul><p id="3128" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用 Pyspark 中的协同过滤技术来创建一个推荐系统。Apache Spark ML 实现了用于协同过滤的交替最小二乘法(ALS ),这是一种非常流行的推荐算法。</p><p id="91a9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ALS 是一种矩阵分解算法，使用交替最小二乘法和加权λ正则化(ALS-WR)。</p><p id="3941" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Spark ALS 的主要问题是，它只会为特定用户(用户-产品模型)推荐顶级产品，为特定产品(产品-用户模型)推荐顶级用户。</p><p id="abbe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">计算所有配对的相似性并不是针对大的产品目录。O(n2)组合数量的增长很快导致了代价过高的混洗操作和不可行的计算机时间。为了计算项目-项目相似性，我们使用来自 ALS 模型的项目因素的相似性，使用 spark 和 elasticsearch 建立了项目-项目模型。</p><p id="c065" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ALS 算法本质上分解两个矩阵——一个是用户特征矩阵，另一个是项目特征矩阵。我们正在对项目特征等级矩阵进行余弦相似性运算，以找到项目间的相似性。</p><h1 id="4d69" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">关于数据集</h1><p id="a52e" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">数据集主要包含来自 Amazon.com 的两种类型的数据。一个是元数据，它包含产品元数据，另一个是用户各自的不同产品的评级数据。</p><p id="fc63" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">注:数据集可以从这个</strong> <a class="ae nc" href="http://deepyeti.ucsd.edu/jianmo/amazon/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">站点</strong> </a> <strong class="kx ir">下载。</strong></p><p id="c8dc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用的 spark 版本是 2.4.6，elasticsearch 版本是 7.9.0</p><h1 id="f726" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">工作流程</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/7db593bd97c28640623a75c50f5b8762.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LnJgqflLrb8wiVVIUCptqw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><ol class=""><li id="07ad" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq ne lx ly lz bi translated">将产品数据集加载到 Spark 中。</li><li id="b1b4" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq ne lx ly lz bi translated">使用 Spark DataFrame 操作来清理数据集。</li><li id="6f45" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq ne lx ly lz bi translated">将清理后的数据加载到 Elasticsearch 中。</li><li id="7450" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq ne lx ly lz bi translated">使用 Spark MLlib，从评级数据中训练一个协同过滤推荐模型。</li><li id="c6a4" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq ne lx ly lz bi translated">将生成的模型数据保存到 Elasticsearch 中。</li><li id="2541" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq ne lx ly lz bi translated">使用弹性搜索查询，生成推荐。</li></ol><h2 id="0e67" class="nf mg iq bd mh ng nh dn ml ni nj dp mp le nk nl mr li nm nn mt lm no np mv nq bi translated">加载数据</h2><p id="93fd" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">以下代码用于读取产品数据，并将其转换为 spark 数据帧。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="b76d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 spark 中加载数据后，数据帧如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/1e1c965a12851e9427e7389a4f1617eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I8A0-cJDpzElczm8WFtl9w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="31c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们需要将产品数据索引到一个 Elasticsearch 索引中。为了将 elasticsearch 与 spark 连接起来，我们需要在类路径中添加一个 JAR 文件，或者将该文件放在 spark 的 jars 文件夹中。JAR <a class="ae nc" href="https://mvnrepository.com/artifact/org.elasticsearch.client/elasticsearch-rest-high-level-client/7.9.0" rel="noopener ugc nofollow" target="_blank">文件</a>需要基于我们现有的 spark 版本下载。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="065c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">既然已经在 Elasticsearch 中索引了产品元数据，我们需要根据主 id 索引文档的<strong class="kx ir"> model_factor </strong>列中每个产品的特征向量。</p><h2 id="4390" class="nf mg iq bd mh ng nh dn ml ni nj dp mp le nk nl mr li nm nn mt lm no np mv nq bi translated">准备特征向量</h2><p id="93c1" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">特征向量是通过使用 ItemFeatures 矩阵生成的，该矩阵是在我们对用户产品评级数据运行 MLib ALS 算法时生成的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a0e0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 spark 中加载评级数据并转换为数据帧后，将如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/d2de44878b6bb535b08085db438df48c.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*a7FWtfRUVMHQMUBau3u05w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="4ca0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在对模型进行评估后，我们得到了一个均方根误差值 RMSE=0.032，这是相当不错的。值越低，模型越好。</p><p id="1302" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们必须将项目向量索引回 Elasticsearch。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9700" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在项目向量已被索引到 elasticsearch，我们需要找到类似的产品。</p><p id="536e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了找到两个项目之间的相似性，我们将使用余弦相似性功能。余弦相似性是内积空间的两个非零向量之间相似性的度量，度量它们之间角度的余弦。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/e1905da96fccc2bb0f928cc906fd6950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WlGsu5cmw7kUFwKhbB9Ygw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="4307" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">余弦距离值越小，项目越相似。</p><p id="3479" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用 elasticsearch 中的<strong class="kx ir"> script_score </strong>功能计算产品的相似性得分。<strong class="kx ir">余弦相似度</strong>函数计算给定查询向量和文档向量之间的余弦相似度。</p><p id="dadf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下查询已用于从 elasticsearch 获取类似的项目。我们用类别过滤也是为了在类别中得到更好的结果。我们可以根据需要更改过滤器选项。该脚本将余弦相似度加 1.0，以防止分数为负。为了利用脚本优化，提供一个查询向量作为脚本参数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="2148" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下代码已被用于获得类似的产品。我们正在传递产品的 ASIN 和我们想要的产品推荐数量。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="2a8a" class="nf mg iq nx b gy ob oc l od oe">display_similar('B001A5HT94', num=5)</span></pre><p id="f018" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将给出前 5 名产品的结果，这与我们已经通过的产品类似。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/ddfaa1c6f1f74c50fe6b39358082acff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wX2epIc4FPUXoCEIbFT2FQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9f3a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">还不错！结果与我们搜索的产品相似。我们可以随时调整 ALS 算法，以获得更好的性能和精度。</p><p id="682a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们也可以采用隐式反馈参数来调整算法。本质上，这种方法不是试图直接对评级矩阵建模，而是将数据视为代表用户行为观察中的<em class="og">强度</em>的数字(如点击次数或购买产品的次数)。</p><p id="5637" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">源代码可以在<a class="ae nc" href="https://github.com/lijoabraham/spark-playground/tree/master/recommendation_system_spark_es" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p><h1 id="cd40" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">参考</h1><ul class=""><li id="a966" class="lr ls iq kx b ky mx lb my le oh li oi lm oj lq lw lx ly lz bi translated">协同过滤-<a class="ae nc" href="https://spark.apache.org/docs/3.0.0/ml-collaborative-filtering.html" rel="noopener ugc nofollow" target="_blank">https://spark . Apache . org/docs/3 . 0 . 0/ml-collaborative-filtering . html</a></li><li id="74c5" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用标签较远的评论和细化的方面来证明推荐的合理性。简墨倪，李嘉诚，朱利安麦考利。自然语言处理中的经验方法(EMNLP)，2019 ( <a class="ae nc" href="http://cseweb.ucsd.edu/~jmcauley/pdfs/emnlp19a.pdf" rel="noopener ugc nofollow" target="_blank"> PDF </a>)</li></ul></div></div>    
</body>
</html>