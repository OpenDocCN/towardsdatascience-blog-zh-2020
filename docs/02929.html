<html>
<head>
<title>Cloud Run: Google Cloud Text to Speech API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行:谷歌云文本到语音 API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/cloud-run-google-cloud-text-to-speech-api-dff308665c70?source=collection_archive---------33-----------------------#2020-03-20">https://towardsdatascience.com/cloud-run-google-cloud-text-to-speech-api-dff308665c70?source=collection_archive---------33-----------------------#2020-03-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="912d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Google Cloud Run 提供智能 API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/546c6e83dbe326dab8c736c17aebece3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qq9_WvZS8yZN_qXJd-cLqA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Google 文本到语音转换 API 服务于<strong class="bd ky">云运行</strong>。</p></figure><h1 id="7521" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">目录</h1><ul class=""><li id="1fc1" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><a class="ae mj" href="#05ab" rel="noopener ugc nofollow">在谷歌云上运行</a></li><li id="21f5" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#78c8" rel="noopener ugc nofollow">在谷歌云文本到语音转换 API 上</a></li><li id="d42a" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#3194" rel="noopener ugc nofollow">申请代码</a></li><li id="acf6" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#6acb" rel="noopener ugc nofollow">docker file</a></li><li id="0d99" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#a1a5" rel="noopener ugc nofollow">使用云构建构建映像，并上传到容器注册表</a></li><li id="4fc8" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#245c" rel="noopener ugc nofollow">使用云运行部署容器</a></li><li id="f7a5" class="lr ls it lt b lu mk lw ml ly mm ma mn mc mo me mf mg mh mi bi translated"><a class="ae mj" href="#1978" rel="noopener ugc nofollow">结论</a></li></ul><h1 id="05ab" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在谷歌云上运行</h1><p id="5b21" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">Google Cloud Run 于 2019 年 11 月左右正式发布。它提供了一个完全托管的无服务器执行平台，通过 HTTP 驱动的容器来抽象无状态代码部署的基础设施。Cloud Run 是一个 Knative 服务，利用相同的 API 和运行时环境，可以构建基于容器的应用程序，这些应用程序可以在任何地方运行，无论是在 Google cloud 或 Anthos 上部署，还是在云上。作为一个“无服务器执行环境”，Cloud Run 可以根据正在运行的应用程序的计算需求进行扩展。应用代码的即时执行、可扩展性和可移植性是 Cloud Run 的核心特性。</p><h1 id="78c8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">关于谷歌云文本到语音转换 API</h1><p id="2ff9" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">Google Cloud Text-to-Speech 公开了一个 API 来从文本合成听起来自然的语音。文本及其相应的语音输出可以是不同的语言，包括英语、法语、俄语和阿拉伯语，仅举几例。这种最先进的 API 为将逼真的高保真文本到语音交互集成到最终用户应用程序中提供了多种机会。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/0ece9afc5180a9e9052e22b50818a639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JAQykmK-gZXkV8TWSFTlnA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 1: </strong>谷歌云文本到语音转换 API。</p></figure><h2 id="3a0e" class="nd la it bd lb ne nf dn lf ng nh dp lj ly ni nj ll ma nk nl ln mc nm nn lp no bi translated">用于身份验证的服务帐户</h2><p id="12fe" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">要使用 Google Cloud 文本到语音转换 API，我们必须创建一个<strong class="lt iu">服务帐户密钥</strong>用于身份验证。服务帐户对应用程序或虚拟机(VM)进行身份验证，以在 Google 云平台上进行授权的 API 调用。</p><p id="2764" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">使用以下链接为云文本到语音转换 API 创建服务帐户。-&gt; <a class="ae mj" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey?_ga=2.228131353.560260692.1584281699-246233217.1575482579&amp;_gac=1.128859262.1582203091.Cj0KCQiA-bjyBRCcARIsAFboWg3ZXsO3kRXR_6ptPfIz4J0NJC6GlKoZTiQblYf4wcSyxL80xKX1xtMaAhwoEALw_wcB" rel="noopener ugc nofollow" target="_blank">云语音合成服务账号</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/67a78e9199a37141217399676a3ea13c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_xG7FH7I4QC3HzsXty0yKg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 2: </strong>为文本到语音 API 创建一个服务账户。</p></figure><p id="d7f5" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">使用以下参数:<br/> - <strong class="lt iu">服务账号:</strong>新服务账号。<br/> <strong class="lt iu"> -服务账户名称:</strong>【指定名称】。<br/> <strong class="lt iu"> -角色:</strong>不需要角色。<br/>点击<code class="fe nv nw nx ny b">Create without role</code>，将包含密钥的 JSON 文件下载到您的电脑。</p><p id="aef7" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">在创建并下载您的安全服务帐户密钥之后，将环境变量<code class="fe nv nw nx ny b">GOOGLE_APPLICATION_CREDENTIALS</code>设置为包含您的服务帐户密钥的 JSON 文件的路径(参见图 3)。</p><h1 id="3194" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">应用程序代码</h1><p id="a468" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">这个项目的代码托管在一个 Github 库中，链接为<a class="ae mj" href="https://github.com/dvdbisong/text-to-speech-cloud-run" rel="noopener ugc nofollow" target="_blank">https://github.com/dvdbisong/text-to-speech-cloud-run</a>。Python 文件<code class="fe nv nw nx ny b">app.py</code>包含了通过 HTTP 访问容器化应用程序的逻辑。代码在<code class="fe nv nw nx ny b">text-speech</code>目录下，可以在<strong class="lt iu">谷歌代码编辑器(云壳的一个组件)</strong>上查看。代码有注释，容易理解。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/f844acf9f5ef9630a7e045543b24b027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mK9PoMFbg9KEshPy2fo5dA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 3:</strong>Python 文件 app.py 中的应用代码。</p></figure><p id="a47a" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated"><strong class="lt iu">将服务账户密钥上传至应用程序</strong></p><p id="1ed2" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">上传服务帐户密钥以验证调用文本到语音转换 API 的应用程序。上传后，将密钥放在<code class="fe nv nw nx ny b">text-speech</code>文件夹中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/07e6276d7de8ffa9f519ab6035c99448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKHnMYE1Pxa4SixSet20Ug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 4: </strong>上传服务账号密钥。</p></figure><h1 id="6acb" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">文档文件</h1><p id="c452" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">docker 文件概述了创建容器映像的方法。这个项目的 Dockerfile 文件基于官方的 Python 图像。Dockerfile 指定了构建映像时将安装在容器上的相关包。Flask 应用程序使用<code class="fe nv nw nx ny b">gunicorn</code>包来公开访问容器内应用程序的端口。<strong class="lt iu">在谷歌代码编辑器上，</strong>导航至<code class="fe nv nw nx ny b">text-speech</code>查看 docker 文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/cedc2eabbefd8ebc67d6608a47684d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4fQijvpIelKcWWwoWyw5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 5: </strong> Dockerfile 为应用程序容器构建映像。</p></figure><p id="d172" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">为了完整起见，下表总结了 Dockerfile 文件中使用的命令。</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="4a15" class="nd la it ny b gy of og l oh oi">+------------+-----------------------------------------------------+<br/>| <strong class="ny iu">Command</strong>    | <strong class="ny iu">Description                                         </strong>|<br/>+------------+-----------------------------------------------------+<br/>| <strong class="ny iu">FROM</strong>       | The base Docker image for the Dockerfile.           |<br/>| <strong class="ny iu">RUN</strong>        | It executes commands on top of the current image as | |              new layers.                                         |<br/>| <strong class="ny iu">COPY</strong>       | Copies files from the local machine to the          |<br/>|              container filesystem.                               |<br/>| <strong class="ny iu">CMD</strong>        | Specifies the command to execute when running the   |   |              container. This command is overridden if another    |   |              command is specified at runtime.                    |<br/>| <strong class="ny iu">WORKDIR</strong>    | Sets the working directory of the container.        |<br/>| <strong class="ny iu">ENV</strong>        | Set Environment variable as a key-value pair that   | |              will be available in the container after building.  |<br/>+------------+-----------------------------------------------------+</span></pre><h1 id="a1a5" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">使用云构建构建映像，并上传到容器注册中心</h1><p id="37d4" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">Cloud Build 是一项 GCP 服务，用于自动化代码工件的部署，作为 CI/CD 管道的一部分。这里，Cloud Build 用于构建 Docker 映像，作为一系列构建步骤，完成的映像被推送到 Google 容器注册表。</p><p id="5255" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">以下代码使用云构建构建映像，并将映像上传到容器注册。从目录<code class="fe nv nw nx ny b">text-speech</code>运行这段代码。</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="52f8" class="nd la it ny b gy of og l oh oi">gcloud builds submit — tag gcr.io/ekabasandbox/ebisong-text-to-speech</span></pre><p id="5a01" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">其中，<br/> - <code class="fe nv nw nx ny b">ekabasandbox</code>为 GCP 项目 ID，<br/> - <code class="fe nv nw nx ny b">ebisong-text-to-speech</code>为图像名称。<br/> <strong class="lt iu">确保根据需要修改这些参数。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/0fd30a42fc3c96231ed3ae3655288012.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VMOxaUSx6l5QAYpSlLngA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 6: </strong>使用云构建构建映像。</p></figure><h1 id="245c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">使用云运行部署容器</h1><p id="c4a3" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">要将存储在<strong class="lt iu"> Google 容器注册表</strong>上的容器部署到<strong class="lt iu">云运行</strong>，请执行以下代码:</p><pre class="kj kk kl km gt ob ny oc od aw oe bi"><span id="efe2" class="nd la it ny b gy of og l oh oi">gcloud run deploy --image gcr.io/ekabasandbox/ebisong-text-to-speech --platform managed</span></pre><p id="9029" class="pw-post-body-paragraph mp mq it lt b lu np ju mr lw nq jx ms ly nr mu mv ma ns mx my mc nt na nb me im bi translated">选择要部署托管云运行计算的地区(例如美国中心 1)。当提示输入服务名时，按<code class="fe nv nw nx ny b">Enter</code>接受缺省值，并在询问是否允许未认证调用时响应<code class="fe nv nw nx ny b">y</code> (yes)。<br/> <br/>当容器部署到云运行时，点击 URL 查看正在运行的应用。<br/><a class="ae mj" href="https://ebisong-text-to-speech-4fa5lgaxpq-uw.a.run.app/" rel="noopener ugc nofollow" target="_blank"><strong class="lt iu"/></a><strong class="lt iu"><br/></strong>你可以继续探索应用了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/6b7afddb1a27a6d40f0a9bb871fda15c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I19PxmSekLylg3_ZROa3nQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">图 7: </strong>云 Run 上托管的文本到语音应用。</p></figure><h1 id="1978" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="6fdd" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">本文提供了一个在 Cloud Run 上部署进行 API 调用的应用程序的示例。它提供了使用 Google Cloud 文本到语音转换 API 和使用 Flask 运行简单 web 应用程序的示例代码，Flask 被打包成一个容器并部署在 Cloud Run 上。整个应用程序在 https://github.com/dvdbisong/text-to-speech-cloud-run 是开源的。最后，确保删除云运行服务，以及云容器注册表中不再需要的图像。</p></div></div>    
</body>
</html>