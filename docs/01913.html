<html>
<head>
<title>Please Stop Doing These 5 Things in Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">请停止在熊猫身上做这5件事</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/please-stop-doing-these-5-things-in-pandas-9fbabea897aa?source=collection_archive---------1-----------------------#2020-02-23">https://towardsdatascience.com/please-stop-doing-these-5-things-in-pandas-9fbabea897aa?source=collection_archive---------1-----------------------#2020-02-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6624" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这些错误非常普遍，也非常容易纠正。</h2></div><p id="a675" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一个在进入数据科学之前从事了十多年开发工作的人，我看到数据科学家在使用熊猫时犯了很多错误。好消息是这些真的很容易避免，修复它们也能让你的代码更可读。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/e80c75fbc3c652f062472cd9b001a71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7pKsJ_5D9bf46rMt"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">丹妮拉·霍尔泽在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="18bc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">错误1:缓慢地获取或设置值</h1><p id="c4e5" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">这不是任何人的错，熊猫有太多的方式来获得和设定价值。在某些情况下，您必须只使用索引来查找值，或者只使用值来查找索引。然而，在许多情况下，您将有许多不同的方法来选择数据:索引、值、标签等。</p><p id="2c14" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种情况下，我更喜欢用最快的。以下是一些常见的选择，从最慢到最快，这表明你可能会错过195%的收益！</p><p id="fbf8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用20，000行的数据框架进行测试。<a class="ae lu" href="https://colab.research.google.com/drive/1heqQy_55YHA9vacunPIbrf8zqd5SWqN5" rel="noopener ugc nofollow" target="_blank">如果你想自己运行，这是笔记本</a>。</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="fb3f" class="mx lw it mt b gy my mz l na nb"><strong class="mt iu"># .at - 22.3 seconds</strong><br/>for i in range(df_size):<br/>    df.at[i] = profile<br/>Wall time: <strong class="mt iu">22.3 s</strong></span><span id="f8cb" class="mx lw it mt b gy nc mz l na nb"><strong class="mt iu"># .iloc </strong>- <strong class="mt iu">15% faster than .at</strong><br/>for i in range(df_size):<br/>    df.iloc[i] = profile<br/>Wall time: <strong class="mt iu">19.1 s</strong></span><span id="d10e" class="mx lw it mt b gy nc mz l na nb"><strong class="mt iu"># .loc </strong>- <strong class="mt iu">30% faster than .at</strong><br/>for i in range(df_size):<br/>    df.loc[i] = profile<br/>Wall time: <strong class="mt iu">16.5 s</strong></span><span id="56c0" class="mx lw it mt b gy nc mz l na nb"><strong class="mt iu"># .iat</strong>, doesn't work for replacing multiple columns of data.<br/># Fast but isn't comparable since I'm only replacing one column.<br/>for i in range(df_size):<br/>    df.iloc[i].iat[0] = profile['address']<br/>Wall time: <strong class="mt iu">3.46 s</strong></span><span id="729a" class="mx lw it mt b gy nc mz l na nb"><strong class="mt iu"># .values / .to_numpy() </strong>- <strong class="mt iu">195% faster than .at<br/></strong>for i in range(df_size):<br/>    df.values[i] = profile<br/>    # Recommend using to_numpy() instead if you have Pandas 1.0+<br/>    # df.to_numpy()[i] = profile<br/>Wall time: <strong class="mt iu">254 ms</strong></span></pre><p id="1a0b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nd">(如</em><a class="ne nf ep" href="https://medium.com/u/c5d0dede6d1?source=post_page-----9fbabea897aa--------------------------------" rel="noopener" target="_blank"><em class="nd">Alex Bruening</em></a><em class="nd">和</em><a class="ne nf ep" href="https://medium.com/u/3af1160a401f?source=post_page-----9fbabea897aa--------------------------------" rel="noopener" target="_blank"><em class="nd">miraculixx</em></a><em class="nd">注释中指出，对于循环来说并不是执行这种动作的理想方式，</em> <a class="ae lu" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.apply.html" rel="noopener ugc nofollow" target="_blank"> <em class="nd">请看。</em>敷()</a>敷<em class="nd">。我在这里用它们，纯粹是为了证明，回路内部，线路的速度差。)</em></p><h1 id="1481" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">错误2:只使用了25%的CPU</h1><p id="531a" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">无论你是在服务器上还是在笔记本电脑上，绝大多数人都不会使用他们所有的计算能力。如今大多数处理器(CPU)都有4个内核，默认情况下，熊猫只会使用一个。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/62821b51bd76aaa2515dbbf170a42580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/0*ThbLuzcUf_oQ1jfh.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">从摩丁文档来看，4核机器上的4倍加速。</p></figure><p id="1976" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Modin是一个Python模块，通过更好地利用硬件来增强Pandas。摩丁数据帧不需要任何额外的代码，在大多数情况下，它会将你对数据帧所做的一切加速3倍或更多。</p><p id="f8c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">摩丁更像是一个插件，而不是一个库，因为它使用熊猫作为后备，不能单独使用。</p><p id="eb76" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">摩丁的目标是悄悄地扩充熊猫，让你不用学习新的库就能继续工作。大多数人需要的唯一一行代码是用<code class="fe nh ni nj mt b">import modin.pandas as pd</code>替换普通的<code class="fe nh ni nj mt b">import pandas as pd</code>，但是如果你想了解更多，请查看这里的文档<a class="ae lu" href="https://modin.readthedocs.io" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d47c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了避免重复已经做过的测试，我在Modin文档中添加了这张图片，展示了它可以在标准笔记本电脑上加速<code class="fe nh ni nj mt b">read_csv()</code>功能的程度。</p><p id="b7b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nd">请注意，Modin正在开发中，虽然我在生产中使用它，但您应该会遇到一些错误。查看GitHub </em>  <em class="nd">中的</em> <a class="ae lu" href="https://github.com/modin-project/modin/issues" rel="noopener ugc nofollow" target="_blank"> <em class="nd">问题和</em> </a><a class="ae lu" href="https://modin.readthedocs.io/en/latest/supported_apis/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="nd">支持的API</em></a><em class="nd">了解更多信息。</em></p><h1 id="c4a8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">错误3:让熊猫猜测数据类型</h1><p id="05b1" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">当您将数据导入到数据帧中，并且没有明确地告诉Pandas列和数据类型时，Pandas会将整个数据集读入内存，以确定数据类型。</p><p id="11c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果您有一个充满文本的列，熊猫将读取每个值，看到它们都是字符串，并将该列的数据类型设置为“字符串”。然后对所有其他列重复这个过程。</p><p id="851c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用<code class="fe nh ni nj mt b">df.info()</code>来查看一个数据帧使用了多少内存，这与Pandas计算每一列的数据类型所消耗的内存量大致相同。</p><p id="3448" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除非您在处理微小的数据集或者您的列经常变化，否则您应该总是指定数据类型。为此，只需添加<code class="fe nh ni nj mt b">dtypes</code>参数和一个字典，将列名及其数据类型作为字符串。例如:</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="345a" class="mx lw it mt b gy my mz l na nb">pd.read_csv(‘fake_profiles.csv’, dtype={<br/>    ‘job’: ‘str’,<br/>    ‘company’: ‘str’,<br/>    ‘ssn’: ‘str’<br/>})</span></pre><p id="6080" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:这也适用于不是来自CSV的数据帧。</p><h1 id="f94e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">错误4:剩余的数据帧</h1><p id="7caa" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">数据帧的一个最好的特点是它们很容易创建和更改。不幸的是，这样做的副作用是大多数人最终会得到这样的代码:</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="f5de" class="mx lw it mt b gy my mz l na nb"># Change dataframe 1 and save it into a new dataframe</span><span id="25db" class="mx lw it mt b gy nc mz l na nb">df1 = pd.read_csv(‘file.csv’)</span><span id="e8cc" class="mx lw it mt b gy nc mz l na nb">df2 = df1.dropna()</span><span id="df0f" class="mx lw it mt b gy nc mz l na nb">df3 = df2.groupby(‘thing’)</span></pre><p id="29f3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所发生的是你将<code class="fe nh ni nj mt b">df2</code>和<code class="fe nh ni nj mt b">df1</code>留在Python内存中，即使你已经转移到了<code class="fe nh ni nj mt b">df3</code>。不要在内存中留下多余的数据帧，如果你用的是笔记本电脑，它几乎会影响你做的所有事情的性能。如果你在一个服务器上，它会损害该服务器上其他人的性能(或者在某个时候，你会得到一个“内存不足”的错误)。</p><p id="b1aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相反，这里有一些简单的方法来保持你的记忆干净:</p><ul class=""><li id="cfbe" class="nk nl it kk b kl km ko kp kr nm kv nn kz no ld np nq nr ns bi translated">使用<code class="fe nh ni nj mt b">df.info()</code>查看数据帧使用了多少内存</li><li id="87d0" class="nk nl it kk b kl nt ko nu kr nv kv nw kz nx ld np nq nr ns bi translated"><a class="ae lu" href="https://jupyter-contrib-nbextensions.readthedocs.io/en/latest/install.html" rel="noopener ugc nofollow" target="_blank">在Jupyter </a>中安装插件支持，然后为Jupyter安装<a class="ae lu" href="https://jupyter-contrib-nbextensions.readthedocs.io/en/latest/nbextensions/varInspector/README.html?highlight=varinspector" rel="noopener ugc nofollow" target="_blank">变量检查器插件</a>。如果你习惯在R-Studio中有一个变量检查器，你应该知道<a class="ae lu" href="https://support.rstudio.com/hc/en-us/articles/360023654474-Installing-and-Configuring-Python-with-RStudio" rel="noopener ugc nofollow" target="_blank"> R-Studio现在支持Python </a>！</li><li id="9fd9" class="nk nl it kk b kl nt ko nu kr nv kv nw kz nx ld np nq nr ns bi translated">如果你已经在Jupyter会话中，你可以通过使用<code class="fe nh ni nj mt b">del df2</code>删除变量而无需重启</li><li id="e564" class="nk nl it kk b kl nt ko nu kr nv kv nw kz nx ld np nq nr ns bi translated">在一行中将多个数据帧修改链接在一起(只要它不会使你的代码不可读):<code class="fe nh ni nj mt b">df = df.apply(thing1).dropna()</code></li><li id="9ebc" class="nk nl it kk b kl nt ko nu kr nv kv nw kz nx ld np nq nr ns bi translated"><em class="nd">正如</em><a class="ne nf ep" href="https://medium.com/u/7ebfe5448045?source=post_page-----9fbabea897aa--------------------------------" rel="noopener" target="_blank"><em class="nd">Roberto Bruno Martins</em></a><em class="nd">所指出的，另一种保证干净内存的方法是</em> <strong class="kk iu"> <em class="nd">执行函数</em> </strong> <em class="nd">内的操作。您仍然可以这样无意中滥用内存，解释范围超出了本文的范围，但是如果您不熟悉，我鼓励您阅读这篇文章。</em></li></ul><h1 id="b3c7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">错误5:手动配置Matplotlib</h1><p id="c8ca" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">这可能是最常见的错误，但它排在第五位，因为它影响最小。我甚至在经验丰富的专业人士的教程和博客帖子中看到这种错误。</p><p id="5cd9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Matplotlib是由Pandas自动导入的，它甚至在每个数据帧上为您设置了一些图表配置。</p><p id="d2cd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">没有必要为每个图表导入和配置它，因为它已经为您烤成熊猫了。</p><p id="e71b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里有一个错误做法的例子，尽管这是一个基本图表，但仍然是浪费代码:</p><pre class="lf lg lh li gt ms mt mu mv aw mw bi"><span id="5e91" class="mx lw it mt b gy my mz l na nb">import matplotlib.pyplot as plt<br/>ax.hist(x=df[‘x’])<br/>ax.set_xlabel(‘label for column X’)<br/>plt.show()</span></pre><p id="fb20" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正确的方法是:</p><p id="e45e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nh ni nj mt b">df[‘x’].plot()</code></p><p id="9c81" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更容易，对吗？你可以对这些<a class="ae lu" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.plot.html" rel="noopener ugc nofollow" target="_blank">数据帧绘图对象</a>做任何你可以对任何其他<a class="ae lu" href="https://matplotlib.org/3.1.3/api/_as_gen/matplotlib.pyplot.plot.html" rel="noopener ugc nofollow" target="_blank"> Matplotlib绘图对象</a>做的事情。例如:</p><p id="7b85" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nh ni nj mt b">df[‘x’].plot.hist(title=’Chart title’)</code></p><p id="3728" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我确信我正在犯我不知道的其他错误，但是希望与您分享这些已知的错误将有助于更好地使用您的硬件，让您编写更少的代码，完成更多的工作！</p><p id="5a9c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nd">如果你还在寻找更多的优化，你一定会想读:</em></p><div class="ny nz gp gr oa ob"><a rel="noopener follow" target="_blank" href="/the-3-secret-weapons-that-changed-my-python-editor-forever-c99f7b2e0084"><div class="oc ab fo"><div class="od ab oe cl cj of"><h2 class="bd iu gy z fp og fr fs oh fu fw is bi translated">Python的3个疯狂的秘密武器</h2><div class="oi l"><h3 class="bd b gy z fp og fr fs oh fu fw dk translated">我不知道没有他们我是如何生活的</h3></div><div class="oj l"><p class="bd b dl z fp og fr fs oh fu fw dk translated">towardsdatascience.com</p></div></div><div class="ok l"><div class="ol l om on oo ok op lo ob"/></div></div></a></div><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="oq or l"/></div></figure></div></div>    
</body>
</html>