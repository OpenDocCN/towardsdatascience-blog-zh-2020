<html>
<head>
<title>Send Google Analytics Hit Level Data to BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向BigQuery发送Google Analytics点击量数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b?source=collection_archive---------17-----------------------#2020-04-30">https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b?source=collection_archive---------17-----------------------#2020-04-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b2bc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何发送标准的谷歌分析点击量数据到BigQuery？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e3ab850f761498a3316d35ab40b00e85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vuCNj2Q7w8yy5Fz_CYdKw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://pixabay.com/users/graphicssc-1426978/" rel="noopener ugc nofollow" target="_blank"> Graphicssc </a>，来源<a class="ae ky" href="https://pixabay.com/illustrations/graphic-analytics-statistics-1142957/" rel="noopener ugc nofollow" target="_blank"> pixabay </a></p></figure><p id="da8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标准的谷歌分析不提供其点击量数据，我们必须购买GA 360来获得它，这是非常昂贵的。</p><p id="9c4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本指南中，我将帮助您建立一个数据管道，允许您在BigQuery中存储GA的数据。这将是一个命中水平的数据，不仅可以让你生成谷歌分析提供的所有报告，还可以应用先进的机器学习技术，将你的业务提升到一个新的水平。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="89e2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为什么发送命中水平数据？</h1><p id="3c90" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">以下是存储GA命中水平数据的许多使用案例中的一些:</p><ol class=""><li id="e8d1" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><strong class="lb iu">无数据抽样。</strong>存储点击量数据让我们在不进行任何采样的情况下创建报告。对于那些每天流量都很大的网站来说，这是一个巨大的进步。</li><li id="4de8" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">构建任何报告</strong>。GA报告有限。点击级别数据允许您使用任何配置构建包含任何分段的任何报告。</li><li id="345f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">机器学习。</strong>应用先进的机器学习技术，获得对你的业务有用的细分和预测<strong class="lb iu"> </strong>。</li><li id="4f9c" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">数据仓库</strong><strong class="lb iu"> </strong>将GA数据与其他营销活动数据联系起来，以便更全面地了解您的营销工作</li><li id="717a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">可视化</strong>。在你喜欢的任何地方可视化数据(不仅仅是在谷歌数据工作室)</li></ol><p id="2a26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">还有很多！</strong></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8b2f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">数据管道</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/6ba6265d04595c554e18d8d08b0eb6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OxLPikuGyQvZnoQEFxln5A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由Muffaddal创建的GTM到BigQuery数据管道</p></figure><blockquote class="no np nq"><p id="ad00" class="kz la nr lb b lc ld ju le lf lg jx lh ns lj lk ll nt ln lo lp nu lr ls lt lu im bi translated">这难道不是一个简单的数据管道吗？确实是！</p></blockquote><p id="1dfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的ELT数据管道使用Google Tag Manager来获取发送到GA的hit，使用Cloud函数来获取和处理从Tag Manager收到的hit，使用BigQuery来存储数据。我们还将使用Bigquery的查询调度器进行原始数据转换。</p><p id="10cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我从Simo Ahava在<a class="ae ky" href="https://www.simoahava.com/analytics/google-tag-manager-monitor/?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=muffaddal.qutbuddin&amp;utm_content=send_ga_hit_data_to_bigquery" rel="noopener ugc nofollow" target="_blank"> tag monitor guide </a>上的帖子中获得了这个想法，并将其用于将GA的数据发送给BigQuery。所以，如果你对监控你的标签感兴趣的话，一定要去看看</p><p id="33ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注</strong> : <em class="nr">我将使用GTM发送和谷歌云平台处理和存储点击数据，但这些工具不是强制性的。一旦您理解了数据如何在这些组件之间移动，任何技术栈都可以用来实现这个数据管道。而且如果你有兴趣探索GCP这边的东西我会推荐</em> <a class="ae ky" href="https://bit.ly/2X4kefM" rel="noopener ugc nofollow" target="_blank"> <em class="nr">谷歌的GCP课程</em> </a> <em class="nr">。</em></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f567" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">谷歌标签管理器</h1><p id="8ef4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">测量协议是一个向Google Analytics发送数据的API。我们发送到GA的任何调用，无论是使用代码片段还是使用标记管理器，都将被发送到测量协议。我们的想法是捕获相同的击中，这将是测量协议，并将其发送到我们的数据仓库。</p><p id="76a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是怎么做呢？嗯，Google analytics对象提供了一个回调函数，当调用被发送到GA时触发该函数。使用该功能，我们可以访问正在发送的命中级别数据。该功能被称为<code class="fe nv nw nx ny b"><a class="ae ky" href="https://www.simoahava.com/analytics/customtask-the-guide/?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=muffaddal.qutbuddin&amp;utm_content=send_ga_hit_data_to_bigquery" rel="noopener ugc nofollow" target="_blank">customTask</a></code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/daae1fc83c307e4fe6da4575a1614c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QOPwznhivm-K4XYO_X_pTg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示数据如何在自定义任务和其他工具之间移动的数据流图，由Muffaddal</p></figure><p id="7071" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们使用自定义函数类型的变量在Google标签管理器中创建一个自定义任务句柄函数</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/6de6aa899d787216c36775b41f616083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*m0ReInEN5s3ZaNmimHSLeA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Muffaddal为customTask选择自定义JavaScript</p></figure><p id="e6e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并按原样粘贴下面的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Muffaddal向云函数发送hit的自定义任务代码</p></figure><p id="9b5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你只需要在一个名为“云函数URL”的常量变量中提供到云函数的链接，GTM就会开始向云函数发送GA的数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/bbadb568f59bcabd5c995cf24b974693.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*CrK6i9p2Vtt0Z8k_Q4o3gw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">与云函数链接的GTM常量变量，由Muffaddal</p></figure><p id="1ab2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将自定义函数变量命名为“自定义任务”。接下来，转到您的设置变量，在“要设置的字段”中添加customTask，并为其提供我们的变量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/ae30b8a7dc07cdf4bb1b5db2543cd8e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HHsjWsLAeYAYNdOlaaY6Qg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Muffaddal在设置变量中添加customTask字段</p></figure><p id="d2f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将customTask直接添加到GA设置变量可以确保我们的函数在每次命中GA时触发。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bba8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">谷歌云功能</h1><p id="ae61" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">接下来，我们必须设置我们的云函数来接收来自GTM的点击，并将其发送给BigQuery。我将在本指南中使用Node.js，但它也可以用任何其他语言实现，比如Python。首先让我们配置我们的云功能</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/468958036d5a0489b212f9ca865d0a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*xjZsf0NdUfUpoUujlOEu-Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云功能配置，由muffaddal</p></figure><p id="da30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经将分配的内存设置为512 MB。您可能希望根据您预期收到的点击量来更新此信息。但大多数情况下，512 MB应该就可以了。</p><p id="c152" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将下面的代码复制到<code class="fe nv nw nx ny b">package.json</code>文件中，告诉我们的云函数使用的节点依赖关系。我们将在Node.js代码中使用BigQuery和云存储。</p><p id="8fb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nr">为什么选择云存储？稍后会详细介绍。</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云函数的Package.json，由Muffaddal</p></figure><p id="59d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在您的<code class="fe nv nw nx ny b">index.js</code>文件中添加下面的<strong class="lb iu"> Node.js 8 </strong>代码，并根据您的GCP环境设置‘projectId’、‘dataset’、‘tableName’和‘bucket name’。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用于处理GA命中的云函数代码，由Muffaddal编写</p></figure><p id="5597" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们还在原始的hit对象中包含了时间戳(<em class="nr">第38行</em>)。这是为了在我们的数据集中有一个日期参数。这将允许我们对数据执行基于日期的操作。</p><p id="381c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果我们在向BigQuery插入原始命中时遇到任何错误，我们会将该命中存储到云存储中。这样做确保我们至少不会错过击中。一旦进入云存储，就可以根据错误进行处理并转发给BigQuery。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/0051b8249b5ca284a1bd3f13d1ef8e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*-XMxwIKNwa_bhArjVQSLjw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有无错误的数据流，由Muffaddal</p></figure><p id="a29c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我根据错误类型在bucket中创建了一个子文件夹。这将有助于区分点击，并允许我们相应地处理它们。</p><p id="d5ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经在文章的最后提到了错误的可能原因。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9a84" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">谷歌大查询</h1><p id="b9bd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">用类型字符串创建一个包含两列<code class="fe nv nw nx ny b">hit_timestamp</code>和<code class="fe nv nw nx ny b">payload</code>的表。确保该表的名称与您在云函数中添加的名称相同。</p><p id="179b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是它的样子。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/05d44462bacc4162b2cfd454943ba2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O09s7sobsmZSRlB_RxRykw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery中的原始数据表，由Muffaddal</p></figure><p id="4c95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有效负载栏中长而怪异的字符串正是Google analytics从网站接收点击的方式，也是我们存储它的方式。它将所有数据点格式化为查询参数。在本节的后面，我们将把它转换成可读的格式。时间戳是我们在云函数代码中添加的列。</p><p id="c0fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦表被创建，我们的数据管道接收谷歌分析点击量数据准备好了！</p><p id="0f5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将把这些原始数据转换成可读的格式。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8f14" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">转换原始数据</h1><p id="5300" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">想法是从有效负载列中提取参数值，并将它们存储在转换后的表中。为此，我们将使用SQL查询。查询将做的是每天从原始数据中提取我们需要的值，并将其附加到转换后的表中。</p><p id="a412" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个从原始点击中提取数据的查询</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Muffaddal转换原始数据的查询</p></figure><p id="001b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将hit_timestamp转换为纽约时间，因为我的Google Analytics时间设置为纽约。我希望我的BigQuery数据能够与谷歌分析的数据相媲美，我建议你也这样做。这有助于匹配事物。</p><p id="5d3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nr">您可能还会问为什么查询只从以前的数据中提取日期？这是有原因的。我将在下一节讨论这一点。</em></p><p id="e887" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行上述查询将获得以下转换格式的数据</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/dac87a5df5c18ac18cf8de40d215eb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eerlFgMVYdyFP-0Oxvbw8g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由Muffaddal转换的GA数据表</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f1bb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">BigQuery查询调度程序</h1><p id="859c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">接下来，我们希望我们的转换查询能够每天获取格式数据，这样我们就不必在处理数据集时自己转换它。查询调度器可以帮助我们做到这一点。它将在每天的<strong class="lb iu"> 00:30 </strong>运行，并提取前一天收到的数据，对其进行转换，并将其添加到我们转换后的数据表中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/a5f735175c1f78aca3ac63a61e617002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6hSYoISn-Qi-aSIrEVgBLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据转换流程，由Muffaddal</p></figure><p id="0207" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是要使用的计划程序设置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/da7809792b6bb870e599cdc48896a570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*P5Ku4iemSWuIKBFIEq-UjA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Muffaddal的BigQuery查询调度程序设置</p></figure><p id="0e93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么我把它安排在00:30？</p><p id="7bb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调度程序的工作是运行SQL查询。该查询从运行时开始获取前一天的所有内容。因此，日期一改变，我就运行调度程序，这样我们就能得到前一天收到的所有信息。这确保我们获得前一天的所有用户活动，并将其存储在转换后的表中。</p><p id="eab9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调度器还被设置为将查询结果追加到目标表中。因此，每天结束时，我们都会在BigQuery中获得转换后的数据。</p><p id="cca5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是基于上述SQL查询的转换表的模式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">转换的数据表架构，bu Muffaddal</p></figure><p id="edb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">搞定了。</p><p id="02d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，我们的数据管道已经完成，可以捕获GA hit，并将其发送到云功能。后者将其转发给BigQuery。在BigQuery查询调度器中处理原始数据，对其进行格式化，并将其存储在我们的表中，以便能够构建报告并对其进行分析。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="aff9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们为什么不直接在云函数中转换命中数据？</h1><p id="ceca" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在BigQuery中存储Google analytics的原始点击比只存储转换后的点击数据有很多优势。其中一些是:</p><ol class=""><li id="1edf" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">变换过程中的任何错误都可能导致整个命中的丢失。这本身就是巨大的损失。</li><li id="fd40" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">谷歌分析跟踪的变化可能会改变整个转型过程。</li><li id="7f34" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">转换后的表模式中的任何变化都会导致转换过程在存储新的命中之前发生变化。</li></ol><p id="d49e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">在BigQuery中直接存储原始命中数据的优势:</strong></p><ol class=""><li id="1586" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">可以直接查询原始数据。</li><li id="71ca" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">在转换后的数据或表格中出现任何错误的情况下，回溯变得更加容易。</li><li id="9ce3" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">您可以随时从原始数据中直接过滤数据点，以便在转换后的版本中包括(或排除)数据点。</li><li id="d352" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">您可以用类似的方式从原始数据中提取任何新的维度或值。</li><li id="38a6" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">转换后的表可以随时从原始数据重建。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ad84" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">需要注意的几个要点</h1><p id="9c75" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">实现以上内容将使您能够在BigQuery中处理GA数据。然而，我想指出的是，在实现数据管道时，应该考虑几件事情。</p><h2 id="a255" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated">Google Analytics自定义维度</h2><p id="c66a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">并不是所有的东西都通过它的API发送到GA。因此，我建议在你的谷歌分析中实现以下自定义维度，这将丰富你的点击量数据。</p><ol class=""><li id="2d38" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><strong class="lb iu">地理定位</strong>:获取用户在你的数据集中的位置</li><li id="997d" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">设备类型</strong>:每次点击获取设备信息。</li><li id="8fb5" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">用户代理</strong>:这个维度可以让你得到多个其他维度，比如浏览器及其版本。它还可以帮助您过滤垃圾邮件流量，因为垃圾邮件发送者没有用户代理。</li><li id="2413" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><strong class="lb iu">会话Id </strong>:这将有助于按会话分组和过滤你的数据集。发送显式会话id有助于简化会话级分析过程。</li></ol><blockquote class="no np nq"><p id="c18d" class="kz la nr lb b lc ld ju le lf lg jx lh ns lj lk ll nt ln lo lp nu lr ls lt lu im bi translated">如果你需要我的帮助来建立这个端到端的数据管道，请在LinkedIn上告诉我。</p></blockquote><p id="1b61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，在GA中设置session-id维度的传统方式不起作用。与传统方式一样，我们将随机id发送给GA，GA将收到的最后一个id作为会话id存储在自定义维度中。在我们的例子中，您必须为整个会话发送相同的id值，以便在BigQuery中，您可以在会话的每次点击中看到相同的id。</p><h2 id="cd03" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated">人口统计信息</h2><p id="c296" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">由于人口统计信息是从GA的后端添加到GA中的，所以我们将无法在我们的点击量数据中获得人口统计信息。尽管您可以使用来自hit数据集的客户端id或用户id从GA的API中提取此类数据。</p><h2 id="055d" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated"><strong class="ak">SQL查询中的查询参数</strong></h2><p id="94a8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">上面转换原始数据的SQL查询涵盖了GA hit拥有的许多参数，但不是全部，比如增强的电子商务的参数。您可能需要根据您的google analytics实现来更新查询。</p><h2 id="60d6" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated"><strong class="ak">错误</strong></h2><p id="b49b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如上所述，如果我们的云函数遇到错误，我们的管道会将命中结果存储在云存储中。云函数中可能会出现错误，原因有很多，其中包括:</p><ul class=""><li id="2496" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ox nf ng nh bi translated">已达到BigQuery报价限制。</li><li id="3e2d" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ox nf ng nh bi translated">云函数收到了不必要的点击(例如，由于垃圾邮件),这可能会导致我们的代码中出现错误。</li><li id="9799" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ox nf ng nh bi translated">由于不需要的架构命中架构，BigQuery拒绝插入。</li><li id="fc3a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ox nf ng nh bi translated">可能还有其他不可预见的运行时错误</li></ul><p id="f88e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在任何情况下，这个想法是至少存储GA命中，以便我们不会错过它。</p><p id="baa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">云存储中的数据需要根据其存储在云存储中的错误进行处理。</p><h2 id="6428" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated">时区</h2><p id="1baa" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您将不得不更新SQL查询，以匹配您的谷歌分析的时间，使数字具有可比性。</p><h2 id="a83a" class="ol md it bd me om on dn mi oo op dp mm li oq or mo lm os ot mq lq ou ov ms ow bi translated">GCP组件限制</h2><p id="bf09" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">云函数和BigQuery都有限制，根据你的流量，你可能需要增加两个组件的配额限制。</p><ul class=""><li id="83dc" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ox nf ng nh bi translated">云函数可以每100秒处理<a class="ae ky" href="https://cloud.google.com/functions/quotas" rel="noopener ugc nofollow" target="_blank"> 1亿次调用。</a></li><li id="a263" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ox nf ng nh bi translated">BigQuery接受每个项目每秒100，000行。</li></ul><p id="2220" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以在将数据发送到BigQuery之前，使用一个中间组件临时批处理数据。</p><h1 id="ea51" class="mc md it bd me mf oy mh mi mj oz ml mm jz pa ka mo kc pb kd mq kf pc kg ms mt bi translated">实时数据管道</h1><p id="2f6b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">还可以进行管道转换，并在Bigquery中实时存储数据，而不是由调度程序引起的延迟。这个想法是，你从云函数接收到的有效载荷中提取参数，直接发送给BQ。</p><p id="173c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你使用实时管道，我会建议你仍然存储原始的点击，因为它有助于在事情发生时进行回溯。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0bad" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结束了</h1><p id="8ab9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">尽管标准的谷歌分析并不提供其点击率数据。通过实现一个简单的数据管道，我们可以在我们的数据仓库中捕获谷歌分析点击。</p><p id="71fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用GTM将GA命中结果发送给云函数，云函数将命中结果以原始格式转发给BigQuery。其中我们利用了一个查询调度器来将原始数据转换成转换格式。这样做允许我们将Google Analytics的点击量数据存储在我们的数据仓库中。它可以用于执行任何类型的分析和/或创建我们喜欢的报告。</p><p id="c1f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">类似的读数</strong></p><ol class=""><li id="87be" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/automate-data-import-to-google-analytics-471de2c3fc76">使用GCP自动将数据导入谷歌分析</a></li><li id="3c9e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/rfm-analysis-using-bigquery-ml-bfaa51b83086">使用BigQuery ML </a>执行RFM分析</li></ol><h1 id="4f66" class="mc md it bd me mf oy mh mi mj oz ml mm jz pa ka mo kc pb kd mq kf pc kg ms mt bi translated">参考</h1><p id="68c8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><strong class="lb iu"> Github代码</strong></p><div class="pd pe gp gr pf pg"><a href="https://github.com/muffaddal52/Send-Google-Analytics-Hits-to-BigQuery" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab fo"><div class="pi ab pj cl cj pk"><h2 class="bd iu gy z fp pl fr fs pm fu fw is bi translated">muffaddal 52/Send-Google-Analytics-Hits-to-big query</h2><div class="pn l"><h3 class="bd b gy z fp pl fr fs pm fu fw dk translated">这个回购有代码来帮助发送谷歌分析点击量数据到BigQuery。它使用了GTM，云函数，BigQuery和…</h3></div><div class="po l"><p class="bd b dl z fp pl fr fs pm fu fw dk translated">github.com</p></div></div><div class="pp l"><div class="pq l pr ps pt pp pu ks pg"/></div></div></a></div></div></div>    
</body>
</html>