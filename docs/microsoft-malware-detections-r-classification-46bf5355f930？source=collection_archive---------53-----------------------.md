# 微软恶意软件检测(R 级)

> 原文：<https://towardsdatascience.com/microsoft-malware-detections-r-classification-46bf5355f930?source=collection_archive---------53----------------------->

## 检查导致计算机被感染的因素，并比较三种不同的预测模型:带逻辑回归的 LASSO 正则化、随机森林和梯度推进决策树(GBDT)。

![](img/ebdcded21be2a7a795a07f9da4343fea.png)

由 KOBU Agency 在 Unsplash 上开发的一款游戏

**团队成员** : [Lukas Tuong](https://www.linkedin.com/in/quoc-tuong-lukas-dong/) ，[叶晨](https://www.linkedin.com/in/yechen-charlotte/)，[王佳义](https://www.linkedin.com/in/jiayi-wang-325joygee/)，[景岩乔](https://www.linkedin.com/in/jingyan-qiao/)

# 一/导言

随着信息产业和相关技术的发展，计算机和其他机器在任何行业的生产中变得越来越重要，保持机器处于安全状态并且不被任何类型的恶意软件感染是安全部门面临的最大挑战。恶意软件行业仍然是一个组织良好、资金充足的市场，致力于规避传统的安全措施。一旦计算机被恶意软件感染，犯罪分子会以多种方式伤害消费者和企业。为了保护企业和消费者客户的计算机，预先降低个人数据泄露的风险，微软非常重视这个问题，并调查了机器被感染的因素，以改进他们的安全系统。从微软收集的数据集包含每台机器的各种属性和每台机器的实际感染状态，由微软的端点保护解决方案 Windows Defender 生成，该解决方案旨在满足某些业务约束，既涉及用户隐私，也涉及机器运行的时间段。

逻辑回归模型是一种经典的机器学习模型分类，当因变量是二分的(二元)时，它是一种合适的回归分析。与所有回归分析一样，逻辑回归是一种预测性分析，用于描述数据并解释一个因变量和一个或多个自变量之间的关系。给定数据集中的因变量(响应)是机器上是否检测到恶意软件，因此逻辑回归模型是此分析中的基本模型。在追求高维数据集预测的更高精度时，偏差和方差之间的权衡无时不在。给定的数据集包含 83 列和 50k 多行。正则化回归是一种在高维数据集上拟合回归模型时避免过度拟合风险并减少模型方差而不显著增加偏差的方法。最小绝对收缩和选择算子(LASSO)正则化方法适用于具有多个高度相关预测因子的模型，以去除冗余特征，以便于模型解释做出决策。

决策树是一种通过基于特征分割数据来对观察结果进行分类的模型，但当研究人员面临各种类型的特征或大量数据时，它具有弱点，尤其是在大数据中。决策树的复杂性严重降低了预测模型的效率和准确性。随机森林是分类分析中的一种机器学习方法，它由大量单独的决策树组成，作为一个整体发挥作用。研究人员从每棵树上收获分类预测，并基于多数投票方法决定哪个是最重要的分类。为了优化预测，研究人员通常使用自举方法。另一种非常适合基于决策树的分类领域的机器学习算法方法是梯度推进决策树(GBDT)模型。它是使用增强技术的模型的集成，本质上是将弱分类器组合起来形成一个更强的分类器。具体地，在这种情况下，弱分类器是不同的决策树，因此 GBDT 模型的结果可以被认为是这些决策树的组合。提升过程是连续的，它将随后的树连接到在过去产生的预测中有误差的先前的树，以便在组合过程中逐渐减小预测误差。此外，GBDT 模型不会将单棵树的结果作为最终结果。因此，它也可以用来解决过拟合问题。

这项研究的目标是预测机器被恶意软件感染的概率，并确定影响感染的最重要因素，以便微软开发人员采取措施，在未来改进他们的系统。此外，这也是一个更好地了解各种分类方法的理论和性能的机会，如简单逻辑回归、带 Lasso 正则化的逻辑回归模型、随机森林和梯度推进决策树方法，并进一步探索大量预测因子和分类响应变量之间的关系，并进一步根据研究结果进行预测。

# II/数据和方法:

## 数据描述:

数据是从位于 Kaggle 的[微软竞赛中检索的，并执行了数据清理流程。原始数据集包含 8，921，483 个观察值，具有机器的 82 个不同特征和一个响应变量，即机器是否被恶意软件感染(有感染:编码为 1，无感染:编码为 0)。在调查缺失值的频率和每个要素的维度分布后，缺失值水平较高(缺失值的百分比超过 75%)或维度高度不平衡的要素将被删除。例如，没有一台机器看起来有 Beta 软件，因此功能 is Beta(Beta 软件是否出现在每台机器上)被删除，在此分析中研究了 50 个变量。](https://www.kaggle.com/c/microsoft-malware-prediction)

本研究中假定的重要特征是:

***引擎版本:*** *引擎的版本。*

****AvSigVersion:****反病毒特征码数据库的版本。**

*****avproductstateigner:****机器上使用的杀毒软件的状态。***

******Wdft _ IsGamer:****该机是否为游戏机。****

*****城市标识符:*** *机器所在的地方。***

*****国家标识符:*** *机器所在的国家。***

******OS ver:****当前操作系统的版本。****

******OS platform:****操作系统所使用的平台。****

*****被保护:*** *机器上是否有杀毒产品。***

*****防火墙*** *:是否在机器上建立了防火墙。***

******HasTpm:****机器是否有可信平台模块。****

*****智能屏幕:*** *智能屏幕在机器上启用。***

******Census _ SystemVolumeTotalCapacity****:机器上安装的系统卷的大小。****

******Census _ OsBuildRevision:****机器上最新版本的操作系统。****

*****平台*** *:安装在机器上的平台。***

******Census _ TotalPhysicalRAM:****随机存取存储器的数量。****

******Census _ HasOpticalDiskDrive****:机器是否有光驱。****

******Census _ o edition:****当前操作系统的版本。****

******Census _ IsTouchEnabled:****机器是否为触控设备。****

## **方法:**

> ****逻辑回归模型。****

**a.总结逻辑模型，并根据 95%置信区间的 P 值选择具有显著贡献的预测因子。**

**b.画出因变量的预测概率。**

> ****LASSO 正则化方法:Logistic 回归模型。****

**a.用所有选定的预测值绘制交叉验证曲线。**

**b.确定最小化平均交叉验证误差的λ值和最小均方误差的一个标准误差内的λ值，以使用 lasso 正则化方法识别最佳逻辑回归模型。**

> ****随机森林模型。****

**a.将目标特征编码为因子。**

**b.将数据集分成 6 个树组，并将每个组分成训练集和测试集。**

**c.将随机森林分类适合 6 棵树的训练集。x 是因变量，y 是结果，ntree 表示要生长的树的数量，结果为 500 棵树。**

**d.以二进制格式显示预测结果，生成矩阵并比较 6 组不同的数据，以确定最佳决策树。**

> ****梯度推进决策树(GBDT)模型。****

**a.标签编码:标签编码将值转换为 0 到 n-1 之间的数字，其中 n 是不同标签的数量。**

**b.频率编码:频率编码是标签编码的特例。基于频率对特征值进行编码。转换后的值是介于 0 和 m 之间的数字，其中 m 是频率大于或等于 2 的值的数量。**

# **III/分析和讨论:**

> ****Logistic 回归分析:****

**预测公式可通过对多个预测值进行逻辑回归，在 95%的置信区间内构建，如下所示:**

> ****(has detections)**的预测 logit = 0.7084 * platform windows 8+0.9071 * SkuEditionEduation+0.9809 * SkuEditionEnterprise+1.366 * SkuEditionHome+2.108 * SkuEditionInvalid+0.933 * SkuEditionPro+0.3086 * is protected+0.1395 * Wdft _ is gamer+0.7202 * app version。(1)**

**根据等式 1，机器感染几率的对数与 9 个特征相关(p 值< 0.05). All features have a coefficient greater than 0, which suggests that these features enhance the probability of the machine getting infected. The feature IsProtected (whether each machine has any active anti-virus products) and Wdft_IsGamer (whether the user of each machine is a gamer) have the lowest p value, therefore these two features are most critical factors increasing the probability of the machine having infections.**

**The goodness-of-fit statistics assess the fit of a logistic model against actual outcomes (i.e., whether a machine has infections). Adjusted R-squared value is 0.028, suggesting around 2.8% of the observations can be explained by the model. The large AIC value (80695) and Residuals (59748) also show the inefficacy of the model.**

**![](img/6ec2b910f927117ff776112d0fa71705.png)**

**Table 1: Confusion Matrix (Logistic Regression Model) (*图片作者***

****1:被恶意软件感染的机器。***

****0:未被恶意软件感染的机器。***

**采用混淆矩阵来评估逻辑回归模型的性能。表 1 表明，大约一半未被感染的机器被预测为未被感染，大约三分之二被感染的机器被逻辑回归模型正确分类。预测的总体成功率为 58.07%。第一类错误(未受感染的机器被错误预测)相对高于第二类错误(受感染的机器被错误分类为未受感染)，这在某些方面捍卫了该模型，因为将受感染的机器分类为未受感染比反之风险更大。**

**![](img/4fb13f749afb02b7e30fc7b6ec904800.png)**

**图 1:结果变量的预测概率，HasDetections ( *作者图片*)**

**概率预测图显示了每台机器被恶意软件感染的预测概率以及实际的恶意软件检测状态。Y 轴是检测到的概率，X 轴是从 60，000 台机器的最低值到最高值的感染概率。曲线在概率 0.5 附近比较平坦，说明模型的预测效率不高，与上面的小 R 平方值一致。**

> ****使用 LASSO 正则化方法的逻辑回归分析:****

**![](img/0e9951cf1df14e1469253e98dbefbabd.png)**

**图 2:均方误差与(λ)的对数的关系。(*图片作者*)**

**根据图 3，均方误差的值随着λ值的增加而增加，并且第一虚线为正则化方法选择了两个λ值。较小的λ导致最小的均方误差，并且λ在一个标准偏差内，这导致具有最少特征的模型。应用 lambda 为 0.00265 的套索正则化过程来移除多余的变量。通过将 Lasso 正则化方法应用于逻辑回归模型来调整预测公式，如下所示:**

> **(HasDetections)的预测 logit = 0.1017 * platform windows 8+0.0843 * is protected+0.0169 * Wdft _ is gamer**

**从等式 1 到等式 2，几个特征被缩减为零。人们注意到，在 Lasso 正则化之后，只有三个特征显示出重要性:platform Windows 8(Windows 8 平台)、IsProtected(每台机器上是否有任何反病毒产品)和 Wdft_IsGamer(每台机器的用户是否是游戏玩家)。所有这三个特征以正系数增加了机器被恶意软件感染的风险。**

**![](img/203514104b55b82f3b8a8ca41233c698.png)**

**表 2:混淆矩阵(采用 Lasso 正则化方法的 Logistic 回归模型)。(*图片作者*)**

**在执行套索正则化方法后，与表 1 所示的简单逻辑回归模型的结果相比，准确率提高了约 0.1%。然而，产生的最大 R 平方值约为 0.039，这表明该模型无效。**

> ****随机森林模型:****

**![](img/1df769c1e3351be2156d25146e4e1842.png)**

**图 3:混淆矩阵(随机森林模型)。(*图片作者*)**

**在随机森林中，数据集被分成 6 棵树，每棵树的输入数量略有不同(500-1000 行),以测试输入的大小是否会实际影响预测率。从图 3 中可以看出，行数最少(4883 个输入)的树 1 的成功率最高，为 57.04%。观察的数量越多，树 6 (6265 个输入)的成功率越低，树 6 只能成功预测 55.91%的测试集。因此，在所有树中，I 类错误(错误地将机器分类为受感染的机器，而实际上它不是)的数量大于 II 类错误(错误地将受感染的机器分类)的数量，这降低了错误预测的严重性。**

**图 4 表示测试集中的实际检测状态，上面的表示预测结果。置信水平被设置为较低的 0.45 和 0.475，并且还被设置为 0.55，以便比较成功率的结果。使用树 1 作为优化的基础，成功率随着故障区域置信水平的变化而波动。尽管如此，优化成功率最高的仍然是原始树 1，成功率为 57.04%。任何高于或低于 0.5 的置信度都会降低随机森林预测模型的成功率。因此，置信水平通常分布在 0 和 1 之间，平均值为 0.5。然而，类型 II 误差从原始树 1 (15.83%)减少到阈值为 0.55 的树 1 的优化 3(10.84%)。因此，置信度为 0.55 的优化案例 3 将被视为成功率降低 0.3%的更有用的决策树。**

> ****梯度推进决策树(GBDT)模型:****

**数据集被随机分为训练集(70%)和测试集(30%)，每个集包含大约相等数量的受感染机器和未受感染机器。训练集用于建立模型，以便可以预测测试机器被感染的概率(1 =有感染，0 =没有感染)。大于 50%的概率意味着机器预计会被感染，而低于 50%的概率不会被感染。**

**![](img/c3dc8962c97d1635a1fe48c9f7f362e4.png)**

**表 3:混淆矩阵(有 60，000 个观察值的 GBDT 模型)。(*图片作者*)**

**![](img/e03e2103bbad6ad1b1dab049b93b257e.png)**

**表 4:GBDT 模型的精度、召回率和 F1 值(有 60000 个观察值)。(*图片作者*)**

**根据表 3，8841 台未被感染的机器中有 4555 台被正确分类，8965 台被感染的机器中有 3609 台被正确分类，预测准确率为 55.66%。精确度和召回率衡量预测模型的性能，比例越高表示性能越好，准确率越高。理论上，模型的修改旨在提高查准率和查全率，但提高查准率总是导致查全率降低，反之亦然。因此，精确度和召回率的结合，F1 分数，被用来更好地评估模型。从表 4 中可以看出，在每组受感染或未受感染的机器中，F1 分数都小于 60%，这表明该模型很难解释这些观察结果。表 5:混淆矩阵(有 100，000 个观察值的 GBDT 模型)。**

**![](img/7e6df244073f6ad39e49f3894e240bdd.png)**

**表 5:混淆矩阵(有 100，000 个观察值的 GBDT 模型)。(*图片作者*)**

**![](img/d99188320c3eddf7837bf41a9d2d9e94.png)**

**表 6:GBDT 模型的精度、召回率和 F1 值(有 10 万个观察值)。(*图片作者*)**

**在具有 100，000 个观察值的较大数据集上采用了 GBDT 模型，准确率提高了约 2.68%，如表 5 所示。此外，对于感染和未感染的病例，F1 得分都高于 55%，这证实了具有更大量数据的模型的更好的功效。**

**![](img/3c0ddb432407e3cb3387609b5be86e12.png)**

**图 5:特征的重要性显示出显著的贡献(有 60，000 个观察值)。(*图片作者*)**

**![](img/6a452520c083947e9eed759fa19b0fbc.png)**

**图 6:显示显著贡献的特性的重要性(有 100，000 个观察值)。(*图片作者*)**

**梯度推进决策树(GBDT)模型生成在模型拟合过程中使用的每个特征的频率，并且具有较高频率的特征被认为具有较高的重要性。绘制了两个 GBDT 模型的条形图，以直观显示这些功能对机器被感染的可能性的影响。图 5 中最重要的前三个特性是 CountryIdentifier(每台机器所在的国家)，LocaleEnglishNameIdentifier(微软定义的机器语言代码，即英语= 1033。)和 GeoNameIdentifier(机器所在的地理区域)，它们都与机器的位置相关。Census _ SystemVolumeTotalCapacity(安装在机器上的系统卷的大小)、CountryIdentifier(每台机器所在的国家)和 Census_OsBuildRevision(机器上操作系统的最新版本，即 Windows 10 =1909 的最新版本)似乎是贡献较高的前三个功能。随着观察数量的不同，每个特性的重要性从图 5 到图 6 都发生了变化。然而，没有足够的证据表明图 6 中的前三个特征能够以相对较低的成功率给出精确的预测。**

# **四、结论和建议:**

**从上面讨论的结果可以得出结论，Lasso 逻辑回归模型是该数据集的最佳预测模型，具有最高的 58.18%的成功率，而被认为是分类机器学习的最佳模型之一的随机森林在优化之前和之后在所有三个模型中具有最低的成功率。此外，梯度推进决策树(GBDT)模型不是以较小的准确率(57.34%)预测每台机器被感染的概率的合适方法。发现 r 编程语言在处理包含超过 1000 个唯一值的变量时性能有限。此外，在 Python 中对具有更多高维特征的 GBDT 模型进行了相同的处理，从而获得了 62.02%的更高准确率。**

**提取过程中的错误概率。由于计算机和 R 编程语言的限制，本研究中使用的观察值仅占整个数据集的 6.7%左右，这使得结果很难代表整个数据集。选择了更大的样本来优化 GBDT 模型，它确实将准确率提高了 2.68%，这证实了样本大小的重要性。尽管我们随机抽取了等量受感染和未受感染机器的数据集，但仍可能有其他因素可以解释最终结果，例如，这些机器的某些属性可能会按特定顺序记录。**

**缺乏透明性、保密性和不可解释的特征。在 83 个原始列中，只有大约一半被选择用于此分析。这是由于许多特征没有被清楚地详细解释、编码，甚至对于所有的观察都是缺失的。其中一个例子是地理特征。所有国家都以保密的方式进行编码，因此无法研究每个国家的机器被恶意软件感染的概率。这些地理要素被排除在随机森林预测之外，因为它们的每个变量都有 200 多个唯一值，而 Random Forest 函数只能分配 53 个。**

**为了进行进一步的研究，研究人员应该在具有大量内存的计算机上使用 Python 执行这些模型，以利用整个数据集，并专注于在该分析中显得重要的特征。这可以是研究位于相同位置或固定的具有大量类别的其他特征之一的那些机器以获得更精确的预测结果的替代方式，并且可以选择不同的观察组来验证机器的每个属性的显著性。**

****Github**:[https://Github . com/lukastuong 123/R-Projects/tree/master/Project-% 20 微软% 20 恶意软件% 20 预测](https://github.com/Lukastuong123/R-Projects/tree/master/Project-%20Microsoft%20Malware%20Prediction)**

****参考文献**:**

**1.**布朗施泰因，A.** (2019)。在 Python 中训练/测试分割和交叉验证。检索自[https://towardsdatascience . com/train-test-split-and-cross-validation-in-python-80 b 61 beca 4 b 6](/train-test-split-and-cross-validation-in-python-80b61beca4b6)**

**2.**在 R. (** 未注明)中计算分类评价指标。检索自[https://blog . revolution analytics . com/2016/03/com _ class _ eval _ metrics _ r . html](https://blog.revolutionanalytics.com/2016/03/com_class_eval_metrics_r.html)**

**3.**微软恶意软件预测。**(未标明)。从 https://www.kaggle.com/c/microsoft-malware-prediction/data[取回](https://www.kaggle.com/c/microsoft-malware-prediction/data)**

**4.**微软恶意软件预测。**(未标明)。检索自[https://www . ka ggle . com/c/Microsoft-malware-prediction/discussion/84065](https://www.kaggle.com/c/microsoft-malware-prediction/discussion/84065)**

**5.Openspecs-Office。(未注明)。[MS-OE 376]:LCID 7.6.2.39 的第 4 部分(区域 ID)。检索自[https://docs . Microsoft . com/en-us/open specs/office _ standards/ms-OE 376/6c 085406-a698-4e 12-9d4d-C3 b 0 ee 3d BC 4a](https://docs.microsoft.com/en-us/openspecs/office_standards/ms-oe376/6c085406-a698-4e12-9d4d-c3b0ee3dbc4a)**

**6.**人。** (2019)。Rstudio，它可用于大型数据集(9gb)吗？检索自[https://community . r studio . com/t/r studio-is-it-useable-for-large-dataset-9gb/21138/7](https://community.rstudio.com/t/rstudio-is-it-useable-for-large-data-sets-9gb/21138/7)**

**7.**尤尔托奥卢，N.** (2018)。[http://www . History Studies . net/dergi//比林西-雅顿-萨瓦辛达-比尔-阿萨伊斯-索鲁努-塞宾卡拉希萨尔-埃尔梅尼-伊斯亚尼 20181092a4a8f.pdf.](http://www.historystudies.net/dergi//birinci-dunya-savasinda-bir-asayis-sorunu-sebinkarahisar-ermeni-isyani20181092a4a8f.pdf.) 历史研究国际历史杂志，10(7)，241–264。doi:10.9737/历史 2018.658**