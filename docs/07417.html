<html>
<head>
<title>Static Hosting with SSL on S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">S3 上使用 SSL 的静态托管</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/static-hosting-with-ssl-on-s3-a4b66fb7cd00?source=collection_archive---------2-----------------------#2020-06-05">https://towardsdatascience.com/static-hosting-with-ssl-on-s3-a4b66fb7cd00?source=collection_archive---------2-----------------------#2020-06-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/3a1307e7e9e09c162f0a170bac0f0240.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S--UUJs0kbsbRCgk"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk">Photo by <a class="ae jd" href="https://unsplash.com/@hhh13?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">傅甬 华</a> on <a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></p></figure><div class=""/><p id="5208" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上个月，我花了大量时间搜索 AWS 文档，试图找出如何:</p><ul class=""><li id="cc85" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">主机静态内容…</li><li id="618c" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">…在 S3 桶里…</li><li id="6ae1" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">…使用自定义域名…</li><li id="3bae" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">和 SSL (HTTPS)连接。</li></ul><p id="0c04" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">鉴于像<a class="ae jd" href="https://gohugo.io/" rel="noopener ugc nofollow" target="_blank">雨果</a>或<a class="ae jd" href="https://jekyllrb.com/" rel="noopener ugc nofollow" target="_blank">杰基尔</a>这样的静态站点生成器越来越受欢迎，这个<em class="lp">看起来</em>应该是一个简单的过程。</p><p id="5d22" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你在这里，你可能会发现这是<strong class="kf jh">而不是</strong>直截了当。你可能也从半打不同的 StackOverflow 问题和支离破碎的博客帖子中拼凑出了一个解决方案。所以:下面是我目前的剧本，关于如何在 AWS 上用 SSL 托管静态站点。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="f2e9" class="lx ly jg bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">步骤 1:将域转移到 AWS / Route53</h1><p id="96cb" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">如果您打算从 S3 桶中提供静态内容，并且想要 SSL 支持，那么您将需要一个 CloudFront 发行版。(CloudFront 是亚马逊的 CDN 服务。)从技术上来说，你的域名注册并不一定要在亚马逊进行，这简化了几个步骤。因此，本行动手册的其余部分假设您能够并且愿意将您的域名转移到 AWS。</p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div class="gh gi na"><img src="../Images/1975f76b99759b298bf42f0e6e8c5cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*RpotsHlpZP2h-R7S959lnw.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">在 Route53 中转移域名→注册域名屏幕</p></figure><p id="c8fd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从您的 AWS 控制台，前往 Route53 → Registered Domains，确认您的域名已经存在，或者点击<em class="lp"> Transfer Domain </em>启动注册转移。<strong class="kf jh">【备选路径:</strong>在 Route53 中设置一个与您当前注册商的区域设置完全匹配的托管区域，并将域名服务器设置指向您的 Amazon 托管区域中<code class="fe nf ng nh ni b">NS</code>记录中列出的服务器。]</p><h1 id="694d" class="lx ly jg bd lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq nn ms mt mu bi translated">步骤 2:创建自定义域 SSL 证书</h1><p id="49be" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">太好了！您的自定义域已准备好“安全”接下来，您需要从 AWS 证书管理器请求一个证书(在控制台服务列表中找到它)。这相当快，而且免费:</p><ul class=""><li id="bedc" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">点击<em class="lp">申请证书</em></li><li id="6a34" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">选择<em class="lp">请求公共证书</em>(您想要一个可以被外界使用的证书)</li><li id="feb9" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">在<em class="lp">域名</em>编辑框中输入两条记录:<code class="fe nf ng nh ni b">yourdomain.com</code>和<code class="fe nf ng nh ni b"><a class="ae jd" href="http://www.yourdomain.com." rel="noopener ugc nofollow" target="_blank">www.yourdomain.com</a></code>T25。我们将在两个独立的 CloudFront 发行版上使用这个证书。<strong class="kf jh">【替代路径:</strong>如果您有其他用于访问静态内容的子域，您当然会希望在这里输入这些子域。]</li><li id="8727" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">选择<em class="lp"> DNS 验证</em>(这让证书管理器通过在 Route53 中自动生成记录来验证您对域的使用)</li><li id="da8b" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">如果您愿意，可以随意在证书中添加自定义标签。</li><li id="5f78" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">点击<em class="lp">审核</em>，然后<em class="lp">确认并请求</em>。</li></ul><p id="a9b4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发起证书请求后，您可以为每个证书路径向域的托管区域添加一个<code class="fe nf ng nh ni b">CNAME</code>记录。或者，更简单的是，只需点击按钮，让 AWS 为您插入记录。</p><h1 id="2f7a" class="lx ly jg bd lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq nn ms mt mu bi translated">步骤 3:设置您的 S3 时段内容</h1><p id="c9d5" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">当我们等待 SSL 证书生成时(这可能需要几分钟)，我们可以前往 S3 并设置我们的存储桶。你需要两个水桶:</p><ul class=""><li id="7438" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><code class="fe nf ng nh ni b">mydomain.com</code>将包含您想要托管的所有静态内容；和</li><li id="cfc1" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nf ng nh ni b">www.mydomain.com</code>将流量重定向到<code class="fe nf ng nh ni b">mydomain.com</code></li></ul><p id="bd9f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">【备选路径:</strong>如果您希望从<code class="fe nf ng nh ni b">www.mydomain.com</code>获得流量服务，只需翻转下面的说明。]</p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/775d34fbab24654724dd79c1fa1f6a9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYUnYXM3ogm-WVQ7m88Rww.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">输入您的域名作为存储桶的名称</p></figure><p id="fd37" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，创建您的内容 S3 存储桶(上例中的<code class="fe nf ng nh ni b">mydomain.com</code>)。如果您愿意，可以使用您的域名作为 bucket 的名称，但是因为我们将在它前面放置一个 CloudFront 发行版，所以这不是一个技术要求。您不需要在 bucket 创建流程的下一个屏幕上配置任何特殊选项。</p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/a0c97511292587a081906d6db561e5a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkhzDRiKu0abnRED9sokuA.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">取消选中“阻止所有<em class="nq">公共访问”以允许全世界访问您的内容</em></p></figure><p id="3cfd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保取消选中“阻止所有公共访问”，这样公共用户就可以看到您的内容。在几次由于开放的 S3 桶的安全设置不严而导致的公开(尴尬)数据泄露之后，亚马逊在这一步上提出了额外的警告和预防措施。然而，在这种情况下，你确实希望这些文件在互联网上到处泄露。</p><p id="ee32" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，为您的备用域名存储桶重复上述过程。此存储桶将用于将流量重定向到您的主域。</p><p id="93e8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在将您的内容上传到您的主要静态托管桶之后，转到该桶的属性选项卡并编辑<em class="lp">静态网站托管</em>设置。您希望<em class="lp">使用这个桶来托管一个网站</em>，将索引文档设置为您的默认页面的文件名(例如<code class="fe nf ng nh ni b">index.html</code>)。此时，您可以使用静态托管设置中的端点进行测试。</p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nr"><img src="../Images/3622809c6fabfe8e5003244efd47353c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yS4_p1A4eyOqom8cULM4BQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">在 S3 存储桶属性选项卡中找到静态网站托管设置</p></figure><figure class="nb nc nd ne gt is gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/574d67e103b304723d43e9c0d8d41c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*O5UM9gwdunHKHUxCSZ74gQ.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">配置 S3 桶来托管一个静态网站</p></figure><p id="05cc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您的 S3 存储桶的最终配置任务是进入托管您的<em class="lp">备用</em>域存储桶(例如<code class="fe nf ng nh ni b">www.mydomain.com</code>)的属性的<em class="lp">静态网站。您希望<em class="lp">将请求</em>重定向到您的主域，并将协议设置为<code class="fe nf ng nh ni b">https</code>(假设您希望所有重定向流量都被路由到 SSL 连接)。</em></p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/bc043b8ce6cce334b975725ebd5b5be7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*Ut1wXQNtpEBKZYJJP0ptDQ.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">配置辅助 S3 桶，通过 HTTPS 将流量重定向到主桶</p></figure><h1 id="f349" class="lx ly jg bd lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq nn ms mt mu bi translated">步骤 4:创建 CloudFront 发行版</h1><p id="00e1" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">现在，您的公共证书应该可以使用了。对于这个用例，云前端是 DNS 记录、SSL 证书和 S3 桶之间的连接组织:</p><figure class="nb nc nd ne gt is gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/3fdb033993560cbb5e27b4607e77bbba.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*slEP3HJ558rLUndrQdF3fA.png"/></div></figure><p id="038a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有这些看似不必要的复杂性的原因是，CloudFront 可以处理与自定义域的 SSL 连接，但 S3 不能。(也许，有一天，AWS 会着手构建一个更简单的解决方案，而这篇文章会让人觉得古怪。)</p><p id="c34a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用两个独立的 CloudFront 发行版:一个专门处理<code class="fe nf ng nh ni b">mydomain.com</code>，另一个处理<code class="fe nf ng nh ni b">www.mydomain.com</code>。您<em class="lp">可以</em>只使用一个响应两个名称的发行版来完成解决方案，但是客户端流量将根据原始请求显示为来自<code class="fe nf ng nh ni b">mydomain.com</code>或<code class="fe nf ng nh ni b">www.mydomain.com</code>。在双 CF 配置中，对二级域名的请求将一直流向二级 S3 存储桶(<code class="fe nf ng nh ni b">www.*</code>)，然后被重定向到<code class="fe nf ng nh ni b">www</code>-自由路径。</p><p id="081d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此:在 CloudFront 中，创建一个<em class="lp"> Web 发行版</em>。配置面板中有<em class="lp">组</em>设置:</p><ul class=""><li id="8ceb" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><em class="lp">来源域名</em>表示内容的来源(<em class="lp">来源</em>)应该是什么。通过选择控件，您将看到可用作原点的可用 S3 桶的列表。选择<code class="fe nf ng nh ni b">mydomain.com</code>。</li><li id="7c4d" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp">限制 Bucket 访问</em>:如果启用，该选项要求所有公共流量通过 CloudFront 路由。这并不是 CloudFront 的全部内容，但是如果您想“锁定”您的 bucket 并保证页面总是显示在自定义域名下，那么您会想要使用它。</li><li id="e16a" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp">查看器协议策略</em>:设置为<em class="lp">将 HTTP 重定向到 HTTPS </em>以强制所有连接使用 SSL。没有什么好的理由不这样做。</li><li id="d79c" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp">允许的 HTTP 方法</em>:指定您的站点需要哪些 HTTP 方法。对于我的大多数被动内容网站，默认的<em class="lp"> GET，HEAD </em>设置是检索内容所需要的，但是如果你有<em class="lp"> POST </em>表单，那么你需要调整这个设置。</li><li id="1525" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">自动压缩对象:你想减少带宽吗？你当然知道！启用 gzip 压缩。</li><li id="8453" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp">备用域名</em> : <strong class="kf jh">非常重要:</strong>您<em class="lp">必须</em>在这里输入<code class="fe nf ng nh ni b">mydomain.com</code>或<code class="fe nf ng nh ni b">www.mydomain.com</code>，这取决于您正在设置的发行版。当客户端请求到达 Route53 并被路由到 CloudFront 进行分发时，CF 将验证请求的域是否在其域名列表<em class="lp">和</em>中，以及证书是否与该域匹配。</li><li id="5fd3" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp"> SSL 证书:</em>以上所有工作都归结于这一个设置。选择<em class="lp">自定义 SSL 证书</em>并选择您最近创建的 SSL 证书将其绑定到发行版。</li><li id="6426" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="lp">默认根对象</em>:存储请求的默认页面，如果请求 URL 中没有包含页面。使用相同的<code class="fe nf ng nh ni b">index.html</code>风格的设置，在你的 S3 桶设置中使用。</li></ul><p id="8cfa" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以单击<em class="lp">创建分发版</em>，并在 CloudFront 将您的内容复制到边缘节点时，对您的第二个分发版(对于<code class="fe nf ng nh ni b"><a class="ae jd" href="http://www.mydomain.com)" rel="noopener ugc nofollow" target="_blank">www.mydomain.com</a></code> <a class="ae jd" href="http://www.mydomain.com)" rel="noopener ugc nofollow" target="_blank"> ) </a>重复这个练习。</p><h1 id="22eb" class="lx ly jg bd lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq nn ms mt mu bi translated">步骤 5:更新域区域设置</h1><p id="615e" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">在您的 CloudFront 发行版建立起来之后，剩下唯一要做的事情就是为<code class="fe nf ng nh ni b">mydomain.com</code>更新 Route53 中的 DNS 设置:</p><ul class=""><li id="ba94" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">为<code class="fe nf ng nh ni b">mydomain.com.</code>更新或创建一个<code class="fe nf ng nh ni b">A</code>记录，它是<code class="fe nf ng nh ni b">mydomain.com.</code>的 CloudFront 发行版的别名</li><li id="c4f2" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">为<code class="fe nf ng nh ni b">www.mydomain.com</code>更新或创建一个<code class="fe nf ng nh ni b">A</code>记录，该记录与<code class="fe nf ng nh ni b">www.mydomain.com</code>的分布有相似的别名。</li></ul><h1 id="6f58" class="lx ly jg bd lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq nn ms mt mu bi translated">派对时间</h1><p id="3241" class="pw-post-body-paragraph kd ke jg kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">瞧啊。现在，您应该能够使用 HTTP 或 HTTPS 请求访问<code class="fe nf ng nh ni b">mydomain.com</code>和<code class="fe nf ng nh ni b">www.mydomain.com</code>，并在<code class="fe nf ng nh ni b">https://mydomain.com</code>被路由到由 S3 存储桶提供的同一个页面。(作为奖励，你有一个 CDN 做后盾。)</p><p id="2c11" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据您决定如何将新内容复制到您的 S3 存储桶，您将需要调整您的发布过程，包括在新的或修改的文件上传后使<code class="fe nf ng nh ni b">mydomain.com</code>的 CloudFront 发行版无效。</p></div></div>    
</body>
</html>