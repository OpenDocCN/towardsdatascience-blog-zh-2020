<html>
<head>
<title>The Alternative to Web Scraping, Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Web 抓取的替代方案，第二部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-alternative-to-web-scraping-part-ii-c2e3c2c06556?source=collection_archive---------19-----------------------#2020-07-14">https://towardsdatascience.com/the-alternative-to-web-scraping-part-ii-c2e3c2c06556?source=collection_archive---------19-----------------------#2020-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f7f6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">检索 web 数据的干燥方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/232d8278b627a380faff9e27d802bf00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MAUxCmORtDtOl5SzjHvLYw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">费尔南多·埃尔南德斯在<a class="ae ky" href="https://unsplash.com/s/photos/person-programming?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7adb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" rel="noopener" target="_blank" href="/the-alternative-to-web-scraping-8d530ae705ca">的上一篇文章</a>中，我描述了如何在不使用网络抓取的情况下从雅虎财经中检索数据。具体来说，我们发现了一种利用 XHR 请求检索数据的方法。从那里，我们在浏览器的开发者控制台中发现了更多带有搜索功能的非官方终端。如果没有任何 XHR 请求，我们能做什么呢？</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="e272" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，记住干燥原则很重要(以下来自维基百科):</p><blockquote class="mc md me"><p id="dfb8" class="kz la mf lb b lc ld ju le lf lg jx lh mg lj lk ll mh ln lo lp mi lr ls lt lu im bi translated"><strong class="lb iu">不要重复</strong> ( <strong class="lb iu">干</strong>，或者有时<strong class="lb iu">不要重复</strong>)是<a class="ae ky" href="https://en.wikipedia.org/wiki/Software_development_process" rel="noopener ugc nofollow" target="_blank">软件开发</a>的<a class="ae ky" href="https://en.wikipedia.org/wiki/Principle#Principle_as_axiom_or_logical_fundament" rel="noopener ugc nofollow" target="_blank">原则</a>，旨在减少软件模式的重复，<a class="ae ky" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself#cite_note-1" rel="noopener ugc nofollow" target="_blank">【1】</a>用抽象代替它或者使用<a class="ae ky" href="https://en.wikipedia.org/wiki/Data_normalization" rel="noopener ugc nofollow" target="_blank">数据规范化</a>来避免冗余。</p></blockquote><p id="b6d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建了你试图抓取的网站的开发者很可能就是带着这个原则在运作的。站点中可用的数据使用一种固定的模式呈现——无论是列表、表格还是一系列 div。很可能，这对你来说并不陌生；这是你用来收集数据的。但是，就像第一篇文章一样，我认为花时间寻找替代方案是有好处的。</p><h1 id="1401" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">例子</h1><p id="7601" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">最近，我被要求搜索大约 100 个房地产网站，以便一家公司能够跟踪他们当地市场的商业地产销售情况。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="4084" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我看的第一个地方是 https://duwestrealty.com/properties/ T21。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/3417680bc76aa7ae063686c9e62cf95e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-cjhLIAdc1_VyKEWjRXkFg.png"/></div></div></figure><ul class=""><li id="2ba1" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">我总是做的第一件事是检查开发者控制台的网络选项卡中的 XHR 请求</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/531d8a4422025f67b79743a49d005c15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSey8rJjaPT6ylo3RR9gbw.png"/></div></div></figure><ul class=""><li id="4018" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">而且……什么都没有。好吧，没理由气馁。屏幕顶部附近有复选框，最有可能过滤下面的结果。我的猜测是，如果我改变其中一个复选框，一个 XHR 请求将被解雇。我们试试吧！</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/caf61f78fda5923606a8235c11bf2408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XxktgH3CdVZfu6Wqd_xiYA.png"/></div></div></figure><ul class=""><li id="c92c" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">取消选中“用于租赁”复选框后，XHR 请求确实发生了。但是，进一步考察之后，似乎一点帮助都没有。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/1e40b0e8970b6c77a12dd79661ba8419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_9_ls-0j_MOZpseg45ny8Q.png"/></div></div></figure><ul class=""><li id="7f99" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">看起来这个网站正在努力隐藏这个请求。这比我想象的要难。</li><li id="a82b" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu nm nn no np bi translated">我现在要去检查大教堂。具体来说，我想看看每个属性的图像和细节是如何呈现的。这是我右键单击其中一个图像并选择“Inspect”后看到的内容。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/23c497eebe5b020a9042fef1ebc3a648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AMKe5vqiFG-i4omvIhQIFg.png"/></div></div></figure><ul class=""><li id="4ff9" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">首先，看起来每个属性都在 id 为<strong class="lb iu"> properties 的 div 中。</strong>并且，每个属性都在一个带有类<strong class="lb iu">属性</strong>的 a 标签内。</li><li id="e29b" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu nm nn no np bi translated">这就是干燥原理再次发挥作用的地方。从传统的 web 抓取的角度来看，我们要么以属性 id 为目标，要么以属性类为目标，然后遍历结果。然而，为什么不从站点开发者的角度考虑这些标识符呢？从 CSS 的角度来看，他们很可能使用这些标识符来保持代码的干爽，但也可能是为了利用 javascript 注入数据。</li><li id="c6e6" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu nm nn no np bi translated">所以，接下来我要做的是在开发者控制台中搜索<em class="mf">属性</em>。结果如下:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/a4622a517f84a08121e045dbb8f330ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_WY-bvXyELnc9ytlX-9klA.png"/></div></div></figure><ul class=""><li id="0d8e" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">前几个是 css 文件。我知道那些不会有什么有用的东西，所以我继续浏览着名单。往下第五个是<em class="mf">properties . js；那似乎很有希望。我将把该文件复制到文本编辑器中，并再次搜索“properties”。这是我的发现:</em></li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><ul class=""><li id="1b4c" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">让我们再细分一下，因为这里有很多有用的信息:</li></ul><ol class=""><li id="6160" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu ob nn no np bi translated">他们利用了 ajax，它允许页面发出异步 HTTP 请求。</li><li id="6c65" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu ob nn no np bi translated">URL 位于一个名为<code class="fe oc od oe of b">ajaxUrl</code>的变量中。</li><li id="99a8" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu ob nn no np bi translated">他们正在发出一个<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST" rel="noopener ugc nofollow" target="_blank"> POST </a>请求。</li><li id="44b5" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu ob nn no np bi translated">最后，他们通过 POST 请求发送数据:</li></ol><pre class="kj kk kl km gt og of oh oi aw oj bi"><span id="0485" class="ok mk it of b gy ol om l on oo">data: {<br/>    action: 'fetch_properties'<br/>}</span><span id="1056" class="ok mk it of b gy op om l on oo">// or</span><span id="db77" class="ok mk it of b gy op om l on oo">data: {<br/>    action: 'fetch_brokers'<br/>}</span></pre><ul class=""><li id="aa14" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">让我们继续前进，因为我还没有完全到达那里；我还需要找到<code class="fe oc od oe of b">ajaxUrl</code>。如果我在同一个<em class="mf"> properties.js </em>文件中搜索“ajaxUrl ”,我会发现:</li></ul><pre class="kj kk kl km gt og of oh oi aw oj bi"><span id="6648" class="ok mk it of b gy ol om l on oo">const ajaxUrl = wp.wpurl + ‘/wp-admin/admin-ajax.php’;</span></pre><ul class=""><li id="13eb" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">我们越来越近了！我的猜测是 wp.wpurl 只是主机名:<code class="fe oc od oe of b">duwestrealty.com</code>但是让我们确认一下。我将在 DOM 中搜索该变量:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/1faf51acad2a6145d5a26d94be5659fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uaiLeIJY9ndAEnVHVNLJmQ.png"/></div></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or oa l"/></div></figure><ul class=""><li id="4402" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">现在，就像用我们在<code class="fe oc od oe of b">properties.js</code>文件中找到的所需有效负载发出 POST 请求一样简单。</li></ul><pre class="kj kk kl km gt og of oh oi aw oj bi"><span id="82d3" class="ok mk it of b gy ol om l on oo">import requests</span><span id="3c82" class="ok mk it of b gy op om l on oo">r = requests.post(<br/>    "<a class="ae ky" href="https://duwestrealty.com/wp-admin/admin-ajax.php" rel="noopener ugc nofollow" target="_blank">https://duwestrealty.com/wp-admin/admin-ajax.php</a>",<br/>    data={'action': 'fetch_properties'}<br/>)<br/>data = r.json()<br/>type(data)<br/>len(data)<br/>data[0].keys()</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><pre class="og of oh oi aw oj bi"><span id="ea42" class="ok mk it of b gy os ot ou ov ow om l on oo">&lt;class 'list'&gt;<br/>185<br/>dict_keys(['id', 'postid', 'address', 'city', 'state', 'zipcode', 'categories', 'sf', 'gla', 'caprate', 'price', 'description', 'brokers', 'pdf', 'image', 'logo', 'video', 'locationmap', 'title'])</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="3dc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，回到我手头的任务。我需要检索大约 100 个其他类似网站的数据。从代码的角度来看，再考虑一下 DRY 原则，利用上面的方法比为每个站点开发不同的抓取解决方案要容易得多。我可以很容易地使每个请求适应适当的站点:修改 HTTP 请求方法(GET、POST)、发送到服务器的数据、查询参数和响应处理。如果你已经读到这里，这里是我想到的解决方案:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="ae7e" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">更多信息</h1><ul class=""><li id="770e" class="nh ni it lb b lc nb lf nc li ox lm oy lq oz lu nm nn no np bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/the-alternative-to-web-scraping-8d530ae705ca">第 1 部分:网页抓取的替代方案</a></li><li id="b0ec" class="nh ni it lb b lc nt lf nu li nv lm nw lq nx lu nm nn no np bi translated">如果您有任何问题或意见，请联系我们。</li></ul></div></div>    
</body>
</html>