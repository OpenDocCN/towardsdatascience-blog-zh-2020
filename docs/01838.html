<html>
<head>
<title>Protect your Infrastructure with Real-time Notifications of AWS Console User Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS控制台用户更改的实时通知来保护您的基础架构</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/protect-your-infrastructure-with-real-time-notifications-of-aws-console-user-changes-3144fd18c680?source=collection_archive---------15-----------------------#2020-02-20">https://towardsdatascience.com/protect-your-infrastructure-with-real-time-notifications-of-aws-console-user-changes-3144fd18c680?source=collection_archive---------15-----------------------#2020-02-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/110da1d536f63220dd42e5800b7a5bac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*0OxbHBLx_M6ujVqIV9yNyA.png"/></div></div></figure><p id="0620" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您已经接受了基础设施即代码(IoC ),并煞费苦心地创建了Terraform或CloudFormation来建模您的EC2实例、自动扩展组、ECS集群和其他一切。devops和开发团队承诺只使用您选择的IoC工具来修改和创建基础设施——但是，令人惊讶的是，有些人就是不遵守。也许有人在特性开发过程中偷懒，或者在事件响应过程中走捷径。也许你已经外包了你的一级支持，但你还没有完全信任那个团队。无论是什么原因，您都想知道用户何时登录AWS控制台网站并手动更改内容。</p><p id="2a07" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">围绕这个话题的担忧是有可信的理由的。环境漂移是一个术语，通常用来描述期望状态(在您的基础设施中用代码表示)和您的基础设施的实际、实时状态之间的差异。这种漂移最终会导致部署失败、影响客户的扩展问题、安全漏洞，或者最糟糕的是数据泄露。</p><p id="7836" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我们将构建一个系统来监控您的AWS基础设施，并在用户直接从AWS控制台做出更改时发送通知。我们将利用CloudTrail来记录事件，并将其写入S3。S3触发器将调用Lamba函数。该功能将过滤事件，并将相关事件发布到您的团队可以订阅的SNS主题中。如果这听起来很吓人，不要担心；AWS完成了繁重的工作，我们只需要连接各个部分。下面详细介绍了每个步骤，让我们开始吧。</p><h1 id="07f1" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">启用CloudTrail</h1><p id="a639" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">CloudTrail是这个项目中关键的AWS服务。您也许可以用功能等同的组件替换其他组件，但是CloudTrail会监控整个AWS帐户的变化，并将数据发布到S3的日志文件中。</p><p id="24a5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">CloudTrail通常用于安全调查、合规性和审计目的。您可以使用它的web界面来搜索它记录的事件。需要知道是谁启动了那个闲置的昂贵实例吗？查看CloudTrail日志。追踪谁修改了启动配置以找出原因？云迹。CloudTrail的基本搜索功能就在它的AWS web界面上，您还可以使用AWS Athena对事件日志执行SQL风格的查询。</p><p id="a03e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，CloudTrail会在您的帐户中保留过去90天活动的事件日志。但是这些日志在S3是无法获取的；为此，我们需要创建一个新的线索。AWS允许为<a class="ae mc" href="https://aws.amazon.com/cloudtrail/pricing/" rel="noopener ugc nofollow" target="_blank">免费</a>创建一个管理事件的踪迹。</p><p id="4c3d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">导航到CloudTrail控制台并选择“创建轨迹”提供一个名称，并为事件过滤器选择“只写”,因为这是我们唯一感兴趣的。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi md"><img src="../Images/66b338a10fab7ff66a261db827735eb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V0hzIMgmHK6llOUiID6ZvQ.png"/></div></div></figure><p id="5c55" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">向下滚动到存储位置部分，选择或创建一个S3存储桶来存储您的日志。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/3d6919bb62f115281881c37654b280e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Ux7BAP1ggsfOEyeEMvMng.png"/></div></div></figure><p id="2b12" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，为了测试这一点，继续在您的AWS环境中进行一些更改——启动一个t.2微实例，创建一个空的Lambda函数，任何事情都可以。然后看看应该包含我们的CloudTrail日志的S3桶:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mj"><img src="../Images/5299c43754a642c5ec2cd049be118497.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HSZckWzNwGRR4XLRU2aBPA.png"/></div></div></figure><p id="3a31" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您从这个bucket下载一个日志文件，您将看到一个事件数组(“记录”)。每个事件都有大量的元数据——下面是一个示例事件(简称),它是在启动一个新的EC2实例时生成的:</p><h1 id="6ec0" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建一个Lambda来处理CloudTrail日志</h1><p id="1ad4" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">既然对AWS基础设施的每次修改都记录到了S3，我们需要编写一个函数来解析数据。我们将在Lambda中这样做，因为它是无服务器的，这符合我们只在记录新事件时调用函数的需求。</p><p id="d75a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">导航到Lambda控制台并创建一个新函数。选择空函数和Python 3.8作为运行时环境。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mk"><img src="../Images/b607dd0f22d1dc445e636e312930dcb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y6JaD9u-cDgv9seT8xN2UA.png"/></div></div></figure><p id="d8be" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该功能需要从S3读取和向SNS发布通知的权限。选择“从AWS策略模板创建新角色”，并从策略模板下拉列表中选择“S3对象只读”和“SNS发布”。为您的角色提供一个名称，然后选择创建功能。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ml"><img src="../Images/37e646da204c25234ace84b838f43271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JU742bsfkGQcz11Uo9PDZw.png"/></div></div></figure><p id="3554" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建函数后，向下滚动找到内联代码编辑器和一个非常基本的Python函数。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mm"><img src="../Images/3aa3edbbe80910963b7f283915bf7013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9CfqhxwrX9j31sFuW8qQ5g.png"/></div></div></figure><p id="c700" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">继续复制下面的所有代码，并将其粘贴到编辑器中，替换所有现有的代码:</p><figure class="me mf mg mh gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="6151" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们回顾一下代码。向下滚动找到<strong class="kd iu">lambda _ handler</strong>——这是我们应用程序的入口点。因为Lambda是由S3触发器调用的，所以参数“event”包含S3事件的列表。每个事件都包含一个对象的键，该对象是在我们的CloudTrail日志写入的S3桶中创建的。我们遍历列表，对于每个事件，我们从S3下载指定的文件并解压。</p><p id="0219" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在每个文件中，我们都有一个JSON格式的CloudTrail事件列表。我们不希望每个CloudTrail事件都被通知；这个练习的目的是只捕捉用户通过AWS控制台触发的事件。Amazon没有提供一种简单的方法来区分手动用户更改和由SDK或命令行调用的用户更改。Arkadiy Tetelma写了一个很棒的博客<a class="ae mc" href="https://arkadiyt.com/2019/11/12/detecting-manual-aws-console-actions/" rel="noopener ugc nofollow" target="_blank">在这里</a>，他在其中致力于解决同样的问题。我们将按照Arkadiy在Lamda中描述的方式过滤CloudTrail事件。</p><p id="5e81" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了执行过滤器，我们使用Python list comprehension对日志中的每个项目运行<strong class="kd iu"> filter_user_events </strong>，并创建仅包含匹配项的<em class="mp"> output_dict </em>。</p><p id="884d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> filter_user_events </strong>函数根据我们指定的过滤器检查事件中的相关字段。首先，它查看<em class="mp">用户代理</em>，并尝试匹配一系列模仿AWS控制台URL的正则表达式。然后，它筛选只读事件，如以“Get”或“Describe”开头的事件。第三项检查是针对一组我们忽略的特定事件名(比如AWS控制台登录。)最后检查事件是否由“AWS内部”调用</p><p id="fe70" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们得到感兴趣的事件子集后，我们想要发送实际的通知。我们将使用亚马逊的简单通知服务(SNS)，这是一个非常简单的服务，允许您创建一个主题，然后发布/订阅它。发布到SNS主题的代码在我们的sns_publish函数中，有两个包装器方法(<strong class="kd iu"> post_to_sns </strong>只发布用户名和eventName，而post_to_sns_details发布整个JSON事件。)</p><p id="99d8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意这里引用的sns_arn变量，它是在文件顶部附近定义的；您需要将它替换为您想要发布到的SNS主题的ARN。单击屏幕右上角附近的save，用您粘贴的代码更新您的Lambda函数；此更改将立即生效。然后导航到AWS控制台的SNS部分，选择主题，并创建主题。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/6129415ff953ba1a01db843dbb604f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XrL43dWTaEzpQhdT4xI5uQ.png"/></div></div></figure><p id="7308" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">适当地命名主题，并对所有其他部分使用默认设置。或者，您可以编辑访问策略设置；默认策略是只允许主题所有者发布和订阅该主题。对于本演示来说，这很好，但是如果您想在一个更大的组织中使用它，您需要根据自己的喜好来定制策略。选择“创建主题”以完成设置过程。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/51b69f385ec47cb0eff78f6fe07f8d4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMsLX8T2Ro5mvM8qqKDbZA.png"/></div></div></figure><p id="807b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个屏幕上，你可以复制你的主题的ARN，然后返回Lambda来更新代码(替换变量<em class="mp"> sns_arn </em>的值)。)您还会注意到这个主题没有订阅；选择“创建订阅”，选择电子邮件作为协议，输入您的电子邮件地址，然后再次选择“创建订阅”。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/640ed98901d54e5fd01086b11d20b203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pSQzwIOVqpzDKvAHjs4o1Q.png"/></div></div></figure><p id="5675" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请务必检查您的电子邮件并确认订阅，否则您将不会收到任何发布到该主题的消息。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/d2d9e6fb72006a0209c2ae1b93e13a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GYDSIcBK8Jw1Nc7Jj3382Q.png"/></div></div></figure><h1 id="da0d" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">在S3事件上触发Lambda</h1><p id="3bf6" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">所以，快速回顾一下。启用了CloudTrail日志记录，存在一个SNS主题并且我们订阅了它，我们的Lambda函数是活动的(并且sns_arn变量被更新。)剩下要做的就是创建触发器，以便每当在S3桶中创建新的CloudTrail日志时调用我们的Lambda函数。</p><p id="00cc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">导航回Lambda控制台，点击您的函数详细信息，并选择靠近设计器窗口顶部的“添加触发器”选项。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/2651afec9726e187d0075adab9fc29ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRPcOGKu2WyAhhd9Pb-xag.png"/></div></div></figure><p id="bd52" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择写入CloudTrail日志的S3存储桶。对于事件类型，选择“所有对象创建事件”,以便每当在存储桶中创建新对象时调用我们的函数。确保选择“启用触发器”以立即激活此触发器，然后单击“添加”</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/842684776189d9133f5165ec6b4e5c2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eia-85grzzN-X-TPT8V5lQ.png"/></div></div></figure><p id="b9b5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建触发器后，您应该会在设计器视图中看到它。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/f9058fba21a6c2c1d44473a03f668cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pk9iDxPuPnSQOgSVmWzNUA.png"/></div></div></figure><h1 id="af8c" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">测试一下</h1><p id="6158" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">现在来测试一下吧！一个简单(且免费)的方法是创建一个新的Lambda函数来触发我们的警报。如果一切正常，在函数创建后不久，您将会收到如下电子邮件:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/a86122d3f9749669060708d47f604397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQ7vzhcJGS48552s7hdmBA.png"/></div></div></figure><p id="5992" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于代码设置为将消息的简短和详细版本发布到SNS，您应该会收到另一封包含完整JSON消息的电子邮件。如果一切正常，您就万事俱备了！请随意更改代码或设置以满足您的需求。如果您对脚本进行了任何改进，请向GitHub repo发送PR。如果有些地方不太对劲，请查看下面的故障排除提示。</p><h1 id="fc85" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">解决纷争</h1><ul class=""><li id="8f99" class="my mz it kd b ke lx ki ly km na kq nb ku nc ky nd ne nf ng bi translated">检查CloudTrail S3桶；是否正在创建日志？</li><li id="e3b8" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">检查Cloudwatch日志中的Lambda函数。每次你期望Lambda被触发时，日志应该存在。在日志中查找写消息。</li><li id="7c69" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">检查Lambda函数的S3触发器；它在监控正确的桶吗？</li><li id="dd03" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">检查分配给Lambda的IAM角色；它有适当的权限从S3读取内容并发布到社交网站吗？</li><li id="22a9" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">Lambda Python代码中的sns_arn变量和你的sns话题匹配吗？</li><li id="1fd4" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">你用你的邮箱地址订阅了SNS话题，并确认订阅了吗？</li><li id="3cc8" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">如果所有这些都失败了，您可以在本地机器上取消注释并运行Python代码中的单元测试。您还可以向代码中添加更广泛的print()日志记录，并查看Cloudwatch日志，以便更好地了解函数执行时发生了什么。</li></ul><h1 id="28ba" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">资源</h1><p id="0fe4" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated"><a class="ae mc" href="https://arkadiyt.com/2019/11/12/detecting-manual-aws-console-actions/" rel="noopener ugc nofollow" target="_blank">检测手动AWS控制台动作— Arkadiy Tetelman </a></p><p id="021c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://github.com/matthew-harper/pyCloudTrailProcesser" rel="noopener ugc nofollow" target="_blank">PyCloudTrailProcessor GitHub Repo</a></p></div></div>    
</body>
</html>