<html>
<head>
<title>Using GBIF data and GeoPandas to plot biodiversity trends</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用 GBIF 数据和 GeoPandas 绘制生物多样性趋势图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-gbif-data-and-geopandas-to-plot-biodiversity-trends-6325ab6632ee?source=collection_archive---------42-----------------------#2020-04-05">https://towardsdatascience.com/using-gbif-data-and-geopandas-to-plot-biodiversity-trends-6325ab6632ee?source=collection_archive---------42-----------------------#2020-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7ab5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">基于 Python 的生物多样性数据热图</h2></div><p id="032b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在<a class="ae le" href="https://medium.com/@wvsharber/introduction-to-gbif-the-global-biodiversity-information-facility-8a0ab65aae34" rel="noopener">的上一篇文章</a>中介绍了 GBIF 以及如何使用 Python 代码通过 API 访问这一优秀的生物多样性数据源，在这篇文章中，我将展示几种不同的方法来绘制之前下载的生物多样性数据。这将是一篇代码量很大的文章，主要使用 GeoPandas，并以复制我在论文中使用的图形而告终。然而，我使用了 R 和 ArcGIS 的组合来创建该图，现在我只使用 Python！希望这将是一个关于 GeoPandas 制图的有用教程，geo pandas 是处理地理空间数据的一个很好的工具！</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="b95a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您对不同地区之间的生物多样性变化感兴趣，地图是可视化空间差异的一种很好的方式。在进化生物学中，知道不同的生物多样性“热点”在哪里，也就是相对高生物多样性的区域，通常是很有趣的。这些热点可以代表高物种形成率的区域，或者如果你正在观察一个单一的生物群体，它们<em class="lm">可能</em>代表它们的起源区域。良好的生物多样性可视化对生物学家非常有用！</p><p id="5b05" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建高质量的地图是复杂的，当我作为一名研究生第一次处理这个问题时，我非常依赖于预先存在的软件和图书馆中非常有用的 GIS 帮助台。现在我有了更多的编程技能，用 Python 重做这个问题真的很有趣。在 Python 中，有一些很好的处理地理空间数据的包。如果你正在处理栅格数据(基于像素的数据)，一定要看看<a class="ae le" href="https://rasterio.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">栅格</a>。不过在这个问题中，我发现使用包<a class="ae le" href="https://geopandas.org/index.html" rel="noopener ugc nofollow" target="_blank"> GeoPandas </a>更容易，它是基于非常有用的 Pandas DataFrame 构建的，但是使用 shapely 库合并了一个几何特性。就像 Pandas 中有数据框和系列一样，GeoPandas 中有地理数据框和地理系列，允许您将其他要素与地理数据相关联。几乎任何可以用熊猫做的事情都可以用地质公园来做。</p><p id="cb0e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">绘制生物多样性地图的一种方法是通过一些现有的地理划界，如国家。这些被称为 choropleth 地图，有一些不同的软件包可以制作它们。这在 GeoPandas 中非常容易，它基于 matplotlib 进行绘图。这是我们首先要做的。</p><p id="f2ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">通过全国范围的物种计数绘制地图(Choropleth 地图)</strong></p><p id="7be3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从物种数据、原产国和地理坐标的数据框架开始，获得每个国家的物种数量是一个简单的聚合函数。我建议在你的数据集中添加一列，使用三个字母的 ISO A3 代码来代表每个国家，这样在以后加入数据框时事情会简单得多。你可以查看我的 GitHub(这篇文章底部的链接)来了解细节。</p><p id="89b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了物种数据框之外，您还需要一个地理数据框作为底图进行绘制。我使用了来自<a class="ae le" href="https://www.naturalearthdata.com/downloads/50m-cultural-vectors/" rel="noopener ugc nofollow" target="_blank"> NaturalEarth </a>的中等分辨率的乡村形状文件。在下面的代码中，我展示了如何合并两个数据帧，然后绘制 choropleth 图(图 1)。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="e86d" class="lw lx it ls b gy ly lz l ma mb">import pandas as pd<br/>import matplotlib.pyplot as plt<br/>import geopandas as gpd</span><span id="2198" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Read back in csv file</em><br/>df = pd.read_csv("../data/Ayenia_cleaned_dataframe.csv")</span><span id="2131" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Create a new dataframe with just number of species per country and #the country code</em><br/>df_plot = pd.DataFrame(df.groupby('country')['species'].nunique().sort_values(ascending=False))</span><span id="2b2c" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Load a country map</em><br/>countries = gpd.read_file("../data/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp", encoding = 'UTF-8')</span><span id="81c9" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Only keep the relevant columns<br/></em>countries = countries[['NAME', 'ISO_A3', 'CONTINENT', 'geometry']]</span><span id="e3fe" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Restrict countries to only North and South America</em><br/>countries = countries[(countries['CONTINENT'] == 'North America') | (countries['CONTINENT'] == 'South America')]</span><span id="62e6" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Join with the species count dataframe</em><br/>countries = countries.merge(df_plot, <br/>                            how = 'outer', <br/>                            left_on = 'ISO_A3', <br/>                            right_on = 'code')</span><span id="afb3" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#Drop the ISO code column we merged on</em><br/>countries.drop('code', axis = 1, inplace = True)</span><span id="fd20" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Fill species count with 0 for countries that weren't in the species #count dataframe</em><br/>countries['species'].fillna(value = 0, inplace = True)</span><span id="54d1" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Drop any remaining NaN (one small island country wasn't in the #basemap file, not a big deal here)</em><br/>countries.dropna(inplace = True)</span><span id="a6e9" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Now plot the choropleth with GeoPandas and matplotlib</em></span><span id="14e8" class="lw lx it ls b gy mc lz l ma mb">fig, ax = plt.subplots(1, 1, figsize= (10, 10))</span><span id="c803" class="lw lx it ls b gy mc lz l ma mb">countries.plot(column='species',<br/>               ax = ax, <br/>               legend = True,<br/>               cmap = 'YlOrRd',<br/>               legend_kwds={'label': "Number of Species", <br/>                            'shrink': 0.5}) </span><span id="c68b" class="lw lx it ls b gy mc lz l ma mb">ax.set_facecolor("lightblue")<br/>plt.xlim((-130, -30))<br/>plt.ylim((-60, 50))<br/>plt.xlabel('Longitude')<br/>plt.ylabel('Latitude')<br/>plt.title(r"Number of $Ayenia$ Species by Country", <br/>          fontdict = {'fontsize': 'x-large'})<br/>plt.tight_layout()</span></pre><figure class="ln lo lp lq gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/a6f867dc023a57cc7f1b6fa5bf03a63a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyl1jsvausPuSnMJAbIEPA.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">图一。每个国家的<em class="mp">叶蝉物种数量分布图。</em></p></figure><p id="ff04" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然 choropleth 显示了物种多样性在 Ayenia 的位置，但它还不够具体。其中一些国家非常大(如巴西、美国)，因此了解这些物种在这些国家的什么地方会更有意思。此外，通过给整个国家着色，地图可能会产生误导。例如，在南美洲的阿根廷，<em class="lm"> Ayenia </em>只限于该国北部地区(零下 30 度以上)，而在美国，<em class="lm"> Ayenia </em>只出现在该国最南部地区。我想更真实地展示这些植物是在哪里发现的。</p><p id="725e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">通过网格单元绘制生物多样性图</strong></p><p id="a346" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于下一张地图，我想计算地图上每 1 个方格中可以找到的物种数量。这将绘制一张更详细的地图，显示艾叶尼亚的生物多样性。为了做到这一点，我必须完成以下步骤:</p><ol class=""><li id="e545" class="mq mr it kk b kl km ko kp kr ms kv mt kz mu ld mv mw mx my bi translated">使用 GeoPandas 将物种数据框中的坐标更改为 shapely 对象</li><li id="56e4" class="mq mr it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated">在我们感兴趣的区域内创建 1 格网像元的地理数据框架</li><li id="648b" class="mq mr it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated">计算每个网格单元内有多少物种</li><li id="5abf" class="mq mr it kk b kl mz ko na kr nb kv nc kz nd ld mv mw mx my bi translated">绘制网格</li></ol><p id="8fcb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是我为每个步骤编写的代码:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="1694" class="lw lx it ls b gy ly lz l ma mb">#<em class="lm">1. Import species data into a GeoDataFrame</em><br/>species_gdf = gpd.GeoDataFrame(df, <br/>              geometry=gpd.points_from_xy(df['decimalLongitude'], <br/>                                          df['decimalLatitude']),  <br/>              crs = "EPSG:4326")</span><span id="1027" class="lw lx it ls b gy mc lz l ma mb"><em class="lm">#2. Create GeoDataFrame with 1 degree grid cells<br/>#Make list of 1 degree grid cells with shapely polygons<br/></em>from shapely.geometry import Polygon</span><span id="0595" class="lw lx it ls b gy mc lz l ma mb">long_range = list(range(-130, -29))<br/>lat_range = list(range(-60, 51))</span><span id="1f5e" class="lw lx it ls b gy mc lz l ma mb">poly_list = []</span><span id="58e3" class="lw lx it ls b gy mc lz l ma mb">for x in long_range:<br/>    for y in lat_range:<br/>        new_poly = Polygon([(x, y), <br/>                            (x + 0.99999, y), <br/>                            (x + 0.99999, y + 0.99999), <br/>                            (x, y + 0.99999)])<br/>        poly_list.append(new_poly)</span><span id="5050" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Make GeoDataFrame from list of polygons, making sure that the #coordinate reference system aligns with your data points DF</em><br/>grid_df_1d = gpd.GeoDataFrame(geometry = poly_list, <br/>                              crs = species_gdf.crs)</span><span id="efac" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Add a column of cell numbers for visualization purposes</em><br/>grid_df_1d['cell_no'] = list(range(0, len(grid_df_1d)))</span></pre><p id="5ce2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此时，我们有了一个包含感兴趣范围内非重叠 1 格网单元的地理数据框架(图 2)。您可以轻松地修改此代码，使其具有更小或更大的网格单元大小(比如 0.5 或 10)，并根据您的需要覆盖更大或更小范围的地球部分。我建议让它尽可能的小，因为这下一步不是很有效率，在我的笔记本电脑上运行需要 30 多分钟。</p><figure class="ln lo lp lq gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ne"><img src="../Images/42282c149b936256cce36e24b466acb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jsxxLVeUVWbkEV-ikMja9Q.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">图二。研究区域内 1 格网单元的范围。为了说明的目的，示出了单元号。</p></figure><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="c8eb" class="lw lx it ls b gy ly lz l ma mb">#<em class="lm">3. Calculate the number of species in each grid cell<br/></em>#<em class="lm">Make a dictionary to store a list of each grid cell's species</em></span><span id="08d4" class="lw lx it ls b gy mc lz l ma mb">grid_species = {}</span><span id="85ab" class="lw lx it ls b gy mc lz l ma mb">for x in list(range(0, len(grid_df_1d))):<br/>    grid_species[f'{x}'] = []</span><span id="2d04" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">For each species in the species dataframe, determine whether or not #it's within the bounds of the polygons in the grid dataframe. If it #is, add that species to the list in the grid_species dict (This step is very slow and inefficient! Does anyone know of a better way??)</em></span><span id="26b4" class="lw lx it ls b gy mc lz l ma mb">for ind_s, val_s in species_gdf.iterrows():<br/>    for ind_g, val_g in grid_df_1d.iterrows(): <br/>        if val_s['geometry'].within(val_g['geometry']):<br/>            grid_species[f"{val_g['cell_no']}"].append(val_s['species'])</span><span id="b4e4" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Now count the number of unique species in each list and save in a #new dictionary and then add data to the grid dataframe</em></span><span id="b896" class="lw lx it ls b gy mc lz l ma mb">import numpy as np<br/>grid_counts = {}</span><span id="4ab8" class="lw lx it ls b gy mc lz l ma mb">for k, v in grid_species.items():<br/>    grid_counts[k] = len(np.unique(v))</span><span id="2279" class="lw lx it ls b gy mc lz l ma mb">grid_df_1d['species_count'] = np.zeros(len(grid_df_1d))<br/>for k, v in grid_counts.items():<br/>    grid_df_1d.loc[int(k) ,'species_count'] = v</span><span id="5bd9" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">Drop cells that don't have any species in them</em><br/>grid_df_1d_nozero = grid_df_1d.drop(grid_df_1d[grid_df_1d['species_count'] == 0].index, axis = 0)</span><span id="600f" class="lw lx it ls b gy mc lz l ma mb">#<em class="lm">4. Plot the grid</em></span><span id="4311" class="lw lx it ls b gy mc lz l ma mb">fig, ax = plt.subplots(1, 1, figsize = (10, 10))<br/>countries.plot(ax = ax, color = 'whitesmoke')<br/>grid_df_1d_nozero.plot(column = 'species_count', <br/>                       ax = ax, <br/>                       legend = True, <br/>                       cmap = 'YlOrRd',<br/>                       legend_kwds={'label': "Number of Species", <br/>                                    'shrink': 0.5})<br/>ax.set_facecolor('lightblue')<br/>plt.xlabel('Longitude')<br/>plt.ylabel('Latitude')<br/>plt.title(r"Biodiversity of $Ayenia$", <br/>          fontdict = {'fontsize': 'x-large'})<br/>plt.xlim((-120, -30))<br/>plt.ylim((-40, 40))<br/>plt.tight_layout()</span></pre><figure class="ln lo lp lq gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nf"><img src="../Images/b1a837e198c821269bbaa4a4fe4c0706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q_t5Ozo4ONK4ydHwGPU8jw.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">图 3。横跨北美和南美的每 1 个网格单元中的叶虫种类数。</p></figure><p id="dcc4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们有了一个更好的表现，可以看出艾叶尼亚在哪里生长，在哪里不生长，哪里有更多的物种，哪里有更少的物种。在图 3 中，你可以看到墨西哥，尤其是墨西哥南部，是 T2 艾尼亚多样性的热点。在巴西南部以及巴拉圭、玻利维亚和阿根廷北部附近地区，还有几个热点。这些地区都有相似的栖息地，包括季节性干燥的热带森林或稀树草原。在巴西和阿根廷的中部有几个网格单元，它们的物种数量非常高，但这些可能不是真实的，因为我们数据中的一些标本具有模糊的位置数据，并且在该国中部给出了 GIS 坐标。以后我得用手移除它们。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="8f61" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望这些代码对学习如何绘制生物多样性地图有用。如果任何人有兴趣将其应用于他们自己的有机体群体，并需要帮助来运行它，我很乐意帮助你！</p><p id="8ebd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://github.com/wvsharber/gbif-occurences" rel="noopener ugc nofollow" target="_blank">这是我在 Jupyter 笔记本上的 GitHub 页面</a>的链接。</p></div></div>    
</body>
</html>