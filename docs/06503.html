<html>
<head>
<title>Improve Your EC2 SSH Workflow Using argparse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用argparse改进您的EC2 SSH工作流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/improve-your-ec2-ssh-workflow-using-argparse-ae831d1de754?source=collection_archive---------36-----------------------#2020-05-23">https://towardsdatascience.com/improve-your-ec2-ssh-workflow-using-argparse-ae831d1de754?source=collection_archive---------36-----------------------#2020-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6bd0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">端口转发、远程jupyter笔记本访问和tmux自动启动</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f08d37b03ec0f4adcd269c7bfae2b731.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ng27eZOm6KgjKv0RVauEGQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@billjelen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">比尔·杰伦</a>在<a class="ae ky" href="https://unsplash.com/s/photos/boost?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="1675" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">动机</h1><p id="fce4" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">数据科学工作通常需要针对巨大数据集使用高级大数据分析技术，以及并行或分布式计算来进行快速模型训练和调整。虽然大多数数据科学工作流(尤其是在探索和开发阶段)都可以在个人的笔记本电脑或台式机上执行，但由于本地开发环境在处理能力、内存和存储方面的限制，完全依赖本地开发环境通常是不切实际或不可能的。</p><p id="592f" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">在这一点上，云计算技术的作用，如亚马逊网络服务的弹性计算云(EC2)所提供的技术，从未像现在这样重要，特别是在将大数据应用大规模部署到生产环境中的情况下。随着此类服务的可用性改变了我们设计和实施DS架构的方式，它也促使数据科学家在其早期开发工作流程中更加依赖云计算的处理和存储能力。</p><p id="b422" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如果你还没有使用过EC2(或任何其他类似的云服务)，这个DataCamp <a class="ae ky" href="https://www.datacamp.com/community/tutorials/aws-ec2-beginner-tutorial" rel="noopener ugc nofollow" target="_blank">教程</a>提供了一个很好的、激励人心的介绍。我每天都使用EC2实例，因为我相信你们中的许多人也一样，所以我想分享一个简单的Python脚本，它包含了一些使用<code class="fe mz na nb nc b">argparse</code>模块来改进EC2 SSH工作流和创建最佳EC2实例环境的巧妙技巧。当您通过SSH建立连接时，该脚本将允许您:</p><ol class=""><li id="0db2" class="nd ne it ma b mb mu me mv mh nf ml ng mp nh mt ni nj nk nl bi translated">每次自动启动<code class="fe mz na nb nc b">tmux</code>。</li><li id="9797" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">在浏览器中本地访问远程运行的<code class="fe mz na nb nc b">jupyter</code>服务器。</li></ol></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="6da0" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">剧本</h1><p id="66c3" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如果你对<code class="fe mz na nb nc b">argparse</code>不熟悉，可以看看这篇温和的<a class="ae ky" href="https://docs.python.org/3/howto/argparse.html" rel="noopener ugc nofollow" target="_blank">介绍</a>或<a class="nr ns ep" href="https://medium.com/u/451599b1142a?source=post_page-----ae831d1de754--------------------------------" rel="noopener" target="_blank">杰夫·黑尔</a>的<a class="ae ky" rel="noopener" target="_blank" href="/learn-enough-python-to-be-useful-argparse-e482e1764e05">学习足够有用的Python:arg parse</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="c158" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">将这个脚本放在您的主目录<code class="fe mz na nb nc b">bin</code>中，例如<code class="fe mz na nb nc b">/Users/jlee/bin</code>。我将我的文件命名为<code class="fe mz na nb nc b">ec2</code>(为了方便起见，没有扩展名<code class="fe mz na nb nc b">.py</code>)。然后，通过运行以下命令将该文件标记为脚本:</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="4d0e" class="nz lh it nc b gy oa ob l oc od">chmod +x ~/bin/ec2</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="cfc0" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">破解密码</h1><h2 id="b59e" class="nz lh it bd li oe of dn lm og oh dp lq mh oi oj ls ml ok ol lu mp om on lw oo bi translated">1.位置参数:会话</h2><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="4d7b" class="nz lh it nc b gy oa ob l oc od"># line 8 above</span><span id="ee18" class="nz lh it nc b gy op ob l oc od">parser.add_argument("session", nargs="?", help="tmux session name")</span></pre><p id="3e3a" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这一行添加了一个位置参数<code class="fe mz na nb nc b">session</code>，它将允许您在每次SSH到远程实例时启动一个新的tmux会话(或者附加到一个现有的会话，如果名称存在的话)。</p><p id="f9d0" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">换句话说，每次你想用一个特定的名字启动一个tmux会话时，不再需要键入/查找tmux cheatsheet来记住<code class="fe mz na nb nc b">tmux new -s new_session</code>。</p><p id="b03e" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如果您将<code class="fe mz na nb nc b">nargs</code>(参数数量)设置为<code class="fe mz na nb nc b">"?"</code>，参数定义将在被解析的命令行上消耗零个<em class="oq">或</em>一个参数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/06b40cfbb97181799473c2206739ea2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZEw3Nibe2lvK3loPWXLgiQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">可变参数列表</p></figure><p id="ab83" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">换句话说，不为<code class="fe mz na nb nc b">session</code>参数传入一个字符串名称将会给你一个选项，连接到你的EC2实例<em class="oq">而不用</em>一个tmux会话。用以下内容扩展原始<code class="fe mz na nb nc b">argv</code>列表(第16-21行):</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="1d39" class="nz lh it nc b gy oa ob l oc od"># lines 24-25</span><span id="5ad7" class="nz lh it nc b gy op ob l oc od">if args.session is not None:<br/>     argv.extend(["-t", "tmux", "-2", "new-session", "-A", "-s", args.session])</span></pre><h2 id="4ce0" class="nz lh it bd li oe of dn lm og oh dp lq mh oi oj ls ml ok ol lu mp om on lw oo bi translated">2.可选参数:jupyter</h2><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="3100" class="nz lh it nc b gy oa ob l oc od"># lines 9</span><span id="539b" class="nz lh it nc b gy op ob l oc od">parser.add_argument('-j', '--jupyter', action='store_true', help='forward port to use remote jupyter')</span></pre><p id="f156" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated"><code class="fe mz na nb nc b">jupyter</code>是一个可选(相对于位置)参数，由前面的<code class="fe mz na nb nc b">-- </code>(或其简称<code class="fe mz na nb nc b">-j</code>)表示。对于可选参数，我们指定了一个新的关键字<code class="fe mz na nb nc b">action</code>。如果我们给它赋值<code class="fe mz na nb nc b">'store_true'</code>，如果指定了选项，它将把值<code class="fe mz na nb nc b">True</code>设置为<code class="fe mz na nb nc b">args.jupyter</code> <em class="oq">。不指定它意味着<code class="fe mz na nb nc b">False</code>。</em></p><p id="cd94" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">因此，在下面的代码中，传递<code class="fe mz na nb nc b">jupyter</code>参数将使您的<code class="fe mz na nb nc b">localhost:8888</code>指向远程服务器的<code class="fe mz na nb nc b">8888</code>端口。因此，当您在EC2实例上运行<code class="fe mz na nb nc b">jupyter notebook</code>时，它会将<em class="oq">的</em>端口<code class="fe mz na nb nc b">8888</code>转发到本地机器的<code class="fe mz na nb nc b">8888</code>端口<em class="oq">，从而允许您从本地浏览器访问远程jupyter笔记本。</em></p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="ea7b" class="nz lh it nc b gy oa ob l oc od"># lines 22-23</span><span id="6eb8" class="nz lh it nc b gy op ob l oc od">if args.jupyter:<br/>  argv.extend(["-L", "8888:localhost:8888"])</span></pre><p id="a987" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">现在，如果您从命令行运行<code class="fe mz na nb nc b">jupyter notebook</code>,它会显示如下内容:</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="391b" class="nz lh it nc b gy oa ob l oc od">Copy/paste this URL into your browser when you connect for the first time,<br/>    to login with a token:<br/>        <a class="ae ky" href="http://localhost:8888/?token=a7213f1213c009f4c7a6c2eddd2fded65d538e5b9ae37876&amp;token=a7213f1213c009f4c7a6c2eddd2fded65d538e5b9ae37876" rel="noopener ugc nofollow" target="_blank">http://localhost:8888/?token=a2bc3def5g41234ed56s78zxfxc3vdfb&amp;token=a2bc3def5g41234ed56s78zxfxc3vdfb</a></span></pre><p id="f686" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">只需将令牌URL复制并粘贴到您的本地浏览器中，您就可以立即访问您的远程Jupyter笔记本。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="8595" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">收尾</h1><p id="79ab" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如果您想要定制您的tmux，在您的主目录中创建一个名为<code class="fe mz na nb nc b">.tmux.conf</code>的配置文件。这是一个隐藏文件，所以你不会看到它，如果你<code class="fe mz na nb nc b">ls ~</code>)，但<code class="fe mz na nb nc b">tmux</code>将选择这个文件为当前用户。</p><p id="680e" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">将这几行添加到文件中，看看您对tmux的新外观有多喜欢:</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="73ac" class="nz lh it nc b gy oa ob l oc od"># <!-- -->~/.tmux.conf</span><span id="dfde" class="nz lh it nc b gy op ob l oc od">set-window-option -g window-status-format " [#I] #W "<br/>set-window-option -g window-status-current-format " [#I] #W "<br/>set-window-option -g window-status-current-style fg=colour240,bold,bg=colour247<br/>set -g default-terminal "screen-256color"</span></pre><p id="5971" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">结果是tmux状态栏在终端底部以灰色显示当前窗口，与会话中的其他窗口(绿色)相区别:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/dab657d846203795b9db19cd9371f069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*08jvuquPvDGmTEqalBEKEw.png"/></div></figure><p id="640d" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">查看这个<a class="ae ky" href="https://www.hamvocke.com/blog/a-guide-to-customizing-your-tmux-conf/" rel="noopener ugc nofollow" target="_blank">网站</a>获得更多tmux定制选项。</p><p id="8292" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">最后，这里有一些有用的键盘快捷键:</p><ol class=""><li id="5476" class="nd ne it ma b mb mu me mv mh nf ml ng mp nh mt ni nj nk nl bi translated">在当前会话中创建一个新窗口:<code class="fe mz na nb nc b">Ctrl+b</code>，然后是<code class="fe mz na nb nc b">c</code></li><li id="3d15" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">转到会话中的下一个窗口:<code class="fe mz na nb nc b">Ctrl+b</code>，然后是<code class="fe mz na nb nc b">n</code></li><li id="d622" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">转到会话中的上一个窗口:<code class="fe mz na nb nc b">Ctrl+b</code>，然后是<code class="fe mz na nb nc b">p</code></li><li id="6df9" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">从当前会话中分离:<code class="fe mz na nb nc b">Ctrl+b</code>，后跟<code class="fe mz na nb nc b">d</code></li></ol></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="347c" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">命令示例</h1><p id="d65c" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">综上所述，您现在可以尝试使用这些示例命令之一运行<code class="fe mz na nb nc b">ec2</code>脚本，每个命令都将创建一个SSH连接，但是结果略有不同:</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="011b" class="nz lh it nc b gy oa ob l oc od">(1) ec2 new_sesh -j<br/>(2) ec2 -j<br/>(3) ec2 new_sesh2</span></pre><p id="02e6" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">(1)将在SSH上创建(或附加到)一个名为<code class="fe mz na nb nc b">new_sesh</code>的tmux会话，结果是当您调用jupyter notebook时，它会将您的远程服务器的端口8888转发到您的本地机器的端口8888。</p><p id="3590" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">(2)将使用端口转发将您SSH到您的EC2实例中，但不会启动tmux(因为您没有为<code class="fe mz na nb nc b">session</code>提供名称)。</p><p id="f998" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">(3)将创建(或附加到)一个名为<code class="fe mz na nb nc b">new_sesh2</code>的tmux会话，但没有端口转发(即，您将无法从本地浏览器访问远程jupyter笔记本)。</p><p id="7760" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">最后，当然可以使用bash别名来达到(1)-(3)的效果。例如，将下面一行添加到您的<code class="fe mz na nb nc b">.bashrc</code>或<code class="fe mz na nb nc b">.bash_profile</code>脚本并运行<code class="fe mz na nb nc b">ssh-jlee</code>将启动一个名为<code class="fe mz na nb nc b">default</code>的tmux会话，并开始通过SSH连接进行<code class="fe mz na nb nc b">8888</code> → <code class="fe mz na nb nc b">8888</code>端口转发:</p><pre class="kj kk kl km gt nv nc nw nx aw ny bi"><span id="c0f5" class="nz lh it nc b gy oa ob l oc od">alias ssh-jlee='ssh -i ~/.ssh/mykey.pem ubuntu@10.999.9.999 -L 8888:localhost:8888 tmux new-session -A -s default'</span></pre><p id="a5cf" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">然而，我认为使用<code class="fe mz na nb nc b">argparse.ArgumentParse</code>创建一个解析器对象并传递一系列字符串作为命令行参数，比使用多个硬编码(1)-(3)中所有变量行为的bash别名更灵活、透明、可控。</p></div></div>    
</body>
</html>