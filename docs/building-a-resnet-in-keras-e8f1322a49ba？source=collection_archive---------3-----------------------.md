# åœ¨å–€æ‹‰æ–¯å»ºç«‹ä¸€ä¸ª ResNet

> åŸæ–‡ï¼š<https://towardsdatascience.com/building-a-resnet-in-keras-e8f1322a49ba?source=collection_archive---------3----------------------->

## åˆ©ç”¨ Keras å‡½æ•° API æ„é€ æ®‹å·®ç¥ç»ç½‘ç»œ

![](img/3048680a82c58944d10872bbd3027553.png)

# ä»€ä¹ˆæ˜¯æ®‹å·®ç¥ç»ç½‘ç»œï¼Ÿ

åŸåˆ™ä¸Šï¼Œç¥ç»ç½‘ç»œåº”è¯¥å¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œå› ä¸ºå®ƒä»¬æœ‰æ›´å¤šçš„å±‚ã€‚ä¸€ä¸ªæ›´æ·±å±‚æ¬¡çš„ç½‘ç»œå¯ä»¥å­¦åˆ°æ¯”å®ƒæ›´æµ…å±‚æ¬¡çš„ç½‘ç»œæ‰€èƒ½å­¦åˆ°çš„ä»»ä½•ä¸œè¥¿ï¼Œè€Œä¸”(å¯èƒ½)ä¸æ­¢è¿™äº›ã€‚å¯¹äºç»™å®šçš„æ•°æ®é›†ï¼Œå¦‚æœç½‘ç»œæ— æ³•é€šè¿‡å‘å…¶æ·»åŠ æ›´å¤šå›¾å±‚æ¥äº†è§£æ›´å¤šä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒåªéœ€äº†è§£è¿™äº›é™„åŠ å›¾å±‚çš„èº«ä»½æ˜ å°„ã€‚è¿™æ ·ï¼Œå®ƒä¿ç•™äº†å‰å‡ å±‚çš„ä¿¡æ¯ï¼Œä¸ä¼šæ¯”æ›´æµ…çš„å±‚å·®ã€‚å¦‚æœæ‰¾ä¸åˆ°æ¯”è¿™æ›´å¥½çš„ä¸œè¥¿ï¼Œç½‘ç»œè‡³å°‘åº”è¯¥èƒ½å¤Ÿå­¦ä¹ èº«ä»½æ˜ å°„ã€‚

ä½†å®é™…ä¸Šï¼Œäº‹æƒ…å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚æ›´æ·±çš„ç½‘ç»œæ›´éš¾ä¼˜åŒ–ã€‚ç½‘ç»œæ¯å¢åŠ ä¸€å±‚ï¼Œè®­ç»ƒçš„éš¾åº¦å°±ä¼šå¢åŠ ï¼›æˆ‘ä»¬ç”¨æ¥å¯»æ‰¾æ­£ç¡®å‚æ•°çš„ä¼˜åŒ–ç®—æ³•å˜å¾—æ›´åŠ å›°éš¾ã€‚éšç€æˆ‘ä»¬æ·»åŠ æ›´å¤šçš„å±‚ï¼Œç½‘ç»œå¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œç›´åˆ°æŸä¸€ç‚¹ï¼›ç„¶åï¼Œéšç€æˆ‘ä»¬ç»§ç»­æ·»åŠ é¢å¤–çš„å±‚ï¼Œç²¾åº¦å¼€å§‹ä¸‹é™ã€‚

æ®‹ä½™ç½‘ç»œè¯•å›¾é€šè¿‡å¢åŠ æ‰€è°“çš„*è·³è·ƒè¿æ¥*æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸Šå›¾ä¸­æç»˜äº†ä¸€ä¸ªè·³è¿‡è¿æ¥ã€‚æ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´ï¼Œæ›´æ·±å±‚æ¬¡çš„ç½‘ç»œè‡³å°‘åº”è¯¥èƒ½å¤Ÿå­¦ä¹ èº«ä»½æ˜ å°„ï¼›è¿™å°±æ˜¯ skip è¿æ¥æ‰€åšçš„:å®ƒä»¬æ·»åŠ ä»ç½‘ç»œä¸­çš„ä¸€ä¸ªç‚¹åˆ°ä¸€ä¸ªè½¬å‘ç‚¹çš„èº«ä»½æ˜ å°„ï¼Œç„¶åè®©ç½‘ç»œå­¦ä¹ é¢å¤–çš„ğ¹(ğ‘¥).å¦‚æœç½‘ç»œæ²¡æœ‰æ›´å¤šå¯ä»¥å­¦ä¹ çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå®ƒå°±å°†ğ¹(ğ‘¥å­¦ä¹ ä¸º 0ã€‚åŸæ¥ç½‘ç»œæ¯”èº«ä»½æ˜ å°„æ›´å®¹æ˜“å­¦ä¹ åˆ°æ›´æ¥è¿‘ 0 çš„æ˜ å°„ã€‚

å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å…·æœ‰è·³è·ƒè¿æ¥çš„å—è¢«ç§°ä¸º*æ®‹å·®å—*ï¼Œæ®‹å·®ç¥ç»ç½‘ç»œ(ResNet)å°±æ˜¯è¿™äº›å—çš„ä¸²è”ã€‚

ä¸€ä¸ªæœ‰è¶£çš„äº‹å®æ˜¯ï¼Œæˆ‘ä»¬çš„å¤§è„‘å…·æœ‰ç±»ä¼¼äºæ®‹ä½™ç½‘ç»œçš„ç»“æ„ï¼Œä¾‹å¦‚ï¼Œçš®å±‚ç¬¬å…­å±‚ç¥ç»å…ƒä»ç¬¬ä¸€å±‚è·å¾—è¾“å…¥ï¼Œè·³è¿‡ä¸­é—´å±‚ã€‚

# Keras å‡½æ•°å¼ API ç®€ä»‹

å¦‚æœä½ æ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯èƒ½å·²ç»ç†Ÿæ‚‰äº†é¡ºåºç±»ï¼Œå®ƒå…è®¸ä½ é€šè¿‡ä¸€å±‚ä¸€å±‚åœ°å †å æ¥è½»æ¾åœ°æ„å»ºç¥ç»ç½‘ç»œï¼Œå°±åƒè¿™æ ·:

```
**from** keras.models **import** Sequential
**from** keras.layers **import** Dense, Activation

model **=** Sequential([
    Dense(32, input_shape**=**(784,)),
    Activation('relu'),
    Dense(10),
    Activation('softmax'),
])
```

ä½†æ˜¯è¿™ç§å»ºç«‹ç¥ç»ç½‘ç»œçš„æ–¹å¼ä¸è¶³ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚å¯¹äºé¡ºåºç±»ï¼Œæˆ‘ä»¬ä¸èƒ½æ·»åŠ è·³è¿‡è¿æ¥ã€‚Keras ä¹Ÿæœ‰ Model ç±»ï¼Œå®ƒå¯ä»¥å’Œ functional API ä¸€èµ·ä½¿ç”¨æ¥åˆ›å»ºå±‚ï¼Œä»¥æ„å»ºæ›´å¤æ‚çš„ç½‘ç»œæ¶æ„ã€‚
æ„é€ æ—¶ï¼Œç±»`keras.layers.Input`è¿”å›ä¸€ä¸ªå¼ é‡å¯¹è±¡ã€‚Keras ä¸­çš„å±‚å¯¹è±¡ä¹Ÿå¯ä»¥åƒå‡½æ•°ä¸€æ ·ä½¿ç”¨ï¼Œç”¨å¼ é‡å¯¹è±¡ä½œä¸ºå‚æ•°è°ƒç”¨å®ƒã€‚è¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¼ é‡ï¼Œç„¶åå¯ä»¥ä½œä¸ºè¾“å…¥ä¼ é€’ç»™å¦ä¸€ä¸ªå±‚ï¼Œä¾æ­¤ç±»æ¨ã€‚

ä¸¾ä¸ªä¾‹å­:

```
**from** keras.layers **import** Input, Dense
**from** keras.models **import** Model

inputs **=** Input(shape**=**(784,))
output_1 **=** Dense(64, activation**=**'relu')(inputs)
output_2 **=** Dense(64, activation**=**'relu')(output_1)
predictions **=** Dense(10, activation**=**'softmax')(output_2)

model **=** Model(inputs**=**inputs, outputs**=**predictions)
model.compile(optimizer**=**'adam',
              loss**=**'categorical_crossentropy',
              metrics**=**['accuracy'])
model.fit(data, labels)
```

ä½†æ˜¯ä¸Šé¢çš„ä»£ç ä»ç„¶æ„å»ºäº†ä¸€ä¸ªæœ‰åºçš„ç½‘ç»œï¼Œæ‰€ä»¥åˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰çœŸæ­£ä½¿ç”¨è¿™ç§å¥‡ç‰¹çš„å‡½æ•°è¯­æ³•ã€‚è¿™ç§è¯­æ³•çš„çœŸæ­£ç”¨é€”æ˜¯åœ¨ä½¿ç”¨æ‰€è°“çš„*åˆå¹¶å±‚*æ—¶ï¼Œé€šè¿‡å®ƒå¯ä»¥åˆå¹¶æ›´å¤šçš„è¾“å…¥å¼ é‡ã€‚è¿™äº›å±‚çš„å‡ ä¸ªä¾‹å­æ˜¯:`Add`ã€`Subtract`ã€`Multiply`ã€`Average`ã€‚æˆ‘ä»¬åœ¨å»ºé€ å‰©ä½™çš„ç§¯æœ¨æ—¶éœ€è¦çš„æ˜¯`Add`ã€‚

ä½¿ç”¨`Add`çš„ä¾‹å­:

```
**from** keras.layers **import** Input, Dense, Add
**from** keras.models **import** Model

input1 **=** Input(shape**=**(16,))
x1 **=** Dense(8, activation**=**'relu')(input1)
input2 **=** Input(shape**=**(32,))
x2 **=** Dense(8, activation**=**'relu')(input2)

added **=** Add()([x1, x2])

out **=** Dense(4)(added)
model **=** Model(inputs**=**[input1, input2], outputs**=**out)
```

è¿™ç»ä¸æ˜¯å¯¹ Keras functional API çš„å…¨é¢æŒ‡å¯¼ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œè¯·å‚è€ƒ[æ–‡ä»¶](https://keras.io/getting-started/functional-api-guide/)ã€‚

# è®©æˆ‘ä»¬å®ç°ä¸€ä¸ª ResNet

æ¥ä¸‹æ¥ï¼Œä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ª ResNet å’Œå®ƒçš„æ™®é€š(æ²¡æœ‰è·³è¿‡è¿æ¥)å¯¹åº”ç‰©ã€‚

æˆ‘ä»¬å°†åœ¨è¿™é‡Œæ„å»ºçš„ ResNet å…·æœ‰ä»¥ä¸‹ç»“æ„:

*   å½¢çŠ¶è¾“å…¥(32ï¼Œ32ï¼Œ3)
*   1 ä¸ª Conv2D å±‚ï¼Œå¸¦ 64 ä¸ªæ»¤æ³¢å™¨
*   å…·æœ‰ 64ã€128ã€256 å’Œ 512 ä¸ªæ»¤æ³¢å™¨çš„ 2ã€5ã€5ã€2 ä¸ªæ®‹å·®å—
*   å¹³å‡æ±  2D å±‚ï¼Œæ± å¤§å°= 4
*   å±•å¹³å›¾å±‚
*   å…·æœ‰ 10 ä¸ªè¾“å‡ºèŠ‚ç‚¹çš„å¯†é›†å±‚

å®ƒæ€»å…±æœ‰ 30 ä¸ª conv+è‡´å¯†å±‚ã€‚æ‰€æœ‰å†…æ ¸å¤§å°éƒ½æ˜¯ 3x3ã€‚æˆ‘ä»¬åœ¨ conv å±‚ä¹‹åä½¿ç”¨ ReLU æ¿€æ´»å’Œæ‰¹å¤„ç†è§„èŒƒåŒ–ã€‚
é™¤äº†è·³è¿‡è¿æ¥å¤–ï¼Œæ™®é€šç‰ˆæœ¬æ˜¯ç›¸åŒçš„ã€‚

æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œå®ƒå°†ä¸€ä¸ªå¼ é‡ä½œä¸ºè¾“å…¥ï¼Œå¹¶å‘å…¶æ·»åŠ  relu å’Œæ‰¹é‡å½’ä¸€åŒ–:

```
**def** relu_bn(inputs: Tensor) **->** Tensor:
    relu **=** ReLU()(inputs)
    bn **=** BatchNormalization()(relu)
    **return** bn
```

ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥æ„é€ ä¸€ä¸ªæ®‹å·®å—ã€‚å®ƒæ¥å—ä¸€ä¸ªå¼ é‡`x`ä½œä¸ºè¾“å…¥ï¼Œå¹¶é€šè¿‡ 2 ä¸ª conv å±‚ï¼›è®©æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ª conv å±‚çš„è¾“å‡ºç§°ä¸º`y`ã€‚ç„¶åæŠŠè¾“å…¥çš„`x`åŠ åˆ°`y`ï¼ŒåŠ ä¸Š relu å’Œæ‰¹é‡å½’ä¸€åŒ–ï¼Œç„¶åè¿”å›ç»“æœå¼ é‡ã€‚å½“å‚æ•°ä¸º`downsample == True`æ—¶ï¼Œç¬¬ä¸€ä¸ª conv å±‚ä½¿ç”¨`strides=2`å°†è¾“å‡ºå¤§å°å‡åŠï¼Œæˆ‘ä»¬ä½¿ç”¨è¾“å…¥ä¸º`x`çš„`kernel_size=1`çš„ conv å±‚ï¼Œä½¿å…¶å½¢çŠ¶ä¸`y`ç›¸åŒã€‚`Add`å±‚è¦æ±‚è¾“å…¥å¼ é‡å…·æœ‰ç›¸åŒçš„å½¢çŠ¶ã€‚

```
**def** residual_block(x: Tensor, downsample: bool, filters: int,                                        kernel_size: int **=** 3) **->** Tensor:
    y **=** Conv2D(kernel_size**=**kernel_size,
               strides**=** (1 **if** **not** downsample **else** 2),
               filters**=**filters,
               padding**=**"same")(x)
    y **=** relu_bn(y)
    y **=** Conv2D(kernel_size**=**kernel_size,
               strides**=**1,
               filters**=**filters,
               padding**=**"same")(y)

    **if** downsample:
        x **=** Conv2D(kernel_size**=**1,
                   strides**=**2,
                   filters**=**filters,
                   padding**=**"same")(x)
    out **=** Add()([x, y])
    out **=** relu_bn(out)
    **return** out
```

`create_res_net()`å‡½æ•°æŠŠæ‰€æœ‰ä¸œè¥¿æ”¾åœ¨ä¸€èµ·ã€‚ä»¥ä¸‹æ˜¯è¿™æ–¹é¢çš„å®Œæ•´ä»£ç :

ç®€å•ç½‘ç»œä»¥ç±»ä¼¼çš„æ–¹å¼æ„å»ºï¼Œä½†æ˜¯å®ƒæ²¡æœ‰è·³è·ƒè¿æ¥ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä½¿ç”¨`residual_block()`åŠ©æ‰‹å‡½æ•°ï¼›ä¸€åˆ‡éƒ½åœ¨`create_plain_net()`é‡Œé¢å®Œæˆã€‚
å¹³åŸç½‘ç»œçš„ä»£ç :

# åœ¨ CIFAR-10 ä¸Šè¿›è¡ŒåŸ¹è®­å¹¶æŸ¥çœ‹ç»“æœ

CIFAR-10 æ˜¯ä¸€ä¸ªåŒ…å« 10 ä¸ªç±»åˆ«çš„ 32x32 rgb å›¾åƒçš„æ•°æ®é›†ã€‚å®ƒåŒ…å« 50k è®­ç»ƒå›¾åƒå’Œ 10k æµ‹è¯•å›¾åƒã€‚
ä»¥ä¸‹æ˜¯æ¯ä¸ªç­çº§ 10 å¼ éšæœºå›¾ç‰‡çš„æ ·æœ¬:

![](img/223c59f58aca94b3e085833517ec78b4.png)

æˆ‘ä»¬å°†åœ¨è¿™ä¸ªæ•°æ®é›†ä¸Šè®­ç»ƒ ResNet å’Œ plain net 20 ä¸ªæ—¶æœŸï¼Œç„¶åæ¯”è¾ƒç»“æœã€‚

åœ¨é…æœ‰ 1 ä¸ª NVIDIA Tesla K80 çš„æœºå™¨ä¸Šï¼Œæ¯ä¸ª ResNet å’Œ PlainNet çš„è®­ç»ƒæ—¶é—´çº¦ä¸º 55 åˆ†é’Ÿã€‚ResNet å’Œ PlainNet åœ¨è®­ç»ƒæ—¶é—´ä¸Šæ²¡æœ‰æ˜¾è‘—å·®å¼‚ã€‚
æˆ‘ä»¬å¾—åˆ°çš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/e939239277460e4ced03cbab8b6c0f2e.png)![](img/19562f76d38f8dbcd1e5624e0f748675.png)

å› æ­¤ï¼Œé€šè¿‡åœ¨è¯¥æ•°æ®é›†ä¸Šä½¿ç”¨ ResNetï¼Œæˆ‘ä»¬åœ¨éªŒè¯å‡†ç¡®æ€§æ–¹é¢è·å¾—äº† **1.59%** çš„æå‡ã€‚åœ¨æ›´æ·±çš„ç½‘ç»œä¸­ï¼Œå·®å¼‚åº”è¯¥æ›´å¤§ã€‚è¯·éšæ„å°è¯•ï¼Œçœ‹çœ‹ä½ å¾—åˆ°çš„ç»“æœã€‚

# å‚è€ƒ

1.  [ç”¨äºå›¾åƒè¯†åˆ«çš„æ·±åº¦æ®‹å·®å­¦ä¹ ](https://arxiv.org/abs/1512.03385)
2.  [æ®‹å·®ç¥ç»ç½‘ç»œâ€”ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Residual_neural_network)
3.  [åŠŸèƒ½ API æŒ‡å—â€” Keras æ–‡æ¡£](https://keras.io/getting-started/functional-api-guide/)
4.  [æ¨¡å‹(åŠŸèƒ½ API) â€” Keras æ–‡æ¡£](https://keras.io/models/model/)
5.  [åˆå¹¶å±‚â€” Keras æ–‡æ¡£](https://keras.io/layers/merge/)
6.  [CIFAR-10 å’Œ CIFAR-100 æ•°æ®é›†](https://www.cs.toronto.edu/~kriz/cifar.html)

æˆ‘å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹ä½ æœ‰ç”¨ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ï¼

è¿™ç¯‡æ–‡ç« ä¹Ÿè´´åœ¨æˆ‘è‡ªå·±çš„ç½‘ç«™[è¿™é‡Œ](https://www.nablasquared.com/building-a-resnet-in-keras/)ã€‚éšä¾¿çœ‹çœ‹å§ï¼