<html>
<head>
<title>Bring Your TensorFlow Training to AWS Sagemaker with Script Mode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在脚本模式下，将您的 TensorFlow 培训带到 AWS Sagemaker</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bring-your-tensorflow-training-to-aws-sagemaker-with-script-mode-aba9e73aa36b?source=collection_archive---------37-----------------------#2020-09-06">https://towardsdatascience.com/bring-your-tensorflow-training-to-aws-sagemaker-with-script-mode-aba9e73aa36b?source=collection_archive---------37-----------------------#2020-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1de2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 Sagemaker 脚本模式节省深度学习计算成本！</h2></div><h1 id="09ae" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">介绍</h1><p id="f917" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我会尽量让这篇文章简单明了。首先，我们先从这种方法的一些利弊谈起。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lt"><img src="../Images/824a9b938bca9b124942f70ea6a2702f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*geZaA9hzaeRmBWUXEGfrZg.jpeg"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">Artem Sapegin 在<a class="ae mj" href="https://unsplash.com/s/photos/script?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="57cb" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated"><strong class="kz ir">优点:</strong></p><ul class=""><li id="48e5" class="mp mq iq kz b la mk ld ml lg mr lk ms lo mt ls mu mv mw mx bi translated">允许您以更低的成本运行您的培训工作！为什么？因为你可以仅仅为了编码而启动一个非常廉价的实例；然后，您可以有一个单独的 GPU 实例，它只在训练期间启动，然后在您的训练代码运行完毕后关闭。这意味着你只在模型训练中消耗 GPU 时间，而不是在你编码的时候！</li></ul><p id="85b8" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated"><strong class="kz ir"> CONS: </strong></p><ul class=""><li id="60fe" class="mp mq iq kz b la mk ld ml lg mr lk ms lo mt ls mu mv mw mx bi translated">任何事情都是一种交换，很少有新的优势没有新的劣势。在这种情况下，缺点是我们需要学习一些新的技能。假设你正在运行一个本地培训任务，你想把它带到 Sagemaker <em class="my">(也许你想在一个更大的 GPU 上运行)</em>，你想利用这个方法来降低成本，那么你将需要编写更多的代码来让这个方法工作。你可能还需要了解线路和事物是如何一起工作的。</li></ul><p id="fa13" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">您可以在一个代码更改较少的笔记本实例中运行您的培训，但是您的作业不会自动关闭<em class="my">(因为您在笔记本实例中执行所有操作)</em>。所以这是一个权衡。要在笔记本实例中运行您的作业，请参见步骤 1 中的链接。</p><h1 id="be85" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">步骤 1:开始使用 Amazon Sagemaker</h1><p id="6a85" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果你以前从未使用过 Amazon Sagemaker 或 S3，我推荐你阅读我在 Amazon Sagemaker 上的第一篇文章，我会一步一步地向你展示如何简单地将数据加载到 S3 并运行一个笔记本实例。你可以在这里找到文章<a class="ae mj" rel="noopener" target="_blank" href="/a-very-simple-introduction-to-deep-learning-on-amazon-sagemaker-b6ca2426275a">的链接</a>。</p><h1 id="eea1" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">步骤 2:启动一个廉价的笔记本实例。</h1><p id="f70d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当你遵循第一步的文章，你将会做一件不同的事情。我们将启动一个廉价的 CPU 实例，例如类似于<em class="my"> ml.t3.medium </em>的东西，而不是用 GPU 启动一个笔记本实例。</p><div class="mz na gp gr nb nc"><a href="https://aws.amazon.com/sagemaker/pricing/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">亚马逊 SageMaker 定价-亚马逊网络服务(AWS)</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">有了亚马逊 SageMaker，你只需为你使用的东西付费。构建、培训和部署 ML 模型的费用由…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">aws.amazon.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq md nc"/></div></div></a></div><h1 id="9d9b" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">第 3 步:创建一个培训脚本，打开一个新的笔记本并运行您的作业。</h1><p id="51b9" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">一旦运行了一个廉价的笔记本实例，并且访问了 Jupyter，您将创建一个新的 python 脚本并打开一个新的 Jupyter 笔记本。</p><ol class=""><li id="7f7f" class="mp mq iq kz b la mk ld ml lg mr lk ms lo mt ls nr mv mw mx bi translated">训练脚本-这个 python 文件是您将拥有训练代码的地方。</li><li id="9dea" class="mp mq iq kz b la ns ld nt lg nu lk nv lo nw ls nr mv mw mx bi translated">朱庇特笔记本——这将是我们的训练指挥官。这个笔记本是要告诉 Sagemaker 我们的训练代码在哪里，我们的训练数据在哪里，模型训练要什么样的机器。</li></ol><h1 id="72ae" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">朱庇特笔记本代码</h1><p id="42b9" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这个笔记本可以很短，这取决于你想让它有多复杂。同样，这个笔记本将作为我们的训练指挥官。我在 GitHub 上有代码，你可以在这里查看。在这篇文章中，我将强调一些基础知识。</p><p id="005d" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">首先，我们需要从 SAGEMAKER 导入 TensorFlow。这是非常不同的，因为我们不是导入普通的 TensorFlow，而是导入一个允许我们启动 TensorFlow 容器进行训练的对象(即云中包含 TensorFlow 的容器)。</p><pre class="lu lv lw lx gt nx ny nz oa aw ob bi"><span id="8951" class="oc kg iq ny b gy od oe l of og"><strong class="ny ir">from</strong> <strong class="ny ir">sagemaker.tensorflow</strong> <strong class="ny ir">import</strong> TensorFlow</span></pre><p id="70d2" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">接下来是代码的核心。这是我们为培训工作指定一切的地方。</p><p id="96dc" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my">入口点</em>指向我们的训练脚本。在这种情况下，我的训练脚本名为<em class="my"> jigsaw_train1_aws2.py </em>，位于我的训练笔记本的工作目录中。</p><p id="e049" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my"> train_instance_type </em>接受一个字符串，该字符串标识我们想要训练什么类型的实例。在本例中，我指定了一个包含 GPU 的<em class="my"> ml.p2.xlarge </em>实例。</p><p id="d289" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my"> output_path </em>表示我希望我的所有输出被转储到哪里。我指着我在 S3 的一个地点。<em class="my">(这将在我们的培训脚本中再次出现)</em>。</p><p id="486f" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my"> train_instance_count </em>指定我们需要多少训练实例。在这种情况下，我只需要<em class="my"> 1 </em>，因为我们没有使用分布式代码，例如 Horovod。</p><p id="9c2f" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my"> framework_version </em>指定我们想要 TensorFlow 的哪个版本。<em class="my">(注意，Sagemaker 可能不支持 TensorFlow 的最新版本，所以请注意您指定的版本，并且不要太新；或者如果是，那就支持)</em>。</p><p id="df02" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">参数<em class="my"> script_mode </em>接受一个布尔值，在本例中为<em class="my"> True </em>，因为我们正在提供我们的训练代码。</p><pre class="lu lv lw lx gt nx ny nz oa aw ob bi"><span id="67df" class="oc kg iq ny b gy od oe l of og">estimator = TensorFlow(entry_point='jigsaw_train1_aws2.py',<br/>                       train_instance_type='ml.p2.xlarge',<br/>                       output_path="s3://jigsaw-toxic-mjy-output",<br/>                       train_instance_count=1,<br/>                       role=sagemaker.get_execution_role(), <br/>                       framework_version='1.11.0',<br/>                       py_version='py3',<br/>                       script_mode=<strong class="ny ir">True</strong>)</span></pre><p id="7a58" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">然后，如果我们想要提交我们的培训作业，我们只需要运行<em class="my">估算器</em>。作为<em class="my">估算器</em>的输入，我已经包含了一个关键字为“<em class="my">data”</em>的字典，对应的值是一个包含我的数据存储在其中的 S3 位置的字符串。</p><pre class="lu lv lw lx gt nx ny nz oa aw ob bi"><span id="f959" class="oc kg iq ny b gy od oe l of og">data_s3 = 's3://jigsaw-toxic-mjy/'<br/>inputs = {'data':data_s3}<br/>estimator.fit(inputs)</span></pre><p id="8bc6" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">在我们运行这个之前，我们需要确保我们的训练脚本已经准备好了。让我们快速回顾一下我们的培训脚本。</p><h1 id="4482" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">培训脚本代码</h1><p id="cb8b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">你可以在 GitHub <a class="ae mj" href="https://github.com/yeamusic21/Bring_Your_Training_To_Sagemaker_Demo/blob/master/jigsaw_train1_aws2.py" rel="noopener ugc nofollow" target="_blank">这里</a>阅读我的完整训练脚本代码示例。我不打算回顾这篇文章中的所有内容，只回顾要点。</p><p id="566c" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">首先，我们需要能够访问我们的数据。我们使用 argparse 来获取我们在<em class="my"> estimator.fit(inputs) </em>期间传递的数据目录。我们可以将数据目录与我们在 S3 获得的训练数据的名称连接起来。一旦我们有了这个字符串，我们就可以像往常一样使用 pandas 来读取我们的数据。</p><pre class="lu lv lw lx gt nx ny nz oa aw ob bi"><span id="64a8" class="oc kg iq ny b gy od oe l of og">import argparse<br/>import pandas as pd<br/>import os</span><span id="8f6d" class="oc kg iq ny b gy oh oe l of og">parser = argparse.ArgumentParser()</span><span id="e65a" class="oc kg iq ny b gy oh oe l of og">parser.add_argument('--data', type=str, default=os.environ.get('SM_CHANNEL_DATA'))</span><span id="c607" class="oc kg iq ny b gy oh oe l of og">args, _ = parser.parse_known_args()</span><span id="e770" class="oc kg iq ny b gy oh oe l of og">data_dir = args.data</span><span id="82fc" class="oc kg iq ny b gy oh oe l of og">df = pd.read_csv(os.path.join(data_dir, 'train.csv'))</span></pre><p id="afd9" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">接下来，我们可以像平常一样运行我们的训练代码了！</p><p id="830b" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">最后，如果我们想要保存任何信息，我们需要将它保存到 TensorFlow 容器知道的特定目录中。那个位置是<em class="my"> /opt/ml/model/ </em>。保存到这个目录的任何东西，都将被保存到我们在 Jupyter 代码中指定的输出路径。</p><pre class="lu lv lw lx gt nx ny nz oa aw ob bi"><span id="5512" class="oc kg iq ny b gy od oe l of og">data_location = “/opt/ml/model/submission.csv” submission.to_csv(data_location, index=False)</span></pre><h1 id="9842" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结束了！</h1><p id="c2a3" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">就是这样！一旦您准备好培训脚本，您就可以从头到尾运行您的 Jupyter 笔记本，并观看您的培训工作开始！</p><p id="7b14" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">再说一次，当你完成后，我会删除一切！这包括你的 S3 桶，你的实例，一切；因为如果你把所有这些工作都放在 AWS 上，即使你不再运行任何东西，也要花钱！</p><p id="b58c" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">你可以在 GitHub <a class="ae mj" href="https://github.com/yeamusic21/Bring_Your_Training_To_Sagemaker_Demo" rel="noopener ugc nofollow" target="_blank">这里</a>找到我自己的脚本模式培训工作的例子。这个 repo 包含我的笔记本实例中的代码，因此，它是我的笔记本实例的快照。希望人们发现这是有益和快乐的学习！:-D</p></div></div>    
</body>
</html>