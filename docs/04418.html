<html>
<head>
<title>Nitty-Gritty of Advanced Indexing in Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫高级索引的本质</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/nitty-gritty-of-advanced-indexing-in-pandas-9850b2d50220?source=collection_archive---------56-----------------------#2020-04-20">https://towardsdatascience.com/nitty-gritty-of-advanced-indexing-in-pandas-9850b2d50220?source=collection_archive---------56-----------------------#2020-04-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ddd9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为什么多级索引并不像看起来那么令人生畏</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e3047e19ec834d2ab58e547eb9dad989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*homoXeHnSxOP3U6X"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@ozgut?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">奥兹古·奥兹登</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="8165" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我经常听到这句美丽的名言，</p><blockquote class="lv lw lx"><p id="e7ee" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">“有时我们看不到眼前的东西”</p></blockquote><p id="d6cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何事情都是如此——无论是错误的原因还是错误本身，拼写错误的变量名，没有设置<code class="fe mc md me mf b">inplace = True</code>,想知道为什么我的数据帧没有改变，等等。不仅仅是错误或打字错误，甚至是功能。我们不认为基本功能是产品的组成部分。熊猫的<em class="ly">指数</em>是一个经常被忽视但在数据分析和处理中起着关键作用的东西。</p><p id="207b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">索引、序列和数据帧是Pandas的核心数据结构。索引是数据帧中某个位置的标识符或地址。而操作一维和二维索引是最常见的做法。学习处理任意数量的维度有时会非常方便。幸运的是，Pandas <a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/advanced.html#hierarchical-indexing-multiindex" rel="noopener ugc nofollow" target="_blank">使</a>能够将高维数据使用和存储到一维数据结构(如序列)和二维数据结构(如数据帧)中。这就是众所周知的分级索引、高级索引或多级索引。</p><p id="f39a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将解释现实世界中多级索引的基本操作方法。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><p id="9291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我从Kaggle获得了这个数据集。数据集包含一些关于汽车的样本数据，如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/1bd6858803df8b569b12e1091ac0ee23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNGFmDJnUGHsZr636240AQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">样本汽车数据</p></figure><h2 id="ee76" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated">繁琐的道:</h2><p id="7785" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">比方说，我想知道是否有丰田汽车的车身样式是轿车，燃料类型是柴油。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/6101fb9916a7d5d4994328e7669f216b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jekf6tw-39tjIxc161nkPg.png"/></div></div></figure><p id="1f53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们找到想要的结果的方法之一。如果我们想知道所有车身样式为旅行车的柴油汽车的品牌，并检查其价格是否在20，000美元以内，该怎么办？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/68c89c72c9f8016495ac2a198aea76ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZabPwepi_bNwQ5VFzg2PYg.png"/></div></div></figure><p id="2649" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们仍然获得了想要的输出，但是代码并不整洁。随着查询变得越来越复杂，代码变得越来越单调和冗长。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h2 id="a420" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated">高级索引或分层索引:</h2><p id="363e" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">分级索引可以帮助我们处理任意数量的维度。它可以帮助我们过滤、聚合、组织和操作数据，进行真正强大的数据分析。</p><h2 id="07a5" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated">1)操纵索引:</h2><p id="bbd3" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">让我们从为数据帧设置索引开始。为了创建多索引数据帧，我们向属性<code class="fe mc md me mf b">index</code>传递一个值列表，而不是一个字符串。我的数据集中有如此多的分类特征，但我将首先考虑<code class="fe mc md me mf b">make</code>，因为我想知道不同汽车组的详细信息。另外，为了更好的组织，我会考虑<code class="fe mc md me mf b">body_style</code>和<code class="fe mc md me mf b">fuel_type</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/e47846ab464ed1e0b0b231a87d075e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oy1KEGNr5PXuh27_PGG6IA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">集合_索引</p></figure><p id="2178" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一下索引，看看它们为我们带来了什么。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/1c8d6930a8004b20060c98c0605d86db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AaEdh4YMDZ5AimM5jQQshg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">多级索引</p></figure><p id="0b9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多索引包含三个不同的属性，即级别、代码和名称。</p><ul class=""><li id="f986" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated"><code class="fe mc md me mf b">levels</code>属性指的是索引的标签名。索引从左开始排序。在这种情况下，<code class="fe mc md me mf b">make</code>是最高的索引，其值为<code class="fe mc md me mf b">level = 0</code>。也可以简称为<code class="fe mc md me mf b">level = 'make'</code></li><li id="7056" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe mc md me mf b">codes</code>属性指的是编码级别的每个数据点的标签。</li><li id="87ca" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">属性包含了级别的字符串名称。</li></ul><p id="89b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">行和列都可以有多级索引。我们可以通过简单地将<code class="fe mc md me mf b">reset_index()</code>函数传递给DataFrame来重置索引。</p><p id="dea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用多级索引时需要注意的是，在尝试执行任何切片操作之前，先对索引进行排序。切片操作会故意抛出如下所示的警告。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/753a072670e635fb943ff1da3312c8e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1totbdnFoegQrX5W_WST6A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">未排序的多索引数据框的警告</p></figure><p id="1648" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过将<code class="fe mc md me mf b">sort_index()</code>函数传递给多索引数据帧来避免这种情况。此外，Pandas依赖于被排序的索引来进行最优的检索和搜索操作。我们可以使用返回布尔值的<code class="fe mc md me mf b">index.is_lexsorted()</code>函数来检查索引是否已经排序。</p><p id="e277" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其他有用的功能有</p><ul class=""><li id="cae2" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">swap_level()</li><li id="a108" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">堆栈()</li><li id="7bd3" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">拆分()</li></ul><p id="05f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">swap_level()</code>可用于交换数据帧内的级别。它采用两个参数<code class="fe mc md me mf b">i</code>和<code class="fe mc md me mf b">j</code>，这两个参数是作为字符串传递的级别名称。传递这个函数不会改变值的顺序。</p><p id="7883" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">stack()</code>和<code class="fe mc md me mf b">unstack()</code>功能带有一个附加参数，您可以选择堆叠或不堆叠的层级，其中堆叠的层级成为新的最低层级(最右边)。</p><p id="4eaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以继续检查官方的熊猫文档来获得更多的索引修改。</p><h2 id="b4a5" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated">2)访问数据:</h2><p id="c9ea" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">让我们看看是否可以使用我们的多索引数据框架找到任何车身类型为轿车、燃料类型为柴油的丰田汽车。</p><ul class=""><li id="493f" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">使用<code class="fe mc md me mf b">.loc</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/ed0d5f4306b4df4a373f2741f38740d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1404Oo3uJRU27ZOLMp65Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。通信线路（LinesofCommunication）</p></figure><p id="6994" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">.<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.loc.html" rel="noopener ugc nofollow" target="_blank">loc</a></code>主要用于基于标签的选择，其中标签名称在元组内传递。有时它与<code class="fe mc md me mf b">pd.IndexSlice</code>结合在一起。例如，查找所有柴油汽车。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/e685c21d79627110518ea8567aad68d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VNQztr5tS67S0AIhQROCVw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">警察。索引切片。通信线路（LinesofCommunication）</p></figure><p id="a601" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，在<code class="fe mc md me mf b">pd.IndexSlice</code>内部，第一个<code class="fe mc md me mf b">:</code>选择所有<code class="fe mc md me mf b">make</code>的车厢，第二个<code class="fe mc md me mf b">:</code>选择所有<code class="fe mc md me mf b">body_style</code>的车厢，而外部的<code class="fe mc md me mf b">:</code>选择所有列。</p><ul class=""><li id="c081" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">使用<code class="fe mc md me mf b">.xs</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/9bb4548dc37514bb8691ab0b82f24860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jv7iCBraRzI5sgDZgRzhw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。特小号</p></figure><p id="b703" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">.<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.xs.html" rel="noopener ugc nofollow" target="_blank">xs</a></code>获取数据帧的特定横截面，其中轴参数默认为零<code class="fe mc md me mf b">axis=0</code>，并获取一个<code class="fe mc md me mf b">level</code>参数，该参数指示要使用的级别。</p><ul class=""><li id="85cf" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">使用<code class="fe mc md me mf b">.query</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/07ec990a599921ff4d7c6d04f86bb469.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tS0OQYX4seQVdVWhE_ULxQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。询问</p></figure><p id="bb1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">.<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.query.html" rel="noopener ugc nofollow" target="_blank">query</a></code>使用布尔表达式进行过滤或切片。注意查询中使用的<code class="fe mc md me mf b">and</code>和<code class="fe mc md me mf b">or</code>超过了<code class="fe mc md me mf b">&amp;</code>和<code class="fe mc md me mf b">|</code>。这是因为查询方法中的表达式是使用<code class="fe mc md me mf b"><a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.eval.html#pandas.eval" rel="noopener ugc nofollow" target="_blank">eval()</a></code>函数动态计算的。此外，默认情况下，该方法使用修改后的Python语法。</p><ul class=""><li id="d0ad" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">使用<code class="fe mc md me mf b">get_level_values</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/4360d8c8ed165b4a491ac1efb360d323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rj1Mr9qHquPvoJSxtKsSVg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">获取级别值</p></figure><p id="22f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b"><a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Index.get_level_values.html" rel="noopener ugc nofollow" target="_blank">get_level_values</a></code>对请求的级别使用标签值的向量。这里，级别值可以作为整数或字符串传递。</p><p id="3d4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更一般地说，<code class="fe mc md me mf b">loc</code>和<code class="fe mc md me mf b">xs</code>用于基于标签的选择，而<code class="fe mc md me mf b">query</code>和<code class="fe mc md me mf b">get_level_values</code>有助于生成用于过滤的条件表达式。并非所有这些方法都同样有效，每种方法在不同的情况下效果最好。我们有责任选择最佳的检索方法！</p><h2 id="2b88" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated">3)汇总数据:</h2><p id="3fae" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">所有内置的数据聚合方法，如<code class="fe mc md me mf b">mean()</code>、<code class="fe mc md me mf b">min()</code>、<code class="fe mc md me mf b">max()</code>、<code class="fe mc md me mf b">sum()</code>都可以应用于分层数据框架。它与<code class="fe mc md me mf b">level</code>参数一起传递，该参数影响计算聚合的数据部分。一个简单的例子是找出所有大众汽车的平均价格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/a47292b5fca394a7429d86517209715d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*TyWt0imrngxdEoe4TSi3zw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">平均价格</p></figure><p id="7e97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用熊猫索引一直是有趣和好奇的！请随意查看我的GitHub repo <a class="ae ky" href="https://github.com/Padhma/Data-Science-Notebooks/tree/master/Data%20Analysis/Pandas/Advanced%20Indexing" rel="noopener ugc nofollow" target="_blank">这里的</a>包含了文章中提到的所有代码。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><p id="2f74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢你一路阅读到这里。如果你有任何问题、反馈或批评，请在评论区告诉我。祝你今天开心！玩的开心！</p></div></div>    
</body>
</html>