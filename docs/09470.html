<html>
<head>
<title>Back-test analysis of NIFTY 50 stocks using CPPI strategy: A Data Science Approach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 CPPI 策略对 NIFTY 50 股票进行回测分析:一种数据科学方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/back-test-analysis-of-nifty-50-stocks-using-ccpi-strategy-a-data-science-approach-c4a258943b5e?source=collection_archive---------45-----------------------#2020-07-06">https://towardsdatascience.com/back-test-analysis-of-nifty-50-stocks-using-ccpi-strategy-a-data-science-approach-c4a258943b5e?source=collection_archive---------45-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1858" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">介绍</h2></div><p id="6480" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文试图通过分析新冠肺炎疫情对 NIFTY-50 股票的影响，使用数据科学方法来解决现实世界的投资管理问题。</p><p id="6c84" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像新冠肺炎这样的疫情事件是“黑天鹅”事件，因为它们无法预测，而且没有任何分散投资策略可以保护投资免受这种系统性风险的影响。正如专家所说，“多样化会在你最需要的时候让你失望”。在 2008 年金融危机或我们现在面临的新冠肺炎疫情等事件中，即使是非常多元化的投资组合也会亏损。那么，当市场在此类事件中崩盘时，你如何保护自己的财富，同时又能参与上涨，在不失去你的财务目标的情况下，两全其美呢？答案是，在建立投资组合时，要有一个“保险”或“安全网”之类的策略。曾经这样的“安全网”策略就是固定比例投资组合保险(CPPI)。</p><p id="ff27" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管这类策略在行业中以多种形式和技术使用，但在这里，我们尝试通过一步一步的数据科学方法，从相关来源提取足够的数据，对其进行清理、转换和建模，实施动态 CPPI 算法，获得回溯测试结果，并使用高级数据可视化方法对策略进行交互分析。在接下来的几节中，我们将更多地讨论用户交互性、直观性和 CPPI 计算的算法复杂性之间的平衡，而不是 CPPI 作为投资组合策略的本质。关于 CPPI 如何运作的更多细节和它是什么的一个外行例子，看一看 https://www.investopedia.com/terms/c/cppi.asp。我们使用 Python/Anaconda 实现数据工程&amp;算法，使用 Tableau 实现数据可视化，使用分析扩展库 TabPy 作为解决方案的技术工具。</p><h2 id="e2f3" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">确定数据源和数据准备步骤</h2><p id="a088" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">我们研究的主要数据来源是 NSE 印度网站，我们试图使用网络抓取来提取 NIFTY-50 股票的历史价格。然后我们发现了一个非常有用的库/API‘NSEPY ’,它以一种更优雅的方式提取给定股票代码的历史价格。因此，我们首先创建了 50 只股票的列表，并调用 NSEpy 库/API(【https://github.com/swapniljariwala/nsepy/tree/master/nsepy】)来提取 2018 年 1 月至 2020 年 6 月的数据。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/19b6de34a78e0a683f8dbb7ea722b92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*KryAuGG-sG5mfi7ojim7EQ.png"/></div></figure><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/e6056d826661e8391c931f04d827fb5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*7VmjURoP3YXEf3mFE5adKA.png"/></div></figure><p id="20a4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从 NSE 提取的原始数据如下所示:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/2ad25a533889e67c33ef9a6136f4c2d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*6AdrMoi5W8oxQaV3A-3D5w.png"/></div></figure><p id="ea55" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些数据点基本上是股票在某一天的各种价格点。为投资组合分析处理每日频率数据可能有些过分，为了简单起见，我们将每周汇总数据。从每日价格中，我们会发现周价格点，如开盘价、收盘价、最高价和最低价。我们还应该注意列标题，确保它们看起来干净，中间没有任何空格或特殊字符。一旦你转换成每周时间序列数据，数据框架应该像下面这样:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/195e8e810158c5dc56a5076dc495847c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*7z0rm4PA9Rxd0LGyGXlBaA.png"/></div></figure><p id="9019" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在每周分组后，计算每周收益，这是相对于前一周的价格变化百分比。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/8e97080d157c2660b26375af2d987532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*UPltY36UPsvHES3ReawVKg.png"/></div></figure><p id="c46b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上述数据框的可视化表示应类似于 Tableau 中的下图或任何数据可视化工具。正如我们所见，在 2020 年 2 月至 5 月期间，每周回报非常繁忙，导致波动很大。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/0c78a6e51135596e18f44931479597d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*0SaG2q70Z7mZS825GL63ZQ.png"/></div></figure><h2 id="740f" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">CPPI 的逻辑</h2><blockquote class="mm mn mo"><p id="55a3" class="ki kj mp kk b kl km ju kn ko kp jx kq mq ks kt ku mr kw kx ky ms la lb lc ld im bi translated">在这一节中，我们将看到如何用 Python 实现 CPPI 算法的伪代码。实现它的步骤基本上不多，用 python 实现也不复杂。</p></blockquote><p id="d9e1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于给定的一组周收益时间序列数据，我们需要遍历尽可能多的步骤来计算和存储每个时间点的各种指标。</p><p id="a8d0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">初始化并设置 CPPI 参数</p><p id="7e2e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> #设置 CPPI 参数</em></p><p id="0df5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> n_steps = len(每周回报数据集)</em></p><p id="5047" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> account_value = start(你投资的起始值)</em></p><p id="a185" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">floor _ value = start * floor(floor 是一个输入参数，通常在 0.1-1.0 之间)</em></p><p id="3aa4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> peak = account_value </em></p><p id="5914" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，对于每周回报时间序列中的每一步，计算以下步骤</p><p id="ca5a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">第一步:缓冲=(账户值-下限值)/账户值</em></p><p id="a931" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">第二步:计算风险重量和安全重量:</em></p><p id="bab2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> risky_weight = m * cushion (m 是一个输入参数，它是一个乘数，基本上表示投资者的风险状况，是一个标准化值，介于 0-1 之间)</em></p><p id="9a1b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">safe _ weight = 1—risky _ weight</em></p><p id="9f6c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">risky _ allocation = account _ value * risky _ weight</em></p><p id="f29c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安全分配=账户价值*安全重量</p><p id="ebce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">第三步:重新计算账户值</em></p><p id="7d9d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">account _ value = risky _ allocation *(1+risky _ week _ return)+safe _ allocation *(1+safe _ week _ return)</em></p><p id="47be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">其中 risky_weekly_return 是作为输入接收的股票的时间序列每周回报，safe_weekly_return 通常使用安全净产品(如国债)的假定无风险利率计算。</em></p><p id="40f7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第四步:使用累计乘积法计算风险财富，因为每个时间段的回报都需要复合。</p><p id="ae88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">risky _ wealth = start *(1+risky _ r[step])* risky _ wealth _ prev</em></p><p id="2b7c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">risky _ wealth _ prev =(1+risky _ r[step])* risky _ wealth _ prev</em></p><p id="8c73" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第五步:将每个时间段的所有指标存储在后验容器中。</p><h1 id="ea69" class="mt lg it bd lh mu mv mw lk mx my mz ln jz na ka lq kc nb kd lt kf nc kg lw nd bi translated">年化回报率与年化波动率</h1><p id="2bb8" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">现在我们已经有了 CPPI 算法，让我们挑选一些回报率较高的股票和一些波动性较大的股票，观察 CPPI 策略的回溯测试结果。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/9583d5896db6b4e1de091ff58e2f0628.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*LI39tN1UW5VJoSxSJn2-ZQ.png"/></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">雀巢印度公司表现最好，盖尔表现最差</p></figure><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/7fc09695b15d37dfadbba1b4eab1a415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*rv9huhQgjNwTifDLsdpgJw.png"/></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">印度斯坦联合利华的年波动率最低，而印度银行的年波动率最高</p></figure><p id="144a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以很容易地观察到，波动性对业绩不利，很明显，高绩效股票(高年回报率)的波动性低，反之亦然。</p><h2 id="89d2" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">为什么 CPPI 是一个安全网战略</h2><p id="41d6" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">雀巢印度公司是 2018 年 1 月至 2020 年 6 月期间表现最好的股票，使用 CPPI 策略，1000 卢比的初始投资回报了 1522.36 英镑的最终财富。如果我们在没有任何策略的情况下投资所有的 1000 卢比，我们最终会得到 2119 卢比。很明显，在形势大好的时候，我们遵循 CPPI 的策略是在吃亏。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/656250e1198c97051b8c2a4fc06ce403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*6vCE8B8jAIg-m9wVYjlbHQ.png"/></div></figure><p id="40c2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但 CPPI 策略的优势在于，当黑天鹅出现时，当情况不妙时。当我们观察盖尔，这是表现最差的股票，我们将能够体会到这一战略的好处。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/f4763a1177e2fc5ff00f4a301d8626d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*uhZE57scCgdLeigRq6THzA.png"/></div></figure><p id="cf07" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所看到的，如果我们没有实施 CPPI 策略，把所有的钱都投资到高风险账户，我们最初的投资 1000 卢比，最终的价值是 210.4 卢比。这会粉碎投资者的财务目标，不是吗？。相反，如果我们遵循 CPPI 策略，我们的损失不会低于我们之前设定的最低价值，我们最终会获得 807.62 卢比，从而保护我们的财务目标，在很大程度上减少损失，保护资本。</p><p id="2990" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于我们必须进行再平衡，CPPI 战略还有其他局限性，这反过来会增加交易成本，这是必须考虑的因素。</p><h2 id="84b5" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">与 Tableau 整合</h2><p id="8aab" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">Tableau 为 python 提供了一个名为 Tabpy 的分析扩展，这是一个有用的工具，可以将 Python 中的数据工程和算法任务与 Tableau 中的高级可视化功能集成在一起。在 Jupyter 中可以很容易地部署 python CPPI 算法，如下所示</p><p id="585d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> client.deploy('run_cppi '，run_cppi，'运行 CPPIstrategy 的回溯测试，给定风险资产的一组回报'，override = True) </em></p><p id="8724" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 Tableau 中，端点的返回值以计算字段的形式接收，如下所示:</p><p id="16e1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp">SCRIPT _ STR(" Return tabpy . query(' run _ cppi '，_arg1，_arg2，_arg3，_arg4，_arg5)['response']"，SUM([Weekly_Return])，cppi_m，cppi_start，cppi_floor，cppi_rfrate) </em></p><p id="66fa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mp"> ##def run_cppi(risky_r，m=3，start=1000，floor=0.8，riskfree_rate=0.03): </em></p><h2 id="5d34" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">结论</h2><p id="67e5" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">尽管 Tableau 和 Python 在金融服务公司中被广泛使用，但是集成它们并利用它们各自优势的能力提供了“思维速度”的分析能力，这是仅使用其中一种工具所无法实现的。分析扩展为数据科学家提供了设计和实施解决方案的机会，这些解决方案对于为投资策略(如 CPPI)提供建议非常有用。尽管这个解决方案的实现并非没有技巧和变通方法，但我们将把它留到以后讨论。</p><h2 id="8c38" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">信用</h2><p id="bb73" class="pw-post-body-paragraph ki kj it kk b kl ly ju kn ko lz jx kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">Coursera 和 EDHEC Business School 提供了 Python 和机器学习在投资管理专业课程中的知识</p></div></div>    
</body>
</html>