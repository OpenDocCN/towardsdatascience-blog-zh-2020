# 分析 Docker 图像安全性

> 原文：<https://towardsdatascience.com/analyzing-docker-image-security-ed5cf7e93751?source=collection_archive---------13----------------------->

## Docker 容器并不像许多人认为的那样本质上是安全的。因此，使用工具和扫描仪来清除容器中的漏洞至关重要…

![](img/7dc0eb5e4baf3379cc063b2e5d95c3fd.png)

由[马頔·佩丘林](https://unsplash.com/@pechka?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄的照片

很多人认为 Docker 图像和容器在默认情况下是安全的，不幸的是，事实并非如此。有很多因素会影响 Docker 图像的安全性。无论是安装在映像中的包、应用程序使用的库，甚至是基本映像，所有这些组件都可能给应用程序带来漏洞。这些问题中有很多是很容易避免的，尽管…

# 安克雷奇-克莱尔公司

在 Docker 映像中查找漏洞的最简单方法是使用或等工具对其进行检查:

*   *Anchore Engine*:*Anchore*是集装箱图像检查、分析和认证的集中服务。它使用来自操作系统供应商的漏洞数据(feeds)扫描图像，如 *Red Hat* 、 *Debian* 或 *Alpine* 。对于非 OS 数据，它使用 [NVD(国家漏洞数据库)](https://nvd.nist.gov/)，包括 *RPM* 、 *Deb* 、 *APK* 以及 *Python (PIP)* 、 *Ruby Gems* 等漏洞。
*   *Clair* : *Clair* 是由 *CoreOS* 为码头工人和 APPC 集装箱开发的静态分析仪。它使用来自类似[来源](https://github.com/quay/clair/blob/master/Documentation/drivers-and-data-sources.md#data-sources-for-the-built-in-drivers)的漏洞元数据*Anchore*——红帽安全数据、NVD、Ubuntu CVE 追踪器、Alpine SecDB、Debian 安全漏洞追踪器等。

# 安装

现在我们知道了我们想要使用的工具，是时候旋转它们了。 *Anchore* 和 *Clair* 都包含各种集成，可以部署到 *Kubernetes* 或 *OpenShift* 上，但是为了演示的目的，我们将在本地机器上使用`docker-compose`来设置它们:

要设置*锚定器*,运行以下程序:

要设置*克莱尔*运行以下程序:

这样我们就可以开始分析了！

*注意:我们将在本文稍后回到 Clair。*

# 检查图像的漏洞

让我们从 *Anchore* 和基本 *Debian* 镜像开始。为了分析我们的图像，我们需要做的是`add`它和`wait`来完成分析:

分析图像后，让我们看看发现了哪些漏洞:

我们首先运行带有`all`标志的`image vuln`命令，列出镜像中存在的操作系统和软件包漏洞。所有这些都是`Negligible`或`Unknown`，所以这很好。接下来，我们运行`evaluate check`命令来查看这个映像是否通过了默认策略检查，正如您在上面所看到的(`Status: pass`)，它通过了。在这方面，这些类型的基本图像通常表现很好，因为它们被广泛使用，因此受到了大量的审查。

但是，使用 Python 3 *Debian Buster* 映像构建的简单的 Python 应用程序呢？让我们先看看 docker 文件:

没什么叫*【脆弱】**【不安全】*的吧？那么，让我们构建并分析它:

我首先使用上面的`debian.Dockerfile`和简单的`hello.py`构建图像。然后我把它推到 Docker Hub，从那里它被添加到 Anchore 并最终被分析。现在我们可以看看结果:

嗯，嗯，嗯…不再那么好了。我们所做的，就是切换到官方 Python *Debian* 映像，我们突然有了 1000 多个漏洞，包括一些`Low`和`Medium`严重性的漏洞，相比之下，只有几个`Negligible`有普通的 *Debian* 映像。最重要的是，在运行映像评估后，我们可以看到它失败了(`Status: fail`)。

所以，即使我们使用了官方的看似安全的图片，并且创建了没有明显漏洞的非常简单的应用程序，我们仍然有很多安全问题。那么，我们该如何改善这一点呢？

# 寻找卓越的形象

说到安全性，基本映像的最佳选择是`scratch`——也就是空容器。然而，从零开始构建我们自己的基础映像是不太实际的，而且考虑到我们大多数人都不是安全专家，这可能会带来更多的安全问题。

在我看来，排在`scratch`之后的第二个最佳选择是*发行版*，它是由*谷歌*制作的一组图像，创建这些图像的目的是为了安全。这些图像包含您的应用程序所需的最少内容，这意味着没有外壳、包管理器或任何其他工具会使图像膨胀，并为安全扫描仪(如 [CVE](https://cve.mitre.org/) )产生信号噪声，从而更难建立合规性。我已经在我之前的博客文章[这里](https://martinheinz.dev/blog/17)中更详细地介绍了*发行版*，所以如果你想知道更多，去看看吧。

好吧，那么*distrolles*现在是我们安全映像的选择，但是在我们分析任何东西之前，让我们先来看看新的`Dockerfile`:

与 T21 的 Debian 版本相比，没有太大的变化。我们真的只是把*赛跑运动员*的图像换成了`gcr.io/distroless/python3`。现在，我们可以继续构建它，推动它并将其添加到 *Anchore Engine* :

最后，是时候看看*发行版*是否比 *Debian* 版本表现得更好了:

的确如此！与第一个例子相比，我们只有 53 个漏洞和 2 个`Low`严重性漏洞。还有，看政策评估——这个镜像通过了，而 *Debian* 那个失败了！

因此，我们可以有把握地得出结论，当谈到我们的容器化应用程序的安全性时，*distroles*是更好的选择。但是，我们还可以检查和改进一些东西，例如，我们可以尝试使用不同的评估策略:

上面的命令列出了我们可以用来检查图像的所有可用策略。默认情况下，它使用`anchore_default_bundle`，这很好，但是如果我们想看到使用不同的白名单和规则执行检查，那么我们可以尝试，例如`anchore_cis_1.13.0_base`:

从上面可以看到，我们首先通过运行`policy hub get`来查看这个特定策略的描述。之后，我们安装它并运行`policy list`命令，这表明我们现在有 2 个策略可用，新策略处于非活动状态。所以，我们用最后一个命令(`policy activate`)激活它。

在我们对新政策进行检查之前，让我们先谈谈它包括哪些内容。考虑到是 *Docker CIS 1.13.0* 检查，将重点关注[本文件](https://blogs.tunelko.com/wp-content/uploads/2017/08/CIS_Docker_1.13.0_Benchmark_v1.0.0.pdf)提供的指导。举几个例子来说明它在寻找什么样的问题:

*   `ADD`用于代替`COPY`的命令
*   未列入白名单的开放端口
*   失踪`HEALTCHECK`
*   使用不可信的基础映像
*   使用`root`作为有效用户

您可以运行`anchore-cli --json policy hub get anchore_cis_1.13.0_base`获得该政策中规则的完整列表。现在，我们知道了它将寻找什么，是时候运行它了:

在一些已安装的软件包的输出中有相当多的警告，但是特定于这个策略的是上面列出的那些。这些是使映像无法通过策略评估的问题/漏洞，应该进行分析。其中一个(第二个)是由于使用了*发行版*映像，因为它不在白名单中，所以可以忽略。至于其他两个——这些都是应该解决的实际问题，但它们都有简单明了的解决方案。

这向我们表明，根据我们的需求选择特定的策略，甚至使用多个策略来捕捉尽可能多的问题是一个好主意。

# 漏洞的类型/级别

然而，并非所有的漏洞都是相同的，其中一些甚至不适用于我们的应用程序/容器/环境。因此，我们不仅要看它们的严重程度，还要看计算严重程度的因素。这包括攻击媒介、攻击复杂性、保密性影响、完整性影响等。然后，这些因素会创建使用 [CVSS 计算器](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator)生成的最终严重性分数。具体的括号有— `None`、`Low`、`Medium`、`High`和`Critical`。关于他们的更多信息可以在 https://nvd.nist.gov/vuln-metrics/cvss 的 NIST 网站找到。

# 修复漏洞

上例中的漏洞很容易修复，但情况并非总是如此。您可能会遇到严重性分数较高漏洞，或者对于您的特定用例来说有问题的漏洞。当涉及到基础映像或其中包含的包的问题时，你不应该修复它们，因为那是所述工具的开发者和/或发行者的责任。也就是说，您应该通过移除攻击媒介来防止或至少减轻现有和未来漏洞的可利用性，例如通过使用没有任何外壳的*发行版*。最重要的是，使用构建/部署管道定期运行漏洞检查是一个好主意，以便在引入漏洞时尽快发现漏洞，最好使用多种扫描工具。

# Anchore 对 Clair

说到运行多种扫描工具…那么*克莱尔*呢？它与*主播*相比如何？这就是我们如何针对我们的示例 *Debian* 和*发行版*映像运行它:

查看以上命令的输出，它看起来与我们从 *Anchore* 那里得到的非常相似——Debian 镜像有很多问题，而*发行版*没有任何问题。在第一次扫描的输出中，有一个我省略了的巨大的漏洞列表，但是我检查了所有的`Low`和`Medium`严重性漏洞，它们同时出现在 *Anchore* 和 *Clair* 扫描结果中，但是情况可能并不总是如此。因此，我建议运行多种扫描工具，最好是使用不同来源的漏洞元数据的扫描工具。

你可能想看看的一些其他工具包括 [Docker Bench for Security](https://github.com/docker/docker-bench-security) 或 *IBM Container Registry* 中包含的漏洞扫描。

# 结论

对于与安全相关的东西，最好是积极主动，在漏洞变成实际问题之前尽量避免它们，本文中展示的工具可以在这方面提供很大帮助。我认为使用和实现这个工具非常容易，所以任何人都可以让它们成为日常工作流程的一部分，或者理想情况下，成为他们自动化管道/工作的一部分。在一定程度上，我们创建的应用程序的安全性是每个开发人员的责任，而不仅仅是安全专家或测试人员的责任，所以我们都应该参与到使它们足够安全的工作中来，也许只是通过不时地运行漏洞扫描。😉

*本文最初发布于*[*martinheinz . dev*](https://martinheinz.dev/blog/19)

***注来自《走向数据科学》的编辑:*** *虽然我们允许独立作者根据我们的* [*规则和指导方针*](/questions-96667b06af5) *发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的* [*读者术语*](/readers-terms-b5d780a700a4) *。*