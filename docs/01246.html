<html>
<head>
<title>Firebase Event Analytics with Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google BigQuery的Firebase事件分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/firebase-event-analytics-with-google-bigquery-ec756230f768?source=collection_archive---------10-----------------------#2020-02-04">https://towardsdatascience.com/firebase-event-analytics-with-google-bigquery-ec756230f768?source=collection_archive---------10-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f1a0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">帮助您开始应用分析的详尽指南</h2></div><p id="3ed4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我开始从事事件分析。正如大多数移动应用程序一样，这个应用程序也链接到Firebase进行事件跟踪。这很难理解，尤其是因为网上关于这方面的资源有限。在进入这个系统4个月后，我有了一些理解和经验，我将在这篇关于Firebase Analytics的易于理解的帖子中分享。(这篇文章包括一些直接来自谷歌文档的信息)。我们开始吧！</p><blockquote class="le"><p id="2403" class="lf lg it bd lh li lj lk ll lm ln ld dk translated">多美啊，<br/>坐在我的办公桌前，<br/>望着窗外，看到整个城市，<br/>在我眼前伸展开来</p><p id="bfcf" class="lf lg it bd lh li lj lk ll lm ln ld dk translated">混凝土丛林的尽头，以河流为标志，<br/>贯穿整个城市</p><p id="4166" class="lf lg it bd lh li lj lk ll lm ln ld dk translated">一个世界，一个非常不同的世界住在河对岸。<br/>好还是坏，你问。让我们不要用善良的尺度来衡量每件事，当所有的事情都是真实的时候，都是不同的。</p></blockquote><h1 id="0e79" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz lz ka ma kc mb kd mc kf md kg me mf bi translated">什么是Firebase Analytics？</h1><p id="379b" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">正如<a class="ae ml" href="https://en.wikipedia.org/wiki/Firebase" rel="noopener ugc nofollow" target="_blank"> wiki </a>所说，<strong class="kk iu"> Firebase </strong>提供了一个实时数据库和后端服务。该服务为应用开发者提供了一个API，允许应用数据跨客户端(基本上是用户)同步，并存储在<strong class="kk iu"> Firebase的</strong>云上。</p><p id="aca3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> Firebase </strong>的核心是Google <strong class="kk iu"> Analytics </strong>，这是一个<strong class="kk iu"> analytics </strong>解决方案，它集成了<strong class="kk iu"> Firebase </strong>的各种功能，并提供多达500个不同事件的报告，这些事件可以使用<strong class="kk iu"> Firebase </strong> SDK来定义。</p><blockquote class="mm mn mo"><p id="72e8" class="ki kj mp kk b kl km ju kn ko kp jx kq mq ks kt ku mr kw kx ky ms la lb lc ld im bi translated">简而言之，Firebase可以让你追踪你的用户在应用程序上做了什么(事件)，将其保存在云(实时数据库)上，还可以让你可视化这些数据。</p></blockquote><p id="e091" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一个Firebase分析仪表板的截图。您可以选择查看不同时间段的性能。在仪表盘上，您将获得关于您的活跃用户、他们的参与度(他们在哪个屏幕上花了多长时间)、转化事件(例如，何时进行应用内购买)、您的受众的地理位置、他们的忠诚度、移动平台以及更多详细信息。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mt"><img src="../Images/27fde0db7500476ce6cbd0a0279ae438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eMIIr1T9qkEC12d2P202zA.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">显示实时信息的Firebase分析仪表板</p></figure><h1 id="b5b9" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz nj ka ma kc nk kd mc kf nl kg me mf bi translated">我们所说的事件是什么意思？</h1><p id="d09a" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">正如谷歌的文档所说，事件提供了对你的应用程序中正在发生的事情的洞察，比如用户操作、系统事件或错误。</p><h2 id="0f14" class="nm lp it bd lq nn no dn lu np nq dp ly kr nr ns ma kv nt nu mc kz nv nw me nx bi translated">自动事件</h2><p id="c0f6" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">Firebase会自动跟踪一些事件(和用户属性),例如应用程序安装后首次打开的事件、通知取消事件、操作系统更新或应用程序更新事件等。</p><h2 id="cc04" class="nm lp it bd lq nn no dn lu np nq dp ly kr nr ns ma kv nt nu mc kz nv nw me nx bi translated">自定义事件</h2><p id="69cf" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">除了自动事件之外，开发人员还可以创建自己的事件来跟踪用户活动或系统事件/错误。你的应用程序记录的事件总量没有限制。例如，如果你是一个约会应用程序，当用户在某人身上向右滑动时，或者当用户将搜索偏好从半径5公里更改为500公里时，你可以选择记录事件。如果你是一个电子商务应用程序，你可以选择在用户添加/删除购物车中的商品或者用户结账时记录一个事件。</p><h2 id="9a37" class="nm lp it bd lq nn no dn lu np nq dp ly kr nr ns ma kv nt nu mc kz nv nw me nx bi translated">事件记录</h2><p id="1f66" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">对于每个事件，firebase都允许您跟踪一系列其他相关信息。它们可以被分组为<strong class="kk iu">事件属性</strong>(事件源自哪个屏幕，哪个用户ID被正确刷过，设置了什么新的搜索距离等等。)、<strong class="kk iu">用户属性</strong>(用户ID、年龄、性别等。)、<strong class="kk iu">设备属性</strong>(设备类型、品牌、型号、操作系统、语言等。)、<strong class="kk iu">位置属性</strong>(事件起源的国家、地区、城市等。)、<strong class="kk iu"> app属性</strong> (app版本，安装app的商店)等。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ny"><img src="../Images/13cc0c3dd8364e88a50fcaa42a196773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2HIQYJNoXUIUIK7M60Acdw.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">为此移动应用配置的事件列表</p></figure><p id="58de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您需要Firebase dashboard没有提供的问题的答案，您可以将您的分析数据连接到BigQuery，它允许进行更复杂的分析，如查询大型数据集、与其他数据源连接、创建业务报告等。这就是我们接下来要讨论的。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nz"><img src="../Images/2cfa9a4c23f9d26a1414729c62e006e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-7s_3tfdh3nHE04vxP3m6g.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae ml" href="https://pixabay.com/images/id-2156083/" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><h1 id="5d63" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz nj ka ma kc nk kd mc kf nl kg me mf bi translated">将数据带到BigQuery</h1><p id="9478" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">由于您希望将原始数据从Firebase导入BigQuery，您可能会对进行用户级分析感兴趣，为此，您必须添加用户ID，以便跨平台和设备跟踪用户。为什么？</p><p id="3031" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Firebase不会识别您平台上的唯一用户。它所做的只是跟踪名为user_pseudo_id的唯一应用实例的活动。这意味着，如果你卸载并重新安装你的约会应用程序，如果你更换了你的设备，或者如果你正在使用来自同一个提供商的多个应用程序，Firebase不会自动通知这只是一个用户。为了能够在您的平台上识别个人，您需要自己为他们设置用户id。设置用户ID后，您的所有活动都将自动标记为该值。</p><p id="1a30" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">问题！如何设置用户ID？如何将Firebase中的数据连接到BigQuery？<br/>回答——作为一名数据科学家，你不会做这种事。应用程序开发人员能够更好地为您完成这一切。这是来自Google的指南，他们可以用它将Firebase数据连接到BigQuery。既然我们已经将原始数据推送到BQ中，那么让我们跳到BigQuery上来看看如何使用它！</p><h1 id="fe4b" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz nj ka ma kc nk kd mc kf nl kg me mf bi translated">BigQuery中的原始事件导出</h1><p id="160e" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated"><em class="mp">(我知道看起来很吓人:p) </em></p><p id="0fcd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我从未见过有重复记录的表格，而这张就是。关于导出的数据，需要知道一些事情</p><ul class=""><li id="f6f1" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld of og oh oi bi translated">在将一个BQ项目与firebase链接之后，第一次导出会创建一个名为analytics_xxx的数据集，其中x表示您的分析属性ID(不要担心这一点)。</li></ul><figure class="mu mv mw mx gt my gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/574ed04ad9956452e4ecfea785cd0f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*xDWsKee_SvOXPwFQ9QqDZw.png"/></div></figure><ul class=""><li id="242c" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld of og oh oi bi translated">在这个数据集中，每天导出一个名为events_YYYYMMDD的表(按日期分区的BQ表)</li><li id="bb83" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld of og oh oi bi translated">您还会看到一个events_intraday_ <date>表，这是一个用今天的原始事件更新的实时表。</date></li><li id="a4ff" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld of og oh oi bi translated">因为表是按天划分的，所以您可以查询某一天的单个表，也可以使用<code class="fe op oq or os b">FROM analytics_xxxxxxxxx.events_20200131 <strong class="kk iu">OR</strong><br/> FROM analytics_xxxxxxxxx.events_* <br/> WHERE _table_suffix BETWEEN ‘20190201’ AND ‘20200131’</code>过滤多个表</li><li id="c7f5" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld of og oh oi bi translated">这些表是事件级表，具有事件属性、用户属性、设备属性等的重复记录。这意味着，对于每个事件，将有多个事件属性被保存为键、值对(数组)而不是平面表格式，如下所示。</li></ul><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ot"><img src="../Images/4dc3d0b7e8e92f9b483993f94fedff74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L-4Rcl4ucst0Tq2BfqU3Gg.png"/></div></div></figure><p id="3cc3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于这种结构，会发生两件事，</p><ul class=""><li id="6bdc" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld of og oh oi bi translated">您将无法使用常规SQL查询数据库。例如，当您想要为user_gender属性过滤您的雇佣事件时，您将不能简单地编写<strong class="kk iu"> </strong> <code class="fe op oq or os b"><strong class="kk iu">where user_gender = ‘Male’</strong></code></li><li id="b209" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld of og oh oi bi translated">你不能将这种表格结构导出到Google Sheets或者你的本地。</li></ul><p id="c302" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了处理这种表格格式，让我们讨论一些查询风格和功能。</p><h2 id="8a98" class="nm lp it bd lq nn no dn lu np nq dp ly kr nr ns ma kv nt nu mc kz nv nw me nx bi translated">UNNEST函数</h2><p id="c6a5" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">正如您可能已经猜到的那样，unnest函数有助于使我们混乱的(起初)表格变平。<code class="fe op oq or os b"><strong class="kk iu">UNNEST</strong></code>函数获取一个数组，并将其分解成每个单独的元素。例如，计算1月20日这一周应用程序中男性用户数量的查询将类似于-</p><pre class="mu mv mw mx gt ou os ov ow aw ox bi"><span id="20df" class="nm lp it os b gy oy oz l pa pb">SELECT count(DISTINCT user_id) FROM <br/> (SELECT user_id,<br/> (SELECT value.string_value FROM UNNEST(user_properties) WHERE key = “user_gender”) AS gender<br/> FROM analytics_xxxxxxxxx.events_*`<br/> WHERE _table_suffix BETWEEN ‘20200120’ AND ‘20200126’<br/> )<br/> WHERE gender = “Male”</span></pre><p id="0d80" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，<code class="fe op oq or os b"><strong class="kk iu">UNNEST</strong></code>函数获取了数组user_properties并展开了它。然后，从用户属性的所有键、值对中，我们过滤了user_gender，并提取了保存了“男性”和“女性”的字符串值。我们将这个提取称为性别，然后在封闭查询中过滤掉男性<em class="mp">和男性</em>。</p><h2 id="52de" class="nm lp it bd lq nn no dn lu np nq dp ly kr nr ns ma kv nt nu mc kz nv nw me nx bi translated">WITH … AS样式中的复杂查询</h2><p id="724f" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">当创建一个包含多个步骤的报告时，比如说在计算保留时，你需要创建一些中间表格，然后才能最终编写<code class="fe op oq or os b">select users, their day-7 retention for a period of 30 days from table x</code></p><p id="321c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，BigQuery不是SAS或Python，您可以编写多个步骤并同时运行它们。该平台一次只运行一个查询。所以为你的拯救干杯..作为风格。它允许您使用表别名在同一个查询中创建多个表。例如保留率-</p><pre class="mu mv mw mx gt ou os ov ow aw ox bi"><span id="4772" class="nm lp it os b gy oy oz l pa pb">with<br/>cohort_items as<br/> (SELECT user_pseudo_id,<br/> MIN( TIMESTAMP_TRUNC(TIMESTAMP_MICROS(event_timestamp), DAY)) as cohort_day<br/> FROM analytics_xxx.events_*<br/> WHERE _table_suffix BETWEEN ‘20170101’ AND ‘20191231’<br/> AND event_name = ‘first_open’<br/> GROUP BY 1<br/> ),<br/> <br/>user_activites AS <br/>(<br/>SELECT A.user_pseudo_id, DATE(C.cohort_day) as cohort_day,<br/>DATE_DIFF(DATE(TIMESTAMP_TRUNC(TIMESTAMP_MICROS(event_timestamp), DAY)), DATE(C.cohort_day), DAY) AS day_number <br/>FROM analytics_xxx.events_* A<br/>LEFT JOIN cohort_items C ON A.user_pseudo_id = C.user_pseudo_id<br/>WHERE _table_suffix BETWEEN ‘20170101’ AND ‘20191231’<br/>GROUP BY 1,2,3),</span><span id="8764" class="nm lp it os b gy pc oz l pa pb">cohort_size AS  ( SELECT cohort_day, count(1) as number_of_users FROM cohort_items GROUP BY 1 ),</span><span id="e0c7" class="nm lp it os b gy pc oz l pa pb">retention_table AS<br/>(<br/>SELECT C.cohort_day, A.day_number, COUNT(1) AS number_of_users<br/>FROM user_activites A<br/>LEFT JOIN cohort_items C <br/>ON A.user_pseudo_id = C.user_pseudo_id<br/>GROUP BY 1,2<br/>)</span><span id="e7fe" class="nm lp it os b gy pc oz l pa pb">SELECT<br/>B.cohort_day, ifnull(B.number_of_users,0) as total_users,<br/>B.day_number, safe_divide((ifnull(B.number_of_users,0)), S.number_of_users) as retention,<br/>FROM retention_table B<br/>LEFT JOIN cohort_size S ON B.cohort_day = S.cohort_day<br/>WHERE B.cohort_day IS NOT NULL and B.day_number &gt;= 0 and B.day_number &lt; 31<br/>)</span></pre><p id="98af" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我们创建了3个中间表，分别名为cohort_items、user_activities和retention_table，然后我们可以使用它们来聚合并获得最终的保留表。</p><p id="9d16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">cohort_items —根据用户首次打开应用程序的日期确定新用户群组</p><p id="949f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">user_activities —对于这些已识别的用户，获取他们在应用程序上的日常活动。如果一个用户在firebase上记录了单个事件，我们认为他们在那天是活动的。</p><p id="c97c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">retention_table —在天级别(cohort_day)聚合上表，并确定每天(day_number)在第0天、第1天、第7天保留了多少用户。。。直到第n天。</p><p id="8e62" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，在最后一个select语句中，我们计算每个群组day和day_number组合的保留百分比，并且只保留第0天到第30天的保留。</p><h1 id="15c3" class="lo lp it bd lq lr ls lt lu lv lw lx ly jz nj ka ma kc nk kd mc kf nl kg me mf bi translated">一些最佳实践</h1><p id="2c29" class="pw-post-body-paragraph ki kj it kk b kl mg ju kn ko mh jx kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">在您开始使用BigQuery中导出的数据创建报告后，您将会遇到分析和您的报告之间的差异。您可以使用以下最佳实践来获得更好的结果:</p><ol class=""><li id="f407" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld pd og oh oi bi translated">使用特定日期的表，而不是在WHERE子句中对事件时间戳使用日期比较。事件时间戳基于客户端设备时间，而客户端设备时间通常是不准确的。</li><li id="c4e6" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld pd og oh oi bi translated">不要比较像session_start或user_engagement这样频繁触发的事件。</li><li id="3524" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld pd og oh oi bi translated">如果任何查询耗尽了分配的资源，请删除ORDER BY子句，因为这是一个开销非常大的操作，并且不能并行处理，所以请尽量避免(或者尝试在有限的结果集中应用它)</li><li id="54da" class="oa ob it kk b kl ok ko ol kr om kv on kz oo ld pd og oh oi bi translated">总是获得过去3天的报告，以便从GA4F导出到BigQuery的数据得到规范化。数据每天只导出到BigQuery一次。因此，包含最近三天的查询将在Firebase Analytics和BigQuery之间显示不同的结果。</li></ol></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><p id="9903" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望这篇文章能帮助你了解一些关于Firebase Analytics的知识。在这篇文章之后会有更多的文章讨论更具体的任务，如使用事件数据来绘制用户行为，创建用户旅程等。</p><p id="c9bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您有任何问题/建议，请随时提出您的意见，并通过<a class="ae ml" href="https://www.linkedin.com/in/kritikajalan/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae ml" href="https://twitter.com/Kritika_Jalan" rel="noopener ugc nofollow" target="_blank"> Twitter </a>与我联系</p></div></div>    
</body>
</html>