# 用 LSTM 神经网络预测南福克帕耶特河的流量

> 原文：<https://towardsdatascience.com/predicting-the-flow-of-the-south-fork-payette-river-using-an-lstm-neural-network-65292eadf6a6?source=collection_archive---------41----------------------->

## 如何使用机器学习对时间序列数据进行预测。

![](img/829823c0eee79af3dd3d6d0aabd8c02e.png)

爱达荷州有一些世界上最美丽的河流！（📷威尔·斯托弗-诺里斯|东岔口南岔口萨蒙河)

# TL；博士:

我制作了一个 LSTM 神经网络模型，它使用 30 多年的天气和河流流量数据来相当准确地预测明天的河流流量。

# 河流预报的问题是

![](img/1b1c1a48857526fea6ed8790b0e1323e.png)

水遇到爱达荷花岗岩。📷威尔·斯托弗·诺里斯

我从事数据科学的主要原因是将它应用于现实世界的问题。作为一名皮划艇运动员，我花了很多很多时间研究天气预报、水文预报和斯诺特尔站的数据，以预测河流的流量。有很多好地方可以进行这种预测——NOAA 在全国各大河流流域都设有预测中心，包括南福克。

但是，这些预测往往达不到预期。特别是，我注意到预报容易受到重大降雨事件的影响(众所周知，太平洋西北部的河流很难预测)，预报通常每天只发布一次或两次，这通常不够频繁，无法对快速变化的山区天气预报做出反应。美国国家海洋和大气管理局也只对一组选定的河流进行预报。如果你想要一个更小或更偏远的流域的预报，即使它被测量了，你也不走运。

因此，我开始着手创建一个模型，这个模型将达到或超过 NOAA 的预测，并为 NOAA 没有覆盖的一些流域建立模型。

首先，我将我的模型与由[上游技术](https://hydroforecast.com/case-study-south-payette)创建的行业标准模型进行对比。

南福克帕耶特是一个很好的起点，有几个原因:

1.  Lowman 上方的南岔口没有筑坝，因此避免了储层的混杂变量。
2.  美国地质调查局在南福克操作一个计量器，国家海洋和大气管理局有气象站和河流预报，在盆地里有 SNOTEL 站点。首先有许多容易获取的数据。
3.  我曾经在帕耶特教过皮划艇，我几乎划过河流系统的每个部分，所以我很了解这个地区及其水文！

![](img/36d0c26a4e1f564afb5dd6ceb7930c78.png)

帕耶特的北叉是皮划艇运动员中的传奇。📷威尔·斯托弗·诺里斯

![](img/109c4191abe6a25ebe94ac805081a25d.png)

爱达荷州的河流总是不断变化。📷威尔·斯托弗·诺里斯

# 数据

我比较的上游技术模型使用气象和遥感数据来建立模型。我还没有加入任何卫星图像，尽管这是我的模型的下一个发展。

首先，我从位于南福克源头的班纳萨米特气象站下载了 NOAA 的每日气象数据。最终，我会将更多的站点合并到我的预测中，但是我想在第一次迭代中保持简单。测量的指标有:

*   沉淀
*   温度(最低和最高)
*   积雪深度
*   雪水当量
*   一年中的某一天。

这些是我的预测特征。数据可以追溯到 1987 年。

接下来，我去了位于爱达荷州洛曼的[美国地质勘探局测量站，获取了自 1987 年以来每天的流量。在一个更精确的模型中，我可能得到每小时的数据，但是我认为每天的数据对于这个迭代来说已经足够了。](https://waterdata.usgs.gov/usa/nwis/uv?13235000)

![](img/09ab8539bd2e381af76a47911c4cd738.png)

1987-2020 年 Lowman 南福克帕耶特的 CFS 排放

![](img/8c28ac4861b889a76fa26df9ae5c0a12.png)

落基山脉的河流除了用于水力发电和灌溉外，还用于娱乐。📷威尔·斯托弗·诺里斯

# 争论

我用 pandas 合并了两个数据集，创建了一个包含特征和目标变量(流量)的数据框架。

气象数据中有一些缺失值，所以我用一些值来代替 NaNs。我创建了一个关联矩阵来查看是否有任何值是相关的，可以被删除。我决定去掉平均温度读数，因为已经有了最低和最高温度特征。

清理完数据后，是时候开始建模了。

![](img/599c31de43f7dc20efacbe620d23653b.png)

美国西部的水是精确到最后一滴的。📷威尔·斯托弗·诺里斯

# 模型

我从一个基线开始——如果你只是猜测每次南福克的平均流量——大约 800 CFS——会发生什么？结果发现平均误差约为 600 CFS。这是不可接受的大，因为它几乎是河流本身的流量！

我知道我可以做得更好，好得多。

![](img/79c42441017d75860cd5e417ff937ca0.png)

红线是大约 800 CFS 的基线预测。时间是 2019 年。

# 线性回归

线性回归非常简单，但也是一个不错的起点。我用了一个，然后两个，然后所有的特征，看看他们能多好地预测南汊的流量。答案是——非常糟糕。

![](img/c0c2164bb1acc7d4c00db5defdebb59e.png)

基于“一年中的某一天”特征的单一特征线性回归只是一条每年重置的斜线。不太有用。

![](img/ff6719a780b261df21199bd0b93effd8.png)

双特征线性回归(基于“一年中的某一天”和“温度”)稍有细微差别。

![](img/1ebbbc4417c8a2075ad145e0dad4840e.png)

在线性回归中使用所有八个特征并没有好到哪里去。

# 随机森林

好吧，所以线性回归不被认为是最强大的机器学习模型。是时候展示一些更复杂的东西了。我把所有的特征放在一个随机的森林模型中。我本来可以花更长的时间来调整超参数，但我决定只使用股票 scikit-learn 设置，例外情况是使用 100 个估计器。

结果是一个惊人的改进——随机森林没有完全捕捉到径流的细微差别，但它确实比线性回归更好地跟踪了一般的季节趋势。

![](img/9a9d847138d6ef8bdf88dbe2b7e7d4fc.png)

一个随机森林模型——越来越接近一个像样的预测！

![](img/0153807ea69452c6d56a159606320e21.png)

锯齿山脉，南福克帕耶特的源头。📷威尔·斯托弗·诺里斯

# LSTM 神经网络

现在是最新、最大、最糟糕的模型——神经网络的时候了。LSTM 神经网络可用于时间序列预测，尽管它们有一些局限性。我用的是 LSTM 的模型。

这个模型有一些怪癖——你必须以一种非常特定的方式争论数据才能使它适合——我发现了一些非常有价值的教程(Keras 文档和[机器学习大师](https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/))。

我在 1987 年至 2015 年期间训练了模型，并在 2016 年至 2020 年期间对其进行了评估。在以后的迭代中，我将更多地研究时间序列数据的更好的验证技术，比如嵌套的交叉验证。

最终，我设法得到了一个 R 值为 98%、平均绝对误差仅为~50 cfs 的模型！这比我试过的其他(相当简单的)型号好得多。

![](img/58b183853d76dbf55110c9102a651fc9.png)

我的模型性能随着时间的推移。LSTM 是明显的赢家！

最疯狂的是，我甚至没有将任何其他气象站或遥感数据纳入神经网络。

我怀疑前一天的流量对预测的贡献最大，因为预测的峰值似乎比实际峰值滞后一天左右。

我想对 LSTM 到底是如何得出预测的进行更多的调查，并可视化特征的重要性。

![](img/bb2a0502b4274451b591cedf02738b9a.png)

我的 2019 年春季决选 LSTM 模型(提前一天)。

![](img/0fb15b65ae91646db2378f60451008d1.png)

就像爱达荷的穷乡僻壤一样，机器学习总有更多的东西可以探索。📷威尔·斯托弗·诺里斯

# 后续步骤

尽管我的模型在一天前表现得相当好，但我想在更长的预测范围内(2-10 天)对流量建模。我已经开始用 LSTM 做这个了，但是我需要花更多的时间。

我还想合并更多的气象站。NOAA 在该地区运营着几个站点，观察站点在分水岭的位置如何改变预测将会非常有趣。

我还想把卫星图像作为一个功能。这要复杂得多，因为文件很大，而且首先要获取图像。我已经开始建立一个管道，将谷歌地球引擎数据吸收到我的机器学习模型中。

最后，看看这个模型，它能够很好地预测过程线的下降段——但我也可以，只是凭直觉。该模型不太能够预测由于快速融雪或降雨事件导致的突然上升。在这些事件中，预测对于水电、防洪和公共安全至关重要。

一如既往，有更多的工作要做！

感谢您的阅读，请继续关注第 2 部分，在那里我将介绍一些后续步骤，尤其是合并卫星图像。

关于我的最新预测，请查看 [rivers.fyi，](http://www.rivers.fyi)我正在将 LSTM 神经网络投入多条河流的生产。

你可以在这里查看我在 Github [上用过的笔记本。](https://github.com/willstauffernorris/streamflow_predictions)