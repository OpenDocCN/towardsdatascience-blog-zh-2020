<html>
<head>
<title>Scale Your Data Pipelines with Airflow and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用气流和 Kubernetes 扩展您的数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/scale-your-data-pipelines-with-airflow-and-kubernetes-4d34b0af045?source=collection_archive---------9-----------------------#2020-03-17">https://towardsdatascience.com/scale-your-data-pipelines-with-airflow-and-kubernetes-4d34b0af045?source=collection_archive---------9-----------------------#2020-03-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2f23" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">完美的气流设置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bb326f515ccca3f469a03b8565f550d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*reDmcXh4cMdYC5oAq5_btw.png"/></div></div></figure><p id="dc3f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不管你是在运行后台任务、预处理作业还是 ML 管道。编写任务是容易的部分。最难的部分是流程编排——管理任务之间的依赖关系、安排工作流并监控它们的执行是一件非常繁琐的事情。</p><p id="5b56" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">输入<strong class="kw iu">气流</strong>。您的新工作流管理平台。</p><h1 id="cb4f" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">为什么是气流？</h1><p id="4eec" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">几年前，在<a class="ae mn" href="https://medium.com/hackernoon/https-medium-com-talperetz24-scaling-effectively-when-kubernetes-met-celery-e6abd7ce4fed" rel="noopener">有效扩展:当 Kubernetes 遇到 Celery </a>时，我写了我自己使用 Flask、Celery 和 Kubernetes 实现的工作流引擎。我考虑了可用的解决方案——包括气流。由于看不到令人满意的解决方案，我决定实现自己的框架。从那时起，气流已经走过了漫长的道路。以下是我改用气流的原因:</p><h2 id="65fc" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">可攀登的</h2><p id="8325" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">当使用正确的设置时，也就是我们将要看到的设置，气流既可扩展又具有成本效益。</p><h2 id="bd32" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">含电池</h2><p id="fb9a" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">虽然 UI 并不完美，但它是 Airflow 的核心竞争力之一。在这种情况下，一张图片胜过千言万语-</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/582137fefafeb105358a1826a1850f11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wznY_eculO_YwTc5BJfOuQ.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">气流 UI</p></figure><p id="a963" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">无论是以<a class="ae mn" href="https://airflow.apache.org/docs/stable/_api/airflow/operators/index.html" rel="noopener ugc nofollow" target="_blank">操作符</a>的形式还是以<a class="ae mn" href="https://airflow.apache.org/docs/stable/_api/airflow/executors/index.html" rel="noopener ugc nofollow" target="_blank">执行器</a>的形式，Airflow 都有大量的集成。</p><p id="c8c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以及一个实验性但不可或缺的用于工作流的 REST API，这意味着你可以动态地触发工作流。</p><h2 id="451c" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">经过战斗考验</h2><p id="5df2" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">有这么多公司使用气流，我可以放心知道它会不断改善。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/717c6ad2974f0e89751a304af3a59d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S69kvgtMI_JRx2jPR7fOJA.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">正在使用气流</p></figure><h1 id="614b" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">完美的气流设置</h1><h2 id="0aef" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">🔥一次性基础设施</h2><p id="02ca" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">使用 helm 和一些预制的命令，我们可以轻松地破坏和重新部署整个基础架构。</p><h2 id="8983" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">🚀经济高效的执行</h2><p id="cfc7" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我们使用 kubernetes 作为任务的引擎。Airflow scheduler 将在新的 pod 上运行每个任务，并在完成后将其删除。允许我们使用最少的资源根据工作负载进行扩展。</p><h2 id="efa9" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">🔩解耦编排</h2><p id="137f" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">使用 Kubernetes 作为任务运行器的另一个巨大优势是——将编排与执行分离。你可以在<a class="ae mn" href="https://medium.com/bluecore-engineering/were-all-using-airflow-wrong-and-how-to-fix-it-a56f14cb0753" rel="noopener">中了解更多信息，我们都在错误地使用气流，以及如何修复它</a>。</p><h2 id="e987" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">🏃动态更新的工作流程</h2><p id="33c4" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我们使用 Git-Sync 容器。这将允许我们单独使用 git 来更新工作流。无需在每次工作流程变更时重新部署气流。</p><h1 id="6bd7" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">气流执行选项</h1><h2 id="1f17" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">CeleryExecutor+KubernetesPodOperator(推荐)</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/8673d72daf0a0f2859b2501b2cfee8e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1YCb1EoEN-cI95KapWl9nA.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">更多 Pods |指定 Docker 映像中的执行代码</p></figure><p id="d952" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">编排和执行的➕解耦。<br/> ➖为芹菜工人提供额外的豆荚和花卉监测。</p><h2 id="9bb1" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">kubernetexecutor+whatever operator</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/11780bae684bd1091c753813e7b5240d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFPdBtaI_MYfCRXxgetQSw.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">更少的窗格| Dag 中定义的代码</p></figure><p id="ca67" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">➕没有多余的豆荚。<br/> ➖弱解耦。我们必须在 Dag 中定义执行代码和依赖关系。</p><h2 id="6757" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">kubernetexecutor+KubernetesPodOperator</h2><p id="37f5" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">➕没有多余的豆荚。<br/> ➕将编排和执行解耦。<br/> ➖ <strong class="kw iu">不支持</strong> —当前导致 pod 启动递归。</p><h1 id="70fa" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">让我们设置它</h1><h2 id="bcdc" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">先决条件</h2><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="0ea6" class="mo lr it nj b gy nn no l np nq">brew install kubectl<br/>brew install helm</span></pre><p id="e754" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">确保你有:</p><ul class=""><li id="a02a" class="nr ns it kw b kx ky la lb ld nt lh nu ll nv lp nw nx ny nz bi translated"><a class="ae mn" href="https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html" rel="noopener ugc nofollow" target="_blank">配置到您的 EKS 集群</a>的 kubectl 上下文。</li><li id="45c1" class="nr ns it kw b kx oa la ob ld oc lh od ll oe lp nw nx ny nz bi translated">一个<a class="ae mn" href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html" rel="noopener ugc nofollow" target="_blank">带自动缩放器</a>的 Kubernetes 集群组。</li><li id="2337" class="nr ns it kw b kx oa la ob ld oc lh od ll oe lp nw nx ny nz bi translated"><a class="ae mn" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/repository-create.html" rel="noopener ugc nofollow" target="_blank">docker 图像的 ECR 储存库</a>。</li></ul><p id="d472" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">还建议<a class="ae mn" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-cluster-kubernetes-dashboard/" rel="noopener ugc nofollow" target="_blank">设置 Kubernetes 仪表板</a>。</p><h2 id="c11f" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">设置</h2><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="675c" class="mo lr it nj b gy nn no l np nq">cookiecutter https://github.com/talperetz/scalable-airflow-template</span></pre><p id="1b96" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要填写 cookiecutter 选项，请查看<a class="ae mn" href="https://github.com/talperetz/scalable-airflow-template" rel="noopener ugc nofollow" target="_blank">可扩展气流模板 github repo </a>。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="9aed" class="mo lr it nj b gy nn no l np nq">make deploy</span></pre><p id="9637" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">瞧🎉</p><h1 id="dc04" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">作为 Docker 图像的任务</h1><p id="ccde" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我使用 docker 图像，因为我可以将气流从它运行的实际任务中分离出来。我可以在不改变气流配置、代码或部署的情况下改变底层任务。</p><p id="bf36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当构建图像时，我从<a class="ae mn" href="https://github.com/talperetz/python-cli-template" rel="noopener ugc nofollow" target="_blank"> python-cli-template </a>开始，它提供了快速而直观的 cli 体验。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/f8bbc45eaffa772a34d5d2d8d072cf8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QjF9b_dY-O3mo5S-8a87og.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">Github 上的 Python CLI 模板</p></figure><h2 id="eab3" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">工作流程示例</h2><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="6eca" class="mo lr it nj b gy nn no l np nq">from datetime import datetime, timedelta<br/><br/>from airflow import DAG<br/>from airflow.contrib.operators.kubernetes_pod_operator import KubernetesPodOperator<br/><br/>default_args = {<br/>    "owner": "airflow",<br/>    "depends_on_past": False,<br/>    "start_date": datetime(2015, 6, 1),<br/>    "email": ["airflow@airflow.com"],<br/>    "email_on_failure": False,<br/>    "email_on_retry": False,<br/>    "retries": 1,<br/>    "retry_delay": timedelta(minutes=5),<br/>}<br/><br/>example_workflow = DAG('kube-operator',<br/>                         default_args=default_args,<br/>                         schedule_interval=timedelta(days=1))<br/>with example_workflow:<br/>    t1 = KubernetesPodOperator(namespace='airflow',<br/>                               image="ubuntu:16.04",<br/>                               cmds=["bash", "-cx"],<br/>                               arguments=["echo", "hello world"],<br/>                               labels={'runner': 'airflow'},<br/>                               name="pod1",<br/>                               task_id='pod1',<br/>                               is_delete_operator_pod=True,<br/>                               hostnetwork=False,<br/>                               )<br/><br/>    t2 = KubernetesPodOperator(namespace='airflow',<br/>                               image="ubuntu:16.04",<br/>                               cmds=["bash", "-cx"],<br/>                               arguments=["echo", "hello world"],<br/>                               labels={'runner': 'airflow'},<br/>                               name="pod2",<br/>                               task_id='pod2',<br/>                               is_delete_operator_pod=True,<br/>                               hostnetwork=False,<br/>                               )<br/><br/>    t3 = KubernetesPodOperator(namespace='airflow',<br/>                               image="ubuntu:16.04",<br/>                               cmds=["bash", "-cx"],<br/>                               arguments=["echo", "hello world"],<br/>                               labels={'runner': 'airflow'},<br/>                               name="pod3",<br/>                               task_id='pod3',<br/>                               is_delete_operator_pod=True,<br/>                               hostnetwork=False,<br/>                               )<br/><br/>    t4 = KubernetesPodOperator(namespace='airflow',<br/>                               image="ubuntu:16.04",<br/>                               cmds=["bash", "-cx"],<br/>                               arguments=["echo", "hello world"],<br/>                               labels={'runner': 'airflow'},<br/>                               name="pod4",<br/>                               task_id='pod4',<br/>                               is_delete_operator_pod=True,<br/>                               hostnetwork=False,<br/>                               )<br/><br/>    t1 &gt;&gt; [t2, t3] &gt;&gt; t4</span></pre><h1 id="7677" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">高级气流</h1><ul class=""><li id="0303" class="nr ns it kw b kx mi la mj ld og lh oh ll oi lp nw nx ny nz bi translated"><a class="ae mn" href="https://blog.twitter.com/engineering/en_us/topics/insights/2018/ml-workflows.html" rel="noopener ugc nofollow" target="_blank">Twitter 中的 ML 工作流</a></li><li id="9851" class="nr ns it kw b kx oa la ob ld oc lh od ll oe lp nw nx ny nz bi translated">在网飞安排笔记本</li><li id="73ad" class="nr ns it kw b kx oa la ob ld oc lh od ll oe lp nw nx ny nz bi translated"><a class="ae mn" href="https://medium.com/datareply/airflow-lesser-known-tips-tricks-and-best-practises-cf4d4a90f8f" rel="noopener">气流提示&amp;招数</a></li></ul><h2 id="5b25" class="mo lr it bd ls mp mq dn lw mr ms dp ma ld mt mu mc lh mv mw me ll mx my mg mz bi translated">如果你喜欢这篇文章，一定要关注我:</h2><p id="5603" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated"><strong class="kw iu">中:</strong><a class="ae mn" href="https://medium.com/@talperetz24" rel="noopener"><strong class="kw iu">https://medium.com/@talperetz24</strong></a><strong class="kw iu"><br/>推特:</strong><a class="ae mn" href="https://twitter.com/talperetz24" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">https://twitter.com/talperetz24</strong></a><strong class="kw iu"><br/>领英:</strong><a class="ae mn" href="https://www.linkedin.com/in/tal-per/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">https://www.linkedin.com/in/tal-per/</strong></a></p></div></div>    
</body>
</html>