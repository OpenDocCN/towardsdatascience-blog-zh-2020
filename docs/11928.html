<html>
<head>
<title>How to tune Pytorch Lightning hyperparameters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何调整 Pytorch 闪电超参数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-tune-pytorch-lightning-hyperparameters-80089a281646?source=collection_archive---------4-----------------------#2020-08-18">https://towardsdatascience.com/how-to-tune-pytorch-lightning-hyperparameters-80089a281646?source=collection_archive---------4-----------------------#2020-08-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="75f3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">想知道如何用 30 行代码优化 Pytorch Lightning 超参数？</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/1f1e060ecfbb3f6b4cdb2d9ea8b8db63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DnX6uxo7g5-LFzXGpESH4g.png"/></div></div></figure><p id="5b0f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Pytorch Lightning 是 2020 年最热门的人工智能库之一，它使人工智能研究可扩展并快速迭代。但是如果你使用 Pytorch Lightning，你需要做<strong class="kx iu">超参数调整</strong>。</p><p id="30bc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">正确的超参数调整可以决定训练的成功与否。每个人都知道，通过良好的调优方法，可以极大地提高模型的准确性！</p><p id="a045" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在这篇博文中，我们将演示如何使用 PyTorch Lightning 使用<a class="ae lr" href="https://docs.ray.io/en/latest/tune.html" rel="noopener ugc nofollow" target="_blank"> Ray Tune，这是一种超参数调整的行业标准</a>。<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank"> Ray Tune </a>是<a class="ae lr" href="https://ray.io/" rel="noopener ugc nofollow" target="_blank"> Ray </a>的一部分，是一个用于缩放 Python 的库。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/0203e346632ddea2b93941d1460d4c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*aBs5S6cV6xTDBFExnbXybw.png"/></div></figure><p id="cf9b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">它以 PyPI 包的形式提供，可以这样安装:</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="cf79" class="ly lz it lu b gy ma mb l mc md">pip install "ray[tune]"</span></pre><p id="c395" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">要使用 PyTorch Lightning 的<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank"> Ray Tune </a>，我们<strong class="kx iu">只需要添加几行代码！！</strong></p><h1 id="5efd" class="me lz it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">雷调+ PTL 入门！</h1><p id="d816" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">要运行这篇博文中的代码，请确保首先运行:</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="a97a" class="ly lz it lu b gy ma mb l mc md">pip install "ray[tune]" <br/>pip install "pytorch-lightning&gt;=1.0" <br/>pip install "pytorch-lightning-bolts&gt;=0.2.5"</span></pre><p id="9150" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><em class="na">下面的例子是在 ray==1.0.1，pytorch-lightning==1.0.2，pytorch-lightning-bolts==0.2.5 上测试的。</em> <a class="ae lr" href="https://github.com/ray-project/ray/blob/releases/1.0.1/python/ray/tune/examples/mnist_ptl_mini.py" rel="noopener ugc nofollow" target="_blank"> <strong class="kx iu">参见此处完整示例。</strong> </a></p><p id="650b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">先从一些进口说起:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="6868" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">导入之后，有三个简单的步骤。</p><ol class=""><li id="840c" class="nd ne it kx b ky kz lb lc le nf li ng lm nh lq ni nj nk nl bi translated">创建您的<code class="fe nm nn no lu b">LightningModule</code></li><li id="0805" class="nd ne it kx b ky np lb nq le nr li ns lm nt lq ni nj nk nl bi translated">创建一个用调优回调函数调用<code class="fe nm nn no lu b">Trainer.fit</code>的函数</li><li id="5b73" class="nd ne it kx b ky np lb nq le nr li ns lm nt lq ni nj nk nl bi translated">使用<code class="fe nm nn no lu b">tune.run</code>执行您的超参数搜索。</li></ol><h2 id="3f28" class="ly lz it bd mf nu nv dn mj nw nx dp mn le ny nz mp li oa ob mr lm oc od mt oe bi translated">步骤 1:创建你的照明模块</h2><p id="aaf2" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">第一步，创建你的照明模块。你的<code class="fe nm nn no lu b">LightningModule</code>应该把一个<strong class="kx iu">配置</strong>字典作为初始化的参数。然后，这个字典应该设置您想要调整的模型参数。您的模块可能如下所示:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="039e" class="ly lz it bd mf nu nv dn mj nw nx dp mn le ny nz mp li oa ob mr lm oc od mt oe bi translated">第 2 步:创建一个函数，用 Tune 回调函数调用<code class="fe nm nn no lu b">Trainer.fit</code></h2><p id="4ddd" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">我们将使用回调来与<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">射线调</a>进行通信。回调非常简单:</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="bae4" class="ly lz it lu b gy ma mb l mc md">from ray.tune.integration.pytorch_lightning import TuneReportCallback</span><span id="5d75" class="ly lz it lu b gy of mb l mc md">...<br/>metrics = {"loss": "ptl/val_loss", "acc": "ptl/val_accuracy"}<br/>callbacks = [TuneReportCallback(metrics, on="validation_end")]<br/>trainer = pl.Trainer(... callbacks=callbacks)</span></pre><p id="06b2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这个回调确保了在每个验证时期之后，我们向<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">光线调节</a>报告损失度量。<code class="fe nm nn no lu b">val_loss</code>和<code class="fe nm nn no lu b">val_accuracy</code>键对应于<code class="fe nm nn no lu b">validation_epoch_end</code>方法的返回值。</p><p id="2ca7" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">此外，<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">射线调节</a>将开始许多不同的训练运行。为了创建多个训练运行(用于超参数搜索)，我们需要将训练器调用包装在一个函数中:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="b027" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><code class="fe nm nn no lu b">train_mnist()</code>函数需要一个<code class="fe nm nn no lu b">config</code>字典，然后传递给<code class="fe nm nn no lu b">LightningModule</code>。该配置字典将包含一次评估的超参数值。</p><h2 id="f7a1" class="ly lz it bd mf nu nv dn mj nw nx dp mn le ny nz mp li oa ob mr lm oc od mt oe bi translated">第三步:使用<code class="fe nm nn no lu b">tune.run</code>执行你的超参数搜索。</h2><p id="28e3" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">最后，我们需要调用<code class="fe nm nn no lu b">ray.tune</code>来优化我们的参数。这里，我们的第一步是告诉<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">光线调节</a>哪些值是参数的有效选择。这叫做<a class="ae lr" href="https://docs.ray.io/en/latest/tune/api_docs/search_space.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kx iu">搜索空间</strong> </a>，我们可以这样定义:</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="9363" class="ly lz it lu b gy ma mb l mc md"># Defining a search space!</span><span id="a17d" class="ly lz it lu b gy of mb l mc md">config = {<br/> <strong class="lu iu">"layer_1_size"</strong>: tune.choice([32, 64, 128]),<br/> <strong class="lu iu">"layer_2_size"</strong>: tune.choice([64, 128, 256]),<br/> <strong class="lu iu">"lr"</strong>: tune.loguniform(1e-4, 1e-1),<br/> <strong class="lu iu">"batch_size"</strong>: tune.choice([32, 64, 128])<br/>}</span></pre><p id="3a28" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">让我们快速浏览一下搜索空间。对于第一层和第二层的大小，我们让<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">射线调整</a>在三个不同的固定值之间选择。学习率在<code class="fe nm nn no lu b">0.0001</code>和<code class="fe nm nn no lu b">0.1</code>之间采样。对于批量大小，也给出了三个固定值的选择。当然，还有许多其他的(甚至是定制的)方法可以用来定义搜索空间。</p><p id="107f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">射线调节</a>现在将随机对十个不同的参数组合进行采样，训练它们，然后比较它们的性能。</p><p id="41dd" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们将<code class="fe nm nn no lu b">train_mnist</code>函数包装在<code class="fe nm nn no lu b">tune.with_parameters</code>中，以传递常数，如训练每个模型的最大历元数和每次试验可用的 GPU 数量。<a class="ae lr" href="https://docs.ray.io/en/master/using-ray-with-gpus.html#fractional-gpus" rel="noopener ugc nofollow" target="_blank"> Ray Tune 支持分数 GPU</a>，所以只要模型仍然适合 GPU 内存，类似<code class="fe nm nn no lu b">gpus=0.25</code>的东西完全有效。</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="484b" class="ly lz it lu b gy ma mb l mc md"># Execute the hyperparameter search<br/>analysis = tune.run(<br/> tune.with_parameters(<!-- -->train_mnist_tune<!-- -->, epochs=10, gpus=0),<br/> config=config,<br/> num_samples=10)</span></pre><p id="8cc0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">对<code class="fe nm nn no lu b">tune.run</code>的最终调用如下所示:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="95df" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">最后，优化结果可能如下所示:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="e07d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在这个简单的例子中，一些配置达到了很好的精度。我们观察到的最好结果是在批量大小为 32，层大小为 128 和 64，学习率为 0.001 左右的情况下，验证精度为<strong class="kx iu"> 0.978105 </strong>。我们还可以看到，学习率似乎是影响性能的主要因素——如果学习率太大，运行将无法达到良好的准确性。</p><p id="64cb" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">您可以通过使用<code class="fe nm nn no lu b">tune.run</code>的返回值来检索最佳分数:</p><pre class="kk kl km kn gt lt lu lv lw aw lx bi"><span id="420b" class="ly lz it lu b gy ma mb l mc md">analysis = tune.run(...)</span><span id="f026" class="ly lz it lu b gy of mb l mc md">best_trial = analysis.best_trial  # Get best trial<br/>best_config = analysis.best_config  # Get best trial's hyperparameters<br/>best_logdir = analysis.best_logdir  # Get best trial's logdir<br/>best_checkpoint = analysis.best_checkpoint  # Get best trial's best checkpoint<br/>best_result = analysis.best_result  # Get best trial's last results</span></pre><p id="f4f0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">您还可以轻松利用<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank"> Ray Tune </a>的一些更强大的优化功能。例如，<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank"> Ray Tune </a>的搜索算法可以让你轻松优化超参数组合的景观。Ray Tune 的调度程序还可以尽早停止性能不佳的试验，以节省资源。</p><p id="85db" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><a class="ae lr" href="https://github.com/ray-project/ray/blob/releases/1.0.1/python/ray/tune/examples/mnist_ptl_mini.py" rel="noopener ugc nofollow" target="_blank"> <strong class="kx iu">看完整例子在这里。</strong> </a></p><h2 id="aaef" class="ly lz it bd mf nu nv dn mj nw nx dp mn le ny nz mp li oa ob mr lm oc od mt oe bi translated">在张量板上检查结果</h2><p id="0767" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">Ray Tune 自动将度量标准<a class="ae lr" href="https://docs.ray.io/en/latest/tune/tutorials/tune-usage.html#logging-tensorboard" rel="noopener ugc nofollow" target="_blank">导出到 TensorBoard，</a>中，还可以轻松支持 W &amp; B。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi og"><img src="../Images/77d3621bd14218fee0cfd3469ea56881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dRDhRuVKoXgDgi0zSuYI4A.png"/></div></div></figure><p id="6b50" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">就是这样！</p><h2 id="c162" class="ly lz it bd mf nu nv dn mj nw nx dp mn le ny nz mp li oa ob mr lm oc od mt oe bi translated"><strong class="ak">要用</strong> <a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">射线调</strong> </a> <strong class="ak">启用简单的超参数调，我们只需要添加一个回调，包装好 train 函数，然后开始调。</strong></h2><p id="b180" class="pw-post-body-paragraph kv kw it kx b ky mv ju la lb mw jx ld le mx lg lh li my lk ll lm mz lo lp lq im bi translated">当然，这是一个非常简单的例子，没有利用许多 Ray Tune 的搜索功能，如<a class="ae lr" href="https://docs.ray.io/en/master/tune/api_docs/schedulers.html#hyperband-tune-schedulers-hyperbandscheduler" rel="noopener ugc nofollow" target="_blank">早期停止表现不佳的试验</a>或<a class="ae lr" href="https://docs.ray.io/en/master/tune/api_docs/schedulers.html#population-based-training-tune-schedulers-populationbasedtraining" rel="noopener ugc nofollow" target="_blank">基于人群的培训</a>。如果你想看完整的例子，请看看我们的<a class="ae lr" href="https://docs.ray.io/en/master/tune/tutorials/tune-pytorch-lightning.html" rel="noopener ugc nofollow" target="_blank">完整 PyTorch 闪电教程</a>。</p><p id="5b23" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果你已经成功地使用 py torch Lightning with<a class="ae lr" href="https://docs.ray.io/en/latest/tune/index.html" rel="noopener ugc nofollow" target="_blank">Ray Tune</a>，或者如果你需要任何帮助，请通过<a class="ae lr" href="https://forms.gle/9TSdDYUgxYs8SA9e8" rel="noopener ugc nofollow" target="_blank">加入我们的 Slack </a>或者通过我们的<a class="ae lr" href="https://github.com/ray-project/ray" rel="noopener ugc nofollow" target="_blank"> Github </a>来联系我们——我们希望收到你的来信！</p><h1 id="e1d3" class="me lz it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">如果你喜欢这篇博文，一定要看看:</h1><ul class=""><li id="5a51" class="nd ne it kx b ky mv lb mw le oh li oi lm oj lq ok nj nk nl bi translated">我们的<a class="ae lr" href="https://wandb.ai/amogkam/transformers/reports/Hyperparameter-Optimization-for-Huggingface-Transformers--VmlldzoyMTc2ODI" rel="noopener ugc nofollow" target="_blank">权重和偏差报告</a>针对变压器的超参数优化</li><li id="29f2" class="nd ne it kx b ky np lb nq le nr li ns lm nt lq ok nj nk nl bi translated">从零开始为你的 NLP 模型服务的最简单的方法</li></ul></div></div>    
</body>
</html>