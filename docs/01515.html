<html>
<head>
<title>Life Hack Web Scrapping</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生活帮网络报废</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/life-hack-web-scrapping-c3a4d57766f?source=collection_archive---------35-----------------------#2020-02-10">https://towardsdatascience.com/life-hack-web-scrapping-c3a4d57766f?source=collection_archive---------35-----------------------#2020-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8d97" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">网络报废让我的生活变得简单多了。然而，从大多数网站中提取内容的过程从来没有真正被提及过。这使得处理信息几乎不可能</h2></div><h1 id="5438" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">为什么？</h1><p id="8142" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">网络报废让我的生活变得简单多了。然而，从使用专有系统锁定内容的网站中实际提取内容的过程从未被真正提及。这使得将信息重新格式化成期望的格式即使不是不可能，也是极其困难的。几年来，我发现了几种(几乎)防失败的技术来帮助我，现在我想把它们传递下去。</p><p id="820e" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我将带您了解将纯网络书籍转换为 PDF 的过程。这里的想法是强调如何根据自己的情况复制/修改它！</p><p id="b48f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">如果你有任何其他的技巧(或者有用的脚本)来完成这样的任务，一定要让我知道，因为创建这些生活黑客脚本是一个有趣的爱好！</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/f4ac2fe049480d6b5e2765615cfb38cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QPJncZjpcT-LeH_Z0sPRwA.jpeg"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">封面图片来源于<a class="ae mo" href="https://www.pxfuel.com/en/free-photo-oinlw" rel="noopener ugc nofollow" target="_blank">此处</a></p></figure><h1 id="e814" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">再现性/适用性？</h1><p id="c94d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我列举的例子来自一个只提供学习指南的网站(为了保护他们的安全，我排除了特定的网址)。我概述了几个经常出现在网络废弃时的缺陷/问题！</p><h1 id="dbb1" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">要犯的错误？</h1><p id="6f4d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我在试图搜索受限访问信息时犯了几个错误。每一个错误都消耗<strong class="kz ir">大量</strong>的<strong class="kz ir">时间</strong>和<strong class="kz ir">能量</strong>，所以它们是:</p><ul class=""><li id="f892" class="mp mq iq kz b la lt ld lu lg mr lk ms lo mt ls mu mv mw mx bi translated">使用 AutoHotKey 或类似的来直接影响鼠标/键盘(这种<strong class="kz ir">会产生躲闪</strong> <strong class="kz ir">不一致的行为</strong>)</li><li id="7c5b" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">加载所有页面，然后导出一个 HAR 文件(HAR 文件没有实际数据，需要很长时间才能加载)</li><li id="7372" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">尝试使用 GET/HEAD 请求(大多数页面使用<strong class="kz ir">授权</strong>方法，这实际上是不可逆的)</li></ul><h1 id="c92e" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">进展缓慢</h1><p id="b949" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">为这些网站写一个 300 行的简短脚本似乎很容易/很快，但它们总是比这更困难。以下是解决方案的潜在障碍:</p><ul class=""><li id="470a" class="mp mq iq kz b la lt ld lu lg mr lk ms lo mt ls mu mv mw mx bi translated">Selenium changing 使用的浏览器配置文件</li><li id="0128" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">以编程方式查找配置文件</li><li id="c52a" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">不知道要等多久才能加载链接</li><li id="1dcd" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">当链接<strong class="kz ir">不等于</strong>当前链接<strong class="kz ir">时进行检测</strong></li><li id="cf31" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">或者使用浏览器 JavaScript(可能的话，将在下面详细描述)</li><li id="d009" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">需要找到关于当前网页内容的信息</li><li id="b77b" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">看看潜在的 JavaScript 函数和 URL</li><li id="0a99" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">失败时重新启动长脚本</li><li id="a913" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated"><strong class="kz ir">减少</strong>文件的<strong class="kz ir">查找</strong>次数</li><li id="2322" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">将文件复制到<strong class="kz ir">可预测的位置</strong></li><li id="c4e2" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">在开始做任何复杂的事情之前，检查这些文件</li><li id="e616" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">不知道一个长的脚本是什么</li><li id="cea7" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">打印任何必要的输出(仅用于那些花费大量时间且没有其他度量的输出)</li></ul><h1 id="8b26" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">密码</h1><h2 id="fe61" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">准备工作</h2><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="c865" class="nd kg iq nq b gy nu nv l nw nx">from selenium import webdriver<br/>from selenium.webdriver.common.by import By<br/>from selenium.webdriver.support.ui import WebDriverWait<br/>from PIL import Image<br/>from natsort import natsorted<br/><br/>import time<br/>import re<br/>import os<br/>import shutil<br/>import img2pdf<br/>import hashlib</span><span id="0200" class="nd kg iq nq b gy ny nv l nw nx">driver = webdriver.Firefox()<br/>cacheLocation = driver.capabilities['moz:profile'] + '/cache2/entries/'<br/>originalPath =  os.getcwd()<br/>baseURL = 'https://edunlimited.com'</span></pre><h2 id="c121" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">装载书</h2><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="db38" class="nd kg iq nq b gy nu nv l nw nx">driver.get(loginURL)<br/>driver.get(bookURL)<br/><br/>wait.until(lambda driver: driver.current_url != loginURL)</span></pre><h2 id="2add" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">获取元数据</h2><p id="b503" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">经常可以找到用于提供有用信息的 JavaScript 函数。有几种方法可以做到这一点:</p><ul class=""><li id="c088" class="mp mq iq kz b la lt ld lu lg mr lk ms lo mt ls mu mv mw mx bi translated">查看页面的 HTML 源代码(右键单击“查看页面源代码”)</li><li id="0444" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">使用 web 控制台</li></ul><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="c5cf" class="nd kg iq nq b gy nu nv l nw nx">bookTitle = driver.execute_script('return app.book')<br/>bookPages = driver.execute_script('return app.pageTotal')<br/>bookID = driver.execute_script('return app.book_id')</span></pre><h2 id="a5c9" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">组织文件</h2><p id="69db" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">脚本通常不会按预期执行，有时需要很长时间才能完成。因此，在脚本的迭代过程中保持进度是相当自由的。实现这一点的一个好方法是保持有条理！</p><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="d3c6" class="nd kg iq nq b gy nu nv l nw nx">if not os.path.exists(bookTitle):<br/>        os.mkdir(bookTitle)<br/>    if len(os.listdir(bookTitle)) == 0:<br/>        start = 0<br/>    else:<br/>        start = int(natsorted(os.listdir(bookTitle), reverse=True)[0].replace('.jpg', ''))<br/>        driver.execute_script('app.gotoPage(' + str(start) + ')')<br/><br/>os.chdir(bookTitle)</span></pre><h2 id="1d15" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">浏览这本书</h2><p id="9f5c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">图像总是存储在缓存中，所以当其他方法都失败时，就利用这一点吧！</p><p id="2a21" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">不过这并不容易，首先我们需要加载页面，然后我们需要以某种方式恢复它！</p><p id="86d4" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">为了确保我们总是加载整个页面，有两种安全措施:</p><ul class=""><li id="145d" class="mp mq iq kz b la lt ld lu lg mr lk ms lo mt ls mu mv mw mx bi translated">在移动到下一页之前，等待当前页面加载</li><li id="30e1" class="mp mq iq kz b la my ld mz lg na lk nb lo nc ls mu mv mw mx bi translated">如果<em class="nz">无法加载</em>，则重新加载页面</li></ul><p id="cc4d" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">让这两者工作需要保证完成(JavaScript 或浏览器响应)的函数，以及故障安全等待时间跨度。安全时间跨度是反复试验的，但是通常在 0.5 到 5 秒之间效果最好。</p><p id="ce6d" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">直接从硬盘缓存中恢复特定数据是一个相对模糊的话题。关键是首先找到一个下载链接(通常很容易，因为<strong class="kz ir">不需要工作</strong>)。然后在<strong class="kz ir"> URL </strong>上运行<strong class="kz ir"> SHA1 </strong>、<strong class="kz ir">十六进制摘要</strong>和一个<strong class="kz ir">大写函数</strong>，产生最终的文件名(它<strong class="kz ir">不仅仅是上述安全算法中的一个</strong>，因为旧的来源让你相信，而是两个都有)。</p><p id="de3f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">最后一点，确保现在而不是以后清理数据(从 PNG 图像中删除 alpha 通道),因为它减少了代码中使用的循环次数！</p><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="304e" class="nd kg iq nq b gy nu nv l nw nx">for currentPage in range(start, bookPages - 1):<br/>        <br/>        while driver.execute_script('return app.loading') == True:<br/>            time.sleep(0.5)<br/><br/>        <br/>        <br/>        while (driver.execute_script('return app.pageImg') == '/pagetemp.jpg'):<br/>            driver.execute_script('app.loadPage()')<br/>            time.sleep(4)<br/><br/>        location = driver.execute_script('return app.pageImg')<br/><br/>        <br/>        pageURL = baseURL + location<br/>        fileName = hashlib.sha1((":" + pageURL).encode('utf-8')).hexdigest().upper()<br/>        Image.open(cacheLocation + fileName).convert('RGB').save(str(currentPage) + '.jpg')<br/><br/>        driver.execute_script('app.nextPage()')</span></pre><h2 id="066e" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">转换为 PDF</h2><p id="ea94" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们终于可以得到一个方便的 PDF 文件</p><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="d517" class="nd kg iq nq b gy nu nv l nw nx">finalPath =  originalPath + '/' + bookTitle + '.pdf'<br/><br/><br/>with open(finalPath, 'wb') as f:<br/>    f.write(img2pdf.convert([i for i in natsorted(os.listdir('.')) if i.endswith(".jpg")]))</span></pre><h2 id="74af" class="nd kg iq bd kh ne nf dn kl ng nh dp kp lg ni nj kr lk nk nl kt lo nm nn kv no bi translated">移除多余的图像</h2><pre class="lz ma mb mc gt np nq nr ns aw nt bi"><span id="2d40" class="nd kg iq nq b gy nu nv l nw nx">os.chdir(originalPath)<br/>shutil.rmtree(bookTitle)</span></pre><p id="0c7d" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">封面图片来源于<a class="ae mo" href="https://www.pxfuel.com/en/free-photo-oinlw" rel="noopener ugc nofollow" target="_blank">此处</a></p><h1 id="9c76" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">感谢阅读！</h1><p id="9163" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这基本上是我在博客上发表的第一篇以代码为中心的文章，所以我希望它有用！</p><p id="b261" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">———下次见，我要退出了</p></div></div>    
</body>
</html>