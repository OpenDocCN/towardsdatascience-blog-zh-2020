<html>
<head>
<title>BigQuery + Cloud Functions: how to run your queries as soon as a new Google Analytics table is available</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery +云函数:如何在新的谷歌分析表可用时立即运行查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bigquery-cloud-functions-how-to-run-your-queries-as-soon-as-a-new-google-analytics-table-is-17fbb62f8aaa?source=collection_archive---------1-----------------------#2020-03-27">https://towardsdatascience.com/bigquery-cloud-functions-how-to-run-your-queries-as-soon-as-a-new-google-analytics-table-is-17fbb62f8aaa?source=collection_archive---------1-----------------------#2020-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f8bc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何确保您的表格、仪表板和数据传输始终保持最新的分步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/934b659a36bc8fbb585e15e358248b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VcWWrLv-TCm6_iSK9lkCQw.png"/></div></div></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><p id="9e3a" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果你的谷歌分析视图链接到BigQuery，你可能正在享受它带来的好处。您的数据中没有抽样，您可以引入第三方数据，您对您的数据有更多的控制权等等。</p><p id="7abb" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">但是，有一件事困扰着我。也许这也困扰着你。每天从Google Analytics导出到BigQuery表(ga_sessions_YYYYMMDD)的确切时间可能有些不可预测。这使得在这个数据集上运行计划查询而不冒一点风险是不可能的。</p><ul class=""><li id="c1de" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">您可能过早设置了计划查询。如果由于某种原因，Google Analytics的导出被延迟，您可能会错过一天的数据。每次发生这种情况时，您都必须手动更正。或者你可以考虑使用日内表。但这可能也不理想，因为谷歌声明:“在每日导入完成之前，当天的数据不是最终数据。你可能会注意到日内和每日数据之间的差异”(见文档<a class="ae me" href="https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089" rel="noopener ugc nofollow" target="_blank">这里</a>)。</li><li id="efd2" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated"><em class="md">您可能会将计划查询设置得太晚。在这种情况下，如果出口延迟，你可能是安全的。但是，您的仪表板的基础表和/或向其他数据系统的可能转移可能不像决策者需要的那样是最新的。</em></li></ul><p id="5e93" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">当然，在这个不确定的日冕时代，你可以称之为第一世界的问题。但因为这是一个我可以帮助解决的问题，我将带您一步步地了解如何在Google Analytics新的每日导出准备就绪时运行您的预定查询。结果是一个更加可靠的设置，其中您的表和仪表板总是尽可能地保持最新。</p><p id="734b" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们将采取的步骤是:</p><ol class=""><li id="6a50" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt mk ma mb mc bi translated">在云日志中创建一个过滤器，隔离确认新的Google Analytics表准备就绪的每日日志。</li><li id="8228" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt mk ma mb mc bi translated">设置一个收集这些每日日志的云发布/订阅主题。</li><li id="80a0" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt mk ma mb mc bi translated">部署一个云函数，一旦用新日志更新了发布/订阅主题，它就在BigQuery中运行您的计划查询。</li></ol></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="9bf8" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第一步。云日志记录</h1><ul class=""><li id="e2e3" class="lu lv iq la b lb nd le ne lh nf ll ng lp nh lt lz ma mb mc bi translated">好的。首先要做的是打开<a class="ae me" href="https://console.cloud.google.com/logs" rel="noopener ugc nofollow" target="_blank">云日志</a>。</li><li id="ccf4" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">单击搜索字段右侧的小下拉箭头，选择“转换为高级过滤器”。至少，在我写这篇文章的时候，它还在那里😉。</li><li id="a26e" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">您可以复制/粘贴下面的代码来创建一个过滤器，该过滤器将隔离确认新的Google Analytics表(ga_sessions_YYYYMMDD)已创建的日志。不要忘记在前两行填写您自己的数据集ID和项目ID。</li></ul><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="0e13" class="nn mm iq nj b gy no np l nq nr">protoPayload.serviceData.jobCompletedEvent.job.jobConfiguration.load.destinationTable.datasetId="[REPLACE_WITH_YOUR_DATASET_ID]"</span><span id="4f56" class="nn mm iq nj b gy ns np l nq nr">protoPayload.serviceData.jobCompletedEvent.job.jobConfiguration.load.destinationTable.projectId="REPLACE_WITH_YOUR_PROJECT_ID"</span><span id="ea94" class="nn mm iq nj b gy ns np l nq nr">protoPayload.authenticationInfo.principalEmail="<a class="ae me" href="mailto:analytics-processing-dev@system.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">analytics-processing-dev@system.gserviceaccount.com</a>"</span><span id="7e67" class="nn mm iq nj b gy ns np l nq nr">protoPayload.methodName="jobservice.jobcompleted"</span><span id="5683" class="nn mm iq nj b gy ns np l nq nr">protoPayload.serviceData.jobCompletedEvent.job.jobConfiguration.load.destinationTable.tableId:"ga_sessions"</span><span id="b561" class="nn mm iq nj b gy ns np l nq nr">NOT protoPayload.serviceData.jobCompletedEvent.job.jobConfiguration.load.destinationTable.tableId:"ga_sessions_intraday"</span></pre><ul class=""><li id="81b1" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">如果您将时间范围调整为过去7天，您现在应该每天都会看到一条消息。在下面的截图中，您可以看到导出的确切时间的不可预测性。在这个例子中，有时候桌子在下午2点之前就准备好了，有时候在下午3点之后。如果你的屏幕是这样的，你就准备好进入下一步了！</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/c2e2d3dd63160c7a3c9f8125784a73bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kP0c8th5aBFmEiESLBj8Tg.png"/></div></div><p class="nu nv gj gh gi nw nx bd b be z dk translated">谷歌日志中的截图</p></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="d5f3" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第二步。云发布/订阅</h1><p id="fa67" class="pw-post-body-paragraph ky kz iq la b lb nd jr ld le ne ju lg lh ny lj lk ll nz ln lo lp oa lr ls lt ij bi translated">Pub/Sub代表发布-订阅，可以看作是系统之间的消息传递系统。在这种情况下，我们希望创建一个新的发布/订阅主题，收集我们在上一步中隔离的日志。这样，每次有新的Google Analyicts表可用时，都会收集一条消息。</p><ul class=""><li id="eb09" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">点击上面截图中的“创建汇”。</li><li id="dbbb" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">输入接收器名称时，您可以随心所欲地发挥创造力。</li><li id="b3e8" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">选择“发布/订阅”作为接收服务。</li><li id="0cea" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">选择创建一个新的云发布/订阅主题，并为其命名，以便在下一步中记住。</li><li id="ca84" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">点击“创建接收器”,您就可以开始下一步了。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/d38888ac41c41ca162998df07f22e00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQnpkCA6p2ZwEg89Bivezw.png"/></div></div><p class="nu nv gj gh gi nw nx bd b be z dk translated">Google日志中的屏幕截图:创建发布/订阅接收器和主题</p></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="aff2" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第三步。云函数</h1><p id="b37f" class="pw-post-body-paragraph ky kz iq la b lb nd jr ld le ne ju lg lh ny lj lk ll nz ln lo lp oa lr ls lt ij bi translated">在最后一步中，我们将创建一个云函数(用Python编写),它在每次发布/订阅主题被触发时运行。然后，该函数向<a class="ae me" href="https://cloud.google.com/bigquery-transfer/docs/reference/datatransfer/rest" rel="noopener ugc nofollow" target="_blank"> BigQuery DataTransfer API </a>发送一个请求，在一个预定的(按需)SQL查询上开始手动传输运行。</p><ul class=""><li id="65eb" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">开启<a class="ae me" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能</a></li><li id="3355" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">选择创建新功能。</li><li id="278e" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">选择“云发布/订阅”作为触发器，并选择您在上一步中创建的发布/订阅主题。</li><li id="fa46" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">选择“Python 3.7”(或者更高版本，如果你将来读到这篇文章的话🚀)作为运行时。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/46a5d63afb29910d5a75d6571e3d75ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*TdK4OjLL2SdHmvGAVTf6oA.png"/></div><p class="nu nv gj gh gi nw nx bd b be z dk translated">如何设置谷歌云功能的屏幕截图</p></figure><ul class=""><li id="c4d5" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">复制/粘贴下面的代码，并将其放在“Main.py”文件中。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><ul class=""><li id="19d0" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">用要运行的计划查询的详细信息替换项目ID和转移ID。</li><li id="1511" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">您可以在您的<a class="ae me" href="https://console.cloud.google.com/bigquery/scheduled-queries" rel="noopener ugc nofollow" target="_blank">计划查询</a>的配置选项卡中找到这些ID。资源名称显示了一个URL，您可以在其中找到这两个ID:“<em class="md">projects/[THIS _ IS _ YOUR _ PROJECT _ ID)/locations/us/TRANSFER configs/[THIS IS YOUR TRANSFER _ ID]</em>”。</li><li id="85d6" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">在这种情况下，我假设您已经创建了想要运行的计划查询。如果您还没有，现在是时候在BigQuery中用<a class="ae me" href="https://cloud.google.com/bigquery/docs/scheduling-queries" rel="noopener ugc nofollow" target="_blank">创建您的预定查询</a>了。最好将查询设置为“按需”运行，否则它可能会运行得太频繁。</li><li id="690b" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">将下面的一小段代码添加到“Requirements.txt”中，这样它就有了运行Python代码所需的所有包。</li></ul><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="b94c" class="nn mm iq nj b gy no np l nq nr">google-cloud-bigquery-datatransfer==1</span></pre><ul class=""><li id="078c" class="lu lv iq la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">将“runQuery”设置为要执行的函数。</li><li id="658f" class="lu lv iq la b lb mf le mg lh mh ll mi lp mj lt lz ma mb mc bi translated">点击部署！</li></ul><h1 id="8f02" class="ml mm iq bd mn mo oe mq mr ms of mu mv jw og jx mx jz oh ka mz kc oi kd nb nc bi translated">现在:享受自动化👍</h1><p id="c3a6" class="pw-post-body-paragraph ky kz iq la b lb nd jr ld le ne ju lg lh ny lj lk ll nz ln lo lp oa lr ls lt ij bi translated">如果您已经正确地设置了所有内容，那么一旦新的每日表被导出到BigQuery，您的预定查询就会立即开始运行！这意味着你可以高枕无忧，享受你的谷歌分析数据总是新鲜的。</p><p id="36e3" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><em class="md">如果你有任何建议、意见或问题，请不要犹豫，在下面的评论中问我。</em></p></div></div>    
</body>
</html>