<html>
<head>
<title>Android app for Notion automation using Chaquopy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Chaquopy 实现概念自动化的 Android 应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/android-app-for-notion-automation-using-chaquopy-863e72fa4ecd?source=collection_archive---------59-----------------------#2020-05-11">https://towardsdatascience.com/android-app-for-notion-automation-using-chaquopy-863e72fa4ecd?source=collection_archive---------59-----------------------#2020-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ae6c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 Android、Chaqopy 和 opinion-py 实现观念的自动化。</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/9cac22e193eb5b484291178fbf87cc7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wm6i4gMV5V9FDBc_QcR-pw.jpeg"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated"><strong class="bd kw">这个应用程序是如何工作的？</strong></p></figure><p id="e90d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我<a class="ae lt" href="https://medium.com/@prathu10/automating-notion-using-notion-py-fa0f2e8f089e" rel="noopener">最近写了一篇文章</a>，讲述了我如何使用 idea-py 自动将我的费用添加到 idea 的费用管理器数据库中。</p><p id="abd2" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在发现使用 idea-py 添加费用是多么容易之后，我继续创建了一个简单的 android 应用程序，它允许我输入一个简单的文本字符串，然后将数据迁移到 idea 的数据库中。我使用 chaquoy 在 android 中运行我的 python 脚本。这个项目在 git-hub 上是开源的，欢迎你来<a class="ae lt" href="https://github.com/Prathmesh2498/ExpensesManagerForNotion" rel="noopener ugc nofollow" target="_blank">查看</a>并让我知道你的想法。如果您希望合作，请阅读 github 上的<a class="ae lt" href="https://github.com/Prathmesh2498/ExpensesManagerForNotion/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件。</a></p><p id="4269" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">因此，这个应用程序基本上做的，是采取一个字符串'费用，金额，评论，标签'并将其添加到概念的费用数据库。因为你可以在 github 上查看完整的代码，所以我只解释核心代码。</p><pre class="kh ki kj kk gt lu lv lw lx aw ly bi"><span id="8074" class="lz ma iq lv b gy mb mc l md me"># -*- coding: utf-8 -*-<br/>"""<br/>Created on Sat May  3 15:22:31 2020<br/><br/>@author: Prathmesh D<br/>"""<br/><br/>def addRecord(Expense,Amount,Comment,Category,v2,db):<br/>    import datetime<br/>    from notion.client import NotionClient<br/>    Date = datetime.datetime.now()<br/><br/>    print(v2)<br/>    print(db)<br/>    # Obtain the `token_v2` value by inspecting your browser cookies on a logged-in session on Notion.so<br/><br/>    try:<br/>        client = NotionClient(token_v2=v2)<br/>        print("Client Connected..")<br/>    except:<br/>        s ="V2Error"<br/>        return s<br/><br/>    try:<br/>        cv = client.get_collection_view(db)<br/>        print("Connected to db")<br/>    except:<br/>        s="dbError"<br/>        return s<br/><br/>    try:<br/>        row = cv.collection.add_row()<br/><br/>        row.Expense = Expense<br/>        row.Amount = Amount<br/>        row.Comment = Comment<br/>        row.Category = Category<br/>        row.Date=Date<br/>        return "Success"<br/>    except Exception as e:<br/>        s = str(e)<br/>	#Get the values from the database         <br/>	filter_params = [{<br/>            "property": "Expense",<br/>        }]<br/>        result = cv.build_query(filter=filter_params).execute()<br/>        #Get size of db<br/>	size = len(result)<br/>        #Remove last entry<br/>	result[size-1].remove()<br/>        return s</span></pre><p id="d9f7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">基本脚本和我之前的<a class="ae lt" href="https://medium.com/@prathu10/automating-notion-using-notion-py-fa0f2e8f089e" rel="noopener">帖子</a>中的一样。唯一增加的是 catch 块，其中我删除了最新的记录，因为有一些错误，并将生成的错误返回给 android 应用程序。</p><p id="9166" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在 android 应用程序中，我使用 AsyncTask 向 python 脚本发送请求，并返回结果。如果您不熟悉 AsyncTask，它有 4 个主要部分:</p><ol class=""><li id="65ea" class="mf mg iq kz b la lb ld le lg mh lk mi lo mj ls mk ml mm mn bi translated">onPreExecute() —在调用新线程之前准备数据。在 UI 线程上运行。</li><li id="f1be" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">doInBackground(Params…) —创建新线程并在后台运行的异步调用。这是我们将使用 chaqopy 调用脚本的地方。</li><li id="fd69" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">onProgressUpdate(Progress…) —该方法在 UI 线程上运行，您可以更新在 doInBackground()方法中完成的流程或操作。我还没有在我的应用程序中使用它，但是使用它的一种方法是显示在一次调用中添加多个条目时完成了多少个条目。</li><li id="88d6" class="mf mg iq kz b la mo ld mp lg mq lk mr lo ms ls mk ml mm mn bi translated">onPostExecute(Result) —此函数在 doInBackground()完成执行后调用。它也运行在 UI 线程上。</li></ol><p id="623c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">以下是我如何使用这些方法的:</p><ol class=""><li id="9892" class="mf mg iq kz b la lb ld le lg mh lk mi lo mj ls mk ml mm mn bi translated">onPreExecute()</li></ol><pre class="kh ki kj kk gt lu lv lw lx aw ly bi"><span id="e870" class="lz ma iq lv b gy mb mc l md me">@Override<br/>protected void onPreExecute() {<br/>    super.onPreExecute();<br/><br/>    editTextString[0] = getData.getText().toString();<br/>    getData.setText("");<br/>   <br/>    d[0] = editTextString[0].split(Pattern.quote(","));<br/><br/>    amount[0] = Integer.parseInt(d[0][1]);<br/><br/>    date[0] = Calendar.getInstance().getTime();<br/><br/>}</span></pre><p id="ef72" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">2.doInBackround(参数…)</p><pre class="kh ki kj kk gt lu lv lw lx aw ly bi"><span id="4fd8" class="lz ma iq lv b gy mb mc l md me">@Override<br/>protected String doInBackground(String... params) {<br/>    try{<br/>	//Call to chaquopy library<br/>        returned_value = viewSource(MainActivity.this, d[0], amount[0], date[0], TOKEN_V2, DB_URL);<br/>	return returned_value;<br/>    }catch (Exception e){<br/>        return returned_value;<br/>    }<br/><br/>}</span></pre><p id="4ee8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">2.1 viewSource(参数…)</p><p id="7e65" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">Chaquopy 码</p><pre class="kh ki kj kk gt lu lv lw lx aw ly bi"><span id="134f" class="lz ma iq lv b gy mb mc l md me">@Override<br/>protected String doInBackground(String... params) {<br/>    try{<br/>	//Call to chaquopy library<br/>        returned_value = viewSource(MainActivity.this, d[0], amount[0], date[0], TOKEN_V2, DB_URL);<br/>	return returned_value;<br/>    }catch (Exception e){<br/>        return returned_value;<br/>    }<br/><br/>}</span></pre><p id="e017" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">3.onPostExecute(结果)</p><p id="da80" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在这个方法中，我们主要检查用户是否正确输入了他的 v2_Token 和数据库 URL，我们检查 python 脚本的结果，并相应地在主 UI 线程上显示结果。</p><pre class="kh ki kj kk gt lu lv lw lx aw ly bi"><span id="3f20" class="lz ma iq lv b gy mb mc l md me">@Override<br/>protected void onPostExecute(String result) {<br/>    super.onPostExecute(result);<br/>    SharedPreferences.Editor putEditor = getSharedPreferences(SAVED_PREFERENCES, MODE_PRIVATE).edit();<br/>    if(result.equals("Success")) {<br/>        Toast.makeText(MainActivity.this, result, Toast.LENGTH_SHORT).show();<br/>    }<br/>    else{<br/><br/>        if(result.equals("V2Error")){<br/>            Toast.makeText(MainActivity.this, "Your V2 Token is wrong. Please Enter Details again!", Toast.LENGTH_LONG).show();<br/>            putEditor.remove("Init");<br/>            putEditor.commit();<br/>            Intent intent = new Intent(MainActivity.this,userDetails.class);<br/>            startActivityForResult(intent,2);<br/><br/>        }<br/>        else if(result.equals("dbError")){<br/>            Toast.makeText(MainActivity.this, "Your db URL is wrong. Please Enter Details again!", Toast.LENGTH_LONG).show();<br/>            putEditor.remove("Init");<br/>            putEditor.commit();<br/>            Intent intent = new Intent(MainActivity.this,userDetails.class);<br/>            startActivityForResult(intent,2);<br/>        }<br/>        else{<br/>            String sourceString = "&lt;b&gt;" + result + "&lt;/b&gt; " ;<br/>            tv.setText(Html.fromHtml(sourceString, Html.FROM_HTML_MODE_LEGACY));<br/>            Toast.makeText(MainActivity.this, "Record Deleted!\\nPlease add again.", Toast.LENGTH_LONG).show();<br/>        }<br/><br/>    }</span></pre><p id="e318" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我希望这在某种程度上对你有所帮助。</p><p id="a19d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">下次见。干杯！</p></div></div>    
</body>
</html>