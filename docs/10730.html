<html>
<head>
<title>Part 2: Building a Simple ETL Pipeline with Python and Google Cloud Functions — MySQL to BigQuery (via SSH)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第 2 部分:用 Python 和 Google Cloud 函数构建一个简单的 ETL 管道——MySQL 到 BigQuery(通过 SSH)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/part-2-building-a-simple-etl-pipeline-with-python-and-google-cloud-functions-mysql-to-bigquery-4e1987f9f89b?source=collection_archive---------20-----------------------#2020-07-27">https://towardsdatascience.com/part-2-building-a-simple-etl-pipeline-with-python-and-google-cloud-functions-mysql-to-bigquery-4e1987f9f89b?source=collection_archive---------20-----------------------#2020-07-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="281f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Google Cloud 函数从 MySQL 数据库中提取数据并加载到 Google BigQuery 中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f644d27b664d0242dad77fd046a7ebc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3L53F9fk1mPbK-52c_wdA.png"/></div></div></figure><p id="80f7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<a class="ae lq" rel="noopener" target="_blank" href="/building-a-simple-etl-pipeline-with-python-and-google-cloud-platform-6fde1fc683d5">第 1 部分</a>中，我们看了如何从 FTP 服务器提取 csv 文件，以及如何使用云函数将其加载到 Google BigQuery 中。在本文中，我们将做同样的事情，但这一次，我们将从 MySQL 数据库中提取数据。</p><p id="3cfb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有很多 ETL 工具，有时它们可能会让人不知所措，特别是当你只想将文件从 A 点复制到 b 点时。所以今天，我将向你展示如何使用<strong class="kw iu"> python 3.6 </strong>和谷歌云功能从 MySQL 数据库中提取数据(extract)、修改数据(Transform)并将其加载到谷歌 BigQuery 表(load)中。</p><p id="d165" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我们将做以下工作:</p><ul class=""><li id="f8b5" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">设置云功能</li><li id="e0a4" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">提取数据</li><li id="16a6" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">转换数据</li><li id="3a61" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">加载数据</li><li id="16dc" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">自动化我们的管道</li></ul><h1 id="f3ed" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">首先，什么是 ETL？</h1><p id="07ad" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated"><em class="nc">提取、转换、加载(ETL)是将数据从一个或多个源复制到目标系统的一般过程，目标系统以不同于源的方式或在不同于源的上下文中表示数据。—维基百科</em></p><p id="5fad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是我们的 ETL 管道最终的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/c62d27d058372e5ed1f229df8e8b3168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/0*NgdYwz8MhhtIPYrE.png"/></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">ETL 管道(使用<a class="ae lq" href="https://www.lucidchart.com/pages/examples/uml_diagram_tool" rel="noopener ugc nofollow" target="_blank"> Lucidchart </a>创建)</p></figure><p id="d6c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">Google Cloud Functions</strong>:<a class="ae lq" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">Cloud Functions</a>(CF)是 Google Cloud 的无服务器平台，用于执行响应特定事件的脚本，如 HTTP 请求或数据库更新。CF 的替代方案是<a class="ae lq" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>或<a class="ae lq" href="https://azure.microsoft.com/en-us/services/functions/" rel="noopener ugc nofollow" target="_blank"> Azure Functions </a>。</p><p id="8ecb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">设置您的云功能</strong></p><ul class=""><li id="e49b" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><a class="ae lq" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">进入云功能概述页面</a>。<br/>确保您启用了云功能的项目被选中。</li><li id="80eb" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">单击创建函数。</li><li id="32c2" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">说出你的函数。</li><li id="ac70" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">在触发器字段中，选择 HTTP 触发器。</li><li id="6427" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">在源代码字段中，选择内联编辑器。在本练习中，我们将编写一些自定义代码，因此您可以在编辑器中删除默认代码。</li><li id="aecd" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">使用运行时下拉列表选择运行时。</li><li id="db05" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">认证:在本例中，我们将“允许未经认证的调用”，但建议使用服务帐户来访问云函数，并在我们将使用的云调度器服务帐户上授予云函数的“<a class="ae lq" href="https://cloud.google.com/functions/docs/reference/iam/roles" rel="noopener ugc nofollow" target="_blank">权限调用程序</a>”。更多详情在文末。</li></ul><p id="51dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">确保您的运行时设置为“Python 3.7”，并在“高级选项”下将区域更改为离您最近的区域。在撰写本文时，CF 并不是在每个谷歌数据中心区域都可用，所以请点击这里的<a class="ae lq" href="https://cloud.google.com/functions/docs/locations" rel="noopener ugc nofollow" target="_blank">查看哪里启用了云功能。</a></p><p id="f3c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">完成这些步骤后，您的显示应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/b8fd273e89e63cc48f9c44dceeb297a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/0*V_3CmtB5FXaUlDwz.png"/></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">截图来自<a class="ae lq" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a></p></figure><h1 id="2606" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated"><strong class="ak">我们的自定义代码</strong></h1><p id="1768" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">一个云函数有两个文件；一个<em class="nc"> main.py </em>和一个<em class="nc"> requirements.txt </em>文件。后者托管我们脚本工作所需的所有文件依赖项，因此单击<em class="nc"> requirements.txt </em>选项卡，并确保编辑器中包含这些依赖项，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="2f15" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">提取</h1><p id="c25a" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">现在在<em class="nc"> main.py </em>选项卡中，您可以开始包含下面的代码。我们创建了一个名为“<em class="nc"> handler </em>的函数，以后用 HTTP 请求访问云函数时会用到这个函数。然后，我们使用必要的凭证登录到 MySQL 服务器，在第 30 行，编写从数据库中提取数据所需的 SQL 查询。</p><p id="3502" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">获得正确的 ssh 隧道细节很重要，这样就不会遇到认证问题。SSHTunnel 是一个很好的 Python 库。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><blockquote class="nl"><p id="efa6" class="nm nn it bd no np nq nr ns nt nu lp dk translated">注意:为了保护你的秘密管理者证书，请遵循这个<a class="ae lq" href="https://medium.com/geekculture/secure-your-credentials-in-google-cloud-functions-with-secret-manager-22a4a1b3788a" rel="noopener">指南</a>。</p></blockquote><h1 id="bfee" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz nv ka mr kc nw kd mt kf nx kg mv mw bi translated">改变</h1><p id="08d6" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">因为我们现在有一个名为“<em class="nc">df”</em>的熊猫数据框架，我们可以像这样操作熊猫数据:</p><p id="fcec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="nc">df . group by([' Name '])[[' Orders ']]。agg('sum') </em></p><p id="1434" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将对“orders”列中的所有订单进行汇总，并根据数据帧的“name”列中的每个唯一名称进行分组。在这个特殊的例子中，我没有包含任何转换，但是如果需要的话，您可以在第 30 行之后这样做。</p><h1 id="b1a5" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">负荷</h1><p id="851f" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">现在，确保您<a class="ae lq" href="https://cloud.google.com/bigquery/docs/tables" rel="noopener ugc nofollow" target="_blank">创建了您的 BigQuery 表</a>。然后我们简单地使用下面的代码将转换后的 CSV 文件加载到您创建的 BigQuery 表中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><ul class=""><li id="cd69" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><strong class="kw iu"><em class="nc">auto detect = True</em></strong>:-由于我们启用了“<a class="ae lq" href="https://cloud.google.com/bigquery/docs/schema-detect" rel="noopener ugc nofollow" target="_blank">自动检测</a>”，所以在将数据加载到表中时，我们不需要提供模式，因为它将基于 Dataframe 中的数据进行推断。</li><li id="45f0" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu"><em class="nc">WRITE _ disposition = " WRITE _ TRUNCATE "</em></strong>:-该作业将截断表数据并从头开始写入。</li><li id="1119" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">T13】source _ format=<em class="nc">big query。source format . NEWLINE _ DELIMITED _ JSON</em></strong></li><li id="53b3" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu"><em class="nc">load _ table _ from _ data frame</em></strong><em class="nc">:-</em>一个不错的 BigQuery 函数，可以将数据从一个<code class="fe ny nz oa ob b"><strong class="kw iu">pandas.DataFrame</strong></code>加载到一个<code class="fe ny nz oa ob b"><a class="ae lq" href="https://googleapis.dev/python/bigquery/latest/generated/google.cloud.bigquery.table.Table.html#google.cloud.bigquery.table.Table" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">Table</strong></a></code>。</li></ul><p id="664d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当您完成编写脚本时，您可以通过单击“创建”来部署云功能。当该功能成功部署后，您应该会看到一个绿色的复选标记。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/a612ef824a5048c980305c126dc0a3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rYE0MjetJQDxAnhF.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated"><a class="ae lq" href="https://cloud.google.com/functions/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><h1 id="b74c" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">使自动化</h1><p id="1933" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">现在剩下要做的就是创建一个 cron 作业(Cloud Scheduler ),它将在某个预定义的时间间隔自动调用 CF。好消息是，在谷歌云平台上创建 cron jobs 非常简单，也是最简单的部分。你可以在这里按照<a class="ae lq" href="https://cloud.google.com/scheduler/docs/creating" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"/></a><strong class="kw iu"/>的指示或者复制下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/1900b96a17e1e8cc87dcfe1b95d5266c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Sjbune7unnGggT3w.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated"><a class="ae lq" href="https://cloud.google.com/functions/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/53e2e21ffd5daa019cff8dbe52daab3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KqRz9Nc8Vpom2vdk.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">截图自 GCP</p></figure><p id="bed4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里的“频率”字段将在每天凌晨 1:59 运行我们的脚本。</p><blockquote class="nl"><p id="7680" class="nm nn it bd no np of og oh oi oj lp dk translated"><em class="ok">你可以使用这个很酷的</em> <a class="ae lq" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> <em class="ok">站点编辑器</em> </a> <em class="ok">进行简单的 cron 调度表达式。</em></p></blockquote><p id="9ae4" class="pw-post-body-paragraph ku kv it kw b kx ol ju kz la om jx lc ld on lf lg lh oo lj lk ll op ln lo lp im bi translated">既然我们的数据已经存放在数据仓库中，我们可以将它连接到任何可视化工具并对其进行分析。</p><h1 id="5f00" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">后续步骤</h1><p id="f286" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">如果您不想允许未经身份验证的调用，请为 Cloud Scheduler 设置 HTTP 目标身份验证。如果您设置了具有适当凭据的关联服务帐户，云调度程序可以调用需要身份验证的 HTTP 目标。点击阅读更多<a class="ae lq" href="https://cloud.google.com/scheduler/docs/http-target-auth" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl oq or hx os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="im in io ip iq"><p id="3d0b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样。希望这对你有帮助。这是一种非常简单的开发 ETL 的方法，任何人都可以在其上进行构建。</p></div><div class="ab cl oq or hx os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="im in io ip iq"><blockquote class="nl"><p id="4a24" class="nm nn it bd no np of og oh oi oj lp dk translated"><em class="ok">你可以</em> <a class="ae lq" href="https://medium.com/@tobisam/membership" rel="noopener"> <em class="ok">成为中等会员</em> </a> <em class="ok">享受更多这样的故事。</em></p></blockquote><p id="da25" class="pw-post-body-paragraph ku kv it kw b kx ol ju kz la om jx lc ld on lf lg lh oo lj lk ll op ln lo lp im bi translated">你可以在<a class="ae lq" href="https://github.com/togobingi/google_cloud_function" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> Github </strong> </a>上找到完整脚本的链接。</p></div></div>    
</body>
</html>