<html>
<head>
<title>Build, Train and Deploy A Real-World Flower Classifier of 102 Flower Types</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建、训练和部署一个包含 102 种花卉类型的真实世界花卉分类器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-train-and-deploy-a-real-world-flower-classifier-of-102-flower-types-a90f66d2092a?source=collection_archive---------29-----------------------#2020-09-11">https://towardsdatascience.com/build-train-and-deploy-a-real-world-flower-classifier-of-102-flower-types-a90f66d2092a?source=collection_archive---------29-----------------------#2020-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="43ad" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">借助 TensorFlow 2.3、Amazon SageMaker Python SDK 2.5.x 和定制 SageMaker 培训和服务 Docker 容器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/58b0787ec4c33a29677fb88f6de4fb87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*U5fka0ETq6k3mVVd4zyrMA.jpeg"/></div><p class="kn ko gj gh gi kp kq bd b be z dk">Lotus Flower taken at Summer Palace (颐和园), Beijing China in 2008. © Juv Chan. All rights reserved.</p></figure><h1 id="f19a" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">简介</strong></h1><p id="9f15" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我喜欢花。上面的荷花是我最喜欢的花卉照片之一，是我 2008 年参观北京颐和园时拍的。由于我是一名开发人员，并且喜欢学习和从事人工智能和云项目，我决定写这篇博客来分享我与 TensorFlow、Amazon SageMaker 和 Docker 一起构建真实世界花卉分类器的项目。</p><p id="558e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这篇文章展示了一步一步的指南:</p><ul class=""><li id="3360" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">使用现成的<a class="ae mt" href="https://www.tensorflow.org/datasets/catalog/oxford_flowers102" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">花数据集</strong> </a>从<a class="ae mt" href="https://www.tensorflow.org/datasets" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> TensorFlow 数据集</strong> </a>。</li><li id="2cac" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/tutorials/images/transfer_learning" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">转移学习</strong> </a>从来自<a class="ae mt" href="https://www.tensorflow.org/hub" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">tensor flow Hub</strong></a>的预训练模型中提取特征。</li><li id="df78" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/guide/data" rel="noopener ugc nofollow" target="_blank"> tf.data </a> API 为分割成训练、验证和测试数据集的数据集构建输入管道。</li><li id="3dee" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/api_docs/python/tf/keras" rel="noopener ugc nofollow" target="_blank"> tf.keras </a> API 建立、训练和评估模型。</li><li id="c407" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/guide/keras/custom_callback" rel="noopener ugc nofollow" target="_blank">回调</a>定义<strong class="ll ir">提前停止</strong>阈值进行模型训练。</li><li id="fc9f" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">准备<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#id1" rel="noopener ugc nofollow" target="_blank">训练脚本</a>以<a class="ae mt" href="https://www.tensorflow.org/guide/saved_model" rel="noopener ugc nofollow" target="_blank"> SavedModel </a>格式训练并导出模型，用于部署<a class="ae mt" href="https://www.tensorflow.org/overview/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">tensor flow</strong></a><strong class="ll ir"/>和<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/v2.html" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">Amazon SageMaker Python SDK</strong></a>。</li><li id="fe3c" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">准备推理代码和配置以运行<a class="ae mt" href="https://www.tensorflow.org/tfx/serving/serving_advanced" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> TensorFlow 服务模型服务器</strong> </a>为模型服务。</li><li id="cc81" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">用亚马逊 SageMaker Python SDK 和<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/overview.html#local-mode" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"/></a>中的<a class="ae mt" href="https://github.com/aws/sagemaker-tensorflow-training-toolkit" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> SageMaker TensorFlow 训练工具包</strong> </a>构建自定义<a class="ae mt" href="https://www.docker.com/resources/what-container" rel="noopener ugc nofollow" target="_blank">Docker 容器 </a>用于训练和服务 TensorFlow 模型。</li></ul><p id="8a2a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">公众可通过以下网址获得该项目:</p><div class="mz na gp gr nb nc"><a href="https://github.com/juvchan/amazon-sagemaker-tensorflow-custom-containers/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">juv chan/亚马逊-sage maker-tensor flow-自定义-容器</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">这个项目展示了一步一步的指导如何建立一个现实世界的花卉分类器的 102 种花卉类型使用…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">github.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq kl nc"/></div></div></a></div><h1 id="19eb" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">设置</strong></h1><p id="c43c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">以下是用于开发和测试项目的系统、硬件、软件和 Python 包的列表。</p><ul class=""><li id="8ca9" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">LTS</li><li id="afff" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">12 年 3 月 19 日</li><li id="7e32" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">Python 3.8.5</li><li id="c11f" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">康达 4.8.4</li><li id="1d18" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">英伟达 GeForce RTX 2070</li><li id="43ff" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">NVIDIA 容器运行时库 1.20</li><li id="33a3" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">NVIDIA CUDA 工具包 10.1</li><li id="3270" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">sagemaker 2.5.3</li><li id="1202" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">sagemaker-tensor flow-培训 20.1.2</li><li id="6a2a" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">张量流-gpu 2.3.0</li><li id="03e3" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">张量流数据集 3.2.1</li><li id="e9ce" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">张量流-集线器 0.9.0</li><li id="fd7e" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">张量流-模型-服务器 2.3.0</li><li id="cca1" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">木星实验室 2.2.6</li><li id="7d50" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">枕头 7.2.0</li><li id="fff5" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">matplotlib 3.3.1</li></ul><h1 id="b277" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">花卉数据集</strong></h1><p id="9c65" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">TensorFlow Datasets (TFDS)是一个公共数据集的集合，可用于 TensorFlow、<a class="ae mt" href="https://github.com/google/jax" rel="noopener ugc nofollow" target="_blank"> JAX </a>和其他机器学习框架。所有 TFDS 数据集都以<a class="ae mt" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset" rel="noopener ugc nofollow" target="_blank"> tf.data.Datasets </a>的形式公开，易于用于高性能的输入管道。</p><p id="d36c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">迄今为止，TFDS 共有 195 个现成可用的数据集。TFDS 有<strong class="ll ir"> 2 个花卉数据集</strong>:<strong class="ll ir">Oxford _ flowers 102</strong>，<strong class="ll ir"> tf_flowers </strong></p><p id="e98b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/datasets/catalog/oxford_flowers102" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">Oxford _ flowers 102</strong></a>数据集是因为它具有更大的数据集大小和更大数量的花类别。</p><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="b389" class="nw ks iq ns b gy nx ny l nz oa">ds_name = 'oxford_flowers102'<br/>splits = ['test', 'validation', 'train']<br/>ds, info = tfds.load(ds_name, split = splits, with_info=True)<br/>(train_examples, validation_examples, test_examples) = ds</span><span id="40d0" class="nw ks iq ns b gy ob ny l nz oa">print(f"Number of flower types {info.features['label'].num_classes}")<br/>print(f"Number of training examples: {tf.data.experimental.cardinality(train_examples)}")<br/>print(f"Number of validation examples: {tf.data.experimental.cardinality(validation_examples)}")<br/>print(f"Number of test examples: {tf.data.experimental.cardinality(test_examples)}\n")<br/><br/>print('Flower types full list:')<br/>print(info.features['label'].names)<br/><br/>tfds.show_examples(train_examples, info, rows=2, cols=8)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ca"><img src="../Images/f1f4402f61cfd9ed2b58fa805f3e71d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQkETmU-buuodJkwnHFtTg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">oxford_flowers 数据集摘要和示例</p></figure><h1 id="fbfa" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">创建 SageMaker TensorFlow 培训脚本</strong></h1><p id="c768" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Amazon SageMaker 允许用户使用训练脚本或推理代码，就像在 SageMaker 外部运行定制的训练或推理算法一样。其中一个区别是，亚马逊 SageMaker 使用的训练脚本可以利用 SageMaker 容器中的<a class="ae mt" href="https://github.com/aws/sagemaker-containers#important-environment-variables" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"/></a>环境变量，例如 SageMaker 容器中的<strong class="ll ir"> SM_MODEL_DIR </strong>，<strong class="ll ir">SM _ NUM _ GPU</strong>，<strong class="ll ir">SM _ NUM _ CPU</strong>。</p><blockquote class="og oh oi"><p id="fe88" class="lj lk oj ll b lm mf jr lo lp mg ju lr ok mh lu lv ol mi ly lz om mj mc md me ij bi translated">Amazon SageMaker 在运行脚本、训练算法或部署模型时总是使用 Docker 容器。亚马逊 SageMaker 为其内置算法提供了容器，并为一些最常见的机器学习框架提供了预构建的 Docker 映像。您还可以创建自己的容器映像来管理 Amazon SageMaker 提供的容器无法解决的更高级的用例。</p></blockquote><p id="7c58" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">自定义培训脚本如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="on oo l"/></div></figure><h1 id="d800" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">使用 TensorFlow Hub 进行迁移学习(TF-Hub)</h1><p id="f090" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><a class="ae mt" href="https://tfhub.dev/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">tensor flow Hub</strong></a>是一个可重用的预训练机器学习模型库，用于不同问题领域的迁移学习。对于这个花分类问题，我们基于不同的图像模型架构和来自 TF-Hub 的数据集评估<strong class="ll ir">预训练的图像特征向量</strong>，如下用于在<strong class="ll ir"> oxford_flowers102 </strong>数据集上的迁移学习。</p><ul class=""><li id="8f6b" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated"><a class="ae mt" href="https://tfhub.dev/tensorflow/resnet_50/feature_vector/1" rel="noopener ugc nofollow" target="_blank"> ResNet50 特征向量</a></li><li id="41be" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated"><a class="ae mt" href="https://tfhub.dev/google/imagenet/mobilenet_v2_100_224/feature_vector/4" rel="noopener ugc nofollow" target="_blank"> MobileNet V2 (ImageNet)特征向量</a></li><li id="e1de" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated"><a class="ae mt" href="https://tfhub.dev/google/imagenet/inception_v3/feature_vector/4" rel="noopener ugc nofollow" target="_blank"> Inception V3 (ImageNet)特征向量</a></li><li id="a528" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated"><a class="ae mt" href="https://tfhub.dev/google/inaturalist/inception_v3/feature_vector/4" rel="noopener ugc nofollow" target="_blank"> Inception V3(非自然语言)特征向量</a></li></ul><p id="9e52" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在最终的训练脚本中，<strong class="ll ir"> Inception V3(非自然主义者)特征向量</strong>预训练模型用于该问题的迁移学习，因为它与上面的其他模型<strong class="ll ir">(在 5 个时期内约 95%的测试准确性，无需微调)</strong>相比表现最佳。该模型使用 Inception V3 架构，并在来自<a class="ae mt" href="https://www.inaturalist.org/" rel="noopener ugc nofollow" target="_blank">https://www.inaturalist.org/</a>的<strong class="ll ir">超过 5000</strong>种不同动植物的<a class="ae mt" href="https://arxiv.org/abs/1707.06642" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">inauturalist(iNat)2017</strong></a>数据集上进行训练。相比之下，<a class="ae mt" href="https://www.tensorflow.org/datasets/catalog/imagenet2012" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> ImageNet 2012 </strong> </a>数据集只有 1000 个类，其中的花类型非常少。</p><h1 id="7174" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">具有张量流服务的服务花分类器</h1><p id="1e0d" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><strong class="ll ir"> TensorFlow Serving </strong>是一个灵活、高性能的机器学习模型服务系统，专为生产环境而设计。它是部署生产机器学习(ML)管道的端到端平台<a class="ae mt" href="https://www.tensorflow.org/tfx" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">tensor flow Extended(TFX)</strong></a>的一部分。<a class="ae mt" href="https://www.tensorflow.org/tfx/serving/setup#available_binaries" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> TensorFlow 服务模型服务器二进制</strong> </a>有两种变体:<strong class="ll ir">tensor flow-model-server</strong>和<strong class="ll ir">tensor flow-model-server-universal</strong>。<strong class="ll ir"> TensorFlow 服务模型服务器</strong>支持<a class="ae mt" href="https://github.com/tensorflow/serving/blob/master/tensorflow_serving/apis/prediction_service.proto" rel="noopener ugc nofollow" target="_blank">gRPC API</a>和<a class="ae mt" href="https://www.tensorflow.org/tfx/serving/api_rest" rel="noopener ugc nofollow" target="_blank">RESTful API</a>。</p><p id="f3a8" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在推理代码中，<strong class="ll ir">tensor flow-model-server</strong>用于通过 RESTful APIs 为模型提供服务，从这里将模型导出到 SageMaker 容器中。它是一个完全优化的服务器，使用一些特定于平台的编译器优化，应该是用户的首选。推理代码如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="on oo l"/></div></figure><h1 id="afde" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">为 SageMaker 训练和推理构建定制的 Docker 映像和容器</h1><p id="c52d" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Amazon SageMaker 利用 Docker 容器来运行所有的训练作业和推理端点。亚马逊 SageMaker 提供了支持机器学习框架的预建 Docker 容器，如<a class="ae mt" href="https://github.com/aws/sagemaker-scikit-learn-container" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> SageMaker Scikit-learn 容器</strong> </a>、<a class="ae mt" href="https://github.com/aws/sagemaker-xgboost-container" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> SageMaker XGBoost 容器</strong> </a>、<a class="ae mt" href="https://github.com/aws/sagemaker-sparkml-serving-container" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> SageMaker SparkML 服务容器</strong> </a>、<a class="ae mt" href="https://github.com/aws/deep-learning-containers" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">深度学习容器</strong> </a> (TensorFlow、PyTorch、MXNet 和 Chainer)以及<a class="ae mt" href="https://github.com/aws/sagemaker-rl-container" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> SageMaker RL(强化这些预先构建的 SageMaker 容器应该足以用于通用机器学习训练和推理场景。</strong></a></p><p id="024e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">有一些场景是预构建的 SageMaker 容器无法支持的，例如</p><ul class=""><li id="c3da" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">使用不支持的机器学习框架版本</li><li id="4191" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用预构建的 SageMaker 容器中没有的第三方包、库、运行时或依赖项</li><li id="040f" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用定制的机器学习算法</li></ul><p id="a2e7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Amazon SageMaker 支持用户为上述高级场景提供的定制 Docker 图像和容器。用户可以使用任何编程语言、框架或包来构建自己的 Docker 映像和容器，这些映像和容器是为亚马逊 SageMaker 的机器学习场景量身定制的。</p><p id="1781" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在这个花卉分类场景中，自定义 Docker 图像和容器用于训练和推理，因为预构建的 SageMaker TensorFlow 容器没有训练所需的包，即<strong class="ll ir"> tensorflow_hub </strong>和<strong class="ll ir"> tensorflow_datasets </strong>。下面是用于构建自定义 Docker 映像的<strong class="ll ir">Docker 文件</strong>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="e053" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">下面的 Docker 命令用于构建自定义 Docker 映像，该映像用于本项目的培训和 SageMaker 托管。</p><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="7f9b" class="nw ks iq ns b gy nx ny l nz oa">docker build ./container/ -t sagemaker-custom-tensorflow-container-gpu:1.0</span></pre><p id="52be" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在 Docker 映像成功构建之后，使用下面的 Docker 命令来验证新映像是否按预期列出。</p><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="8eb7" class="nw ks iq ns b gy nx ny l nz oa">docker images</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi op"><img src="../Images/52bda06f7fe3d5c3bf81757c58eb5fae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nai3DAhGO37qAd8OxTRsSw.png"/></div></div></figure><h1 id="9a4d" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">本地模式下的 SageMaker 培训</strong></h1><p id="cbe9" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><strong class="ll ir"> SageMaker Python SDK </strong>支持<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/overview.html#local-mode" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">本地模式</strong> </a>，允许用户创建估算器、训练模型并将其部署到他们的本地环境中。这对于任何想要在运行到云中之前，在本地实例上使用 SageMaker Python SDK 在 Jupyter 笔记本中原型化、构建、开发和测试他或她的机器学习项目的人来说，都是非常有用和具有成本效益的。</p><p id="dcd9" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">亚马逊 SageMaker 本地模式支持<strong class="ll ir">本地 CPU 实例(单实例和多实例)</strong>和<strong class="ll ir">本地 GPU 实例(单实例)</strong>。它还允许用户通过更改 SageMaker Estimator 对象的<strong class="ll ir"> instance_type </strong>参数，在本地和云实例(即<a class="ae mt" href="https://aws.amazon.com/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank"> Amazon EC2 实例</a>)之间无缝切换(注意:该参数在 SageMaker Python SDK 1.x 中以前称为<strong class="ll ir"> train_instance_type </strong>)。其他一切都一样。</p><p id="f5ed" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在这种情况下，如果可用，默认使用本地 GPU 实例，否则回退到本地 CPU 实例。注意<strong class="ll ir">输出路径</strong>设置为本地当前目录(<strong class="ll ir">文件://)。</strong>)将训练好的模型工件输出到本地当前目录，而不是上传到亚马逊 S3。<strong class="ll ir"> image_uri </strong>被设置为本地定制的 Docker 映像，该映像是在本地构建的，因此 SageMaker 不会从基于框架和版本的预构建的 Docker 映像中获取。您可以参考最新的<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html" rel="noopener ugc nofollow" target="_blank">sage maker tensor flow Estimator</a>和<a class="ae mt" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html" rel="noopener ugc nofollow" target="_blank">sage maker Estimator Base</a>API 文档了解全部细节。</p><p id="a251" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">此外，通过设置 SageMaker 估计器对象的<strong class="ll ir">超参数</strong>，可以将<strong class="ll ir">超参数</strong>传递给训练脚本。可以根据训练脚本中使用的超参数来设置的超参数。在这种情况下，它们是<em class="oj">【epochs】</em><em class="oj">【batch _ size】</em><em class="oj">【learning _ rate】</em>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="on oo l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi oq"><img src="../Images/72f651ff847bbcf572c9664ce0a7459b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*paJHgdSvSbGlG8uHlZf77Q.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">在自定义 TensorFlow 容器中完成 SageMaker 培训作业</p></figure><h1 id="8a8c" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">SageMaker 本地端点部署和模型服务</h1><p id="9d52" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">SageMaker 培训作业完成后，运行该作业的 Docker 容器将退出。当训练成功完成后，通过调用 SageMaker 估计器对象的<strong class="ll ir"> deploy </strong>方法，并将<strong class="ll ir"> instance_type </strong>设置为 local instance type(即<strong class="ll ir"> local_gpu </strong>或<strong class="ll ir"> local </strong>，可以将训练好的模型部署到<strong class="ll ir"> local SageMaker 端点</strong>。</p><p id="182b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">将启动一个新的 Docker 容器来运行定制推理代码(即<strong class="ll ir"> serve </strong>程序)，该程序运行 TensorFlow Serving ModelServer 来为模型提供实时推理服务。ModelServer 将在 RESTful APIs 模式下提供服务，并期待 JSON 格式的请求和响应数据。当本地 SageMaker 端点部署成功时，用户可以向端点发出预测请求，并实时获得预测响应。</p><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="bd9e" class="nw ks iq ns b gy nx ny l nz oa">tf_local_predictor = tf_local_estimator.deploy(initial_instance_count=1,                                                          <br/>                          instance_type=instance_type)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi or"><img src="../Images/1e8e1a154d2335ecd3f53a0602287ba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x5YU3qgptmEoZ9tM9D_uZw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">在自定义 TensorFlow 服务容器上运行的 SageMaker 推理端点</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi os"><img src="../Images/588e63c5f200385846df1ef15d0fe747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rPFlzGoHZvNuvc-fu1aMRQ.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">SageMaker TensorFlow 服务容器正在运行，训练容器已退出</p></figure><h1 id="2fc5" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">利用花图像的外部来源预测花的类型</h1><p id="6f6c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">为了使用<strong class="ll ir">准确度</strong>度量来评估这种花分类模型的性能，使用了来自独立于<strong class="ll ir"> oxford_flowers102 </strong>数据集的外部源的不同花图像。这些测试图片的主要来源是提供高质量免费图片的网站，如<a class="ae mt" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">【unsplash.com】</strong></a><a class="ae mt" href="https://pixabay.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"/></a>以及自拍照片。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="on oo l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ot"><img src="../Images/faff3280ca6814cc336ca5815245aafd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7XY4BPsbJCYGN46XpwsQw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ot"><img src="../Images/17db429ff05dd1ecd3e5ec52e3fdabd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*coY6aq4ENGZXq48o2rxxRg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ou"><img src="../Images/259ef9767a20475d64bb018215fd6931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SK8hozPQhpoGenkQlFNQtg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ov"><img src="../Images/c8871327a24ef5c687e0b5b3006dc957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p2-h_SGAdzh_Xsgjik2W9w.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ov"><img src="../Images/7a2c69ec1e1f86c9f73c11bc697a1a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k-QnzcsjwMAk4J1uWVxvvg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ow"><img src="../Images/12422d039b1bc4e12ca6af34a2db4ea0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xr_vNWqQ7zsTpnOdlerTEA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ox"><img src="../Images/ef34c46090a72b995e0bb6c06910bca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MeZNInB-awNUgru4KIcqlw.png"/></div></div></figure><h1 id="20d7" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">总结</h1><p id="68d0" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">最终的花卉分类模型根据一组来自外部来源的不同类型的真实世界花卉图像进行评估，以测试它对看不见的数据的概括程度。因此，该模型能够正确地分类所有看不见的花图像。模型大小约为<strong class="ll ir"> 80 MB </strong>，对于生产中的边缘部署来说，这可以认为是相当紧凑和高效的。总之，该模型似乎能够在给定的一小组不可见数据上表现良好，并且对于生产边缘或 web 部署来说相当紧凑。</p><h1 id="12ba" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">提议的改进</h1><p id="6213" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">由于时间和资源的限制，此处的解决方案可能无法提供最佳实践或最佳设计和实施。这里有一些想法，对任何有兴趣改进当前解决方案的人都有用。</p><ul class=""><li id="30fa" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">应用<a class="ae mt" href="https://www.tensorflow.org/tutorials/images/data_augmentation" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"/></a>，即随机(但真实)的变换，如旋转、翻转、裁剪、亮度和对比度等。以增加其规模和多样性。</li><li id="5b99" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://keras.io/guides/preprocessing_layers/" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> Keras 预处理图层</strong> </a>。<a class="ae mt" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> Keras </strong> </a>提供预处理层，如<strong class="ll ir">图像预处理层</strong>和<strong class="ll ir">图像数据增强预处理层</strong>，它们可以作为 Keras SavedModel 的一部分进行组合和导出。因此，模型可以接受原始图像作为输入。</li><li id="ae86" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">将 TensorFlow 模型(SavedModel 格式)转换为<a class="ae mt" href="https://www.tensorflow.org/lite/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">tensor flow Lite</strong></a>模型(。tflite)，用于移动和物联网设备上的边缘部署和优化。</li><li id="fbae" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">优化 TensorFlow 服务签名(SavedModel 中的<strong class="ll ir"> SignatureDefs </strong>)以最小化预测输出数据结构和有效载荷大小。当前模型预测输出返回所有 102 种花类型的预测类别和分数。</li><li id="3884" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://www.tensorflow.org/guide/profiler" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">TensorFlow Profiler</strong></a>工具跟踪、分析和优化 tensor flow 模型的性能。</li><li id="db72" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">使用<a class="ae mt" href="https://software.intel.com/content/www/us/en/develop/tools/openvino-toolkit.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">英特尔发布的 OpenVINO toolkit </strong> </a>在英特尔硬件如 CPU、iGPU、VPU 或 FPGA 上进行模型优化和高性能推理。</li><li id="3a94" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">优化 Docker 图像尺寸。</li><li id="915c" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">为 TensorFlow 培训脚本添加单元测试。</li><li id="425a" class="mk ml iq ll b lm mu lp mv ls mw lw mx ma my me mp mq mr ms bi translated">为 docker 文件添加单元测试。</li></ul><h1 id="3caf" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">后续步骤</h1><p id="d25c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在机器学习工作流已经在本地环境中测试为预期工作后，下一步是将这个工作流完全迁移到带有<a class="ae mt" href="https://docs.aws.amazon.com/sagemaker/latest/dg/nbi.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">亚马逊 SageMaker 笔记本实例</strong> </a>的<a class="ae mt" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS 云</a>。在下一个指南中，我将演示如何调整这个 Jupyter notebook 以在 SageMaker Notebook 实例上运行，以及如何将自定义 Docker 映像推送到<a class="ae mt" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">【Amazon Elastic Container Registry(ECR)</strong></a>，以便整个工作流完全在 AWS 中托管和管理。</p><h1 id="99b7" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">清理</h1><p id="0d78" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">最佳做法始终是在最后清理过时的资源或会话，以回收计算、内存和存储资源，如果在云或分布式环境中清理，还可以节省成本。对于这个场景，本地 SageMaker 推理端点以及 SageMaker 容器被删除，如下所示。</p><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="8ecd" class="nw ks iq ns b gy nx ny l nz oa">tf_local_predictor.delete_endpoint()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/9bddd98f7517c38e62eb0d59cbff4a40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*30DTqcXLfEZsnQqKt7QM-Q.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">删除 SageMaker 推理端点并停止 TensorFlow 服务容器</p></figure><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="f2f4" class="nw ks iq ns b gy nx ny l nz oa">docker container ls -a</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi oz"><img src="../Images/2d3f7d623a43f30bf0079c66fe634f22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YznAb1ZJadpP7BqaB7pTdg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">SageMaker 培训和服务容器均处于退出状态</p></figure><pre class="kg kh ki kj gt nr ns nt nu aw nv bi"><span id="a47d" class="nw ks iq ns b gy nx ny l nz oa">docker rm $(docker ps -a -q)<br/>docker container ls -a</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ca"><img src="../Images/e804d5481cd2955c79e84231e73af5c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRmIe9xQCKroPU9Y8nGTxw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">所有容器都被移除</p></figure></div></div>    
</body>
</html>