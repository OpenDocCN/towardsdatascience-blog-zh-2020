<html>
<head>
<title>Bayesian LSTM on PyTorch — with BLiTZ, a PyTorch Bayesian Deep Learning library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PyTorch 上的贝叶斯 LSTM—使用 BLiTZ，PyTorch 贝叶斯深度学习库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bayesian-lstm-on-pytorch-with-blitz-a-pytorch-bayesian-deep-learning-library-5e1fec432ad3?source=collection_archive---------22-----------------------#2020-04-15">https://towardsdatascience.com/bayesian-lstm-on-pytorch-with-blitz-a-pytorch-bayesian-deep-learning-library-5e1fec432ad3?source=collection_archive---------22-----------------------#2020-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="25f7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">是时候给你的时间序列预测画一个置信区间了——现在这很简单。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1f381f5caf51a374c2d216c4cbe2dd61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4UvluodzwSjM5zEqHHxHXg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">LSTM 细胞插图。<a class="ae ky" href="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/The_LSTM_cell.png/800px-The_LSTM_cell.png" rel="noopener ugc nofollow" target="_blank">来源</a>访问于 2020 年 4 月 14 日</p></figure><p id="bba9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一篇关于如何使用 BLiTZ 的帖子，BLiTZ 是一个 PyTorch 贝叶斯深度学习库，使用其贝叶斯 LSTMs 的实现来创建、训练和执行序列数据上的变分推理。</p><p id="680b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以查看这篇文章的示例部分的笔记本<a class="ae ky" href="https://github.com/piEsposito/blitz-bayesian-deep-learning/blob/master/blitz/examples/stocks-blstm.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>和 PyTorch 上<a class="ae ky" href="https://github.com/piEsposito/blitz-bayesian-deep-learning" rel="noopener ugc nofollow" target="_blank"> BLiTZ Bayesian 深度学习的知识库这里</a>。</p><p id="6164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了做到这一点，我们将解释贝叶斯长短期记忆是如何工作的，然后使用 Kaggle 的数据集<a class="ae ky" href="https://www.kaggle.com/szrlee/stock-time-series-20050101-to-20171231" rel="noopener ugc nofollow" target="_blank">通过一个股票置信区间预测的例子。</a></p><p id="6c1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你是贝叶斯深度学习主题的新手，你可能想在 Medium 上寻找关于它的许多帖子中的一个，或者只是我们 lib repo 中关于贝叶斯 DL 的<a class="ae ky" href="https://github.com/piEsposito/blitz-bayesian-deep-learning#Bayesian-Deep-Learning-in-a-Nutshell" rel="noopener ugc nofollow" target="_blank">文档部分。你可能也想看看</a><a class="ae ky" rel="noopener" target="_blank" href="/blitz-a-bayesian-neural-network-library-for-pytorch-82f9998916c7">这篇关于 BLiTZ 用法教程的文章</a>。</p><h1 id="3f3e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">贝叶斯 LSTM 层</h1><p id="48c4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">正如我们所知，LSTM 架构旨在解决当标准递归神经网络用于处理长序列数据时出现的信息消失问题。</p><p id="c7e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在数学上，我们将 LSTM 架构翻译为:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/1d2f5ad233651f67b77758cf7077aa7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*uts_zd10IyiLtgYQQdRjSw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">LSTM 方程。来源:<a class="ae ky" href="https://en.wikipedia.org/wiki/Long_short-term_memory" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Long_short-term_memory</a>由我用乳胶改写。访问时间为 2020 年 4 月 14 日。</p></figure><p id="a0ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还知道，贝叶斯神经网络的核心思想是，我们可以对它们进行采样以获得概率分布，然后优化这些分布参数，而不是具有确定性的权重。</p><p id="c78c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用这一点，有可能衡量预测的可信度和不确定性，这与预测本身一样，都是非常有用的洞察数据。</p><p id="594b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从数学上来说，我们只需要在上面的方程中增加一些额外的步骤。它们是权重和偏差采样，发生在前馈操作之前。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/ce0953b996117fb6a22b235f8a90513e.png" data-original-src="https://miro.medium.com/v2/resize:fit:546/1*4ohDjTR5x9r6QkeXfiwyew.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代表在层/模型的位置 N 上在第 I 时间采样的权重的方程。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/490d4979dcaaaec7c29b7bcaad097c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/1*wl-ove27_D8WVLtbJ-t3_w.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代表在层/模型的位置 N 上第 I 次采样的偏差的方程。</p></figure><p id="9823" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我们的可训练参数是参数化每个权重分布的ρ和μ。BLiTZ 有一个内置的 BayesianLSTM 层，可以为您完成所有这些艰苦的工作，因此您只需担心您的网络架构和培训/测试循环。</p><p id="8f52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看我们的例子。</p><h1 id="654b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">首先，我们的进口</h1><p id="42e3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">除了我们常见的进口产品，我们还将从<code class="fe mv mw mx my b">blitz.modules</code>引进<code class="fe mv mw mx my b">BayesianLSTM</code>，从<code class="fe mv mw mx my b">blitz.utils</code>引进<code class="fe mv mw mx my b">variational_estimator</code>一名室内装潢师，对他们进行不同的培训和复杂的成本收集。</p><p id="0c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还引入了<code class="fe mv mw mx my b">collections.deque</code>用于时间序列数据的预处理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="7a15" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据预处理</h1><p id="a341" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们现在将创建并预处理数据集，以将其提供给网络。我们将从从 Kaggle 获得的数据集导入亚马逊股票定价，获得它的“收盘价”列，并将其规范化。</p><p id="8e72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的数据集将由标准化股票价格的时间戳组成，并将具有形状(batch_size、sequence_length、observation_length)。</p><p id="6254" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们导入并预处理数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="5a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还必须创建一个函数来转换时间戳中的股票价格历史。为此，我们将使用一个最大长度等于我们正在使用的时间戳大小的 deque。我们将每个数据点添加到 deque 中，然后将其副本附加到主时间戳列表中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="9a75" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建我们的网络类</h1><p id="d90c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们的网络类接收到了<code class="fe mv mw mx my b">variational_estimator</code>装饰器，它简化了对贝叶斯神经网络损失的采样。它将有一个贝叶斯 LSTM 图层，其中 in_features=1，out_features=10，后跟一个 nn。Linear(10，1)，输出股票的标准化价格。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="bbdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，这个网络是一个非常正常的网络，这里唯一不常见的是<code class="fe mv mw mx my b">BayesianLSTM</code>层实例和<code class="fe mv mw mx my b">variational_estimator</code>装饰，但是它的行为是一个正常的火炬。</p><p id="70eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，我们可以创建我们的神经网络对象，分割数据集，并继续进行训练循环:</p><h1 id="9cec" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建对象</h1><p id="603e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们现在可以创建我们的损失对象，神经网络，优化器和数据加载器。请注意，我们没有随机分割数据集，因为我们将使用最后一批时间戳来评估模型。因为我们的数据集就大小而言非常小，所以我们不会为训练集创建数据加载器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="723a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用正态均方误差损失和学习率=0.001 的 Adam 优化器</p><h1 id="f6c9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">火车环线</h1><p id="85ac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">对于我们的训练循环，我们将使用<code class="fe mv mw mx my b">variational_estimator</code>添加到我们的神经网络的<code class="fe mv mw mx my b">sample_elbo</code>方法。它对 X 个样本的损失进行平均，帮助我们轻松地进行蒙特卡罗估计。</p><p id="9e1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为使该方法有效，网络的<code class="fe mv mw mx my b">forward</code>方法的输出必须与将被输入损失对象/标准的标签具有相同的形状。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="33e7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">评估模型并收集置信区间</h1><p id="d484" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们将首先用要绘制的真实数据创建一个数据框架:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="d2d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了预测置信区间，我们必须创建一个函数来预测相同数据的 X 次，然后收集其平均值和标准差。同时，在参考真实数据之前，我们必须设置我们将尝试预测的窗口大小。</p><p id="fc28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看预测函数的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2cfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和置信区间的收集。请注意，我们可以决定距离均值有多少标准差来设置我们的置信区间:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="c3a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们使用的样本数量非常少，因此我们用高标准偏差对其进行了补偿。我们的网络将尝试预测 7 天，然后查询数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="8645" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们可以通过查看真实值是低于上界还是高于下界来检查置信区间。设置好参数后，您应该有一个 95%左右的置信区间，如我们所知:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="8eea" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">查看预测图表</strong></h1><p id="07b2" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们现在只是绘制预测图，直观地看看我们的训练是否顺利。我们将绘制真实数据和测试预测及其置信区间:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/bd8a8d4d120c42b9ad8582d55c980854.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*c7vkZ5wqIO1dNTbqiIycFA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基于置信区间的股票价格预测。</p></figure><p id="212d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了结束我们的评估，我们将放大预测区域:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/e9ea78047cbccfcad6961fbc0d6a4bec.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*pqUSAVHQLislxZNW7M6WxA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带有置信区间的测试数据的网络预测图。</p></figure><h1 id="41f7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="1552" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们看到 BLiTZ 贝叶斯 LSTM 实现使得利用贝叶斯深度学习的所有能力在时间序列上实现和迭代变得非常容易。我们还看到贝叶斯 LSTM 很好地集成到 Torch 中，并且易于在任何工作或研究中使用和介绍。</p><p id="d537" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以非常准确地预测 IBM 股票价格的置信区间，这可能是一个比点估计有用得多的洞察力。</p><h1 id="4c1f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><div class="nc nd gp gr ne nf"><a href="https://github.com/piEsposito/blitz-bayesian-deep-learning" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">piEsposito/blitz-贝叶斯深度学习</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">BLiTZ 是一个简单且可扩展的库，用于创建贝叶斯神经网络层(基于 Weight…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><div class="nc nd gp gr ne nf"><a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">了解 LSTM 网络</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">2015 年 8 月 27 日发布人类不是每秒钟都从零开始思考。当你读这篇文章时，你…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">colah.github.io</p></div></div></div></a></div><div class="nc nd gp gr ne nf"><a rel="noopener follow" target="_blank" href="/blitz-a-bayesian-neural-network-library-for-pytorch-82f9998916c7"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">BLiTZ——py torch 的贝叶斯神经网络库</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">火炬动物园中的贝叶斯层是一个简单且可扩展的库，用于在…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="nu l nq nr ns no nt ks nf"/></div></div></a></div><div class="nc nd gp gr ne nf"><a href="https://arxiv.org/abs/1505.05424" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">神经网络中的权重不确定性</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">我们介绍了一个新的，有效的，原则性和反向传播兼容的算法学习概率…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">arxiv.org</p></div></div></div></a></div></div></div>    
</body>
</html>