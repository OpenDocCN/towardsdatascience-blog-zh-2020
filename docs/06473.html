<html>
<head>
<title>Build your first data warehouse with Airflow on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP建立你的第一个数据仓库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-your-first-data-warehouse-with-airflow-on-gcp-fdd0c0ad91bb?source=collection_archive---------6-----------------------#2020-05-23">https://towardsdatascience.com/build-your-first-data-warehouse-with-airflow-on-gcp-fdd0c0ad91bb?source=collection_archive---------6-----------------------#2020-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f9cd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建数据仓库的步骤是什么？你应该使用什么云技术？如何利用气流来协调你的管道？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e79263991a639835c6de9742f7099a7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAhhmZeg89AYu3ZXRSHK4w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这个项目的架构</p></figure><p id="372c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">作为一名数据专业人员，气流已经成为我的工具集的重要组成部分。在我之前的帖子之后，很多人联系我，询问如何开始学习气流。和许多其他事情一样，我相信开始学习一件事情的最好方法是通过实践。</p><p id="8c31" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个项目中，我们将在谷歌云平台上建立一个数据仓库，帮助回答常见的业务问题，并为仪表盘提供动力。您将直接体验如何构建DAG来实现常见的数据工程任务:从数据源提取数据，加载到数据接收器，转换数据并为业务消费建模。</p><p id="7213" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你不知道什么是气流或者需要帮助来设置它，看看我以前的帖子。</p><div class="lu lv gp gr lw lx"><a rel="noopener follow" target="_blank" href="/getting-started-with-airflow-locally-and-remotely-d068df7fcb4"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd iu gy z fp mc fr fs md fu fw is bi translated">从本地和远程开始使用气流</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">气流已经存在了一段时间，但最近它获得了很大的牵引力。那么什么是气流呢？你如何使用…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">towardsdatascience.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml ks lx"/></div></div></a></div><h1 id="f8be" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">为什么选择谷歌云平台？</h1><p id="ec93" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">简短的回答是BigQuery。虽然市场上有许多数据仓库解决方案，或者作为云提供商的解决方案，或者作为内部部署，但我对BigQuery的体验是最愉快的。</p><h2 id="a937" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">费用</h2><p id="57ea" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">首先，定价模式简单明了，无论规模大小都可以承受。您不需要为一个永不停机的实例(向您眨眼、红移)付费，而是每月每TB存储花费20美元，每次查询时每TB扫描花费5美元。</p><p id="a396" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设您的数据集大小为200GB，这对于结构化数据集来说相当大。你每月只需支付2美元的仓储费。就查询成本而言，您也不会花费太多，因为BigQuery是一个列数据库，这意味着每次查询时，引擎不会扫描整个表，而是只扫描您选择的列，这取决于您构建数据仓库的方式，这是一个显著的成本节约。粗略估计，您一个月将扫描所有数据大约50次，这相当于扫描10TB，花费您50美元。</p><p id="d98a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，对于一个规模合理的结构化数据仓库，每月只需52美元，相比之下，最便宜的始终在线红移实例每月需要146美元。如果最低层的红移不能满足您的需求，那么无论您是否大量使用您的数据仓库，您每月都要支付大约2，774美元。对我来说，BigQuery的按需定价更可取。</p><h2 id="ba2a" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">易用性</h2><p id="d270" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">这更多的是个人意见，而不是确凿的事实，但我认为GCP比AWS更方便用户。在GCP，从浏览器中维护权限或查询数据等操作通常更加用户友好。此外，BigQuery会自动进行许多优化，在后台为您加速查询。</p><h1 id="516f" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">商业目标</h1><p id="2da0" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">在着手进行任何数据仓库项目之前，您应该有一个明确定义的、您试图解决的业务问题。对于这个项目，我选择了美国政府提供的I94移民数据，以及几个补充数据集。</p><p id="28f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设你是美国移民局的数据工程师。你的老板找到你，说目前分析移民模式的方法是手工的，耗时且容易出错。他希望您提出一个解决方案，使分析过程更加简单、快速和可扩展。</p><blockquote class="nv nw nx"><p id="2896" class="ky kz ny la b lb lc ju ld le lf jx lg nz li lj lk oa lm ln lo ob lq lr ls lt im bi translated">该数据仓库将帮助美国官员分析移民模式，以了解是什么因素驱使人们迁移。</p></blockquote><h1 id="c64a" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">数据集</h1><p id="ef1d" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">您可以为这个项目选择任何免费的数据源，并遵循。你可以在<a class="ae oc" href="https://www.kaggle.com/datasets" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>或者<a class="ae oc" href="https://datasetsearch.research.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌数据集搜索</a>上找到很多有用的数据集。以下是这个项目中使用的数据集。</p><ul class=""><li id="81d5" class="od oe it la b lb lc le lf lh of ll og lp oh lt oi oj ok ol bi translated">I94移民数据:该数据来自美国<a class="ae oc" href="https://travel.trade.gov/research/reports/i94/historical/2016.html" rel="noopener ugc nofollow" target="_blank">国家旅游和贸易办公室</a>。</li><li id="978d" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">I94数据字典:字典伴随着I94移民数据</li><li id="8a1e" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">世界温度数据:该数据集来自<a class="ae oc" href="https://www.kaggle.com/berkeleyearth/climate-change-earth-surface-temperature-data" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>。</li><li id="4f52" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">美国城市人口统计数据:该数据来自OpenSoft。你可以在这里阅读更多信息<a class="ae oc" href="https://public.opendatasoft.com/explore/dataset/us-cities-demographics/export/" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="1809" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">机场代码表:这是一个简单的机场代码和相应城市的表格。这里来自<a class="ae oc" href="https://datahub.io/core/airport-codes#data" rel="noopener ugc nofollow" target="_blank">这里来自</a>。</li></ul><h1 id="ccd2" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">数据建模</h1><p id="bc94" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">根据原始数据，我们的下一步是为数据仓库设计一个数据模型。数据模型应该与业务目标和您试图回答的问题紧密联系在一起。</p><p id="b3e7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我根据星型模式原理设计了以下模型，其中包含一个事实表和七个维度表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/c059311f3ea571ce76118fabef4275f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8nXC8P0v7qI5146Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们数据仓库的数据模型</p></figure><ul class=""><li id="3a63" class="od oe it la b lb lc le lf lh of ll og lp oh lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">F_IMMIGRATION_DATA</code>:包含入境信息，如到达日期、离开日期、签证类型、性别、原籍国等。</li><li id="bc39" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_TIME</code>:包含日期列的维度</li><li id="f141" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_PORT</code>:包含端口标识和端口名称</li><li id="efde" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_AIRPORT</code>:包含州内的机场</li><li id="6682" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_STATE</code>:包含状态标识和状态名称</li><li id="5ccd" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_COUNTRY</code>:包含国家标识和国家名称</li><li id="13c1" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_WEATHER</code>:包含一个州的平均天气</li><li id="1fb1" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated"><code class="fe os ot ou ov b">D_CITY_DEMO</code>:包含一个城市的人口统计信息</li></ul><h1 id="a146" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">体系结构</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e79263991a639835c6de9742f7099a7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAhhmZeg89AYu3ZXRSHK4w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这个项目的架构</p></figure><p id="b7fe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将跳过从不同数据库中提取数据的步骤，并假设我们在Google云存储(GCS)中拥有这个项目的所有数据。</p><p id="87d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">GCS将作为存储所有原始文件的数据源。然后，数据将被加载到BigQuery上的临时表中。ETL过程将从这些临时表中获取数据，并创建数据仓库表。</p><p id="02f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Airflow实例部署在Google计算引擎上或本地，以协调我们管道的执行。</p><p id="12b7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是使用这些技术的理由:</p><ul class=""><li id="8306" class="od oe it la b lb lc le lf lh of ll og lp oh lt oi oj ok ol bi translated">谷歌云存储:充当我们的数据源，纵向可扩展。</li><li id="602c" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">Google Big Query:充当数据仓库、数据集市和ETL过程的数据库引擎。BigQuery是一种无服务器的解决方案，可以高效地处理Pb级数据集。</li><li id="d927" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">Apache Airflow:通过发出CLI命令将数据加载到BigQuery或SQL查询中以执行ETL过程，从而协调工作流。Airflow本身不需要处理任何数据，因此允许我们的管道进行扩展。</li></ul><h1 id="6261" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">建立基础设施</h1><p id="bea9" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">要运行这个项目，你应该有一个GCP帐户。您可以免费创建一个新的Google帐户，并获得300美元的点数。与免费学分和免费层，你应该通过这个项目，无需支付任何费用。你可以参考我以前的文章<a class="ae oc" rel="noopener" target="_blank" href="/getting-started-with-airflow-locally-and-remotely-d068df7fcb4">这里</a>在谷歌计算引擎实例上设置气流，并在这里运行我的代码<a class="ae oc" href="https://github.com/tuanchris/cloud-data-lake/blob/master/src/setup_gcp_iac.py" rel="noopener ugc nofollow" target="_blank">来轻松地为项目创建必要的云资源。</a></p><p id="ef3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">否则，您可以使用GCP用户界面创建GCS bucket、BigQuery数据集和BigQuery表。</p><ul class=""><li id="473d" class="od oe it la b lb lc le lf lh of ll og lp oh lt oi oj ok ol bi translated">创建一个关于GCP的项目</li><li id="88e5" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">通过添加信用卡启用计费(您有价值300美元的免费点数)</li><li id="9b5c" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">导航到IAM并创建一个服务帐户</li><li id="3ae8" class="od oe it la b lb om le on lh oo ll op lp oq lt oi oj ok ol bi translated">授予帐户项目所有者。这对于本项目来说很方便，但不建议用于生产系统。你应该把钥匙放在安全的地方。</li></ul><p id="17fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以通过运行以下命令将数据复制到存储桶中:</p><pre class="kj kk kl km gt ow ov ox oy aw oz bi"><span id="230e" class="nj mn it ov b gy pa pb l pc pd">gsutil cp -r gs://cloud-data-lake-gcp/ gs://{your_bucket_name}</span></pre><p id="ae6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">查看我的GitHub <a class="ae oc" href="https://github.com/tuanchris/cloud-data-lake#gcp-setup" rel="noopener ugc nofollow" target="_blank"> repo </a>了解更多信息。</p><h1 id="c5ee" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">数据管道</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/1fad8c92a0b4170abc64343516ff6277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QL9cdTGObXcYQW-I.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据管道</p></figure><p id="cb4d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">随着所有的设计和设置的方式，我们可以开始与这个项目的实际管道。下面用的代码可以参考我的GitHub repo。</p><div class="lu lv gp gr lw lx"><a href="https://github.com/tuanchris/cloud-data-lake" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd iu gy z fp mc fr fs md fu fw is bi translated">Tuan Chris/云数据湖</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">该项目在谷歌云平台上创建了一个数据湖，主要侧重于建立一个数据仓库和数据…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">github.com</p></div></div><div class="mg l"><div class="pe l mi mj mk mg ml ks lx"/></div></div></a></div><p id="2c8e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个<code class="fe os ot ou ov b">DummyOperator</code> start_pipeline启动流水线，随后是四个加载操作。这些操作将数据从GCS bucket加载到BigQuery表中。<code class="fe os ot ou ov b">immigration_data</code>被加载为<code class="fe os ot ou ov b">parquet</code>文件，而其他的被格式化为<code class="fe os ot ou ov b">csv</code>。在装载到BigQuery后，有检查行的操作。</p><p id="ff63" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，管道从I94数据字典加载三个主数据对象。然后创建<code class="fe os ot ou ov b">F_IMMIGRATION_DATA</code>表，并检查以确保没有重复。还创建了其他维度表，管道也完成了。</p><h2 id="f566" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">导入气流库</h2><p id="e6a5" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">定义新dag的第一件事是从Airflow导入所需的库。我们应该从Airflow导入DAG，以及您希望使用的任何操作符。您可以阅读Airflow文档，了解操作员的工作内容和使用方法。</p><p id="bd50" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不同的操作符可以有相同的参数，每次使用操作符时定义所有相同的参数是重复的。这就是为什么您应该定义一个默认的set参数，它将被传递给所有的任务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h2 id="9340" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">定义DAG</h2><p id="9257" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">接下来要做的是定义一个DAG。您应该给它一个唯一的名称、开始日期和schedule_interval。您还可以将上面定义的默认参数传递到DAG。</p><p id="0111" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以使用Airflow <a class="ae oc" href="https://airflow.apache.org/docs/stable/concepts.html#variables" rel="noopener ugc nofollow" target="_blank">变量</a>传入变量，而不是像我下面这样在DAG定义代码中定义。经验法则是，对于经常变化的变量，使用气流变量。否则，您可以不使用标准的Python变量。请记住，您不应该定义大量的气流变量；否则，您可能会使气流的元数据数据库过载。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h2 id="facd" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">从GCS定义加载任务</h2><p id="5b47" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">对于我们的四个数据集，我们将使用<code class="fe os ot ou ov b">GoogleCloudStorageToBigQueryOperator</code>将数据从GCS加载到BigQuery。您可以阅读Airflow文档，了解更多关于如何将变量传递给操作符的信息。</p><p id="d8e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的例子中，我们加载CSV格式的尺寸文件和parquet格式的<code class="fe os ot ou ov b">immigration</code>数据。请注意，对于CSV文件，您应该提供一个模式来确保以预期的格式加载数据。对于parquet格式，您不需要这样做，因为parquet文件已经附带了一个模式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h2 id="5413" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">定义数据检查</h2><p id="635f" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">在我们将数据加载到BigQuer之后，我们应该检查我们之前的任务是否按预期运行。我们可以通过检查表中的行数来验证是否有行存在。根据您的业务需求，您可以在这里实现更复杂的数据质量检查。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h2 id="5fd9" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">创建事实和维度表</h2><p id="5c04" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">在临时数据集中加载并检查了临时数据后，我使用BigQueryOperator执行SQL查询来转换和加载事实表和dim表。</p><p id="f491" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，我在查询中传递参数，而不是数据集和表。这使得在开发和生产环境之间切换变得更加容易。查看我在GitHub repo中的SQL查询，找出我在转换中使用了什么逻辑。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h2 id="181c" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">定义任务相关性</h2><p id="aa4a" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">最后，我们必须定义任务依赖性，即哪些任务相互依赖。您可以使用<code class="fe os ot ou ov b">&gt;&gt;</code>或<code class="fe os ot ou ov b">&lt;&lt;</code>操作符来实现。您也可以使用列表对多个任务进行分组。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pf pg l"/></div></figure><h1 id="1c0e" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">结果</h1><p id="bdb4" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">在所有这些步骤之后，您将有一个数据仓库呈现给您的老板。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/21bd424b81c011a2b5f621dc9e7c423c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iX6rdzvZsLMLyGGTVkP5xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的数据仓库</p></figure><p id="bfab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们运行一下我们的数据仓库。让我们看看哪些州的移民人数最多。在我们的数据集中，佛罗里达的移民人数最多，其次是纽约和加利福尼亚。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pi"><img src="../Images/9e8ad0daa5e1f8566e3648e252012932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jSB5FHZTh7JV3IbWzmFGKw.png"/></div></div></figure><p id="57c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">谁要移民到美国，他们的性别是什么？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/c7f01ca0607221b410d2f762c1ffe18f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sovm8dkb7q3wRdtX5y8o9Q.png"/></div></div></figure><h2 id="0c12" class="nj mn it bd mo nk nl dn ms nm nn dp mw lh no np my ll nq nr na lp ns nt nc nu bi translated">打扫</h2><p id="b23c" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">请记住关闭Airflow实例/删除未使用的资源，以避免不必要的费用。</p><h1 id="4994" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">摘要</h1><p id="84fa" class="pw-post-body-paragraph ky kz it la b lb ne ju ld le nf jx lg lh ng lj lk ll nh ln lo lp ni lr ls lt im bi translated">在本文中，我使用Airflow作为编排器，完成了在GCP设计和部署数据仓库的许多步骤。如您所见，这是一个漫长而复杂的过程，因此我无法在一篇文章中涵盖所有内容。</p><p id="05d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望你能更好地理解数据工程师是做什么的，并能运用这些知识。</p><p id="dfa9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">快乐学习！</p></div></div>    
</body>
</html>