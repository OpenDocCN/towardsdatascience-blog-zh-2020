<html>
<head>
<title>Ansible — Ports Monitoring.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ansible —端口监控。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ansible-ports-monitoring-15f48c8e208e?source=collection_archive---------23-----------------------#2020-06-17">https://towardsdatascience.com/ansible-ports-monitoring-15f48c8e208e?source=collection_archive---------23-----------------------#2020-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ff7e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">今天，我将向您展示Ansible如何简化我们在监控服务器间网络通信时可能面临的技术难题。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/dde08d0bdc62f7bb06da471e37b3ac1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*JADg8mzTZ13nZuQm2HuJnA.png"/></div></figure><p id="658b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">事实上，在像银行业这样高度敏感的行业中，港口受到严格的监管，只有必要的港口才允许SecOps开放。否则，不受监管的端口可能成为DDOS等网络攻击的诱人目标。</p><p id="1c40" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了更容易地解释事情，让我们想象一组名为<strong class="kp ir">源</strong>的主机应该与另一组名为<strong class="kp ir">目标</strong>的主机通信，只通过授权的<strong class="kp ir">端口</strong>。</p><p id="9d09" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">主机</strong>可以是cloud、docker、VM、metal server……端口可以是任何(https 443、SMTP 25、PostgreSQL 5432、Ldap 389、elk 9200、Redis 6379或任何其他定制端口)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lj"><img src="../Images/b012c0e369e0a43ca2ae2e75282a9e47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zA1bV3eHBFIra0rj0YVcLg.png"/></div></div></figure><p id="d9c2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在我们到了有趣的部分:)</p><p id="4f9b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">众所周知，SRE/DevOps最重要的职责是监控。那么，SRE团队如何轻松有效地监控服务器间的端口通信，尤其是在大型库存上？</p><p id="2902" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">他们如何在每个网络修补程序后执行运行状况检查，以确认没有退化？</p><p id="d4dd" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">更重要的是，他们如何在服务中断期间快速可靠地检查问题是否来自主机网络内部通信问题？</p><p id="4bc4" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">编排前(Ansible，Terraform..)，解决方案是创建一个shell、PowerShell或python脚本来telnet或ping任何目标主机。这种解决方案的最大缺点是必须在所有源服务器上一个接一个地手动启动脚本。</p><p id="b326" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">有了Ansible，事情变得更加智能、自动化和简单。</p><p id="bc06" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">事实上，我们可以创建一个任务(可以是cron作业),该任务将在所有源主机上执行，以通过定义的端口检查与所有目标主机的通信，并在出现问题时发送报告/警报。</p><p id="b11f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在让我们转到编码部分:)</p><p id="8a8f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们将从创建ansible主任务开始:<br/><strong class="kp ir">roles/ansi ble-role-ports/tasks/main . yml</strong></p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="a9b0" class="lt lu iq lp b gy lv lw l lx ly">---<br/>- name: Check global ports<br/>  wait_for:<br/>    host: "{{ item.name }}"<br/>    port: "{{ item.port }}"<br/>    state: started         # Port should be open<br/>    delay: 0               # No wait before first check (sec)<br/>    timeout: 3             # Stop checking after timeout (sec)<br/>  ignore_errors: yes<br/>  with_items: "{{ server_to_test }}"</span></pre><p id="482c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是主要的ansible角色任务，指示将通过端口“item.port”从“item.name”远程登录到“server_to_test”中的主机列表。</p><p id="0471" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在让我们创建我们的游戏:<br/><strong class="kp ir">plays/ports/ports . yml</strong></p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="67ef" class="lt lu iq lp b gy lv lw l lx ly">---<br/>- name: check ports<br/>  hosts: "{{ host }}"<br/>  become: yes<br/>  become_user: root<br/>  roles:<br/>    - ansible-role-ports</span></pre><p id="a36a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是一个可行的<strong class="kp ir">行动</strong>，它将使用清单中的源主机和目标主机来调用任务。</p><p id="bebe" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">关于清单，它只是列出了主机(源和目标)，每个主机都有一个group_vars参数，该参数指定了用于每组源服务器的目标主机和目标端口。</p><p id="3cd8" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">inventory/hosts-update . yml</strong></p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="b832" class="lt lu iq lp b gy lv lw l lx ly">source1:<br/>  hosts:<br/>    host1:<br/>      ansible_host: ip-source1-host1<br/>      host_name: source1-host1<br/>    host2:<br/>      ansible_host: ip-source1-host2<br/>      host_name: source1-host2<br/>      <br/>source2:<br/>  hosts:<br/>    host1:<br/>      ansible_host: ip-source2-host1<br/>      host_name: source2-host1<br/>    host2:<br/>      ansible_host: ip-source2-host2<br/>      host_name: source2-host2<br/>      <br/>target1:<br/>  hosts:<br/>    host1:<br/>      ansible_host: ip-target1-host1<br/>      host_name: target1-host1<br/>    host2:<br/>      ansible_host: ip-target1-host2<br/>      host_name: target1-host2     <br/>      <br/>target2:<br/>  hosts:<br/>    host1:<br/>      ansible_host: ip-target2-host1<br/>      host_name: target2-host1<br/>    host2:<br/>      ansible_host: ip-target2-host2<br/>      host_name: target2-host2</span></pre><p id="4c3c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最后是每组源主机的group_vars:</p><p id="2065" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">inventory/group _ vars/source 1 . yml</strong></p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="c497" class="lt lu iq lp b gy lv lw l lx ly">---<br/>server_to_test:<br/>  - {name: 'target1', port: 'port1'}#target1<br/>  - {name: 'target1', port: 'port2'}#target1<br/>  <br/>  - {name: 'target2', port: 'port1'}#target2<br/>  - {name: 'target2', port: 'port2'}#target2</span></pre><p id="e9cf" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">inventory/group _ vars/source 2 . yml</strong></p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="bf07" class="lt lu iq lp b gy lv lw l lx ly">---<br/>server_to_test:<br/>  - {name: 'target1', port: 'port3'}#target1<br/>  - {name: 'target1', port: 'port4'}#target1</span></pre><p id="60aa" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">该剧的用法如下:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="b5ed" class="lt lu iq lp b gy lv lw l lx ly">---<br/>ansible-playbook -i inventory/hosts-update.yml plays/ports/ports.yml — extra-vars ‘{“host”:”source1,source2”}’ -k -K -vv -u “USER”</span></pre><p id="d0c0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Source1、source2可由任何其他主机集更改。</p><p id="0f71" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们结束了，所以一如既往，我希望你学到了新的东西。<br/>再见:)</p><p id="66dc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">萨拉姆。</p></div></div>    
</body>
</html>