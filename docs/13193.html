<html>
<head>
<title>Audio Onset Detection: Data preparation for a baseball application using Librosa</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">音频开始检测:使用 Librosa 为棒球应用程序准备数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/audio-onset-detection-data-preparation-for-a-baseball-application-using-librosa-7f9735430c17?source=collection_archive---------30-----------------------#2020-09-10">https://towardsdatascience.com/audio-onset-detection-data-preparation-for-a-baseball-application-using-librosa-7f9735430c17?source=collection_archive---------30-----------------------#2020-09-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9ebb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用声音来识别视频中的击球时间</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0bdcdeb7d00620735d5a2bab3084db73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0i8sW50hPYBIRx_F"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@chris_chow?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">周隼</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><h1 id="cb55" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="bdf2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我希望为棒球应用程序建立一个深度学习项目，其中一个挑战是数据收集。我需要很多击球手击球的短片。但是我在网上找不到这种数据集，因此，我决定自己收集和制作数据集。</p><p id="d5c8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我发现的大多数棒球击球视频在一个长视频剪辑中包含多次击球，例如:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="02e3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我需要找到击球的瞬间，把它们剪下来，分成短片。一种简单的方法是手工操作，但是这非常费时费力。</p><p id="bcd4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我需要一个工具来自动完成这项工作。</p><p id="6d4f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">受郑健国作品《<a class="ae ky" href="https://tht.fangraphs.com/building-a-robot-umpire-with-deep-learning-video-analysis/" rel="noopener ugc nofollow" target="_blank">用深度学习视频分析</a>构建机器人裁判》的启发，我决定尝试一下<strong class="lt iu"> <em class="mu">【发病检测】</em> </strong>。</p><p id="724c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">经过一些研究和阅读教程，如<a class="ae ky" href="https://musicinformationretrieval.com/onset_detection.html" rel="noopener ugc nofollow" target="_blank">这个</a>，我使用<strong class="lt iu"> librosa 的发作检测</strong>功能。</p><h1 id="985c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">加载视频</h1><p id="f807" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">第一步是从 YouTube 下载并加载视频。我用<a class="ae ky" href="https://pythonhosted.org/pafy/" rel="noopener ugc nofollow" target="_blank"> pafy </a>做的。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="837d" class="na la it mw b gy nb nc l nd ne">filename='batting_pratice' <br/>url='https://www.youtube.com/watch?v=dbZy8Q6J7pw' <br/>video = pafy.new(url)<br/>clip = video.getbest(preftype="mp4")<br/>clip.download()<br/>os.rename(clip.filename,filename+'.mp4')</span></pre><p id="f10d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该视频现已下载并保存为“batting _ pratice.mp4”</p><h1 id="06e3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">加载音频</h1><p id="b3eb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">然后我可以用<a class="ae ky" href="https://librosa.org/doc/latest/index.html" rel="noopener ugc nofollow" target="_blank"> librosa </a>加载音频。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="c129" class="na la it mw b gy nb nc l nd ne">x, sr = librosa.load(filename+'.mp4')</span></pre><p id="2f06" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果你感兴趣就去玩吧。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="c35f" class="na la it mw b gy nb nc l nd ne">ipd.Audio(data=x, rate=sr)</span></pre><p id="bef3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">并绘制波形图</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="2b1c" class="na la it mw b gy nb nc l nd ne">plt.figure(figsize=(14, 5))<br/>librosa.display.waveplot(x, sr=sr)<br/>plt.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/a6e1e86bfc4d5ef5dca84bbc8e777bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NSL_atNQZH_6KJrjqSZcyA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">音频波形图(图片由作者提供)</p></figure><p id="dab8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你可以看到有一些尖刺，是击球的声音。工作是确定它们的时间。</p><h1 id="775b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">应用过滤器</h1><p id="0365" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一个额外的步骤是使用高通滤波器过滤一些低频噪声。可以使用 scipy 来完成。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="b3f6" class="na la it mw b gy nb nc l nd ne">from scipy.signal import butter,filtfilt</span><span id="406f" class="na la it mw b gy ng nc l nd ne"><strong class="mw iu">def</strong> butter_highpass(data,cutoff, fs, order=5):<br/>   """<br/>   Design a highpass filter.<br/>   Args:<br/>   - cutoff (float) : the cutoff frequency of the filter.<br/>   - fs     (float) : the sampling rate.<br/>   - order    (int) : order of the filter, by default defined to 5.<br/>   """<br/>   # calculate the Nyquist frequency<br/>   nyq = 0.5 * fs<br/>   # design filter<br/>   high = cutoff / nyq<br/>   b, a = butter(order, high, btype='high', analog=False)<br/>   # returns the filter coefficients: numerator and denominator<br/>   y = filtfilt(b, a, data)<br/>   return y</span><span id="f271" class="na la it mw b gy ng nc l nd ne">x_f=butter_highpass(x,1000, sr, order=5)</span></pre><h1 id="3350" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">发病检测</h1><p id="d1b6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">然后我们可以开始发作检测，我们使用<em class="mu"> librosa.onset </em>。详细介绍可以在他们的<a class="ae ky" href="https://librosa.org/doc/latest/generated/librosa.onset.onset_detect.html#librosa.onset.onset_detect" rel="noopener ugc nofollow" target="_blank"> doc </a>中找到。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="6721" class="na la it mw b gy nb nc l nd ne">o_env = librosa.onset.onset_strength(x_f, sr=sr)<br/>times = librosa.frames_to_time(np.arange(len(o_env)), sr=sr)<br/>onset_frames = librosa.util.peak_pick(o_env, 3, 3, 3, 5, 0.3, 100)</span></pre><p id="b77b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这之后，我们应该看到存储在 onset_frames 中的峰值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/d99b8960a994ecd6fb0ed1fc2844909e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*csJzR4QK-c8Jyw_jqwEnlQ.png"/></div></div></figure><p id="71ab" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后我们可以绘制它并检查。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="a9ac" class="na la it mw b gy nb nc l nd ne">D = np.abs(librosa.stft(x_f))</span><span id="2a41" class="na la it mw b gy ng nc l nd ne">plt.figure(figsize=(15,10))</span><span id="70e4" class="na la it mw b gy ng nc l nd ne">ax1 = plt.subplot(2, 1, 1)<br/>librosa.display.specshow(librosa.amplitude_to_db(D, ref=np.max),<br/>x_axis='time', y_axis='log')<br/>plt.title('Power spectrogram')</span><span id="c491" class="na la it mw b gy ng nc l nd ne">plt.subplot(2, 1, 2, sharex=ax1)<br/>plt.plot(times, o_env, label='Onset strength')<br/>plt.vlines(times[onset_frames], 0, o_env.max(), color='r', alpha=0.9,<br/>linestyle='--', label='Onsets')</span><span id="3938" class="na la it mw b gy ng nc l nd ne">plt.axis('tight')<br/>plt.legend(frameon=True, framealpha=0.75)<br/>plt.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/289d45d7f70d07163d475df24d139e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xDrYs-qQkoSD855J1QNZEg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">发病检测(图片由作者提供)</p></figure><p id="f1a9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">看起来我们确定了所有的发病点。</p><p id="df82" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，我们可以将 onset_frames 转换为时间:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="ce2d" class="na la it mw b gy nb nc l nd ne">onset_times = librosa.frames_to_time(onset_frames)</span></pre><p id="c020" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这会返回一个时间数组。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/105421e30039005eaae640b31386f540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*26IFXbSAYxxp22M3oi2Dyg.png"/></div></div></figure><p id="d664" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，我们可以将数据放入数据帧中，并在特定时间创建 youtube URLs。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/5624cda47c8720466770f1d2667041d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90HfMtjmcI6QOs0nzR7k3Q.png"/></div></div></figure><p id="29dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">检查其中一个<a class="ae ky" href="https://www.youtube.com/watch?v=dbZy8Q6J7pw&amp;feature=youtu.be&amp;t=29" rel="noopener ugc nofollow" target="_blank">示例</a>。成功了！</p><h1 id="ae1d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">切断视频</h1><p id="aff8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">然后，我们可以使用计时将视频剪切成短片。我想要 3 秒的剪辑，所以我从(开始时间-1.5)到(开始时间+1.5)开始。这可以使用 ffmpeg 来完成。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="4851" class="na la it mw b gy nb nc l nd ne">for hit_time in onset_times:</span><span id="9adc" class="na la it mw b gy ng nc l nd ne">ffmpeg_extract_subclip(filename+'.mp4',round(hit_time)-1.5,    <br/>     round(hit_time)+1.5,  <br/>     targetname=filename+'/'+filename+'_'+str(int(hit_time))+".mp4")</span></pre><p id="f22f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，我有了一个工具，可以根据声音来检测击球，并自动进行切割。下一步将使用该工具收集更多数据，用于进一步培训。</p><p id="d94a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢阅读。欢迎提出建议和意见。</p><p id="7501" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里支持我:【https://medium.com/@c.kuan/membership】T2</p></div></div>    
</body>
</html>