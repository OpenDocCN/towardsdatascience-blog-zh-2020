<html>
<head>
<title>How to do time series forecasting in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BigQuery中进行时间序列预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-time-series-forecasting-in-bigquery-af9eb6be8159?source=collection_archive---------21-----------------------#2020-03-30">https://towardsdatascience.com/how-to-do-time-series-forecasting-in-bigquery-af9eb6be8159?source=collection_archive---------21-----------------------#2020-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5172" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用BigQuery ML中的ARIMA模型进行需求预测</h2></div><p id="62d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们根据过去的六周，对海德公园的一个自行车站开始的自行车租赁数量进行两周预测。</p><h2 id="ae18" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">收集培训数据</h2><p id="18ea" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">与任何机器学习问题一样，第一步是收集训练数据并探索它。假设我们有截至2015年6月中旬的租赁数据，我们希望预测这个月的剩余时间。我们可以使用以下工具收集过去6周的数据:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="cc5d" class="lb lc iq me b gy mi mj l mk ml">SELECT<br/>   CAST(EXTRACT(date from start_date) AS TIMESTAMP) AS date<br/>   , COUNT(*) AS numrentals<br/>FROM<br/>  `bigquery-public-data`.london_bicycles.cycle_hire<br/>WHERE start_station_name LIKE '%Hyde%'  -- all stations in Hyde Park<br/>GROUP BY date<br/>HAVING date BETWEEN '2015-05-01' AND '2015-06-15'<br/>ORDER BY date</span></pre><p id="65aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">绘制该图时，我们看到一种每周趋势，即周末租金上涨:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/0308e9bdf43782db88c268a19de6a737.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*tO5yNkhOlbVyvBs5IPaRTw.png"/></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">史料</p></figure><h2 id="d21d" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">火车ARIMA模型</h2><p id="3e13" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们可以使用这些数据来训练ARIMA模型，告诉BigQuery哪一列是数据列，哪一列是时间戳列:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f501" class="lb lc iq me b gy mi mj l mk ml">CREATE OR REPLACE MODEL ch09eu.numrentals_forecast</span><span id="8bec" class="lb lc iq me b gy mu mj l mk ml">OPTIONS(model_type='ARIMA',<br/>        time_series_data_col='numrentals',<br/>        time_series_timestamp_col='date') AS</span><span id="bfaa" class="lb lc iq me b gy mu mj l mk ml">SELECT<br/>   CAST(EXTRACT(date from start_date) AS TIMESTAMP) AS date<br/>   , COUNT(*) AS numrentals<br/>FROM<br/>  `bigquery-public-data`.london_bicycles.cycle_hire<br/>WHERE start_station_name LIKE '%Hyde%'  -- all stations in Hyde Park<br/>GROUP BY date<br/>HAVING date BETWEEN '2015-05-01' AND '2015-06-15'</span></pre><p id="f09b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦模型被训练，我们就可以使用ML来评估它。评估()并使用ML查看ARIMA系数。ARIMA系数()。</p><h2 id="dd49" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">预测</h2><p id="85de" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们可以预测未来14天每天的租赁数量，并使用以下公式获得第90个百分位数的置信界限:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="187d" class="lb lc iq me b gy mi mj l mk ml">SELECT * FROM ML.FORECAST(MODEL ch09eu.numrentals_forecast, <br/>                  STRUCT(14 AS horizon, 0.9 AS confidence_level))</span></pre><p id="e969" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">历史、预测和置信界限可以用以下公式绘制:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4b52" class="lb lc iq me b gy mi mj l mk ml">import matplotlib.pyplot as plt<br/>import pandas as pd<br/>def plot_historical_and_forecast(input_timeseries, forecast_output, timestamp_col_name, data_col_name):<br/>  plt.figure(figsize=(20,6))<br/>  plt.plot(input_timeseries[timestamp_col_name], input_timeseries[data_col_name], label = 'Historical')<br/>  plt.xlabel(timestamp_col_name)<br/>  plt.ylabel(data_col_name)</span><span id="1793" class="lb lc iq me b gy mu mj l mk ml">forecast_output['forecast_timestamp'] = pd.to_datetime(forecast_output['forecast_timestamp'])<br/>  x_data = forecast_output['forecast_timestamp']<br/>  y_data = forecast_output['forecast_value']<br/>  confidence_level = forecast_output['confidence_level'].iloc[0] * 100<br/>  low_CI = forecast_output['confidence_interval_lower_bound']<br/>  upper_CI = forecast_output['confidence_interval_upper_bound']</span><span id="293d" class="lb lc iq me b gy mu mj l mk ml"># Plot the data, set the linewidth, color and transparency of the<br/>  # line, provide a label for the legend<br/>  plt.plot(x_data, y_data, alpha = 1, label = 'Forecast', linestyle='--')<br/>  # Shade the confidence interval<br/>  plt.fill_between(x_data, low_CI, upper_CI, color = '#539caf', alpha = 0.4, label = str(confidence_level) + '% confidence interval')<br/>  # Display legend<br/>  plt.legend(loc = 'upper center', prop={'size': 16})</span><span id="e9d3" class="lb lc iq me b gy mu mj l mk ml">plot_historical_and_forecast(df, fcst, 'date', 'numrentals')</span></pre><p id="ffe7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这会产生:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/8140912e8ede6cfad81bd67f3bb904da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bHwFxHEo7JyAgYuxQ1DUdA.png"/></div></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">历史数据和预测数据</p></figure><p id="0c4c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但这与6月下旬实际发生的情况相比有多好呢？我们可以提取这些天的数据，并与预测时间序列进行比较:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/c30cc29bacd35a51aa10223bd359168c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AvJHaPf3ABvXT_nRMh1zlA.png"/></div></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">历史、预测和实际发生的情况。</p></figure><p id="a8b5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很酷，是吧？</p><h2 id="bc7f" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">预测一系列</h2><p id="98e3" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">到目前为止，我一直在预测海德公园所有自行车站的总出租量。我们如何预测每个加油站的租赁量？使用时间序列标识列:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="89ab" class="lb lc iq me b gy mi mj l mk ml">CREATE OR REPLACE MODEL ch09eu.numrentals_forecast<br/>OPTIONS(model_type='ARIMA',<br/>        time_series_data_col='numrentals',<br/>        time_series_timestamp_col='date',<br/>        <strong class="me ir">time_series_id_col='start_station_name'</strong>) AS<br/>SELECT<br/>   <strong class="me ir">start_station_name</strong><br/>   , CAST(EXTRACT(date from start_date) AS TIMESTAMP) AS date<br/>   , COUNT(*) AS numrentals<br/>FROM<br/>  `bigquery-public-data`.london_bicycles.cycle_hire<br/>WHERE start_station_name LIKE '%Hyde%'  -- all stations in Hyde Park<br/>GROUP BY start_station_name, date<br/>HAVING date BETWEEN <strong class="me ir">'2015-01-01' </strong>AND '2015-06-15'</span></pre><p id="e0cb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，我现在不是在45天内(5月1日至6月15日)进行系列训练，而是在更长的时间内进行训练。这是因为总体时间序列比单个站点的时间序列更平滑，也更容易预测。因此，我们必须向模型展示一条更长的趋势线。</p><p id="1d06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，这个模型不是一个ARIMA模型，而是一个独立的ARIMA模型。的确，在做:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="ca0c" class="lb lc iq me b gy mi mj l mk ml">SELECT * <br/>FROM ML.ARIMA_COEFFICIENTS(MODEL ch09eu.numrentals_forecast)<br/>ORDER BY start_station_name</span></pre><p id="317e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为每个起点站名称提供一组单独的系数:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi na"><img src="../Images/4aee6931ca6c57a213b83bccba9af716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kPGyRkwiRVP0TpXSCOAxdw.png"/></div></div></figure><p id="6350" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意一些有趣的事情——每个站点都有不同复杂度的ARIMA模型！在引擎盖下，BigQuery ML进行自动超参数调优。虽然该模型被称为“ARIMA”，但底层算法实际上包括<a class="ae nb" href="https://cloud.devsite.corp.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-time-series#whats_inside_a_time_series_model" rel="noopener ugc nofollow" target="_blank">相当多的华而不实的功能</a>，包括异常检测、假日效应建模(用户需要指定假日区域)、季节性检测/建模和趋势建模。另外，不同的时间序列是并行训练的。</p><p id="642b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们进行预测时，我们将获得每个站和时间戳的预测:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="d0cc" class="lb lc iq me b gy mi mj l mk ml">SELECT <br/>  start_station_name,<br/>  forecast_timestamp, forecast_value<br/>FROM ML.FORECAST(MODEL ch09eu.numrentals_forecast, <br/>                  STRUCT(3 AS horizon, 0.9 AS confidence_level))<br/>ORDER By start_station_name, forecast_timestamp</span></pre><p id="a565" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为每个站点生成一个时间序列预测:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/b6e5438c6bd52b4cb46dd325f52e5947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*76mJqD0dD84qV-kGTahGQw.png"/></div></figure><p id="351c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GitHub 上的<a class="ae nb" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/bqml_arima/bqml_arima.ipynb" rel="noopener ugc nofollow" target="_blank">满满的笔记本里有各站的预报图。</a></p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nd"><img src="../Images/41320c72d59ac13820e883ebf5edb8a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzYI3jFy6wLho2h7OB24qQ.png"/></div></div></figure><p id="8bfd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模型评估可能有助于您预测哪个站的模型更好(季节性校正方差越低，预测就越容易，因此，模型应该越好-此处不能使用AIC，因为不同时间序列的AIC不具有可比性):</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="1764" class="lb lc iq me b gy mi mj l mk ml">SELECT * FROM ML.EVALUATE(MODEL ch09eu.numrentals_forecast)<br/>ORDER BY <strong class="me ir">variance</strong> DESC</span></pre><p id="0754" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">基于这些结果，我们预计海德公园角的预测是最差的，骑士桥是最好的:</p><figure class="lz ma mb mc gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ne"><img src="../Images/68ac933440bdfd437b403edd53c697d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ANMuyh0qRQYhUKuI5pTMsQ.png"/></div></div></figure><p id="53d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><h2 id="9a38" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">后续步骤</h2><ol class=""><li id="83ef" class="nf ng iq kh b ki lu kl lv ko nh ks ni kw nj la nk nl nm nn bi translated">在GitHub 上浏览<a class="ae nb" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/bqml_arima/bqml_arima.ipynb" rel="noopener ugc nofollow" target="_blank">完整笔记本。</a></li><li id="2776" class="nf ng iq kh b ki no kl np ko nq ks nr kw ns la nk nl nm nn bi translated">要了解更多关于BigQuery ML的内容，请阅读<a class="ae nb" href="https://www.amazon.com/Google-BigQuery-Definitive-Warehousing-Analytics/dp/1492044466" rel="noopener ugc nofollow" target="_blank"> BigQuery:权威指南的第9章。</a>这本书会定期更新这些博客文章，这样它就保持了权威性。</li></ol><p id="a6d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nt">感谢Xi·程和阿米尔·霍玛蒂的有益建议</em></p></div></div>    
</body>
</html>