# 预测华盛顿特区的自行车共享需求(下)

> 原文：<https://towardsdatascience.com/predicting-bike-sharing-demand-in-washington-d-c-part-2-56af211585a2?source=collection_archive---------81----------------------->

![](img/5b4f462e59ad65857e6270508b431c56.png)

马库斯·温克勒在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

2017 年，我写了这篇[帖子](/playing-with-prophet-on-bike-sharing-demand-time-series-1f14255f7ff0)，在那里我用 [Prophet](https://facebook.github.io/prophet/) 预测了华盛顿特区的自行车共享需求。当时，Prophet 只有几个月大，它只能将时间序列分解为趋势、季节性和假日部分。从那以后，Prophet 得到了很大的改进，并继续成为时间序列预测的默认技术之一。

[](https://facebook.github.io/prophet/) [## 先知

### Prophet 是一个用 R 和 Python 实现的预测程序。它速度很快，并提供完全自动化的预测…

facebook.github.io](https://facebook.github.io/prophet/) 

在这篇文章中，我将继续我以前的工作，并在模型中加入一些天气和环境变量。这应该提供额外的信息，可以用来改善我们原来的预测。数据集将与第一部分相同，取自华盛顿特区一个与预测[自行车共享需求](https://www.kaggle.com/c/bike-sharing-demand)相关的 Kaggle 竞赛。

在整篇文章中，我将扼要重述第 1 部分的内容，以便读者更容易理解。这个项目的所有代码都可以在这个 [repo](https://github.com/jroberayalas/bikes_prophet/blob/master/experiment.R) 中获得。

# 数据

数据集包含几个特征，包括:

*   日期时间(YYYY-MM-DD HH:MM:SS)
*   假日(作为一个二元变量，表示该日是否被视为假日)
*   天气状况(一个有 4 类的分类变量)
*   温度/表观温度(摄氏度)
*   相对湿度
*   风速
*   自行车租赁总数

该数据集提供了跨越两年(2011 年和 2012 年)的每小时租金数据。训练集由每个月的前 19 天组成，而测试集是从每月的第 20 天到月末。目标是预测测试集覆盖的每个小时内租赁的自行车总数，只使用租赁期之前可用的信息。

因为数据来自一场比赛，测试集不包含租赁自行车的总数，所以对于这个实验，它不能用于评估模型的性能。此外，Prophet 最适合处理每日周期数据，因此我必须将数据从每小时转换为每天。

在[第 1 部分](/playing-with-prophet-on-bike-sharing-demand-time-series-1f14255f7ff0)中，我考虑的特征是日期时间、假期和自行车租赁总数。这次我还将包括天气、表观温度、相对湿度和风速。选择是主观的，因为我认为这些是人们选择骑自行车出行的主要驱动因素。

# 设置

首先，我决定将竞赛网站提供的训练集分成三部分:2011 年全年用于模型拟合，2012 年上半年作为参数调优的验证集，2012 年下半年作为检验所选模型性能的测试集。虽然我们没有整个月的数据，但这似乎不是 Prophet 软件包的问题，因为它对丢失的数据很健壮。

对于数据操作，我广泛使用了 [tidyverse](https://www.tidyverse.org/packages/) 工具，自上一篇文章以来，这些工具也有了很大的改进。假设我们将每小时的数据汇总为每天的数据，我将所有外部特性的平均值作为每天的数据。

假日特性是一个二元变量，它只告诉我们日期是否是假日，但不提供它所指的是哪个假日的信息。对于第 1 部分，我必须做一些研究来确定这些日期，因为 Prophet 使用这些信息来正确地确定特定节日的贡献(这非常有用)。我用来获取这些信息的网站已经不存在了，但是我几年前写的代码仍然适用于 2011 年和 2012 年的美国联邦假日。

最后，需要一些调整的参数与我们希望给予模型的灵活性有关，以适应变点、季节性、节假日和外部特征。进行非详尽的网格搜索只是为了对参数的最佳值有一个模糊的概念。我不得不限制可能的值，因为旧代码在网格搜索过程中遇到了问题。此外，这次我将*回归变量 _ 先验 _ 尺度*作为一个超参数。如果用户对手头的任务有一些专业知识，可以跳过这整个步骤。

# 模型

使用平均绝对误差(MAE)作为性能度量来执行网格搜索，以识别最佳参数。考虑到我们包括外部信息，模型设置略有不同。首先，需要初始化 Prophet 模型，然后在拟合模型之前，需要手动添加每个外生特征。更多详情，请查看[文档](https://facebook.github.io/prophet/docs/seasonality,_holiday_effects,_and_regressors.html#additional-regressors)。

找到的最佳参数是:

*   运载能力:8000 人
*   变点先验标度:0.5
*   季节性先验标度:10
*   假日优先比例:1
*   回归变量先验标度:10

然后使用这些参数用训练集和验证集重新训练该模型。完成后，Prophet 提供了一个功能，可以绘制出时间序列中的不同部分。这些显示如下，可以观察到一些有趣的事情。首先，似乎有些节日会增加租赁数量(如独立日——7 月 4 日),而其他节日则会减少(如元旦)。第二，一旦我们纳入外生信息，租金记录较少的一天是星期一。此外，随着周末的临近，租金往往会上涨，周六达到最高。最后，在一年中，4 月至 6 月的租赁数量往往较高，冬季月份会有所减少。剧情也包括了外生特征的综合贡献，但是这个更难解读。

![](img/66f2ad8e47605b30a460eff011d1d68f.png)

使用 Prophet 软件包识别的时间序列组件。

最后，我们可以在测试集上评估模型的性能，并将其与第 1 部分中训练的不考虑外部信息的模型进行比较。下表显示了结果，表明引入外源信息确实减少了[【RMSE】](https://en.wikipedia.org/wiki/Root-mean-square_deviation)(减少了 16%)[【MAE】](https://en.wikipedia.org/wiki/Mean_absolute_error)(减少了 23%)，以及[【MAPE】](https://en.wikipedia.org/wiki/Mean_absolute_percentage_error)(减少了 19%)。

下面是两个比较两个模型的图。在这里，从视觉上更容易看出，引入外源信息确实提高了模型性能。

![](img/17ec57ba52147f6bda7c9a16eeb985c5.png)![](img/0451beb1015a53eff8e6cc196e631c04.png)

使用 Prophet 软件包对自行车共享需求时间序列进行建模和预测。黑点对应于训练集，绿色点对应于验证集，红色点对应于测试集。蓝线及其周围的阴影对应于置信区间为 80%的预测。包含外部信息可以提高模型性能。

# 评论

这只是原始帖子的扩展，仍然有几件事情可以考虑(可能是第 3 部分):

*   使用原始的每小时数据集，而不是每天数据集。我尝试这样做，但注意到 Prophet 预测负值，即使我在逻辑模型中指定了零值下限。我想知道为什么会这样…
*   将其他外生特征合并到模型中。此处介绍的功能选择是主观的，绝不应被视为唯一的选择。一些功能工程可以帮助获得更好的性能。
*   为超参数调整执行贝叶斯优化。这里提出的网格搜索只是获得一些(初始)好的超参数的一种快速方法。
*   为正确的模型选择执行模拟历史预测。Prophet 提供了一个有趣的[诊断](https://facebook.github.io/prophet/docs/diagnostics.html)工具，可以用来更深入地研究模型性能。
*   获取参数系数。Prophet 是一个很棒且简单易用的工具，但由于其简单性，用户很难获得参数系数。当一个模型被拟合时，Prophet 返回一个包含大量元素的列表，其中一个是另一个名为 *params* 的列表，它包含模型中的参数值。除非深入探究，否则很难猜测哪个参数对应哪个特性。如果你富有冒险精神，你会发现 Prophet 在 [Stan](https://mc-stan.org/) 中构建了[模型](https://github.com/facebook/prophet/blob/master/python/stan/win/prophet.stan)，这是一种用 C++编写的用于统计推断的概率编程语言。如果你继续下去，你最终会发现有另一个 R 包叫做 [rstan](http://mc-stan.org/rstan/) ，一旦你决定从后验分布中采样(而不是优化)来释放概率编程的全部力量，它将允许你使用一堆不同的函数来评估模型和参数的训练。
*   使用 *dyplot.prophet* 探索预测。Prophet 还提供了一个不错的功能，允许您与您的预测进行交互。它使用了 [dygraphs](https://rstudio.github.io/dygraphs/) ，结果相当有用。

![](img/20b85765f5a1219ac95ddaa021fc3b2e.png)

使用 Prophet 软件包对自行车共享需求时间序列进行建模和预测。一旦选择了超参数，黑点对应于训练集。蓝线及其周围的阴影对应于置信区间为 80%的预测。

这就是我第二部分的内容。尽管如此，仍有许多东西可以考虑，新的工具可以使用，但这将是另一个时间。