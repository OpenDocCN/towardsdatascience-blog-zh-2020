<html>
<head>
<title>Did you know — Python Tips</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您知道吗——Python 技巧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/did-you-know-you-can-measure-the-execution-time-of-python-codes-14c3b422d438?source=collection_archive---------9-----------------------#2020-03-07">https://towardsdatascience.com/did-you-know-you-can-measure-the-execution-time-of-python-codes-14c3b422d438?source=collection_archive---------9-----------------------#2020-03-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4214" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">测量 Python 代码的执行时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aade13314da56d77537b8c7f71b12a6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h6uskmiR6hjpWh2-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@neonbrand?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> NeONBRAND </a>拍摄的照片</p></figure><p id="486f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们开始精通一门编程语言时，我们渴望不仅交付最终目标，而且使我们的程序更高效。</p><p id="205d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<strong class="ky ir">你知道吗</strong>系列的这个教程中，我们将学习一些<strong class="ky ir"> Ipython 的</strong>魔法命令，它们可以帮助我们对 python 代码进行时间分析。</p><p id="82f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，出于本教程的目的，建议使用 Anaconda 发行版。</p><h1 id="9437" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">1.)分析一行代码</h1><p id="0063" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">要检查一行 python 代码的执行时间，可以使用<strong class="ky ir"> %timeit </strong>。下面是一个简单的例子来说明它是如何工作的:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="443c" class="mu lt iq mq b gy mv mw l mx my">#### Simple usage of magics command %timeit<br/><strong class="mq ir">%timeit [num for num in range(20)]</strong></span><span id="9456" class="mu lt iq mq b gy mz mw l mx my">#### Output<br/><strong class="mq ir">1.08 µs ± 43 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)</strong></span></pre><p id="0821" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关键注意事项:</p><ul class=""><li id="1494" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">在要评测的代码行之前使用<strong class="ky ir"> %timeit </strong></li><li id="42f3" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">返回每次运行内循环<strong class="ky ir">r</strong>T16】次数或运行和<strong class="ky ir">n</strong>T20】次数计算的代码运行时间的<strong class="ky ir">平均值和标准差</strong>。在上面的例子中，列表理解被评估了 7 次，每次运行有一百万次循环(默认行为)。这平均花费了 1.08 微秒，标准偏差为 43 纳秒。</li><li id="6081" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">你可以在调用魔术命令时自定义运行和循环的次数。下面的例子供参考:</li></ul><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9112" class="mu lt iq mq b gy mv mw l mx my">#### Customizing number of runs and loops in %timeit magic command<br/><strong class="mq ir">%timeit -r5 -n100 [num for num in range(20)]</strong></span><span id="6356" class="mu lt iq mq b gy mz mw l mx my">1.01 µs ± 5.75 ns per loop (mean ± std. dev. of 5 runs, 100 loops each)</span></pre><p id="9fdd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用命令选项<strong class="ky ir"> -r 和-n，</strong>分别表示运行次数和循环次数，<strong class="ky ir">我们将时间曲线操作定制为</strong> 5 次运行和每次运行中的 100 次循环。</p><h1 id="c9ae" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">2.)剖析多行代码</h1><p id="4463" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">本节向前迈进了一步，解释了如何分析一个完整的代码块。通过对<strong class="ky ir">%下面有一个示例演示供参考:</strong></p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="1264" class="mu lt iq mq b gy mv mw l mx my">#### Time profiling the code block using %%timeit<br/><strong class="mq ir">%%timeit -r5 -n1000<br/>for i in range(10):<br/>    n = i**2<br/>    m = i**3<br/>    o = abs(i)</strong></span><span id="27c3" class="mu lt iq mq b gy mz mw l mx my">#### Output<br/><strong class="mq ir">10.5 µs ± 226 ns per loop (mean ± std. dev. of 5 runs, 1000 loops each)</strong></span></pre><p id="3c8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以观察到循环的<strong class="ky ir">的<strong class="ky ir">平均执行时间</strong>为 10.5 微秒。注意，相同的命令选项<strong class="ky ir"> -r 和-n </strong>分别用于控制<strong class="ky ir">运行计数和每次运行</strong>中的循环数。</strong></p><h1 id="24d4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">3.2)对代码块中的每一行代码进行时间剖析</h1><p id="b054" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">到目前为止，在分析单行代码或完整代码块时，我们只查看了汇总统计数据。如果我们想评估代码块中每一行代码的性能，该怎么办？<strong class="ky ir">线路侧写师</strong>包来救援！！！</p><p id="3426" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> Line_profiler </strong>包可用于对任何<strong class="ky ir">功能进行逐行剖析。</strong>要使用 line_profiler 软件包，请执行以下步骤:</p><ul class=""><li id="4c38" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated"><strong class="ky ir">安装包</strong>—<strong class="ky ir">line profiler</strong>包可以通过简单调用 pip 或 conda install 来安装。如果使用 Python 的 anaconda 发行版，建议使用<strong class="ky ir"> conda install </strong></li></ul><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7785" class="mu lt iq mq b gy mv mw l mx my">#### Installing line_profiler package<br/><strong class="mq ir">conda install line_profiler</strong></span></pre><ul class=""><li id="2745" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated"><strong class="ky ir">加载扩展</strong> —安装后，您可以使用 IPython 加载<strong class="ky ir"> line_profiler IPython 扩展</strong>，该扩展作为该软件包的一部分提供:</li></ul><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="d2ac" class="mu lt iq mq b gy mv mw l mx my">#### Loading line_profiler's Ipython extension<br/><strong class="mq ir">%load_ext line_profiler</strong></span></pre><ul class=""><li id="d060" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated"><strong class="ky ir">对函数</strong>进行时间分析——一旦加载，使用以下语法对任何预定义的<strong class="ky ir">函数</strong>进行时间分析</li></ul><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7401" class="mu lt iq mq b gy mv mw l mx my">%lprun -f <strong class="mq ir">function_name_only</strong> <strong class="mq ir">function_call_with_arguments</strong></span></pre><p id="a46a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法细节</strong>:</p><ul class=""><li id="ebe1" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">对 line_profiler 的调用以关键字<strong class="ky ir"> %lprun </strong>开始，后跟<strong class="ky ir">命令选项-f </strong></li><li id="493b" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">命令选项后面是<strong class="ky ir">函数名</strong>，然后是<strong class="ky ir">函数调用</strong></li></ul><p id="981e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本练习中，我们将定义一个函数，接受身高(单位为米)和体重(单位为磅)列表作为输入，并将它们分别转换为厘米和千克。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9b85" class="mu lt iq mq b gy mv mw l mx my"><strong class="mq ir">#### Defining the function</strong><br/>def conversion(ht_mtrs, wt_lbs ):<br/>    ht_cms = [ht*100 for ht in ht_mtrs]<br/>    wt_kgs = [wt*.4535 for wt in wt_lbs]</span><span id="94e2" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">#### Defining the height and weight lists:</strong><br/>ht = [5,5,4,7,6]<br/>wt = [108, 120, 110, 98]</span><span id="a801" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">#### Profiling the function using line_profiler<br/></strong>%lprun -f conversion conversion(ht,wt)</span><span id="9d61" class="mu lt iq mq b gy mz mw l mx my">---------------------------------------------------------------<br/><strong class="mq ir">#### Output<br/>Total time: 1.46e-05 s</strong></span><span id="f54b" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">File: &lt;ipython-input-13-41e195af43a9&gt;</strong></span><span id="6b4a" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">Function: conversion at line 2</strong></span><span id="6eb5" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">Line #      Hits         Time  Per Hit   % Time  Line Contents<br/>==============================================================<br/>     2       1        105.0    105.0     71.9      ht_cms = [ht*100 for ht in ht_mtrs]<br/>     3       1         41.0     41.0     28.1      wt_kgs = [wt*.4535 for wt in wt_lbs]</strong></span></pre><p id="19d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出详细信息:</p><ul class=""><li id="b8f2" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">完整的时间曲线以<strong class="ky ir"> 14.6 微秒</strong>为单位完成(参考输出的第一行)</li></ul><p id="1401" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">生成的表格有 6 列:</p><ul class=""><li id="bdf3" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">第 1 列(行号)-代码的行号(<strong class="ky ir">注意，第 1 行被故意从输出中省略，因为它只是函数定义语句</strong>)</li><li id="18ea" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">第 2 列(命中数)—线路被调用的次数</li><li id="33fb" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">第 3 列(时间)—花费在代码行上的<strong class="ky ir">时间单位数(每个时间单位为 14.6 微秒)</strong></li><li id="f386" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">第 4 列(每次命中)-第 3 列除以第 2 列</li><li id="e41a" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">第 5 列(%Time) —在花费的总时间中，<strong class="ky ir">在特定代码行上花费的时间百分比是多少</strong></li><li id="8689" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">第 6 列(内容)-代码行的内容</li></ul><p id="67d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">人们可以清楚地注意到，从米到厘米的高度转换几乎花费了总时间的 72%。</p><h1 id="c678" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结束语</h1><p id="01ea" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有了我们可以支配的每行代码的执行时间，我们就可以部署策略来提高代码的效率。在接下来的 3 个教程中，我们将分享一些<strong class="ky ir">最佳实践</strong>来帮助你提高代码<strong class="ky ir">的效率。</strong></p><p id="b529" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这个【T42 你知道吗】系列的教程是有益的，你学到了一些新的东西。</p><p id="98c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">会在以后的教程中尝试并带来更多有趣的话题。在此之前:</p><p id="a515" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快乐学习！！！！</p></div></div>    
</body>
</html>