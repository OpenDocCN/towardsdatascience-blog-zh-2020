<html>
<head>
<title>Image Classification on Tensorflow Serving with gRPC or REST Call for Inference</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于 gRPC 或 REST 调用推理的张量流图像分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/image-classification-on-tensorflow-serving-with-grpc-or-rest-call-for-inference-fd3216ebd4f3?source=collection_archive---------13-----------------------#2020-06-30">https://towardsdatascience.com/image-classification-on-tensorflow-serving-with-grpc-or-rest-call-for-inference-fd3216ebd4f3?source=collection_archive---------13-----------------------#2020-06-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9168" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过 gRPC 或 rest API 调用为生产和推理中的影像分类模型提供服务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b4da6e66a55f73108e9c13f6cc5d4385.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fntmDYs03vQ_y5vCnqfflA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用<a class="ae kv" href="https://www.postermywall.com/" rel="noopener ugc nofollow" target="_blank">后墙</a>创建的图像</p></figure><p id="d925" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Tensorflow 提供了多种部署模型的方法。我已经探索了为生产中的模型服务的大多数方法。我一直在寻找一个简单、安全、健壮的解决方案，它应该既能在边缘设备上访问，也能在用其他编程语言编写的服务器上访问。模型服务器非常适合我的需求。我通过 REST API 连接边缘设备，并对我的另一台服务器进行内部 RPC 调用。我还能够为不同的设备提供不同的版本，我可以很容易地从中央服务器控制这些设备。在本文中，我演示了如何以两种方式调用模型服务器，并找出哪种方法适合您的问题陈述。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="8def" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我们开始吧</h1><p id="8638" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们将部署一个在 Keras 上训练的图像分类器。为了让我们的模型在模型服务器上运行，我们需要以下面提到的特定格式导出我们的权重。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="f874" class="nb ma iq mx b gy nc nd l ne nf">model_name/<br/>    version/<br/>        saved_model.pb<br/>        variables/<br/>           variables.index<br/>           variables.data-000-of-n</span></pre><p id="a3a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在 TensorFlow 2 中我们可以用<code class="fe ng nh ni mx b">tf.keras.models.save_model</code>函数直接导出训练好的模型。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="2e54" class="nb ma iq mx b gy nc nd l ne nf">MODEL_DIR = './cat_dog_classifier'<br/>version = 1<br/>export_path = os.path.join(MODEL_DIR, str(version))</span><span id="e442" class="nb ma iq mx b gy nj nd l ne nf">tf.keras.models.save_model(<br/>    model,<br/>    export_path,<br/>    overwrite=True,<br/>    include_optimizer=True,<br/>    save_format=None,<br/>    signatures=None,<br/>    options=None<br/>)</span></pre><h1 id="c6a3" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">验证元图和签名定义</h1><p id="e495" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们将使用<code class="fe ng nh ni mx b">saved_model_cli</code>工具来检查图形。这将有助于找出输入和输出节点名称。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="74dd" class="nb ma iq mx b gy nc nd l ne nf">saved_model_cli show --dir ./cat_dog_classifier/1/ --all</span></pre><h1 id="d1f0" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">安装模型服务器</h1><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="befa" class="nb ma iq mx b gy nc nd l ne nf"><em class="np">echo "deb [arch=amd64] </em><a class="ae kv" href="http://storage.googleapis.com/tensorflow-serving-apt" rel="noopener ugc nofollow" target="_blank"><em class="np">http://storage.googleapis.com/tensorflow-serving-apt</em></a><em class="np"> stable tensorflow-model-server tensorflow-model-server-universal" | sudo tee /etc/apt/sources.list.d/tensorflow-serving.list &amp;&amp; \<br/>curl </em><a class="ae kv" href="https://storage.googleapis.com/tensorflow-serving-apt/tensorflow-serving.release.pub.gpg" rel="noopener ugc nofollow" target="_blank"><em class="np">https://storage.googleapis.com/tensorflow-serving-apt/tensorflow-serving.release.pub.gpg</em></a><em class="np"> | sudo apt-key add -</em></span><span id="9465" class="nb ma iq mx b gy nj nd l ne nf">sudo apt-get update</span><span id="2db3" class="nb ma iq mx b gy nj nd l ne nf">sudo apt-get install tensorflow-model-server</span></pre><h1 id="f4b3" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">运行模型服务器</h1><p id="0976" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们将在 grpc 的默认端口 8500 和 HTTP 的默认端口 8501 上运行模型服务器。如果需要，您还可以指定不同的端口。</p><p id="96b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您的终端位置与模型文件夹位于同一文件夹中。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="c97b" class="nb ma iq mx b gy nc nd l ne nf">export MODEL_DIR=$(pwd)/cat_dog_classifier</span><span id="3f1b" class="nb ma iq mx b gy nj nd l ne nf">tensorflow_model_server --port=8500 --rest_api_port=8501 --model_name=cat_dog_classifier --model_base_path="${MODEL_DIR}"</span></pre><p id="a240" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在使用您保存的模型成功运行模型服务器之后，您将获得与您的模型类似的输出。</p><blockquote class="nq nr ns"><p id="6335" class="kw kx np ky b kz la jr lb lc ld ju le nt lg lh li nu lk ll lm nv lo lp lq lr ij bi translated">2020–06–30 15:22:57.309568:I tensor flow _ serving/core/loader _ harness . cc:87]成功加载可服务版本{ name:cat _ dog _ classifier version:1 }<br/>2020–06–30 15:22:57.311296:I tensor flow _ serving/model _ servers/server . cc:355]运行 gRPC model server 0 . 0 . 0:8500</p></blockquote><h1 id="9fca" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">图像推理</h1><h2 id="1d5b" class="nb ma iq bd mb nw nx dn mf ny nz dp mj lf oa ob ml lj oc od mn ln oe of mp og bi translated">拨打 GRPC 电话</h2><p id="aa9f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><strong class="ky ir">必要进口:</strong></p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="73b9" class="nb ma iq mx b gy nc nd l ne nf">import grpc<br/>import numpy as np<br/>import nsvision as nv<br/>import tensorflow as tf<br/>from tensorflow_serving.apis import predict_pb2<br/>from tensorflow_serving.apis import prediction_service_pb2_grpc</span></pre><p id="144d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">设置 gRPC 通道:</strong></p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5000" class="nb ma iq mx b gy nc nd l ne nf">label = ['cat', 'dog']<br/>GRPC_MAX_RECEIVE_MESSAGE_LENGTH = 4096 * 4096 * 3<br/>channel = grpc.insecure_channel('localhost:8500', options=[('grpc.max_receive_message_length', GRPC_MAX_RECEIVE_MESSAGE_LENGTH)])<br/>stub = prediction_service_pb2_grpc.PredictionServiceStub(channel)<br/>grpc_request = predict_pb2.PredictRequest()<br/>grpc_request.model_spec.name = 'cat_dog_classifier'<br/>grpc_request.model_spec.signature_name = 'serving_default'</span></pre><p id="bd9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">预测图像的输出:</strong></p><p id="4049" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保为 gRPC 请求对象指定了正确的输入和输出。如果你想知道你的模型的输入输出键是什么，你可以使用元数据来检查，元数据可以通过在浏览器中调用一个系统化的 URL 来找到。在这种情况下，它是:</p><p id="0831" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ng nh ni mx b"><a class="ae kv" href="http://localhost:8501/v1/models/cat_dog_classifier/metadata" rel="noopener ugc nofollow" target="_blank">http://localhost:8501/v1/models/cat_dog_classifier/metadata</a></code></p><p id="8bea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的输入层名称是<code class="fe ng nh ni mx b">conv2d_input</code>和输出层名称是<code class="fe ng nh ni mx b">dense_1</code>，但它会因型号而异。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="85ec" class="nb ma iq mx b gy nc nd l ne nf">image = nv.imread('golden-retriever-royalty-free-image-506756303-1560962726.jpg',resize=(150,150),normalize=True)<br/>image = nv.expand_dims(image,axis=0)<br/>grpc_request.inputs['conv2d_input'].CopyFrom(tf.make_tensor_proto(image, shape=image.shape))<br/>result = stub.Predict(grpc_request,10)<br/>result = int(result.outputs['dense_1'].float_val[0])<br/>print(label[result])<br/>#This printed 'dog' on my console</span></pre><h2 id="ba45" class="nb ma iq bd mb nw nx dn mf ny nz dp mj lf oa ob ml lj oc od mn ln oe of mp og bi translated">进行 REST API 调用</h2><p id="2496" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Rest API 比 grpc 需要更少的库和设置。</p><p id="9bb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">进口:</strong></p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="cb0a" class="nb ma iq mx b gy nc nd l ne nf">import json<br/>import requests<br/>import nsvision as nv</span></pre><p id="10e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">为 REST 调用创建 JSON:</strong></p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="63c6" class="nb ma iq mx b gy nc nd l ne nf">label = ['cat','dog']<br/>image = nv.imread('cat.2033.jpg',resize=(150,150),normalize=True)<br/>image = nv.expand_dims(image,axis=0)<br/>data = json.dumps({ <br/>    "instances": image.tolist()<br/>})<br/>headers = {"content-type": "application/json"}</span></pre><p id="1c37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">预测图像的输出:</strong></p><p id="18a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">REST API 调用需要一个 URL 用于 POST 调用，模型服务器已经为 API 调用指定了一个 URL 格式:<br/> <code class="fe ng nh ni mx b">http://host_ip:port/version_number/models/model_name:predict</code></p><p id="9dce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，API URL 将是:</p><p id="ca4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ng nh ni mx b"><a class="ae kv" href="http://localhost:8501/v1/models/cat_dog_classifier:predict" rel="noopener ugc nofollow" target="_blank">http://localhost:8501/v1/models/cat_dog_classifier:predict</a></code></p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8e0a" class="nb ma iq mx b gy nc nd l ne nf">response = requests.post('<a class="ae kv" href="http://localhost:8501/v1/models/cat_dog_classifier:predict'" rel="noopener ugc nofollow" target="_blank">http://localhost:8501/v1/models/cat_dog_classifier:predict'</a>, data=data, headers=headers)<br/>result = int(response.json()['predictions'][0][0])<br/>print(label[result])<br/>#This printed 'cat' on my console</span></pre><p id="4bc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于它是一个 REST API，您可以将端点连接到 javascript 等 web 客户端或 Android、Ios 等边缘设备或 Raspberry Pi 或 Jetson Nano 等物联网设备。</p><h2 id="0d27" class="nb ma iq bd mb nw nx dn mf ny nz dp mj lf oa ob ml lj oc od mn ln oe of mp og bi translated">Github 资源库:</h2><div class="oh oi gp gr oj ok"><a href="https://github.com/novasush/image-classifier-in-production" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">生产中的图像分类器</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">该存储库包含在模型服务器上部署生产中的 Keras 模型的代码，以及使用 GRPC 或 HTTP…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">github.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy kp ok"/></div></div></a></div><h1 id="2735" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">这是所有的乡亲</h1></div></div>    
</body>
</html>