<html>
<head>
<title>Web scraping in R using CSS selectors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CSS选择器在R中抓取网页</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-in-r-using-rvest-and-selectorgadget-5fc5124547e?source=collection_archive---------17-----------------------#2020-01-20">https://towardsdatascience.com/web-scraping-in-r-using-rvest-and-selectorgadget-5fc5124547e?source=collection_archive---------17-----------------------#2020-01-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="716f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">又名当客户做空你时如何获得更多数据</em></h2></div><p id="2d65" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><em class="lf">R中的Web抓取比你想象的要容易——像CSS选择器和抓取库这样的工具可以快速完成工作。事实上，“最困难”的部分是识别元素的CSS路径，但是我将向您展示如何轻松地到达那里！</em></p><p id="4afc" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我曾经有一个客户(美国的一家商业保险经纪公司)，他想要一个数据科学解决方案来提高他们的销售和转化率。看似直白？客户给我们的数据非常少——只有客户的唯一许可证号、销售结果(保单状态)和保费价格。</p><p id="c045" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我开始在网上寻找相关数据的其他来源。客户的唯一许可证号是由美国政府交通部(DOT)颁发的DOT号。联邦汽车运输安全管理局(FMCSA)对与DOT编号相关的车辆和司机进行例行检查，并在其网站上发布报告。这是公共信息，不需要登录/密码即可访问。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/a69adca572f334cac0ee300e2e56cc10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Et4KTJvrkkFXWMXKrhjbbA.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated"><em class="ki">一个点号的FMCSA安全报告部分截图。</em></p></figure><p id="430e" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">像报告的撞车次数、车辆/驾驶员危险率这样的数据可以帮助优化保单保费，以增加客户购买保单的几率。</p><p id="9909" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">获得这一点需要3个步骤:</p><ol class=""><li id="f260" class="lw lx it kl b km kn kp kq ks ly kw lz la ma le mb mc md me bi translated">识别感兴趣的元素，并获取它们的CSS路径。</li><li id="a0d8" class="lw lx it kl b km mf kp mg ks mh kw mi la mj le mb mc md me bi translated">将抓取的元素压缩成一个数据帧。</li><li id="761c" class="lw lx it kl b km mf kp mg ks mh kw mi la mj le mb mc md me bi translated">清理输出，然后将其连接到现有数据(由客户端提供)。</li></ol><h2 id="8c66" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">包和工具</h2><p id="7b19" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">我使用了<a class="ae ni" href="https://cran.r-project.org/web/packages/rvest/rvest.pdf" rel="noopener ugc nofollow" target="_blank"> rvest </a>库和CSS选择器<a class="ae ni" href="https://selectorgadget.com/" rel="noopener ugc nofollow" target="_blank"> SelectorGadget </a>来抓取网页。该工具可以作为浏览器的扩展下载，这样可以更容易地确定网页上每个元素的CSS路径。</p><h2 id="1532" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">定义URL和网页</h2><p id="7156" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">我开始使用单点编号报告。报告的URL包含点号本身，这对于以后遍历点号列表非常有用。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="16c5" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">检查感兴趣的元素</h2><p id="fab9" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">首先，我想收集每个点号的注册地址，以及它们拥有的驱动程序的数量。我需要这些元素的CSS路径——这告诉scraper要抓取的元素的精确位置。一个地址，如果你愿意的话。</p><p id="d672" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">打开SelectorGadget扩展——浏览器底部会出现一个框。选择屏幕上列出地址的区域。该工具将在屏幕上突出显示许多其他元素——此时它已经选择了67个其他元素。只需点击黄色元素，直到只剩下绿色的地址部分。(这只需要3到4次点击)。额外元素的每次“取消选择”都会将CSS路径更新到地址的精确位置。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nl"><img src="../Images/25c77e8b49bd56df022c6a182dc20b73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O9UDwneEhsa9UbQvPhZXLg.png"/></div></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nl"><img src="../Images/3870a6834971aeb7d9648479e9f743b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z7SU5WyjXP7TDGg2y1BQhQ.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">现在address元素的CSS路径可用了。截图自<a class="ae ni" href="https://ai.fmcsa.dot.gov/SMS/Carrier/2844805/Overview.aspx?FirstView=True" rel="noopener ugc nofollow" target="_blank">此处</a></p></figure><p id="7106" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在“地址”是唯一突出显示的元素。红框里看似乱码的文字就是这个元素的<strong class="kl iu"> CSS路径</strong>，这就是我们要传递给rvest去刮取的东西。</p><p id="1a95" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">类似地，要获得驱动程序数量的CSS路径:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nl"><img src="../Images/d97d726d68587c4a06263bf29090ca2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLQbJaE1uJ-WxVCYn3kXwQ.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">截图自<a class="ae ni" href="https://ai.fmcsa.dot.gov/SMS/Carrier/2844805/Overview.aspx?FirstView=True" rel="noopener ugc nofollow" target="_blank">此处</a></p></figure><p id="46b5" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">将CSS路径传递给rvest:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nj nk l"/></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nm"><img src="../Images/74f813f8e2de730dd822febf653d6b12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aFj8BbeC5hNaut8IPt3V2A.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">我们有产出了！它必须被清洗，很多，但它的工作！</p></figure><p id="f8a0" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在我将为所有的点号刮取更多的元素。</p><h2 id="cdb8" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">遍历所有的点号</h2><p id="5410" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">我利用了URL反映点号的事实-<a class="ae ni" href="https://ai.fmcsa.dot.gov/SMS/Carrier/2844805/CompleteProfile.aspx" rel="noopener ugc nofollow" target="_blank">https://ai . fmcsa . DOT . gov/SMS/Carrier/2844805/complete profile . aspx</a></p><p id="d36b" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我创建了一个包含每个点号的URL的向量。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="d4d8" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">现在，刮！</h2><p id="f690" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">最后一步将所有不同的元素组合成一个数据帧，称为fmcsa_data。这将需要一些时间，取决于你有多少迭代。我建议把电脑插上电源，给自己泡杯茶。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="aec2" class="mk ml it bd mm mn mo dn mp mq mr dp ms ks mt mu mv kw mw mx my la mz na nb nc bi translated">清洁数据框</h2><p id="7fa1" class="pw-post-body-paragraph kj kk it kl b km nd ju ko kp ne jx kr ks nf ku kv kw ng ky kz la nh lc ld le im bi translated">产生的数据帧并不美观——大量无关的文本隐藏了相关的信息。还有一些缺失的数据——FMCSA网站还没有一些点号的报告，所以什么也没有收集到。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nn"><img src="../Images/e24371d6b7c321b057c08f4aeeab024f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgCwwOUliTGk-KYNTT3MQw.png"/></div></div></figure><p id="67ca" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">对数据的进一步观察也揭示了许多不可见的特征。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi no"><img src="../Images/0c393ff43bc61a5e7b6e41039052842a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QY7tEdqrIr8tXfGMjh167w.png"/></div></div></figure><p id="bd28" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">清理这些数据是一个简单的过程:</p><ol class=""><li id="1688" class="lw lx it kl b km kn kp kq ks ly kw lz la ma le mb mc md me bi translated">删除空行。将每一列从因子转换为字符类型。</li><li id="2866" class="lw lx it kl b km mf kp mg ks mh kw mi la mj le mb mc md me bi translated">删除地址的不可见字符。</li><li id="b4aa" class="lw lx it kl b km mf kp mg ks mh kw mi la mj le mb mc md me bi translated">仅提取除地址、姓名和安全等级之外的所有列的数字。</li></ol><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="bac4" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">清理后的dataframe就懂事多了！</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi np"><img src="../Images/ae34e49014d8aa5105cde9f6aa166bbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQjhEIVhbUVkPwiE8U3S4g.png"/></div></div></figure><p id="7a3f" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">这就是我们从成千上万份报告中整理出来的简洁明了的数据框架。</p><p id="66ec" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><em class="lf">我是帕洛阿尔托ScoreData公司的数据科学家。我非常热衷于有效的沟通——我热衷于将统计数据转化为对业务友好的、可操作的见解。我想让这个博客成为一个分享我一路走来所学到的一些东西的空间，所以一起来吧！</em></p><p id="f4d7" class="pw-post-body-paragraph kj kk it kl b km kn ju ko kp kq jx kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><a class="ae ni" href="https://www.linkedin.com/in/namrata-date/" rel="noopener ugc nofollow" target="_blank"><em class="lf"/>https://www.linkedin.com/in/namrata-date/</a></p></div></div>    
</body>
</html>