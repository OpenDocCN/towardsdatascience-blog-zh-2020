<html>
<head>
<title>Data Cleaning with Pandas — Avoid this Mistake!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用熊猫清理数据——避免这个错误！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-cleaning-with-pandas-avoid-this-mistake-7af559657c2c?source=collection_archive---------18-----------------------#2020-01-17">https://towardsdatascience.com/data-cleaning-with-pandas-avoid-this-mistake-7af559657c2c?source=collection_archive---------18-----------------------#2020-01-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fa6561054bf09ea86f83365e90084695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vk_yy9oybY7lzQ0V"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/photos/FOsina4f7qM" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/FOsina4f7qM</a></p></figure><p id="3632" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Pandas是Python中一个非常有用的数据操作包。在很大程度上，函数是直观的，快速的，易于使用的。但是有一次，我花了几个小时调试管道，发现在Pandas列中混合类型会导致管道中出现各种问题。多读一点去发现我的意思，避免以后这样做。</p><h1 id="03de" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">什么是混合型栏目</strong></h1><p id="aa02" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">混合类型正是您所想的:它们是具有多种类型(string、integer、float等)的列。在pandas中，创建混合型列非常容易:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9b1e" class="mq lf it mm b gy mr ms l mt mu">import pandas<br/>df = pd.DataFrame({"price": [9.99, "$9.99"]})<br/>print(list(map(type, df["price"])))</span></pre><p id="b470" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这输出<strong class="ki iu">【浮点，str】</strong>。这些混合类型列将始终使用“object”数据类型作为其d type:</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/7871672b2205cc753cffdc1081457c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/format:webp/1*zYJmgipIi9Hun3RCG_inUw.png"/></div></figure><p id="11c3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是因为Pandas在幕后使用了Numpy数组，Numpy的dtypes之一就是Python对象本身。因此，当多个类型被引入到一个列中时，Pandas将使用这个“全部捕获”选项，而不是抛出一个错误(当您有字符串时，请参阅下面的参考资料，了解为什么它是一个对象数据类型，至少在Pandas 1.0之前是这样)。如果创建一个全是整数的熊猫序列，然后添加一个字符串，就可以看到这一点。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2cb7" class="mq lf it mm b gy mr ms l mt mu">import pandas as pd<br/>int_series = pd.Series([1, 2, 3])<br/>print(int_series.dtype)  # dtype('int64')<br/>int_series.loc[3] = "4"<br/>print(int_series.dtype)  # dtype('O')</span></pre><p id="3b54" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是由设计决定的，类似于将数据输入Excel电子表格的设计模式。</p><h1 id="b7f5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">这会导致问题</strong></h1><p id="e590" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">假设您有几个文件要合并。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="a3ec" class="mq lf it mm b gy mr ms l mt mu">sales_data = pd.read_csv("data/sales_data.csv", parse_dates=["date"])</span><span id="8e0c" class="mq lf it mm b gy mw ms l mt mu">census_data = pd.read_csv("data/population_by_zip_2010.csv")<br/>population = census_data.groupby("zipcode")["population"].sum().reset_index()</span></pre><div class="mh mi mj mk gt ab cb"><figure class="mx ju my mz na nb nc paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/7db0d8813367c8dc13bde0ff08e13921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*ouQ5WX0y1w3l8JDcL2Ecjw.png"/></div></figure><figure class="mx ju nd mz na nb nc paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/f23e3cf8961ea21c59fefded3a9f4570.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*LkXKQ3psb2PIamPhYCU81w.png"/></div></figure></div><div class="ab cb"><figure class="mx ju ne mz na nb nc paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/7e860f798f14e0b97efd2a63cac7d5d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*1EjQQAHYwIRLk7sCxF98Tw.png"/></div></figure><figure class="mx ju nf mz na nb nc paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/1ac7dd0d0b1a7de3975dbecb4bdab18a.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*QRxosHpPQ5Y2Oq4m_LdICQ.png"/></div></figure><figure class="mx ju ng mz na nb nc paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/edf296e88b9740edacae8d674b383e25.png" data-original-src="https://miro.medium.com/v2/resize:fit:284/format:webp/1*xse9L_Q_dpo4H9ERp6l0mg.png"/></div></figure></div><p id="8122" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要合并邮政编码，但是为了这样做，我们需要首先清理<strong class="ki iu"> sales_data </strong>邮政编码。让我们从9位数的邮政编码中提取出前5位数。有一些缺失值，假设经过调查，我们知道2018年之前所有缺失的邮政编码是90001，之后所有缺失的邮政编码是90002。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="5c83" class="mq lf it mm b gy mr ms l mt mu">sales_data["zip_code"] = sales_data["zip_code"].str[:5]</span><span id="5388" class="mq lf it mm b gy mw ms l mt mu">sales_data.loc[sales_data["zip_code"].isna() &amp; (sales_data["date"] &lt; pd.to_datetime("2018-01-01")), "zip_code"] = 90001</span><span id="352e" class="mq lf it mm b gy mw ms l mt mu">sales_data.loc[sales_data["zip_code"].isna() &amp; (sales_data["date"] &gt;= pd.to_datetime("2018-01-01")), "zip_code"] = 90002</span></pre><p id="6ae6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们准备合并</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7e8e" class="mq lf it mm b gy mr ms l mt mu">sales_and_population = pd.merge(sales_data, population, left_on="zip_code", right_on="zipcode")</span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/e023ce839176472411a66ef074c7224f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v1_x0D9gPuZnjBGOHp6Y0g.png"/></div></div></figure><p id="f6ce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看起来不错，对吧？</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/bc50878261a047b1c64a106df2a6b600.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*MQ5olJK-usQuAvKnww7HQA.png"/></div></figure><p id="9996" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">嗯，这似乎太低了。现在你可能想知道这是不是因为右边的数据框<strong class="ki iu">人口</strong>中缺少数据。但不是，这是因为左边的dataframe <strong class="ki iu"> sales_data </strong>的<strong class="ki iu"> zip_code </strong>列中有混合类型。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/d4ae62dd260b37ad3639f8a147163e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_69oqybVlKT5WNVWzn0xNQ.png"/></div></div></figure><p id="e15d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们用90001和90002替换缺失的邮政编码时，引入了我们的int。这些是唯一成功连接到<strong class="ki iu">人口</strong>数据框架的行，该数据框架的dtype为<strong class="ki iu"> int </strong>。为了避免这个问题，我们需要在合并之前将我们的类型转换为int类型。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6817" class="mq lf it mm b gy mr ms l mt mu">sales_data = sales_data.astype({"zip_code": int})</span><span id="8263" class="mq lf it mm b gy mw ms l mt mu">sales_and_population = pd.merge(sales_data, population, left_on="zip_code", right_on="zipcode")</span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/a705b3bb2d44350af2f2dc6d2172ed23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*wxLd7wjjZ9wQVzUKwSUTyQ.png"/></div></figure></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="3305" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">关键提示</strong>:用熊猫清理数据的时候要小心——类型不是强制的，以后可能会让人头疼，所以要经常检查你的类型，必要的时候进行强制转换！</p><h1 id="2c50" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">参考</h1><div class="ns nt gp gr nu nv"><a href="https://github.com/sm14159/pandas-mixedtype/blob/master/notebook/pandas-mixedtypes.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">sm 14159/熊猫-混合型</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jz nv"/></div></div></a></div><ul class=""><li id="ed1e" class="ok ol it ki b kj kk kn ko kr om kv on kz oo ld op oq or os bi translated"><a class="ae kf" href="https://www.kaggle.com/census/us-population-by-zip-code" rel="noopener ugc nofollow" target="_blank">人口普查数据</a></li><li id="c76b" class="ok ol it ki b kj ot kn ou kr ov kv ow kz ox ld op oq or os bi translated"><a class="ae kf" href="https://ca.postcodebase.com/" rel="noopener ugc nofollow" target="_blank">随机地址来源</a></li><li id="2866" class="ok ol it ki b kj ot kn ou kr ov kv ow kz ox ld op oq or os bi translated"><a class="ae kf" href="https://pbpython.com/currency-cleanup.html" rel="noopener ugc nofollow" target="_blank">另一个例子显示了处理货币时的类似问题</a></li><li id="2348" class="ok ol it ki b kj ot kn ou kr ov kv ow kz ox ld op oq or os bi translated"><a class="ae kf" href="https://stackoverflow.com/questions/34881079/pandas-distinction-between-str-and-object-types" rel="noopener ugc nofollow" target="_blank">NumPy数据类型的解释</a></li></ul></div></div>    
</body>
</html>