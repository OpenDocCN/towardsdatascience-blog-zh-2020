<html>
<head>
<title>Data Processing In Rust With DataFusion (Arrow)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rust 中的数据处理与数据融合(箭头)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-processing-in-rust-with-datafusion-arrow-56df5432de68?source=collection_archive---------25-----------------------#2020-07-24">https://towardsdatascience.com/data-processing-in-rust-with-datafusion-arrow-56df5432de68?source=collection_archive---------25-----------------------#2020-07-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b72b5d54c820c78d3bea0772c6a66015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Om4MWxq0_2fq8tK2zXWrDg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">Rust 中的数据处理与数据融合(作者提供图片)</p></figure><p id="0f5a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Rust 是最受喜爱的语言，据 stack overflow 称，它连续四年高居榜首！有了 Apache Spark 这样的框架，数据处理变得越来越简单和快速。然而，数据处理领域竞争激烈。data fusion(Arrow now 的一部分)是将数据处理引入 Rust 的最初尝试之一。如果您有兴趣学习 Rust with DataFusion 中数据处理的某些方面，我将展示 Rust with DataFusion 中的一些代码示例，并比较 DataFusion 和 Pandas 之间的查询性能。</p><p id="13dc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="le">更新:我最初在</em>data fusion<em class="le">0 . 15 . 0 版本中写了这篇文章。在 DataFusion 和 Arrow 的 1.0.0 版本中，我添加了代码和基准，因此我们可以看到改进。</em></p><h1 id="9d80" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">数据融合</h1><p id="bbc5" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated"><a class="ae ld" href="https://github.com/andygrove" rel="noopener ugc nofollow" target="_blank">安迪·格罗夫</a>创造了<a class="ae ld" href="https://github.com/andygrove/datafusion" rel="noopener ugc nofollow" target="_blank">数据融合</a>，他有一些关于构建现代分布式计算的伟大文章，例如<a class="ae ld" href="https://andygrove.io/how_to_build_a_modern_distributed_compute_platform/" rel="noopener ugc nofollow" target="_blank">如何构建现代分布式计算平台</a>。正如 Andy 提到的，DataFusion 项目还不适合生产环境，</p><blockquote class="mi mj mk"><p id="5c16" class="kf kg le kh b ki kj kk kl km kn ko kp ml kr ks kt mm kv kw kx mn kz la lb lc im bi translated">“这个项目是学习构建查询引擎的一个很好的方式，但这还很早，还不能用于任何现实世界的工作。”</p></blockquote><p id="e7ae" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">该项目于 2019 年 2 月捐赠给 Apache Arrow 项目，更多人开始为 Arrow 版本的<a class="ae ld" href="https://github.com/apache/arrow/tree/master/rust/datafusion" rel="noopener ugc nofollow" target="_blank"> DataFusion </a>做贡献。</p><blockquote class="mi mj mk"><p id="024b" class="kf kg le kh b ki kj kk kl km kn ko kp ml kr ks kt mm kv kw kx mn kz la lb lc im bi translated">DataFusion 是一个内存查询引擎，它使用 Apache Arrow 作为内存模型。它支持对 CSV 和 Parquet 文件执行 SQL 查询，也支持直接查询内存中的数据。</p></blockquote><p id="c1e8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">项目描述可能不会带来太多的兴奋，但由于整个项目都是在 Rust 中完成的，它为您提供了关于在 Rust 中编写分析 SQL 的想法。此外，您可以轻松地将 DataFusion 作为库添加到 Rust 项目的 Cargo 文件中。</p><h1 id="8765" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">初始设置</h1><p id="9a07" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">为了用 DataFusion 测试运行一些代码，首先，我们需要创建一个新的 Rust 包</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0835" class="mx lg it mt b gy my mz l na nb">cargo new datafusion_test --bin</span></pre><p id="011d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然后在 Cargo.toml 文件中引入 DataFusion 作为依赖项</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="744e" class="mx lg it mt b gy my mz l na nb">[dependencies]<br/>arrow = "1.0.0"<br/>datafusion = "1.0.0"</span></pre><h1 id="73f1" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">测试数据集</h1><p id="0422" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">网上有很多可用的数据集，<a class="ae ld" href="https://www.kaggle.com" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>是我经常去探索新数据集的地方之一。我们将使用<a class="ae ld" href="https://www.kaggle.com/rounakbanik/the-movies-dataset?select=ratings.csv" rel="noopener ugc nofollow" target="_blank">的电影数据集</a>，该数据集的完整版本约为 676.68 MB。电影数据集具有以下模式</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="df68" class="mx lg it mt b gy my mz l na nb">userId: int</span><span id="4829" class="mx lg it mt b gy nc mz l na nb">movieId: int</span><span id="5058" class="mx lg it mt b gy nc mz l na nb">rating: double</span><span id="fb3b" class="mx lg it mt b gy nc mz l na nb">timestamp: long</span></pre><p id="141d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了处理 CSV 文件格式，DataFusion 过去需要我们在这里提供模式，因为 1.0.0 版本引入了模式推断，这不再需要。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b824" class="mx lg it mt b gy my mz l na nb">let schema = <em class="le">Arc</em>::new(<em class="le">Schema</em>::new(vec![</span><span id="4290" class="mx lg it mt b gy nc mz l na nb"><em class="le">    Field</em>::new(“userId”, <em class="le">DataType</em>::UInt32, false),</span><span id="8b1c" class="mx lg it mt b gy nc mz l na nb"><em class="le">    Field</em>::new(“movieId”, <em class="le">DataType</em>::UInt32, false),</span><span id="1ee8" class="mx lg it mt b gy nc mz l na nb"><em class="le">    Field</em>::new(“rating”, <em class="le">DataType</em>::Float64, false),</span><span id="5dd5" class="mx lg it mt b gy nc mz l na nb"><em class="le">    Field</em>::new(“timestamp”, <em class="le">DataType</em>::Int16, false)</span><span id="d9c7" class="mx lg it mt b gy nc mz l na nb">]));</span></pre><h1 id="0098" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">初始选择(版本 1.0.0)</h1><p id="fce2" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">随着 1.0.0 版本中引入更多特性，DataFusion API 带来了许多激动人心增强。您会看到诸如模式推断、更容易打印结果等改进。代码非常简洁，易于阅读。</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nd ne l"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">DataFusion 1.0.0 的代码示例</p></figure><h1 id="cfc6" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">DataFusion 与 Pandas 的性能比较</h1><p id="4e4f" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">这不是一个公平的比较，因为数据融合是全新的，缺乏大量的优化。但看到 DataFusion 的当前状态并将其与 pandas 等成熟的数据处理包进行比较仍然很有趣。</p><p id="19d9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="le">免责声明:我在我的个人 Mac 13 ( </em> 2 GHz 四核英特尔酷睿 i5 <em class="le">)上运行它来执行基准测试，结果可能会有偏差。因为最初的基准测试是在调试模式下发布的，所以注意到发布模式下的性能有很大的不同。</em></p><h2 id="2bc8" class="mx lg it bd lh nf ng dn ll nh ni dp lp kq nj nk lt ku nl nm lx ky nn no mb np bi translated">查询 1:选择前 10 行</h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="de3e" class="mx lg it mt b gy my mz l na nb"><strong class="mt iu">Query</strong>: “SELECT userId,movieId,rating FROM ratings LIMIT 10”</span><span id="e7da" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">DataFusion</strong>: 0.7s</span><span id="bf3a" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">Pandas</strong>: 6.15s</span></pre><p id="bc62" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">数据融合在随机存取 10 行上运行得非常快。另一方面，熊猫要慢 6s 左右。</p><h2 id="f3f0" class="mx lg it bd lh nf ng dn ll nh ni dp lp kq nj nk lt ku nl nm lx ky nn no mb np bi translated">查询 2:获得每个用户的平均评分</h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="77b4" class="mx lg it mt b gy my mz l na nb"><strong class="mt iu">Query</strong>: “SELECT userId, AVG(rating) FROM ratings GROUP BY userId”</span><span id="17dd" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">DataFusion</strong>: 18.57s</span><span id="f473" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">Pandas</strong>: 6.24s</span></pre><p id="bd03" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于熊猫在引擎盖下使用 NumPy，所以看到熊猫方面的良好表现就不足为奇了。在数据融合方面，虽然它比 Pandas 慢，但性能对于执行这些类型的聚合也是合理的。</p><h2 id="e25c" class="mx lg it bd lh nf ng dn ll nh ni dp lp kq nj nk lt ku nl nm lx ky nn no mb np bi translated">问题 3:最高评分是多少</h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="7383" class="mx lg it mt b gy my mz l na nb"><strong class="mt iu">Query</strong>: “SELECT MAX(rating) FROM ratings”</span><span id="5924" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">DataFusion</strong>: 15.28s</span><span id="cc08" class="mx lg it mt b gy nc mz l na nb"><strong class="mt iu">Pandas</strong>: 5.97s</span></pre><p id="e324" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于前面的分析查询看起来很慢，因此该查询在数据融合端也会很慢。</p><h1 id="ba46" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">最后的想法</h1><p id="bd20" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">正如我们首先讨论的，DataFusion 是 Rust 进入竞争激烈的数据计算市场的一次令人兴奋的尝试。由于 DataFusion 项目仍处于早期阶段，需要更多的贡献，所以在某些类型的查询上看到一些缓慢的性能并不奇怪。此外，如项目自述文件中所述，缺少一些关键特性，因此您必须小心您编写的 SQL 命令，并仔细检查它当前是否受支持。</p><p id="e223" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">总的来说，DataFusion 是 Rust 对数据世界的一个有吸引力的开始，尤其是它现在是 Apache Arrow 的一部分，DataFusion 可以轻松利用 Arrow 生态系统的功能。我希望在 DataFusion 的未来版本中看到显著的性能改进和更多受支持的 SQL 特性。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><p id="b30b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">希望这个故事对你有帮助。本文是我的工程&amp;数据科学系列的<strong class="kh iu">部分，目前包括以下内容:</strong></p><div class="nx ny gp gr nz"><div role="button" tabindex="0" class="ab bv gv cb fp oa ob bn oc jz ex"><div class="od l"><div class="ab q"><div class="l di"><img alt="Chengzhi Zhao" class="l de bw oe of fe" src="../Images/51b8d26809e870b4733e4e5b6d982a9f.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/2*SGCkys53sdZUZKnpRQoq_A.jpeg"/><div class="fb bw l oe of fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://chengzhizhao.medium.com/?source=post_page-----56df5432de68--------------------------------" rel="noopener follow" target="_top">赵承志</a></p></div></div><div class="oi oj gw l"><h2 class="bd iu tn to fp tp fr fs tq fu fw is bi translated">数据工程和数据科学故事</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tr au ts tt tu qc tv an eh ei tw tx ty el em eo de bk ep" href="https://chengzhizhao.medium.com/list/data-engineering-data-science-stories-ddab37f718e7?source=post_page-----56df5432de68--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="tz l fo"><span class="bd b dl z dk">47 stories</span></div></div></div><div class="ov dh ow fp ab ox fo di"><div class="di on bv oo op"><div class="dh l"><img alt="" class="dh" src="../Images/4ba0357365403d685da42e6cb90b2b7e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:388:388/1*b4EVtemQ1EQEup3o1ewz1w.gif"/></div></div><div class="di on bv oq or os"><div class="dh l"><img alt="" class="dh" src="../Images/89f9120acd7a8b3a37b09537198b34ca.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*xj-YsbUEN_pMA4IS7hE6hw.jpeg"/></div></div><div class="di bv ot ou os"><div class="dh l"><img alt="" class="dh" src="../Images/1f0d78b4e466ea21d6a5bd7a9f97c526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*zF1_SxRakCIMJ2sgKtyP1w.jpeg"/></div></div></div></div></div><p id="7870" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">你也可以<a class="ae ld" href="https://chengzhizhao.medium.com/subscribe" rel="noopener"> <strong class="kh iu">订阅我的新文章</strong> </a>或者成为<a class="ae ld" href="https://chengzhizhao.medium.com/membership" rel="noopener"> <strong class="kh iu">推荐媒介会员</strong> </a> <strong class="kh iu"> </strong>可以无限制访问媒介上的所有故事。</p><p id="771b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果有问题/评论，<strong class="kh iu">请不要犹豫，写下这个故事的评论</strong>或者通过<a class="ae ld" href="https://www.linkedin.com/in/chengzhizhao/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>或<a class="ae ld" href="https://twitter.com/ChengzhiZhao" rel="noopener ugc nofollow" target="_blank"> Twitter </a>直接<strong class="kh iu">联系我。</strong></p></div></div>    
</body>
</html>