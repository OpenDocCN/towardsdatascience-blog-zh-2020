<html>
<head>
<title>Configure Cloud Environments for Batch ML Jobs on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为 AWS 上的批处理 ML 作业配置云环境</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/configure-cloud-environment-for-batch-ml-job-on-aws-82edb5631540?source=collection_archive---------28-----------------------#2020-03-12">https://towardsdatascience.com/configure-cloud-environment-for-batch-ml-job-on-aws-82edb5631540?source=collection_archive---------28-----------------------#2020-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/288ac88375c49491f27ccc8b2c6d7ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3KH8JRAk1Ve7sW4N"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@good_citizen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">汉弗莱·穆莱巴</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="011d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我将带您完成准备步骤，使您能够在 AWS 上将容器化的机器学习模型作为批处理作业进行调度。这是本系列文章的第二部分，假设您已经完成了<a class="ae kf" rel="noopener" target="_blank" href="/build-a-docker-container-with-your-machine-learning-model-3cf906f5e07e">第 1 部分</a>中的前 2 步，创建了一个<code class="fe le lf lg lh b">Dockerfile</code>并构建了一个容器映像。</p><p id="00fa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了了解您在准备什么，最终，我们将使用<a class="ae kf" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank"> AWS Batch </a>来安排 ML 作业。</p><p id="39e4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">AWS Batch 使用弹性容器服务(ECS)将作业作为 Docker 容器执行。它根据提交的批处理作业的数量和特定资源要求，动态调配计算资源的最佳数量和类型(例如，CPU 或内存优化实例)。</p><p id="a5fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您的模型需要很长时间运行或者有复杂的依赖关系，AWS Batch 是一个很好的解决方案。它支持任何可以作为 Docker 容器执行的作业。</p><p id="9f03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是为了能够使用 AWS Batch，需要为您的云环境做一些准备。在本文中，我们将首先在注册表中注册我们构建的容器，并确保我们有适当的配置。</p><h1 id="a730" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 3—注册您的容器👩🏻‍✈️</h1><p id="cea7" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">我们构建的 Docker 映像当前驻留在我们的本地机器上。要在其他地方运行它，比如云，我们需要把它推到 Docker 注册中心。这非常像将您的本地代码推送到 GitHub，以便您的 EC2 可以克隆它。</p><p id="e333" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">类似于我们有不同的版本控制工具，如 GitHub、GitLab、BitBucket 等，也有不同的容器注册中心。Docker Hub 是最受欢迎的一个，但是<a class="ae kf" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> AWS </a>、<a class="ae kf" href="https://azure.microsoft.com/en-us/services/container-registry/" rel="noopener ugc nofollow" target="_blank"> Azure </a>、<a class="ae kf" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank"> GCP </a>也都提供了它们自己的容器注册表。你可以根据自己的喜好选择其中的任何一个。对于本教程，我们将使用 AWS 原生— Amazon 弹性容器注册中心(或 ECR)。</p><h2 id="6b56" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">创建存储库</h2><p id="303c" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">打开 AWS 控制台并转到 ECR，选择<strong class="ki iu"> Create repository </strong>并给它命名。然后点击<strong class="ki iu">创建存储库。</strong></p><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/bbac6195899a2549fee99fb34d5b0813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D672lBbFvCQg-pa47VBhfw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">创建存储库</p></figure><p id="b64e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您已经准备好将容器从您的终端推送到这个存储库了(需要<a class="ae kf" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>)。单击存储库名称查看推送命令。</p><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/89f1a41f12167060eebe85b95842ec80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gWQF4bK_uvTWHdUBJoUiog.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">通过单击存储库名称查看推送命令</p></figure><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/945d214abbaf08a77314b6b279ba9f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HUovA2BJnqITSufS1VL-9Q.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">查看推送命令</p></figure><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/58c652174712ce5904eab3d3676d2967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oa4Iwlcx_uy08F395qcViA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">容器注册库的推送命令</p></figure><h2 id="3076" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">推送命令是什么意思</h2><p id="aefd" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated"><strong class="ki iu"> 1)向您的注册中心认证您的 Docker 客户端</strong></p><p id="9dff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开您的终端，复制步骤 1 中括号中的内容，以检索您的登录命令，该命令向您的注册表验证您的 Docker 客户端。然后运行返回的登录命令。</p><p id="e437" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您有不同的配置文件设置(比如一个用于个人，一个用于商业)，记得在最后添加<code class="fe le lf lg lh b">--profile username</code>选项来检索正确的凭证。</p><p id="84cd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 2)树立你的形象</strong></p><p id="d567" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 3)标记图像，这样我们可以将图像推送到这个注册表</strong></p><p id="0ac9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以在这里，我们用你的亚马逊 ECR 注册 URI 来标记你创建的图像。</p><pre class="my mz na nb gt nf lh ng nh aw ni bi"><span id="2846" class="ml lj it lh b gy nj nk l nl nm">$ docker tag &lt;IMAGE_NAME&gt;:&lt;TAG&gt; 012345678901.dkr.ecr.us-east-1.amazonaws.com/&lt;IMAGE_NAME&gt;:&lt;TAG&gt;</span></pre><p id="0eff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 4)将图像推送到该注册表</strong></p><pre class="my mz na nb gt nf lh ng nh aw ni bi"><span id="507a" class="ml lj it lh b gy nj nk l nl nm">$ # push your image to the AWS ECR repository<br/>$ docker push 012345678901.dkr.ecr.us-east-2.amazonaws.com/&lt;IMAGE_NAME&gt;:&lt;TAG&gt;</span></pre><p id="29cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以通过从注册表中提取来测试推送是否成功。</p><pre class="my mz na nb gt nf lh ng nh aw ni bi"><span id="28f6" class="ml lj it lh b gy nj nk l nl nm">$ docker pull 012345678901.dkr.ecr.us-east-2.amazonaws.com/&lt;IMAGE_NAME&gt;:&lt;TAG&gt;</span></pre><p id="f803" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您的云帐户可以访问您的容器了，您已经准备好进入第 4 步来配置您的云环境。</p><h1 id="51a2" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 4 —配置权限和环境👩🏻‍🎤</h1><h2 id="f762" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">EC2</h2><p id="396e" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">你们大多数人都已经熟悉 EC2 的设置，但我只想在这里提几件事。我们不会手动创建 EC2，但是无论您选择在 AWS 上使用什么服务，它最终都会创建一些 EC2 来进行计算，因此拥有正确的设置非常重要。</p><p id="3bc0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 1)密钥对</strong></p><p id="cf60" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要为 AWS 批处理计算环境容器实例(ec2)设置 pem 密钥。您可以在 EC2 控制台中创建密钥对。创建密钥对后，您可以在创建计算环境时指定密钥对的名称，然后在使用 SSH 登录时提供私钥。</p><p id="e44c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 2)安全组</strong></p><p id="9176" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要为 AWS 批处理容器实例指定防火墙规则。例如，允许从您自己的 IP 使用 SSH，从任何地方使用 HTTP 和 HTTPS，以及任何其他规则来打开您的任务所需的端口。您也可以在 EC2 控制台中进行设置。</p><h2 id="cffd" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">VPC</h2><blockquote class="nn no np"><p id="ac24" class="kg kh nq ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated">虚拟私有云(VPC)使您能够将 AWS 资源启动到您定义的虚拟网络中。您可以完全控制虚拟网络环境，包括选择自己的 IP 地址范围、创建子网以及配置路由表和网络网关。</p></blockquote><p id="745c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了在您安全实践中更加警惕，我们应该设置一个 VPC，并让我们的计算节点驻留在 VPC 的私有子网中(如果需要访问互联网，则使用 NAT 网关)。</p><p id="c071" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是出于测试目的，您可以创建一个带有单个公共子网的 VPC，我们应该没问题。</p><h2 id="b494" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">IAM 角色和权限</h2><p id="d0ec" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">在您开始尝试 AWS Batch 之前，请通过参考<a class="ae kf" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html" rel="noopener ugc nofollow" target="_blank">该清单</a>确保您拥有所需的权限(如果您是管理员，请跳过此步骤)。</p><p id="2c40" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简而言之，AWS Batch 将创建一个 EC2 节点来使用 Amazon ECS 运行您的代码，因此您需要创建一个 IAM 角色，该角色具有访问计算环境和容器实例的权限，然后将该角色与您的计算环境相关联。</p><blockquote class="nn no np"><p id="f7e3" class="kg kh nq ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated">AWS 批处理计算环境和容器实例角色是在首次运行控制台时自动创建的，因此如果您打算使用 AWS 批处理控制台，可以继续下一节。如果您计划使用 AWS CLI，在创建您的第一个计算环境之前，完成<a class="ae kf" href="https://docs.aws.amazon.com/batch/latest/userguide/service_IAM_role.html" rel="noopener ugc nofollow" target="_blank"> AWS 批处理服务 IAM 角色</a>和<a class="ae kf" href="https://docs.aws.amazon.com/batch/latest/userguide/instance_IAM_role.html" rel="noopener ugc nofollow" target="_blank"> Amazon ECS 实例角色</a>中的过程。</p></blockquote><h2 id="6c9a" class="ml lj it bd lk mm mn dn lo mo mp dp ls kr mq mr lw kv ms mt ma kz mu mv me mw bi translated">AWS CLI</h2><p id="7911" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">如果你还没有安装 AWS CLI，现在是安装的好时机。我们将使用它将我们的容器推送到 AWS 注册中心，并与 AWS 批处理交互。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="5c4b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经将代码容器化，构建了容器映像，设置了基本的云环境，并确保我们拥有所需的权限，我们已经准备好开始在 AWS 上调度我们的第一批作业。本系列的第 3 部分再见！</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><h1 id="bcdd" class="li lj it bd lk ll ob ln lo lp oc lr ls lt od lv lw lx oe lz ma mb of md me mf bi translated">参考</h1><ul class=""><li id="982e" class="og oh it ki b kj mg kn mh kr oi kv oj kz ok ld ol om on oo bi translated">aCloudGuru<a class="ae kf" href="https://learn.acloud.guru/course/aws-ecs-scaling-docker/dashboard" rel="noopener ugc nofollow" target="_blank">AWS ECS——由<a class="ae kf" href="https://twitter.com/nickjanetakis?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor" rel="noopener ugc nofollow" target="_blank"> Nick Janetakis </a>教授的 Scaling Docker 课程</a></li><li id="742d" class="og oh it ki b kj op kn oq kr or kv os kz ot ld ol om on oo bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html" rel="noopener ugc nofollow" target="_blank">从 AWS 文档开始使用 AWS 批次</a></li><li id="5363" class="og oh it ki b kj op kn oq kr or kv os kz ot ld ol om on oo bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html" rel="noopener ugc nofollow" target="_blank">使用 AWS 文件中的 AWS 批次</a>进行设置</li><li id="f7f5" class="og oh it ki b kj op kn oq kr or kv os kz ot ld ol om on oo bi translated"><a class="ae kf" href="https://aws.amazon.com/blogs/compute/creating-a-simple-fetch-and-run-aws-batch-job/" rel="noopener ugc nofollow" target="_blank">创建简单的“获取&amp;运行”AWS 批处理作业</a>Bryan Liston</li><li id="4459" class="og oh it ki b kj op kn oq kr or kv os kz ot ld ol om on oo bi translated"><a class="ae kf" href="https://medium.com/weareservian/getting-started-with-aws-batch-3442446fc62" rel="noopener">Sunit Mehta 的 AWS 批次</a>入门</li><li id="bb0e" class="og oh it ki b kj op kn oq kr or kv os kz ot ld ol om on oo bi translated"><a class="ae kf" href="https://www.freecodecamp.org/news/an-introduction-to-docker-tags-9b5395636c2a/" rel="noopener ugc nofollow" target="_blank">快速介绍 Docker 标签</a></li></ul></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><h1 id="1eac" class="li lj it bd lk ll ob ln lo lp oc lr ls lt od lv lw lx oe lz ma mb of md me mf bi translated">关于作者💁🏻</h1><p id="8de5" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">我是一名机器学习工程师，除了技术教程之外，我还撰写关于生产力和自我发展的文章。我最近的兴趣是学习广东话和中国书法。</p></div></div>    
</body>
</html>