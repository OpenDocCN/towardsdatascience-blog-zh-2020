<html>
<head>
<title>GIS data processing cheat sheet: Effectively using command line GDAL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GIS数据处理备忘单:有效使用命令行GDAL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/gis-data-processing-cheat-sheet-effectively-using-command-line-gdal-b280823a7389?source=collection_archive---------34-----------------------#2020-05-03">https://towardsdatascience.com/gis-data-processing-cheat-sheet-effectively-using-command-line-gdal-b280823a7389?source=collection_archive---------34-----------------------#2020-05-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/1870ec7ab5523ef0674fa169b3f6bd2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CDH3htHe5FZ6LShwXOqu5A.png"/></div></div></figure><div class=""/><div class=""><h2 id="e87d" class="pw-subtitle-paragraph kb jd je bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks dk translated">在本文中，我提供了一个使用简单的命令行GDAL来处理、转换和操作大量复杂的GIS数据集的演练</h2></div><p id="8c5d" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">地理信息系统(GIS)信息量大，并提供数据的粒度表示。不用说，这些数据集对研究人员、数据分析师和数据科学家非常有吸引力。但是这些数据带来了一个大问题。从处理和计算时间的角度来看，它们很重，操作起来很痛苦。鉴于这些数据集的大小和结构，除非使用ArcGis或QGIS等软件，否则很难对其进行有意义的分析。在本文中，我提供了一些简单的命令行代码，可以用来极大地减少处理时间，并且可以有效地用于从这些数据中提取有意义的信息。这段代码使用了GDAL程序，这里的<a class="ae lp" href="https://gdal.org/" rel="noopener ugc nofollow" target="_blank">是可用的</a>。所以，让我们直接开始吧。</p><p id="b0ee" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">对于那些不熟悉GIS数据类型的人来说</strong>——我想简单总结一下你可能会遇到的不同类型的GIS数据。有两大类需要考虑。第一个是<strong class="kv jf"> <em class="lq">栅格数据</em> </strong>，它是基于格网/像元的数据，包含一些关于像元内容的信息(像元中包含的人口这样的离散数据)或它所代表的内容(像特定像元属于什么类别这样的连续数据)。光栅格式的一个例子是. tif。bsq或者。bil文件。第二个是<strong class="kv jf"> <em class="lq">矢量数据</em> </strong>，是表示为国家、州等地图形状的数据。矢量格式的一个例子是. shp或shapefile。现在，我们知道了将要处理的数据，让我们直接进入代码。</p><p id="0623" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">要使用这个代码，你需要在你的机器上安装GDAL</strong>。如果你在windows机器上，我会推荐通过cygwin终端安装GDAL。</p><p id="5cb6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">1.<strong class="kv jf">获取信息/元数据- </strong>我在本文中使用了一个示例栅格，名为gpw _ v4 _ population _ count _ rev 11 _ 2000 _ 30 _ sec . TIF。这是一个从NASA维护的数据库中下载的文件，可以在这里访问<a class="ae lp" href="https://sedac.ciesin.columbia.edu/data/set/gpw-v4-population-count-rev11/data-download" rel="noopener ugc nofollow" target="_blank">。这是一个简单的栅格，包含世界上每个国家的每个格网像元的人口。要查看该栅格实际包含的内容，让我们使用下面的gdalinfo函数。</a></p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="845b" class="ma mb je lw b gy mc md l me mf">#First go the directory containing the file</span><span id="7628" class="ma mb je lw b gy mg md l me mf">cd 'file path here'</span><span id="e67f" class="ma mb je lw b gy mg md l me mf">#Now let's run gdalinfo</span><span id="1e44" class="ma mb je lw b gy mg md l me mf">gdalinfo gpw_v4_population_count_rev11_2000_30_sec.tif</span><span id="c04c" class="ma mb je lw b gy mg md l me mf">#This is the output we get<br/>Driver: GTiff/GeoTIFF</span><span id="1a7f" class="ma mb je lw b gy mg md l me mf">Files: gpw_v4_population_count_rev11_2015_30_sec.tif</span><span id="d0c9" class="ma mb je lw b gy mg md l me mf">Size is 43200, 21600</span><span id="6e1e" class="ma mb je lw b gy mg md l me mf">Origin = (-180.000000000000000,89.999999999999915)</span><span id="49da" class="ma mb je lw b gy mg md l me mf">Pixel Size = (0.008333333333333,-0.008333333333333)</span><span id="c215" class="ma mb je lw b gy mg md l me mf">Metadata:</span><span id="2ccb" class="ma mb je lw b gy mg md l me mf">AREA_OR_POINT=Area</span><span id="cbac" class="ma mb je lw b gy mg md l me mf">DataType=Generic</span><span id="2187" class="ma mb je lw b gy mg md l me mf">Image Structure Metadata:</span><span id="2d29" class="ma mb je lw b gy mg md l me mf">COMPRESSION=LZW</span><span id="f781" class="ma mb je lw b gy mg md l me mf">INTERLEAVE=BAND</span><span id="f8c0" class="ma mb je lw b gy mg md l me mf">Corner Coordinates:</span><span id="39cb" class="ma mb je lw b gy mg md l me mf">Upper Left  (-180.0000000,  90.0000000)</span><span id="f168" class="ma mb je lw b gy mg md l me mf">Lower Left  (-180.0000000, -90.0000000)</span><span id="353f" class="ma mb je lw b gy mg md l me mf">Upper Right ( 180.0000000,  90.0000000)</span><span id="2e20" class="ma mb je lw b gy mg md l me mf">Lower Right ( 180.0000000, -90.0000000)</span><span id="9305" class="ma mb je lw b gy mg md l me mf">Center      (  -0.0000000,  -0.0000000)</span><span id="3f64" class="ma mb je lw b gy mg md l me mf">Band 1 Block=43200x1 Type=Float32, ColorInterp=Gray</span><span id="5925" class="ma mb je lw b gy mg md l me mf">NoData Value=-3.40282306073709653e+38</span></pre><p id="e02b" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">因此，我们得到的信息告诉我们<strong class="kv jf">驱动:</strong>这是文件的类型(在本例中是tif文件)，<strong class="kv jf">大小:</strong>这是网格的大小(组成网格的行数和列数，在本例中是43200，21600)。<strong class="kv jf">像素大小:</strong>这是像素内投影的大小(在本例中为0.00833333度，即5弧分)，<strong class="kv jf">角坐标:</strong>这是投影的范围(这将告诉我们某些区域是否从投影中缺失)。例如，一些地图将有一些区域被切断等)，最后我们得到<strong class="kv jf"> NoData值:</strong>，这是没有数据计算的值，或者基本上是数据集中的空值。所有这些数据都很有用，我们将在本文的其余部分看到。但是<strong class="kv jf"><em class="lq">gdalinfo</em></strong><em class="lq"/>确实很有用，因为它提供了一个文件中可用数据的快速摘要，并且不消耗任何处理能力。</p><p id="ea79" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">2.<strong class="kv jf">在栅格中填充Nodata值- </strong>对于不同的项目，我们可能不需要NoData值，或者可能希望用不同于默认值的值替换NoData值。使用gdal，我们可以遵循3个步骤来完成这个任务。首先，我们需要将NoData值替换为我们自己的默认值(假设为0)，将所有NoData值替换为零(这是一个健全性检查，以确保我们捕获的Nodata值不是由元数据指定的)，然后我们需要去掉NoData标签，因为NoData本质上是一个定性标签。我们在这里可以使用两个命令，第一个是用<strong class="kv jf"> <em class="lq"> gdalwarp </em> </strong>来替换值，第二个是用<strong class="kv jf"><em class="lq">gdal _ translate</em></strong>来移除标签。请注意，这两个命令像大多数其他gdal命令一样，会要求您指定一个单独的输出对象。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="7673" class="ma mb je lw b gy mc md l me mf">#Fill NoData values with zero</span><span id="553e" class="ma mb je lw b gy mg md l me mf">gdalwarp -srcnodata -3.40282306073709653e+38 dstnodata 0 gpw_v4_population_count_rev11_2015_30_sec.tif population_nodatafilled.tif</span><span id="374b" class="ma mb je lw b gy mg md l me mf"># Now replace all no_data values with a 0.</span><span id="a209" class="ma mb je lw b gy mg md l me mf">gdal_translate -b 1 -a_nodata 0 population_nodatafilled.tif population_only_data.tif</span><span id="e6bf" class="ma mb je lw b gy mg md l me mf">#Note that the -b indicates the band within the raster where you want to the operation. This would change for multiband rasters.</span><span id="9972" class="ma mb je lw b gy mg md l me mf"># Now take off the no_data tag itself</span><span id="d39a" class="ma mb je lw b gy mg md l me mf">gdal_translate -a_nodata none population_only_data.tif population_clean.tif</span></pre><p id="02ff" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">3.<strong class="kv jf">重新投影栅格- </strong>在比较两个栅格文件时，我们需要确保我们是在比较同类文件，因为网格大小、投影类型或投影大小甚至范围可能存在差异。<strong class="kv jf"> <em class="lq"> gdalwarp </em> </strong>允许我们进行方便的重新投影来标准化光栅文件。因此，继续我们当前的例子，如果我们想用不同的投影类型将数据重新投影到一个更小的网格上，我们将使用下面的gdalwarp命令。代码中的注释还提供了我们提供给这个命令的参数的描述。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="f809" class="ma mb je lw b gy mc md l me mf">#Let's reproject </span><span id="aefd" class="ma mb je lw b gy mg md l me mf">gdalwarp -ts 1440 600 -r average -ot Float32 -t_srs "+proj=longlat +ellps=WGS84" -te -180 -60 180 90 population_clean.tif population_reprojected.tif</span><span id="7521" class="ma mb je lw b gy mg md l me mf">#Note the following:</span><span id="2aa6" class="ma mb je lw b gy mg md l me mf"># -ts is the size of the grid that we want in rows and columns<br/># -r is specifying the method used to aggregate/dis-aggregate. There #are a number of options available, but the one that makes the most #sense is average since this is basically the sum of the cell values #being aggregated divided by the number of cells.<br/># -ot is the output type which is set to a Float since this us a #mathematical operation.<br/># -t_srs is the reprojection type. The one I am specifying here is a #longlat projection using a WGS84 datum.<br/># -te is the extent itself, which is the extent of the projection. #If you standardize the grid size and the reprojection type, you will automatically standradize the pixel size.   </span></pre><p id="7090" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">现在，你可能已经注意到，你甚至不能打开原来的tif。不过，在重新投影后，我们实际上可以绘制出光栅，因为尺寸要小得多。</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mh"><img src="../Images/5dfa21275471e4362743c5598b861b1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lh-uE9YL6jqfCNjDpTBwrw.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">这是带有按格网单元划分的人口的变形tif。</p></figure><p id="e689" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">4.<strong class="kv jf">转换栅格数据类型- </strong>用户通常会想要转换数据类型。这样做的一个常见原因是空间。例如，地理IFF在内存方面很贵，但是。bil或者。bsq文件便宜很多。因此，我们可以使用gdal_translate轻松地转换它。最棒的是，gdal会在需要的地方自动创建头文件。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="e404" class="ma mb je lw b gy mc md l me mf">#Convert tif to bil</span><span id="8a19" class="ma mb je lw b gy mg md l me mf">gdal_translate -of ENVI population_reprojected.tif population_final.bil</span><span id="cc2d" class="ma mb je lw b gy mg md l me mf">#The -of specifies the file type we want to convert to.</span></pre><p id="c962" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">5.<strong class="kv jf">根据标准替换特定像素值- </strong>现在，用户可能还想用自己的值替换栅格中的特定值。假设我们希望在所讨论的栅格中，具有任意人口值的格网像元的值为1，而没有人口值的格网像元的值为0。我们可以使用<strong class="kv jf"> <em class="lq"> gdal_calc.py </em> </strong>来实现这一点。我们只需使用下面的代码来完成这个。请注意，这是一个python命令。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="cc09" class="ma mb je lw b gy mc md l me mf">#Replace pixel values based on criteria</span><span id="2e46" class="ma mb je lw b gy mg md l me mf">gdal_calc.py -A population_final.bil --calc='((A&gt;0))*1+((A&lt;=0)*A)' --outfile=population_final_reclass.bil</span><span id="aeec" class="ma mb je lw b gy mg md l me mf">#This will basically replace all values within pixels with 1 and those without values to 0.</span></pre><p id="5299" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">6.<strong class="kv jf">光栅到矢量转换(多边形化)——</strong>假设我们想要一个根据人口分布的全球地图。也就是说，一张地图向我们展示了人们在世界上实际生活的地方。我们已经有了一个光栅，可以精确地跟踪每个像素。如果我们能结合像素得到一个有意义的地图，那将非常有帮助。这在gdal中使用<strong class="kv jf"><em class="lq">gdal _ polygonize . py</em></strong>很容易实现。这将需要一个栅格，将像素转换为多边形，合并具有相同值(在本例中为1)的相邻像素，并输出一个全局地图。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="d04a" class="ma mb je lw b gy mc md l me mf">#Convert raster to vector (shape file)</span><span id="304e" class="ma mb je lw b gy mg md l me mf">gdal_polygonize.py population_final_reclass.bil population_map.shp pop</span><span id="2ea1" class="ma mb je lw b gy mg md l me mf">#Note that the pop is the destination column name within the shape file. </span></pre><p id="7c81" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">在这之后，如果我们要绘制出人们居住的世界地图，我们会得到下面的地图。最重要的是，它将对应于我们的光栅的尺寸。</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mm"><img src="../Images/53b4c12229035c6daa84311e082eee1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSOhcm_HDw1CocI4NO1sKg.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">全球人口分布图。洞表明那里没有人口居住。</p></figure><p id="7e83" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">7.<strong class="kv jf">合并矢量文件- </strong>现在，假设在上面的地图中，我们也想要在上面的地图中表示世界上不同的国家。使用<strong class="kv jf"> <em class="lq"> ogr2ogr </em> </strong>命令，还可以合并两个矢量文件。假设我们有一个名为countries.shp的shapefile，其中包含国家的实际边界。我们可以将它与现有的形状文件合并，得到一个地图文件，向您显示国家地图，以及国家中没有人居住的地方的洞。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="8d47" class="ma mb je lw b gy mc md l me mf">#First create a file to merge against</span><span id="2e89" class="ma mb je lw b gy mg md l me mf">ogr2ogr -f 'ESRI Shapefile' population_boundaries_merged.shp population_map.shp</span><span id="9b24" class="ma mb je lw b gy mg md l me mf">#Now merge the boundaries shapefile into this one</span><span id="3920" class="ma mb je lw b gy mg md l me mf">ogr2ogr -f -update -append population_boundaries_merged.shp ccountries.shp -nln merge</span><span id="9e13" class="ma mb je lw b gy mg md l me mf">#This command is updating the population_boundaries_merged.shp by appending a new boundaries file from countries.shp. </span></pre><p id="c8a4" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这是我们从新的人口边界合并中得到的输出</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mm"><img src="../Images/ff77adc32a2c652a6aedf0024d91d1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QeN-A-FtoTz9Ks-inDUxTA.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">我们的合并矢量的输出(形状文件)</p></figure><p id="7a01" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这就是了。当必须处理大量GIS数据并从中提取有意义的信息时，这些命令是非常有用的备忘单。它们显然可以被修改以适应许多操作。我还在开发一个存储库，将这些命令作为一组正式的bash脚本来存放。当前形式的存储库在这里是<a class="ae lp" href="https://github.com/kanishkan91/Command-line-GDAL" rel="noopener ugc nofollow" target="_blank"/>。一如既往，欢迎任何与此相关的反馈！</p></div></div>    
</body>
</html>