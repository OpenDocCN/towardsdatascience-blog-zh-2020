<html>
<head>
<title>Discord notification using CloudWatch Alarms, SNS and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 CloudWatch 警报、SNS 和 AWS Lambda 的不一致通知</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/discord-notification-using-cloudwatch-alarms-sns-and-aws-lambda-71393861699f?source=collection_archive---------17-----------------------#2020-09-12">https://towardsdatascience.com/discord-notification-using-cloudwatch-alarms-sns-and-aws-lambda-71393861699f?source=collection_archive---------17-----------------------#2020-09-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e8e3f61c614414c73d2f62bb1050a0ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1dtvsqlgPihcgMqt"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@k_yasser?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Khadeeja Yasser </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c750" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">警报的存在是为了在我们的系统以一种意外的方式运行时通知我们<em class="le">，这保证了手动干预来纠正</em>。当我们在一个生产环境中有多个系统而一个错误没有被注意到时，后果可能是灾难性的。</p><p id="cc48" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当系统无法自动恢复，需要人工干预时，应发出警报。如果警报发生得过于频繁，可能会导致更长的响应时间，甚至被遗漏。</p><p id="8e28" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将为 AWS Lambda 函数构建一个警报通知管道。为此，将使用 3 个 AWS 服务:AWS Lambda、简单通知服务(SNS)和 CloudWatch。<em class="le">目标是在触发 CloudWatch 警报时向不和谐频道发送通知</em>。</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lf"><img src="../Images/09b982a5edf285d44c4c87730306fab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w489MUctwaUW0eUL2Hddkg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">使用 Lucidchart 设计:<a class="ae kf" href="https://www.lucidchart.com" rel="noopener ugc nofollow" target="_blank">https://www.lucidchart.com</a></p></figure></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="5081" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">步骤 1 —云监控警报</h1><h2 id="a216" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">选择指标</h2><p id="1ebe" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">首先，您需要选择一个 CloudWatch 指标来观察警报。对于 Lambda 函数，有 3 种类型的指标:</p><ul class=""><li id="aed0" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated"><strong class="ki iu">调用度量</strong>:调用结果的二进制指示器。例子:<em class="le">调用</em>，<em class="le">错误</em>，<em class="le">死信错误</em>，<em class="le">目的交付失败</em>，<em class="le">节流</em>。</li><li id="1fff" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">性能指标</strong>:单次调用的性能细节。如:<em class="le">时长</em>、<em class="le">迭代器</em>。</li><li id="b8cc" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">并发度量</strong>:跨函数、版本、别名或 AWS 区域处理事件的实例数量的总数。示例:<em class="le">并发执行</em>、<em class="le">ProvisionedConcurrentExecutions</em>、<em class="le">ProvisionedConcurrencyUtilization</em>、<em class="le">UnreservedConcurrentExecutions。</em></li></ul><p id="5ec1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在<a class="ae kf" href="https://docs.aws.amazon.com/lambda/latest/dg/monitoring-metrics.html" rel="noopener ugc nofollow" target="_blank"> AWS 开发者指南</a>中阅读更多关于 AWS Lambda 指标的细节。</p><p id="ecf3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个例子中，我们将监控<strong class="ki iu">错误度量</strong>，即导致函数错误的调用次数。</p><h2 id="d21f" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">图表度量</h2><p id="7776" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">接下来，您需要为指定时间段内的数据聚合选择<a class="ae kf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Statistic" rel="noopener ugc nofollow" target="_blank">统计</a>，即应用上面定义的度量的统计:<em class="le">样本计数</em>、<em class="le">平均值</em>、<em class="le">总和</em>、<em class="le">最小值</em>、<em class="le">最大值</em>。我们将使用<strong class="ki iu">总和</strong>。</p><p id="5810" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">变量 period 表示应用上述<em class="le">统计数据</em>的时间，单位为秒。我们将它设置为<strong class="ki iu"> 60s。</strong>数据与指定阈值进行比较的周期数将被设置为 1，因为我们希望我们的<em class="le">错误</em>指标仅在 1 分钟的间隔内进行评估。</p><h2 id="c84c" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">情况</h2><p id="519a" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">最后，您需要设置比较运算符，这是在比较指定的统计数据和阈值时使用的算术运算。支持的条件:</p><ul class=""><li id="f969" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">GreaterThanOrEqualToThreshold</li><li id="0b8f" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">更大的阈值</li><li id="a7af" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">小于阈值</li><li id="654b" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">LessThanOrEqualToThreshold</li></ul><p id="f777" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用条件:<strong class="ki iu"> GreaterThanThreshold </strong>，阈值<strong class="ki iu"> </strong>为<strong class="ki iu"> 0 </strong>。</p><h2 id="b12f" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated"><strong class="ak">通知</strong></h2><p id="9188" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">正如本文开头提到的，CloudWatch 警报将触发一个 SNS 主题来通知警报何时处于<code class="fe nu nv nw nx b">ALARM</code>状态。</p><h2 id="7419" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">地形代码</h2><p id="2972" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">下面的代码包含了上面讨论的所有设置。它还包含一些这里不会讨论的附加设置。您可以看到，我在变量<code class="fe nu nv nw nx b">alarms_actions</code>中添加了我们将在下一节中创建的 SNS 的 ARN，这意味着当 SNS 转换到<code class="fe nu nv nw nx b">ALARM</code>状态时，该警报将触发 SNS。</p><figure class="lg lh li lj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="9ea8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的代码允许您创建任意数量的 CloudWatch 警报。您只需编辑<code class="fe nu nv nw nx b">local.alarms_dimensions</code>:</p><figure class="lg lh li lj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="80c1" class="lr ls it bd lt lu oa lw lx ly ob ma mb mc oc me mf mg od mi mj mk oe mm mn mo bi translated">步骤 2 —简单通知服务(SNS)</h1><p id="56b8" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">来自<a class="ae kf" href="https://aws.amazon.com/sns/?nc1=h_ls&amp;whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" rel="noopener ugc nofollow" target="_blank"> AWS 文档</a>:</p><blockquote class="of og oh"><p id="cd19" class="kg kh le ki b kj kk kl km kn ko kp kq oi ks kt ku oj kw kx ky ok la lb lc ld im bi translated">Amazon Simple Notification Service(Amazon SNS)是一种 web 服务，用于协调和管理向订阅端点或客户端发送消息。它使您能够通过<a class="ae kf" href="https://aws.amazon.com/pub-sub-messaging/" rel="noopener ugc nofollow" target="_blank">发布/订阅</a>(发布/订阅)模式在系统之间进行通信</p></blockquote><p id="be0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的 SNS 需要向 Lambda-Alarm 发布消息，然后 Lambda-Alarm 会向 Discord 通道发送一条自定义消息。</p><h2 id="cf3b" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">地形代码</h2><p id="213b" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">在下面的代码中，我们为 SNS 主题订阅了 Lambda-Alarm，并在<code class="fe nu nv nw nx b">endpoint</code>参数中传递了 lambda ARN。</p><figure class="lg lh li lj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="284a" class="lr ls it bd lt lu oa lw lx ly ob ma mb mc oc me mf mg od mi mj mk oe mm mn mo bi translated">第 3 步—λ警报</h1><p id="1666" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">当被 SNS 主题触发时，该 Lambda 将使用以下消息格式向不和谐频道发送警报:</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lf"><img src="../Images/35fd377eb8fe0e605a0e2d95f14cb979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aynzm_bpNjqTcX8i5rDl9w.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">不和谐频道截图</p></figure><h2 id="1be2" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">不和谐的网钩</h2><p id="ff5c" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">首先，您需要在所需的频道中创建一个 Webhook。在<em class="le">编辑频道</em>页面，你将进入<em class="le">整合</em>，以及<em class="le">创建 Webhook。</em></p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ol"><img src="../Images/afba6e97ef26e71ba391c85cd1e4c614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3uwrxHBs9UeP6lzgu9U5GQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">不和谐频道设置截图</p></figure><p id="0985" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，您将复制 Webhook URL 并将其粘贴到您的 Lambda 代码中。</p><h2 id="a6ac" class="mp ls it bd lt mq mr dn lx ms mt dp mb kr mu mv mf kv mw mx mj kz my mz mn na bi translated">λ代码</h2><p id="d5d7" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">下面的代码非常直观，不需要过多解释。你可以在<a class="ae kf" href="https://discord.com/developers/docs/resources/channel#embed-limits" rel="noopener ugc nofollow" target="_blank"> Discord 的开发者门户</a>上获得关于<em class="le">通道对象</em>的更多信息。</p><figure class="lg lh li lj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="ace2" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">结论</h1><p id="fa15" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">在本文中，我们使用 CloudWatch Alarms、SNS 和 AWS Lambda 构建了一个警报通知系统。当我们的 lambda 中出现错误时，我们将在 Discord 通道中收到一条消息。</p><p id="177e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当然，您可以将 Lambda 警报与除 Discord 之外的其他服务集成在一起，例如:</p><ul class=""><li id="e464" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">任何电子邮件服务:Gmail，Outlook，雅虎等</li><li id="d069" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">松弛的</li><li id="5c08" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">微软团队</li></ul><p id="2fa8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在这里查看完整代码<a class="ae kf" href="https://github.com/DanielDaCosta/cloudwatch-alarms" rel="noopener ugc nofollow" target="_blank"/>！</p><h1 id="5bbf" class="lr ls it bd lt lu oa lw lx ly ob ma mb mc oc me mf mg od mi mj mk oe mm mn mo bi translated">参考</h1><div class="om on gp gr oo op"><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ConsoleAlarms.html" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">基于静态阈值创建云观察警报</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">您为要观察的警报选择一个 CloudWatch 指标，以及该指标的阈值。警报进入警报状态…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="om on gp gr oo op"><a href="https://discord.com/developers/docs/resources/channel#embed-limits" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">Discord 开发者门户-面向机器人和开发者的 API 文档</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">将你的服务与不和谐融为一体——无论是机器人、游戏还是你能想到的任何东西…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">discord.com</p></div></div></div></a></div><div class="om on gp gr oo op"><a href="https://docs.aws.amazon.com/lambda/latest/dg/monitoring-metrics.html" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">使用 AWS Lambda 函数度量</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">当您的函数处理完一个事件时，Lambda 会将关于调用的指标发送到 Amazon CloudWatch。你…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="om on gp gr oo op"><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">地形注册表</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">编辑描述</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">registry.terraform.io</p></div></div></div></a></div></div></div>    
</body>
</html>