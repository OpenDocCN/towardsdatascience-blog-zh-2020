<html>
<head>
<title>Top 5 SQL Analytic Functions Every Data Analyst Needs to Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">每个数据分析师都需要知道的五大 SQL 分析函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/top-5-sql-analytic-functions-every-data-analyst-needs-to-know-3f32788e4ebb?source=collection_archive---------1-----------------------#2020-08-27">https://towardsdatascience.com/top-5-sql-analytic-functions-every-data-analyst-needs-to-know-3f32788e4ebb?source=collection_archive---------1-----------------------#2020-08-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8aeb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">SQL 分析函数，让您的分析技能更上一层楼</h2></div><p id="484c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">分析功能是 BI/数据分析师中用于执行复杂数据分析的最受欢迎的工具之一。这些函数对多行执行计算，并返回多行。今天，我们将讨论我认为最有用的 5 个函数，以及大量的实际例子。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/b8266c5e0942d33c82b06fc959c7c651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ohetMxBu4pfi-d0H"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">帕特里克·卡尔在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="048d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于外行来说，带有分析功能的查询的相对大小可能有点吓人。别担心，我们会保护你的。这些函数大多遵循一个基本语法:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d969" class="ma mb it lw b gy mc md l me mf">analytic_function_name([argument_list])<br/>OVER (<br/>[PARTITION BY partition_expression,…]<br/>[ORDER BY sort_expression, … [ASC|DESC]])</span></pre><p id="a7da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个语法有三个部分，即<em class="mg">函数</em>、划分的<em class="mg">和</em>排序的<em class="mg">。让我们简要介绍一下每种方法的作用:</em></p><ul class=""><li id="e115" class="mh mi it kk b kl km ko kp kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mq mr ms lw b">analytic_function_name</code>:功能名称——如<code class="fe mq mr ms lw b">RANK()</code>、<code class="fe mq mr ms lw b">SUM()</code>、<code class="fe mq mr ms lw b">FIRST()</code>等</li><li id="a1c2" class="mh mi it kk b kl mt ko mu kr mv kv mw kz mx ld mm mn mo mp bi translated"><code class="fe mq mr ms lw b">partition_expression</code>:创建分区或窗框所依据的列/表达式</li><li id="bda9" class="mh mi it kk b kl mt ko mu kr mv kv mw kz mx ld mm mn mo mp bi translated"><code class="fe mq mr ms lw b">sort_expression</code>:对分区中的行进行排序所依据的列/表达式</li></ul><p id="405c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，到目前为止，我们已经介绍了基础知识。对于实际部分，我们将使用存储在<em class="mg"> PostgreSQL </em>数据库中的<a class="ae lu" href="https://www.w3resource.com/sql/sql-table.php" rel="noopener ugc nofollow" target="_blank">订单表</a>:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi my"><img src="../Images/0696dd8dcdc4408e35cc31cf06ba2377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1LdQb4C0Z1PPeG7IIOS4Hw.png"/></div></div></figure><p id="fa85" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们从实际部分开始，好吗？</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="1f74" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">AVG()和求和()</h1><p id="3fec" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated">我们都在我们的<code class="fe mq mr ms lw b">GROUP BY</code>子句中使用了聚合函数，比如<code class="fe mq mr ms lw b">SUM</code>、<code class="fe mq mr ms lw b">AVG</code>、<code class="fe mq mr ms lw b">MIN</code>、<code class="fe mq mr ms lw b">MAX</code>和<code class="fe mq mr ms lw b">COUNT</code>。但是当这些函数用于一个<code class="fe mq mr ms lw b">ORDER BY</code>子句时，它们可以给出运行总和、平均值、总数等。</p><p id="aa7b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的例子将使它变得更加清晰— <em class="mg">我们要计算每个代理在第三季度的运行平均收入和总收入:</em></p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="2213" class="ma mb it lw b gy mc md l me mf">SELECT ord_date, agent_code, AVG(ord_amount) OVER (<br/>    PARTITION BY agent_code<br/>    ORDER BY ord_date<br/>) running_agent_avg_revenue, <br/>    SUM (ord_amount) OVER (<br/>        PARTITION BY agent_code<br/>        ORDER BY ord_date<br/>    ) running_agent_total_revenue<br/>FROM orders<br/>WHERE ord_date BETWEEN ‘2008–07–01’ AND ‘2008–09–30’;</span></pre><p id="d5e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果如下:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oc"><img src="../Images/07bb87538e3281b83acc3aaa900a6e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wpu1uWQu7IddUAGdshx-Lw.png"/></div></div></figure><p id="311f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">厉害！这些功能很简单，不需要额外的解释。我们继续吧。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="df56" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">第一个值()，最后一个值()，第 n 个值()</h1><p id="5bcc" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated"><code class="fe mq mr ms lw b">FIRST_VALUE()</code>是一个分析函数，从窗口框架的第一行返回指定列的值。如果你已经理解了上一句话，<code class="fe mq mr ms lw b">LAST_VALUE()</code>不言自明。它从最后一行获取值。</p><p id="79f0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg"> PostgreSQL </em>为我们提供了另一个名为<code class="fe mq mr ms lw b">NTH_VALUE(column_name, n)</code>的函数，它从第 n 行获取值。是不是很棒？不再有复杂的自连接。</p><p id="458b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们来回答以下问题— <em class="mg">客户第一次购买后多少天进行下一次购买？</em></p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="2cb9" class="ma mb it lw b gy mc md l me mf">SELECT cust_code, ord_date, ord_date — FIRST_VALUE(ord_date) OVER (<br/>    PARTITION BY cust_code <br/>    ORDER BY ord_date) next_order_gap<br/>FROM orders<br/>ORDER BY cust_code, next_order_gap;</span></pre><p id="696b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果如下:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi od"><img src="../Images/9c7bec3aa746f283122b006ffe164d60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4mZ9pOrLfAiPEtX7fZr-Pw.png"/></div></div></figure><p id="05fd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个函数在很多情况下都是有用的。此外，很高兴知道结果可以直接从数据库中获得，所以我们不必用 Python/R 手动进行这种计算。</p><p id="3a90" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们进行下一个。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="2c25" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">超前()和滞后()</h1><p id="6f3e" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated"><code class="fe mq mr ms lw b">LEAD()</code>函数，顾名思义，从下一行取出特定列的值，并将取出的值返回当前行。在<em class="mg"> PostgreSQL </em>中，<code class="fe mq mr ms lw b">LEAD()</code>采用两个参数:</p><ul class=""><li id="2837" class="mh mi it kk b kl km ko kp kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mq mr ms lw b">column_name</code>必须从中提取下一个值</li><li id="9c6d" class="mh mi it kk b kl mt ko mu kr mv kv mw kz mx ld mm mn mo mp bi translated"><code class="fe mq mr ms lw b">index</code>相对于当前行的下一行。</li></ul><p id="463a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mq mr ms lw b">LAG()</code>正好相反。它从前面的行中获取值。</p><p id="d4b6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们来回答以下问题，让这个概念更清楚一点— <em class="mg">代理销售订单的最后最高金额是多少？</em></p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="3e79" class="ma mb it lw b gy mc md l me mf">SELECT agent_code, ord_amount, LAG(ord_amount, 1) OVER (<br/>    PARTITION BY agent_code<br/>    ORDER BY ord_amount DESC<br/>) last_highest_amount<br/>FROM orders<br/>ORDER BY agent_code, ord_amount DESC;</span></pre><p id="e798" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果如下:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oe"><img src="../Images/b4732be902942d77499ccde93f78a395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a_j5FKa7bo3QX0tooHXj8A.png"/></div></div></figure><p id="a52f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面您可以看到<code class="fe mq mr ms lw b">last_highest_amount</code>如何清楚地显示每个代理的数据——这就是为什么代理 A001 没有结果，而其他代理的第一个值为空。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="bf49" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">秩()和密集秩()</h1><p id="a80b" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated"><code class="fe mq mr ms lw b">RANK()</code>和<code class="fe mq mr ms lw b">DENSE_RANK()</code>是编号功能。它们根据分区和排序将整数值赋给一行。在查找表中的第 n 个最高/最低记录时，我不能过分强调这些函数的重要性。</p><p id="10da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mq mr ms lw b">DENSE_RANK()</code>和<code class="fe mq mr ms lw b">RANK()</code>的区别在于，前者得到连续的等级，而后者是跳过一个平局后的等级。例如，使用<code class="fe mq mr ms lw b">DENSE_RANK()</code>的排名将类似于(1，2，2，3)，而使用<code class="fe mq mr ms lw b">RANK()</code>的排名将是(1，2，2，4)。希望你明白其中的区别。</p><p id="96ce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无论如何，让我们在这些函数的帮助下回答以下问题— <em class="mg">每个月的第二高阶值是多少？</em></p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="eadb" class="ma mb it lw b gy mc md l me mf">SELECT * FROM (<br/>    SELECT ord_num, ord_date, ord_amount, DENSE_RANK() OVER(<br/>        PARTITION BY DATE_PART(‘month’, ord_date) <br/>        ORDER BY ord_amount DESC) order_rank <br/>    FROM orders<br/>) t<br/>WHERE order_rank = 2<br/>ORDER BY ord_date;</span></pre><p id="4d7e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果如下:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi of"><img src="../Images/96919ebf35fd910a5633515b0509c0b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VsgfdCD9-pGaQ7_5PFDSbQ.png"/></div></div></figure><p id="33f4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">酷！让我们进行下一个。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="a9d9" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">DIST CUME()</h1><p id="151e" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated"><code class="fe mq mr ms lw b">CUME_DIST()</code>函数用于计算给定分区内值的累积分布。它计算分区中小于或等于当前行的行的比例。当我们必须只获取结果的前 n%时，这非常有用。</p><p id="9442" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们用它来<em class="mg">计算八月和九月每个订单的收入百分比</em>:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="e408" class="ma mb it lw b gy mc md l me mf">SELECT DATE_PART(‘Month’,ord_date), agent_code, ord_amount, CUME_DIST() OVER(<br/>   PARTITION BY DATE_PART(‘Month’,ord_date)<br/>    ORDER BY ord_amount<br/>)<br/>FROM orders<br/>WHERE ord_date BETWEEN ‘2008–08–01’ AND ‘2008–09–30’;</span></pre><p id="e172" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果如下:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi og"><img src="../Images/1b1b5e97e03ee43310c5f18579390133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pvGm7eE-mAB8PoEzjO6_cw.png"/></div></div></figure><p id="5724" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这不是我日常使用的功能，但很高兴知道它的存在。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="4443" class="ng mb it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">在你走之前</h1><p id="28d9" class="pw-post-body-paragraph ki kj it kk b kl nx ju kn ko ny jx kq kr nz kt ku kv oa kx ky kz ob lb lc ld im bi translated">这就是我在数据库中执行分析时使用的 5 个最常见的分析函数。对我来说，这不像用 Python 和 Pandas 做分析那么常见，但我仍然发现这有时很有用——尤其是对于仅限于 SQL 的分析师。</p><p id="bab0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望这 5 款能很好的适合你，可以随意自己多研究研究。感谢阅读。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><p id="10f4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg">喜欢这篇文章吗？成为</em> <a class="ae lu" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="mg">中等会员</em> </a> <em class="mg">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="oh oi gp gr oj ok"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">通过我的推荐链接加入 Medium-Dario rade ci</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy lo ok"/></div></div></a></div></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><p id="0ac4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lu" href="https://mailchi.mp/46a3d2989d9b/bdssubscribe" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu">加入我的私人邮件列表，获取更多有用的见解。</strong> </a></p></div></div>    
</body>
</html>