<html>
<head>
<title>Backtesting Bollinger Bands on Apple Stock using Quantopian</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Quantopian对苹果股票的布林线进行回溯测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/backtesting-bollinger-bands-on-apple-stock-using-quantopian-6be2e4824f43?source=collection_archive---------19-----------------------#2020-02-29">https://towardsdatascience.com/backtesting-bollinger-bands-on-apple-stock-using-quantopian-6be2e4824f43?source=collection_archive---------19-----------------------#2020-02-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="825d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们将创建一个使用双布林线策略交易APPL股票的机器人，并用5年的数据进行回溯测试，将其与买入并持有进行比较。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5d3b9ea2531d146280455cc9e20cab88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8GBT4hV_EvfuR1aN"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">尼古拉·切尔尼琴科在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="dc07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">学习技术分析的最大挑战之一(如果不是最大的话)是<em class="ls"/>把你的钱押在一个策略上，而你并不知道这个策略是否有效。互联网上有很多好的和坏的信息，但通过经济损失找出什么有效什么无效是一个难以下咽的药丸。幸运的是，我们不再需要拿我们辛苦赚来的钱去测试我们在网上学到的东西了。我们可以在开始操作前用量子力学进行回溯测试。</p><p id="6cef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想提出一个简单的练习:用一个最著名的指标来交易2015年到2020年的苹果股票。是双布林线策略。这是我们要做的:</p><p id="300f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 1-计算2组布林线。</strong></p><p id="3c81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一组距离20天简单移动平均线(SMA 20)1个标准差，另一组距离SMA 20 2个标准差。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/78ef1abeeb8a5521c551f0831c2c0d16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HNN3FsHHmOmslTimmqd0nQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://www.prorealcode.com/prorealtime-indicators/blai5-bb-double/" rel="noopener ugc nofollow" target="_blank">https://www . pro real code . com/pro real time-indicators/blai 5-b b-double/</a></p></figure><p id="eaa8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 2-定义操作区域</strong></p><p id="6965" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">两个上部带之间的区域将是<em class="ls">‘购买区’</em>(上图中的红色区域)。两个较低带之间的区域将是<em class="ls">‘销售区’</em>(绿色区域)。以及中央区域，即<em class="ls">‘中性区域’</em>。</p><p id="83fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 3-实施战略</strong></p><ul class=""><li id="ee85" class="lu lv iq ky b kz la lc ld lf lw lj lx ln ly lr lz ma mb mc bi translated">如果当前价格在<em class="ls">买入区</em>，我们在APPL上做多。</li><li id="9b77" class="lu lv iq ky b kz md lc me lf mf lj mg ln mh lr lz ma mb mc bi translated">如果当前价格处于“中性区”<em class="ls"/>，我们就按兵不动。</li><li id="6cf9" class="lu lv iq ky b kz md lc me lf mf lj mg ln mh lr lz ma mb mc bi translated">如果当前价格在“<em class="ls">卖出区</em>”内，我们做空APPL。</li></ul><p id="3a2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除此之外，我们还将测试该算法的不同参数。但是首先我们需要一个基准。让我们看看购买APPL并持有5年的表现。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/a48df2a2ca3438e6fcc78f773c1a46d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hsnsKDnXwcRHJSajTiuRcg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在APPL (sid=24)上，每天重新平衡投资组合，使其为100%多头</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mj"><img src="../Images/057c0a4c9eac1b62e07fe1ae3a2782da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQabW4NetYyovf6gsH_3IA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">APPL买入并持有业绩</p></figure><p id="0054" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不算太坏，5年内194.63%的回报率或每年大约15%。然而，贝塔系数和下降幅度非常高。同样，希望增加α和夏普比率。让我们编写一个机器人来执行双布林线策略，并在相同的时间内对其进行回测:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="ccf4" class="mp mq iq ml b gy mr ms l mt mu"># Original Double BB strategy</span><span id="f060" class="mp mq iq ml b gy mv ms l mt mu">import numpy as np</span><span id="3315" class="mp mq iq ml b gy mv ms l mt mu">def initialize(context):<br/>    context.stock = sid(24)<br/>    schedule_function(buy_and_hold, date_rules.every_day())<br/>    context.sell = False<br/>    context.buy = False</span><span id="f19f" class="mp mq iq ml b gy mv ms l mt mu">def bollinger_bands(context, data):<br/>    period = 20<br/>    current_price = data.current(context.stock, 'price')<br/>    prices = data.history(context.stock, 'price', period, '1d')<br/>    avg_20 = prices.mean()<br/>    std = prices.std()<br/>    <br/>    upper_band1 = avg_20 + std<br/>    upper_band2 = avg_20 + 2*std<br/>    lower_band1 = avg_20 - std<br/>    lower_band2 = avg_20 - 2*std<br/>    <br/>    stop_loss = 0.0<br/>        <br/>    if ((current_price &gt; upper_band1) and (current_price &lt; upper_band2)) and not context.buy:<br/>        order_target_percent(context.stock, 1.0)<br/>        context.buy = True<br/>        context.sell = False<br/>        print('Long position')<br/>            <br/>    elif ((current_price &lt; lower_band1) and (current_price &gt; lower_band2)) and not context.sell:<br/>        order_target_percent(context.stock, -1.0)<br/>        context.buy = False<br/>        context.sell = True<br/>        print('Short position')<br/>    <br/>    elif (current_price &lt; (1 - stop_loss) * lower_band1) and context.buy:<br/>        order_target_percent(context.stock, 0)<br/>        context.buy = False<br/>        context.sell = False<br/>        print('Stop loss on long')<br/>        <br/>    elif (current_price &gt; (1 + stop_loss) * upper_band1) and context.sell:<br/>        order_target_percent(context.stock, 0)<br/>        context.buy = False<br/>        context.sell = False<br/>        print('Stop loss short')<br/>    <br/>    record(upper = upper_band2, lower = lower_band2, price = current_price)</span></pre><p id="c9d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个代码中，使用了SMA20和0%的止损。除此之外，一旦当前价格脱离买入或卖出区域，算法就会平仓。让我们看看这段代码将如何执行:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/b27f41547830042fb3a4badcc01480f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IUfoisdHYH4F3BtgGwpW1A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">原创双BB性能</p></figure><p id="f8a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回报率大幅下降，但所有其他基本面都有所改善。让我们看看是否可以通过稍微调整我们的算法来做得更好。我提议3个改变:</p><p id="381b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1-不要用SMA20，我们试试SMA13。<em class="ls">互联网</em>会告诉你在8到12之间选择一个SMA，但我认为最好对它进行回溯测试，选择一个最适合你想要使用的安全性的。我测试了几个，13是最好的。</p><p id="3559" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2-允许当前价格有更多的空间来“T2”呼吸“T3”。让价格在简单移动平均线(上下带)的2个标准差内反弹。</p><p id="fbfc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3-设置2%的止损。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="c394" class="mp mq iq ml b gy mr ms l mt mu"># Modified Double BB strategy</span><span id="826f" class="mp mq iq ml b gy mv ms l mt mu">import numpy as np</span><span id="b8d7" class="mp mq iq ml b gy mv ms l mt mu">def initialize(context):<br/>    context.stock = sid(24)<br/>    schedule_function(bollinger_bands, date_rules.every_day())<br/>    context.sell = False<br/>    context.buy = False<br/>     <br/>def buy_and_hold(context, data):<br/>    order_target_percent(context.stock, 1.0)<br/>    print('Buy APPL')</span><span id="f167" class="mp mq iq ml b gy mv ms l mt mu">def bollinger_bands(context, data):<br/>    period = 13<br/>    current_price = data.current(context.stock, 'price')<br/>    prices = data.history(context.stock, 'price', period, '1d')<br/>    avg_20 = prices.mean()<br/>    std = prices.std()<br/>    <br/>    upper_band1 = avg_20 + std<br/>    upper_band2 = avg_20 + 2*std<br/>    lower_band1 = avg_20 - std<br/>    lower_band2 = avg_20 - 2*std<br/>    <br/>    stop_loss = 0.02<br/>        <br/>    if ((current_price &gt; upper_band1) and (current_price &lt; upper_band2)) and not context.buy:<br/>        order_target_percent(context.stock, 1.0)<br/>        context.buy = True<br/>        context.sell = False<br/>        print('Long position')<br/>            <br/>    elif ((current_price &lt; lower_band1) and (current_price &gt; lower_band2)) and not context.sell:<br/>        order_target_percent(context.stock, -1.0)<br/>        context.buy = False<br/>        context.sell = True<br/>        print('Short position')<br/>    <br/>    elif (current_price &lt; (1 - stop_loss) * lower_band2) and context.buy:<br/>        order_target_percent(context.stock, 0)<br/>        context.buy = False<br/>        context.sell = False<br/>        print('Stop loss on long')<br/>        <br/>    elif (current_price &gt; (1 + stop_loss) * upper_band2) and context.sell:<br/>        order_target_percent(context.stock, 0)<br/>        context.buy = False<br/>        context.sell = False<br/>        print('Stop loss short')<br/>    <br/>    record(upper = upper_band2, lower = lower_band2, price = current_price)</span></pre><p id="094e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们回测一下这段代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/f94cd393035b7496356011dd5cfa8f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AWXQVWwRdNix2-c2ecI4lA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">改进的双BB性能</p></figure><p id="72fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">很好！我们能够提高回报率、阿尔法和夏普比率，同时降低贝塔和下降。</p><h1 id="2f70" class="my mq iq bd mz na nb nc nd ne nf ng nh jw ni jx nj jz nk ka nl kc nm kd nn no bi translated">结论</h1><p id="e518" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">在本文中，我们研究了苹果股票的双BB策略与买入并持有策略的绩效。</p><p id="3d23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与买入并持有相比，自动双BB的回报率增加了100%以上，同时降低了市场风险β和提款。此外，机器人增加了阿尔法和夏普比率。</p><p id="8fc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我很想在评论区听到你关于如何改进这个算法的想法。</p><p id="3137" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谢谢！</p><p id="7c84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="ls">来自《走向数据科学》编辑的提示:</em> </strong> <em class="ls">虽然我们允许独立作者根据我们的</em> <a class="ae kv" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="ls">规则和指导方针</em> </a> <em class="ls">发表文章，但我们并不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae kv" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="ls">读者术语</em> </a> <em class="ls">。</em></p></div></div>    
</body>
</html>