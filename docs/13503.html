<html>
<head>
<title>Investigate Anomalies in Temporal Data With Machine Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用机器学习研究时态数据中的异常</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/investigate-anomalies-in-temporal-data-with-machine-learning-b3da86793142?source=collection_archive---------25-----------------------#2020-09-16">https://towardsdatascience.com/investigate-anomalies-in-temporal-data-with-machine-learning-b3da86793142?source=collection_archive---------25-----------------------#2020-09-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d89a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用 Python 和机器学习分析时序数据，并交互可视化。</h2></div><h1 id="8815" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">这是你要做的:</h1><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/e9be2a2eccf9298c4df914b383979e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*hiD7-mAofhi1GiQrxbpF3g.gif"/></div></div></figure><h2 id="c1f6" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">概观</h2><p id="52d7" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">在<a class="ae mu" href="https://colab.research.google.com/drive/1rrkJ-pcddna7Ft8Zv-xYgPIVMduJi49u?usp=sharing" rel="noopener ugc nofollow" target="_blank">这本笔记本</a>中，我们将探索脸书的开源萨里玛模型<em class="mv">先知</em>来识别时间序列数据中的异常值。以下是你将学到的东西:</p><ul class=""><li id="2b1a" class="mw mx it md b me my mh mz lr na lu nb lx nc mt nd ne nf ng bi translated">什么是时序数据？</li><li id="f5b4" class="mw mx it md b me nh mh ni lr nj lu nk lx nl mt nd ne nf ng bi translated">萨里玛是什么？</li><li id="5150" class="mw mx it md b me nh mh ni lr nj lu nk lx nl mt nd ne nf ng bi translated">构建一个简单的优化器来自动优化 Prophet 模型</li><li id="c108" class="mw mx it md b me nh mh ni lr nj lu nk lx nl mt nd ne nf ng bi translated">如何使用 Prophet 预测数据</li><li id="1fd4" class="mw mx it md b me nh mh ni lr nj lu nk lx nl mt nd ne nf ng bi translated">使用 Prophet 和 Bokeh 识别交互式仪表板中的异常值</li><li id="5294" class="mw mx it md b me nh mh ni lr nj lu nk lx nl mt nd ne nf ng bi translated">使用散景创建用于调查的时序仪表板布局</li></ul><h2 id="7707" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">什么是时态数据？</h2><p id="17d8" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">在<a class="ae mu" rel="noopener" target="_blank" href="/level-up-your-visualizations-make-interactive-maps-with-python-and-bokeh-7a8c1da911fd">我的上一篇文章</a>中，我们使用了空间数据——也就是说，空间中某个地方存在的带有坐标的数据。时态数据通常是空间数据的伴生物，它是任何具有相关时间或日期的数据。时态数据对于全面理解数据集至关重要，能够理解与时间相关的统计数据(趋势、季节性和异常值)将显著提高您处理业务数据的整体能力。</p><p id="c16d" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">在我擅长的国家安全和国防领域，可能没有比时态数据更重要的数据类型了。时态数据有助于我们了解时间模式，并对未来做出预测。在本文中，这也是您将要学习的内容。</p><h2 id="417f" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">我们的数据</h2><p id="f89d" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">我们将使用来自<strong class="md iu">武装冲突地点事件数据库</strong>的数据，具体范围缩小到伊拉克。数据可以从 github <a class="ae mu" href="https://raw.githubusercontent.com/ConnerBrew/Iraq-Conflict-Data/master/conflict_data_irq.csv" rel="noopener ugc nofollow" target="_blank">这里</a>下载，或者从<a class="ae mu" href="http://acleddata.com" rel="noopener ugc nofollow" target="_blank"> ACLED 网站</a>下载。我们将分析 2016 年至 2020 年伊拉克冲突事件数据的趋势和季节性，预测这些数据，并识别异常值。然后，我们将创建一个配套的折线图，它将允许我们深入特定的事件类别，这样我们就可以在发现异常值后对其进行调查。<strong class="md iu">走吧！</strong></p><h2 id="5388" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">加载库</h2><p id="3ef4" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">首先，让我们导入必要的库。我们将使用所有的 Bokeh 来创建我们的交互式图形，fbprophet 用于 prophet 预建模型，sklearn 用于模型优化，pandas 用于一些数据操作。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="78ed" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">加载数据</h2><p id="aa1c" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">你可以在<a class="ae mu" href="https://raw.githubusercontent.com/ConnerBrew/Iraq-Conflict-Data/master/conflict_data_irq.csv" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到我在<a class="ae mu" href="https://colab.research.google.com/drive/1rrkJ-pcddna7Ft8Zv-xYgPIVMduJi49u?usp=sharing" rel="noopener ugc nofollow" target="_blank">本笔记本</a>中使用的具体数据。然而，我强烈建议你在这个练习中尝试使用你自己的时间序列数据！</p><p id="a6a1" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">在这个代码块中，我们将使用<strong class="md iu"> value_counts() </strong>方法来获取我们的折线图所需的数据。我们希望可视化每天的事件数量，因此我们将<strong class="md iu"> value_counts() </strong>应用于我们的日期组。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="d2e6" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">在整篇文章中，您将看到我在处理日期时间数据时喜欢应用的一些实践。首先，每次对数据帧进行操作时，我都会对其进行重新排序——这有助于减少稍后我们训练模型时的错误。我也总是喜欢在我的数据帧中有一列是日期时间格式，另一列是字符串格式。我使用 datetime 列进行分析，string 列用于标签、图例和工具提示。</p><h2 id="ef74" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">提取分类数据</h2><p id="014a" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">接下来，我们想要为每个<strong class="md iu">事件类型</strong>获取<strong class="md iu"> value_counts() </strong>。最终产品将是一个可视化，允许用户在折线图中选择一个时间窗口，然后在第二个合作伙伴可视化中显示相关事件类型。我们将遵循与上面相同的步骤，但是现在针对<strong class="md iu"> event_type </strong>字段中的每个事件类型。我们将使用<strong class="md iu"> groupby() </strong>方法来实现这一点。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="5973" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">打扫</h2><p id="fa06" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">接下来，只需删除重复项并重新排序我们的值。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="fa31" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">为什么是先知？</h1><p id="dc25" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">Prophet 是 facebook 开发的开源 SARIMA 模型。SARIMA 是一种时间序列回归<em class="mv">(解读:预测)</em>技术，它考虑了时间序列数据集的各种统计属性，包括移动平均、季节性和趋势。<strong class="md iu">趋势</strong>是时序数据的一个属性，与数据集中的总体正增长和负增长有关。<strong class="md iu">季节性</strong>与数据集中的周期性变化有关，例如周末活动的定期减少或每天下午活动的增加。</p><p id="83ee" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">Prophet 最初是为了满足脸书的预测需求而开发的，因为 facebook office 严重依赖时间序列预测来设定目标和衡量进展。你可以通过观看由 Prophet 开发者提供的视频来了解更多关于 Prophet 及其起源的信息。</p><p id="5393" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">Prophet 需要两个数据源才能工作:<strong class="md iu">‘ds’</strong>，代表<em class="mv">日期戳</em>，以及<strong class="md iu">‘y’</strong>，<em class="mv">目标变量</em>。如果您正在跟随<a class="ae mu" href="https://colab.research.google.com/drive/1rrkJ-pcddna7Ft8Zv-xYgPIVMduJi49u?usp=sharing" rel="noopener ugc nofollow" target="_blank">这款笔记本</a>，那么我们已经做到了这一点——如果没有，那么为了您自己的数据，请记住这一点。</p><h2 id="06db" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">模型优化</h2><p id="09b0" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">模型优化是任何机器学习项目的关键要素。所有机器学习模型都有一个或两个关键参数，需要进行优化以实现模型的最佳性能。对于 Prophet，该参数为<strong class="md iu">change point _ prior _ scale</strong>。此参数定义了模型响应数据集中的变点的灵活程度，需要进行优化以防止过度拟合和欠拟合。</p><p id="3162" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">为了对此进行优化，我们将使用一个非常简单的优化模型。它简单地遍历用户定义的历元，测试每个参数，并选择返回最低误差的参数。为此，我们将使用<strong class="md iu">均方误差</strong>统计。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="bd6f" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">有关使用均方误差进行模型优化的更多信息，请参见<a class="ae mu" rel="noopener" target="_blank" href="/https-medium-com-chayankathuria-regression-why-mean-square-error-a8cad2a1c96f">本文</a>关于均方误差和线性回归。</p><h2 id="2fb7" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">训练模型</h2><p id="941b" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">既然模型已经优化，我们就用我们的数据来训练它。你会看到，根据我提供的数据，<strong class="md iu"> MSE </strong>(均方差)大约为 38。这可能看起来很高，但对于时间序列预测来说非常好——通常 MSE 低于 50 对这些目的来说是好的。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="a2b1" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">如果想进一步降低错误率，常见的技术是在训练模型之前对数据应用<strong class="md iu">指数平滑</strong>。把它想象成时间序列数据的缩放和标准化——你可以在这里了解更多关于时间序列数据的指数平滑。</p><h2 id="a1ba" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">绘制数据</h2><p id="f8a6" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">我们将使用散景来绘制数据。交互性是使您的数据可视化脱颖而出并为您的客户提供更多用途和洞察力的一种很好的方式。尽管有其他库和方法来创建交互式可视化，但 Bokeh 是我的首选库。然而，这不是一个散景教程。如果不熟悉散景，可以试试他们的<a class="ae mu" href="https://docs.bokeh.org/en/latest/docs/user_guide/quickstart.html" rel="noopener ugc nofollow" target="_blank"> <strong class="md iu">入门指南</strong> </a>。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/cb95d3baa5fcd82923b33ce0709a934b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*MFlXoMHBn_pPp886ylmE6Q.png"/></div></figure><p id="3a16" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">基本上，我们将原始数据绘制为散景图内的线字形，并绘制<strong class="md iu">不确定性界限</strong>，在 Prophet 数据帧中表示为<em class="mv"> yhat_upper </em>和<em class="mv"> yhat_lower </em>作为面积图。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="db4d" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">分析趋势和季节性</h2><p id="f095" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">如上所述，<strong class="md iu">趋势</strong>和<strong class="md iu">季节性</strong>是时间序列数据的两个关键统计属性。理解这些因素对于理解数据本身至关重要。Prophet 用<strong class="md iu"> plot_components </strong>方法使这变得简单。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e8a5" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">在下面的图表中，你可以看到伊拉克冲突事件在过去几年中一直呈总体负面趋势(随着 ISIS 被稳步击败)。然而，你可以看到在整个 2020 年都有小幅上升的趋势——这是由于多种因素，包括冠状病毒疫情和美国从该地区的多个基地撤军，导致 is is 活动增加。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/92ad4a213e6a951c069949a03496dd63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*PSu91ktX-VB8RjS6o3m13Q.png"/></div></figure><p id="45e2" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">就季节性而言，你可以看到一些有趣的模式——周五<strong class="md iu">和穆斯林安息日</strong>的活动通常很少。你可以在 3 月-6 月看到一个活动高峰，这是众所周知的常见的西部沙漠战斗季节，因为温暖的气温使干河谷变干，使地形更容易通过；这也是典型的穆斯林斋月。有趣的是，数据还显示了 10 月至 11 月的高活动量，很可能是由于炎热的夏季过后天气变冷。就近年来而言，这也是一个充满政治冲突和抗议的年度时期。</p><h2 id="aecf" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">绘制异常值</h2><p id="924c" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">接下来，我们将识别时间序列数据中的异常值。这些事件超出了由 Prophet 模型确定的趋势和季节性。这对国家安全和国防数据至关重要。例如，在伊拉克，我们知道恐怖活动有季节性的上升和下降。那些季节性上涨来的时候，怎么知道是不是比平时差？异常值检测有助于识别恐怖活动的可能死灰复燃，让我们有更好的准备。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6f34" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">我们将使用一种简单的方法——我们寻找超出 Prophet 预测的不确定性上限的数据点，然后绘制该点。在最终的图中，我们可以看到，几乎整个 2016 年都充满了高于预期的恐怖活动，2019 年底和 2020 年初也是如此-这是由于伊拉克总理阿卜杜勒-迈赫迪向新总理卡迪米移交权力后的政治不稳定，2019 年 10 月开始的重大抗议和骚乱活动，以及上述因素，如美国撤军和冠状病毒疫情。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nt"><img src="../Images/ae1667f23a01f1b06a7d533e579c54eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*cppktkItsbyTPvbMa7lXKg.gif"/></div></div></figure><h2 id="1052" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">绘制分类数据</h2><p id="7308" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">我想更彻底地调查异常活动。我想知道，在活动增加的时候，哪些类型的事件构成了这些数据——简易爆炸装置、常规战争等等。为此，我们将绘制第二个图来可视化数据。</p><p id="3de6" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">散景自动链接共享<strong class="md iu">列数据源</strong>的图之间的选择。因为两个图的数据来自相同的数据框，一个图中的选择将自动反映在第二个图中。我们需要做的只是在视觉上对元素进行样式化，以吸引人们对所选元素的注意，并明确不同时期流行的类别。</p><p id="0a26" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">在这个数据的例子中，我们将使用散景中的<strong class="md iu"> selection_glyph </strong>和<strong class="md iu"> nonselection_glyph </strong>属性，使数据在未被选中时不可见。这将使我们能够很容易地看到我们在原始图中选择的时间窗口的主要数据类型。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="np nq l"/></div><p class="nu nv gj gh gi nw nx bd b be z dk translated">该代码片段仅显示了一个层的绘图。完整代码见笔记本。</p></figure><p id="302d" class="pw-post-body-paragraph mb mc it md b me my ju mg mh mz jx mj lr nm ml mm lu nn mo mp lx no mr ms mt im bi translated">主绘图使用一个<strong class="md iu"> box_select </strong>工具来动态改变可视化。将鼠标光标放在图中并拖动以选择时间窗口，观察可视化显示的变化！</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/e9be2a2eccf9298c4df914b383979e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*hiD7-mAofhi1GiQrxbpF3g.gif"/></div></div></figure><h2 id="5228" class="lm kj it bd kk ln lo dn ko lp lq dp ks lr ls lt ku lu lv lw kw lx ly lz ky ma bi translated">摘要</h2><p id="1067" class="pw-post-body-paragraph mb mc it md b me mf ju mg mh mi jx mj lr mk ml mm lu mn mo mp lx mq mr ms mt im bi translated">现在，您可以通过 Prophet 机器学习模型使用 SARIMA 预测技术来分析时间序列数据。您可以自动优化您的模型，并使用它来了解数据中的趋势和季节性属性。您可以在交互式图表中绘制该信息，以便以后在仪表板或 web 应用程序中发布。<strong class="md iu">伟大的作品！</strong></p></div></div>    
</body>
</html>