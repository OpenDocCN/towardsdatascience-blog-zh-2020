<html>
<head>
<title>Using TensorBoard in an Amazon SageMaker PyTorch Training job: a Step-by-Step Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在亚马逊SageMaker PyTorch培训工作中使用TensorBoard:一步一步的教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-tensorboard-in-an-amazon-sagemaker-pytorch-training-job-a-step-by-step-tutorial-19b2b9eb4d1c?source=collection_archive---------37-----------------------#2020-05-22">https://towardsdatascience.com/using-tensorboard-in-an-amazon-sagemaker-pytorch-training-job-a-step-by-step-tutorial-19b2b9eb4d1c?source=collection_archive---------37-----------------------#2020-05-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1324" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">理解Amazon SageMaker培训工作的数据流，并通过示例学习如何在SageMaker Pytorch培训工作上设置TensorBoard</h2></div><h1 id="8f6f" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="d03f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在这篇文章中，我们在这个博客中向你展示如何在亚马逊SageMaker PyTorch培训工作中使用TensorBoard。这些步骤是:</p><ol class=""><li id="fc11" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">在SageMaker培训作业运行时安装TensorBoard，此处为<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/using_pytorch.html#using-third-party-libraries" rel="noopener ugc nofollow" target="_blank"/></li><li id="fe1e" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">将PyTorch SageMaker估计器初始化时的<em class="mk">tensor board _ output _ config</em>参数配置为<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_debugger.html#capture-real-time-tensorboard-data-from-the-debugging-hook" rel="noopener ugc nofollow" target="_blank">这里</a></li><li id="8d3d" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">在PyTorch培训脚本中，记录您想要监控和可视化的数据，如这里的<a class="ae me" href="https://pytorch.org/docs/stable/tensorboard.html" rel="noopener ugc nofollow" target="_blank">所示</a></li><li id="a165" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">启动tensorbard并将日志目录指向步骤2中配置的s3位置</li></ol><h1 id="2330" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">写这篇博客的原因</strong></h1><p id="ac34" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在我最近的一个项目中，我需要使用TensorBoard来可视化来自亚马逊SageMaker PyTorch培训工作的指标。在网上搜索并查看了AWS官方文档、SageMaker SDK示例和AWS博客后，我意识到没有针对该主题的现有分步教程。所以，我写这篇文章，希望给你一个现成的解决方案。这篇文章也可以在我的<a class="ae me" href="https://www.sun-analytics.nl/posts/2020-05-23-using-tensorboard-in-an-amazon-sagemaker-pytorch-training-job-a-step-by-step-tutorial/" rel="noopener ugc nofollow" target="_blank">博客</a>里找到。</p><h1 id="e2e2" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">SageMaker培训作业如何在S3和培训实例之间交换数据</strong></h1><p id="f83a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">首先，让我们在执行PyTorch SageMaker培训工作时有一个总体的了解。SageMaker简化了以下流程:</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/754bef2a6057c9b8181a134dc0548977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5giiGwdN1RTKk7Ov4kNTGA.png"/></div></div><p class="mx my gj gh gi mz na bd b be z dk translated">SageMaker培训工作</p></figure><ol class=""><li id="d09c" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">启动并准备请求的ML实例</li><li id="6320" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">从S3下载输入数据</li><li id="27b6" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">从ECR中提取训练图像</li><li id="cc38" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">执行训练文件(上图中的train.py)作为训练的入口点</li><li id="52c1" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ma mb mc md bi translated">把训练模型神器推回S3</li></ol><p id="8c27" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">让我们通过下面的例子来放大ML实例和S3之间的数据交换。这里我们使用<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> SageMaker Python SDK </a>。</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="24db" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated"><strong class="kz ir">输入数据:</strong></p><ul class=""><li id="3433" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ng mb mc md bi translated">输入数据位置由<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/estimators.html#sagemaker.estimator.EstimatorBase.fit" rel="noopener ugc nofollow" target="_blank">估算器配置。拟合</a>函数<em class="mk">输入</em>参数。在这个例子中，训练数据是具有S3前缀<em class="mk">S3://input-data-bucket/train</em>的所有对象，验证数据也是如此。</li><li id="cc72" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">数据下载到ML实例中，位于<em class="mk">/opt/ML/input/data/</em><strong class="kz ir"><em class="mk">train</em></strong><em class="mk">和/opt/ML/input/data/</em><strong class="kz ir"><em class="mk">val</em></strong><em class="mk"/>文件夹中。“<em class="mk"> train </em>”和“<em class="mk"> val </em>”通道通过<em class="mk"> estimator.fit.inputs </em>参数字典中的键进行配置。</li></ul><p id="1995" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated"><strong class="kz ir">输出模型神器</strong></p><ul class=""><li id="b17d" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ng mb mc md bi translated">您的训练脚本应该将您所有的最终模型工件写到目录<em class="mk"> /opt/ml/model </em>中。</li><li id="4bde" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">SageMaker将<em class="mk"> /opt/ml/model </em>下的数据作为单个对象以压缩tar.gz格式复制到您在估计器对象<strong class="kz ir"> <em class="mk"> output_path </em> </strong>参数中指定的S3位置。在我们的示例中，在训练作业成功之后，模型工件被定位为<em class="mk">S3://output-data-bucket/model/model . tar . gz</em>。</li></ul><h1 id="6dd1" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">在SageMaker PyTorch培训工作中逐步使用tensor board</strong></h1><h2 id="3104" class="nh kg iq bd kh ni nj dn kl nk nl dp kp lg nm nn kr lk no np kt lo nq nr kv ns bi translated"><strong class="ak">同步张量板日志</strong></h2><p id="1c25" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">SageMaker调试器是去年年底<a class="ae me" href="https://aws.amazon.com/about-aws/whats-new/2019/12/introducing-amazon-sagemaker-debugger-get-complete-insights-into-the-training-process-of-machine-learning-models/" rel="noopener ugc nofollow" target="_blank">的一个特性。它提供了一种</a><a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_debugger.html#capture-real-time-tensorboard-data-from-the-debugging-hook" rel="noopener ugc nofollow" target="_blank">非常简单的方式</a>从SageMaker培训工作中发出TensorBoard数据。要使调试钩子发出张量板数据，需要如下指定新选项<code class="fe nt nu nv nw b">TensorBoardOutputConfig</code>:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="60f2" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">在训练作业期间，调试挂钩将生成的张量板数据近乎实时地上传到从配置中提供的<code class="fe nt nu nv nw b">s3_output_path</code>的值导出的S3路径。</p><p id="bd58" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg nb li lj lk nc lm ln lo nd lq lr ls ij bi translated">在你的训练脚本中，你应该把你的TensorBoard日志写到ML实例中由<code class="fe nt nu nv nw b">s3_output_path</code>指示的本地文件夹中。如果跳过设置，默认目录是<em class="mk">/opt/ml/output/tensor board/</em>。以下是一些示例代码:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="0cdb" class="nh kg iq bd kh ni nj dn kl nk nl dp kp lg nm nn kr lk no np kt lo nq nr kv ns bi translated">在SageMaker PyTorch容器中安装TensorBoard</h2><p id="0a83" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">默认情况下，SageMaker PyTorch容器中不包含TensorBoard包，SageMaker Python SDK中的PyTorch estimator使用该包。你得先装TensorBoard。最简单的方法是使用在<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/using_pytorch.html#using-third-party-libraries" rel="noopener ugc nofollow" target="_blank"> SDK文档</a>中描述的requirements.txt文件:</p><blockquote class="nx ny nz"><p id="027a" class="kx ky mk kz b la lv jr lc ld lw ju lf oa nb li lj ob nc lm ln oc nd lq lr ls ij bi translated">如果您想在您的脚本中使用其他包，您可以在与您的训练脚本相同的目录中包含一个<code class="fe nt nu nv nw b">requirements.txt</code>文件，以便在运行时安装其他依赖项。<code class="fe nt nu nv nw b">requirements.txt</code>和你的训练脚本应该放在同一个文件夹里。创建PyTorch估计器时，必须在<code class="fe nt nu nv nw b">source_dir</code>参数中指定该文件夹。</p></blockquote><h2 id="54a0" class="nh kg iq bd kh ni nj dn kl nk nl dp kp lg nm nn kr lk no np kt lo nq nr kv ns bi translated">启动TensorBoard服务器</h2><p id="aa6d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在，我们可以通过命令<code class="fe nt nu nv nw b"><em class="mk">F_CPP_MIN_LOG_LEVEL=3 AWS_REGION=YOUR-AWS-REGION tensorboard --logdir s3://tensorboard-output-location</em></code>启动TensorBoard服务器</p><ul class=""><li id="7191" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ng mb mc md bi translated">TensorBoard支持直接从S3加载日志文件。我们将日志目录指定为在<code class="fe nt nu nv nw b">TensorBoardOutputConfig</code>中配置的目录。</li><li id="651d" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">您需要正确设置AWS环境变量，例如<code class="fe nt nu nv nw b">AWS_ACCESS_KEY_ID and AWS_ACCESS_KEY_ID.</code></li><li id="80ac" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated"><em class="mk"> F_CPP_MIN_LOG_LEVEL </em>可以抑制详细日志</li><li id="7d96" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">如果您在SageMaker笔记本实例中运行TensorBoard服务器，您可以通过预先设计的笔记本实例url访问TensorBoard页面，例如<a class="ae me" href="https://YOUR-NOTEBOK-INSTANCE-NAME.notebook.YOUR-REGION.sagemaker.aws/proxy/6006/." rel="noopener ugc nofollow" target="_blank"><strong class="kz ir"><em class="mk">https://YOUR-NOTEBOK-INSTANCE-name . notebook . YOUR-region . SageMaker . AWS/proxy/6006/</em></strong><em class="mk">。</em> </a> <em class="mk"> </em>注意最后一个反斜杠是madantory，否则看不到TensorBoard页面。</li></ul><h1 id="e0ae" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">参考</strong></h1><ul class=""><li id="0bcb" class="lt lu iq kz b la lb ld le lg od lk oe lo of ls ng mb mc md bi translated">SageMaker容器提供的环境变量列表:<a class="ae me" href="https://github.com/aws/sagemaker-containers#list-of-provided-environment-variables-by-sagemaker-containers" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS/SageMaker-Containers # list-of-provided-environment-variables-by-SageMaker-Containers</a></li><li id="a365" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">SageMaker培训工作如何运作<a class="ae me" href="https://docs.aws.amazon.com/sagemaker/latest/dg/how-it-works-training.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/sage maker/latest/DG/how-it-works-training . html</a></li><li id="6fea" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">SageMaker调试器<a class="ae me" href="https://docs.aws.amazon.com/sagemaker/latest/dg/train-debugger.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/SageMaker/latest/DG/train-debugger . html</a></li><li id="15a4" class="lt lu iq kz b la mf ld mg lg mh lk mi lo mj ls ng mb mc md bi translated">Estimator:通过SageMaker Python SDK<a class="ae me" href="https://sagemaker.readthedocs.io/en/stable/estimators.html" rel="noopener ugc nofollow" target="_blank">https://sagemaker.readthedocs.io/en/stable/estimators.html</a>为SageMaker培训提供的高级接口</li></ul></div></div>    
</body>
</html>