<html>
<head>
<title>A Production Machine Learning Pipeline for Text Classification with fastText</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于fastText的文本分类生产机器学习流水线</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-production-machine-learning-pipeline-for-text-classification-with-fasttext-7e2d3132c781?source=collection_archive---------35-----------------------#2020-02-04">https://towardsdatascience.com/a-production-machine-learning-pipeline-for-text-classification-with-fasttext-7e2d3132c781?source=collection_archive---------35-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3350" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在多个步骤中组织您的ML代码，并使用Valohai创建受版本控制的ML管道。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/888e59179c69032f199ada8d007c41a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2RnwIcwwmL60V0cDfd8Cw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带有执行和工件的数据谱系图。</p></figure><p id="2e3a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在生产中做机器学习的时候，<strong class="la iu">模型的选择只是众多重要标准中的一个</strong>。同样重要的是正确定义问题，收集高质量的数据并构建机器学习管道。</p><p id="620e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文着重于为一个流行的问题构建一个机器学习管道:文本分类。管道获取带标签的数据，对其进行预处理，自动调优fastText模型，在所有数据中重新训练模型，并输出度量和预测以进行迭代。</p><p id="44ef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我使用<a class="ae lu" href="https://valohai.com" rel="noopener ugc nofollow" target="_blank"> Valohai </a>创建一个ML管道，并对每一步进行版本控制。最后，只需点击几下鼠标，您就可以在云上运行管道，并探索每个中间结果。</p><h1 id="2aff" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">构建生产就绪基线</h1><p id="fde2" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">在Kaggle竞赛中，你在一个确定的问题和一个冻结的数据集上工作。你对排行榜上的好成绩有所了解。</p><p id="031f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在现实世界的应用中，<strong class="la iu">数据集不断发展，模型会定期重新训练</strong>。例如，在文本分类中，添加新的标签数据和更新标签空间是很常见的。</p><p id="9f36" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了构建ML管道，我使用了来自BBC新闻的2225份文件的数据集，分为五个主题:商业、娱乐、政治、体育和科技。数据集为每个文档分配一个标签，这就是所谓的多类问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/af864023ada0b498f88710ab32562a73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/0*YU8zlzp4Ssm_CdS0.png"/></div></figure><p id="7b42" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以在任何包含两列的CSV文件上运行管道:文本和标签。如果您想为多标签问题训练它，您可以添加具有相同文本和不同标签的额外行。</p><h1 id="b80c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用快速文本进行文本分类</h1><p id="5500" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">脸书在2016年宣布fastText是一个高效的文本分类和表示学习库。<a class="ae lu" href="https://arxiv.org/abs/1607.01759" rel="noopener ugc nofollow" target="_blank">官方快速文本文件</a>中报告的一些优势:</p><ul class=""><li id="806d" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt my mz na nb bi translated">在标准多核CPU上几分钟内训练10亿个单词。</li><li id="51fe" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">在不到一分钟的时间内对312K个类别中的50万个句子进行分类。</li><li id="70f3" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">创建对拼写错误具有鲁棒性的子词向量。</li><li id="d589" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">包括易于使用的CLI和Python绑定。</li></ul><p id="5463" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2019年，脸书为fastText 添加了<a class="ae lu" href="https://fasttext.cc/docs/en/autotune.html" rel="noopener ugc nofollow" target="_blank">自动超参数调谐，我将它作为管道中的一个步骤。</a></p><h1 id="ba33" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">集成fastText和Valohai</h1><p id="5284" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我用<a class="ae lu" href="https://click.palletsprojects.com/" rel="noopener ugc nofollow" target="_blank"> Click </a>为每个ML步骤创建一个命令，这是一个Python库，它修饰函数，将它们转换成命令。<strong class="la iu">每个命令接受数据和参数，并生成数据和指标</strong>。</p><p id="a231" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，autotune命令在训练分割上训练几个模型，以找到验证分割上的最佳参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae lu" href="https://github.com/arimbr/valohai-fasttext-example/blob/master/models/classification/commands.py" rel="noopener ugc nofollow" target="_blank">检查Github中所有commands.py代码。</a></p></figure><p id="7d0f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nj"> get_input_path </em>和<em class="nj"> get_output_path </em>函数在本地和Valohai云环境上返回不同的路径。<em class="nj"> train_supervised </em>方法接受参数来限制训练的持续时间和模型的大小。保存最佳参数，以便以后根据所有数据重新训练模型。</p><p id="df0a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了在云中运行autotune命令，我将它添加到<a class="ae lu" href="https://docs.valohai.com/valohai-yaml/index.html" rel="noopener ugc nofollow" target="_blank"> valohai.yaml. </a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae lu" href="https://github.com/arimbr/valohai-fasttext-example/blob/master/models/classification/commands.py" rel="noopener ugc nofollow" target="_blank">检查Github </a>中的所有valohai.yaml代码。</p></figure><h1 id="36d2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建机器学习管道</h1><p id="6046" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated"><a class="ae lu" href="https://docs.valohai.com/core-concepts/pipelines/" rel="noopener ugc nofollow" target="_blank"> Valohai管道</a>是一个版本控制的步骤集合，在图中表示为节点。每个数据依赖导致步骤之间的边缘。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/c3c7fb7d09f5cd567a73775b57496f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tngfQ7P45a8ADjZa.png"/></div></div></figure><p id="7bf1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">文本分类管道有5个步骤:</p><ol class=""><li id="5e19" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt nl mz na nb bi translated"><strong class="la iu">预处理</strong>:对fastText使用的原始数据进行预处理。</li><li id="b2f4" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated"><strong class="la iu">拆分</strong>:将预处理后的数据拆分成训练、验证和测试数据。</li><li id="dc5a" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated"><strong class="la iu">自动调优</strong>:在验证数据上找到最佳参数。</li><li id="e69a" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated"><strong class="la iu">训练</strong>:用所有数据上的最佳参数训练最终模型。</li><li id="d904" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated"><strong class="la iu">测试</strong>:获取测试数据的度量和预测。</li></ol><p id="97a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与执行类似，管道在valohai.yaml文件中由两部分声明:节点和边缘。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae lu" href="https://github.com/arimbr/valohai-fasttext-example/blob/master/models/classification/commands.py" rel="noopener ugc nofollow" target="_blank">检查Github </a>中所有的valohai.yaml代码。</p></figure><p id="5659" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦声明了管道，就可以运行它，并通过单击它来检查每个管道节点。下面您可以看到自动调优节点的详细信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/cf86f56afebb4dfbd5dd0d38fb2682c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7hYeRwyHH6v9xInz.png"/></div></div></figure><p id="a79c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Valohai管道是声明性的，很容易与您的代码集成。对于动态管道，可以<a class="ae lu" href="https://blog.valohai.com/scaling-airflow-machine-learning" rel="noopener ugc nofollow" target="_blank">将Valohai与气流</a>整合。</p><h1 id="ba6e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">自动跟踪数据沿袭</h1><p id="0653" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">数据沿袭图显示了执行和工件之间的数据依赖关系。在Valohai中，您可以跟踪每个依赖项，以便更快地调试管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1bc5969f2efaf1be9f9acbaf9128fbb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ejiJD4Tfq-vQnn5W.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Valohai生成的数据谱系图。</p></figure><h1 id="4c45" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">迭代问题、数据和模型</h1><p id="a590" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">自动调优步骤是获得良好结果的关键。F1分数从默认参数的0.3变为测试数据集的<strong class="la iu">最终F1分数0.982。中间结果由fastText autotune命令记录，可以在日志中读取。最终得分记录在JSON中，并由Valohai存储为执行指标。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/78358778ecc82d303bf965d4d5fdeb7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ttBb7fWKt1cuNlUJ.jpg"/></div></div></figure><p id="42f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是只看一个指标不足以知道你的模型是否工作良好。最有趣的信息在test_predictions.csv文件中。它包含模型在222条记录的测试数据集上产生的4个错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/288d76c2187b0e4c13d5284001137914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VXNaGNqMgXa23TRz.png"/></div></div></figure><h2 id="33f2" class="no lw it bd lx np nq dn mb nr ns dp mf lh nt nu mh ll nv nw mj lp nx ny ml nz bi translated">反复讨论这个问题</h2><p id="1018" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">第四个错误将0.59的概率分配给商业标签，而不是0.39的政治标签。探究全文可以发现，文章谈到了这两个话题。该观察可能导致<strong class="la iu">对问题进行迭代，以变成多标签</strong>，并分配高于概率阈值的所有标签。</p><h2 id="8e27" class="no lw it bd lx np nq dn mb nr ns dp mf lh nt nu mh ll nv nw mj lp nx ny ml nz bi translated">对数据进行迭代</h2><p id="7bad" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">总的来说，标记的数据是高质量的。我们可以认为一些p@1较高的误差是对标记数据的修正。在另一个具有由不同过程产生的标记数据的数据集中，<strong class="la iu">模型预测可用于校正标记数据</strong>。</p><h2 id="88e4" class="no lw it bd lx np nq dn mb nr ns dp mf lh nt nu mh ll nv nw mj lp nx ny ml nz bi translated">在模型上迭代</h2><p id="6604" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">如果最终指标对您的业务案例不满意，<strong class="la iu">可以添加新功能，并培训不同的模型</strong>。但是我认为最好从正确的问题定义和数据开始。这些是你的ML管道的成分。</p><h1 id="5be8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用Valohai在您自己的数据集上尝试fastText</h1><p id="2709" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">自己在云端运行管道很容易。下面的按钮将邀请您注册/登录到您的Valohai帐户，并创建一个项目来尝试这个管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://app.valohai.com/projects/create/?template=fasttext-example"><div class="gh gi oa"><img src="../Images/645fd81e9c1b2b1b0281471002c2b9ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:276/format:webp/1*aBdtzKMoDFnb95Hw5E-DjA.png"/></div></a></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/b65d27dc6a0ee091951a7be57804d87c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*in2BJqXsBeNT51He.gif"/></div></div></figure><p id="c3c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建项目后，请按照以下步骤操作:</p><ol class=""><li id="4b1e" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt nl mz na nb bi translated">在设置选项卡&gt;常规选项卡中，将默认环境设置为<strong class="la iu">微软Azure F16s v2(无GPU) </strong>。</li><li id="bba0" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated">在Pipeline选项卡中，使用蓝图<strong class="la iu"> fasttext-train </strong> <em class="nj">创建一个管道。</em></li><li id="48d5" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated">点击<strong class="la iu">创建管道</strong>运行管道。</li></ol><p id="7496" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当管道运行时，您可以单击图中的每个节点，并查看日志和输出。管道完成后，您可以单击一个节点，并通过单击Trace按钮获得数据谱系图。</p><p id="ae02" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">恭喜你，你已经运行了你的第一个ML管道！现在你可以用你自己的数据来尝试一下，为你的文本分类问题获得一个基线:</p><ol class=""><li id="3abc" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt nl mz na nb bi translated">在数据选项卡&gt;上传选项卡中，上传数据集。数据集应该是一个包含两列的CSV文件:文本和标签。</li><li id="4bb3" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt nl mz na nb bi translated">在运行管道之前，单击预处理节点。在输入部分，用步骤1中上传的数据替换默认输入数据。</li></ol><h1 id="8167" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论和下一步措施</h1><p id="ce5f" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">在多个步骤中组织你的ML代码是创建受版本控制且易于调试的<strong class="la iu">生产机器学习管道的关键。CLI是ML代码工业化的一个流行选择。</strong></p><p id="6407" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于文本分类等常见问题，fastText是一个强大的基线构建库。有了<a class="ae lu" href="https://valohai.com" rel="noopener ugc nofollow" target="_blank"> Valohai </a>你就有了一个版本控制的机器学习管道，你可以在你的数据上运行。在另一篇文章中，我重用了管道来<a class="ae lu" rel="noopener" target="_blank" href="/classifying-4m-reddit-posts-in-4k-subreddits-an-end-to-end-machine-learning-pipeline-ee511d26b362?source=friends_link&amp;sk=e5e631fed93a2e99ce6746ebd6b36583">将400万个Reddit帖子分类到4k个子编辑中</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://app.valohai.com/projects/create/?template=fasttext-example"><div class="gh gi oa"><img src="../Images/645fd81e9c1b2b1b0281471002c2b9ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:276/format:webp/1*aBdtzKMoDFnb95Hw5E-DjA.png"/></div></a></figure><h1 id="e89d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">有用的资源</h1><ul class=""><li id="1eb5" class="mt mu it la b lb mn le mo lh oc ll od lp oe lt my mz na nb bi translated"><a class="ae lu" href="https://github.com/arimbr/valohai-fasttext-example" rel="noopener ugc nofollow" target="_blank">Github上的代码库</a></li><li id="5ad9" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated"><a class="ae lu" href="https://fasttext.cc/docs/en/support.html" rel="noopener ugc nofollow" target="_blank">快速文本文档</a></li><li id="dd29" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated"><a class="ae lu" href="https://docs.valohai.com/core-concepts/pipelines/" rel="noopener ugc nofollow" target="_blank">瓦罗海文档</a></li></ul></div></div>    
</body>
</html>