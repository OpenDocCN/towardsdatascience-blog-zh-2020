<html>
<head>
<title>Using AWS SQS For Scheduled Message In Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Python 中为预定消息使用 AWS SQS</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-aws-sqs-for-scheduled-message-in-python-3c9910621a4e?source=collection_archive---------31-----------------------#2020-04-10">https://towardsdatascience.com/using-aws-sqs-for-scheduled-message-in-python-3c9910621a4e?source=collection_archive---------31-----------------------#2020-04-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="7760" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">新闻捕手</h2><div class=""/><div class=""><h2 id="915c" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何开始使用 Lambda、S3 和 SQS 等 AWS 服务来创建新产品</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/acbd5c40dabd30c532b4587e2916a4b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PFw1cNKw01wPH3Ex"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Melanie Pongratz 在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="26f9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于<a class="ae lh" href="https://www.safegraph.com/blog/data-as-a-service-bible-everything-you-wanted-to-know-about-running-daas-companies?source=search_post---------0" rel="noopener ugc nofollow" target="_blank">数据即服务</a>产品来说，有时候，架构比想法本身更重要。这正是我们和朋友一起开发的产品的情况。Newscatcher 是一个 API，用于搜索在线发布的新闻文章。换句话说，我们从全球最受欢迎的新闻来源收集所有文章，将它们放在一个地方，并提供基于日期、来源和全文进行搜索的可能性。</p><p id="7b69" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">到目前为止，我们已经发布了一个封闭的测试版。本质上，我们是开发者至上的团队，这就是为什么我们决定分享我们所经历的一切。Newcatcher API 的另一位创始人发表了一篇关于整个数据架构的文章。</p><div class="me mf gp gr mg mh"><a rel="noopener follow" target="_blank" href="/launching-beta-data-product-within-two-month-with-aws-6ac6b55a9b5d"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">我们如何利用 AWS 在 60 天内推出数据产品</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">两个人的团队在不到两个月的时间里为 200 名用户计划并发布了一个测试版，并且没有放弃他们的全职工作。</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">towardsdatascience.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv lb mh"/></div></div></a></div><p id="24a3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我的目标是深入挖掘细节，谈谈产品的功能部分。解释数据管道，给出一些提示并揭示要避免的陷阱。我会努力让这篇文章既有趣又有用。如果您想知道如何构建相同的架构，也许您可以将它作为指南。</p><p id="ca40" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以开始了吗？</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="5a5f" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">挑战</h1><p id="268e" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">让我们回到这个想法。我们希望构建一个包含最新新闻文章的 API。基点是每个在线新闻来源的<a class="ae lh" rel="noopener" target="_blank" href="/collecting-news-articles-through-rss-atom-feeds-using-python-7d9a65b06f70"> RSS 提要</a>。<strong class="lk jd"> RSS 提要</strong>是简单的文本文件，包含文章的基本更新信息。几乎每个新闻来源都有一个储存标题、摘要、出版日期等信息的地方。我们的目标是创建一个数据管道，每小时从多个 RSS 提要获取信息。为了实现这个想法，我们面临一些简单的问题:</p><ul class=""><li id="0023" class="oa ob it lk b ll lm lo lp lr oc lv od lz oe md of og oh oi bi translated">我们从哪里获得全世界成千上万新闻源的 RSS 提要？</li><li id="15e4" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">如何每小时获取新文章？</li><li id="93f6" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">我们把它存放在哪里，SQL 还是 NoSQL 数据库？</li><li id="7f8e" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">最快的查询方式是什么？</li><li id="2898" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">如何做一个 API？(是的，我们以前从未构建过 API)</li></ul><p id="f44d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了回答第一个问题，我们使用了维基百科、<a class="ae lh" href="https://www.alexa.com/about" rel="noopener ugc nofollow" target="_blank"> Alexa </a>和其他来源来搜集新闻来源网站和他们的 RSS 订阅。经过几个小时的手工清理，我们或多或少地获得了一些参考数据。csv 文件。一切都以. csv 开头。</p><p id="6dfa" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下一步是每天多次使用 RSS 提要检索新文章。在这一点上，我们想出了使用<strong class="lk jd"> SQS </strong>队列来逐步发送参考数据和获取文章更新的想法。它有两个主要优势:</p><ul class=""><li id="9b6c" class="oa ob it lk b ll lm lo lp lr oc lv od lz oe md of og oh oi bi translated">容错。数据不是一个长时间的连续循环，而是通过成束的消息发送。一群人的错误不会影响其他人。日志中的错误很容易识别。</li><li id="e848" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">管理负载。易于管理其他服务的负载，如 DynamoDB 和 Elasticsearch。</li></ul><p id="63fb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">SQS 队列和<strong class="lk jd"> AWS Lambda </strong>串联<strong class="lk jd"> </strong>完全符合我们的需求。多个 Lambda 函数可以同时启动。这意味着 lambda 可以接收每一串消息。公平地说，SQS 和 Lambda 函数的优势在数据管道中更加明显，我们接收 SQS 队列并将它们放入 DynamoDB 表中。在本文后面我们讨论 Lambda 函数的地方，只有一个用于发送 SQS 队列的函数。</p><p id="1028" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在让我们转到更技术性的部分。文章的下半部分包含了一个实际实现的生动例子。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/9a270cdbb28f2b81f4ab0a2dfa51ffba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*vGBr0dQstpJUJsk5KqmODw.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">数据管道</p></figure><h2 id="e53b" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">开始前的准备工作</h2><p id="a518" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">在开始处理数据管道之前，需要完成一些步骤:</p><ul class=""><li id="0d05" class="oa ob it lk b ll lm lo lp lr oc lv od lz oe md of og oh oi bi translated">拥有<a class="ae lh" href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc" rel="noopener ugc nofollow" target="_blank">一个 AWS 自由层账户</a></li><li id="a623" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">选择一个地区，对于您使用的其他服务，请选择该地区</li><li id="ef84" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">使用 Linux 机器或创建一个<a class="ae lh" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" rel="noopener ugc nofollow" target="_blank"> EC2 实例</a>,该实例有权访问其他 AWS 服务</li><li id="1968" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">在您的 AWS 帐户上创建一个访问密钥</li><li id="0f41" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">为此项目专门创建一个虚拟 Python 环境</li><li id="c8ee" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">安装 AWS CLI 并<a class="ae lh" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">将</a>配置为您之前创建的访问密钥</li><li id="701a" class="oa ob it lk b ll oj lo ok lr ol lv om lz on md of og oh oi bi translated">为 Python 安装<code class="fe pa pb pc pd b">boto3</code>包</li></ul><h1 id="bcb8" class="nd ne it bd nf ng pe ni nj nk pf nm nn ki pg kj np kl ph km nr ko pi kp nt nu bi translated">1.在亚马逊 S3 上提供数据</h1><p id="9935" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">让我们从简单的事情开始。在 AWS 上打开 S3 服务，创建一个存储桶并上传您的。csv 文件在那里。恭喜你，三分之一完成了。</p><h1 id="61c0" class="nd ne it bd nf ng pe ni nj nk pf nm nn ki pg kj np kl ph km nr ko pi kp nt nu bi translated">2.从传输数据。csv 文件到 NoSQL 表</h1><p id="6918" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">如果您已经完成了前面提到的所有预安装要求，那么在访问不同的服务方面就不会有任何问题。</p><h2 id="a261" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">来自<code class="fe pa pb pc pd b">boto3</code>的资源和客户端</h2><p id="39a6" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">从现在开始，请记住，每次您想要使用 AWS 服务时，您都必须导入<code class="fe pa pb pc pd b">boto3</code>并建立适当的连接，无论是<em class="pj">资源</em>还是<em class="pj">客户端</em>。</p><p id="8cce" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我不知道何时使用它们中的每一个，试着阅读官方的<a class="ae lh" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/index.html#general-feature-guide" rel="noopener ugc nofollow" target="_blank">文档</a>或来自<a class="ae lh" href="https://stackoverflow.com/questions/42809096/difference-in-boto3-between-resource-client-and-session" rel="noopener ugc nofollow" target="_blank"> Stackoverflow </a>的简短解释。对于您的项目，我们总是连接到<strong class="lk jd"> DynamoDB </strong>作为<em class="pj">资源</em>，连接到<strong class="lk jd"> S3 </strong>作为<em class="pj">客户端</em>，连接到<strong class="lk jd"> SQS </strong>作为<em class="pj">客户端</em>发送消息，并作为<em class="pj">资源</em>接收消息。</p><h2 id="05ff" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">DynamoDB 中的表</h2><p id="9fa9" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">还有一件事，你需要在 DynamoDB 中创建一个表。这并不困难:你进入 DynamoDB 服务，点击“创建表”。配置它的惟一方法是默认选择一个主分区键——这个变量对于每个观察都有一个惟一的值。如果您没有该变量，您可以创建两个变量 MD5 散列，这将为您提供一个唯一的 ID。例如:</p><p id="085f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">将数据从 S3 发送到 DynamoDB 是一次性操作，如果您的数据没有被更改，则无需重复。该操作的代码片段从建立到所需服务的连接开始。</p><p id="5b7e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">向 DynamoDB 发送数据的一种可能方式是通过<strong class="lk jd">一个字典列表</strong>，其中每个字典都代表来自您的。csv 文件。所以你需要一个函数来完成这项工作。每个变量将作为一个<strong class="lk jd">字符串</strong>发送。郑重声明你的。csv 文件的名称必须与您选择作为 DynamoDB 表主键的名称相同。</p><p id="5ef8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后一部分是使用您之前打开的连接发送自身的过程。</p><p id="f827" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你在<code class="fe pa pb pc pd b">if __name__ == '__main__':</code>下插入主代码，就可以把功能放在外面导入了。然后发射。虚拟环境中的 py。检查 DynamoDB 服务中表格上的“项目”选项卡。</p><h1 id="ecae" class="nd ne it bd nf ng pe ni nj nk pf nm nn ki pg kj np kl ph km nr ko pi kp nt nu bi translated">3.向 SQS 发送参考数据</h1><p id="9c58" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">使用 AWS Lambda，我们将获取不可变的引用数据，并通过 SQS 将其发送给另一个 Lambda 使用。为了执行这个操作，我们需要创建一个 SQS 队列，以及具有所有权限的 Lambda 函数。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pk"><img src="../Images/df51666f37de129a5d66a1c40d0798c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZTxwxuiK-XdvMEPKtCxsg.png"/></div></div></figure><h2 id="9051" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">SQS 队列</h2><p id="4bee" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">这里没什么难的。您使用 SQS 服务并创建一个新队列。在<strong class="lk jd">标准</strong>和<strong class="lk jd">先进先出</strong>队列之间有一个选择。主要区别在于顺序:使用<strong class="lk jd"> FIFO </strong>保存发送消息的顺序，而对于<strong class="lk jd">标准</strong>，不考虑发送消息的顺序。我们选择了<strong class="lk jd">标准的</strong>一个，我们真的不在乎顺序。</p><p id="79f8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您还可以配置您的队列。该配置对您的主题和信息类型保持唯一性。在您的例子中，每条消息包含 6 个字符串变量。这里附上我们 SQS 队列的配置。</p><h2 id="c0bf" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">策略和角色</h2><p id="0059" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">对于 Lambda 函数，最棘手的部分之一是<a class="ae lh" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" rel="noopener ugc nofollow" target="_blank"> IAM 角色和策略</a>。简而言之，一个<strong class="lk jd">角色</strong>就是一组策略。<strong class="lk jd">策略</strong>是授权一个服务对另一个服务执行的动作。一个角色可以附加多个策略。反过来，角色与服务相关联。您可以通过在现有策略中搜索来添加策略，也可以创建自己的策略。在下面的例子中，我们授权 Lambda 函数从 DynamoDB 表中检索信息，发送队列并离开日志。</p><h2 id="bf84" class="op ne it bd nf oq or dn nj os ot dp nn lr ou ov np lv ow ox nr lz oy oz nt iz bi translated">λ函数</h2><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pl"><img src="../Images/67ba08d6ee993c361c04db87f14ff80f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQ4164Em08iqmUAEovurkg.png"/></div></div></figure><p id="00fe" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Lambda 的功能代码结构重复了<strong class="lk jd">步骤 2 </strong>中的代码，除了它不再是一次性的。对于我们的项目，这个函数是整个数据管道的起点。我们希望通过添加一个带有简单 cron schedule 表达式的触发器，让它每 30 分钟执行一次。</p><p id="bdc7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Lambda 函数的内部是这样的。</p><p id="f987" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">消息按照 SQS 队列的配置发送。我可以给你另一个建议。如果 SQS 的“交货延迟”选项不适合您，<code class="fe pa pb pc pd b">sqs.send_message</code>还有一个参数叫做<code class="fe pa pb pc pd b">DelaySeconds</code>。当您想要在 Lambda 函数中分离发送操作时，请使用此参数。例如，您有 10k 个观测值要发送，这些观测值将一个接一个地进行。取而代之的是，你将它们分成 5 个 2k 的片段，每个片段都有<code class="fe pa pb pc pd b">DelaySeconds=180</code>，你的下一个服务将会逐渐接收到它，而不会使你的平台过载。<code class="fe pa pb pc pd b">DalaySeconds</code>参数的最大限制是 900 秒，这就是为什么您总是必须根据零件数量删除 900，以获得队列组之间的最大延迟。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="4011" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">结论</h1><p id="7f93" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">希望你能在这篇文章/指南中找到有用的东西。你可以在我们的<a class="ae lh" href="https://github.com/NewscatcherAPI/beta/tree/master/Newscatchet%20Architecture%2C%20Part%20I" rel="noopener ugc nofollow" target="_blank"> Github 库</a>上找到所有提到的代码。此外，我们已经发布了封闭测试版。如果您对新闻 API 感兴趣，<a class="ae lh" href="https://newscatcherapi.com/docs" rel="noopener ugc nofollow" target="_blank">注册</a>，亲自测试我们的产品。</p><p id="8e0d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我计划写另外两个部分，分别是关于接收 SQS 消息、在 DynamoDB 上保存数据、使用 DynamoDB 流填充 es 索引、在 Flask 上创建 RESTful API 以及用 Zappa 安装 Gateway API 的测试版。注意安全，呆在家里。</p></div></div>    
</body>
</html>