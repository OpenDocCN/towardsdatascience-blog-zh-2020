<html>
<head>
<title>Complete Guide to Build and Deploy a Tweet Generator App into Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中构建和部署Tweet Generator应用程序的完整指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/complete-guide-to-build-and-deploy-a-tweet-generator-app-into-production-5006729e583c?source=collection_archive---------37-----------------------#2020-04-16">https://towardsdatascience.com/complete-guide-to-build-and-deploy-a-tweet-generator-app-into-production-5006729e583c?source=collection_archive---------37-----------------------#2020-04-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8d8b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习使用代码从零开始构建一个Tweet Generator应用程序，从Twitter下载数据，在Google Colab上训练GPT-2模型，并在AWS上部署</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/301facc66b45e9740818f76229997029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IutOG1gH6q2_vLKl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">🇨🇭·克劳迪奥·施瓦茨| @purzlbaum 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="f6e9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">快速链接</h1><p id="c04e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">app:【http://botbaby.in/】T4T6】GitHub:<a class="ae ky" href="https://github.com/nikhilno1/bot-baby" rel="noopener ugc nofollow" target="_blank">https://github.com/nikhilno1/bot-baby</a></p><h1 id="3e23" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">目录:</h1><p id="cc1d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">- <a class="ae ky" href="#87f3" rel="noopener ugc nofollow">背景与目的</a> <br/> - <a class="ae ky" href="#9fbb" rel="noopener ugc nofollow">大局</a> <br/> - <a class="ae ky" href="#0f81" rel="noopener ugc nofollow">构建数据集</a> <br/> - <a class="ae ky" href="#236b" rel="noopener ugc nofollow">模型训练</a> <br/> - <a class="ae ky" href="#95de" rel="noopener ugc nofollow">在AWS上部署</a> <br/> - <a class="ae ky" href="#b939" rel="noopener ugc nofollow">前端</a> <br/> - <a class="ae ky" href="#f467" rel="noopener ugc nofollow">分析</a>-<a class="ae ky" href="#458f" rel="noopener ugc nofollow">结果</a> <br/> - <a class="ae ky" href="#c3e0" rel="noopener ugc nofollow">挑战</a></p><h1 id="87f3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">背景和目标</h1><p id="69f7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">作为一个痴迷于数据分析的twitter用户，我一直想开发应用程序来分析twitter数据。我关心的是社交媒体话语演变的方式，尤其是。在推特上。假新闻、钓鱼、仇恨信息、虚假趋势、机器人等的扩散令人担忧，我总是有这种冲动去做些什么。</p><p id="f684" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我也一直希望获得现实世界的工作经验，我相信这对我的下一份工作会有帮助。在我一年的职业生涯中期，我还有3个月的休息时间。由于时间不多(因为我也在找工作),我想挑选一个不太关注ML算法的问题，但可以让我花足够的时间学习大规模部署ML生产模型。</p><p id="0715" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我决定开始为左翼(LW)和右翼(RW)的印度推特建立一个推特生成器应用程序。该应用背后的想法是突出两个阵营的两极分化和使用的语言。在我看来，以此为起点的好处是:</p><ol class=""><li id="55a5" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">允许我建立一个下载/传输twitter数据的框架。</li><li id="9404" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">开发一个语言模型，我可以稍后用于其他下游任务。</li><li id="19f9" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">ML模型培训允许我在大约一个月内建立完整的应用程序。</li><li id="d3b1" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">完成MLOps生命周期，包括数据和模型的版本控制。</li><li id="86e7" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">使用Elasticsearch添加搜索功能，以获得其他有趣的见解。</li><li id="635c" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">建立解决其他问题(假新闻/趋势、机器人、仇恨信息等)的基础</li></ol><p id="47c5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">有了明确的目标后，我开始着手工作，用了大约3周的时间完成了这个应用。</p><p id="5a09" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在让我们来看看所有的细节。</p><h1 id="9fbb" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">大局</h1><p id="5b72" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这是我们将涉及的所有构建模块的快速快照。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/edc3c13156d17e20edc54eba388dd257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1fY6_9qjWm3Je3jWiB6ktg.png"/></div></div></figure><h1 id="0f81" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">构建数据集</h1><p id="cc96" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了生成LW &amp; RW tweets，我需要两个语言模型，它们分别在自己的数据集上进行训练。在这种情况下，数据集是来自两个阵营的人的推文。</p><p id="f465" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在获得一份LW &amp; RW帐户的列表可能有点困难，因为这些信息不会在任何地方公开。每个人都认为自己是中间派。:)</p><p id="b53a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">起初我想建立某种社交图或聚类算法，但后来我发现我不需要做任何复杂的事情。以下是我最后做的事情:</p><ol class=""><li id="364c" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">我从少数几个经常被贴上LW或RW标签的客户开始。</li><li id="bbae" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">我利用了Twitter自己的推荐引擎，即“与X相似”的功能来寻找更多像他们一样的句柄。</li><li id="899b" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">通过这个，我为每一方建立了一个35-40名用户的列表，我称他们为领导者。</li><li id="b9ee" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后我下载了所有领导人的追随者名单。</li><li id="2971" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">我合并了关注者列表，并按频率排序。</li><li id="970c" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">这个想法是，任何追随大多数“领导者”的人都很可能属于同一个阵营。</li><li id="8eed" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">通过这种方式，我获得了双方排名前15万的twitter账户列表，并删除了两个列表中的共同账户。</li><li id="017c" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后，我会下载所有这些用户的推文，这些推文将成为我的数据集。</li></ol><p id="0d5e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从twitter上下载数据是一项痛苦的工作，因为存在各种速率限制。我不想冒应用程序被阻塞的风险，创建一大堆节点并下载。所以我公平地使用单个节点来下载数据。</p><p id="3cc3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">不幸的是，当我开始构建数据集时，我并不知道twint。我知道了<a class="ae ky" href="https://www.tweepy.org/" rel="noopener ugc nofollow" target="_blank"> tweepy </a>，后来又知道了<a class="ae ky" href="https://pypi.org/project/GetOldTweets3/" rel="noopener ugc nofollow" target="_blank"> GetOldTweets3 </a>图书馆。由于这两个一起满足了我的要求，我与它滚动。但如果让我再来一次，我最有可能选择<em class="nh"> twint </em>。</p><blockquote class="ni nj nk"><p id="c9f9" class="lr ls nh lt b lu mn ju lw lx mo jx lz nl mp mc md nm mq mg mh nn mr mk ml mm im bi translated"><strong class="lt iu"> <em class="it">注:Tweepy vs GetOldTweets3 </em> </strong></p><p id="e5cd" class="lr ls nh lt b lu mn ju lw lx mo jx lz nl mp mc md nm mq mg mh nn mr mk ml mm im bi translated">Tweepy: 7天，每15分钟窗口18000条推文。3200条最近的推文，每条推文都有丰富的信息。</p><p id="1e1c" class="lr ls nh lt b lu mn ju lw lx mo jx lz nl mp mc md nm mq mg mh nn mr mk ml mm im bi translated">GetOldTweets3:没有授权，信息更少，获取旧的推文</p></blockquote><p id="e9d8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下载推文数据的步骤:</p><ol class=""><li id="bdc1" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">使用<em class="nh"> tweepy，</em>我首先下载了所有的追随者id。获得关注者id而不是用户名的好处是速度提高了15倍。id的速率限制是45000，而用户名的速率限制是3000。</li><li id="93ec" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">一旦我有了所有的追随者id，我就把它们合并，按降序排列，最后删除重复。</li><li id="8fe2" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后我使用twitter的HTTP GET请求将id转换成用户名，这个请求没有任何速率限制。这一步是必需的，因为<a class="ae ky" href="https://pypi.org/project/GetOldTweets3/" rel="noopener ugc nofollow" target="_blank"> GetOldTweets3 </a>只对用户名有效，对id无效。</li><li id="5c9a" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">最后，我使用<a class="ae ky" href="https://pypi.org/project/GetOldTweets3/" rel="noopener ugc nofollow" target="_blank"> GetOldTweets3 </a>为每个用户下载推文，时间可以追溯到2014年。为什么是2014年？那是选举年，许多人在那段时间开始活跃在twitter上。</li><li id="e941" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">在下载了足够的数据后，我执行文本预处理，以删除超链接、非英语字符(因为我的语言模型只理解英语)和极短的推文。我将所有这些推文收集在一个文本文件中(LW和RW分开)，这给了我最终的训练数据集。</li></ol><h1 id="236b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">模型训练(在Google Colab上)</h1><p id="4a66" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当我开始开发这个应用程序时，我首先从零开始训练自己的语言模型。我在谷歌云上的TPU训练了一个GPT-2模型。但是结果并不像Max Woolf的笔记本那样吸引人。它开箱即用，效果极佳，所以我坚持使用它。为了减轻训练的痛苦，我甚至注册了Colab Pro订阅，这太便宜了。在TPU上进行一天的培训，我花了100多澳元，但Colab Pro每月花费我10美元。我鼓励每个人利用它。它给你更高的超时和内存。</p><p id="58b3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我培训用的笔记本在这里<a class="ae ky" href="https://github.com/nikhilno1/bot-baby/blob/master/training/notebook/Train_a_GPT_2_Model_on_Tweets.ipynb" rel="noopener ugc nofollow" target="_blank"/>。这与马克斯的原作十分相似。我用的是GPT-2的355米模型。根据我的数据集的大小，我训练了2000到6000步，直到我看到平均损失下降。对于我的大约300 MB(每边)的训练数据集，我训练了6000步。</p><p id="faee" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">训练完成后，大约需要一个小时，模型输出一堆文件，很好地打包在一个归档文件中，您可以将它复制到Google Drive进行进一步分发。</p><h1 id="95de" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在AWS上部署</h1><p id="61ec" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我最初的计划是在谷歌新发布的<a class="ae ky" href="https://cloud.google.com/ai-platform/pipelines/docs" rel="noopener ugc nofollow" target="_blank"> AI平台管道</a>上做生产部署。它看起来就像是一个全面的产品。然而，当我偶然看到这个<a class="ae ky" href="https://francescopochetti.com/deploying-a-pretrained-gpt-2-model-on-aws/#Deploying_with_Lambda_EC2_and_DynamoDB" rel="noopener ugc nofollow" target="_blank">博客</a>，它提供了在AWS上部署的详细说明，我想为什么我不先这样做。当你独自工作时，获得经常性的激励是很重要的。没有比尽早发布你的应用更好的激励了。所以我决定首先在AWS上部署它，然后再考虑在人工智能平台管道上通过适当的工作流程大规模部署它。</p><p id="e4b6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如在<a class="ae ky" href="https://francescopochetti.com/deploying-a-pretrained-gpt-2-model-on-aws/#Why_not_going_entirely_serverless?" rel="noopener ugc nofollow" target="_blank">的博客</a>中所解释的，我们不能完全没有服务器，因为每个型号都接近1.5GB，所以我需要至少3 GB的内存，仅用于这些型号。另外，我需要进行批量推理，为此我需要一个GPU实例。</p><p id="e155" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以下是当前部署架构的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/fd7f5c3acc74bf542998fe97c283d140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tVLXVjqb9n9jhtRZYI-Efg.png"/></div></div></figure><h2 id="2980" class="np la it bd lb nq nr dn lf ns nt dp lj ma nu nv ll me nw nx ln mi ny nz lp oa bi translated"><strong class="ak">主持:</strong></h2><p id="71b7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">该网站是静态托管在亚马逊S3，这是一个真正的廉价和快速的方式把你的网站推向世界。</p><h2 id="1339" class="np la it bd lb nq nr dn lf ns nt dp lj ma nu nv ll me nw nx ln mi ny nz lp oa bi translated"><strong class="ak"> API网关:</strong></h2><p id="85c7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这将创建一个API端点，它将接收来自前端应用程序的传入HTTP请求，并调用已配置的Lambda函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/1dc15d24fe3e511f64130a9fe6b69d75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jFw7HNN4Bpnz0iQ3r9oHkw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤1)创建一个API端点</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/ee75ac2133705ca6217c4681204d41c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*iD5Sc7IwK29k8We4_LfIdA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤2)创建路线</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/73b0fb07df3d944b793d1720c8e01a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xuua1Q3TbGKODHi3HCkqzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤3)配置CORS</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/8793df9699c2ed3b66f068bd4699d43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ozqaPSJsw3GWT367OmsvMw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤4)为Lambda函数配置更高的超时</p></figure><p id="bcc0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">任何集成的默认超时是3秒，因此如果您需要进行任何需要更长时间的推理，那么您需要相应地增加这个超时。</p><h2 id="dd58" class="np la it bd lb nq nr dn lf ns nt dp lj ma nu nv ll me nw nx ln mi ny nz lp oa bi translated">λ函数:</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/cc7e059729c20813a46409cbb4a26af0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xwhj6M4VoPVxEuTznfyYyA.png"/></div></div></figure><p id="1a56" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Lambda函数从API网关接收HTTP GET请求，并执行以下操作:</p><ol class=""><li id="9439" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">检查提示是否已经存在于DynamoDB中。如果是，那么读取记录并返回响应。此操作需要几毫秒才能完成。</li><li id="b708" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">如果是新的提示，那么将请求添加到SQS FIFO队列中，并启动EC2 g4dn.xlarge实例。</li><li id="8112" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">一旦实例启动，继续轮询DynamoDB以检查是否有新的提示可供读取。在这种情况下，它读取新添加的记录并将响应返回给API网关。</li><li id="e357" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">Lambda函数在返回响应之前做了一个额外的步骤。它选择生成的tweets中的大多数情绪，并只返回这些情绪。例如，如果数据库返回10条推文，其中7条是正面的，2条是负面的，1条是中性的。那么lambda函数将返回7条正面推文，因为这表明了大多数人的观点。请记住，语言生成本质上是概率性的，因此显示多数输出是有意义的。</li></ol><p id="57f7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">像在API端点上一样，我们也需要增加Lambda上的超时。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/f225bcad9d9bbc4e9647e80278729b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2wp7KqT4uSBLODBZCtbq-g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">λ超时配置</p></figure><p id="fdea" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">提示:利用TestEvent来测试你的Lambda函数。您可以按如下方式配置测试事件:</p><pre class="kj kk kl km gt oh oi oj ok aw ol bi"><span id="bd96" class="np la it oi b gy om on l oo op">{<br/> “queryStringParameters”: {<br/> “model”: “left”,<br/> “prompt”: “Test prompt”,<br/> “num_samples”: “20”,<br/> “length”: “80”,<br/> “temperature”: “0.7”,<br/> “top_p”: “0.9”,<br/> “top_k”: “40”<br/> }<br/>}</span></pre><h2 id="656c" class="np la it bd lb nq nr dn lf ns nt dp lj ma nu nv ll me nw nx ln mi ny nz lp oa bi translated">简单队列服务(SQS):</h2><p id="0dea" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了序列化传入的HTTP请求，我使用了SQS FIFO队列。Lambda函数将传入的请求排入该队列，并启动EC2 GPU实例。GPU实例在启动时从该队列中读取数据，并逐个运行推理。这允许我用一个EC2实例以高性价比的方式处理并发请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/f949525a1639d7b02fd4c2d748f4dcbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*relqoJsmL59-kqoPkDhHug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SQS先进先出队列</p></figure><h2 id="be52" class="np la it bd lb nq nr dn lf ns nt dp lj ma nu nv ll me nw nx ln mi ny nz lp oa bi translated">EC2 GPU实例:</h2><p id="5d8f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">对于推理，我使用最近推出的高性价比的G4实例(准确地说是g4dn.xlarge)。G4实例以每小时0.58美元的价格为按需主机提供最新一代的英伟达T4 GPU。使用spot实例可以进一步降低成本。在使用G4实例之前，您需要提出一个服务请求来增加vCPU限制。</p><p id="114c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在原始代码中，作者在EC2实例上启动了一个python脚本。然而，这意味着每次推理都需要额外的15秒钟来将模型加载到内存中。我修改了它，改为运行一个网络应用程序(基于Starlette)。下面是EC2实例从头到尾发生的所有事情。</p><ol class=""><li id="630b" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">Lambda函数触发EC2实例的启动</li><li id="659d" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">两个单独的web应用程序作为系统启动的一部分(作为systemd服务)运行(每个型号一个),并开始监听端口8081和8082。</li><li id="f0e5" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">另一个服务在启动时运行，监视SQS队列。每当有新请求进来时，该服务都会处理它，并使用CURL调用适当的GET请求，这会触发后端web应用程序上的推理。</li><li id="c66f" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">后端web应用程序收到请求后，调用GPT2 API批量生成20条tweets。</li><li id="48fa" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后，它会进行清理，保留最合理的推文。它首先删除不必要的字符，如换行符和引号。然后，它使用NLTK的sent_tokenize()函数删除最后一个可能不完整的句子。有时，生成的推文包含重复的单词或句子序列，因此它会删除唯一单词数量较少的推文。</li><li id="6c02" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后，网络应用程序使用<a class="ae ky" href="https://aws.amazon.com/comprehend/" rel="noopener ugc nofollow" target="_blank"> AWS领悟</a>服务对剩余的推文进行情感分析。它保留了得分最高的前10条推文。这个想法是，在任何类别(正面、负面或中性)中得分高的推文往往比得分分布更均匀的推文更连贯。</li><li id="eea4" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">然后，前10条推文按照排序顺序存储在DynamoDB中。</li><li id="05e8" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">如果超过15分钟没有收到新的请求，那么EC2实例将被关闭以节省成本。</li><li id="bf4b" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">作为关闭过程的一部分，会调用一个脚本，该脚本会将新添加的提示更新到S3上的一个文件中。这用于在UI上提供自动完成功能。</li></ol><h1 id="b939" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">前端</h1><p id="03bf" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">前端使用HTML、CSS &amp; Javascript开发。为了复制twitter的用户界面，安迪·勒沃伦兹的<a class="ae ky" href="https://web-crunch.com/posts/lets-build-tailwind-css-tweet" rel="noopener ugc nofollow" target="_blank">让我们来构建:利用顺风CSS——Tweet</a>就像天赐之物。它提供了显示单条推文的基本UI，稍后我可以扩展它(在<a class="ae ky" href="https://github.com/manan2002" rel="noopener ugc nofollow" target="_blank">马南</a>的帮助下)来显示推文的并排视图。</p><p id="c11e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如前所述，该网站静态托管在亚马逊S3。</p><p id="c742" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">自动完成:<br/> </strong>考虑到新提示的推理需要30-60秒，而如果用户输入一个现有的提示，那么在大约250毫秒内就会得到结果，鼓励用户更多地使用现有的提示是有意义的。因此，添加自动完成功能变得很重要，这样用户可以从列表中选择一个，而不是输入他/她自己的。</p><p id="5b8c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在实现一些极其简单的东西之前，我考虑了一些复杂的解决方案(使用Elasticsearch或AWS云搜索)。</p><p id="25b8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">由于我的网站位于S3，我修改了我的前端代码，以读取来自S3的“提示”文件。该文件包含所有现有提示的列表。在用户对新提示进行推理之后，每当实例关闭时，S3上的提示文件就会更新。有一个小的滞后，但除此之外，这个简单的解决方案工作得非常好。</p><h1 id="f467" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">分析学</h1><p id="e4b4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我想获得使用统计数据，并为用户提供一个选项来给出他们对应用程序的反馈。</p><p id="ec06" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这些是我为此添加的一些东西:</p><ol class=""><li id="d6f0" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">向DynamoDB添加了一个“已访问”计数器，这样每次读取记录都会触发该计数器的(原子)增量。我可以用它来显示流行的查询。</li><li id="5b6c" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">在API端点上启用了“详细路由度量”收集。我可以用它来获得更多关于AWS内的访问者数量，位置等细节。</li><li id="51d3" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">与谷歌分析集成，以获得更详细的使用统计数据</li><li id="fdc2" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">与<a class="ae ky" href="https://mopinion.com/" rel="noopener ugc nofollow" target="_blank"> mopinion </a>整合以获得用户反馈。</li></ol><p id="a0f5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于(3)和(4)，您只需要将它们提供的几行代码复制到您的HTML中。</p><h1 id="458f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结果</h1><p id="56bc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我尝试了几个温度、top_p和top_n的设置，最终选择了这些能给出最佳结果的设置。这些也是推荐的默认值。</p><pre class="kj kk kl km gt oh oi oj ok aw ol bi"><span id="594a" class="np la it oi b gy om on l oo op">“temperature”: “0.7”,<br/> “top_p”: “0.9”,<br/> “top_k”: “40”</span></pre><p id="e8d7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">其中，<br/> <em class="nh">温度</em>:温度越高，文本越疯狂<br/> <em class="nh"> top_k </em>:将生成的猜测限制为前k个猜测<br/> <em class="nh"> top_p </em>:核采样:将生成的猜测限制为累积概率</p><p id="fc5b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以下是一些结果:</p><div class="kj kk kl km gt ab cb"><figure class="or kn os ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/eec8a34bb1a35927ab96d7e9e375c133.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*CPGbYBMEqq3KDmxT4PVbhA.png"/></div></figure><figure class="or kn ox ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/cb3372a92a60f7ab4f6ecb39802ab9b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:660/format:webp/1*NprdZnNz2S0EP-h3oYNa0Q.png"/></div></figure><figure class="or kn oy ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/fe880f87262489f405847e672ff62ca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*FmHBwQPf8BB1sRwcofno-w.png"/></div></figure></div><div class="ab cb"><figure class="or kn oz ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/7c7896731cab7b3970ff7ece5725ee08.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*asIZh_5YPHpKfq80OZivlA.png"/></div></figure><figure class="or kn pa ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/5f6f383e4d77c7cd65dec2a243e2a006.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*sRIbubyv2FaulilFN41_kA.png"/></div></figure><figure class="or kn pb ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/1f82f225bdd637a2b8a578c26a122fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*rYP1kIzXgH_8cJCkLxjcJA.png"/></div></figure></div><div class="ab cb"><figure class="or kn pc ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/d9de99397098aaa3bc17367d8694e5f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*tv7zQwANqnrieM-b9YzDUQ.png"/></div></figure><figure class="or kn pd ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/2145573078429f34cad8965f2add5730.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*WVhD0oe7_YKWFVJWPo30FQ.png"/></div></figure><figure class="or kn pe ot ou ov ow paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/9bdbe5b56b5265e3c4fea8079ca63444.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*YW49m12AjZEv5HeupXM7MQ.png"/></div></figure></div><h1 id="faf3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">挑战</h1><p id="a123" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这一部分列出了我一路上面临的一些挑战。希望它能帮助面临类似问题的人。<br/> <em class="nh">(注:我没有做好记录我所面临的所有问题/挑战的工作，所以这些是凭记忆提供的。我会根据我的记忆不断补充。)</em></p><ol class=""><li id="44e0" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">用命令<code class="fe pf pg ph oi b">nltk.download(‘punkt’)</code>安装NLTK数据</li><li id="febc" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><code class="fe pf pg ph oi b">app.py</code>代码取自<a class="ae ky" href="https://github.com/minimaxir/gpt-2-cloud-run" rel="noopener ugc nofollow" target="_blank">GPT-2-云运行</a>。我在安装ujson包时遇到了构建错误。这个错误是由于缺少<code class="fe pf pg ph oi b">g++</code>库造成的。<br/>运行<br/>T3】</li><li id="5d4d" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">安装使用GPU的正确tensorflow 1.x版本时出现问题。我认为正确的安装方法是运行<code class="fe pf pg ph oi b">pip install tensorflow-gpu==1.15</code></li><li id="9b0a" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">SSM代理存在没有正确权限/策略的问题。始终验证SSM代理是否工作正常，并且能够连接到可用的实例。确保您已经在AWS控制台上完成了“<a class="ae ky" href="https://ap-south-1.console.aws.amazon.com/systems-manager/home" rel="noopener ugc nofollow" target="_blank">系统管理器快速设置</a>”。</li><li id="bddd" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">我遇到了一个问题，推理发生在CPU上，而不是GPU上。这被证明是环境变量问题。LD_LIBRARY_PATH设置不正确。过了一会儿，我注意到系统日志中有一个错误。参考gp T2-app-[型号]。正确设置它的服务文件。</li><li id="8c33" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">如果遇到任何问题，请始终查看/var/log/syslog。大多数情况下，错误会被记录在那里。</li><li id="ff24" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">有时，由于可用性区域中的容量不足，GPU实例将不会运行。您需要尝试不同的AZ。</li></ol><h1 id="c3e0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">下一步怎么样</h1><p id="2998" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这个应用程序是为了让我尝试使用twitter数据并学习MLOps。所以我肯定想转移到谷歌的AI平台管道，进行更完整的ML工作流部署。我还希望有一个易于使用的框架来下载和存储twitter数据，所以我将探索<em class="nh"> twint </em>。一旦我有了这个想法，就可以更容易地去想其他的想法了。如果你有任何关于twitter的想法/建议，请在下面评论让我知道。</p></div></div>    
</body>
</html>