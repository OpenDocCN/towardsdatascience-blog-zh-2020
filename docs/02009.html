<html>
<head>
<title>How a broken memory module hid in plain sight — and how I blamed the Linux Kernel and two innocent hard drives</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个损坏的内存模块是如何隐藏在众目睽睽之下的——以及我是如何指责Linux内核和两个无辜的硬盘驱动器的</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-a-broken-memory-module-hid-in-plain-sight-and-how-i-blamed-the-linux-kernel-and-two-innocent-ef8ce7560ecc?source=collection_archive---------29-----------------------#2020-02-25">https://towardsdatascience.com/how-a-broken-memory-module-hid-in-plain-sight-and-how-i-blamed-the-linux-kernel-and-two-innocent-ef8ce7560ecc?source=collection_archive---------29-----------------------#2020-02-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/eb8c2a75ff1f37a72f07a75d84d0914d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/0*oUbQ1RZqbkGt2qFx.jpg"/></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">梅斯特不高兴了— <em class="kb">来源:克里斯蒂安·霍林格</em></p></figure><p id="cf0c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们大多数人在生活中见过、调试并解决了很多技术问题——从理解廉价的PSU意味着大量的烟雾，通过你最喜欢的编程语言中一个接一个的错误，一直到在grep中寻找segfaults。</p><p id="138b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">这是一个关于DDR-4内存的断棒如何隐藏在众目睽睽之下近一年的故事。</p><h1 id="a97d" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">卑微的出身</h1><p id="df3d" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">2019年4月，<a class="ae la" href="https://chollinger.com/blog/2019/04/building-a-home-server/" rel="noopener ugc nofollow" target="_blank">我搭建了一个家庭服务器</a>。在大多数情况下，它运行得很好。唯一奇怪的是:我的两个最老的驱动器，一对WD Red 3TB NAS驱动器，对他们的年龄来说很年轻，只有大约20，000小时，似乎拒绝接受更大的数据量。</p><p id="ed31" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">一个简单的<code class="fe me mf mg mh b">rsync</code>运行如下:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="52c5" class="mq lc it mh b gy mr ms l mt mu">sudo rsync -P -aht --out-format="%t %f %b" /mnt/3TB/ /mnt/6TB/ --exclude=".Trash-1000" --exclude="Thumbs.db"</span></pre><p id="486b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">会随机停下来，似乎没有什么好的理由。它不仅停止了，而且使整个机器无法使用。</p><p id="0142" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">当将整个事件(包括<code class="fe me mf mg mh b">stderr</code>)传送到日志时，输出会像这样停止:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4d42" class="mq lc it mh b gy mr ms l mt mu">3TB/Photos/2002/02/dad/IMG-0814.JPG # &lt;- nothing here</span></pre><h1 id="fcf4" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">配置失误</h1><p id="4953" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">问题中的驱动器是作为软件RAID-1，在作为文件系统的<code class="fe me mf mg mh b">ext4</code>之上有<code class="fe me mf mg mh b">mdadm</code>、LUKS加密，这并不是一个非常复杂的设置，这使我相信我搞砸了配置。仍然值得一看。</p><p id="8371" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">使用<code class="fe me mf mg mh b">mdadm --detail</code>检查阵列没有显示任何问题、挂起的重新同步或任何其他明显错误配置的迹象。关于<code class="fe me mf mg mh b">cryptsetup luksDump</code>也可以这么说——一切都按照预期设置好了(关于缺少ZFS、btrfs甚至LVM的评论将通过管道传送到<code class="fe me mf mg mh b">/dev/null</code>)。</p><p id="2e7d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">甚至<code class="fe me mf mg mh b">badblocks</code>，这个检查坏扇区的工具，也没有产生任何结果。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9789" class="mq lc it mh b gy mr ms l mt mu">nohup badblocks -nvs /dev/sda 1&gt;&amp;2 | tee sda.out &amp;</span></pre><p id="425e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我甚至试图使用<code class="fe me mf mg mh b">strace</code>找到最初的命令:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4277" class="mq lc it mh b gy mr ms l mt mu">sudo strace -o strace-output.log -f rsync -P -aht --out-format="%t %f %b" /mnt/3TB/ /mnt/6TB/ --exclude=".Trash-1000" --exclude="Thumbs.db"</span></pre><p id="6192" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">无济于事。</p><p id="6515" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">因此，肯定是一个坏的硬盘驱动器(或者可能是SATA电缆或一个垂死的PCI-to-SATA卡)。诚然，两个驱动器同时损坏的可能性很低，但并非不可能。</p><h1 id="751e" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">责怪错误的事情</h1><p id="03b0" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">因此，我干脆不挂载阵列。毕竟，服务器是全新的，在我最终将所有现有的备份驱动器迁移到它之前，它仍然有足够的空间。所以何必呢？</p><p id="d137" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我的懒惰很快就咬了我。几个月后，我在服务器上移植了我的<code class="fe me mf mg mh b">pihole</code>，一个基于DNS的网络级广告和跟踪拦截器。它也恰好是一个DHCP服务器。</p><p id="f7ff" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">DHCP服务器的问题是它们缺乏可用性不会马上显现出来。如果网络上的每台设备都分配了IP地址，就没什么好担心的了。对于DNS来说也是如此——大多数设备将简单地与它们的备用DNS对话，如<code class="fe me mf mg mh b">8.8.8.8</code>或<code class="fe me mf mg mh b">1.1.1.1</code>。</p><p id="72d0" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">有一天，我的网络似乎中断了。我很快责怪康卡斯特，愤怒地重启调制解调器和路由器，但无济于事。WiFi是有的，但是设备得不到IPs。嗯，奇怪。</p><p id="c1b1" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">过了一会儿，我明白了——是服务器在分配地址。如果它关闭，没有设备可以加入网络。由于时间紧迫，我重启了服务器，解密了驱动器，然后继续我的快乐之路，归咎于一个反常的事故。</p><p id="2181" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">回来后，我继续翻看<code class="fe me mf mg mh b">/var/log</code>，愤怒地寻找罪犯。我敢说，这可能是潮人科技的错——Kubernetes、Docker、nodejs、golang——魔鬼的杰作！</p><p id="322c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">嗯，在一个死内核上找到日志是很困难的——毕竟，没有一个内核做I/O，死内核写日志是不太可能的。但是有一点很突出:<code class="fe me mf mg mh b">munin</code>。</p><p id="e214" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在不可避免的硬重置之前收到的最后一个日志如下所示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c7ce" class="mq lc it mh b gy mr ms l mt mu">bigiron smartd[786]: Device: /dev/sdd [SAT], SMART Usage Attribute: 194 Temperature_Celsius changed from 113 to 112<br/>22:43:15 bigiron smartd[786]: Device: /dev/sdf [SAT], 1 Currently unreadable (pending) sectors<br/>22:43:15 bigiron smartd[786]: Device: /dev/sdf [SAT], SMART Usage Attribute: 194 Temperature_Celsius changed from 61 to 60<br/>22:50:01 bigiron CRON[9239]: (root) CMD (if [ -x /etc/munin/plugins/apt_all ]; then /etc/munin/plugins/apt_all update 7200 12 &gt;/dev/null; elif [ -x /etc/munin/plug<br/>ins/apt ]; then /etc/munin/plugins/apt update 7200 12 &gt;/dev/null; fi)<br/>08:09:52 bigiron systemd-modules-load[465]: Inserted module 'lp'</span></pre><p id="e2c5" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">Munin，作为久经沙场的监控软件，可能遭遇了配置不良、软件包过时或类似的问题。有道理——北美某处房子里的一台服务器发现了监控全球成千上万台机器的软件中的一个破坏游戏的漏洞。</p><p id="dcae" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我不想再为此烦恼了，就把穆宁搬走了。反正我太笨了。</p><h1 id="9aa7" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">法伦海特233</h1><p id="4004" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">但是另一件困扰我的事情是:硬盘温度不太可能超过110摄氏度——大多数硬盘可能会在80摄氏度左右失效。在reddit的一个帖子上(关于我的服务器！)，用户<code class="fe me mf mg mh b">Tired8281</code>发帖:</p><blockquote class="mv mw mx"><p id="3078" class="kc kd my ke b kf kg kh ki kj kk kl km mz ko kp kq na ks kt ku nb kw kx ky kz im bi translated"><code class="fe me mf mg mh b"><em class="it">Unfortunately I made a single stupid mistake with the hardware setup and the software setup I used didn't catch it, and three months later half of the drives died</em></code></p><p id="2adc" class="kc kd my ke b kf kg kh ki kj kk kl km mz ko kp kq na ks kt ku nb kw kx ky kz im bi translated"><code class="fe me mf mg mh b"><em class="it">Promise you won't laugh? I installed the fan wrong. Instead of sucking the hot air from the CPU out of the case, it sent that hot air into the drive cage, slow roasting my hard drives</em></code></p><p id="2eaf" class="kc kd my ke b kf kg kh ki kj kk kl km mz ko kp kq na ks kt ku nb kw kx ky kz im bi translated"><a class="ae la" href="https://old.reddit.com/r/linux/comments/cq9few/building_a_home_server/ewvcx9o/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://old . Reddit . com/r/Linux/comments/CQ 9 view/building _ a _ home _ server/ewvcx 9 o/</em></a></p></blockquote><p id="578c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我没有笑。我以为我也做了同样的事。坐下来，把东西拆开，检查气流，甚至搜索“如何安装机箱风扇”——我已经做了几十次了(我的电脑太多了)——结果发现一切都很好，事实上，那里没有任何东西看起来异常温暖。盒子旁边有一个空调通风口，我用了很多高质量的风扇。</p><p id="a86a" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">肯定是S.M.A.R.T .蠢东西，从来不靠谱。这就更有理由去责怪驱动了！</p><p id="cd62" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">只是… /dev/sdf从来不是看似破碎的3TB阵列的一部分。</p><h1 id="9733" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">追逐错误的东西</h1><p id="9afa" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">我们总结一下:融化硬盘。复制数据时系统死锁。在系统被监控软件锁定之前记录消息，可能会进行大量的I/O操作。</p><p id="63c1" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">是时候追踪这个问题了:在“坏的”驱动器上启动另一个rsync，迎接我的是:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/9ccbcc33bf345c53bab761e9ddaaaeb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6XeC6NaMWJMg0dJz.jpg"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">ext4_finish_bio — <em class="kb">来源:克里斯蒂安·霍林格</em></p></figure><p id="8a47" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">哈，<strong class="ke iu">我就知道</strong>！<code class="fe me mf mg mh b">ext4_finish_bio</code>！Ext4！<code class="fe me mf mg mh b">fs</code>模块！一定是硬盘的问题！令人讨厌的是:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ff91" class="mq lc it mh b gy mr ms l mt mu">static void ext4_finish_bio(struct bio *bio)<br/>{<br/> int i;<br/> struct bio_vec *bvec;</span><span id="c035" class="mq lc it mh b gy nh ms l mt mu">bio_for_each_segment_all(bvec, bio, i) {<br/>  struct page *page = bvec-&gt;bv_page;<br/>#ifdef CONFIG_EXT4_FS_ENCRYPTION<br/>  struct page *data_page = NULL;<br/>#endif<br/>  struct buffer_head *bh, *head;<br/>  unsigned bio_start = bvec-&gt;bv_offset;<br/>  unsigned bio_end = bio_start + bvec-&gt;bv_len;<br/>  unsigned under_io = 0;<br/>  unsigned long flags;</span><span id="a619" class="mq lc it mh b gy nh ms l mt mu">if (!page)<br/>   continue;</span><span id="8872" class="mq lc it mh b gy nh ms l mt mu">#ifdef CONFIG_EXT4_FS_ENCRYPTION<br/>  if (!page-&gt;mapping) {<br/>   /* The bounce data pages are unmapped. */<br/>   data_page = page;<br/>   fscrypt_pullback_bio_page(&amp;page, false);<br/>  }<br/>#endif</span><span id="102b" class="mq lc it mh b gy nh ms l mt mu">if (bio-&gt;bi_status) {<br/>   SetPageError(page);<br/>   mapping_set_error(page-&gt;mapping, -EIO);<br/>  }<br/>  bh = head = page_buffers(page);<br/>  /*<br/>   * We check all buffers in the page under BH_Uptodate_Lock<br/>   * to avoid races with other end io clearing async_write flags<br/>   */<br/>  local_irq_save(flags);<br/>  bit_spin_lock(BH_Uptodate_Lock, &amp;head-&gt;b_state);<br/>  do {<br/>   if (bh_offset(bh) &lt; bio_start ||<br/>       bh_offset(bh) + bh-&gt;b_size &gt; bio_end) {<br/>    if (buffer_async_write(bh))<br/>     under_io++;<br/>    continue;<br/>   }<br/>   clear_buffer_async_write(bh);<br/>   if (bio-&gt;bi_status)<br/>    buffer_io_error(bh);<br/>  } while ((bh = bh-&gt;b_this_page) != head);<br/>  bit_spin_unlock(BH_Uptodate_Lock, &amp;head-&gt;b_state);<br/>  local_irq_restore(flags);<br/>  if (!under_io) {<br/>#ifdef CONFIG_EXT4_FS_ENCRYPTION<br/>   if (data_page)<br/>    fscrypt_restore_control_page(data_page);<br/>#endif<br/>   end_page_writeback(page);<br/>  }<br/> }<br/>}</span></pre><p id="79ec" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><a class="ae la" href="https://elixir.bootlin.com/linux/v4.19.106/source/fs/ext4/page-io.c#L62" rel="noopener ugc nofollow" target="_blank">https://elixir . boot Lin . com/Linux/v 4 . 19 . 106/source/fs/ext 4/page-io . c # L62</a></p><p id="390b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">经过搜索，以下是2005年以来的邮件列表主题中互联网智慧的全部:<a class="ae la" href="https://www.redhat.com/archives/dm-devel/2015-October/msg00046.html" rel="noopener ugc nofollow" target="_blank">https://www . red hat . com/archives/DM-devel/2015-10月/msg00046.html </a></p><p id="1d27" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">只是……我运行的是<code class="fe me mf mg mh b">Debian 10</code>，内核<code class="fe me mf mg mh b">4.19</code>。</p><p id="da20" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">比以往任何时候都更困惑——<code class="fe me mf mg mh b">ext4</code>内核模块中的一个标准调用如何会在一个最新的(稳定的)内核上导致死锁，这超出了我的理解范围。</p><p id="33cf" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">同样，我们可以看到这一点:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5db9" class="mq lc it mh b gy mr ms l mt mu">invalid_op+0x14/0x20</span></pre><p id="2fb0" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">呃，无效的操作码？</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e4e2" class="mq lc it mh b gy mr ms l mt mu">ENTRY(invalid_op) ASM_CLAC pushl $0 pushl $do_invalid_op jmp error_code END(invalid_op)</span></pre><p id="e3e2" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><a class="ae la" href="https://elixir.bootlin.com/linux/v4.2/source/arch/x86/entry/entry_32.S#L743" rel="noopener ugc nofollow" target="_blank">https://elixir . boot Lin . com/Linux/v 4.2/source/arch/x86/entry/entry _ 32。S#L743 </a></p><p id="cbb0" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">嗯，中央处理器的问题？知道了旧版本的BIOS会引起AMD锐龙CPU的问题，我现在开始更新BIOS，希望能有所改变。这并没有发生。</p><h1 id="5899" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">找到线索</h1><p id="422a" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">沮丧之余，我几乎准备好花费数百美元购买一对新的NAS驱动器。幸运的是，一个周日下午，我和我的搭档在好市多看到一个8TB的外置硬盘，售价120美元。在最终更换驱动器之前，运行一些额外的备份似乎是一项不错的投资。除了餐馆供应的一加仑橄榄油和鸡汤，我们回到家，我开始准备开车。</p><p id="3373" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">像我这样天真的人，我把它插入服务器，格式化成ext4，加上LUKS……然后遇到了一个“无效的密码短语”,甚至是一个单字符的密码。归咎于一个坏了的USB端口，我把它插到我的笔记本电脑上——运行popOS！还有一个更新的内核，我可以补充一下——它工作起来非常棒。</p><p id="5783" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">回到服务器，启动<code class="fe me mf mg mh b">rsync</code>，我就不管它了。</p><p id="ee04" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">第二天早上我看到了这个:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ni"><img src="../Images/8440c7301703ef12bcc0a706a6ad293f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qZdIbxAqekaKVM76.jpg"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">_raw_spin_lock — <em class="kb">来源:克里斯蒂安·霍林格</em></p></figure><p id="6195" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">打扰一下。<code class="fe me mf mg mh b"><a class="ae la" href="https://www.kernel.org/doc/Documentation/locking/spinlocks.txt" rel="noopener ugc nofollow" target="_blank">_raw_sping_lock</a></code>？那个跟<strong class="ke iu">有什么关系？嗯，我想如果机器锁死了，从多线程和中断的调用中得到一个异常是有意义的，但是这次我不能责怪<code class="fe me mf mg mh b">ext4</code>。发生了什么事？</strong></p><h1 id="af02" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">认识到真正的邪恶</h1><p id="fa6b" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">我恍然大悟。服务器通常在晚上崩溃。自动备份在晚上运行，但通常情况下，考虑到它们的增量性质，它们不会做很多事情(特别是如果我只是在Windows box上玩魔兽世界的话)。由于这些备份从来没有接触过看似失效的驱动器，所以我从来没有完全建立起这种联系。</p><p id="8965" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><code class="fe me mf mg mh b">rsync</code>读取、比较和写入数据。底层内核调用缓存数据、分配页面并处理所有需要的模块——文件系统、mdadm、dm-crypt(使用内核的加密API)——同时处理多个线程。</p><p id="ddc4" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">虽然这些操作可能不会对系统造成巨大的负载(从绝对意义上来说，如所用CPU内核的百分比),但它会执行许多需要同步的小操作</p><p id="713d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果在任何时候，坏的内存导致内核弄乱了各自的锁，它很可能会死锁并导致系统不可用，而不会出现真正的内核崩溃。</p><p id="a7ca" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我越深入调查，就越发现:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="bd8d" class="mq lc it mh b gy mr ms l mt mu">Message from syslogd@bigiron at Feb 22 12:38:40 ... <br/>kernel:[ 7467.252060] page:ffffe29fc735a400 count:-1 mapcount:-1 mapping:0000000000000000 index:0x1 <br/>kernel:[53370.089111] watchdog: BUG: soft lockup - CPU#0 stuck for 22s! [smbd:21214]</span></pre><p id="6f45" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">内存损坏也可以解释很多更奇怪的问题——比如硬盘看起来就要融化成一片火海，尽管它处于一个舒适的温度。</p><h1 id="35cc" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">检验假设</h1><p id="7b2a" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">这很简单:我在实时系统上运行<code class="fe me mf mg mh b">memtester</code>，发现了多个问题；然后，我在一个可启动的USB驱动器上使用了用过的<code class="fe me mf mg mh b">memtest86</code>，只发现许多问题。理论证实。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ni"><img src="../Images/244cdc3b6b5d65ccf754a65d77a719f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*faUZYskgcLfxT4sT.jpg"/></div></div><p class="jx jy gj gh gi jz ka bd b be z dk translated">梅斯特不高兴了— <em class="kb">来源:克里斯蒂安·霍林格</em></p></figure><p id="305f" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在关掉内存之后——问题中的一个是一套海盗船复仇LPX 2x8GB DDR 4 cmk 8 GX 4 m1 a 2400 c 16——强制一个大的<code class="fe me mf mg mh b">rsync</code>工作，看着机器像为它而建一样工作。</p><h1 id="55e5" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="5cdd" class="pw-post-body-paragraph kc kd it ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz im bi translated">我不完全确定该说什么——但我真诚地希望有人在寻找一个模糊的、看似随机和不相关的问题时发现了这一点，并被阻止发疯。</p><p id="e6b7" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">就我而言，在走后一条路之前，我将开始更换RAM模块。</p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="9f67" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><em class="my">原载于2020年2月25日https://chollinger.com</em><a class="ae la" href="https://chollinger.com/blog/2020/02/how-a-broken-memory-module-hid-in-plain-sight-and-how-i-blamed-the-linux-kernel-and-two-innocent-hard-drives/?preview=true&amp;_thumbnail_id=475" rel="noopener ugc nofollow" target="_blank"><em class="my"/></a><em class="my">。</em></p></div></div>    
</body>
</html>