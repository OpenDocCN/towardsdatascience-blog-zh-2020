<html>
<head>
<title>Working with APIs in Data Science — Explore Bit-Rent Theory in Singapore’s HDB Resale Market</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在数据科学中使用APIs探索新加坡HDB转售市场中的位租理论</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/working-with-apis-in-data-science-explore-bit-rent-theory-in-singapores-hdb-resale-market-d7760fdfc601?source=collection_archive---------25-----------------------#2020-03-04">https://towardsdatascience.com/working-with-apis-in-data-science-explore-bit-rent-theory-in-singapores-hdb-resale-market-d7760fdfc601?source=collection_archive---------25-----------------------#2020-03-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="aaa1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你在数据分析和机器学习方面80%的工作是争论和清理数据，这可能是非常乏味的工作。使用API实现数据提取、数据丰富和数据清理的自动化可以节省大量手工提取的工作。</p><p id="a11c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文的重点将是如何在Python中与API交互，我们将在新加坡公共住房数据集的背景下工作，并探索住房市场中的出价-租金理论。它将更侧重于Python脚本，而不是实际分析，所以如果本文的任何部分缺乏学术和统计的严谨性，请原谅我。</p><p id="a34b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完整代码Github链接:<a class="ae ko" href="https://github.com/yuan-yexi/hdb-resale-api/blob/master/script.py" rel="noopener ugc nofollow" target="_blank">https://github . com/yuan-西野/hdb-转售-api/blob/master/script.py </a></p><h2 id="f426" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">比特租金理论</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi li"><img src="../Images/83ac29c48ca79ac92f3fb769b0e6cac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/0*1H8250MHQzKGNe00.jpg"/></div></figure><p id="a098" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们基本上是在探索每平方米价格和房产到CBD的距离之间的关系。</p><h2 id="b98d" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">我们想要实现的目标:</h2><ul class=""><li id="4ffa" class="lq lr it js b jt ls jx lt kb lu kf lv kj lw kn lx ly lz ma bi translated">从转售API查询2017年1月以后的所有交易数据</li><li id="50a8" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取交易地址的地理位置(纬度，经度)</li><li id="0e99" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取所有捷运站(新加坡地铁)的地理位置(经度，纬度)</li><li id="125b" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取所有购物中心的地理位置(纬度，经度)</li><li id="de52" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取每笔交易与最近的捷运站和购物中心之间的距离</li><li id="ff94" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取每次交易到中央商务区(莱佛士广场)的距离</li><li id="9e87" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">不要使用一行PD . read _ CSV()；)</li></ul><p id="39b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">太好了，既然已经不碍事了，那就让我们进入正题吧。</p><h2 id="0fa0" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">首先让我们检查一下我们今天将使用的API:</h2><ol class=""><li id="f0d6" class="lq lr it js b jt ls jx lt kb lu kf lv kj lw kn mg ly lz ma bi translated">https://data.gov.sg/dataset/resale-flat-prices<a class="ae ko" href="https://data.gov.sg/dataset/resale-flat-prices" rel="noopener ugc nofollow" target="_blank">——Data.gov.sg的转售价格提供了自1990年以来的历史交易数据。我们将专门检查2017年1月以后的数据集。</a></li><li id="4658" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn mg ly lz ma bi translated">https://docs.onemap.sg/<a class="ae ko" href="https://docs.onemap.sg/" rel="noopener ugc nofollow" target="_blank">—一个强大的API，提供特定于新加坡的位置坐标、交通、路线、人口数据等数据。我们将利用这个API来获取这个练习所需的地理坐标。</a></li></ol><h2 id="7918" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">通过API获取数据并转换成Pandas数据框架</h2><p id="044e" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">首先，我们将从导入一些基本库开始</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="ff1c" class="kp kq it ml b gy mp mq l mr ms">import json<br/>import requests<br/>import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt</span></pre><p id="600a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了发出我们的第一个API请求，我们将使用请求库。但在此之前，让我们检查一下浏览器中的API:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mt"><img src="../Images/39c60766cdff406133d7808fea0e95b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ve9HjJ7ZGFridgHiHc6IQ.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">这是我们将发出的HTTP GET请求，用于请求数据集的服务</p></figure><p id="8a59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以看到，我们可以通过使用“limit”或“q”参数来查询结果，以获得搜索结果。既然我们需要整个数据集，我们只需要指定整个数据集的限制。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nc"><img src="../Images/517db6f359abd24e80702f9e71fc7232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MrTPld0eJkVS1uF3E7c9dw.png"/></div></div></figure><p id="a67a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快速检查我们浏览器中的示例查询，我们可以看到我们感兴趣的事务的“记录”嵌套在JSON响应的“结果”数组中。有了我们正在处理的数据结构的概念，我们可以移动到我们的Python IDE并查询我们的数据。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="7edd" class="kp kq it ml b gy mp mq l mr ms">query_string='<a class="ae ko" href="https://data.gov.sg/api/action/datastore_search?resource_id=42ff9cfe-abe5-4b54-beda-c88f9bb438ee&amp;limit=500'" rel="noopener ugc nofollow" target="_blank">https://data.gov.sg/api/action/datastore_search?resource_id=42ff9cfe-abe5-4b54-beda-c88f9bb438ee&amp;limit=500'</a><br/>resp = requests.get(query_string)</span><span id="6ea4" class="kp kq it ml b gy nd mq l mr ms">#Convert JSON into Python Object <br/>data = json.loads(resp.content)</span></pre><p id="0c91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为这是一个相当大的数据集(在撰写本文时有101994条)，所以在转移到整个数据库之前，我们将对500条记录进行采样，以便于处理。在使用API的探索阶段，这是一个很好的实践，可以避免耗尽不必要的服务器资源，重复查询巨大的数据集。现在，让我们在IDE中检查一下服务返回给我们的内容。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="808b" class="kp kq it ml b gy mp mq l mr ms"># Notice that data type is actually 'dict'<br/>print(type(data))</span><span id="49f7" class="kp kq it ml b gy nd mq l mr ms">#Output<br/>&lt;class 'dict'&gt;</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ne"><img src="../Images/e8c1e92b39bc333786780cc33e220d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u90ayWpUIRS2cr5mXpHDZA.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">这看起来类似于我们在浏览器中看到的返回的JSON</p></figure><p id="334d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不错，从服务器返回的JSON对象基本上是大家熟悉的Python字典！我们的工作变得简单了一点，不需要额外的工作来转换我们的JSON对象，使其在Python中工作。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="3a19" class="kp kq it ml b gy mp mq l mr ms">len(data['result']['records'])</span><span id="d28c" class="kp kq it ml b gy nd mq l mr ms">#Output<br/>500</span></pre><p id="cf45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们所要做的就是访问dictionary对象中的records键，以获得存储为dictionary键-值对的事务数据列表。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="a726" class="kp kq it ml b gy mp mq l mr ms"># Access the first record in our list<br/>hdb_price_dict_records[0]</span><span id="d53b" class="kp kq it ml b gy nd mq l mr ms">#Output<br/>{'town': 'JURONG EAST',<br/> 'flat_type': '3 ROOM',<br/> 'flat_model': 'New Generation',<br/> 'floor_area_sqm': '67',<br/> 'street_name': 'JURONG EAST ST 21',<br/> 'resale_price': '270000',<br/> 'month': '2018-07',<br/> 'remaining_lease': '63 years 08 months',<br/> 'lease_commence_date': '1983',<br/> 'storey_range': '10 TO 12',<br/> '_id': 1,<br/> 'block': '214'}</span></pre><p id="bd83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">既然我们已经习惯了遍历嵌套数据，那么让我们创建Pandas数据框。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="ac32" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的示例中，我们创建了一个for循环，将每个记录中的字典值附加到相关列表中，该列表将构成数据框中的每一列。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="8c53" class="kp kq it ml b gy mp mq l mr ms">df_hdb_price = pd.DataFrame({<br/>    'town': town,<br/>    'flat_type': flat_type,<br/>    'flat_model': flat_model,<br/>    'floor_area_sqm': floor_area_sqm,<br/>    'street_name': street_name,<br/>    'resale_price': resale_price,<br/>    'month': month,<br/>    'remaining_lease': remaining_lease,<br/>    'lease_commence_date': lease_commence_date,<br/>    'storey_range': storey_range,<br/>    '_id': _id,<br/>    'block': block<br/>})</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nh"><img src="../Images/995033b305303084695aa01b06755b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MN4bXbzn--htGprKo234Ag.png"/></div></div></figure><p id="81eb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">酷！我们的数据框看起来不错！</p><h2 id="6cbe" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">通过OneMap API获取经度和纬度数据</h2><p id="73ed" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">接下来的部分有点棘手。我们需要使用地理位置坐标(纬度、经度)找到HDB单位所在的最近的捷运站。我们将使用另一个API来实现这一点OneMap API。</p><p id="824d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先让我们创建一个新加坡所有捷运站的列表。由于MRT站点随时间变化相对较慢，我们可以利用静态列表来代替。我获得了(好的ole副本和面食；) )维基百科的数据，其中也提供了即将到来的捷运站的数据。我们暂时只考虑现有的捷运站。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="9554" class="kp kq it ml b gy mp mq l mr ms">list_of_mrt = [<br/>    'Jurong East MRT Station',<br/>    'Bukit Batok MRT Station',<br/>    'Bukit Gombak MRT Station',<br/>    'Choa Chu Kang MRT Station',<br/>    'Yew Tee MRT Station',<br/>    'Kranji MRT Station',<br/>    'Marsiling MRT Station',<br/>    ....<br/>    ]</span></pre><p id="f968" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快速查看OneMap API —我们可以看到，我们需要将我们的地址输入到URL的“searchVal”参数中，如下所示:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="83ab" class="kp kq it ml b gy mp mq l mr ms"><a class="ae ko" href="https://developers.onemap.sg/commonapi/search?searchVal='+str(query_address)+'&amp;returnGeom=Y&amp;getAddrDetails=Y'" rel="noopener ugc nofollow" target="_blank">https://developers.onemap.sg/commonapi/search?searchVal='+str(address)+'&amp;returnGeom=Y&amp;getAddrDetails=Y</a></span></pre><p id="714d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们使用OneMap API来获取每个MRT站的(lat，long)坐标。下面的for循环遍历MRT车站列表并返回结果，然后我们将获取响应的第一个结果，类似于我们之前遍历转售JSON对象时所做的。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="63d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我们将它存储到一个新的数据帧中:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="a5ec" class="kp kq it ml b gy mp mq l mr ms"># Store this information in a dataframe<br/>mrt_location = pd.DataFrame({<br/>    'MRT': list_of_mrt,<br/>    'latitude': mrt_lat,<br/>    'longitude': mrt_long<br/>})</span></pre><p id="f7fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们找出使用相同方法处理的每个单元的地理位置。但是等一下，这是一个很大的数据集..我们可以让它更有效率。我们知道，在同一个HDB公寓区会有多个单位进行交易。我们可以对我们的数据帧进行重复数据消除，并仅获得数据帧中的唯一地址。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="c9ee" class="kp kq it ml b gy mp mq l mr ms"># Let's combine the block and street name to form the address of our transacted unit.<br/>df_hdb_price['address'] = df_hdb_price['block'] + " " + df_hdb_price['street_name']</span><span id="18ab" class="kp kq it ml b gy nd mq l mr ms"># Dedup Address List<br/>df_dedup = df_hdb_price.drop_duplicates(subset='address', keep='first')<br/>len(df_dedup)</span></pre><p id="9dbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们现在可以通过OneMap API获得(经度，纬度)坐标</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nf ng l"/></div></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ni"><img src="../Images/623f77d262a4aa5107cceb620f7fe2a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qENVIQNgqIHt-TtT2Uiyxg.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">当我们遍历地址列表时，我们在控制台中打印出坐标数据</p></figure><p id="04a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，让我们将它保存到一个日期框架中:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="0c2b" class="kp kq it ml b gy mp mq l mr ms">df_coordinates = pd.DataFrame({<br/>    'latitude': latitude,<br/>    'longitude': longitude,<br/>    'blk_no': blk_no,<br/>    'road_name': road_name,<br/>    'postal_code': postal_code,<br/>    'address': address<br/>})<br/>len(df_coordinates)</span></pre><p id="a723" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要为下一个任务找到解决方案，为数据框中的每个地址找到最近的MRT，并获得以米为单位的距离。</p><h2 id="4fd0" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">寻找坐标列表之间的最短距离</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/ff86dac1fe5825618352a9f0b4d690c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*UzpfrBf2cHaFLJNpfVGqFg.png"/></div><p class="my mz gj gh gi na nb bd b be z dk translated">来源:维基百科</p></figure><p id="a4a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将使用哈弗辛公式来获得曲面上两点之间的距离。或者，我们也可以使用毕达哥拉斯定理，因为我们两点之间的距离并不大。但是为了简单起见，我们将使用geopy包来计算哈弗辛公式。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="52b6" class="kp kq it ml b gy mp mq l mr ms"><strong class="ml iu"><em class="nk"># Lists of all the coordinates we will need to iterate through</em></strong><br/>list_of_lat = df_coordinates['latitude']<br/>list_of_long = df_coordinates['longitude']<br/>mrt_lat = mrt_location['latitude']<br/>mrt_long = mrt_location['longitude']</span><span id="ac69" class="kp kq it ml b gy nd mq l mr ms"><strong class="ml iu"><em class="nk"># Zipping the respective Lat and Long lists together as a list of tuples</em></strong><br/>list_of_coordinates = []<br/>for lat, long in zip(list_of_lat, list_of_long):<br/>    list_of_coordinates.append((lat,long))</span><span id="9372" class="kp kq it ml b gy nd mq l mr ms">for lat, long in zip(mrt_lat, mrt_long):<br/>    list_of_mrt_coordinates.append((lat, long))<br/>    </span></pre><p id="1173" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要获得地图上任意给定点的最近的MRT车站，我们需要:</p><ul class=""><li id="d1df" class="lq lr it js b jt ju jx jy kb nl kf nm kj nn kn lx ly lz ma bi translated">遍历我们的地址列表</li><li id="fe28" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">获取地址和所有捷运站之间的距离</li><li id="c575" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">将它存储到列表中</li><li id="5438" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">从那里我们将采取最短的距离作为最近的捷运站</li></ul><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="ab10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面我们有一个嵌套的for循环，它遍历2组坐标，为数据集中的每个唯一地址获取最近的MRT。尽管这肯定不是最有效的解决方案。例如，我们可以将我们的地址分组到新加坡的各个地区，并且只检查位于给定距离内的MRT站列表，而不是整个列表。但是现在我们将依靠CPU的强大力量来为我们制造这些数字:)</p><p id="699a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将同样计算到CBD的距离和到最近的购物中心的距离。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="0fca" class="kp kq it ml b gy mp mq l mr ms"><strong class="ml iu"><em class="nk"># Storing our distance into our data frame as a new column</em></strong><br/>df_coordinates['min_dist_mrt'] = min_dist_mrt<br/>df_coordinates['min_dist_mall'] = min_dist_mall<br/>df_coordinates['cbd_dist'] = cbd_dist</span></pre><h2 id="4de0" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">把它们放在一起</h2><p id="05a2" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">最后，我们将使用外部连接将距离数据与主数据框合并。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="0e75" class="kp kq it ml b gy mp mq l mr ms">combined = df_coordinates.merge(df_hdb_price, on="address", how='outer')</span></pre><h2 id="960c" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">一些数据卫生步骤</h2><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="0a0b" class="kp kq it ml b gy mp mq l mr ms"># Converting to the right data types<br/>combined['resale_price'] = combined['resale_price'].astype('float')<br/>combined['floor_area_sqm'] = combined['floor_area_sqm'].astype('float')</span><span id="c099" class="kp kq it ml b gy nd mq l mr ms">combined['lease_commence_date'] = combined['lease_commence_date'].astype('int64')<br/>combined['lease_remain_years'] = 99 - (2019 - combined['lease_commence_date'])<br/>combined.columns</span><span id="0d88" class="kp kq it ml b gy nd mq l mr ms">combined.dropna(inplace=True)</span><span id="00e5" class="kp kq it ml b gy nd mq l mr ms">combined['price_per_sqm'] = combined['resale_price'].div(combined['floor_area_sqm'])</span></pre><p id="d2d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们已经准备好绘制我们的价格/平方米到CDB的距离关系图！</p><h2 id="0432" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">绘制钻头租金关系</h2><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="77c2" class="kp kq it ml b gy mp mq l mr ms">g = sns.scatterplot(x=combined['cbd_dist'],y=combined['price_per_sqm'], hue=combined['flat_type'], ax=ax1)</span><span id="848e" class="kp kq it ml b gy nd mq l mr ms">box = g.get_position()<br/>g.set_position([box.x0, box.y0, box.width * 0.85, box.height]) # resize position</span><span id="2b1c" class="kp kq it ml b gy nd mq l mr ms">g.legend(loc='center right', bbox_to_anchor=(1.2, 0.5), ncol=1)</span><span id="581b" class="kp kq it ml b gy nd mq l mr ms">plt.show()</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi no"><img src="../Images/cfa15d3ab55f8e59f42b7ee3593b18bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mY7wwa7mJpYCsQLxiAX6OA.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">新加坡转售组屋的位租关系</p></figure><p id="9ed2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从我们的数据中，我们明确看到了距离和每平方米价格之间的负相关关系。但是在房地产和中央商务区之间的某些距离间隔上也有很大的差异。除了我们的cdb_dist变量之外，肯定还有其他决定地价的解释性因素。让我们探索变量之间的相关性。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="7756" class="kp kq it ml b gy mp mq l mr ms">corrMatrix = df_numerical_cols.corr()<br/>sns.heatmap(corrMatrix, <br/>        xticklabels=corrMatrix.columns,<br/>        yticklabels=corrMatrix.columns,<br/>        cmap='coolwarm',<br/>        annot=True)</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi np"><img src="../Images/8cec43e408db1bfbcaf02dc89fd16246.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*-yAdGZqhZiyjanDmXOxQHg.png"/></div></figure><p id="3c6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">看起来，到关键设施的距离，如捷运和购物中心，对我们的土地价格有影响。而土地租赁也可以解释部分价格。</p><h2 id="f58b" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">线性回归模型</h2><p id="0ad9" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">我们将使用一个简单的多元线性回归模型进一步探索我们的特征的解释能力。让我们设计我们需要的功能。</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="8a3d" class="kp kq it ml b gy mp mq l mr ms"><strong class="ml iu"># Separate our numerical and categorical variables</strong><br/>cat_features = ['town', 'flat_type', 'storey_range']<br/>num_features = ['min_dist_mrt', 'min_dist_mall', 'cbd_dist','floor_area_sqm', 'lease_remain_years', 'resale_price', 'price_per_sqm']<br/>target = ['resale_price']</span><span id="0b64" class="kp kq it ml b gy nd mq l mr ms"><strong class="ml iu"># New data frame for our regression model</strong><br/>df_reg = combined[['town', 'flat_type', 'storey_range', 'min_dist_mrt', 'min_dist_mall', 'cbd_dist','floor_area_sqm', 'lease_remain_years', 'resale_price', 'price_per_sqm']]</span></pre><p id="6000" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">映射序数分类特征:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="efff" class="kp kq it ml b gy mp mq l mr ms">flat_type_map = {<br/>    'EXECUTIVE': 7,<br/>    'MULTI-GENERATION': 6,<br/>    '5 ROOM': 5,<br/>    '4 ROOM': 4,<br/>    '3 ROOM': 3,<br/>    '2 ROOM': 2,<br/>    '1 ROOM': 1<br/>}</span><span id="f8c8" class="kp kq it ml b gy nd mq l mr ms">df_reg['flat_type_mapped'] = df_reg['flat_type'].map(lambda x: flat_type_map[x])</span><span id="9889" class="kp kq it ml b gy nd mq l mr ms">def split_mean(x):<br/>    split_list = x.split(' TO ')<br/>    mean = (float(split_list[0])+float(split_list[1]))/2<br/>    return mean</span><span id="8a05" class="kp kq it ml b gy nd mq l mr ms">df_reg['storey_mean'] = df_reg['storey_range'].apply(lambda x: split_mean(x))</span></pre><p id="3716" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一键编码我们的“城镇”功能:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="bb2a" class="kp kq it ml b gy mp mq l mr ms"># One-Hot Encoding for our categorical variables and drop 1 of our dummy variables<br/>df_reg = pd.get_dummies(data=df_reg, columns=['town'], drop_first=True)</span></pre><p id="5a70" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建我们的回归模型:</p><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="5e7b" class="kp kq it ml b gy mp mq l mr ms">import statsmodels.api as sm<br/><br/>X = df_reg[['min_dist_mrt', 'min_dist_mall',<br/>       'cbd_dist', 'floor_area_sqm', 'lease_remain_years',<br/>       'flat_type_mapped', 'storey_mean']] <br/>y = df_reg["price_per_sqm"]</span><span id="aeff" class="kp kq it ml b gy nd mq l mr ms">X = sm.add_constant(X)</span><span id="a039" class="kp kq it ml b gy nd mq l mr ms">model = sm.OLS(y, X).fit()<br/>predictions = model.predict(X)</span><span id="f909" class="kp kq it ml b gy nd mq l mr ms"># Print out the statistics<br/>model.summary()</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/93018c26ad4de6dcec42a2e1f5d36e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*acGta86uPKJW7T5QgBPtBQ.png"/></div></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nr"><img src="../Images/30495d7eb8d880d2d14bb46f4f512024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CugwDlqZNad47Oih4Lsj5A.png"/></div></div></figure><h2 id="5830" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">解释我们的结果</h2><ul class=""><li id="8785" class="lq lr it js b jt ls jx lt kb lu kf lv kj lw kn lx ly lz ma bi translated">r平方-这是预测的解释方差的百分比。我们的模型只能解释约0.728或72.8%的数据差异</li><li id="8b35" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">我们的系数的统计显著性-我们在模型中的p值很小(&lt; 0.05)，因此我们可以拒绝零假设，并得出结论，我们的变量与我们的每平方米价格有因果关系。事实上，我们与CDB的距离每增加1米，每平方米的价格就会下降0.19美元</li></ul><h2 id="a6b2" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">检查回归误差指标</h2><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="3479" class="kp kq it ml b gy mp mq l mr ms">from sklearn import metrics</span><span id="1a42" class="kp kq it ml b gy nd mq l mr ms">print('Mean Absolute Error:', metrics.mean_absolute_error(df_reg["price_per_sqm"], predictions))  <br/>print('Mean Squared Error:', metrics.mean_squared_error(df_reg["price_per_sqm"], predictions))  <br/>print('Root Mean Squared Error:', np.sqrt(metrics.mean_squared_error(df_reg["price_per_sqm"], predictions)))</span><span id="9f1e" class="kp kq it ml b gy nd mq l mr ms"><strong class="ml iu"><em class="nk"># Output</em></strong><br/>Mean Absolute Error: 476.06461056219956<br/>Mean Squared Error: 395453.2820071103<br/>Root Mean Squared Error: 628.8507629057234</span></pre><p id="41ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">平均结果误差给出了模型预测的实际数据的平均绝对值。与我们的数据集中每平方米价格的范围和平均值相比，我们的MAE相当小。</p><p id="2d3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从我们的RMSE值来看，我们的模型的预测平均会与实际价值相差628.85美元。如果我们将RMSE作为每平方米平均价格的一个百分比，那么我们将得到14%的误差率，这是相当高的。</p><h2 id="ef7f" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">改进我们的模型</h2><p id="6c99" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">让我们通过在回归中引入分类变量来提高模型的解释力。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/4bf441555059d343eb4d4d06fcc4de45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*KNkJ0WDa78K2mpoTvYjrdA.png"/></div></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/3d56e19249e5e064eeb3f41e8ed8f3e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*4PuvHqtuJAOk_WxYGJqEmA.png"/></div></figure><ul class=""><li id="9df4" class="lq lr it js b jt ju jx jy kb nl kf nm kj nn kn lx ly lz ma bi translated">我们可以看到，我们的R平方值提高了，可以解释我们数据集中82.3%的方差</li><li id="baa7" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">我们看到，房产所属的城镇对其每平方米价格有着巨大而显著的影响</li><li id="9c51" class="lq lr it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">武吉提马、海洋游行、碧山，这些都是新加坡非常受欢迎的房地产，与芽笼(红灯区)、后港(反对党)等传统上不太受欢迎的地区相比，溢价要高得多</li></ul><pre class="lj lk ll lm gt mk ml mm mn aw mo bi"><span id="bf15" class="kp kq it ml b gy mp mq l mr ms">Mean Absolute Error: 382.26714892132696<br/>Mean Squared Error: 257854.07863672107<br/>Root Mean Squared Error: 507.7933424501754</span></pre><p id="b8bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的平均误差、均方误差和RSME都降低了，这意味着我们的模型有了更高的精度。我们的RMSE/均值也降到了11.2%。</p><h2 id="c25c" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">结论</h2><p id="b0c7" class="pw-post-body-paragraph jq jr it js b jt ls jv jw jx lt jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">显然，从统计数据来看，到中央商务区的距离和每平方米的价格之间存在显著的关系。但是，这并不能完全解释新加坡HDB的房价。从我们的回归模型中，我们看到住宅地产定价有更多的因素，如设施、政治边界、物业的成熟度以及它所在的地产，这些因素可能比到中央商务区的距离具有更强的解释力和预测力。</p><p id="736f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读到最后！这是一篇很长的文章，希望它能帮助你更好地理解如何与Python中的API进行交互，以及它如何帮助你自动化数据处理和分析工作流！更多数据和Python相关内容请关注我:)</p></div></div>    
</body>
</html>