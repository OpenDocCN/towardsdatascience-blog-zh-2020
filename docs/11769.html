<html>
<head>
<title>Step by step: build a data pipeline with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一步一步:建立一个有气流的数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/step-by-step-build-a-data-pipeline-with-airflow-4f96854f7466?source=collection_archive---------2-----------------------#2020-08-15">https://towardsdatascience.com/step-by-step-build-a-data-pipeline-with-airflow-4f96854f7466?source=collection_archive---------2-----------------------#2020-08-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c0d2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建气流数据管道，以监控错误并自动发送警报电子邮件。故事提供了详细的步骤，并配有截图。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bbe07b31ee926ed10aca75cca9724a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*TptKc0vLz_h9oAmSLg7W1A.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">构建气流数据管道</p></figure><p id="e5bc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi lr translated">每次我们部署新软件时，我们会每天检查两次日志文件，看看在接下来的一两周内是否有问题或异常。一位同事问我，有没有办法监控错误，如果某个错误出现 3 次以上，就自动发送警报。我现在正在跟踪气流过程，这是一个用气流构建数据管道来监控异常的完美用例。</p><h1 id="85af" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">什么是气流？</h1><blockquote class="ms mt mu"><p id="595f" class="kv kw mv kx b ky kz jr la lb lc ju ld mw lf lg lh mx lj lk ll my ln lo lp lq ij bi translated">Airflow 是一个开源的工作流管理平台，它于 2014 年 10 月在 Airbnb 开始，后来被开源，在 2016 年 3 月成为 Apache 孵化器项目。气流设计遵循“配置即代码”的原则。[1]</p><p id="c4de" class="kv kw mv kx b ky kz jr la lb lc ju ld mw lf lg lh mx lj lk ll my ln lo lp lq ij bi translated">在 Airflow 中，DAG(或有向非循环图)是您想要运行的所有任务的集合，以反映它们的关系和依赖性的方式组织。[2]</p></blockquote><p id="70b6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Airflow 使用 Python 语言创建其工作流/DAG 文件，对于开发者来说非常方便和强大。</p><h1 id="cece" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">分析</h1><p id="1399" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">我们的日志文件保存在服务器上，有几个日志文件。我们可以通过<strong class="kx ir"> sftp </strong>命令获取它们。将所有日志文件下载到一个本地文件夹后，我们可以使用<strong class="kx ir"> grep </strong>命令提取所有包含异常或错误的行。以下是错误日志的示例:</p><p id="2211" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mv">/usr/local/air flow/data/2020 07 23/log in app . log:140851:[[]]23 Jul 2020/13:23:19196 错误 session id:u 0 ukvlfdnmsmicbuozo 86 LQ 8 ocu =[log in app]Dao。AbstractSoapDao-getNotificationStatus-服务异常:Java . net . sockettimeoutexception:读取超时</em></p><p id="9c1d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们需要逐行解析错误消息并提取字段。和上面的例子一样，我们想知道文件名、行号、日期、时间、会话 id、应用程序名、模块名和错误消息。我们将把所有这些信息提取到一个数据库表中，稍后，我们可以使用 SQL 查询来汇总这些信息。如果任何类型的错误发生超过 3 次，它将触发发送电子邮件到指定的邮箱。</p><p id="0b60" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">整个过程非常简单，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/65f49d2570bf2c72bb6de3596d8e16ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzH-LNWWaxtNn2S_RS5IXw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">监控错误日志的工作流</p></figure><h2 id="ffb6" class="nf mb iq bd mc ng nh dn mg ni nj dp mk le nk nl mm li nm nn mo lm no np mq nq bi translated">气流操作员</h2><p id="1ff1" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">气流提供了很多有用的运算符。操作符是一个单一的任务，它提供了一种实现特定功能的简单方法。例如，<em class="mv"> BashOperator </em>可以执行 Bash 脚本、命令或命令集。<em class="mv"> SFTPOperator </em>可以通过 SSH 会话访问服务器。此外，气流允许任务之间的并行，因为一个操作符对应一个任务，这意味着所有操作符可以并行运行。Airflow 还提供了一种非常简单的方法来定义任务之间的依赖性和并发性，我们将在后面讨论它。</p><h1 id="7fa9" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">履行</h1><p id="f842" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">通常，气流在 docker 容器中流动。阿帕奇在<a class="ae nr" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>发布<a class="ae nr" href="https://hub.docker.com/r/apache/airflow" rel="noopener ugc nofollow" target="_blank">气流图像</a>。一张更受欢迎的气流图由<a class="ae nr" href="https://hub.docker.com/r/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank"> Puckel </a>发布，配置良好，随时可用。我们可以从<a class="ae nr" href="https://github.com/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank"> Puckel 的 Github 库</a>中检索 docker 文件和所有配置文件。</p><p id="4329" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">安装 Docker 客户端并提取 Puckel 的存储库后，运行以下命令行启动 Airflow 服务器:</p><pre class="kg kh ki kj gt ns nt nu nv aw nw bi"><span id="f442" class="nf mb iq nt b gy nx ny l nz oa">docker-compose -f ./docker-compose-LocalExecutor.yml up -d</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/5cade13ba7381e67ca6f91d491c90a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSTSMSrfVXsW_5HJxPEx2w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">第一次运行气流</p></figure><p id="2c86" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一次运行脚本时，它会从<a class="ae nr" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>下载 Puckel 的 Airflow 镜像和 Postgres 镜像，然后启动两个 Docker 容器。</p><p id="7db6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">气流有一个很好的 UI，可以从<a class="ae nr" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>访问。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/c08db621b03265b5e566fdf7d05a0cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4MZ5dW1C7joWMXMvku0mw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流 UI 门户</p></figure><p id="a7aa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从 Airflow UI 门户，它可以触发 DAG 并显示当前运行的任务的状态。</p><p id="cc17" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们开始创建 DAG 文件。创建新的 DAG 非常容易。首先，我们定义一些默认参数，然后用 DAG 名称<strong class="kx ir"> monitor_errors </strong>实例化一个 DAG 类，DAG 名称将显示在 Airflow UI 中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">实例化新的 DAG</p></figure><p id="3b9f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">工作流的第一步是从服务器下载所有日志文件。Airflow 支持运行任务的并发性。我们为一个日志文件创建一个下载任务，所有的任务可以并行运行，我们将所有的任务添加到一个列表中。<em class="mv"> SFTPOperator </em>需要一个 SSH 连接 id，我们将在运行工作流之前在 Airflow 门户中配置它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建下载任务</p></figure><p id="9cb5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">之后，我们可以刷新 Airflow UI 来加载我们的 DAG 文件。现在我们可以看到我们的新 DAG - <strong class="kx ir"> monitor_errors </strong> -出现在列表中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/33ed09f36cf9630a41d495b8d2f6716c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gaZWZ_XH6JiSL8neQvq_Jg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流中显示的新 DAG</p></figure><p id="883c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">单击 DAG 名称，它将显示图形视图，我们可以在这里看到所有的下载任务:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/c7b646d735ac2858ef686cc00bfa09c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xlxXMSLe0t__TdHzqaqSvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图表视图中的所有下载任务</p></figure><p id="bfe6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们触发 DAG 批处理之前，我们需要配置 SSH 连接，以便<em class="mv"> SFTPOperator </em>可以使用这个连接。点击<strong class="kx ir">管理</strong>菜单，然后选择<strong class="kx ir">连接</strong>来创建一个新的 SSH 连接。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/dede2e667a556dfd265f0d5d54e43daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*1T1FtmVd4O7dtjl8RwhTrQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建 SSH 连接</p></figure><p id="8eb6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要在不输入密码的情况下访问 SSH 服务器，需要使用公钥登录。假设公钥已经放入服务器，私钥位于<em class="mv"> /usr/local/airflow/。ssh/id_rsa </em>。将<strong class="kx ir">密码</strong>字段留空，并将以下 JSON 数据放入<strong class="kx ir">额外</strong>字段。</p><pre class="kg kh ki kj gt ns nt nu nv aw nw bi"><span id="ee5a" class="nf mb iq nt b gy nx ny l nz oa">{<br/>  "key_file": "/usr/local/airflow/.ssh/id_rsa",<br/>  "timeout": "10",<br/>  "compress": "false",<br/>  "no_host_key_check": "false",<br/>  "allow_host_key_change": "false"<br/>}</span></pre><p id="dc71" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好了，让我们启用 DAG 并触发它，一些任务变成绿色，这意味着它们处于运行状态，其他任务保持灰色，因为它们在队列中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/54ba32fb98776c3b2968733d570c8b4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*naZaEdnp-IkLEIVGKpQ8aA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">任务正在运行</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/30073d26e0740a8b4475daa422be9899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hBIlE6rsh8MIyNyWD44S5g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">所有任务完成</p></figure><p id="45b2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当所有任务完成后，它们以深绿色显示。让我们检查下载到<strong class="kx ir"> data/ </strong>文件夹中的文件。它将创建带有当前日期的文件夹。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/b1db5972d1fbc194e6108c3be4087ce1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMhFkWA7ty3eZp1TfN-0Lw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">所有日志都下载到该文件夹中</p></figure><p id="3104" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">看起来不错。</p><p id="ef82" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们将提取日志文件中包含“<strong class="kx ir">异常</strong>的所有行，然后将这些行写入同一文件夹中的文件(errors.txt)中。<strong class="kx ir"> grep </strong>命令可以在一个文件夹的所有文件中搜索某些文本，也可以在搜索结果中包含文件名和行号。</p><p id="554b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Airflow 检查 bash 命令返回值作为任务的运行结果。如果没有发现异常，grep 命令将返回<strong class="kx ir"> -1 </strong>。Airflow 将非零返回值视为失败任务，然而事实并非如此。没有错误意味着我们都很好。我们检查 grep 生成的 errors.txt 文件。如果文件存在，无论它是否为空，我们都将此任务视为成功。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建 grep_exception 任务</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/2caaf289505b384a887243e3f69a090c.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*6BHg_Ikk3RQsUaprBaI4zw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">grep 异常</p></figure><p id="efcc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">刷新 DAG 并再次触发它，图形视图将如上所述进行更新。让我们检查文件夹中的输出文件 errors.txt。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/546ea4aaa0dde669c57222ef3b1dc706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWWVYhQlTmmdpQCieZ_0XQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在 errors.txt 中列出最后 5 个异常</p></figure><p id="4113" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们将逐行解析日志，提取我们感兴趣的字段。我们使用一个<em class="mv"> PythonOperator </em>通过一个正则表达式来完成这项工作。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用正则表达式解析异常日志</p></figure><p id="8fce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">提取的字段将保存到数据库中，供以后查询使用。Airflow 支持任何类型的数据库后端，它在数据库中存储元数据信息，在这个例子中，我们将使用 Postgres DB 作为后端。</p><p id="23a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们定义了一个<em class="mv"> PostgresOperator </em>来在数据库中创建一个新表，如果这个表已经存在，它将删除这个表。在真实的场景中，我们可能会将数据追加到数据库中，但是我们应该小心，如果由于某种原因需要重新运行某些任务，可能会将重复的数据添加到数据库中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在 Postgres 数据库中创建一个表</p></figure><p id="c792" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要使用 Postgres 数据库，我们需要在 Airflow 门户中配置连接。我们可以修改现有的 postgres_default 连接，这样在使用<em class="mv"> PostgresOperator </em>或<em class="mv">postgreshawk</em>时就不需要指定连接 id。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/17efeaf998f8d50847f6b7c7072ab5f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_eewrg_dsM82WshfczooQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">修改 postgres_default 连接</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/f1fcfba0aff62a6b3848235233e7b229.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*0RQMHRulON6eERJ_vUuDKw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">配置 postgres_default 连接</p></figure><p id="415f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">太好了，让我们再次触发 DAG。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi on"><img src="../Images/68b022d5084e13be9b2e3e4a0dc41d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*QkbdOouzP6r01Qn3lk2IYw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">解析错误日志</p></figure><p id="b076" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">任务成功运行，所有日志数据都被解析并存储在数据库中。Airflow 提供了一种查询数据库的便捷方式。在“<strong class="kx ir">数据分析</strong>菜单下选择“<strong class="kx ir">临时查询</strong>，然后输入 SQL 查询语句。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/af0569820a8f5deaed5730999a8b1f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*6x7JdPHEFjczqv5LB1c_yA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">即席查询</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/c5f4e24cb81d7621289a29e02f673929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94C-wxAOSYuzcpMbIdjTgg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Postgres 数据库中的错误日志</p></figure><p id="7311" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们可以查询表并统计每种类型的错误，我们使用另一个<em class="mv"> PythonOperator </em>来查询数据库并生成两个报告文件。一个包含数据库中的所有错误记录，另一个是统计表，以降序显示所有类型的错误。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">定义任务以生成报告</p></figure><p id="4ad3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好的，再次触发 DAG。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/411b37a3f9d64e888d0fe670bf2ca435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Zinu0IMMmTGnq6kTlcOyQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">生成报告</p></figure><p id="8ff1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">文件夹中会生成两个报告文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/d31af6bba201a4cebea121ad3f1a0ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*67Zio6Lg3QtCW5EEsS3BKQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">两份报告</p></figure><p id="6c30" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 error_logs.csv 中，它包含数据库中的所有异常记录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/8a546c8d2b46878b530f9da04b439964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oTSZOIb5dSk91PPgwHSgKw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">报告所有例外情况</p></figure><p id="5300" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 error_stats.csv 中，它列出了出现的不同类型的错误。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/8660b310608dee6f372c4860d90b4076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kj3kQ9BxUfkAudtlhbQXOw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">报告不同类型的异常</p></figure><p id="daaf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在最后一步，我们使用一个分支操作符来检查错误列表中的最高出现次数，如果它超过阈值，说 3 次，它将触发发送电子邮件，否则，静静地结束。我们可以在气流变量中定义阈值，然后从代码中读取该值。这样我们就可以在不修改代码的情况下更改阈值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/673d7c54c633a71e399a31d174b89e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*an8vf5YOkGDWfK0ksWRukA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在气流中产生一个变量</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">定义任务以检查错误号</p></figure><p id="61c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mv">branch pythonooperator</em>返回下一个任务的名称，要么发送电子邮件，要么什么都不做。我们使用<em class="mv"> EmailOperator </em>发送电子邮件，它提供了一个方便的 API 来指定收件人、主题、正文字段，并且易于添加附件。我们用<em class="mv"> DummyOperator </em>定义一个空任务。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">电子邮件任务和虚拟任务</p></figure><p id="8ddf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要使用电子邮件操作符，我们需要在 YAML 文件中添加一些配置参数。这里我们定义 Gmail 帐户的配置。您可以在这里输入您的密码，或者使用<a class="ae nr" href="https://support.google.com/mail/answer/185833?hl=en" rel="noopener ugc nofollow" target="_blank">应用程序密码</a>作为您的电子邮件客户端，这样可以提供更好的安全性。</p><pre class="kg kh ki kj gt ns nt nu nv aw nw bi"><span id="e5a9" class="nf mb iq nt b gy nx ny l nz oa">- AIRFLOW__SMTP__SMTP_HOST=smtp.gmail.com<br/>- AIRFLOW__SMTP__SMTP_PORT=587<br/>- AIRFLOW__SMTP__SMTP_USER=&lt;your-email-id&gt;@gmail.com<br/>- AIRFLOW__SMTP__SMTP_PASSWORD=&lt;your-app-password&gt;<br/>- AIRFLOW__SMTP__SMTP_MAIL_FROM=&lt;your-email-id&gt;@gmail.com</span></pre><p id="b58f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">到目前为止，我们创建了工作流中的所有任务，我们需要定义这些任务之间的依赖关系。气流提供了一种非常直观的方式来描述依赖性。</p><pre class="kg kh ki kj gt ns nt nu nv aw nw bi"><span id="af36" class="nf mb iq nt b gy nx ny l nz oa">dl_tasks &gt;&gt; grep_exception &gt;&gt; create_table &gt;&gt; parse_log &gt;&gt; gen_reports &gt;&gt; check_threshold &gt;&gt; [send_email, dummy_op]</span></pre><p id="31a2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们完成了所有的编码部分，让我们再次触发工作流来看看整个过程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/7385a0b53ab0a6164b423cbcdb008858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGKwhjHg4bytWvN_NDyv6A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当任何类型的错误数量超过阈值时发送电子邮件</p></figure><p id="10fd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的例子中，有两种类型的错误，它们都超过了阈值，它将在最后触发发送电子邮件。邮件附有两份报告。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/9ed13ded1c138ce4381210145ec072b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*a8pZrfQ5kai_8L3EoTXPxw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">电子邮件提醒</p></figure><p id="2697" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将阈值变量更改为 60，并再次运行工作流。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/22ff268e5e8c97f78e56ab9535a9420e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKuzAxGhAmZoS0gxuRticA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将阈值更改为 60</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/8439b2a4b5baef8ae270b65a643ee85a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xeBDAbySJQizuBwcvUaCOQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">工作流结束，不发送电子邮件</p></figure><p id="f546" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如您所见，它不会触发发送电子邮件，因为错误数小于 60。工作流无声地结束。</p><p id="6635" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们回到 DAG 视图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/261589966bb57f6ec0498f65fcb3039a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sr4-hnyKjjrp9KZL8LaTFQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">DAG 视图</p></figure><p id="15e2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它列出了所有活动或非活动 DAG 以及每个 DAG 的状态，在我们的示例中，您可以看到，我们的 monitor_errors DAG 成功运行了 4 次，在最后一次运行中，15 个任务成功，1 个任务被跳过，这是最后一个 dummy_op 任务，这是预期的结果。</p><p id="0151" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们的 DAG 计划每天运行，我们可以根据需要更改计划时间，例如每 6 小时或每天的特定时间。</p></div><div class="ab cl oz pa hu pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="ij ik il im in"><p id="5a30" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Airflow 是一个强大的 ETL 工具，它被广泛应用于许多一级公司，如 Airbnb，Google，Ubisoft，Walmart 等。它也受到主要云平台的支持，如 AWS、GCP 和 Azure。它在数据工程和数据处理中发挥着越来越重要的作用。</p><h1 id="1f42" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">密码</h1><p id="40a9" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated"><a class="ae nr" href="https://github.com/kyokin78/airflow" rel="noopener ugc nofollow" target="_blank">https://github.com/kyokin78/airflow</a></p><h1 id="4daf" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">参考</h1><p id="506f" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">[1]https://en.wikipedia.org/wiki/Apache_Airflow<a class="ae nr" href="https://en.wikipedia.org/wiki/Apache_Airflow" rel="noopener ugc nofollow" target="_blank"/></p><p id="33f4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[2]https://airflow.apache.org/docs/stable/concepts.html<a class="ae nr" href="https://airflow.apache.org/docs/stable/concepts.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="3242" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[3]<a class="ae nr" href="https://github.com/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank">https://github.com/puckel/docker-airflow</a></p></div></div>    
</body>
</html>