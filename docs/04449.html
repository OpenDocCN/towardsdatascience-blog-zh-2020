<html>
<head>
<title>Data Science in Finance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">金融中的数据科学</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-science-in-finance-56a4d99279f7?source=collection_archive---------18-----------------------#2020-04-21">https://towardsdatascience.com/data-science-in-finance-56a4d99279f7?source=collection_archive---------18-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a9a3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Python 中历史股价数据的移动平均策略回溯测试</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2f7d643eda653635b1129d26ed760135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*abNNceNHz3mEyp3a"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="5bc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这项工作中，我将从 Yahoo Finance 中提取特定股票代码的历史价格数据，并检查一个简单的策略，看看它是否可以盈利。你可以通过我的 Github <a class="ae kv" href="https://github.com/mardani72/Finance_Moving_Ave_Strategy" rel="noopener ugc nofollow" target="_blank">账号</a>访问这部作品的源代码。</p><p id="3b8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几年前，当我想投资股票市场时，在没有 python 知识的情况下测试一个策略会花费我在各种网站上订阅的费用。坦率地说，在大多数情况下，我对数据筛选和入围的标准并不满意。</p><p id="b3d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们定义一些将在这项工作中使用的概念:<br/>简单移动平均线(SMA):这是一个趋势跟踪指标，可以通过对一组给定的值进行算术平均来计算。换句话说，一组数字或者金融工具的价格相加，然后除以这组数字中的价格数(更多细节请参见 i <a class="ae kv" href="https://www.investopedia.com/terms/m/movingaverage.asp" rel="noopener ugc nofollow" target="_blank"> nvestpedia </a>)。</p><p id="9078" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如:如果我们想计算当前点的 SMA_20 值，我们可以将过去 20 天(或其他时间间隔)的收盘价相加，然后除以 20。</p><p id="d068" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">移动平均线策略建议当短均线穿过长均线时买入，当短均线穿过长均线时卖出。下图是买入信号(SMA_20，红线穿越蓝线，SMA_50)和出场点，反之亦然。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/e4f8cec6583d3732507e55d3a247bd4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IrFfJZB6lPSOWMvlziFXYw.png"/></div></div></figure><h1 id="4c4f" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated"><strong class="ak"> 1-数据提取和准备</strong></h1><p id="acaa" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">历史股价数据可以从各种来源找到，但最简单的是雅虎财经。为此，我们需要导入<em class="mq"> yfinance </em>库和其他相关的库，它们将用于使用 pandas 进行数据操作。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="54c8" class="mw lu iq ms b gy mx my l mz na">import numpy as np<br/>import pandas as pd<br/>import yfinance as yf<br/>import datetime as dt<br/>import matplotlib.pyplot as plt<br/>import mplfinance as mpf</span></pre><p id="adaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要定义我们将检查策略的时间范围。要使用<em class="mq"> yfinace </em>库，日期格式应为 YYYY-MM-DD。将开始日期定义为你最喜欢的时间。你可以对结束日期做同样的事情，但是我更喜欢今天作为结束日期。我们可以将其定义如下:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="04b1" class="mw lu iq ms b gy mx my l mz na">start = '2016-01-01'                # format: YYYY-MM-DD<br/>end = dt.datetime.now()             # today</span></pre><p id="8bb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一步中，将您最喜欢的股票代码 ticker 字符串存储在 stock 变量中。我们打算用它在雅虎财经库中作为数据框下载:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="d290" class="mw lu iq ms b gy mx my l mz na">stock='AMD'<br/>df = yf.download(stock,start, end, interval='1d')<br/>df.head()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/58123138018a6d6c183b2fad20d575ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IzdzrSSbczUVQQdjzxkhBw.jpeg"/></div></div></figure><p id="7a65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我选择了 AMD ticker (Advanced Micro Devices，semiconductor)并使用<em class="mq"> yfinance </em>的下载属性将价格数据存储在数据帧中。有几个参数，我们应该包括如股票名称，开始和结束日期。默认的采样间隔是一天，但是您也可以选择其他间隔。数据框的最后一列是开盘价、最高价、最低价、收盘价、调整后收盘价和交易量。</p><p id="3682" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要查看我们可以为下载功能定义哪些参数，我们可以在 jupyter 笔记本(如下图)中点击功能括号内的<em class="mq"> shift </em> + <em class="mq"> Tab </em>键。如果你向下滚动，它也有每个参数的解释。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/4a2b4c324d52b487cc09bf00ebef3454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X3kniK8Bins2Zl3ckmMO7g.png"/></div></div></figure><h1 id="6ea5" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">2- <strong class="ak">移动平均计算</strong></h1><p id="d7c6" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们来定义短、长简单移动平均线，SMA 变量，并把它们存储在这里名为 SMAs 的列表中。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="5f76" class="mw lu iq ms b gy mx my l mz na">short_sma= 20<br/>long_sma = 50<br/>SMAs=[short_sma, long_sma]</span></pre><p id="1d16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用滚动和均值函数逐个计算每个 SMA 的移动平均值，但是为了使它更灵活地用于两个以上的 SMA，我们可以使用 for 循环，例如:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="e141" class="mw lu iq ms b gy mx my l mz na">for i in SMAs:<br/>    df["SMA_"+str(i)]= df.iloc[:,4].rolling(window=i).mean()</span></pre><p id="5fd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这一行代码表示，将在预定义的时间窗口中使用滚动函数计算每个 SMAs，调整后的收盘价位于数据框的第 5 列。然后，每个 SMA 将被添加为一个新列，名称为 SMA，后缀为我们准备的时间窗口。</p><p id="8d58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了检查结果，我们可以调用 tail 函数来查看数据帧的最后几行。增加了 SMA_20 和 SMA_50。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/ce6edfe17f85e05a8e2467a6b5592932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNQkWVFJG-P6tz9vIvQeMw.png"/></div></div></figure><h1 id="535d" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">3- <strong class="ak"> SMAs 相对位置识别</strong></h1><p id="cf2c" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这部分是均线策略回溯测试的主干。应该定义这两个 SMA 的相对位置，以识别趋势方向。它有简单的基本原则:如果短均线高于长均线，我们在上升趋势区域，在相反的条件下建仓卖出。让我们看看代码:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="d8c1" class="mw lu iq ms b gy mx my l mz na">position=0 # 1 means we have already entered poistion, 0 means not already entered<br/>counter=0<br/>percentChange=[]   # empty list to collect %changes <br/>for i in df.index:<br/>    SMA_short=df['SMA_20']<br/>    SMA_long =df['SMA_50']<br/>    close=df['Adj Close'][i]<br/>    <br/>    if(SMA_short[i] &gt; SMA_long[i]):                          #line 9<br/>        print('Up trend')<br/>        if(position==0):<br/>            buyP=close   #buy price<br/>            position=1   # turn position<br/>            print("Buy at the price"+str(buyP))<br/>        <br/>    elif(SMA_short[i] &lt; SMA_long[i]):<br/>        print('Down trend')<br/>        if(position==1):   # have a poistion in down trend<br/>            position=0     # selling position<br/>            sellP=close    # sell price<br/>            print("Sell at the price"+str(sellP))<br/>            perc=(sellP/buyP-1)*100<br/>            percentChange.append(perc)                      #line 23<br/>    if(counter==df["Adj Close"].count()-1 and position==1):<br/>        position=0<br/>        sellP=close<br/>        print("Sell at the price"+str(sellP))<br/>        perc=(sellP/buyP-1)*100<br/>        percentChange.append(perc)</span><span id="7b03" class="mw lu iq ms b gy ne my l mz na">counter+=1<br/>print(percentChange)</span></pre><p id="bc4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个 for 循环代码块，它将迭代我们先前读入 df 变量的数据集。在从数据框架中定义收盘价、短和长 SMA 后，它将根据短和长 SMA 值使用 if 语句进入两个不同的分支(第 9 行)。如果短均线在长均线之上，它打印出趋势方向(“上升趋势”)，如果投资组合中没有现有头寸，它将根据当天的收盘价买入头寸(信号)。如果短 SMA 的读数比长 SMA 的读数小，则它处于下降趋势。如果我们已经有头寸，我们应该以调整后的收盘价卖出。使用 pandas 中的 append 函数(第 23 行)，我们将把结果存储到一个<em class="mq"> percentChange </em>变量列表中，如前一行所定义的。块代码的最后一部分，从第 24 行开始，是检查是否有一个开放位置，我们正在向下计数到数据帧的末尾。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/d530baa087ed5f698444837990be8140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-78njH7YX1Y_iPhGETxhQ.png"/></div></div></figure><p id="931d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上图中，你可以看到屏幕打印的 lat 部分，它显示了趋势打印、买入和卖出信号以及存储在列表中的所有交易。</p><h1 id="0ba6" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">4-统计</h1><p id="000a" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在定义了一些变量(如收益和损失)和它们的数量后，我们可以对<em class="mq"> perecntChange </em>中的单个值再次使用 for 循环来找出统计信息。列表中的正值表示增益，将在增益变量中累加。负值是损耗，将存储在损耗变量中。我们可以将总回报以百分比的形式打印出来，并将数值四舍五入到小数点后两位。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="3b45" class="mw lu iq ms b gy mx my l mz na">gains=0<br/>numGains=0<br/>losses=0<br/>numLosses=0<br/>totReturn=1<br/>for i in percentChange:<br/>    if(i&gt;0):<br/>        gains+=i<br/>        numGains+=1<br/>    else:<br/>        losses+=i<br/>        numLosses+=1<br/>    totReturn = totReturn*((i/100)+1)<br/>totReturn=round((totReturn-1)*100,2)<br/>print("This statistics is from "+str(df.index[0])+" up to now with "+str(numGains+numLosses)+" trades:")<br/>print("SMAs used: "+str(SMAs))<br/>print("Total return over "+str(numGains+numLosses)+ " trades: "+ str(totReturn)+"%" )</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/41cab4c27a44afcdd126573d03c25d81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qdy5X6kp1RKhOo3H26VbhA.png"/></div></div></figure><p id="e079" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，这个策略建议了 2016 年初的 10 笔交易。这只股票的总回报率超过 850%。</p><p id="c84e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了计算平均收益和损失，我们可以简单地使用 if 语句来查看收益的数量是否大于零。如果是这样，平均增益可以通过增益除以增益数来计算。如果损失数量为正值，它还会计算平均损失。最大的收益和损失也是交易策略的一个吸引人的地方。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="38ed" class="mw lu iq ms b gy mx my l mz na">if (numGains&gt;0):<br/>    avgGain=gains/numGains<br/>    maxReturn= str(max(percentChange))<br/>else:<br/>    avgGain=0<br/>    maxReturn='unknown'</span><span id="7f3b" class="mw lu iq ms b gy ne my l mz na">if(numLosses&gt;0):<br/>    avgLoss=losses/numLosses<br/>    maxLoss=str(min(percentChange))<br/>    ratioRR=str(-avgGain/avgLoss)  # risk-reward ratio<br/>else:<br/>    avgLoss=0<br/>    maxLoss='unknown'<br/>    ratioRR='inf'<br/>print("Average Gain: "+ str(avgGain))<br/>print("Average Loss: "+ str(avgLoss))<br/>print("Max Return: "+ maxReturn)<br/>print("Max Loss: "+ maxLoss)<br/>print("Gain/loss ratio: "+ ratioRR)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/49a713640714f19b1132b2a59b1689b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1pngERzrJ8vAxy0QaCkHcw.png"/></div></div></figure><p id="cf47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，一支股票的平均收益是 62 美元，平均损失几乎是 8 美元。最大收益 153，最大亏损 16 美元。</p><p id="9cd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">击球率的计算方法是将收益数除以总交易数。对于 0 到 1 之间的位置范围，这可能是输入准确性的标志。1 是最准的蝙蝠。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="538d" class="mw lu iq ms b gy mx my l mz na">if(numGains&gt;0 or numLosses&gt;0):<br/>    batAvg=numGains/(numGains+numLosses)<br/>else:<br/>    batAvg=0<br/>print("Batting Avg: "+ str(batAvg))</span></pre><p id="dc5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，击球率是 0.6。</p><h1 id="4c99" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">5-绘图</h1><p id="d6a5" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">虽然您可以使用 seaborn 或 matplotlib 库来绘制股票价格，但是 mplfinance 库是专门为绘制股票价格而设计的。它的函数接受各种属性，如图形大小、价格绘图类型(直线、蜡烛线等)和移动平均线。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="4cac" class="mw lu iq ms b gy mx my l mz na">mpf.plot(df, type = 'ohlc',figratio=(16,6), <br/>         mav=(short_sma,long_sma), <br/>         volume=True, title= str(stock), <br/>         style='default')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/391b589715a87b6a7a367aa4649349f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gKSOqXSbA0iozg7xDPtXWA.png"/></div></div></figure><h1 id="27ba" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated"><strong class="ak">结论</strong></h1><p id="a568" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">使用 python 和其他库，我们能够提取历史股票价格数据，并检查数据上的各种策略。均线策略是一个简单的概念，基于短期和长期均线的价格趋势以及它们之间的相对位置。在这项工作中，我们展示了使用 for 循环和 if 语句方法，我们可以很容易地在历史数据集上检查这种策略。</p><p id="0522" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您有问题或需要更多的澄清，请随时与我联系。</p><blockquote class="nj nk nl"><p id="c1a0" class="kw kx mq ky b kz la jr lb lc ld ju le nm lg lh li nn lk ll lm no lo lp lq lr ij bi translated">声明:这篇文章不是财务建议。它有教育目的。</p></blockquote></div></div>    
</body>
</html>