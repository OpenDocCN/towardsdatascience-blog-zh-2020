<html>
<head>
<title>Using AWS Sagemaker and Lambda to Build a Serverless ML Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Sagemaker和Lambda构建无服务器ML平台</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-aws-sagemaker-and-lambda-function-to-build-a-serverless-ml-platform-f14b3ec5854a?source=collection_archive---------5-----------------------#2020-03-10">https://towardsdatascience.com/using-aws-sagemaker-and-lambda-function-to-build-a-serverless-ml-platform-f14b3ec5854a?source=collection_archive---------5-----------------------#2020-03-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee5e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建一个无服务器的ML应用程序来预测AWS上的航班延误</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e95cb7d3d8ea110eacc929ba061ef887.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VHYPEp2R6Txq8L2F.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AWS Sagemaker徽标</p></figure><p id="6afc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">大多数数据爱好者都知道如何构建和训练模型，但如何部署模型并使其在现实生活中有用，有时对于初学数据的科学家来说是一个具有挑战性的问题。幸运的是，有许多不同的平台和工具可以帮助模型部署。Amazon Sagemaker是我的最爱之一，因为它大大减少了构建、训练和部署模型的努力和犹豫。在众多AWS功能和工具的帮助下，如Lambda function、S3、Dynamo DB，构建一个工作的ML应用程序的整个过程只需点击一下鼠标。</p><p id="0795" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我想演示我们如何利用AWS的能力来构建一个预测航班延误的无服务器ML应用程序。</p><h1 id="7a45" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">目录</h1><ul class=""><li id="12d3" class="mm mn it la b lb mo le mp lh mq ll mr lp ms lt mt mu mv mw bi translated">资料组</li><li id="151c" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">演示架构</li><li id="3a8f" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">创建笔记本实例</li><li id="f105" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">创建Sagemaker端点</li><li id="a828" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">创建Lambda函数</li><li id="4593" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">创建API端点</li><li id="20e3" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">端到端测试</li><li id="57a0" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">结论</li></ul><h2 id="75f1" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">资料组</h2><p id="b771" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">该数据集来自美国交通部，包含2018年721万条飞行记录，共有28列。</p><p id="78f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae nr" href="https://www.kaggle.com/yuanyuwendymu/airline-delay-and-cancellation-data-2009-2018" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://www . ka ggle . com/yuanyuwendymu/airline-delay-and-cancel-data-2009-2018</em></a></p><p id="23c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于数据量很大(721万)，我们使用Google Bigquerry进行数据清洗、预处理和简单的特征工程。由于这个项目的目的是演示AWS如何帮助模型训练和部署，我们不会花太多时间讨论如何用Bigquerry预处理数据(可能是未来的主题)。准备用于训练的已处理数据随后以CSV格式存储到S3存储桶中。现在我们可以开始在AWS上构建我们的演示了</p><h2 id="d4df" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">演示架构</h2><p id="e3b5" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">为了使这个应用程序有用，我们将利用AWS API Gateway和Lambda函数来构建一个API，它接受包含航空公司信息的HTTP POST请求(一个真实的例子可能是一个将航空公司编号作为输入的应用程序或网站)，POST请求将触发Lambda函数来解析值，并将测试数据发送到部署了模型的Sagemaker端点。返回值将再次被Lambda函数解析，并将预测结果发回给用户。架构图展示了从用户输入到预测输出的端到端管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/1fad493975f04ef88c14be1e0f4737be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMKhY5WjDcQ9U44494Hysw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创建的架构图</p></figure><h2 id="be1c" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">创建笔记本实例</h2><p id="c397" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">正如我们前面提到的，预处理的结果存储在一个S3桶中，以方便使用。但是，Sagemaker可以使用不同渠道的数据。比如来自AWS IoT的Dynamo DB、Aurora甚至IoT设备数据。Sagemaker还提供了各种工具来自动调整和选择模型。让我们首先在Sagemaker中创建一个Jupyter notebook实例。从AWS主页中，选择service并进入Sagemaker。并且你会看到下面的选项，选择<strong class="la iu">笔记本实例</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/aa9da6d05775b92087081db1b268763f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZcTnhFdYjy-xaWByIkFkA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Sagemaker控制台</p></figure><p id="906d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你以前从未使用过亚马逊SageMaker，在最初的两个月里，你可以在<strong class="la iu">获得</strong> <strong class="la iu">每月250小时的T2免费等级。中号或者t3。中型笔记本电脑用于构建您的模型，外加50小时m4 </strong>。输入笔记本的名称和实例类型。如果您之前从未创建过IAM角色，请创建一个新角色或使用默认的Sagemaker IAM角色。IAM角色控制实例的资源权限。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f2a829d94a5f8a5960aca35339269998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KvPEdHi2tKaiBp0sbY9Sgg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">笔记本实例配置</p></figure><p id="a4d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">亚马逊SageMaker内置了Jupyter笔记本，允许你用Python、Julia、R或者Scala写代码。我们将在这个项目中使用Python 3。它还提供了笔记本实例启动时加载的示例笔记本列表。每个示例笔记本都有不同的用例，并包含每个步骤的详细注释。我强烈建议初学者仔细阅读这些笔记本，你会对如何使用Sagemakers有一个更好的想法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b4425a4748ed2177e5d3bcd18a3f7c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3azMpAkBM-LZr1UR.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Sagemaker示例笔记本</p></figure><p id="a0f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们创建我们的笔记本，笔记本是基于<em class="ns">乳腺癌预测. ipynb. </em>修改的，你可以通读原始样本。记得更改S3存储桶名称和CSV文件以匹配您的名称。</p><h2 id="8a1d" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">创建Sagemaker端点</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="b74a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后一行代码将删除从笔记本中创建的端点，让我们先注释掉最后一行。然后，您可以通过点击Run All或使用Shift和Enter键逐步运行单元格来执行笔记本。通过运行笔记本，模型被训练和部署，并创建了一个Sagemaker端点。您可以从Amazon SageMaker控制台查看这个端点。您可以将默认端点名称更改为更有意义的名称。</p><h2 id="d85a" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">创建Lambda函数</h2><p id="4645" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">现在我们有了一个SageMaker端点。让我们创建一个Lambda函数来调用端点。它将解析HTTP POST请求，撤销Sagemaker端点，返回预测，解析结果并将其发送回用户。Lambda可以使用boto 3 sage maker-runtime . invoke _ endpoint()来调用端点</p><p id="201b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">AWS Lambda是一个有用的工具，允许开发人员基于每次使用的成本来构建无服务器功能。您还将受益于FaaS更快的开发速度、更简单的操作管理和可伸缩性。从Lambda函数中，从头选择<strong class="la iu">作者</strong>。输入您的函数名，为此项目选择Python 3.6。记住，选择IAM执行角色时，要使用一个策略，该策略允许您的函数调用sagemaker端点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/41f6d94d26357e8664bf99c8814c7863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-eNa-pH1QMMEcaYn5dqsQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda功能配置</p></figure><p id="2391" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是Lambda函数的代码，它使用ENDPOINT_NAME作为环境变量，保存SageMaker端点的名称。记得在环境变量部分将变量分配给端点名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/0ea78ef52fb8bd07a982d2328a65501d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_G2yYYTANEaIP5PHCy9tDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">设置环境变量</p></figure><pre class="kj kk kl km gt oa ob oc od aw oe bi"><span id="59d7" class="nc lv it ob b gy of og l oh oi">import os<br/>import io<br/>import boto3<br/>import json<br/>import csv</span><span id="e06b" class="nc lv it ob b gy oj og l oh oi"># grab environment variables<br/>ENDPOINT_NAME = os.environ['ENDPOINT_NAME']<br/>runtime= boto3.client('runtime.sagemaker')</span><span id="aa53" class="nc lv it ob b gy oj og l oh oi">def lambda_handler(event, context):<br/>    print("Received event: " + json.dumps(event, indent=2))<br/>    <br/>    data = json.loads(json.dumps(event))<br/>    payload = data['data']<br/>    print(payload)<br/>    <br/>    response = runtime.invoke_endpoint(EndpointName=ENDPOINT_NAME,<br/>                                       ContentType='text/csv',<br/>                                       Body=payload)<br/>    print('res is !!!!')<br/>    print(response)<br/>    result = json.loads(response['Body'].read().decode())<br/>    print('result is!!!!')<br/>    print(result)<br/>    pred = int(result['predictions'][0]['score'])<br/>    #pred = int(result['predictions'][0])<br/>    predicted_label = 'delay' if pred == 1 else 'no delay'<br/>    <br/>    return predicted_label</span></pre><h2 id="b524" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">创建API端点</h2><p id="2d98" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">现在我们已经准备好了Lambda函数，让我们创建API来接收HTTP请求并集成一切。您可以按照AWS <a class="ae nr" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-create-api.html" rel="noopener ugc nofollow" target="_blank">文档</a>从API Gateway创建API。或者只是按照这些简单的步骤。</p><ol class=""><li id="0660" class="mm mn it la b lb lc le lf lh ok ll ol lp om lt on mu mv mw bi translated">打开AWS API网关控制台。选择<strong class="la iu">创建API </strong>选择一个API名称，您可以将端点类型设为区域。选择创建API。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/6d6d30da0db2d91b76915ad190988a77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*x_wWdIDdXAEa8v9c.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建新的API</p></figure><p id="382d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.接下来，创建一个<strong class="la iu">资源</strong>从<strong class="la iu">动作</strong>下拉列表中选择，当资源被创建时，从同一个列表中选择<strong class="la iu">创建方法</strong>来创建一个POST方法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/71f979a47bdd9b5d754893f64f2a0e0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*R6KMUUH9Hpl7OjJs.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建方法</p></figure><p id="2218" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.在出现的屏幕上，输入以下内容:对于集成类型，选择Lambda Function。对于Lambda函数，输入您创建的函数</p><p id="d4bb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">4.设置完成后，将API部署到一个阶段。从动作下拉列表中，选择<strong class="la iu">部署API </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/a8b2da7eac061585b8401afff75b4a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*j8BqzWV2-e104sh2.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">部署API</p></figure><p id="a3d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">5.在出现的页面上，创建一个新阶段。并选择部署，这一步将为您提供调用URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/ab9dc9614d8faa53770dbcc92cc55daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yHfzHM2U_8fKd8zW"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">API流程</p></figure><h2 id="782e" class="nc lv it bd lw nd ne dn ma nf ng dp me lh nh ni mg ll nj nk mi lp nl nm mk nn bi translated">端到端测试</h2><p id="c9ca" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">现在我们已经构建了一个无服务器的ML管道，它可以从HTTP POST获取用户数据，并从我们部署的模型返回ML预测结果。我们可以在邮递员身上测试。Postman是一个接口测试工具。做接口测试的时候，Postman就像一个客户端。它可以模拟用户发起的各种HTTP请求，将请求数据发送到服务器，获得相应的响应结果，并验证响应中的结果数据是否与期望值匹配。现在，我们发送一个POST请求到上一步创建的调用Url，它触发Lambda函数并调用我们的Sagemaker端点来进行预测。我们可以看到，我们得到的结果是“不成交”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/8e7ef1064143c87d7b77506ecf14a293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v286vFZMQYFOHabO"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">邮递员测试</p></figure><p id="ca37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">总结思路</strong></p><p id="05ea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">AWS Sagemaker是所有级别的数据科学家和ML应用程序开发人员实现健壮和完整的端到端ML解决方案的一个很好的工具。它可以自动化许多繁琐的工作，如超参数调整，模型选择，甚至数据标记。在Lambda函数的帮助下，ML应用程序可以具有高度的灵活性和成本效益。</p></div><div class="ab cl os ot hx ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="im in io ip iq"><p id="30d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读，我期待听到您的问题和想法。如果你想了解更多关于数据科学和云计算的知识，可以在 <a class="ae nr" href="https://www.linkedin.com/in/andrewngai9255/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> Linkedin </strong> </a> <strong class="la iu">上找我。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/9aee96eef743b6c63259c16bdf76aa82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vz0I260Jddh3CjnY"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae nr" href="https://unsplash.com/@joaosilas?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔·塞拉斯</a>在<a class="ae nr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="f368" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ns">参考</em></p><p id="f8d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae nr" href="https://docs.aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://docs.aws.amazon.com/sagemaker/</em></a></p><p id="480e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae nr" href="https://aws.amazon.com/blogs/machine-learning/call-an-amazon-sagemaker-model-endpoint-using-amazon-api-gateway-and-aws-lambda/" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://AWS . Amazon . com/blogs/machine-learning/call-an-Amazon-sagemaker-model-endpoint-using-Amazon-API-gateway-and-AWS-lambda/</em></a></p></div></div>    
</body>
</html>