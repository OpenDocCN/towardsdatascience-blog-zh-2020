<html>
<head>
<title>Model with TensorFlow and Serve on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 TensorFlow 建模，在 Google 云平台上服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deep-learning-course-v1-guide-81a53c238901?source=collection_archive---------21-----------------------#2020-07-05">https://towardsdatascience.com/deep-learning-course-v1-guide-81a53c238901?source=collection_archive---------21-----------------------#2020-07-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ae73" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">实用指南</h2><div class=""/><div class=""><h2 id="1d14" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在可扩展的云平台上服务 TensorFlow 模型</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/4ec2f3cff7dd6d9f13780ff53125cb52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qx7bctniPtgYRoqvF20UhQ.png"/></div></div></figure><p id="ccda" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在本指南中，我们学习如何开发一个 TensorFlow 模型，并在谷歌云平台(GCP)上提供服务。我们考虑使用 TensorFlow 和 Keras APIs 实现的三层神经网络来预测产品收益的回归问题。</p><p id="becd" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">本指南的主要学习成果是</p><ol class=""><li id="c2fa" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated">在 Tensorflow 中建立、编译和拟合模型</li><li id="3555" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">在 Google colab 中设置 tensorboard</li><li id="1505" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">保存、加载和预测看不见的数据</li><li id="1e3d" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">在 Google 云平台上部署 TensorFlow 模型</li></ol><p id="76dc" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在本指南中，我们将使用 TensorFlow 2.1.0 和 Google colab 运行时环境。我们将使用 google colab 来训练使用 TensorFlow 和 Keras APIS 的模型。从 TensorFlow 2.0 开始，Keras 现在是 TensorFlow 包的一部分。Google colab 在免费的 GPU 和 TPU 上提供机器学习模型的训练。因此，建议环境获得在 GPU 和 TPU 上训练您的深度学习模型的实践经验。而且可以设置 tensorboard，更好的了解模型训练。本指南附带了一个 Google colab 的工作副本，可以帮助您快速入门。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="821e" class="ms mt it mo b gy mu mv l mw mx"># Install TensorFlow &gt;2.0<br/>!pip install tensorflow==2.1.0</span></pre><p id="97b4" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">导入必要的 python 库以及 TensorFlow 和 Keras 函数</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="2746" class="ms mt it mo b gy mu mv l mw mx"># Import libraries<br/>import pandas as pd<br/>from sklearn.preprocessing import MinMaxScaler<br/>import os<br/>import numpy as np<br/>from __future__ import absolute_import, division, print_function, unicode_literals<br/><br/>import tensorflow as tf<br/><br/>from tensorflow.keras.layers import Dense, Flatten, Conv2D<br/>from tensorflow.keras import Model<br/>from tensorflow.keras.models import Sequential, load_model</span></pre><p id="e828" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">加载张量板扩展</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="da15" class="ms mt it mo b gy mu mv l mw mx"># Load tensorboard <br/>%load_ext tensorboard</span></pre><h2 id="edbc" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">为数据安装 Gdrive</h2><p id="7cc6" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">要在 Google colab 环境中访问数据，有多种方法。我最喜欢的一个方法是将数据上传到你的 Google Drive，然后在 colab 中安装 Google Drive。</p><p id="70dd" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">可以从<a class="ae nt" href="https://github.com/amjadraza/blogs-data/tree/master/deep_leraning_tensorflow" rel="noopener ugc nofollow" target="_blank"> data_deep_learning </a>下载用于训练和测试的数据。可以尝试其他开源数据集试试。</p><p id="8f29" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们需要安装 google drive 来读取存储在 google drive 中的数据。下面是最简单的安装方法。您将被要求输入访问过程生成的令牌。你可以参考文章《<a class="ae nt" href="https://medium.com/@prajwal.prashanth22/google-colab-drive-as-persistent-storage-for-long-training-runs-cb82bc1d5b71" rel="noopener">使用 Google Colab GPU VM + Drive 作为长期深度学习训练运行的持久存储</a>》了解更多关于使用 Google drive 作为 Colab 的数据存储的信息。</p><blockquote class="nu nv nw"><p id="cb2b" class="ld le nx lf b lg lh kd li lj lk kg ll ny ln lo lp nz lr ls lt oa lv lw lx ly im bi translated">我已经把数据上传到我的 google drive 上，以便于访问。你可以照着做。</p></blockquote><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="7aa8" class="ms mt it mo b gy mu mv l mw mx">from google.colab import drive<br/>drive.mount('/content/drive')</span><span id="75ba" class="ms mt it mo b gy ob mv l mw mx">Go to this URL in a browser: <br/>Enter your authorization code:<br/>··········<br/>Mounted at /content/drive</span></pre><h2 id="c647" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">加载培训和验证数据</h2><p id="67de" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">我已经将培训和验证数据上传到我的 google drive。出于练习的目的，您可以尝试任何其他开源数据。对于本教程，数据已经准备好进入训练集和测试集，但是在实际问题中，最有可能的是数据必须逐个任务地清理和准备。在我看来，机器学习科学家几乎 50%的工作是准备与机器学习模型兼容的数据</p><blockquote class="nu nv nw"><p id="e1cb" class="ld le nx lf b lg lh kd li lj lk kg ll ny ln lo lp nz lr ls lt oa lv lw lx ly im bi translated">确保培训、有效和测试拆分中没有信息泄漏。</p></blockquote><p id="052f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">最近，杰森·布朗利在他的网站【https://machinelearningmastery.com/blog/. T4】发表了一系列关于数据准备的文章</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="02cf" class="ms mt it mo b gy mu mv l mw mx"># I have already uploaded the data to my google drive<br/><br/>data_path= '/content/drive/My Drive/data_deep_learning_tensorflow/'<br/><br/>output_dir =  '/content/drive/My Drive/Deep_Learning_Course/Ex_Files_Building_Deep_Learning_Apps/'</span></pre><p id="1b7e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">阅读我们问题的训练和测试数据。目标是预测给定产品的总收入，给出下列特征。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="e072" class="ms mt it mo b gy mu mv l mw mx"># Reading the traing and test data<br/>training_data_df = pd.read_csv(data_path + 'sales_data_training.csv')<br/><br/>test_data_df = pd.read_csv(data_path + 'sales_data_test.csv')</span><span id="f68b" class="ms mt it mo b gy ob mv l mw mx">training_data_df.head()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl oc"><img src="../Images/b44e2235a48767badebe6c083c2417c5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cxy2nJLiB9zegoM4cGNHfg.png"/></div></figure><h2 id="a138" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">标准化要素数据</h2><p id="568f" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">标准化是大多数机器学习模型的推荐做法，并已被证明是可行的。Scikit-learn 附带了一些业界信任的转换，用于预处理数据。</p><p id="0a2b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">MinMaxScaler 是 Scikit-learn 转换模块中实现的常用转换之一。它在 0 和 1 之间缩放数据。在输入张量流模型训练之前，建议对训练和测试数据进行归一化。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="423c" class="ms mt it mo b gy mu mv l mw mx">scalar = MinMaxScaler(feature_range=(0,1))<br/>scaled_training = scalar.fit_transform(training_data_df)<br/>scaled_test = scalar.fit_transform(test_data_df)<br/><br/>scaled_training_df = pd.DataFrame(data = scaled_training, columns=training_data_df.columns)<br/>scaled_test_df = pd.DataFrame(data = scaled_test, columns=training_data_df.columns)</span></pre><p id="b863" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们来看看缩放后的数据</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="2a47" class="ms mt it mo b gy mu mv l mw mx">scaled_training_df.head()</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl oc"><img src="../Images/38c8c707cbcd31e9efd238d63b6bc3ab.png" data-original-src="https://miro.medium.com/v2/format:webp/1*i8K3X-hAE5-k5xYRrDe3HQ.png"/></div></figure><p id="bb8b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">对于有监督的机器学习模型，我们将特征和目标分成<code class="fe od oe of mo b">X</code>和<code class="fe od oe of mo b">y</code> NumPy 数组。TensorFlow 模型也是如此，使用这种格式的数据。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="725b" class="ms mt it mo b gy mu mv l mw mx"># Splitting the feature and target columns. Using this dataset, we aim to predict total_earnings<br/>X = scaled_training_df.drop('total_earnings', axis=1).values<br/>Y = scaled_training_df['total_earnings'].values</span></pre><h2 id="c2ce" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">用 Keras 顺序 API 定义张量流模型</h2><p id="c411" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">为了定义深度学习模型，我们使用 TensorFlow 2.1.0 附带的 Keras API 模块。我们从一个具有两个中间<strong class="lf jd"> relu </strong>层的基本模型开始。输入维度是 9，输出维度是 1。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="3e08" class="ms mt it mo b gy mu mv l mw mx"># Define the Model<br/><br/>model = Sequential()<br/><br/>model.add(Dense(50, input_dim=9, activation = 'relu'))<br/><br/>model.add(Dense(100, activation = 'relu'))<br/><br/>model.add(Dense(50, activation = 'relu'))<br/><br/>model.add(Dense(1, activation = 'linear'))<br/><br/>model.compile(loss = 'mean_squared_error', optimizer = 'adam')</span></pre><p id="7124" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">显示定义的模型摘要</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="bf07" class="ms mt it mo b gy mu mv l mw mx">model.summary()</span><span id="f140" class="ms mt it mo b gy ob mv l mw mx">Model: "sequential_1"<br/>_________________________________________________________________<br/>Layer (type)                 Output Shape              Param #   <br/>=================================================================<br/>dense_4 (Dense)              (None, 50)                500       <br/>_________________________________________________________________<br/>dense_5 (Dense)              (None, 100)               5100      <br/>_________________________________________________________________<br/>dense_6 (Dense)              (None, 50)                5050      <br/>_________________________________________________________________<br/>dense_7 (Dense)              (None, 1)                 51        <br/>=================================================================<br/>Total params: 10,701<br/>Trainable params: 10,701<br/>Non-trainable params: 0<br/>_________________________________________________________________</span></pre><p id="a110" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">准备类似于训练数据的测试特征和目标</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="ecd4" class="ms mt it mo b gy mu mv l mw mx">X_test = scaled_test_df.drop('total_earnings', axis=1).values<br/>Y_test = scaled_test_df['total_earnings'].values</span></pre><p id="2134" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">为 tensorboard 安排复试</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="c40b" class="ms mt it mo b gy mu mv l mw mx"># Setup for tensorboard<br/>from datetime import datetime<br/>logdir="logs/scalars/" + datetime.now().strftime("%Y%m%d-%H%M%S")<br/>tensorboard_callback = tf.keras.callbacks.TensorBoard(log_dir=logdir)</span></pre><p id="0648" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">用<code class="fe od oe of mo b">verbose=0</code>和<code class="fe od oe of mo b">epochs=50</code>训练模型，并将测试数据作为验证集。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="c168" class="ms mt it mo b gy mu mv l mw mx"># Train the network<br/>training_history = model.fit(X, Y,<br/>                             epochs = 50,<br/>                             shuffle=True,<br/>                             verbose=0,<br/>                             validation_data=(X_test, Y_test),<br/>                             callbacks=[tensorboard_callback])<br/><br/>print("Average test loss: ", np.average(training_history.history['loss']))</span><span id="e887" class="ms mt it mo b gy ob mv l mw mx">Average test loss:  0.0003906410974522077</span></pre><p id="cbfc" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们在 tensorboard 中显示训练/验证错误</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="78ca" class="ms mt it mo b gy mu mv l mw mx"># Click on the view output full screen from dropdown cell menu if tensorboard does not show up itself<br/>%tensorboard --logdir logs/scalars</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi og"><img src="../Images/88e660b50338409e596497ac6c1bcf8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ORl_06UexOmfff12FNB5Q.png"/></div></div></figure><h2 id="478b" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">验证结果</h2><p id="9a1a" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">训练的验证是任何机器学习框架中非常重要的步骤之一。这里，我们互换使用验证/测试错误。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="f3dc" class="ms mt it mo b gy mu mv l mw mx">test_error_rate = model.evaluate(X_test,<br/>                                 Y_test,<br/>                                 verbose=0)<br/>print('The mean squared error for test data is {}'.format(test_error_rate))</span><span id="39be" class="ms mt it mo b gy ob mv l mw mx">The mean squared error for test data is 0.09696226567029953</span></pre><h2 id="e316" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">对看不见的数据进行预测并保存模型</h2><p id="12dc" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">让我们读取样本输入数据并测试我们的模型，以预测并在本地保存模型供将来使用。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="e15e" class="ms mt it mo b gy mu mv l mw mx"># Read the values of features for new product and test on our traioned model <br/>df_new_products = pd.read_csv(data_path + 'proposed_new_product.csv').values</span><span id="e166" class="ms mt it mo b gy ob mv l mw mx"># Use our trained moel to predict<br/>predictions = model.predict(df_new_products)</span><span id="6682" class="ms mt it mo b gy ob mv l mw mx"># Scaling up the earnings prediction using our Normalisation Parameters<br/>predictions = predictions + 0.1159<br/>predictions = predictions/0.0000036968<br/><br/>print('Earnings predictions for Proposed product - ${}'.format(predictions))</span><span id="9d25" class="ms mt it mo b gy ob mv l mw mx">Earnings predictions for Proposed product - $[[270639.12]]</span><span id="34ed" class="ms mt it mo b gy ob mv l mw mx"># Save the Model<br/><br/>model.save(output_dir + 'trained_model.h5')<br/><br/>print('Trained Model saved at {}'.format(output_dir))</span><span id="ce9f" class="ms mt it mo b gy ob mv l mw mx">Trained Model saved at /content/drive/My Drive/Deep_Learning_Course/Ex_Files_Building_Deep_Learning_Apps/</span></pre><h2 id="9b46" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">检索已保存的预测模型</h2><p id="597c" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">一旦我们对模型感到满意，我们就可以在本地保存这个模型，并且可以用来对看不见的数据进行预测。这个模型可以托管在云上，你可以发送输入数据来获得预测。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="4e1c" class="ms mt it mo b gy mu mv l mw mx"># Importing saved model<br/><br/>model_trained = load_model(output_dir + 'trained_model.h5')</span><span id="02a0" class="ms mt it mo b gy ob mv l mw mx"># Read the values of features for new product and test on our traioned model <br/>df_new_products = pd.read_csv(data_path + 'proposed_new_product.csv').values</span><span id="41ee" class="ms mt it mo b gy ob mv l mw mx">predictions = model_trained.predict(df_new_products)<br/>predictions = predictions + 0.1159<br/>predictions = predictions/0.0000036968<br/><br/>print('Earnings predictions for Proposed product - ${}'.format(predictions))</span><span id="2dd6" class="ms mt it mo b gy ob mv l mw mx">Earnings predictions for Proposed product - $[[270639.12]]</span></pre><h2 id="c502" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">在 Google Cloud 上部署训练模型</h2><p id="9678" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">一旦我们有了训练好的模型，下一个任务就是部署它来为客户服务。有各种可用的部署选项，但在这一节中，我们重点关注在谷歌云人工智能平台上部署它。</p><h2 id="8d65" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">先决条件</h2><p id="be95" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">在 google cloud 上部署 TensorFlow 模型的先决条件是</p><ul class=""><li id="144e" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly oh mf mg mh bi translated">熟悉谷歌云项目</li><li id="7341" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">基本了解存储桶和 it <code class="fe od oe of mo b">gsutils</code>命令行工具</li><li id="0369" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">基本了解与谷歌云交互的<code class="fe od oe of mo b">gcloud</code>命令行工具</li><li id="e046" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">经过训练的 Tensorflow 2.1.0 模型</li><li id="c438" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">阅读下面的指南，了解如何部署机器学习模型的详细信息</li></ul><blockquote class="nu nv nw"><p id="d292" class="ld le nx lf b lg lh kd li lj lk kg ll ny ln lo lp nz lr ls lt oa lv lw lx ly im bi translated"><a class="ae nt" href="https://blog.tensorflow.org/2020/04/how-to-deploy-tensorflow-2-models-on-cloud-ai-platform.html" rel="noopener ugc nofollow" target="_blank">如何在云人工智能平台上部署 TensorFlow 2 模型</a></p></blockquote><p id="7d81" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">通过 colab 验证您的 google 帐户</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="7985" class="ms mt it mo b gy mu mv l mw mx">from google.colab import auth<br/>auth.authenticate_user()</span></pre><p id="c544" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">创建一个谷歌云项目，如果没有做之前和存储模型桶。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="2fef" class="ms mt it mo b gy mu mv l mw mx"># GCP project name<br/>CLOUD_PROJECT = 'gcpessentials-rz'<br/>BUCKET = 'gs://' + CLOUD_PROJECT + '-tf2-models'</span></pre><p id="ab5f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">将所需的项目设置为在 colab 环境中使用的默认环境变量。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="1c79" class="ms mt it mo b gy mu mv l mw mx"># Set the gcloud consol to $CLOUD_PROJECT 9Environment Variable for your Desired Project)<br/>!gcloud config set project $CLOUD_PROJECT</span><span id="27e1" class="ms mt it mo b gy ob mv l mw mx">Updated property [core/project].</span></pre><p id="70cc" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">使用<code class="fe od oe of mo b">gsutil</code>命令行实用程序创建 Bucket。您可以使用 python API 来创建存储桶。现在让我们坚持使用命令行方法。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="19f2" class="ms mt it mo b gy mu mv l mw mx"># Create the storage bucket for tf2 Models<br/>!gsutil mb $BUCKET<br/>print(BUCKET)</span><span id="ddf6" class="ms mt it mo b gy ob mv l mw mx">Creating gs://gcpessentials-rz-tf2-models/...<br/>gs://gcpessentials-rz-tf2-models</span></pre><p id="ff8d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">将 TensorFlow 模型保存到刚刚创建的存储桶中。您可以确认模型文件是从 google 控制台图形用户界面上传的。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="2e51" class="ms mt it mo b gy mu mv l mw mx">MODEL = 'earnings-prediction'<br/>model.save(BUCKET + f'/{MODEL}', save_format='tf')</span><span id="9abc" class="ms mt it mo b gy ob mv l mw mx">WARNING:tensorflow:From /usr/local/lib/python3.6/dist-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.<br/>Instructions for updating:<br/>If using Keras pass *_constraint arguments to layers.<br/>INFO:tensorflow:Assets written to: gs://gcpessentials-rz-tf2-models/earnings-prediction/assets</span></pre><h2 id="3fd3" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">服务于模型的配置</h2><p id="76b8" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">有两种方法可以设置在 google cloud 上服务的模型。第一个是使用 GCP 图形控制台，另一个是使用 gcloud 命令行工具，如<a class="ae nt" href="https://blog.tensorflow.org/2020/04/how-to-deploy-tensorflow-2-models-on-cloud-ai-platform.html" rel="noopener ugc nofollow" target="_blank">如何在云 AI 平台上部署 TensorFlow 2 模型</a>中所述。我跟随 GCP 控制台进行了这次部署。一些关键点</p><ul class=""><li id="8c16" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly oh mf mg mh bi translated">确保您的模型数据上传到存储桶中</li><li id="e523" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">建议对您的模型和存储桶使用相同的区域(有时会产生问题)。</li><li id="5435" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">请耐心等待，创建模型/版本可能需要几分钟时间</li><li id="1ddc" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">第一次做的时候，仔细阅读所有的说明</li></ul><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="9999" class="ms mt it mo b gy mu mv l mw mx">!gcloud ai-platform versions create $VERSION \<br/>  --model $MODEL \<br/>  --origin $MODEL_DIR \<br/>  --runtime-version=2.1 \<br/>  --framework='tensorflow' \<br/>  --python-version=3.7</span></pre><h2 id="3637" class="ms mt it bd my mz na dn nb nc nd dp ne lm nf ng nh lq ni nj nk lu nl nm nn iz bi translated">获取已部署模型的预测</h2><p id="9164" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">一旦部署了模型，并且您可以看到绿色的勾号，就该测试模型的预测了。一些需要考虑的要点。</p><ul class=""><li id="6114" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly oh mf mg mh bi translated">使用<strong class="lf jd">测试&amp;测试模型预测使用您的版本或模型选项卡下的</strong>选项卡。</li><li id="1d8b" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">输入 JSON 数据取决于您如何定义您的模型</li></ul><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="0314" class="ms mt it mo b gy mu mv l mw mx"># [Reference](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/ml_engine/online_prediction/predict.py)<br/><br/>import googleapiclient.discovery<br/><br/>def predict_json(project, model, instances, version=None):<br/><br/>    service = googleapiclient.discovery.build('ml', 'v1')<br/>    name = 'projects/{}/models/{}'.format(project, model)<br/><br/>    if version is not None:<br/>        name += '/versions/{}'.format(version)<br/><br/>    response = service.projects().predict(<br/>        name=name,<br/>        body={'instances': instances}<br/>    ).execute()<br/><br/>    if 'error' in response:<br/>        raise RuntimeError(response['error'])<br/><br/>    return response['predictions']</span></pre><p id="1fc9" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">加载看不见的数据进行预测</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="101d" class="ms mt it mo b gy mu mv l mw mx">df_new_products = pd.read_csv(data_path + 'proposed_new_product.csv')</span><span id="1c4e" class="ms mt it mo b gy ob mv l mw mx">df_new_products</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl oc"><img src="../Images/5f0654e9c365bab5532d73d9fdeb49f8.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wlxju36stSlkUlDM4l6Jgg.png"/></div></figure><p id="f960" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">将数据转换成 JSON 格式，以便与上面写的<code class="fe od oe of mo b">predict_json</code>程序兼容。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="7edf" class="ms mt it mo b gy mu mv l mw mx">tdata_instances = {'dense_input':df_new_products.values[0].tolist()}</span><span id="7686" class="ms mt it mo b gy ob mv l mw mx">predictions_gcloud = predict_json(CLOUD_PROJECT, 'earnings_prediction', tdata_instances, version='v1')<br/>predictions_gcloud = predictions_gcloud[0]['dense_3'][0] + 0.1159<br/>predictions_gcloud = predictions_gcloud/0.0000036968<br/><br/>print('Earnings predictions for Proposed product - ${}'.format(predictions_gcloud))</span><span id="dfce" class="ms mt it mo b gy ob mv l mw mx">Earnings predictions for Proposed product - $261848.21778936993</span></pre><h1 id="2e48" class="oi mt it bd my oj ok ol nb om on oo ne ki op kj nh kl oq km nk ko or kp nn os bi translated">谷歌 Colab 笔记本</h1><p id="d357" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">按照下面的谷歌合作笔记本来复制和实践这个指南。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h1 id="afc1" class="oi mt it bd my oj ok ol nb om on oo ne ki op kj nh kl oq km nk ko or kp nn os bi translated">结论</h1><p id="a40a" class="pw-post-body-paragraph ld le it lf b lg no kd li lj np kg ll lm nq lo lp lq nr ls lt lu ns lw lx ly im bi translated">在本指南中，我们学习了使用 TensorFlow 2.1.0 训练深度学习模型，并将训练好的模型部署在谷歌云平台上。以下是指南的重点。</p><ul class=""><li id="b99f" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly oh mf mg mh bi translated">安装 TensorFlow 2.1..google colab 中的 0</li><li id="697f" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">在 google colab 中设置 tensorboard</li><li id="60e4" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">使用 TensorFlow 构建、编译和训练模型</li><li id="f8a6" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">评估并保存训练好的模型</li><li id="7b1e" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">加载已保存的模型以根据看不见的数据进行预测</li><li id="b876" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">在 Google Cloud 上部署模型</li><li id="53fe" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly oh mf mg mh bi translated">使用云中部署的模型进行预测</li></ul><h1 id="c74e" class="oi mt it bd my oj ok ol nb om on oo ne ki op kj nh kl oq km nk ko or kp nn os bi translated">参考资料/阅读/链接</h1><ol class=""><li id="bc86" class="lz ma it lf b lg no lj np lm ov lq ow lu ox ly me mf mg mh bi translated"><a class="ae nt" href="https://blog.tensorflow.org/2020/04/how-to-deploy-tensorflow-2-models-on-cloud-ai-platform.html" rel="noopener ugc nofollow" target="_blank">https://blog . tensor flow . org/2020/04/how-to-deploy-tensor flow-2-models-on-cloud-ai-platform . html</a></li><li id="e568" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">https://scikit-learn.org/stable/modules/preprocessing.html<a class="ae nt" href="https://scikit-learn.org/stable/modules/preprocessing.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="8a99" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">【https://www.tensorflow.org/tutorials/keras/regression T4】</li><li id="0653" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated"><a class="ae nt" href="https://www.tensorflow.org/tutorials/keras/save_and_load" rel="noopener ugc nofollow" target="_blank">https://www.tensorflow.org/tutorials/keras/save_and_load</a></li></ol></div></div>    
</body>
</html>