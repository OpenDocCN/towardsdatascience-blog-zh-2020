<html>
<head>
<title>Building a simple web scraped COVID-19 Visualization with Bokeh by Region</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立一个简单的网页刮新冠肺炎可视化与散景按地区</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-simple-web-scraped-covid-19-visualization-with-bokeh-by-region-84aa351f668?source=collection_archive---------29-----------------------#2020-04-22">https://towardsdatascience.com/building-a-simple-web-scraped-covid-19-visualization-with-bokeh-by-region-84aa351f668?source=collection_archive---------29-----------------------#2020-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="88e0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">每个数据问题都始于良好的可视化</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6509a313ecce2f31fda3e051d82e193c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ksq8qJa32TiFCY3O"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@jchmrt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jochem Raat </a>拍摄的照片</p></figure><p id="175c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就像任何数据爱好者所说的那样；有洞察力的数据可视化使我们能够获得对问题的直觉，对于任何类型的问题解决都是一个很好的起点，而不仅仅是数据繁重的问题。</p><p id="8661" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个项目中，我致力于开发一个可视化工具，让人们了解我所在地区(加拿大安大略省)的哪些县市仍然是当前新冠肺炎疫情的重灾区。</p><p id="5f1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将需要什么:</p><ol class=""><li id="c330" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">要可视化的区域的shapefile。我使用了大多数GIS(地理信息软件)生成的. shp文件格式。这里有一个<a class="ae kv" href="http://www.geographynetwork.ca/website/obm/viewer.htm" rel="noopener ugc nofollow" target="_blank">来源</a>的链接。(这是近20年前的资料，因此不是最新的)</li><li id="ce4b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">Bokeh和GoogleMaps包已安装。在终端/命令提示符下安装软件包的代码如下:</li></ol><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="4cb2" class="ml mm iq mh b gy mn mo l mp mq"><strong class="mh ir">pip</strong> <strong class="mh ir">install</strong> bokeh<br/><strong class="mh ir">pip install</strong> googlemaps</span></pre><p id="9d99" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们加载数据和必要的库。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="5218" class="ml mm iq mh b gy mn mo l mp mq"><strong class="mh ir">import</strong> requests<br/><strong class="mh ir">import</strong> numpy as np<br/><strong class="mh ir">import</strong> pandas as pd<br/><strong class="mh ir">import</strong> googlemaps<br/><strong class="mh ir">import</strong> geopandas as gpd<br/><strong class="mh ir">import</strong> seaborn<br/><strong class="mh ir">from</strong> shapely.geometry <strong class="mh ir">import</strong> Point, Polygon</span></pre><p id="3886" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面这段简单的代码支持将数据集自动下载、写入(或覆盖)到所选的目的地。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="39e4" class="ml mm iq mh b gy mn mo l mp mq">url = ‘<a class="ae kv" href="https://data.ontario.ca/dataset/f4112442-bdc8-45d2-be3c-12efae72fb27/resource/455fd63b-603d-4608-8216-7d8647f43350/download/conposcovidloc.csv'" rel="noopener ugc nofollow" target="_blank">data_source_url'</a><br/>myfile = requests<strong class="mh ir">.get</strong>(url)<br/><strong class="mh ir">open</strong>(‘data/conposcovidloc.csv’, ‘wb’).<strong class="mh ir">write</strong>(myfile.<strong class="mh ir">content</strong>)</span></pre></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="0f3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可能是一个简单的周末项目的很大一部分原因是因为data.ontario.ca的研究员保持了数据的干净。然而，我们确实需要将数据集塑造成更好地用于此目的的方式。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="1f78" class="ml mm iq mh b gy mn mo l mp mq">covid_19 = pd.<strong class="mh ir">read_csv</strong>(‘covid_19_data_path.csv’)</span><span id="830f" class="ml mm iq mh b gy my mo l mp mq">cv0 = pd.<strong class="mh ir">get_dummies</strong>(covid_19, columns = [‘OUTCOME1’,’CLIENT_GENDER’,’Age_Group’])<br/># this creates dummy variables for the categorical variables names<br/>cv0 = cv0.<strong class="mh ir">drop</strong>(cv0.columns[0],axis = 1)<br/>cv0 = cv0.<strong class="mh ir">replace</strong>(0,np.nan)</span><span id="2966" class="ml mm iq mh b gy my mo l mp mq">cv1 = cv0.<strong class="mh ir">groupby</strong>(['Reporting_PHU','Reporting_PHU_Latitude','Reporting_PHU_Longitude','Reporting_PHU_City']).<strong class="mh ir">count</strong>().<strong class="mh ir">reset_index</strong>()</span></pre><p id="752d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的代码块做了几件好事。首先，它使分类变量的结果，客户性别和年龄组列。但是，这就产生了np。NaN对象，我们希望在新创建的分类变量中使用零。上面的最后一行按可视化和。count()方法将NaN对象转换为零。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="3e89" class="ml mm iq mh b gy mn mo l mp mq">Counties = gpd.<strong class="mh ir">read_file</strong>(‘geo_data_path.shp’)<br/>Counties = Counties.<strong class="mh ir">sort_values</strong>(‘OFF_NAME’)<br/>for <strong class="mh ir">i,v</strong> in <strong class="mh ir">enumerate</strong>(city_order):<br/> city = cv1[‘Reporting_PHU_City’][v]<br/> county_city.<strong class="mh ir">append</strong>(city)<br/> <br/>Counties[‘CITY’]=county_city</span></pre><p id="a20a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们加载了地理数据。本项目中使用的地理数据源不包含报告新冠肺炎病例的公共卫生城市的数据。<em class="mz"> city_order </em>是一个包含列表索引的列表，我们可以从新冠肺炎数据集中的列Reporting _ PHU _城市生成该列表。这为合并两个数据集创建了一个起点。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="a0e9" class="ml mm iq mh b gy mn mo l mp mq"># longitude must always come before latitude<br/>geometry = [<strong class="mh ir">Point</strong>(xy) for xy in zip(cv1[‘Reporting_PHU_Longitude’],cv1[‘Reporting_PHU_Latitude’])]<br/>geo_cv = gpd.<strong class="mh ir">GeoDataFrame</strong>(cv1, geometry = geometry)</span></pre><p id="6fc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个简单的代码块做得相当不错。它根据城市的经度和纬度创建几何图形，并由此创建新的地理数据框架。</p><p id="592e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我使用<em class="mz">均值归一化</em>进行了一些基本的特征缩放，以产生一个更具代表性的疫情迄今为止受灾最严重的城市分布。然后，新列应合并成一个数据帧，用于散景图。</p><p id="61f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是数据帧的快照:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="467e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后两个代码块在GoogleMaps库的帮助下生成散景图。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="88fc" class="ml mm iq mh b gy mn mo l mp mq">import json<br/>from <strong class="mh ir">bokeh</strong>.io import output_notebook, show, output_file<br/>from <strong class="mh ir">bokeh</strong>.plotting import figure<br/>from <strong class="mh ir">bokeh</strong>.models import GeoJSONDataSource,LinearColorMapper, ColorBar, Label, HoverTool<br/>from <strong class="mh ir">bokeh</strong>.models import Range1d, ColorMapper<br/>from <strong class="mh ir">bokeh</strong>.models.glyphs import MultiLine<br/>from <strong class="mh ir">bokeh</strong>.palettes import brewer, mpl</span><span id="39e0" class="ml mm iq mh b gy my mo l mp mq">api_key = ‘<strong class="mh ir"><em class="mz">YOUR_API_KEY</em></strong>’<br/>gmaps = googlemaps.<strong class="mh ir">Client</strong>(key=api_key)</span><span id="d663" class="ml mm iq mh b gy my mo l mp mq">#Read data to json and convert to string-like object<br/>Counties_json = json.<strong class="mh ir">loads</strong>(Counties.<strong class="mh ir">to_json</strong>())<br/>json_data = json.<strong class="mh ir">dumps</strong>(Counties_json)</span><span id="1dde" class="ml mm iq mh b gy my mo l mp mq">#Provide GeoJSONData source for plotting.<br/>geosource = GeoJSONDataSource(geojson = json_data)</span><span id="480b" class="ml mm iq mh b gy my mo l mp mq">#Repeat for geo_cv GeoPandas DataFrame<br/>geo_csv_json = json.<strong class="mh ir">loads</strong>(geo_cv.<strong class="mh ir">to_json</strong>())<br/>json_data2 = json.dumps(geo_csv_json)geosource2 = GeoJSONDataSource(geojson = json_data2)</span></pre><p id="191f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而对于剧情本身。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="d434" class="ml mm iq mh b gy mn mo l mp mq">fig = figure(title = ‘Ontario Covid 19 Cases by Municipality’, plot_height = 750 , plot_width = 900<br/> ,active_scroll=’wheel_zoom’)<br/>fig.<strong class="mh ir">xgrid</strong>.<strong class="mh ir">grid_line_color</strong> = None<br/>fig.<strong class="mh ir">ygrid</strong>.<strong class="mh ir">grid_line_color</strong> = None</span><span id="1e14" class="ml mm iq mh b gy my mo l mp mq"># initialize the plot on south and eastern ontario<br/>left, right, bottom, top = -83.5, -74.0, 41.5, 47.0<br/>fig.<strong class="mh ir">x_range</strong>=Range1d(left, right)<br/>fig.<strong class="mh ir">y_range</strong>=Range1d(bottom, top)</span><span id="af15" class="ml mm iq mh b gy my mo l mp mq"># Creating Color Map by Recovery Rate<br/>palette1 = brewer[‘RdYlGn’][11] <br/>cmap1 = LinearColorMapper(palette = palette1,<br/> low = Counties[‘PERCENTAGE_TOTAL_log’].<strong class="mh ir">min</strong>(),<br/> high = Counties[‘PERCENTAGE_TOTAL_log’].<strong class="mh ir">max</strong>())</span><span id="3033" class="ml mm iq mh b gy my mo l mp mq">cmap2 = LinearColorMapper(palette = palette1,<br/> low = geo_cv[‘TOTAL_CASES’].<strong class="mh ir">min</strong>(),<br/> high = geo_cv[‘TOTAL_CASES’].<strong class="mh ir">max</strong>())</span><span id="cd29" class="ml mm iq mh b gy my mo l mp mq">#Add patch renderer to figure. <br/>f2 = fig.<strong class="mh ir">patches</strong>(‘xs’,’ys’, source = geosource, line_color = ‘black’, line_width = 0.25, line_alpha = 0.9, fill_alpha = 0.6,<br/> fill_color = {‘field’:’PERCENTAGE_TOTAL_log’,’transform’:cmap1})</span><span id="eac5" class="ml mm iq mh b gy my mo l mp mq">fig.<strong class="mh ir">add_layout</strong>(ColorBar(color_mapper=cmap2, location=’bottom_right’,label_standoff=10))</span><span id="c2d1" class="ml mm iq mh b gy my mo l mp mq">hover2 = HoverTool(renderers = [f2], tooltips = [(‘Municipality Name’,’<a class="ae kv" href="http://twitter.com/OFF_NAME" rel="noopener ugc nofollow" target="_blank">@OFF_NAME</a>’)])<br/>fig.add_tools(hover2)</span><span id="e168" class="ml mm iq mh b gy my mo l mp mq">f1 = fig.<strong class="mh ir">circle</strong>(x=’Reporting_PHU_Longitude’,y=’Reporting_PHU_Latitude’,size = 10,<br/> color = ‘black’, line_color = ‘white’, source = geosource2, fill_alpha = 0.55)<br/>hover1 = HoverTool(renderers = [f1], tooltips=[(‘Health Unit’,’<a class="ae kv" href="http://twitter.com/Reporting_PHU" rel="noopener ugc nofollow" target="_blank">@Reporting_PHU</a>’)<br/> ,(‘Health Unit City’,’<a class="ae kv" href="http://twitter.com/Reporting_PHU_City" rel="noopener ugc nofollow" target="_blank">@Reporting_PHU_City</a>’)<br/> ,(‘Fatalities’,’<a class="ae kv" href="http://twitter.com/Outcome1_Fatal" rel="noopener ugc nofollow" target="_blank">@Outcome1_Fatal</a>’)<br/> ,(‘Percentage Recovered’,’<a class="ae kv" href="http://twitter.com/PERCENTAGE_Recovered" rel="noopener ugc nofollow" target="_blank">@PERCENTAGE_Recovered</a>’),(‘Total Cases’,’<a class="ae kv" href="http://twitter.com/TOTAL_CASES" rel="noopener ugc nofollow" target="_blank">@TOTAL_CASES</a>’)<br/> ,(‘Male to Female Ratio’,’<a class="ae kv" href="http://twitter.com/GENDER_RATIO1" rel="noopener ugc nofollow" target="_blank">@GENDER_RATIO1</a>')])b</span><span id="559f" class="ml mm iq mh b gy my mo l mp mq">fig.<strong class="mh ir">add_tools</strong>(hover1)<br/>output_notebook()<br/>show(fig)</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nb l"/></div></figure></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><h1 id="9dc8" class="nd mm iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">感谢您的关注，我相信您会发现这很有价值</h1><p id="ac95" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">请随时通过以下平台联系我</p><p id="94cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://twitter.com/MeloKanjo" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae kv" href="https://www.linkedin.com/in/kanjo-melo/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>，<a class="ae kv" href="https://github.com/jomelo23" rel="noopener ugc nofollow" target="_blank"> Github </a>或者在Medium上关注我！</p></div></div>    
</body>
</html>