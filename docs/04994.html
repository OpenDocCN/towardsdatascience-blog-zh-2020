<html>
<head>
<title>Automated Scraping using AWS Lambda (with Layers), AWS S3, and Current Super Bowl Odds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 AWS Lambda(带层)、AWS S3 和当前超级碗赔率的自动刮擦</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automated-scraping-using-aws-lambda-with-layers-aws-s3-and-current-superbowl-odds-dc7f9c6d27b1?source=collection_archive---------26-----------------------#2020-04-30">https://towardsdatascience.com/automated-scraping-using-aws-lambda-with-layers-aws-s3-and-current-superbowl-odds-dc7f9c6d27b1?source=collection_archive---------26-----------------------#2020-04-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="162f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于如何在 AWS 上设置一个自动刮刀的指南，没有漂亮的 Soup 或 Selenium…一路上还带着相当多的戏谑！</h2></div><blockquote class="ki kj kk"><p id="f5fa" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">*注意:这篇文章假设读者已经了解基本的 AWS Lambda 和 S3 功能。简单介绍一下 AWS 快速入门指南:<a class="ae li" href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started.html" rel="noopener ugc nofollow" target="_blank"> Lambda </a>和<a class="ae li" href="https://docs.aws.amazon.com/quickstarts/latest/s3backup/step-1-create-bucket.html" rel="noopener ugc nofollow" target="_blank"> S3 </a></p></blockquote><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/7c5b83eb1411d802f3e6e8a33a7bd5b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*ewg-6IjdBZPGDN6r0Y6qaQ.gif"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">开炮！(由<a class="ae li" href="https://giphy.com/nfl/" rel="noopener ugc nofollow" target="_blank"> NFL </a>通过<a class="ae li" href="https://giphy.com/gifs/nfl-tampa-bay-buccaneers-l3vRiQESRDKkl9qta" rel="noopener ugc nofollow" target="_blank"> Giphy </a>拍摄)</p></figure><h1 id="e0ee" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">好吧…首先，让我们来解决房间里的大象。</h1><p id="d83d" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">是的，我是坦帕湾海盗队的球迷。不，我不是因为他们签了汤姆·布拉迪才开始喜欢他们的。我从 10 岁起就是一个粉丝，在坦帕以南大约一小时车程的地方长大，他们认为他们的新制服/标志比 creamsicle 的制服和 Bucco Bruce 的标志酷得多。为了完全透明，在今年 3 月 20 日之前，我不是 TB12 的粉丝。也就是说，我不记得有哪一次我对 NFL 橄榄球赛在秋季回归如此兴奋。去年，海盗队在传球码数方面领先联盟。布雷迪和埃文斯、戈德温、格隆考斯基和霍华德是一伙的吗？？？开炮！希望到九月来临的时候，世界会变得更好(通俗地说)，雷蒙德·詹姆斯体育场会被点亮！！！</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/9dcdd346198dd754a02dcf78b24c74dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*8Odvps-1b2_y9ANDy__t-A.gif"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">NFC South 就要被干掉了！(照片由<a class="ae li" href="http://nbcsports.tumblr.com/post/107421040869" rel="noopener ugc nofollow" target="_blank"> NBC 体育</a>通过<a class="ae li" href="https://giphy.com/gifs/rob-gronkowski-gronk-tall-yWhBLGwP9nFVm" rel="noopener ugc nofollow" target="_blank"> Giphy </a>拍摄)</p></figure><p id="c84b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">海盗队签下布雷迪后不久，我看了看超级碗赔率，发现海盗队的赔率是+2600。如果你不熟悉美国博彩赔率，这意味着 100 美元的赌注，赌徒赢得了 2700 美元的总支出。就背景而言，堪萨斯城酋长队是目前赢得 2021 年超级碗的最大热门，目前的赔率在+550 到+650 之间，这取决于你检查的体育博彩赔率。在+2600 的情况下，我下了一个小赌注，如果成功的话，会有一笔可观的支出。</p><blockquote class="mw"><p id="f2ca" class="mx my it bd mz na nb nc nd ne nf lh dk translated">" Andrew，这篇文章不应该是关于实现自动化的 AWS Lambda 吗？"</p></blockquote></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="6ee5" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">最近，我一直在试图为一篇新的博客文章想一个新的主意，将我学到的一种流行的 AWS 服务结合起来。在听说海盗队也签下了罗布·格隆考斯基后不久，我开始思考我的赌注，赔率将如何变化，以及我如何分析未来 9-10 个月的走势。排队文章灵感！</p><p id="6658" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">在本帖中，我们将:</p><ul class=""><li id="e308" class="nn no it ko b kp kq ks kt mp np mr nq mt nr lh ns nt nu nv bi translated">创建一个 Lambda 函数，该函数将剔除当前超级碗赔率</li><li id="3016" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">创建 Lambda 层以便于访问</li><li id="2b21" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">使用 CloudWatch 自动执行每天的抓取功能</li></ul><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/3a4e02ee1998f89527e83e046a366d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*-zhXW4aiHGkXVLjLyk4gZg.gif"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">赢得比赛的超级猫头鹰(照片由<a class="ae li" href="https://giphy.com/pbsdigitalstudios/" rel="noopener ugc nofollow" target="_blank"> PBS </a>通过<a class="ae li" href="https://giphy.com/gifs/pbsdigitalstudios-pbs-owl-l3q2EftwJ1tCBmDfy" rel="noopener ugc nofollow" target="_blank"> Giphy </a>拍摄)</p></figure><h1 id="7c1a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">自动气象站λ</h1><p id="0ce7" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">我第一次接触 AWS Lambda 是在去年，当时一位同事听到我谈论我如何学习使用 AWS EC2 部署应用程序。他们解释了我为什么不需要一台 24/7 全天候运行的服务器来运行我选择的脚本或 scraper。相反，他们让我去调查 AWS Lambda。</p><blockquote class="ki kj kk"><p id="3ee4" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">“AWS Lambda 允许您在不提供或管理服务器的情况下运行代码。您只需为消耗的计算时间付费。有了 Lambda，你可以为几乎任何类型的应用程序或后端服务运行代码——所有这些都无需管理。只需上传你的代码，Lambda 就会为你的代码提供高可用性的运行和扩展。您可以将代码设置为从其他 AWS 服务自动触发，或者直接从任何 web 或移动应用程序调用它。”— <a class="ae li" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> <strong class="ko iu"> AWS 链接</strong> </a></p></blockquote><p id="e9ea" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">厉害！但是，作为一名数据科学家，我经常使用像 pandas 或 scikit-learn 这样的库。这两个库都没有预装在 Lambda 环境中。这意味着如果您想要包含除 AWS SDK 之外的库和依赖项，您需要创建一个部署包。此外，作为一名程序员，我学到的第一个概念是避免重复相同的代码。我希望尽可能地高效，不希望每次只需要几行代码就能实现目标时，就创建一个大的部署包。这就是λ层非常有益的地方。</p><ul class=""><li id="474d" class="nn no it ko b kp kq ks kt mp np mr nq mt nr lh ns nt nu nv bi translated">在继续阅读之前，请转到 AWS 控制台，创建一个基本的 Lambda 函数和一个具有基本 Lambda 权限的新执行角色。我们将使用这个λ向前移动；稍后我会详细讨论执行角色权限。</li></ul><h1 id="7229" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">λ层</h1><p id="26b5" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">兰姆达斯像洋葱，这意味着他们也像食人魔(和冻糕！).</p><div class="lk ll lm ln gt ab cb"><figure class="oc lo od oe of og oh paragraph-image"><img src="../Images/620fded9e2239053c539981fa73171b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*ZA5T0bBTNjq8Z_zE75l9VA.gif"/></figure><figure class="oc lo oi oe of og oh paragraph-image"><img src="../Images/610b24d9566af5049c8449298a96678a.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*cw8wWxam0HvRuh3HCyej7g.gif"/><p class="lr ls gj gh gi lt lu bd b be z dk oj di ok ol translated">"不是每个人都喜欢洋葱。"(左图来自<a class="ae li" href="https://tenor.com/view/shrek-onions-gif-5703242" rel="noopener ugc nofollow" target="_blank">男高音</a> |右图来自<a class="ae li" href="https://memes.getyarn.io/yarn-clip/763df806-2f86-4cbd-bb7c-83548c0ac283/gif" rel="noopener ugc nofollow" target="_blank">纱线</a>)</p></figure></div><blockquote class="ki kj kk"><p id="ec15" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">“您可以配置 Lambda 函数，以层的形式引入额外的代码和内容。层是包含库、自定义运行时或其他依赖项的 ZIP 存档。通过层，您可以在函数中使用库，而无需将它们包含在部署包中。”<br/>-<a class="ae li" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">-<strong class="ko iu">AWS 链接</strong>-</a></p></blockquote><p id="86c8" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">我真的希望在我花几天时间开发几个 Lambdas 之前就知道层的功能，因为调试过程会容易一百万倍。在构建 Chrome 扩展(仍在构建中)的过程中，我为应用程序中运行的三个主要 Lambdas 创建了一个大型部署包。浪费了相当多的时间，因为我不得不等待开发包的构建和上传，只是为了测试代码中的简单编辑。本质上，使用层类似于在虚拟环境中安装库。在某些时候，你必须在你的虚拟环境中安装这个库来使用它的代码，这基本上就是你在 AWS 上要做的事情。</p><p id="f678" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">本教程的主要目的是向你展示如何自动化你的 Lambda 函数。大声喊出来<a class="ae li" href="https://medium.com/@qtangs" rel="noopener"> Quy Tang </a>他的<a class="ae li" href="https://medium.com/@qtangs/creating-new-aws-lambda-layer-for-python-pandas-library-348b126e9f3e" rel="noopener">教程是关于如何为 Python 的熊猫库</a>创建一个新的 AWS Lambda 层。它非常简单，可以快速启动并运行，并且我能够修改 Python 3.7 的代码。在浏览该指南时，我注意到的唯一区别是运行这段代码时得到的文件夹结构:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="8783" class="or lw it on b gy os ot l ou ov">./get_layer_packages.sh<br/>zip -r my-Python36-Pandas23.zip .</span></pre><div class="lk ll lm ln gt ab cb"><figure class="oc lo ow oe of og oh paragraph-image"><img src="../Images/969fe4c7c4c37d70876bd9a9e224abe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*OMKcaORvZavZwd_Fj0rn5A.png"/></figure><figure class="oc lo ox oe of og oh paragraph-image"><div role="button" tabindex="0" class="oy oz di pa bf pb"><img src="../Images/cab1a6f27dd9dd25dbabe4c7958bc662.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*NgGn35PI-XbId9xZOTTbiw.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk pc di pd ol translated">【左】前面提到的<a class="ae li" href="https://medium.com/@qtangs/creating-new-aws-lambda-layer-for-python-pandas-library-348b126e9f3e" rel="noopener">教程</a>的结果(图片由<a class="ae li" href="https://medium.com/@qtangs" rel="noopener">曲唐</a>拍摄)。[右]运行代码时的结果(作者截图)。</p></figure></div><p id="9bdb" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">这两种文件夹结构都适用于上传到 AWS Lambda 层。如果您运行的是 Python 3.7，那么您将需要适当的 Docker 映像。在您的<code class="fe pe pf pg on b">.sh</code>脚本中，将<code class="fe pe pf pg on b">.6</code>改为<code class="fe pe pf pg on b">.7</code>:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="a68e" class="or lw it on b gy os ot l ou ov">lambci/lambda:build-python3.7</span></pre><p id="6492" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">对于这个应用程序，我想避免使用 BeautifulSoup 和 Selenium，因为我想让它尽可能地轻便，并且我想使用 pandas 为我们提供的有用功能，<code class="fe pe pf pg on b">pd.read_html(&lt;URL_HERE&gt;)</code>。要记住的重要一点是，为了让<code class="fe pe pf pg on b">.read_html()</code>正常工作，你试图从中检索信息的网站必须有一个 HTML 格式的表格。当我想获取的唯一数据是 HTML 表中的数据时，我喜欢使用这个函数。对于我的个人项目，我还需要为<code class="fe pe pf pg on b">requests</code>库做一个单独的 Lambda 层。我需要这样做，因为我想访问的一个站点返回 403 响应，并需要特定的头来发出 GET 请求。(同样，因为库<a class="ae li" href="https://aws.amazon.com/blogs/compute/upcoming-changes-to-the-python-sdk-in-aws-lambda/" rel="noopener ugc nofollow" target="_blank">不包含在 AWS SDK </a>中)。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/00c75e03b725462645a96e7bc9a4c351.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*hUHk5r3if42dJ74XIGOQjQ.png"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者截图</p></figure><p id="1262" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated"><em class="kn">*注:在我的调试过程中，我了解到</em> <code class="fe pe pf pg on b">lxml</code> <em class="kn">库需要调用上面的</em> <code class="fe pe pf pg on b">pd.read_html()</code> <em class="kn">函数才能得到响应。我在请求层中安装了</em> <code class="fe pe pf pg on b">lmxl</code> <em class="kn">只是为了方便自己。我本来可以专门为</em> <code class="fe pe pf pg on b">lxml</code> <em class="kn">再做一层的。</em></p><p id="a497" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">在谷歌上快速搜索“当前超级碗赔率”会有很多潜在的选项。在这篇文章中，我将只演示抓取<a class="ae li" href="https://www.vegasinsider.com/nfl/odds/futures/" rel="noopener ugc nofollow" target="_blank">一个网站</a>，我之所以选择它是因为它过于简单，格式陈旧。理论上，你可以随意抓取任意多的网站。在我的私人版本中，我从 3 个其他来源获取数据，这些数据似乎是实时更新的。这三个来源不是体彩本身，但为市场上一些最可信的体彩提供了现场赔率。实时更新对我来说很重要，因为我的下一篇博文将是关于获取由特定事件触发的文本通知。我能想到的描述这一点的最好例子来自硅谷的<a class="ae li" href="https://en.wikipedia.org/wiki/Silicon_Valley_(TV_series)" rel="noopener ugc nofollow" target="_blank">T4，在那里</a><a class="ae li" href="https://www.youtube.com/watch?v=t_L0UPmxgho&amp;start=26" rel="noopener ugc nofollow" target="_blank">吉尔福伊尔正在接收他的比特币价格变动通知</a>。</p><h1 id="476b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">编码的时间到了:</h1><p id="9e9e" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">此时，你应该已经创建了一个 Lambda 和一两个不同的层。让我们深入一小段代码和自动化过程。下面是我们将在 Lambda 中实现的第一部分代码:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="420d" class="or lw it on b gy os ot l ou ov">import json<br/>import requests<br/>import pandas as pd<br/>from fractions import Fraction<br/>from functools import reduce<br/>from datetime import datetime, timedelta</span><span id="d66f" class="or lw it on b gy pi ot l ou ov"># set the URL<br/>url = '<a class="ae li" href="https://www.vegasinsider.com/nfl/odds/futures/'" rel="noopener ugc nofollow" target="_blank">https://www.vegasinsider.com/nfl/odds/futures/'</a></span><span id="c404" class="or lw it on b gy pi ot l ou ov"># define the dataframe; located in the 6th index position<br/>df = pd.read_html(url)[6]</span><span id="b89c" class="or lw it on b gy pi ot l ou ov"># limit the dataframe to the 32 teams/rows we want<br/>df = df.iloc[:32, :-1]</span><span id="fe8d" class="or lw it on b gy pi ot l ou ov"># label the columns<br/>df.columns = ['team', 'odds']</span><span id="2f7a" class="or lw it on b gy pi ot l ou ov"># convert the fraction to American odds<br/>df.odds = df.odds.apply(lambda x: 100*float(Fraction(x)))</span><span id="c82f" class="or lw it on b gy pi ot l ou ov"># format the row into string w/ "+"<br/>df.odds = df.odds.apply(lambda x: '+' + str('%g'%(x)))</span></pre><h2 id="1fc8" class="or lw it bd lx pj pk dn mb pl pm dp mf mp pn po mh mr pp pq mj mt pr ps ml pt bi translated">好了，我们的数据已经格式化了，现在我们需要保存它:</h2><p id="1df4" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">这就是 AWS S3(简单存储服务)发挥作用的地方。前往 AWS 控制台的 S3 部分，创建一个基本的 S3 桶。一旦您完成了创建 bucket，请返回 Lambda 控制台。为了让你的 Lambda 能够访问 S3 桶，我们必须给 Lambda 这样做的权限。您可以在第一次实例化 Lambda 时授予它权限，也可以在创建后编辑权限。我们将选择后者。以下是步骤:</p><p id="f4cf" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">首先，点击 Lambda 中的“Permissions”选项卡。接下来，单击您的“执行角色:角色名称”下面的 URL 链接，这将打开一个带有身份和访问管理(IAM)控制台的新选项卡。接下来，单击标有“附加策略”的蓝色大按钮。最后，在过滤搜索中搜索“S3 ”,并选择“AmazonS3FullAccess”并附加策略。</p><p id="6635" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">既然我们的 Lambda 拥有 S3 权限，那么是时候进行更多编码了:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="7620" class="or lw it on b gy os ot l ou ov"># instantiate S3 object<br/>s3 = boto3.client('s3')</span><span id="3469" class="or lw it on b gy pi ot l ou ov"># set datetime str w/ EST timezone adjustment and Daylight Savings<br/>if datetime.now().month in range(4,11):<br/>    day_and_time = (timedelta(hours=-4) + datetime.now())<br/>else:<br/>    day_and_time = (timedelta(hours=-5) + datetime.now())<br/>day_and_time = day_and_time.strftime("%b-%d-%Y-%H%M%S")</span><span id="5299" class="or lw it on b gy pi ot l ou ov"># the two different file paths used for uploading<br/>scraped_file_path = '/tmp/SB_odds_' + str(day_and_time) + '.csv'<br/>path_name_for_bucket = scraped_file_path[5:]</span><span id="f45e" class="or lw it on b gy pi ot l ou ov"># create csv file<br/>output = final.to_csv(scraped_file_path, index=True)</span><span id="debb" class="or lw it on b gy pi ot l ou ov"># upload the new csv file to S3<br/>s3.upload_file(f'{scraped_file_path}', '&lt;YOUR_S3_BUCKET_NAME_STR&gt;', f'{path_name_for_bucket}')</span><span id="49b8" class="or lw it on b gy pi ot l ou ov"># define a simple lambda handler<br/>def lambda_handler(event, context):<br/>    return {<br/>    'body': json.dumps('SUCCESS: The SB odds have been scraped!'),<br/>    'date and time':day_and_time<br/>}</span></pre><p id="d4e2" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">在定义<code class="fe pe pf pg on b">lambda_handler()</code>函数时，不需要返回字典内容(或者根本不需要任何东西)。我写这段代码是因为当你运行一个测试时，看到输出是一种视觉享受。我稍后会解释更多关于时区和夏令时的调整，但是需要注意的是文件路径格式不包含任何空格。在继续之前，请确保测试您的函数并检查您的相关 S3 桶以获得结果文件。</p><h1 id="550c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">大获成功！</h1><div class="lk ll lm ln gt ab cb"><figure class="oc lo pu oe of og oh paragraph-image"><img src="../Images/b9b4c9c5e0deec262fe8140628166e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*CPDuyYzdyQn0u476RpHlBg.gif"/></figure><figure class="oc lo pu oe of og oh paragraph-image"><img src="../Images/1cd3c395b012554d31fa6b0aa19bad7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*XQicFcRERBg6As5cCAe0PA.gif"/><p class="lr ls gj gh gi lt lu bd b be z dk oj di ok ol translated">祝贺安迪·雷德、马霍斯、蜜獾和所有 2020 KC 酋长队获得冠军！(<a class="ae li" href="https://giphy.com/nfl" rel="noopener ugc nofollow" target="_blank"> NFL </a>通过<a class="ae li" href="http://giphy.com" rel="noopener ugc nofollow" target="_blank"> Giphy </a>拍摄的<a class="ae li" href="https://giphy.com/gifs/nfl-TFBx2muuRkJ1jquFQT" rel="noopener ugc nofollow" target="_blank">左</a>和<a class="ae li" href="https://giphy.com/gifs/nfl-LNfkiwcd378LxrXy89" rel="noopener ugc nofollow" target="_blank">右</a>照片)</p></figure></div><p id="fabe" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">如果你还在继续，你应该有一个 Lambda (w/ Layers)可以将一个<code class="fe pe pf pg on b">.csv</code>文件推送到你的 S3 桶中。然而，现在唯一能触发 Lambda 执行的事情是在控制台中按下“test”按钮。</p><h1 id="f2a8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">自动化来了！</h1><p id="b3b3" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">这个过程的下一步是设置一个自动触发器，在你想要的时间执行你的 lambda 函数。为了实现这一点，我们将使用 CloudWatch AWS 服务，更具体地说是一个 cron 作业。</p><blockquote class="ki kj kk"><p id="8e67" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><a class="ae li" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank">“cloud watch 为您提供数据和可操作的见解，以监控您的应用、响应系统范围的性能变化、优化资源利用率，并获得运营状况的统一视图。”</a></p></blockquote><p id="e711" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">CloudWatch 有很多功能，但是我们将只使用它来执行我们的 cron 任务。一般来说，Cron 用于运行预定的进程(例如:定期删除不再需要的日志文件)。你可以在这本<a class="ae li" href="https://www.ostechnix.com/a-beginners-guide-to-cron-jobs/" rel="noopener ugc nofollow" target="_blank">初学者指南</a>中读到更多关于 cron jobs 的内容。重要的一点是，我们将为一个函数设定一个时间，让它按照指定的时间表执行。AWS 控制台的 cron 表达式时间格式为:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="d82e" class="or lw it on b gy os ot l ou ov">&lt;Minute&gt; &lt;Hour&gt; &lt;Day_of_month&gt; &lt;Month&gt; &lt;Day_of_week&gt; &lt;Year&gt;</span></pre><p id="fadd" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">这些字段中的每一个都应该填入一个数值，数字之间只有一个空格。此外，我们将利用两个方便的 cron 通配符，<code class="fe pe pf pg on b">*</code>和<code class="fe pe pf pg on b">?</code>。<code class="fe pe pf pg on b">*</code>通配符代表字段中的所有值(例如:在小时字段中，<code class="fe pe pf pg on b"><strong class="ko iu">*</strong></code>将包括每个小时)，而<code class="fe pe pf pg on b">?</code>通配符代表我们的星期值，因为我们不关心它是星期几。<a class="ae li" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions" rel="noopener ugc nofollow" target="_blank">这里有一个链接，包含了 AWS 上 cron 表达式可用的所有不同通配符。对于这个博客，我们将设置 cron 作业每天在美国东部时间 08:00 执行。请完成所有这些步骤，我将在以下段落中解释这是怎么回事:</a></p><ul class=""><li id="3712" class="nn no it ko b kp kq ks kt mp np mr nq mt nr lh ns nt nu nv bi translated">前往<a class="ae li" href="https://console.aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank">云手表控制台</a>。</li><li id="e7d3" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">在左侧，单击“规则”选项卡，然后单击蓝色的“创建规则”按钮。</li><li id="ffc5" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">在“步骤 1”页面的左侧，选择“计划”选项，然后选择“cron 表达式”选项。</li><li id="caef" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">输入<code class="fe pe pf pg on b">00 12 * 04–10 ? 2020</code>作为您的 cron 表达式。</li><li id="c082" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">在“步骤 1”页面的右侧，单击“添加目标”按钮。</li><li id="3e85" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">在下拉菜单中，分别选择“Lambda function”和您的特定功能。</li><li id="b22e" class="nn no it ko b kp nw ks nx mp ny mr nz mt oa lh ns nt nu nv bi translated">最后，单击“配置详细信息”按钮，并填写下一页上的名称和描述框。</li></ul><p id="b29d" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">您可能已经注意到时间表中有一个“固定费率”选项。我不确定每天执行的确切时间，我想精确一些，所以我选择了“cron expression”。因为这篇文章是关于获得超级碗赔率的，所以我想设置刮刀每天运行直到下一次超级碗。我还没有想出用一个表达式来做这件事的方法，所以我们将重复这个过程四次来创建单独的规则。夏令时于 11 月 1 日结束，因此我们需要用两个表达来表示 2020 年。我们还需要一份 2021 年 1 月的，一份 2021 年 2 月 1 日至 2 月 7 日的。三个 cron 表达式将使用<code class="fe pe pf pg on b">—</code>(破折号)操作符来指定月或日值的范围:</p><pre class="lk ll lm ln gt om on oo op aw oq bi"><span id="07b6" class="or lw it on b gy os ot l ou ov">00 12 * 04-10 ? 2020</span><span id="4b74" class="or lw it on b gy pi ot l ou ov">00 13 * 11-12 ? 2020</span><span id="c2d6" class="or lw it on b gy pi ot l ou ov">00 13 * 1 ? 2021</span><span id="d24a" class="or lw it on b gy pi ot l ou ov">00 13 1-7 2 ? 2021</span></pre><p id="c9ab" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">到目前为止，您可能已经注意到 AWS CloudWatch 的执行时间是 GMT。除非你住在那个时区的某个地方，否则你会想根据你的时区来调整你的计划时间。这就是为什么我们在为<code class="fe pe pf pg on b">.csv</code>文件路径设置日期时间字符串时进行了时间增量调整。在创建了四个规则中的每一个之后，您应该已经准备好了。</p><h1 id="2576" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结束语</h1><p id="4858" class="pw-post-body-paragraph kl km it ko b kp mn ju kr ks mo jx ku mp mq kx ky mr ms lb lc mt mu lf lg lh im bi translated">你有它；一个自动铲运机，将填充你的 S3 桶每天与当前超级碗赔率！如果您想测试您的 cron 表达式并立即看到结果，只需将表达式的时间值编辑为从现在起 5 分钟(GMT)并稍事休息。5 分钟后，你的 S3 里会有一个新的<code class="fe pe pf pg on b">.csv</code>。</p><p id="aeb5" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated">感谢阅读！如果你喜欢这篇文章，请发送一些中等掌声，并关注我的页面，以便将来发布。希望，你现在可以创建自己的自动铲球，不会像中场休息时的左鲨鱼一样。</p><div class="lk ll lm ln gt ab cb"><figure class="oc lo pv oe of og oh paragraph-image"><img src="../Images/609dbf7cfae48b615def5acd1849e511.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*Ot5WfOgb-zgykKV5wmcKvQ.gif"/></figure><figure class="oc lo pw oe of og oh paragraph-image"><img src="../Images/4338540212b4ed15e3cb0e70e49b0be4.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/1*jALYlfD6XIEm0gUO3mFQiw.gif"/><p class="lr ls gj gh gi lt lu bd b be z dk px di py ol translated">lolz(左图来自<a class="ae li" href="https://tenor.com/view/sharks-katy-perry-concert-dancing-gif-3718657" rel="noopener ugc nofollow" target="_blank">男高音</a> |右图来自<a class="ae li" href="https://giphy.com/gifs/super-bowl-shark-i-have-no-idea-what-im-doing-lXiRG1vwLewnehlxS" rel="noopener ugc nofollow" target="_blank"> Giphy </a>)</p></figure></div><p id="a924" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku mp kw kx ky mr la lb lc mt le lf lg lh im bi translated"><em class="kn">本文的项目托管在</em> <a class="ae li" href="https://github.com/SproulHimself/aws_lambda_layer_blog" rel="noopener ugc nofollow" target="_blank"> <em class="kn"> Github </em> </a> <em class="kn">上。</em></p></div></div>    
</body>
</html>