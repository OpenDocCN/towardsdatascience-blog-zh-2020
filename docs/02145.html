<html>
<head>
<title>Extracting data from semi-structured tweets using Pandas and regex</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pandas和regex从半结构化推文中提取数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/extracting-data-from-semi-structured-tweets-using-pandas-and-regex-2f293588c1dd?source=collection_archive---------22-----------------------#2020-02-29">https://towardsdatascience.com/extracting-data-from-semi-structured-tweets-using-pandas-and-regex-2f293588c1dd?source=collection_archive---------22-----------------------#2020-02-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="46f5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用系列字符串函数和正则表达式从文本中提取数字数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b499a9883676374259f1e248f9571eb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QQmIYiX734TsqEtF"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">华盛顿州渡口。在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@jetcityninja?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">奥克</a>拍摄的照片</p></figure><p id="4eaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，我们将华盛顿州渡轮推文转化为以小时为单位的等待时间。推文有一些结构，但似乎不是自动化的。目标是转变:</p><ul class=""><li id="1146" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">Edm/King —埃德蒙兹和金斯敦码头状态—等待2小时</li><li id="f910" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —金斯敦码头状态—等待两小时</li><li id="6907" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —埃德蒙兹终端状态—等待一小时</li><li id="788d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —离开埃德蒙兹的司机无需长时间等待</li><li id="9985" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —从金斯敦和埃德蒙兹出发需等待一小时</li></ul><p id="0708" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输入特定位置的等待时间(以小时为单位)(例如，埃德蒙兹:2，n/a，1，0，1。金斯敦:2，2，不适用，不适用，1。)</p><p id="a9ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有趣的是，还有一些更不标准的推文:</p><ul class=""><li id="43e5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">Edm/King —更新—埃德蒙兹和金斯敦码头状态，2小时Edm，1小时King</li><li id="bc38" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">EDM/King——在金斯敦没有长时间等待——在埃德蒙兹等待一小时，晚班船</li><li id="0ba3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —金斯敦早上6:25发车取消。一小时，等等</li><li id="0fc0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">EDM/King——从埃德蒙兹或金斯敦出发不再需要长时间等待</li><li id="9d45" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —埃德蒙兹和金斯敦码头状态—等待2小时</li><li id="5a7f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Edm/King —埃德蒙兹终端状态—等待90分钟</li><li id="f429" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Ed/Ki —埃德蒙兹等待时间— 60分钟</li></ul><p id="5619" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到，这是一个非常特殊的任务，但它可以转移到各种设置，例如1)操作Pandas字符串系列数据，2)使用正则表达式在字符串中搜索目标信息。所以我们去兜兜风吧！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/777ee6fccf0d53335c1eaef5fab43b6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZLj8MtAxpBRDQhXl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@chadpeltola?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">查德·佩尔托拉</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="9140" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">用熊猫操纵弦系列</h1><p id="b75f" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在任何清理之前，我的推文实际上(大部分)遵循这样的模式:Edm/King——无论什么——无论什么……有时[没有] WSP登机牌……链接到华盛顿州轮渡通知页面”。我想删除这些对我当前意图无用的部分，以得到我需要的位置和时间数据。</p><p id="1297" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">pandas通过Series.str.method()方便地提供了各种字符串处理方法。点击查看总结文档<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/text.html#method-summary" rel="noopener ugc nofollow" target="_blank">。向上滚动查看更多创意和使用细节。</a></p><p id="b20a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，我使用了<code class="fe nh ni nj nk b">.str.lower()</code>、<code class="fe nh ni nj nk b">.str.strip()</code>和<code class="fe nh ni nj nk b">.str.replace()</code>。注意<code class="fe nh ni nj nk b">.str.replace()</code>默认为regex=True，不像基本的python字符串函数。</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="88fc" class="np ml it nk b gy nq nr l ns nt"># changing text to lowercase and removing the url, <br/>df['tweet_text'] = df['tweet_text'].str.lower()\<br/>                                   .str.replace('https:.*', '')</span><span id="f4ae" class="np ml it nk b gy nu nr l ns nt"># removing route indicator ('edm/king -'), extra whitespace<br/>df['tweet_text'] = df['tweet_text'].str.replace('edm/king -', '')\<br/>                                   .str.strip()</span><span id="3786" class="np ml it nk b gy nu nr l ns nt"># removing wsp boarding pass indicataor<br/>wsp = ', no wsp boarding pass required|, wsp boarding pass required'<br/>df['tweet_text'] = df['tweet_text'].str.replace(wsp, '')</span></pre><p id="a9b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还用它将我的列名从['Tweet permalink '，' Tweet text '，' time']修改为['tweet_permalink '，' tweet_text '，' time']</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="d538" class="np ml it nk b gy nq nr l ns nt">df.columns = df.columns.str.lower().str.replace(‘ ‘, ‘_’)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/6b11bbe0a4e7629a2380f950c77a1d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YjMxhqC5xZFGSOxp"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@jordansteranka?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jordan Steranka </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h1 id="33e6" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">使用正则表达式(regex)</h1><h2 id="832c" class="np ml it bd mm nw nx dn mq ny nz dp mu li oa ob mw lm oc od my lq oe of na og bi translated">正则表达式。包含带有或的()</h2><p id="fc13" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我想说，如果tweet.contains('1 '或' 1 '或' 60分钟')，那么返回1。</p><p id="2637" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，python字符串没有方法<code class="fe nh ni nj nk b">.contains()</code>。您可以使用<code class="fe nh ni nj nk b">bool(string.find() +1)</code>来解决这个问题。但是这个不支持正则表达式。所以我的代码应该是这样的:</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="e933" class="np ml it nk b gy nq nr l ns nt">if (bool(tweet.find('1') +1) or bool(tweet.find('one') +1)<br/>    or bool(tweet.find('60 minute')):<br/>  <br/>    return 1</span></pre><p id="8900" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">取而代之的是正则表达式，我将我的bool转换计数减少到1:</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="bbc9" class="np ml it nk b gy nq nr l ns nt">if bool(re.search('1|one|60 minute', tweet)): return 1</span></pre><p id="0d57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，如果您只是检查一个字符串在另一个字符串中，您可以像这样使用基本python的<code class="fe nh ni nj nk b">in</code>:</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="4976" class="np ml it nk b gy nq nr l ns nt">if 'one' in tweet:</span></pre><h2 id="abf2" class="np ml it bd mm nw nx dn mq ny nz dp mu li oa ob mw lm oc od my lq oe of na og bi translated">正则表达式匹配多种方式来表达同一件事</h2><p id="faca" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">完全披露，这需要一点点的试验和错误为我的情况。在识别出其中包含等待时间的推文后，我想对没有(延长)等待的推文进行适当的分类，并将它们与没有等待时间的推文(“埃德蒙兹码头等待时间标志停止服务”)和碰巧没有等待时间的推文(“金斯敦码头等待时间——一小时”)区分开来。没有wsp登机牌”)。</p><p id="2fad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里你需要在你的文本中寻找模式。我决定使用“no”后跟不确定数量的字符(在正则表达式句点(。)代表任何字符，星号(*)代表任何重复次数)，后跟“等待”。</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="ab9d" class="np ml it nk b gy nq nr l ns nt">bool(re.search('no.*wait', text))</span></pre><p id="f105" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在评估等待时间之前，我确实切断了非常常见的“[不] wsp登机牌”和华盛顿州渡轮更新网页的持续链接。这有助于简化文本搜索过程，减少意外匹配导致的错误机会。</p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><p id="6705" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">额外提示:将多个csv加载到单个数据帧中。使用<code class="fe nh ni nj nk b">glob</code>获取所有匹配正则表达式路径名的文件。在这种情况下，我需要数据文件夹中以csv结尾的所有文件。从那里，您可以读取它们中的每一个(这里有一个元组理解和<code class="fe nh ni nj nk b">pd.read_csv()</code>，并使用<code class="fe nh ni nj nk b">pd.concat()</code>将它们连接在一起</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="c82d" class="np ml it nk b gy nq nr l ns nt">import glob</span><span id="0985" class="np ml it nk b gy nu nr l ns nt">all_files = glob.glob("./data/*.csv")</span><span id="9931" class="np ml it nk b gy nu nr l ns nt">df_from_each_file = (pd.read_csv(f) for f in all_files)<br/>df = pd.concat(df_from_each_file, ignore_index=True)</span></pre></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><p id="8a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像往常一样，查看GitHub <a class="ae ky" href="https://github.com/allisonhonold/tweets_to_data_ferry_wait_blog" rel="noopener ugc nofollow" target="_blank"> repo </a>中的完整代码。编码快乐！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/7e0aa9b4444dfcfdb720c80f0dcb02cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CKl5pnv4hVY6HDbz"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@lidyanada?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Lidya Nada </a>拍摄的照片</p></figure></div></div>    
</body>
</html>