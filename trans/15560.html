<html>
<head>
<title>Quick Guide to Dockerized Training in AWS Sagemaker (with Code Example)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Sagemaker中的文档化培训快速指南(带代码示例)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/quick-guide-to-dockerized-training-in-aws-sagemaker-with-code-example-94909c17556c?source=collection_archive---------50-----------------------#2020-10-26">https://towardsdatascience.com/quick-guide-to-dockerized-training-in-aws-sagemaker-with-code-example-94909c17556c?source=collection_archive---------50-----------------------#2020-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="bab5" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="9c0e" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">带上您自己的代码，只需几个步骤就可以利用云计算的强大功能！</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/4212a41d8c9567398247b061449b838d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Patp4pnNd9OPdEPTh95zaw.jpeg"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@guibolduc?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Guillaume Bolduc </a>在<a class="ae le" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c6e0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">训练一个模型是乏味的，尤其是当训练脚本耗尽了你所有的计算机能力，你除了等待什么也做不了的时候。这种情况总是发生在我身上——无论是在我开始模型构建过程时，还是在我通过参数调整最终确定模型时。幸运的是，大型云供应商提供了在云中培训和部署您的模型的解决方案，而不必使用您的本地容量。AWS、Azure和GCP都有类似的产品，我在这里使用AWS Sagemaker来展示如何使用自己的容器化docker来训练云中的模型。</p><p id="6dce" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">谈到配置，云培训通常是我的噩梦。不同的云供应商有不同的存储、实例和API结构，这意味着我们必须通读手册和开发指南才能正常工作。我开始用Sagemaker的时候也有这种感觉。但是，我发现Sagemaker SDK非常强大，而不是查看他们的控制台并试图在UI中找到解决方案。Sagemaker的典型用法或宣传用法是通过它们的预建算法。但是除非你只是购买一个基线模型，否则你必须使用你自己的模型代码。当然，你可以研究他们的手册，学习如何调整或修改他们的算法API，但我相信还有更有效的方法。</p><p id="2e64" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">所以我创建了这个初学者指南来展示一种利用Sagemaker训练实例的方法，同时保持使用docker训练自己代码的能力。希望解决方案能帮助到有需要的人！</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="3d6f" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">先决条件</h2><p id="d85d" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">这个练习需要一些先决条件。如果您以前使用过Sagemaker SDK，可以跳过这一部分。否则，请仔细遵循设置。</p><ul class=""><li id="ad86" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nk nl nm nn bi translated"><strong class="lh ja"> AWS CLI安装&amp;设置</strong></li></ul><p id="44b8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">检查此<a class="ae le" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-mac.html" rel="noopener ugc nofollow" target="_blank">链接</a>，根据您使用的系统按照说明下载并安装AWS CLI。本教程中的示例是使用Mac-OS。</p><p id="980a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果您没有AWS帐户，您可以免费注册一个(注意:这将需要您的信用卡信息，并确保阅读<a class="ae le" href="https://aws.amazon.com/free/?trk=ps_a134p000003yBfvAAE&amp;trkCampaign=acq_paid_search_brand&amp;sc_channel=ps&amp;sc_campaign=acquisition_US&amp;sc_publisher=google&amp;sc_category=core&amp;sc_country=US&amp;sc_geo=NAMER&amp;sc_outcome=acq&amp;sc_detail=%2Baws%20%2Bfree&amp;sc_content=Cost_bmm&amp;sc_segment=438195701024&amp;sc_medium=ACQ-P|PS-GO|Brand|Desktop|SU|AWS|Core|US|EN|Text&amp;s_kwcid=AL!4422!3!438195701024!b!!g!!%2Baws%20%2Bfree&amp;ef_id=Cj0KCQjw28T8BRDbARIsAEOMBcwCR5zop0jeg0l-y_gNpAIpY2hDfRX6e6Vh4evFgjOkWi7cb-ZFRDIaAmeoEALw_wcB:G:s&amp;s_kwcid=AL!4422!3!438195701024!b!!g!!%2Baws%20%2Bfree&amp;all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc" rel="noopener ugc nofollow" target="_blank"> free-tier </a>优惠，以防产生任何费用)。</p><p id="ce65" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">登录到控制台并导航到IAM。创建一个用户并附加SagemakerFullAccess策略。另外，在<strong class="lh ja">安全凭证</strong>下创建一个<strong class="lh ja">访问密钥</strong>，并下载凭证。csv文件。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/d905d6a8dbde8bcb6655fc6c26257fad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wXJtoQqimEekT1TGo94NRA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">AWS IAM控制台</p></figure><p id="16b3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">安装AWS CLI后，您可以使用凭据进行设置。您刚刚设置的csv文件。在终端中，键入以下内容:</p><p id="a611" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe np nq nr ns b">aws configure</code></p><p id="aa4a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果您的用户没有使用MFA，只需填写从凭证文件中获得的信息，就可以了。否则，请在配置文件中添加您的MFA配置文件。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/e8e7c879ce1f0949ca1bce452d717ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6_rXFEK8TrNK5vmbQ-_kQ.png"/></div></div></figure><p id="f176" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">请检查您的配置。如果您的CLI设置正确，您应该会看到您的帐户下面列出了bucket。</p><p id="b4d2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe np nq nr ns b">aws s3 ls</code></p><ul class=""><li id="07e1" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nk nl nm nn bi translated"><strong class="lh ja"> Pipenv设置</strong></li></ul><p id="4d21" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这一步是可选的，因为您可以针对您的环境使用其他方法。但是，我将简要介绍如何设置Pipenv环境，以便让您能够轻松地理解。</p><ol class=""><li id="4acb" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nu nl nm nn bi translated">在这里克隆我的回购<a class="ae le" href="https://github.com/zoraxl/WH002-AWS-Containerized-Training" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="0994" class="nf ng iq lh b li nv ll nw lo nx ls ny lw nz ma nu nl nm nn bi translated">在您喜欢的SDE中打开项目。我正在使用VSCode。</li><li id="6412" class="nf ng iq lh b li nv ll nw lo nx ls ny lw nz ma nu nl nm nn bi translated">用pip安装pipenv。<code class="fe np nq nr ns b">pip install pipenv</code></li><li id="1597" class="nf ng iq lh b li nv ll nw lo nx ls ny lw nz ma nu nl nm nn bi translated">用Python解释器初始化pipenv环境。我使用的是3.7版本。使用<code class="fe np nq nr ns b">pipenv --python 3.7</code>进行初始化。</li><li id="63df" class="nf ng iq lh b li nv ll nw lo nx ls ny lw nz ma nu nl nm nn bi translated">用<code class="fe np nq nr ns b">pipenv install</code>安装依赖项。</li></ol><p id="eb5b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">设置正确，它应该导致这样的事情。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oa"><img src="../Images/4648099dde84ed60f5275898029c373b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9gKEKAfi06T-aT_sDLHNlw.png"/></div></div></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="780b" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">模型结构</h2><p id="73ce" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">这个例子将使用<a class="ae le" href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques" rel="noopener ugc nofollow" target="_blank">房价:高级回归技术</a>数据集，它包含79个变量来预测每套房子的最终价格。在比较了一堆模型之后，xgboost回归器脱颖而出，我们的工作是在训练脚本中微调回归器。RMSE将是模型选择的标准。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="46c1" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">码头工作总结</h2><p id="fd8c" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">如果您不熟悉Docker，请查看AWS的本指南。我们在这里要做的是构建我们自己的docker映像，并将其推送到AWS ECR。Elastic Container Registry是AWS提供的托管服务，用于存储和管理Docker映像。为了与Sagemaker SDK一起使用，我们需要将docker映像推送到ECR，以允许我们的训练实例从那里提取映像。</p><ul class=""><li id="cc9f" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nk nl nm nn bi translated"><strong class="lh ja"> Dockerfile </strong></li></ul><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/b8c95946841009d706f76cc252ff4d5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLJPCECkw_bViReH3vLlDg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">文档化培训工作流程(图片由作者提供)</p></figure><p id="5610" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上图说明了我们如何设置Dockerfile文件。建议在将docker映像推送到ECR之前，先在本地对其进行测试。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><ul class=""><li id="c953" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nk nl nm nn bi translated"><strong class="lh ja">本地文档化培训</strong></li></ul><p id="64c9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">本例将使用<a class="ae le" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html#sagemaker.estimator.EstimatorBase.fit" rel="noopener ugc nofollow" target="_blank"> Sagemaker训练API </a>在上述Docker映像中测试执行本地训练。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><ul class=""><li id="253e" class="nf ng iq lh b li lj ll lm lo nh ls ni lw nj ma nk nl nm nn bi translated"><strong class="lh ja">将对接器推到ECR </strong></li></ul><p id="df70" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AWS ECR提供了一个控制台，只需点击几下鼠标就可以设置Docker存储库。如果您想使用控制台，请检查<a class="ae le" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/repository-create.html" rel="noopener ugc nofollow" target="_blank">此链接</a>。或者，您可以使用AWS CLI通过命令行设置Docker存储库。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="ca76" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在我们的图像设置好了，可以使用了。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="a49a" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">在Sagemaker培训</h2><p id="3528" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">一旦我们正确设置了前面的所有步骤，Sagemaker中启动培训的工作流程就相对简单了。首先，我们需要将数据存储在指定的S3桶中。您可以在AWS控制台中创建一个并上传数据，或者使用Sagemaker SDK。然后我们利用<code class="fe np nq nr ns b">sagemaker.estimator</code>开始训练。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="edf9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上面的脚本将使用指定的配置启动一个培训作业。检查自由层实例以避免费用。我使用的是“<strong class="lh ja"> ml.c4.xlarge </strong>”，如果你的账户在两个月内开通，这应该是自由层实例。培训完成后，您可以在Sagemaker控制台中查看您的培训工作:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/f6571f0a63a702ad4b7eef2739cc4b39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oL_syuO73uDr51dC7HE34w.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">培训作业控制台视图</p></figure><p id="5ae1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您还可以在同一个页面的<strong class="lh ja">输出下找到您的s3模型工件。</strong>通常，<code class="fe np nq nr ns b">estimator</code>会为您创建一个新的存储桶来存储工件，除非您在<code class="fe np nq nr ns b">output_path</code>中指定。检查此处的<a class="ae le" href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html#sagemaker.estimator.EstimatorBase.fit#input_mode" rel="noopener ugc nofollow" target="_blank">链接</a>是否清晰。</p><p id="407c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这里需要注意的一点是，如果你想从Docker中导出你的模型或输出，只需将文件保存到<code class="fe np nq nr ns b">opt/ml/model</code>，Sagemaker会将你想要的输出打包到一个<code class="fe np nq nr ns b">model.tar.gz</code>，并上传到输出桶。然后，您可以通过S3 bucket控制台或Python SDK下载并提取该文件。</p><p id="7e44" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">一个完整的例子，检查我的回购<a class="ae le" href="https://github.com/zoraxl/WH002-AWS-Containerized-Training" rel="noopener ugc nofollow" target="_blank">这里</a>。和平！🤗</p></div></div>    
</body>
</html>