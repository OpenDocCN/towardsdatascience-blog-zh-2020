<html>
<head>
<title>SQL in Data Science</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据科学中的SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-in-data-science-af0b4492bcd?source=collection_archive---------37-----------------------#2020-10-22">https://towardsdatascience.com/sql-in-data-science-af0b4492bcd?source=collection_archive---------37-----------------------#2020-10-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b852" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用SQLite和Chinook数据库的SQL教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1e633551f96d5f3b097a4c5ced6b57f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PcVV-Stq79lbp4y8tYcdqA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae ky" href="https://unsplash.com/s/photos/query?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="8b3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章将作为使用SQL(结构化查询语言)查询数据的教程。出于本教程的目的，我将使用SQLite3库，它提供了一个关系数据库管理系统。例如，我将使用Chinook数据库，这是一个表示数字媒体商店的示例数据库，包括艺术家、专辑等的表。更多细节，请看文档<a class="ae ky" href="https://github.com/lerocha/chinook-database" rel="noopener ugc nofollow" target="_blank"> <em class="lv">这里</em> </a>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="1de4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，SQL是处理和查询数据的标准。一个重要的好处是SQL允许用户快速有效地从关系数据库中输入和检索信息。关系数据库是一种存储和访问彼此相关的数据点的数据库<em class="lv"> (Oracle，</em>)T5什么是关系数据库？)，把这个想象成一个有列和行的excel电子表格。它们可以由一个或多个这样的表组成，每一行由一个唯一的键(主键)标识。这些数据库对象的集合被称为模式。模式是一种有用的机制，可以为不同的应用程序、访问权限和管理数据库的安全管理隔离数据库对象<em class="lv"> (Rajendra GuptaRajendra，2019) </em>。使用SQL时，我最喜欢的一个优点是能够只检索特定于任务的数据。通常，我使用Pandas库进行大部分数据操作和分析。然而，当试图用多个条件来划分数据帧的子集时，语法变得相当复杂。使用SQL语句，如<code class="fe md me mf mg b">SELECT</code>、<code class="fe md me mf mg b">DISTINCT</code>和<code class="fe md me mf mg b">LIKE</code>，我们可以通过只检索服务于我们目标的数据来节省计算时间。下图是关系数据库模式的一个示例。每个矩形都是一个表格，表格名称列在顶部。在每个表名的下面是与每个表相关联的列名列表。带有星号(*)的列名(在本例中为金键)表示它是表的<strong class="lb iu">主键</strong>(唯一标识符)。如您所见，一个表中的主键也可能在另一个表中。这就是所谓的<strong class="lb iu">外键</strong>(来自不同表的主键)，在本例中为蓝色菱形。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mh"><img src="../Images/53b740419911847cab37d94c7c3b1c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IyWh6JoVzdhH_NbAL6AqVg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/vectors/database-schema-data-tables-schema-1895779/" rel="noopener ugc nofollow" target="_blank"> pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/mcmurryjulie-2375405/?tab=about" rel="noopener ugc nofollow" target="_blank">麦克默里朱莉</a></p></figure><p id="6212" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQLite库有一个非常有效的关系数据库管理系统(RDBMS)。SQLite3为用户提供了许多有益的特性，最引人注目的是它是自包含的、无服务器的、零配置的(<em class="lv">什么是SQLite？你应该知道的SQLite顶级特性</em> 2020)。</p><h2 id="1c96" class="mi mj it bd mk ml mm dn mn mo mp dp mq li mr ms mt lm mu mv mw lq mx my mz na bi translated">SQLite3在运行</h2><p id="3dff" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">对于本教程，我将安装并加载必要的库，连接到数据库，然后开始发送查询。下面使用的几个例子摘自<a class="ae ky" href="https://github.com/LucasMcL/15-sql_queries_02-chinook" rel="noopener ugc nofollow" target="_blank"><em class="lv">Lucas MCL/15-SQL _ queries _ 02-chinook</em></a>。如果您使用的是Python版本3，则可能不需要安装。</p><ul class=""><li id="1636" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">安装SQLite3</li><li id="2b18" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">导入SQLite3</li></ul><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="6b09" class="mi mj it mg b gy ny nz l oa ob">pip install pysqlite3</span><span id="2944" class="mi mj it mg b gy oc nz l oa ob">import sqlite3</span></pre><ul class=""><li id="a9c0" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">连接到数据库</li></ul><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="3c99" class="mi mj it mg b gy ny nz l oa ob">conn = sqlite3.connect('data/Chinook_Sqlite.sqlite')</span></pre><ul class=""><li id="6329" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">实例化游标对象以获取查询结果</li></ul><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="c934" class="mi mj it mg b gy ny nz l oa ob">cur = conn.cursor()</span></pre><p id="4572" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经连接到数据库，我们可以查询其中的数据。使用cursor对象执行查询只会返回cursor对象。为了看到结果，我们需要在事后使用<code class="fe md me mf mg b">fetchall()</code>方法。</p><ul class=""><li id="2949" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">使用<code class="fe md me mf mg b">SELECT</code>语句和<code class="fe md me mf mg b">WHERE</code>子句执行查询，查看数据库中有多少个表。<code class="fe md me mf mg b">WHERE</code>子句通常根据某种条件过滤查询结果。在下面的例子中，我用它来返回数据库中类型为“table”的对象的名称。每个SQLite数据库都有一个包含模式信息的sqlite_master表。以分号结束查询表示语句结束。如果我们希望查询返回表中的所有记录，请使用星号(*)代替<code class="fe md me mf mg b">name</code>。</li></ul><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="693a" class="mi mj it mg b gy ny nz l oa ob">cur.execute("SELECT name FROM sqlite_master WHERE type='table';")<br/>print(cur.fetchall())</span><span id="9bb4" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu">#Output:</strong><br/>[('Album',), ('Artist',), ('Customer',), ('Employee',), ('Genre',), ('Invoice',), ('InvoiceLine',), ('MediaType',), ('Playlist',), ('PlaylistTrack',), ('Track',)]</span><span id="c9a3" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu"><em class="lv">The output of this query statement returned all of the tables in the database.</em></strong></span></pre><p id="3046" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们想要关于数据库中每个表的更详细的信息，那么<code class="fe md me mf mg b">PRAGMA</code>命令将会给我们提供这些信息。</p><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="ddfd" class="mi mj it mg b gy ny nz l oa ob">cur.execute("PRAGMA table_info(Employee)")<br/>info = cur.fetchall()<br/>print(*info, sep = "\n")</span><span id="ba8e" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu">#Output:</strong><br/>(0, 'EmployeeId', 'INTEGER', 1, None, 1)<br/>(1, 'LastName', 'NVARCHAR(20)', 1, None, 0)<br/>(2, 'FirstName', 'NVARCHAR(20)', 1, None, 0)<br/>(3, 'Title', 'NVARCHAR(30)', 0, None, 0)<br/>(4, 'ReportsTo', 'INTEGER', 0, None, 0)<br/>(5, 'BirthDate', 'DATETIME', 0, None, 0)<br/>(6, 'HireDate', 'DATETIME', 0, None, 0)<br/>(7, 'Address', 'NVARCHAR(70)', 0, None, 0)<br/>(8, 'City', 'NVARCHAR(40)', 0, None, 0)<br/>(9, 'State', 'NVARCHAR(40)', 0, None, 0)<br/>(10, 'Country', 'NVARCHAR(40)', 0, None, 0)<br/>(11, 'PostalCode', 'NVARCHAR(10)', 0, None, 0)<br/>(12, 'Phone', 'NVARCHAR(24)', 0, None, 0)<br/>(13, 'Fax', 'NVARCHAR(24)', 0, None, 0)<br/>(14, 'Email', 'NVARCHAR(60)', 0, None, 0)</span><span id="c507" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu"><em class="lv">The output of this query statement returned the Employee table's Column ID, Column Name, Column Type, Not Null Values, Default Value, and Primary Key.</em></strong></span></pre><p id="4290" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望输出的格式能够操作或处理数据，那么使用Pandas将查询结果包装到dataframe中可以节省时间。<strong class="lb iu"> cursor.description </strong>属性返回包含以下内容的列描述:</p><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="435e" class="mi mj it mg b gy ny nz l oa ob">1. name<br/>2. type_code<br/>3. display_size<br/>4. internal_size<br/>5. precision<br/>6. scale<br/>7. null_ok</span></pre><p id="ba6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用description属性，我们可以使用list comprehension获取每一列的名称。下面是一个查询语句，选择不在美国的客户的全名、id和国家，结果封装在一个数据帧中。</p><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="a0c8" class="mi mj it mg b gy ny nz l oa ob"><strong class="mg iu">#Importing Pandas</strong></span><span id="d7b5" class="mi mj it mg b gy oc nz l oa ob">import pandas as pd</span><span id="960e" class="mi mj it mg b gy oc nz l oa ob">cur.execute("""<br/>    SELECT FirstName, LastName, CustomerId, Country<br/>    FROM customer<br/>    WHERE country != 'USA'<br/>""")<br/>df = pd.DataFrame(cur.fetchall())<br/>df.columns = [x[0] for x in cur.description]<br/>df.head(10)</span><span id="af7c" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu">#Output:</strong></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/b297af67e46fe492efaff6a4eb4df047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oA2gR1DdwkNysYwy0CUt6w.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="c9bd" class="mi mj it bd mk ml mm dn mn mo mp dp mq li mr ms mt lm mu mv mw lq mx my mz na bi translated">使用SQL进行过滤和排序</h2><p id="5ea2" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">回到SQL查询只允许您检索与您的任务相关的数据的地方。我将介绍一些查询修饰符，<code class="fe md me mf mg b">ORDER BY</code>是第一个。这个修饰符允许我们按照特定的特性对<code class="fe md me mf mg b">SELECT</code>语句的结果进行排序。</p><p id="b243" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe md me mf mg b">LIMIT</code>子句就像它听起来的那样，它将输出限制为一定数量的结果。这类似于使用<code class="fe md me mf mg b">df.head(10)</code>属性查看熊猫数据帧的输出。</p><p id="d1c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe md me mf mg b">BETWEEN</code>运算符允许我们通过过滤设置值之间的结果来进一步选择特定数据。这在查询特定的年龄组、时间范围等时非常有用。</p><p id="9ea1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面我将执行一个查询，从track表中选择数据，其中track的长度以毫秒为单位，介于205205和300000之间。结果按曲目的毫秒数降序排列，因此曲目较长的曲目将排在最前面。我还将这个查询限制为只输出10个结果。</p><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="3b12" class="mi mj it mg b gy ny nz l oa ob">cur.execute("""<br/>    SELECT Name, AlbumId, TrackId, Milliseconds<br/>    FROM track<br/>    WHERE Milliseconds BETWEEN 205205 AND 300000<br/>    ORDER BY Milliseconds Desc<br/>    LIMIT 10<br/>""")<br/>info = cur.fetchall()<br/>print(*info, sep = "\n")</span><span id="cd9b" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu">#Output:<br/></strong>('Breathe', 212, 2613, 299781)<br/>('Queixa', 23, 524, 299676)<br/>('Getaway Car', 10, 97, 299598)<br/>('Winterlong', 201, 2485, 299389)<br/>('Cherub Rock', 202, 2491, 299389)<br/>('Sonata for Solo Violin: IV: Presto', 325, 3480, 299350)<br/>('Linha Do Equador', 21, 218, 299337)<br/>('Who Are You (Single Edit Version)', 221, 2749, 299232)<br/>('Garden', 181, 2201, 299154)<br/>('The Spirit Of Radio', 196, 2406, 299154)</span></pre><h2 id="1311" class="mi mj it bd mk ml mm dn mn mo mp dp mq li mr ms mt lm mu mv mw lq mx my mz na bi translated">聚合函数</h2><p id="6d3e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">这些SQL函数在执行统计分析时非常有用。我们可以得到一列中的平均值、最小值和最大值以及值的总和。<code class="fe md me mf mg b">COUNT</code>函数返回满足特定条件的记录数。</p><p id="b2fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe md me mf mg b">GROUP BY</code>函数将返回按设定列分组的结果。例如，按性别、品种或国籍对结果进行分组。</p><p id="f291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是每个国家总销售额的查询示例，结果按每个国家分组。我还将总和别名为“TotalSales ”,以便按每个国家的总销售额对结果进行分组。</p><pre class="kj kk kl km gt nu mg nv nw aw nx bi"><span id="5fe3" class="mi mj it mg b gy ny nz l oa ob">cur.execute('''<br/>    SELECT i.billingcountry, sum(total) as 'TotalSales'<br/>    FROM invoice AS i<br/>    GROUP BY billingcountry<br/>    ORDER BY totalsales DESC<br/>    '''<br/>)<br/>            <br/>info = cur.fetchall()<br/>print(*info, sep = "<strong class="mg iu">\n</strong>")</span><span id="e737" class="mi mj it mg b gy oc nz l oa ob"><strong class="mg iu">#Output:</strong><br/>('USA', 523.0600000000003)<br/>('Canada', 303.9599999999999)<br/>('France', 195.09999999999994)<br/>('Brazil', 190.09999999999997)<br/>('Germany', 156.48)<br/>('United Kingdom', 112.85999999999999)<br/>('Czech Republic', 90.24000000000001)<br/>('Portugal', 77.23999999999998)<br/>('India', 75.25999999999999)<br/>('Chile', 46.62)<br/>('Ireland', 45.62)<br/>('Hungary', 45.62)<br/>('Austria', 42.62)<br/>('Finland', 41.620000000000005)<br/>('Netherlands', 40.62)<br/>('Norway', 39.62)<br/>('Sweden', 38.620000000000005)<br/>('Poland', 37.620000000000005)<br/>('Italy', 37.620000000000005)<br/>('Denmark', 37.620000000000005)<br/>('Australia', 37.620000000000005)<br/>('Argentina', 37.620000000000005)<br/>('Spain', 37.62)<br/>('Belgium', 37.62)</span></pre><p id="2bcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想进一步了解SQL聚合器和select语句，<a class="ae ky" href="http://www.sqlclauses.com/sql+aggregate+functions" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">SQL clauses</strong></a><strong class="lb iu"/>和<strong class="lb iu"/><a class="ae ky" href="http://zetcode.com/db/sqlite/select/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">zetcode</strong></a><strong class="lb iu"/>提供了一些非常有用的示例。</p><h2 id="b6c8" class="mi mj it bd mk ml mm dn mn mo mp dp mq li mr ms mt lm mu mv mw lq mx my mz na bi translated">结论</h2><p id="5879" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">当在数据库中查找特定信息时，SQL是一个非常有用的工具。我相信SQL和Pandas可以让你查询和操作数据到任何你需要的格式。本教程只是触及了使用SQL的可能性的表面。如果您正在寻找一些后续步骤，我建议您查看带有<code class="fe md me mf mg b">USING</code>和<code class="fe md me mf mg b">ON</code>语句的join语句。</p><h2 id="dd11" class="mi mj it bd mk ml mm dn mn mo mp dp mq li mr ms mt lm mu mv mw lq mx my mz na bi translated">参考资料:</h2><ul class=""><li id="0556" class="ng nh it lb b lc nb lf nc li oe lm of lq og lu nl nm nn no bi translated"><em class="lv"> SQL:运算符中的&amp;之间。(2018年3月21日)。检索自</em>【https://www.geeksforgeeks.org/sql-between-in-operator/】<em class="lv"/></li><li id="21f5" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><em class="lv">(未注明)。检索自</em><a class="ae ky" href="https://www.sqlite.org/index.html" rel="noopener ugc nofollow" target="_blank"><em class="lv">https://www.sqlite.org/index.html</em></a></li><li id="c7db" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><em class="lv"> LucasMcL。(未注明)。Lucas MCL/15-SQL _ queries _ 02-chinook。检索自</em><a class="ae ky" href="https://github.com/LucasMcL/15-sql_queries_02-chinook" rel="noopener ugc nofollow" target="_blank"><em class="lv"/></a></li><li id="8e83" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><em class="lv"> SQL教程。(未注明)。检索自</em><a class="ae ky" href="https://www.tutorialspoint.com/sql/index.htm" rel="noopener ugc nofollow" target="_blank"><em class="lv">https://www.tutorialspoint.com/sql/index.htm</em></a></li></ul></div></div>    
</body>
</html>