<html>
<head>
<title>Emulating a PID Controller with Long Short-term Memory: Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模拟具有长短期记忆的PID控制器:第4部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b?source=collection_archive---------33-----------------------#2020-10-28">https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b?source=collection_archive---------33-----------------------#2020-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d9f4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用LSTM控制器代替PID控制器进行温度控制的实际应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/82db2e5b0f8a194917e4b513bca398e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i8LkWmWBMcGzDOZH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@mantasos?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Tasos Mansour </a>拍摄</p></figure><p id="fd83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是这个有趣项目的最后一部分！在这里，我们将看到使用LSTM来仿真PID控制器的一些实际应用，以及一些潜在的缺点。如果您还没有阅读本系列的前几篇文章，我强烈建议您回去看看，这样您就可以有一些背景知识了。当然，这个项目的巧妙之处在于，你可以在自己的<a class="ae ky" href="http://apmonitor.com/pdc/index.php/Main/ArduinoTemperatureControl" rel="noopener ugc nofollow" target="_blank">温度控制实验室</a>设备上运行所有的<a class="ae ky" href="https://github.com/nrlewis929/TCLab_emulate_PID" rel="noopener ugc nofollow" target="_blank">代码</a>，模拟你可能在真正的炼油厂或化工厂看到的东西。因此，这里有一个快速回顾这一系列，然后我们将开始！</p><ol class=""><li id="3cf9" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@nrlewis929/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08" rel="noopener">使用温度控制实验室创建比例积分微分控制器数据</a></li><li id="0ae9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47" rel="noopener">在Keras中训练长短期记忆神经网络，以模拟PID控制器</a></li><li id="6c2c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/emulating-a-pid-controller-with-long-short-term-memory-part-3-23da7df3e033">用LSTM控制温控实验室</a></li><li id="3e9d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">用LSTM控制器代替PID控制器进行温度控制的实际应用(本文)</li></ol><h1 id="2d5f" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">改变PID调节参数</h1><p id="6fd4" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">如果您熟悉PID控制器，在问题设置期间，您可能想知道的第一件事是，如果您更改调整参数，会发生什么情况？回想一下PID控制器方程:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/4c9b2a74623c214aa0ed048a5d582af7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f9wl8o_QjHjT1bj68d5Hnw.png"/></div></div></figure><p id="0b88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们改变K_c、τ_I或τ_D，加热器输出也会改变，然后我们训练的LSTM不再与输出匹配。人们可能会认为这是一个巨大的缺点——如果我们改变PID控制器的调整参数，我们将不得不重新训练LSTM来模拟新的行为(回到<a class="ae ky" rel="noopener" target="_blank" href="/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47">第2部分</a>)。另一方面，我们可以利用这一点。一旦PID控制器被调整到一个系统，我们很少需要改变调整参数，因此PID行为的改变可能表明来自外部的恶意攻击(或潜在的内部攻击，如不满的员工)。</p><p id="7b67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">突然，我们有了一个现成的异常检测方法。我们可以像在<a class="ae ky" rel="noopener" target="_blank" href="/emulating-a-pid-controller-with-long-short-term-memory-part-3-23da7df3e033">第3部分</a>中所做的那样进行检查，在那里我们运行PID之外的控制器，但是也检查LSTM输出以确保它们是相似的。如果不是，那么我们知道有什么东西使PID控制器出了问题，我们可以调查并修复它。</p><p id="4179" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看我们的设置，现在应该很熟悉了，但是有一些变化:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="969e" class="nm mk it ni b gy nn no l np nq">#### Set up run ####</span><span id="a0cc" class="nm mk it ni b gy nr no l np nq"># Import model and model parameters<br/>model = load_model('pid_emulate.h5')<br/>model_params = pickle.load(open('model_params.pkl', 'rb'))</span><span id="a0d0" class="nm mk it ni b gy nr no l np nq">s_x = model_params['Xscale']<br/>s_y = model_params['yscale']<br/>window = model_params['window']</span><span id="4880" class="nm mk it ni b gy nr no l np nq"># Run time in minutes<br/>run_time = 45.0</span><span id="dba5" class="nm mk it ni b gy nr no l np nq"># Number of cycles<br/>loops = int(60.0*run_time)</span><span id="9c52" class="nm mk it ni b gy nr no l np nq"># arrays for storing data<br/>T1 = np.zeros(loops) # measured T (degC)<br/>Qpid = np.zeros(loops) # Heater values for PID controller<br/>Qlstm = np.zeros(loops) # Heater values for LSTM controller<br/>tm = np.zeros(loops) # Time<br/>t_pid = np.zeros(loops) # Time to compute PID controller output<br/>t_lstm = np.zeros(loops) # Time to compute LSTM controller output<br/>Q2 = np.zeros(loops)</span><span id="857d" class="nm mk it ni b gy nr no l np nq"># Time range to introduce anomaly (turn on heater 2, change PID tuning constants)<br/>start_anom = int(0.7*loops)</span><span id="c1aa" class="nm mk it ni b gy nr no l np nq"># Heater 2 turned on during anomaly window<br/>Q2[start_anom:] = 80</span><span id="933c" class="nm mk it ni b gy nr no l np nq"># Temperature set point (degC)<br/>with tclab.TCLab() as lab:<br/>    Tsp = np.ones(loops) * lab.T1</span><span id="26b3" class="nm mk it ni b gy nr no l np nq"># vary temperature setpoint<br/>end = window + 15 # leave 1st window + 15 seconds of temp set point as room temp<br/>while end &lt;= start_anom: <br/>    start = end<br/>    # keep new temp set point value for anywhere from 4 to 10 min<br/>    end += random.randint(240,600) <br/>    Tsp[start:end] = random.randint(30,70)<br/>    <br/>while end &lt;= loops: <br/>    start = end<br/>    # keep new temp set point value for anywhere from 4 to 10 min<br/>    end += random.randint(240,600) <br/>    Tsp[start:end] = random.randint(30,50)</span></pre><p id="5f96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像往常一样，我们导入我们的模型和附带的参数，设置运行时间，启动数组来存储数据，并创建一个设定点配置文件。还有几件事需要指出。我们有<code class="fe ns nt nu ni b">t_pid</code>和<code class="fe ns nt nu ni b">t_lstm</code>，稍后我们将使用它们来为控制器计时。我们有<code class="fe ns nt nu ni b">start_anom</code>变量，我用它来表示数据的异常部分应该何时开始。注意，我还为heater 2 ( <code class="fe ns nt nu ni b">Q2</code>)设置了一个数组，稍后我们将使用它进行另一个测试。最后，在数据的异常部分，我将加热器的设定点保持在稍低的位置——它将在较高的温度下工作，但当温度保持较低时更容易看到。</p><p id="b3ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还对<code class="fe ns nt nu ni b">pid(sp,pv,pv_last,ierr,dt)</code>函数进行了修改，因此它现在将调谐“常数”作为附加输入<code class="fe ns nt nu ni b">(Kc,tauI,tauD)</code>。这将让我们在运行中途改变PID控制器输出。</p><p id="471d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，下面是我们运行模拟时的代码:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="3b82" class="nm mk it ni b gy nn no l np nq"># Run test<br/>with tclab.TCLab() as lab:<br/>    # Find current T1, T2<br/>    print('Temperature 1: {0:0.2f} °C'.format(lab.T1))<br/>    print('Temperature 2: {0:0.2f} °C'.format(lab.T2))</span><span id="009f" class="nm mk it ni b gy nr no l np nq">    # Integral error<br/>    ierr = 0.0<br/>    # Integral absolute error<br/>    iae = 0.0</span><span id="1ed7" class="nm mk it ni b gy nr no l np nq">    start_time = time.time()<br/>    prev_time = start_time</span><span id="da02" class="nm mk it ni b gy nr no l np nq">    for i in tqdm(range(loops)):<br/>        # Delay 1 second<br/>        if time.time() &gt; prev_time + 1.0:<br/>            print('Exceeded cycle time')<br/>        else:<br/>            while time.time() &lt; prev_time + 1.0:<br/>                pass<br/>        <br/>        # Record time and change in time<br/>        t = time.time()<br/>        dt = t - prev_time<br/>        prev_time = t<br/>        tm[i] = t - start_time</span><span id="87df" class="nm mk it ni b gy nr no l np nq">        # Read temperature (C)<br/>        T1[i] = lab.T1</span><span id="dd21" class="nm mk it ni b gy nr no l np nq">        # Integral absolute error<br/>        iae += np.abs(Tsp[i]-T1[i])</span><span id="6d67" class="nm mk it ni b gy nr no l np nq">        # Perturb PID tuning parameter<br/>        if i &gt; start_anom:<br/>            Kc, tauI, tauD = 3.0*Kc0, 0.5*tauI0, tauD0 + 2.0<br/>        else:<br/>            Kc, tauI, tauD = Kc0, tauI0, tauD0<br/>            <br/>        # Calculate PID output (and time)<br/>        t0_pid = time.time()<br/>        [Qpid[i],P,ierr,D] = pid(Tsp[i],T1[i],T1[i-1],ierr,dt,<br/>                                 Kc=Kc,tauI=tauI,tauD=tauD)<br/>        tf_pid = time.time()</span><span id="f28c" class="nm mk it ni b gy nr no l np nq">        # Write heater output (0-100)<br/>        lab.Q1(Qpid[i])<br/>        <br/>        # Run LSTM model to get Q1 value for control<br/>        if i &gt;= window:<br/>            # Load data for model<br/>            T1_m = T1[i-window:i]<br/>            Tsp_m = Tsp[i-window:i]<br/>            # Predict and store LSTM value for comparison<br/>            t0_lstm = time.time()<br/>            Qlstm[i] = lstm(T1_m,Tsp_m)<br/>            tf_lstm = time.time()<br/>            <br/>        # Save controller times<br/>        t_pid[i] = tf_pid - t0_pid<br/>        t_lstm[i] = tf_lstm - t0_lstm</span></pre><p id="4d53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">里面有很多，但从第三部看起来应该很熟悉。主要区别是当我们的时间计数超过我们的<code class="fe ns nt nu ni b">start_anom</code>规格时，我们改变PID调节参数的行:<code class="fe ns nt nu ni b">Kc, tauI, tauD = 3.0*Kc0, 0.5*tauI0, tauD0 + 2.0</code>。您还会注意到这里有一些时间记录，我们将在下一节中讨论。</p><p id="b1da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行后，我们可以绘制结果，并将其放入视频中进行可视化。让我们看看发生了什么！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/760ee58f6c1e9d3007a29680361efb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*GGhGVjAK4tziWVVEQgajbQ.gif"/></div></div></figure><p id="71ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们在第3部分中看到的，LSTM输出非常类似于PID输出，在瞬态时间范围内有明显的例外。正如所料，当PID调节参数改变时，这种情况会突然改变。你会注意到，由于PID控制器是实际写入输出的控制器，加热器输出也开始变得不稳定，温度开始波动得更大。</p><p id="d980" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以很容易地绘制出<code class="fe ns nt nu ni b">Qpid</code>和<code class="fe ns nt nu ni b">Qlstm</code>之间的误差，并使用它来检测异常行为。这种情况下有备份也很方便；如果我们注意到PID控制器开始表现异常，我们可以迅速将控制切换到LSTM控制器，只需将<code class="fe ns nt nu ni b">lab.Q1(Qpid[i])</code>改为<code class="fe ns nt nu ni b">lab.Q1(Qlstm[i])</code>。非常巧妙的是，最初可能被认为是缺点的东西实际上变得非常有用！</p><h1 id="c5a8" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">计算时间</h1><p id="fbc8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">如果你还记得，我们开始这个项目的主要原因是来自一篇<a class="ae ky" href="https://www.sciencedirect.com/science/article/pii/S2405896318320597" rel="noopener ugc nofollow" target="_blank">论文</a>讨论使用神经网络来模拟模型预测控制器，其想法是神经网络将比控制器更快。从上次我们计算LSTM和PID控制器的运行中，我们方便地节省了每个控制器所花费的时间。让我们看看结果如何:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="1ecf" class="nm mk it ni b gy nn no l np nq">print('LSTM:',t_lstm.mean())<br/>print('PID:',t_pid.mean())</span><span id="da5e" class="nm mk it ni b gy nr no l np nq">&gt;&gt;&gt; LSTM: 0.03118442685515792<br/>PID: 2.043927157366717e-05</span></pre><p id="6b72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">老实说，这正是我所期望的。PID实际上比LSTM快得多，尽管LSTM控制器的计算时间仍不到1秒。使用PID控制器是有原因的，那是因为它们速度快，在解决一些控制问题时表现得相当好。但是，如果你有一个更复杂的控制器，假设模型输入和参数是相似的，我们可能期望LSTM控制器每次计算只需要几分之一秒。因此，虽然它实际上比PID控制器有时间上的优势，但仍然有一些用途(请查看2020年11月的一篇关于更复杂的控制器以及LSTM控制器在这种情况下如何有优势的额外文章)。</p><h1 id="f730" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">使用加热器2模拟额外的异常</h1><p id="fbfa" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">最后，让我们再来看看如何使用LSTM控制器来检测其他类型的异常。我们将模拟炼油厂的环境条件不再标准的情况。也许这是良性的，如不同的天气，或者是恶意的，如针对工厂另一部分的网络攻击(甚至是这个特定的过程)。控制器的行为会有什么不同？</p><p id="8a97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过打开加热器2一部分时间来模拟这一异常事件。虽然加热器2与加热器1上的传感器在物理上是分开的，但它仍然足够近，足以影响我们试图控制的加热器1周围的条件。我们的LSTM控制器是根据在标准室温下运行的一组特定数据进行训练的，所以如果我们打开加热器2，就会出现LSTM控制器没有被训练来控制的情况。类似于改变PID调节参数的情况，这最初看起来像是使用LSTM控制器的失败。然而，如果我们的工厂有一个精心控制的周围环境，那么我们希望控制器表现一致；任何偏离都表明有异常情况发生。</p><p id="41e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里看一下运行的代码(回想一下，我们已经在初始设置中指定了<code class="fe ns nt nu ni b">Q2</code>参数)。</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="4c02" class="nm mk it ni b gy nn no l np nq"># Run test<br/>with tclab.TCLab() as lab:<br/>    # Find current T1, T2<br/>    print('Temperature 1: {0:0.2f} °C'.format(lab.T1))<br/>    print('Temperature 2: {0:0.2f} °C'.format(lab.T2))</span><span id="de86" class="nm mk it ni b gy nr no l np nq">    start_time = time.time()<br/>    t = start_time</span><span id="136b" class="nm mk it ni b gy nr no l np nq">    for i in tqdm(range(loops)):<br/>        # Delay 1 second<br/>        if time.time() &gt; t + 1.0:<br/>            print('Exceeded cycle time by ',time.time()-t-1.0)<br/>        else:<br/>            while time.time() &lt; t + 1.0:<br/>                pass</span><span id="31a2" class="nm mk it ni b gy nr no l np nq">        # Record time and change in time<br/>        t = time.time()<br/>        tm[i] = t - start_time</span><span id="3223" class="nm mk it ni b gy nr no l np nq">        # Read temperature (C)<br/>        T1[i] = lab.T1</span><span id="d78f" class="nm mk it ni b gy nr no l np nq">        # Run LSTM model to get Q1 value for control<br/>        if i &gt;= window:<br/>            # Load data for model<br/>            T1_m = T1[i-window:i]<br/>            Tsp_m = Tsp[i-window:i]<br/>            # Timer for LSTM controller output<br/>            t0_lstm = time.time()<br/>            # Predict and store LSTM value for comparison<br/>            Qlstm[i] = lstm(T1_m,Tsp_m)<br/>            tf_lstm = time.time()</span><span id="6666" class="nm mk it ni b gy nr no l np nq">        # Write heater output (0-100)<br/>        lab.Q1(Qlstm[i])<br/>        lab.Q2(Q2[i])</span></pre><p id="97e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一切现在看起来可能都很熟悉，只有最后两行是明显的例外:我们已经将控制权交给了LSTM，并且我们还在中读取了Q2值。运行模拟后，我们可以再次绘制结果，并将其放入动画中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/9ce95d8b2ecb02172c19cd2b9887fa99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*trS1gOvq3R5k2nTL8ZZoyA.gif"/></div></div></figure><p id="4f79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很有意思。请注意，一旦我们打开Q2，温度往往会超过设定值，控制器无法正确解释这种超调。这是因为控制器没有被训练去考虑来自附近加热器的额外热量。</p><p id="ddae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这让我有了一个想法，但我想我会让你尝试一下，现在你知道如何设置TCLab，训练一个LSTM，并用它运行温度控制模拟。你能利用从本系列中学到的技巧来设置一个控制系统，打开两个加热器，并试图将两个温度控制在某个设定值吗？这将是多输入多输出(MIMO)控制器。为了找到正确的方向，请访问位于APMonitor.com的MIMO实验室。</p><h1 id="45b1" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">最后的想法</h1><p id="a62e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">这使我们得出了这个项目的结论。我们从一个基本的PID控制器开始，生成一些数据，使用这些数据训练一个自动LSTM来模拟PID控制器，将控制交给LSTM，然后查看一些有用的应用，例如检测各种异常和潜在的计算时间节省。</p><p id="b877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你表现如何？你像我一样对这个项目感到兴奋吗？你还能想到这方面的其他应用吗？我很高兴听到对需要更多澄清的领域的建议。感谢您关注这个项目，我期待着未来的互动。如果你喜欢这个，请随时在LinkedIn上与我联系。</p></div></div>    
</body>
</html>