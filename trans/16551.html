<html>
<head>
<title>How to conduct market basket analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何进行市场篮子分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-conduct-market-basket-analysis-f14f391a8625?source=collection_archive---------17-----------------------#2020-11-15">https://towardsdatascience.com/how-to-conduct-market-basket-analysis-f14f391a8625?source=collection_archive---------17-----------------------#2020-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="077b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过关联分析研究消费者偏好和生活方式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/abff5fb370c6a397af7479f467c43ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pFyg57YsY-6KUqrhKtbW6A.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">罗布·麦克斯韦在<a class="ae kv" href="https://unsplash.com/s/photos/shopping-grocery?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bcb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">购物篮分析是大型零售商用来发现商品之间隐藏关联的关键技术之一。市场购物篮分析使用交易数据，即客户在一次购买中购买的所有商品的列表，来确定一起订购或购买的商品，并确定共现模式。这种强有力的分析有助于揭示消费者的偏好，而通过在线调查获取这些偏好是非常具有挑战性的。零售商使用市场购物篮分析的结果来指导商店中的产品放置、跨类别和联合营销促销等。</p><h2 id="d593" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">介绍</h2><p id="c23d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我上次购物的经历相当不可预测。我在一家亚洲商店买了一些东西。这是我的购物篮。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/74782b4e7d69ea7d42bef3ef91704b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wM1T5D8Qd-5BrqBeyTIONA.png"/></div></div></figure><p id="76a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该列表将与其他顾客的数千次购物或购物篮一起进入商店数据库的一行。关联规则挖掘是从存储在数据库中的交易数据中提取有用信息的最流行的方法之一。项目集是从杂货店所有待售项目中选择的项目集合。一个项目集可以包含2、3个项目，依此类推。关联规则确定项目集中项目之间的关系。然后，这些关系被用于构建包含所购买商品的IF-Then规则的配置文件。</p><p id="fdc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些规则可以写成:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="cac6" class="ls lt iq ms b gy mw mx l my mz">If {A} Then {B}</span></pre><p id="3c84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">规则的IF部分称为前提，规则的THEN部分称为结果。因此，前因是条件，结果是结果。关联规则有三个共同决定规则强度的关键度量:支持度、置信度和提升度。</p><p id="ed1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们假设有100个客户。其中10个人带了牛奶，8个人买了黄油，6个人两个都买了。如果我们要评估关联规则“如果有人买牛奶，他们也会买黄油”，那么关联规则的<strong class="ky ir">支持度</strong>可以计算为:</p><p id="e26a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(牛奶和黄油的概率)或者换句话说(包含牛奶和黄油的篮子的数量)/(总篮子的数量)</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="9742" class="ls lt iq ms b gy mw mx l my mz">Support = (Probability of Milk and Butter) </span><span id="7c23" class="ls lt iq ms b gy na mx l my mz">= 6/100 = 0.06</span></pre><p id="5454" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">0.06的支持标准意味着每一百个市场篮子中有六个既有牛奶又有黄油。</p><p id="630e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">置信度</strong> =前件中项目集的支持度除以项目集的支持度。换句话说，它是条件概率P(黄油|牛奶),计算如下:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="b183" class="ls lt iq ms b gy mw mx l my mz">Confidence of P(B|A) = P(AB) / P(A) =&gt; (Probability of Milk and Butter) / (Probability of Milk)<br/>OR<br/>Confidence = Support / P (Milk)<br/>OR<br/>Confidence = 0.06 / (10/100) = 0.06/0.1 = 0.6</span></pre><p id="b946" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，<strong class="ky ir"> lift </strong>是相对预测置信度的度量。在关联规则“如果牛奶那么黄油”中，假设顾客已经购买了牛奶，我们可以用这种信心来预测他将购买黄油。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="f694" class="ls lt iq ms b gy mw mx l my mz">Lift = P(B|A) / P(B)<br/>or<br/>Lift = Confidence / P(Butter) = 0.6 / (8/100) = 0.6/0.08 = 7.5</span></pre><p id="4f17" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提升值大于1反映了更强的关联性。</p><h2 id="2f4a" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">数据集和探索性数据分析</h2><p id="80e9" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">为了这个分析，我利用了一个由Hahsler，Hornik和Reutterer (2006)分析的食品杂货数据集。总共有9835笔交易，包含169个不同的杂货项目。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="e5ba" class="ls lt iq ms b gy mw mx l my mz">grocery_data = data("Groceries")<br/>#Show dimensions of the dataset<br/>print(dim(Groceries))<br/>print(dim(Groceries)[1]) # 9835 market baskets for shopping trips<br/>print(dim(Groceries)[2]) # 169 initial store items</span><span id="22af" class="ls lt iq ms b gy na mx l my mz">summary(Groceries)</span></pre><p id="1780" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仔细观察数据集，可以发现每一行都有一个项目子集。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="3e3d" class="ls lt iq ms b gy mw mx l my mz"># Let's take a look at the first 5 transactions<br/>inspect(Groceries[1:5])<br/>    items                                                                <br/>[1] {citrus fruit,semi-finished bread,margarine,ready soups}             <br/>[2] {tropical fruit,yogurt,coffee}                                       <br/>[3] {whole milk}                                                         <br/>[4] {pip fruit,yogurt,cream cheese ,meat spreads}                        <br/>[5] {other vegetables,whole milk,condensed milk,long life bakery product}</span></pre><p id="b43b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看一下频率图，以确定商品出现在市场购物篮中的频率。我们将支持度设置为0。确保地块中的每个项目至少出现在每10个购物篮中</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="1cf1" class="ls lt iq ms b gy mw mx l my mz">itemFrequencyPlot(Groceries, support = 0.025, cex.names=0.8, xlim = c(0,0.3),type = "relative", horiz = TRUE, col = "dark red", las = 1,<br/>xlab = paste("Proportion of Market Baskets Containing Item",<br/>"\n(Item Relative Frequency or Support)"))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/7effa41ab1c5e7ab95ab1d36e7eef478.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nXDgj4Pm1GXH8u6g85D5mw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">R中的项目频率图</p></figure><p id="874b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来看看购物篮中最常出现的20种商品。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="aeb8" class="ls lt iq ms b gy mw mx l my mz"># Plot the frequency of top 20 items<br/>itemFrequencyPlot(Groceries,topN = 20)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/bf1c2b641fac95cd299f02d08e9a56c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IbINWaneYnlUyiruTCWdzQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">R中的项目频率图</p></figure><p id="e81e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以全脂牛奶、蔬菜、面包卷、苏打水和酸奶是商店里最常购买的五种商品。</p><h2 id="dfc1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">关联规则挖掘</h2><p id="cb26" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">R中arules包实现的Apriori算法有助于挖掘关联规则。通过将支持度和置信度的阈值设置为0.025和0.05，获得一组344个规则。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="b89f" class="ls lt iq ms b gy mw mx l my mz">rules &lt;- apriori(groceries, parameter = list(support = 0.025 , confidence = 0.05))</span><span id="4f2a" class="ls lt iq ms b gy na mx l my mz">Apriori</span><span id="2df9" class="ls lt iq ms b gy na mx l my mz">Parameter specification:<br/> confidence minval smax arem  aval originalSupport maxtime support minlen maxlen target  ext<br/>       0.05    0.1    1 none FALSE            TRUE       5   0.025      1     10  rules TRUE</span><span id="9ff9" class="ls lt iq ms b gy na mx l my mz">Algorithmic control:<br/> filter tree heap memopt load sort verbose<br/>    0.1 TRUE TRUE  FALSE TRUE    2    TRUE</span><span id="d4b2" class="ls lt iq ms b gy na mx l my mz">Absolute minimum support count: 245</span><span id="d33d" class="ls lt iq ms b gy na mx l my mz">set item appearances ...[0 item(s)] done [0.00s].<br/>set transactions ...[55 item(s), 9835 transaction(s)] done [0.03s].<br/>sorting and recoding items ... [32 item(s)] done [0.00s].<br/>creating transaction tree ... done [0.01s].<br/>checking subsets of size 1 2 3 4 done [0.00s].<br/>writing ... [344 rule(s)] done [0.00s].<br/>creating S4 object  ... done [0.00s].</span><span id="d606" class="ls lt iq ms b gy na mx l my mz">&gt; rules<br/>set of 344 rules</span></pre><p id="9fc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们研究一下按提升值排序的前10个关联规则。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="ce93" class="ls lt iq ms b gy mw mx l my mz">inspect(sort(rules,by="lift")[1:10])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/d5da6d22d1d33f0d7e50edeacf94c1a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HwLy5aJsAtcblZuB_rD0dg.png"/></div></div></figure><p id="279a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">手动检查所有344个关联规则将是极其令人厌烦的，并且不是可行的选择。使用R包arulesViz，我们将实现可视化技术来探索这些关系。</p><h2 id="19ea" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">关联规则可视化</h2><p id="464b" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">可以查看水平轴为支撑、垂直轴为提升的散点图。点的颜色编码与置信度有关。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="8471" class="ls lt iq ms b gy mw mx l my mz">plot(rules,measure = c("support","lift"),shading="confidence")</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/c67ed94b6e3b8d0c854d3c5588682b1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5us6Yd9T0HDUf3fAAEmcBw.png"/></div></div></figure><p id="d3fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Unwin、Hofmann和Bernt (2001)介绍了一种特殊版本的散点图，称为双键图。这里，支持度和置信度分别代表X轴和Y轴，色点用于指示“顺序”，即每个规则中包含的项目数。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="253c" class="ls lt iq ms b gy mw mx l my mz">plot(rules,shading="order",control=list(main="Two-Key plot"))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/88dd0c05457d9d2999a28e77f1126f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rgp-U84ttsJ3PjDaKxnygg.png"/></div></div></figure><p id="fb22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从上面的情节可以清楚地看出，顺序和支持度是成反比的。</p><p id="526b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下图以矩阵气泡图的形式提供了已识别关联规则的更清晰视图。关联规则的前件(左侧)中的项目表示在矩阵顶部的标签中，而关联规则的后件(右侧)中的项目表示在矩阵的右侧。支持度由每个气泡的大小表示，提升度由颜色强度反映。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="6e38" class="ls lt iq ms b gy mw mx l my mz">plot(rules,method="grouped",control=list(col=rev(brewer.pal(9,"Greens")[4:9])))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/3b35fc93bed1ba5453543697bd88c050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*If3aRU_r-aLel28OBf6Y_w.png"/></div></div></figure><p id="375f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，如果我要确定哪些产品是通常与蔬菜一起购买的，我可以从总体关联规则中过滤并报告数据。下面我按照lift对这些规则进行排序，并找出前10个关联规则。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="d472" class="ls lt iq ms b gy mw mx l my mz">vegie.rules &lt;- subset(rules,subset=rhs %pin% "vegetables")<br/>inspect(sort(vegie.rules,by="lift")[1:10])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/90eacd42e55634ef584c4b1f45f810b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BfzayniPOGmx1RH9RCVmRg.png"/></div></div></figure><p id="37ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我在下面的网络图中表示了经常购买的蔬菜产品的关联规则。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="d52c" class="ls lt iq ms b gy mw mx l my mz">plot(top.vegie.rules,method = "graph",control = list(type="items"),shading = "lift" )</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/7290a530e5ae53d698f435d00b602259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ALVFI1fO3TdDF9atJX0t9Q.png"/></div></div></figure><p id="a63e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从网络图中可以明显看出，顾客在购买蔬菜时可能会购买牛肉、奶制品、农产品、面包和香肠。</p><h2 id="b0b7" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">结论</h2><p id="0b25" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">作为相对频率或概率估计，支持值位于0到1之间。只要不是非常低，较低的支持值是可以的。置信度也取0到1之间的值，因为它是一个条件概率度量。更高的置信度值通常是优选的。最后，提升值需要大于1.0才能被管理层重视。</p><p id="3662" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们上面所做的分析本质上是描述性的，因为分析购物数据是为了研究购物行为。将这一分析带入下一步，就是在商场和地面上实施这项研究的见解。</p><p id="0cde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">零售商经常使用关联规则的发现来做出关于商店布局、产品捆绑或交叉销售的决策。商店经理也在进行地面实验，如A/B测试，以研究购物者对新商店布局的反应。这是一项正在进行的令人着迷的研究，旨在真正测试购物篮预测模型的性能。</p><p id="a080" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以下次你走进当地超市，发现安排已经改变，你现在知道为什么了。</p><h2 id="5cc5" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">参考</h2><p id="679e" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我要特别感谢米勒教授的指导和启发。我在西北大学攻读数据科学硕士课程期间曾在他的课上学习过，他的书和他的课对我的数据科学生涯产生了深远的影响。我的工作借鉴了以下文献:</p><p id="9c68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">托马斯·w·米勒(2014) <a class="ae kv" href="https://www.amazon.com/s?k=modeling+techniques+in+predictive+analytics&amp;i=digital-text&amp;ref=nb_sb_noss_2" rel="noopener ugc nofollow" target="_blank">预测分析中的建模技术</a></p><p id="f0e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">米（meter的缩写））Hahsler，S. Chelluboina (2015) <a class="ae kv" href="https://www.researchgate.net/publication/228961197_Visualizing_Association_Rules_Introduction_to_the_R-extension_Package_arulesViz" rel="noopener ugc nofollow" target="_blank">可视化关联规则:R-extension aruleviz简介</a></p><p id="251c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://webfocusinfocenter.informationbuilders.com/wfappent/TLs/TL_rstat/source/marketbasket49.htm" rel="noopener ugc nofollow" target="_blank"> Rstat构建菜篮子模型</a></p></div></div>    
</body>
</html>