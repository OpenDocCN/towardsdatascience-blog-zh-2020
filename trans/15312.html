<html>
<head>
<title>MLflow Part 3: Logging Models to a Tracking Server!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MLflow第3部分:将模型记录到跟踪服务器！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mlflow-part-3-logging-models-to-a-tracking-server-54b6aa3cd00f?source=collection_archive---------20-----------------------#2020-10-21">https://towardsdatascience.com/mlflow-part-3-logging-models-to-a-tracking-server-54b6aa3cd00f?source=collection_archive---------20-----------------------#2020-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/03b7b9062e44aaa89aa57c1c4ae22b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIoLJREKKpSHrFi1OWLpmw.png"/></div></div></figure><h2 id="5eb0" class="jc jd je bd b dl jf jg jh ji jj jk dk jl translated" aria-label="kicker paragraph">MLflow 101</h2><div class=""/><div class=""><h2 id="76cd" class="pw-subtitle-paragraph kk jn je bd b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dk translated">将您的参数、指标、工件等记录到MLflow跟踪服务器</h2></div><p id="32f7" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">嘿，朋友们，欢迎回到我们关于MLflow系列的另一篇文章。如果这是你看到的第一篇文章，你想了解一下，请点击这里查看之前的文章:</p><ul class=""><li id="c7fa" class="ly lz je le b lf lg li lj ll ma lp mb lt mc lx md me mf mg bi translated"><a class="ae mh" rel="noopener" target="_blank" href="/mlflow-part-1-getting-started-with-mlflow-8b45bfbbb334">第1部分:MLflow入门！</a></li><li id="8de8" class="ly lz je le b lf mi li mj ll mk lp ml lt mm lx md me mf mg bi translated"><a class="ae mh" rel="noopener" target="_blank" href="/mlflow-part-2-deploying-a-tracking-server-to-minikube-a2d6671e6455">第2部分:将跟踪服务器部署到Minikube！</a></li></ul><p id="c410" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">和往常一样，如果你想看这篇文章中提到的代码，请务必<a class="ae mh" href="https://github.com/dkhundley/ds-quick-tips/tree/master/010_mlflow_logging_to_server" rel="noopener ugc nofollow" target="_blank">点击这里</a>查看我的GitHub repo。</p><p id="b3fd" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">这篇最新的文章将建立在第2部分的基础上，所以如果你错过了，请一定要看看。简单回顾一下我们在那篇文章中所做的，我们在本地机器上用Minikube为Kubernetes部署了一个MLflow跟踪服务器。在幕后，MLflow跟踪服务器由Postgres元数据存储和名为Minio的类似AWS S3的工件存储支持。那篇文章内容丰富，所以我很乐意分享这篇文章，相比之下，这篇文章简单多了。唷！</p><p id="2331" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">我个人更喜欢图片，而不是静态的解释，所以结合我们在上一段中提到的内容，这个架构图像总结了我们将如何在这个特定的帖子中与MLflow进行交互。(如果你不熟悉图标，大象是PostgreSQL，红色的火烈鸟图标是Minio。)</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/161549374ea9b957817e71137a3b103d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kcPZVAKc7RESiglvZ6fvsg.png"/></div></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">作者创建的图像</p></figure><p id="f293" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">当然，在我们上一篇文章中，我们已经在图片的右侧做了所有的事情，所以这篇文章的重点是你需要为客户机上的Python文件包含什么。当然，巧合的是，由于我们使用Minikube，所有的东西都托管在本地机器上，但是如果你使用合法的Kubernetes环境，你的客户端很可能与MLflow跟踪服务器分开。</p><p id="b08d" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">这段代码实际上非常简单，其中很多内容对您来说肯定很熟悉。部分是因为其中很多是基本的机器学习内容，部分是因为在阅读本系列的第1部分时，您可能已经看到了其中的大部分内容。因为代码非常简单，所以我将把全部内容粘贴到这里，并介绍一些您可能不熟悉的特殊内容。</p><pre class="mn mo mp mq gt mv mw mx my aw mz bi"><span id="e257" class="na nb je mw b gy nc nd l ne nf"># Importing in necessary libraries<br/>import os<br/>import pandas as pd<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score<br/>from sklearn.linear_model import ElasticNet<br/>import mlflow<br/>import mlflow.sklearn</span><span id="0114" class="na nb je mw b gy ng nd l ne nf"># PROJECT SETUP<br/># ------------------------------------------------------------------------------<br/># Setting the MLflow tracking server<br/>mlflow.set_tracking_uri('<a class="ae mh" href="http://mlflow-server.local'" rel="noopener ugc nofollow" target="_blank">http://mlflow-server.local'</a>)</span><span id="87a9" class="na nb je mw b gy ng nd l ne nf"># Setting the requried environment variables<br/>os.environ['MLFLOW_S3_ENDPOINT_URL'] = '<a class="ae mh" href="http://mlflow-minio.local/'" rel="noopener ugc nofollow" target="_blank">http://mlflow-minio.local/'</a><br/>os.environ['AWS_ACCESS_KEY_ID'] = 'minio'<br/>os.environ['AWS_SECRET_ACCESS_KEY'] = 'minio123'</span><span id="f526" class="na nb je mw b gy ng nd l ne nf"># Loading data from a CSV file<br/>df_wine = pd.read_csv('../data/wine/train.csv')</span><span id="adb7" class="na nb je mw b gy ng nd l ne nf"># Separating the target class ('quality') from remainder of the training data<br/>X = df_wine.drop(columns = 'quality')<br/>y = df_wine[['quality']]</span><span id="3262" class="na nb je mw b gy ng nd l ne nf"># Splitting the data into training and validation sets<br/>X_train, X_val, y_train, y_val = train_test_split(X, y, random_state = 42)</span><span id="e9a3" class="na nb je mw b gy ng nd l ne nf"># MODEL TRAINING AND LOGGING<br/># ------------------------------------------------------------------------------<br/># Defining model parameters<br/>alpha = 1<br/>l1_ratio = 1</span><span id="2616" class="na nb je mw b gy ng nd l ne nf"># Running MLFlow script<br/>with mlflow.start_run():</span><span id="513b" class="na nb je mw b gy ng nd l ne nf"># Instantiating model with model parameters<br/>    model = ElasticNet(alpha = alpha,<br/>                       l1_ratio = l1_ratio)</span><span id="692a" class="na nb je mw b gy ng nd l ne nf"># Fitting training data to the model<br/>    model.fit(X_train, y_train)</span><span id="10a5" class="na nb je mw b gy ng nd l ne nf"># Running prediction on validation dataset<br/>    preds = model.predict(X_val)</span><span id="427b" class="na nb je mw b gy ng nd l ne nf"># Getting metrics on the validation dataset<br/>    rmse = mean_squared_error(preds, y_val)<br/>    abs_error = mean_absolute_error(preds, y_val)<br/>    r2 = r2_score(preds, y_val)</span><span id="fe67" class="na nb je mw b gy ng nd l ne nf"># Logging params and metrics to MLFlow<br/>    mlflow.log_param('alpha', alpha)<br/>    mlflow.log_param('l1_ratio', l1_ratio)<br/>    mlflow.log_metric('rmse', rmse)<br/>    mlflow.log_metric('abs_error', abs_error)<br/>    mlflow.log_metric('r2', r2)</span><span id="106f" class="na nb je mw b gy ng nd l ne nf"># Logging training data<br/>    mlflow.log_artifact(local_path = '../data/wine/train.csv')</span><span id="65b4" class="na nb je mw b gy ng nd l ne nf"># Logging training code<br/>    mlflow.log_artifact(local_path = './mlflow-wine.py')</span><span id="281b" class="na nb je mw b gy ng nd l ne nf"># Logging model to MLFlow<br/>    mlflow.sklearn.log_model(sk_model = model,<br/>                             artifact_path = 'wine-pyfile-model',<br/>                             registered_model_name = 'wine-pyfile-model')</span></pre><p id="6061" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">在顶部，您会注意到我们首先必须确保脚本指向正确的跟踪服务器。当我们在上一篇文章中部署我们的跟踪服务器时，你可能记得我们在URI mlflow-server.local后面有跟踪服务器本身，并且工件存储(minio)在mlflow-minio.local后面提供。提醒一下，Minio故意模仿AWS的S3，所以如果你想知道为什么我们要设置类似AWS的环境变量，这就是为什么。</p><p id="5eee" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">在加载数据并进行一些基本建模后，我们归结到所有MLflow跟踪的优点。MLflow在这里非常灵活，所以你会注意到我们正在记录/上传所有这些伟大的东西，包括…</p><ul class=""><li id="bdf6" class="ly lz je le b lf lg li lj ll ma lp mb lt mc lx md me mf mg bi translated">因素</li><li id="78f1" class="ly lz je le b lf mi li mj ll mk lp ml lt mm lx md me mf mg bi translated">韵律学</li><li id="9217" class="ly lz je le b lf mi li mj ll mk lp ml lt mm lx md me mf mg bi translated">我们用来运行这个模型的代码</li><li id="f050" class="ly lz je le b lf mi li mj ll mk lp ml lt mm lx md me mf mg bi translated">训练数据本身</li><li id="7b75" class="ly lz je le b lf mi li mj ll mk lp ml lt mm lx md me mf mg bi translated">模型本身</li></ul><p id="6bba" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">说到最后一个，您会注意到一些关于模型命名的特殊语法。这是因为除了在工件注册中心获得模型工件之外，MLflow还将在其MLflow模型注册中心创建一个正式的模型。我们将在下面简要地介绍一下，但是我们将在以后的文章中进一步探讨。(敬请期待！)</p><p id="5c75" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">好了，如果一切正常，您需要做的就是运行以下命令:</p><pre class="mn mo mp mq gt mv mw mx my aw mz bi"><span id="7cdf" class="na nb je mw b gy nc nd l ne nf">python mlflow-wine.py</span></pre><p id="a45b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">我已经多次运行了这个文件，所以这里是我的终端显示的输出。如果您是第一次运行这个程序，您会看到一些类似的东西，但很明显只是一个微小的不同:</p><pre class="mn mo mp mq gt mv mw mx my aw mz bi"><span id="b712" class="na nb je mw b gy nc nd l ne nf">Registered model 'wine-pyfile-model' already exists. Creating a new version of this model...<br/>Created version '3' of model 'wine-pyfile-model'.</span></pre><p id="419b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">还有朋友，真的是这样！但是在我们结束这篇文章之前，让我们进入UI，看看一切都正常工作。打开你的浏览器，跳到mlflow-server.local，你会看到一个类似这样的屏幕:</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nh"><img src="../Images/870281cedc9302615a7bee0dca3aa6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0q5-EbF_QlZgwDfHkcYww.png"/></div></div></figure><p id="a8b6" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">如果您阅读了本系列的第1部分，这看起来会非常熟悉。点击相应的超链接，打开其中一个运行。如果一切正常，您应该看到您刚刚记录的所有适当的信息，包括我们刚刚创建的模型工件。不错！</p><p id="1cd3" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">第1部分中我们没有涉及的另一件事是位于UI左上角的新Models选项卡。单击它，您应该会看到类似这样的内容:</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nh"><img src="../Images/8bf8a8d3b3e164ab670babba7edfa8ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eObf8e02pp3voHcORzU8Zg.png"/></div></div></figure><p id="f623" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">这个用户界面很酷。您不仅可以提供模型的全面描述，还可以将模型的特定版本设置为不同的阶段。例如，您可以将“版本2”设置为转移，“版本3”设置为生产，“版本1”设置为归档。这个功能真的很棒，当我们在未来的帖子中探索更多东西时，它会非常方便。</p><p id="8069" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">当然，尽管UI很棒，但我们真的应该以编程方式做所有事情，MLflow在这方面也有我们的支持。但是我认为我们今天在一个很好的地方停下来，所以我们将继续并结束。在下一篇文章中，我们将从一个更加程序化的角度来看如何与这个UI交互，然后在接下来的两篇文章中，我们将展示如何将这个模型注册表中的模型部署到一个真实的生产环境中，从而真正开始使用gas。在此之前，感谢阅读！注意安全，朋友们！</p></div></div>    
</body>
</html>