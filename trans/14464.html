<html>
<head>
<title>Using SQL to Play ‘Have You Ever?’</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SQL玩‘你有过吗？’</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-sql-to-play-have-you-ever-4e1ab7c99967?source=collection_archive---------43-----------------------#2020-10-05">https://towardsdatascience.com/using-sql-to-play-have-you-ever-4e1ab7c99967?source=collection_archive---------43-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a199" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">高级SQL技术第2部分:collect_list、group_concat、agg_array、string_agg等等</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/985b2f676ca8756493c6f2b05e2d5b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_JkhyPWyWYFn0ufCjR76YA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=707200" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/brrr-910186/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=707200" rel="noopener ugc nofollow" target="_blank">好友痞子</a></p></figure><p id="3087" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">学习使用高级SQL技术可以在两个方面帮助你。它使您能够更快地获得洞察力，如果您使用输出进行进一步分析，您可以以最有效的布局清理和格式化数据。如果您的数据已经到达一个可以直接在python中使用的格式良好的列表中，该怎么办？让我们回顾一下不同数据库中的一些技术，继续使用我在以前的<a class="ae ky" rel="noopener" target="_blank" href="/how-to-set-up-ms-sql-server-on-aws-c1105ce08fb4">文章</a>中使用的恶劣天气细节数据。</p><p id="1e58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这很重要，但我不想只讨论代码的语法，而是想把重点放在业务用例上。学习如何找出哪种技术可以帮助你回答业务问题是至关重要的。为了让它变得有趣，我喜欢关注那些超出典型范围的问题。好吧，<a class="ae ky" rel="noopener" target="_blank" href="/hey-data-were-there-any-sharknados-in-2020-b616932faced"> Sharknado的文章</a>有点出格。</p><h2 id="c169" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">这个问题</h2><blockquote class="mo mp mq"><p id="931d" class="kz la mr lb b lc ld ju le lf lg jx lh ms lj lk ll mt ln lo lp mu lr ls lt lu im bi translated">佛罗里达，你曾经…经历过导致生命损失的天气事件吗？</p><p id="e97e" class="kz la mr lb b lc ld ju le lf lg jx lh ms lj lk ll mt ln lo lp mu lr ls lt lu im bi translated">给我一份所有死亡事件的清单。</p></blockquote><h2 id="71c2" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">用SQL怎么回答这个问题？</h2><p id="792f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">答案取决于你的数据库。每个数据库可能需要稍微不同的SQL。这也取决于你希望你的结果如何格式化。</p><p id="4821" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要考虑的事项:</p><p id="50b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请求者将如何使用该列表？如果他们要将列表传递给python程序，您需要提供不同的格式，以便他们将列表剪切并粘贴到PowerPoint演示文稿中。</p><p id="dc2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你想要那个列表排序吗？您希望对列表进行重复数据删除吗？</p><h2 id="add8" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">数据</h2><p id="b74c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">数据本质上是“垂直的”,由每个事件的时间戳列出。我们的目标是将这个事件数据展平成一列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/1953e4a9d67fa757c9e4c8e034c939f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x2klRrWAy77PC98ufygVeA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">样本风暴数据—作者截图</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/2bcae53049de90d3f9ceb39c5cbd3bdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-CvrI5XqOeBzlJnUbCgS0Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">样本风暴数据—作者截图</p></figure><p id="5f31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想在家玩，这里有一个数据链接:</p><div class="nc nd gp gr ne nf"><a href="https://www.ncdc.noaa.gov/ncei-severe-weather-data-inventory" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">NCEI的恶劣天气资料目录</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">恶劣天气数据目录(SWDI)是美国恶劣天气记录的综合数据库。</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">www.ncdc.noaa.gov</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><h2 id="e882" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">MySQL: GROUP_CONCAT()</h2><p id="b7c8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">MySQL Group_Concat返回找到的元素的列表，以逗号分隔。它没有类似python的列表格式["c "，" d "，" e "，" f"]。您可以使用一些额外的代码来创建这种格式，如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f4868308ac28a42d34eec4926a87478e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-5EmEbIyPVw95VScBCBlg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MySQL Group_Concat —作者截图</p></figure><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="b6ca" class="lv lw it nw b gy oa ob l oc od">SELECT <br/>   STATE                                                           <br/>,  CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>        THEN 1 ELSE 0 <br/>        END      AS DEADLY_EVENT<br/>,  SUM(CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>            THEN 1 ELSE 0 END) <br/>       AS TOTAL_DEADLY_EVENTS<br/>, COUNT(*)  AS TOTAL_EVENT_COUNT<br/>, GROUP_CONCAT(EVENT_TYPE)  AS EVENT_LIST<br/>, GROUP_CONCAT(DISTINCT EVENT_TYPE) AS UNIQUE_EVENT_LIST<br/>, CONCAT('[' , GROUP_CONCAT( DISTINCT CONCAT( '\"', EVENT_TYPE ,'\"')), ']') AS UNIQUE_EVENT_LIST_BRACKETED<br/>FROM severe_events_details<br/>WHERE STATE = 'FLORIDA'<br/>GROUP BY STATE, (CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>THEN 1 ELSE 0 END)<br/>ORDER BY COUNT(*) DESC</span></pre><h2 id="429a" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">雪花:ARRAY_AGG()和LISTAGG()</h2><p id="89ef" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果请求者想要一个重复数据删除的python列表，那么ARRAY_AGG(DISTINCT)就是您所需要的。如果他们想要一个简单易读的列表，LISTAGG()就很好。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/220206166857698ae8c945ec85ceeab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v0kNBnBhq_IoQVcnFWNh8g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">雪花数组_Agg —作者截图</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/893c5f9736b75c9465a79b995a4b4c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AOj3t7c-11--5-Hclq96qg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">雪花数组_Agg —作者截图</p></figure><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="6e33" class="lv lw it nw b gy oa ob l oc od">SELECT <br/>   STATE AS STATE<br/>,  CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>        THEN 1 ELSE 0 END      AS DEADLY_EVENT<br/>,  SUM(CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>             THEN 1 ELSE 0 END) AS TOTAL_DEADLY_EVENTS<br/>, COUNT(*)  AS TOTAL_EVENT_COUNT<br/>, ARRAY_AGG(EVENT_TYPE) AS EVENT_LIST<br/>, ARRAY_AGG(DISTINCT EVENT_TYPE) AS UNIQUE_EVENT_LIST<br/>, LISTAGG(DISTINCT EVENT_TYPE ,', ')  AS UNIQUE_LIST_AGG</span><span id="d001" class="lv lw it nw b gy og ob l oc od">FROM MEDIUM_DEMO.PUBLIC.WEATHER_EVENT_DETAILS<br/>WHERE STATE = 'FLORIDA'<br/>GROUP BY STATE, (CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 THEN 1 ELSE 0 END)<br/>ORDER BY COUNT(*) DESC</span></pre><h2 id="b1ac" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">MS SQL-SERVER TSQL: STRING_AGG()</h2><p id="6913" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">TSQL有点混乱。创建完整列表和唯一列表需要分成两个不同的查询。请求时，Sting_Agg不允许使用Distinct。</p><p id="e63b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以得到你需要的东西，但是要达到它需要更多的工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/3cacc2307f9c04cfd820c06b28d9e146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dVBTb0h7A7ENogBREFpLCg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TSQL String_Agg —作者截图</p></figure><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="01d7" class="lv lw it nw b gy oa ob l oc od">SELECT</span><span id="7881" class="lv lw it nw b gy og ob l oc od">STATE  AS STATE</span><span id="9a0e" class="lv lw it nw b gy og ob l oc od">,  CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>        THEN 1 ELSE 0 END      AS DEADLY_EVENT</span><span id="20a7" class="lv lw it nw b gy og ob l oc od">,  SUM(CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>         THEN 1 ELSE 0 END) AS TOTAL_DEADLY_EVENTS</span><span id="b6c8" class="lv lw it nw b gy og ob l oc od">, COUNT(*)  AS TOTAL_EVENT_COUNT</span><span id="0149" class="lv lw it nw b gy og ob l oc od">, STRING_AGG(CAST(EVENT_TYPE AS NVARCHAR(MAX)) , ',')                        AS EVENT_LIST</span><span id="1dee" class="lv lw it nw b gy og ob l oc od">FROM demo.dbo.[StormEvents_details-ftp_v1.0_d2020_c20200922]</span><span id="10da" class="lv lw it nw b gy og ob l oc od">WHERE STATE = 'FLORIDA'</span><span id="b6a9" class="lv lw it nw b gy og ob l oc od">GROUP BY STATE, (CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 THEN 1 ELSE 0 END)</span><span id="8fb6" class="lv lw it nw b gy og ob l oc od">ORDER BY COUNT(*) DESC</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/a053a7090caf448a9189d449248db27e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ATZFjY8cDxgxHAvxqzI3w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TSQL String_Agg —作者截图</p></figure><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="a2c7" class="lv lw it nw b gy oa ob l oc od">SELECT</span><span id="834f" class="lv lw it nw b gy og ob l oc od">STATE AS STATE<br/>,  CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>        THEN 1 ELSE 0 END      AS DEADLY_EVENT</span><span id="d957" class="lv lw it nw b gy og ob l oc od">,  SUM(CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 <br/>             THEN 1 ELSE 0 END) AS TOTAL_DEADLY_EVENTS<br/>, COUNT(*)  AS TOTAL_EVENT_COUNT</span><span id="7d85" class="lv lw it nw b gy og ob l oc od">, STRING_AGG(CAST(EVENT_TYPE AS NVARCHAR(MAX)) , ',')                        AS UNIQUE_EVENT_LIST</span><span id="ec9e" class="lv lw it nw b gy og ob l oc od">, CONCAT('[' , (STRING_AGG(CONCAT('"', CAST(EVENT_TYPE AS NVARCHAR(MAX)) , '"'), ',')) , ']')   AS UNIQUE_EVENT_LIST_BRACKETED</span><span id="5104" class="lv lw it nw b gy og ob l oc od">FROM</span><span id="b6e3" class="lv lw it nw b gy og ob l oc od">(SELECT DISTINCT STATE, EVENT_TYPE, DEATHS_DIRECT,DEATHS_INDIRECT</span><span id="2a20" class="lv lw it nw b gy og ob l oc od">FROM demo.dbo.[StormEvents_details-ftp_v1.0_d2020_c20200922]) X</span><span id="8182" class="lv lw it nw b gy og ob l oc od">WHERE STATE = 'FLORIDA'</span><span id="0cbe" class="lv lw it nw b gy og ob l oc od">GROUP BY STATE, (CASE WHEN DEATHS_DIRECT &gt; 0 OR DEATHS_INDIRECT &gt; 0 THEN 1 ELSE 0 END)</span><span id="5578" class="lv lw it nw b gy og ob l oc od">ORDER BY COUNT(*) DESC</span></pre><h2 id="f412" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">Hive和Spark SQL: COLLECT_SET和COLLECT_LIST</h2><p id="d80c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Collect_List返回所有值。Collect_Set返回唯一值。</p><p id="973d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">COLLECT_LIST(EVENT_TYPE)返回[Rip电流，Rip电流，闪电，Rip电流]</p><p id="6928" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">COLLECT_SET(EVENT_TYPE)返回[Rip电流，闪电]</p><h1 id="da2d" class="oj lw it bd lx ok ol om ma on oo op md jz oq ka mg kc or kd mj kf os kg mm ot bi translated">结论</h1><p id="c748" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">根据您的需要和您的数据库，使用SQL有许多方法来回答一个业务问题。当您经常在平台之间切换时，所有的命令开始融合在一起。这就是为什么如果有人告诉我他们编码时很少使用谷歌，我会立刻不信任他们。除非他们连续几年只使用一种语言，否则我会把他们叫出来。</p></div></div>    
</body>
</html>