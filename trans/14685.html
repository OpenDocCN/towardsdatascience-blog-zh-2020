<html>
<head>
<title>Direct Query in Power BI — What, When &amp; Why?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Power BI中的直接查询—什么、何时以及为什么？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/direct-query-in-power-bi-what-when-why-8180825812d2?source=collection_archive---------5-----------------------#2020-10-10">https://towardsdatascience.com/direct-query-in-power-bi-what-when-why-8180825812d2?source=collection_archive---------5-----------------------#2020-10-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d86e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于DirectQuery您想知道但不敢问的一切！导入模式的Power BI替代方案的最终指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c9fd33bf62b1fe2d69449dd8e6d43aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*abJAFlHtpNG9E0w9RhCMkA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">皮查拜在Pexels.com拍摄的照片</p></figure><p id="2323" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用Power BI时，您需要首先做出以下决定:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/f9a73aff8a0f208795014729d4c4698a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*nsfyQBBHpzrcymS1ZKK9MQ.png"/></div></figure><p id="82aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦您计划获取一些数据，Power BI会要求您选择数据连接模式。如果您已经阅读了<a class="ae lv" rel="noopener" target="_blank" href="/how-to-reduce-your-power-bi-model-size-by-90-b2f834c9f12e">这篇文章</a>，或者更好，从<a class="ae lv" rel="noopener" target="_blank" href="/vertipaq-brain-muscles-behind-power-bi-eecd6c8891e3">这篇文章</a>开始，您可能会熟悉导入选项，以及表格模型如何在Power BI的背景下支持您的查询并生成闪电般快速的报告。</p><p id="acd1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我想更深入地研究DirectQuery选项，因为我感觉这个选项仍然没有得到充分利用(不管是好是坏，我们将在本文中进行探讨)。</p><h2 id="ea75" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">什么是DirectQuery？</h2><p id="32cf" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">顾名思义，DirectQuery是一种检索数据的方法，它在查询时间 直接从数据源<strong class="la iu"> <em class="mu">中提取数据！这句话的最后一部分掌握着关键—虽然导入模式将数据的快照存储在内存中，但DirectQuery (DQ)不存储任何数据。对于每一个请求，它都直接进入数据源(在99%的情况下是SQL数据库)，并从那里提取数据。</em></strong></p><p id="d2ef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="mu">因此，在查询执行之前、期间和之后，数据都驻留在其原始源中！</em>T11】</strong></p><p id="aa61" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在与报表交互时，您的用户会生成一个查询(或者大多数情况下是一组查询)，需要执行该查询才能满足请求。您可能还记得本文中的<a class="ae lv" rel="noopener" target="_blank" href="/inside-vertipaq-in-power-bi-compress-for-success-68b888d9d463">，表格模型由公式引擎(FE)和存储引擎(SE)组成。Formula Engine接受请求，创建查询计划，然后根据您在Import和DirectQuery模式之间的选择，生成针对相应数据源的查询。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ad1132b1067c9310045b311847cddba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUkicOT08-nPcWplF9iLdQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Pexels.com上Lum3n的照片</p></figure><p id="3f56" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可能会注意到，当您选择DQ选项时，公式引擎会将DAX“翻译”为SQL，并将查询直接发送到数据源。</p><p id="ba92" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦选择了DirectQuery选项，Power BI将不会从底层表中导入数据。它将只保存它们的元数据。</p><p id="ee67" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好消息是:您可以在Power BI中使用复合模型。简而言之，这意味着您可以在数据模型中结合DQ和导入模式，为每个表设置首选选项！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/4fa35480603fe5210de2f84313a06326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WBKtCs-ecQCZ0eP41CJg-w.png"/></div></div></figure><p id="231c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您可能看到的，一旦我使用DQ选项创建了Power BI数据模型，当我在model视图中打开我的数据时，在Advanced下，我可以选择对所选表应用哪种存储模式。<em class="mu">重要提示</em>:您可以从直接查询模式切换到导入模式，但不能从导入模式切换到直接查询模式！</p><p id="5534" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">双重模式就像一个混合体——导入模式和DirectQuery的结合。表中的数据被加载到内存中，但是在查询时，也可以直接从源中检索。</p><h2 id="2999" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">什么时候使用DirectQuery？</h2><p id="704c" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">老实说，这是一个“百万美元”的问题:)…而且，和大多数情况一样，唯一正确的答案是:<strong class="la iu"> <em class="mu">【看情况】</em> </strong>。但是，让我们看看这取决于什么！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1e041c907c21df2a832a0429697286be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yL9erdVE7TjkdQrvJphnHA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">乔治·贝克尔在Pexels上的照片</p></figure><ul class=""><li id="3293" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated">您需要“实时”或接近实时的数据吗？如果您对这些问题的回答是:是的，您应该考虑使用DirectQuery模式。为什么？因为，导入模式会保存数据的快照，并且需要定期刷新以获取最新数据。例如，如果您需要最大延迟为1分钟的数据，使用导入模式实际上是不可能的</li><li id="d284" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">您的数据模型规模大吗？我说的大，就是大！大到你无法在最大限度内容纳它。pbix文件大小(专业版许可1 GB，高级版/嵌入式版10 GB)。假设您的用户需要在高粒度级别上分析十亿行表中的数据。您不能简单地将十亿行的表数据导入到表格模型中，相反，数据会保留在源中，并且在细化的结果返回到报表之前，您的聚合/计算会在源中执行</li></ul><h2 id="663b" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">为什么(不)使用DirectQuery？</h2><p id="9893" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">如果您的工作负载需要上述场景之一(“实时”分析和/或过大的数据模型)，DirectQuery将是一个显而易见的选择。</p><p id="411f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，让我们研究一下在更频繁的情况下使用DirectQuery的一些一般优缺点:</p><p id="101c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用DirectQuery时最重要的考虑是，整体用户体验几乎完全取决于底层数据源的性能。这意味着，如果您的源数据库没有针对分析工作负载进行优化(缺少索引；不适当的索引；数据建模不充分，以至于查询需要针对多个表)，您的报表性能会很差！</p><p id="ca47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，与报告并行交互的用户数量也会产生影响。想象一下这样一个场景，10个人浏览带有20个视觉效果的报告页面——这将同时生成对底层数据源的200个查询！请记住，每个可视化将生成(至少)一个对数据源的查询！</p><p id="5216" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，如果您有机会通过应用不同的技术来改善这两个方面，您还应该记住，有些事情是您无法控制的，例如:</p><ul class=""><li id="f525" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated"><em class="mu">源服务器的性能</em> —例如，如果在同一台服务器上运行数十种不同的工作负载，您将无能为力</li><li id="d57f" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated"><em class="mu">网络延迟</em></li></ul><h2 id="155e" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">优化数据源的技术</h2><p id="4e6e" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">正如我上面提到的，有不同的技术可以提高数据源的性能(假设您可以访问底层数据源，并且可以应用结构性更改)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cf6d6aca1702b2aacc23996b22940a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m8cJhXIfLLwycv18XoBpqg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">皮查拜在Pexels.com拍摄的照片</p></figure><ul class=""><li id="02df" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated"><strong class="la iu"> <em class="mu">添加合适的索引</em></strong>——支持你最详尽的查询。您应该考虑为大型分析工作负载创建<a class="ae lv" rel="noopener" target="_blank" href="/rows-or-columns-where-should-i-put-my-index-on-65d429692dee">列存储索引</a>，但是设计良好的B树索引也应该提高性能</li><li id="6fbd" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated"><strong class="la iu"> <em class="mu">数据完整性到位</em> </strong> —确保维度表包含正确的键，并且这些键与事实表相关(每个事实表键值在维度表中都有相应的值)</li><li id="e0df" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated"><strong class="la iu"> <em class="mu">在源数据库</em> </strong>中创建持久对象——这意味着，尝试物化所有的聚合、转换和计算，无论是在特殊的表中还是在<a class="ae lv" href="https://docs.microsoft.com/en-us/sql/relational-databases/views/create-indexed-views?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">索引视图</a>中。这样，Power BI可以从一个地方检索所有数据，而不是每次执行查询时都执行复杂的操作(比如多个表之间的连接)</li><li id="3908" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated"><strong class="la iu"> <em class="mu">使用源系统</em> </strong>中的数据表——每一个(合适的)数据模型都应该依赖一个<a class="ae lv" rel="noopener" target="_blank" href="/tiq-part-1-how-to-destroy-your-power-bi-model-with-auto-date-time-8fec32b22aff">单独的日期维度</a>。确保您已经在数据库中建立了<a class="ae lv" rel="noopener" target="_blank" href="/tiq-part-3-ultimate-guide-to-date-dimension-creation-98b951ffa68c">日期表</a></li></ul><h2 id="3760" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">Power BI和DirectQuery最佳实践</h2><p id="ba6e" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">一旦您使用了Power BI，在使用DirectQuery模式时，您应该坚持以下最佳实践:</p><ul class=""><li id="0b3b" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated"><strong class="la iu"> <em class="mu">避免复杂的Power Query转换</em> </strong> —每次将转换应用到数据模型时，Power Query都会生成一个查询并将其发送到源数据库。假设我想用783替换我所有的ProductKey值782。如果我在超级查询编辑器中这样做，会发生以下情况:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/e2efe8497616d2c13a55f58282784947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQEOOjAb9cwu99ulcwXuxw.png"/></div></div></figure><p id="c356" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以看到Power Query为满足我们的请求而生成的M语句，但是如果您右键单击该步骤并选择View Native Query选项，您还可以看到将被发送到SQL Server数据库的SQL查询:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/8cbe7f57e16ecc0ab5eafca0711f2032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhtzT796zM3vPkr7-zbRVw.png"/></div></div></figure><p id="5bd9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，对于这些简单的转换，Formula Engine足够智能，可以在一次迭代中完成所有工作。但是，如果您执行一些更复杂的东西，打开SQL Server Profiler或DAX Studio，看看有多少请求被发送到您的源数据库…</p><ul class=""><li id="bb46" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated">如果您需要使用<strong class="la iu"> <em class="mu">计算列</em> </strong>，请尝试将它们的创建推送到源数据库并保持它们的持久性</li><li id="bdd3" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">避免复杂的DAX度量——由于您的DAX语句需要“翻译”成SQL，请记住，此过程可能会产生昂贵的SQL查询。同样，只要有可能，在源端执行所有的计算</li><li id="1fde" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">避免GUID列(唯一标识符)上的关系— Power BI不支持这种数据类型，需要在查询执行期间应用一些数据转换，这会影响性能。解决方案是在Power BI生成自己的查询之前，在源数据库中转换这种数据类型</li><li id="6348" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">尽可能限制并行度—您可以定义DQ可以同时打开的最大连接数:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/cc7686955a78c77c38f507f4ba0b8732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c3ue31uv0p90BG4-u8FwdA.png"/></div></div></figure><p id="b6b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果转到“选项”,在“当前文件”下，可以为每个数据源的最大连接数指定一个值(默认为10)。</p><ul class=""><li id="eb94" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated">在Power BI报告中，几乎没有额外的优化选项:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/e3eaba297470d3dface3bb9377359d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I-XMtsOHQABpO4s9EeiTuw.png"/></div></div></figure><p id="bdfb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些选项中的大多数都是不言自明的。基本上，您可以限制切片器和过滤器，因为默认情况下，当您更改一个切片器值时，所有切片器都会生成对数据源的查询(即使是那些没有更改的数据)！</p><p id="1079" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，您可以添加“应用”按钮，以便用户可以具体选择需要刷新的数据部分。当然，这将影响您的报表设计，因为您需要为这些按钮提供额外的空间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/6e245dce1f38eca9d2d9379952e881a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9V0NYGiEubbOd_cAMwFdw.png"/></div></div></figure><p id="2eb7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你还应该仔细想想报表页面上的<a class="ae lv" rel="noopener" target="_blank" href="/how-i-speed-up-my-power-bi-report-5x-155255415895"> <strong class="la iu"> <em class="mu">视觉效果的数量</em> </strong> </a> —视觉效果越多，数据检索所需的时间就越长。</p><p id="7552" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，你应该<strong class="la iu"> <em class="mu">关闭视觉效果之间的交叉高亮和交叉过滤</em> </strong>，因为这将减少生成的查询数量。您可以在整个报告级别上关闭这些功能(在选项- &gt;查询缩减- &gt;中，选中选项:默认情况下禁用交叉突出显示/过滤)，或者仅针对特定视觉效果关闭这些功能。</p><p id="011c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还有一个非常重要的建议— <strong class="la iu"> <em class="mu">与您的用户</em> </strong>交谈，尝试向他们解释导入模式和DirectQuery之间的区别，他们使用这两种模式中的每一种可以获得什么好处，以及预计会有哪些缺点(尤其是在选择DQ模式时)。</p><h2 id="598d" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">结论</h2><p id="c69c" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">正如你自己可能得出的结论:<strong class="la iu"> <em class="mu">如果你正在考虑使用DirectQuery，为工作选择正确的工具</em> </strong>是最好的建议。</p><p id="413a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在做出最终决定之前，请仔细评估您的潜在工作负载，并尝试确定导入和DirectQuery方法的所有优缺点。</p><p id="0c98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p><p id="54bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lv" href="https://datamozart.medium.com/membership" rel="noopener">成为会员，阅读媒体上的每一个故事！</a></p><p id="8e7b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">订阅<a class="ae lv" href="http://eepurl.com/gOH8iP" rel="noopener ugc nofollow" target="_blank">这里</a>获取更多有见地的数据文章！</p><p id="99ca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lv" href="https://youtu.be/7dssvnKEmCA" rel="noopener ugc nofollow" target="_blank">https://youtu.be/7dssvnKEmCA</a></p></div></div>    
</body>
</html>