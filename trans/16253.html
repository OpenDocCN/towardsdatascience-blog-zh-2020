<html>
<head>
<title>US Election Choropleth with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python的美国选举Choropleth</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/us-election-choropleth-with-python-bad8e355f1bd?source=collection_archive---------29-----------------------#2020-11-09">https://towardsdatascience.com/us-election-choropleth-with-python-bad8e355f1bd?source=collection_archive---------29-----------------------#2020-11-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9cff" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何创建美国选举结果的时间序列图表</h2></div><p id="45d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这次美国大选带来了高度紧张，毫无根据的欺诈指控，最重要的是，一些伟大的形象化。至少对数据科学家来说很重要。看起来你在任何地方都看不到展示选举结果的新方法。那么，为什么不多加几个呢？在本教程中，你将学习如何使用Python创建一些你自己的可视化。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/aac375dcd88fe17098b18201efbcc613.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fQQtzM261lE5EGth-_GYjA.gif"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:作者</p></figure><p id="d5d5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将学习如何创建两个从1976年到2016年美国总统选举结果的互动合唱曲。第一张地图有一个时间滑块。当您移动滑块时，地图将会改变以显示给定年份每个州的结果。对于第二张地图，每个州都变成了一个按钮。您可以单击状态来查看一段时间内的投票趋势。我们会检查代码，你可以在<a class="ae lu" href="https://github.com/conorosully/medium-articles" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到完整的项目。你也可以在这里下载<a class="ae lu" href="https://github.com/conorosully/medium-articles/tree/master/maps" rel="noopener ugc nofollow" target="_blank">的地图</a>。您应该能够在浏览器中打开并浏览它们。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lv"><img src="../Images/bd5bba7a6677d5fbd30b06ad70bd5679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3M6vuM3vEP1gtTcbyy1RQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">来源:<a class="ae lu" href="https://www.flaticon.com/packs/united-states-presidential-election-10?word=election" rel="noopener ugc nofollow" target="_blank"> flaticon </a></p></figure><h1 id="c750" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Python包</h1><p id="50d2" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们将使用<a class="ae lu" href="https://python-visualization.github.io/folium/" rel="noopener ugc nofollow" target="_blank">叶子</a>来构建地图。这是一个非常有用的软件包，用于创建简单的地理空间数据可视化。除了leav，我们还将使用一些其他的Python包。您可以使用下面的代码导入它们。确保你已经安装了所有的软件包。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="9323" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据源</h1><h2 id="047b" class="mv lx it bd ly mw mx dn mc my mz dp mg kr na nb mi kv nc nd mk kz ne nf mm ng bi translated">美国形状文件</h2><p id="e248" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们需要的第一个数据集是一个<a class="ae lu" href="https://alicia.data.socrata.com/Government/States-21basic/jhnu-yfrj/data" rel="noopener ugc nofollow" target="_blank">美国形状文件</a>。shapefile是一种用于存储地理空间矢量数据的文件格式。在我们的例子中，我们有一组定义美国各州边界的坐标。我们将数据作为地理数据框读入。数据框的51行中的每一行都给出了国家的名称和坐标(即几何图形)。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="e3d3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们使用这个shapefile来创建我们的第一个叶子地图。在下面的代码中，我们初始化了地图。通过设置location=[50.77500，-100]，地图打开时会聚焦美国。然后，我们使用US shapefile和GeoJson函数向地图添加一个choropleth。在图1中，您可以看到这段代码创建的地图。shapefile为我们提供了一个工作基础，但我们需要另一个数据集来获得选举结果。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nh"><img src="../Images/5a7786467c5bc8787b6b3fb0448185b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUmDUmbZVQwgNYWDn1uEaw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图1:美国形状文件choropleth</p></figure><h2 id="4fe4" class="mv lx it bd ly mw mx dn mc my mz dp mg kr na nb mi kv nc nd mk kz ne nf mm ng bi translated">选举结果数据集</h2><p id="2ccb" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对于选举结果，我们使用麻省理工学院选举数据和科学实验室提供的数据集。它包含了1976年至2016年的美国总统选举结果。该数据集包含每个州、年份和当年参选的候选人的一行。为了使事情变得简单一点，我们应该首先将这个数据集转换成不同的格式。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="b71f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用下面的代码，我们将数据集转换成一个嵌套字典。对于每一年，我们都有一个以州名为关键字的字典。对于每个州，都有一本字典给出民主党和共和党候选人的票数。该词典的格式如下:</p><pre class="lf lg lh li gt ni nj nk nl aw nm bi"><span id="e568" class="mv lx it nj b gy nn no l np nq">{<br/>  &lt;year&gt;: { <br/>    &lt;state&gt; : {'dem':&lt;#votes&gt;, 'rep':&lt;#votes&gt;},<br/>    &lt;state&gt; : {'dem':&lt;#votes&gt;, 'rep':&lt;#votes&gt;},<br/>    ...},<br/>  ...<br/>}</span></pre><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="1b7f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">将数据可视化</h1><p id="e9bb" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在我们进入交互式地图之前，让我们使用这些数据集来创建一个简单的choropleth。我们首先需要定义两个函数。<strong class="kk iu"> state_style </strong>函数返回一个字典，用来定义一个州的颜色和边界。在某一年，如果一个州投了民主党的票，它就变成蓝色；如果它投了共和党的票，它就变成红色。根据是由<strong class="kk iu"> style_dictionary </strong>还是<strong class="kk iu"> style_function </strong>使用，该函数返回的词典略有不同。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2896" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于这个choropleth，我们将使用一个<strong class="kk iu">样式_函数</strong>。GeoJson包使用此函数将GeoJson要素映射到样式。在我们的示例中，GeoJson要素将包含状态信息(即名称和几何)。这些特征由GeoJson包传递给<strong class="kk iu"> style_function </strong>。通过设置year=2016，我们使用2016年选举的结果来定义每个州的风格。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="f7c6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在可以使用这些函数来创建我们的第一个choropleth。该代码与我们用来创建第一张地图的代码非常相似。唯一的区别是我们现在将<strong class="kk iu"> style_function </strong>传递给GeoJson函数。如前所述，这给每个州一种基于选举结果的颜色。生成的地图如图2所示。现在，让我们看看如何改进这张地图，使它更具互动性。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nr"><img src="../Images/4bdedd44cda83591762f889592c9cc99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qsb_O4GbVZXhpBs6ZqqMcA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图2: 2016年选举结果</p></figure><h2 id="1f4a" class="mv lx it bd ly mw mx dn mc my mz dp mg kr na nb mi kv nc nd mk kz ne nf mm ng bi translated">地图1: Choropleth滑块</h2><p id="c45f" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们首先创建一个带有时间滑块的choropleth地图。使用函数TimeSliderChoropleth <strong class="kk iu"> </strong>完成。该函数假设所有日期都是Unix时间格式(即时间戳)。因此，我们使用<strong class="kk iu"> year_to_ts </strong>函数将选举年份转换为时间戳。例如，2016年将被转换为“1451606400”。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6bd8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要定义的第二个函数，<strong class="kk iu"> style_dictionary </strong>，返回一个样式字典。这与<strong class="kk iu"> style_function </strong>类似，只是我们现在处理的是时间序列数据。所以，对于每一个州，我们需要定义从1976年到2016年每一年的风格。<strong class="kk iu"> style_dictionary </strong>函数返回如下形式的嵌套字典:</p><pre class="lf lg lh li gt ni nj nk nl aw nm bi"><span id="4a4b" class="mv lx it nj b gy nn no l np nq">{<br/>  &lt;ID&gt;: { <br/>    &lt;timestamp&gt; : {'opacity':1, 'color':&lt;hex_color&gt;},<br/>    &lt;timestamp&gt; : {'opacity':1, 'color':&lt;hex_color&gt;},<br/>    ...},<br/>  ...<br/>}</span></pre><p id="ea57" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面提到的ID是给予一个国家的唯一ID。由<strong class="kk iu">自动分配。to_json() </strong>函数。TimeSliderChoropleth使用这些id将状态映射到它们的样式。因此，为了确保我们有正确的映射，我们首先创建一个从ID到州名的映射。这是在下面的第7到13行中完成的。该函数的其余部分用上面看到的形式创建字典。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="5420" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在准备创建我们的地图。同样，代码与之前类似，只是我们使用了TimeSliderChoropleth函数并传入了一个样式字典。代码的结果如图3所示。你可以滑动地图上方的滚动条来查看不同时间的选举结果。例如，从2012年到2016年，我们可以看到几个州变红。这导致了共和党候选人的胜利。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/3c9131b705757ec34b08be35e629418a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*0yjHAlbrlEHAWv2vex8HMQ.gif"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图3: Choropleth滑块</p></figure><p id="3c42" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们应该提到上面第6行中保存地图的代码。这一行将地图保存为HTML文件。您可以在任何浏览器中打开并浏览它。如果您正在使用jupyter笔记本，地图也会显示在您的代码块下方。如果地图太复杂，笔记本可能会出现渲染问题。在这种情况下，您必须保存地图并在浏览器中打开它，然后才能看到它。</p><h2 id="771a" class="mv lx it bd ly mw mx dn mc my mz dp mg kr na nb mi kv nc nd mk kz ne nf mm ng bi translated">地图2: Choropleth按钮</h2><p id="ba4e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对于下一个地图，我们将把每个州变成一个按钮。你可以点击状态来查看一段时间内的投票趋势。首先，为了创建这些趋势图表，我们使用下面的代码。函数为给定的状态创建一个标准的matplotlib图表。在最后几行中，我们将图表转换成HTML，并将其添加到IFrame中。这是为了能够嵌入到我们的叶子地图中。您可以在图5中看到为加利福尼亚制作的图表示例。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/8fa377e64d47075368d83588d672a503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kzszGOZAxAHO0xe2oyCldg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图5:加州投票趋势</p></figure><p id="c262" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在创建按钮choropleth之前，我们必须定义最后一个函数。highlight_style函数用于定义当鼠标悬停在一个状态上时该状态的样式。当这种情况发生时，状态会变得稍微有点阴影。这让我们可以在点击鼠标之前看到它的状态。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="c5a9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，为了创建地图，我们首先使用2016年的结果创建一个choropleth。我们使用与图2中的地图完全相同的代码来实现这一点。然后，使用每个状态的几何图形，我们创建一个状态标记，并为每个标记添加一个弹出窗口。每个弹出窗口都包含一个上面讨论过的嵌入式图表。单击时，标记将显示弹出窗口，我们将能够看到投票趋势。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="e7cf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以在图4中看到这段代码的结果。您可以看到悬停在一个状态上是如何突出显示它的。德克萨斯和加利福尼亚也被点击来揭示他们的趋势。在笔记本中查看这张地图可能会有一些困难。在这种情况下，将其保存为HTML文件并在浏览器中打开。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ns"><img src="../Images/3fc5bd1cd42fed0a1293dd6d384d6867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*GAoW6QPbicvQ2XjlxKAQrQ.gif"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图4: Choropleth按钮</p></figure><p id="f71c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与本文不同的是，美国大选还没有完全结束。在我写这篇文章的时候，还有一些选票需要统计。当他们完成时，我们将能够用2020年的数据更新可视化。我们会看到一些州改变颜色，而其他州的投票趋势将保持不变。这些变化的原因很复杂。像这样的观想有助于我们理解它们。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h2 id="96ab" class="mv lx it bd ly mw mx dn mc my mz dp mg kr na nb mi kv nc nd mk kz ne nf mm ng bi translated">图像来源</h2><p id="4c46" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">所有图片都是我自己的或从<a class="ae lu" href="http://www.flaticon.com/" rel="noopener ugc nofollow" target="_blank">www.flaticon.com</a>获得的。在后者的情况下，我拥有他们的<a class="ae lu" href="https://support.flaticon.com/hc/en-us/articles/202798201-What-are-Flaticon-Premium-licenses-" rel="noopener ugc nofollow" target="_blank">高级计划</a>中定义的“完全许可”。</p></div></div>    
</body>
</html>