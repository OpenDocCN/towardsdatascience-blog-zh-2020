<html>
<head>
<title>Mapping Your Favorite Coffee Shop in the Philippines using Google Places API and Folium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Places API和leav绘制您在菲律宾最喜欢的咖啡店地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mapping-your-favorite-coffee-shop-in-the-philippines-using-google-places-api-and-folium-2f9d5ad697bf?source=collection_archive---------60-----------------------#2020-10-13">https://towardsdatascience.com/mapping-your-favorite-coffee-shop-in-the-philippines-using-google-places-api-and-folium-2f9d5ad697bf?source=collection_archive---------60-----------------------#2020-10-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ae66" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="0dba" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用Google Places API和leav绘制菲律宾的咖啡馆地图</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/ac95e1d1f9a7143e09055a8a4e25ef1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*96gUTcYzZpHk8IIU"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/@vickygu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Vicky Gu </a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="feb2" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">为什么是咖啡？</h1><p id="c698" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">对我们大多数人来说，咖啡已经成为我们早晨日常生活中不可或缺的一部分。</p><p id="ec1d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">但在很多城市规划研究中，咖啡店的数量已经成为一个地方或一个城市发展水平的标志。这并不奇怪，因为咖啡店是商业和客户会议的场所，而且位于商业区，忙碌的员工需要快速获得咖啡。</p><p id="ec0f" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">因此，仅仅通过知道一个地方咖啡店的数量，就能告诉我们一些有价值的东西。但是我们如何进行呢？</p><h1 id="e0d9" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated"><strong class="ak">数据科学如何改善这一过程</strong></h1><p id="d0fc" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">既然我们知道了这些数据的重要性，那么我们应该如何收集这些数据呢？</p><p id="3b1f" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">一些咖啡连锁店有一个位置列表，可以在他们的网站上找到，我们可以通过复制信息并自己对数据进行地理编码来手动获取。</p><p id="4b8b" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">但是这将导致冗长的过程，容易出错，并且可能需要更长的时间来清理。</p><p id="0f2a" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">这就是数据科学的魔力所在。对于本教程，让我们使用Google API收集数据，并使用follow以HTML格式可视化我们的数据。</p><blockquote class="nb nc nd"><p id="88b7" class="ma mb ne mc b md mw kd mf mg mx kg mi nf my ml mm ng mz mp mq nh na mt mu mv im bi translated">演职员表:我们从artemrys  借用了一些代码，并对其进行了修改，以满足菲律宾城市的需要，并返回比count更多的代码。</p></blockquote></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="d12b" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">分析项目设计</strong></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi np"><img src="../Images/b6d0001961d8a620b0cc0f67bf31f46e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dc2yT0MCzFP76GmNqsAEUg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我们这个项目的设计</p></figure><p id="4409" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">上面的图片总结了我们处理这个项目的过程。<strong class="mc jd">注意，这仅用于数据采集</strong>。我没有把清理和数据可视化放在这里，因为它们通常是通常分析项目的一部分。</p><p id="cc16" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">准备工作</strong></p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="c1e7" class="nv lj it nr b gy nw nx l ny nz">#Preliminaries<br/>from collections import namedtuple<br/>import requests<br/>import csv<br/>import time<br/>import json<br/>import os<br/>import pandas as pd</span><span id="4080" class="nv lj it nr b gy oa nx l ny nz">#For Interactive GeoVisualization<br/>import folium<br/>from folium import Map<br/>from folium.map import Layer, FeatureGroup, LayerControl, Marker<br/>from folium.plugins import MarkerCluster, FeatureGroupSubGroup, Fullscreen</span><span id="d0fe" class="nv lj it nr b gy oa nx l ny nz">#To turn our DataFrame to a GeoDataFrame<br/>import geopandas as gpd<br/>from shapely.geometry import Point, Polygon</span></pre><p id="43ca" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">为什么选择Google API？</strong></p><p id="5173" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在<em class="ne">谷歌地图API </em>和<em class="ne"> OpenStreetMap </em>之间，<em class="ne">谷歌地图API </em>返回更多更新的数据。这可能是因为谷歌使用了更多的资源，拥有了更多的用户。不过需要注意的是，在多次调用后，谷歌开始收费，所以我建议开发者阅读成本矩阵，并在使用API时保持警惕。</p><p id="cb50" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">出于本教程的目的，假设您本月没有使用Google API(<em class="ne">免费层每月刷新</em>)，这不会花费您什么。</p><p id="c4b8" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">测试代码时，将API调用限制在几行内，这样就不会出现耗尽自由层的错误。</p><p id="24f9" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">不言而喻，为了继续，你应该注册一个Google API密钥。</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="90d4" class="nv lj it nr b gy nw nx l ny nz">#the namedtuple method returns a new subclass of tuple with named fields<br/>#this is a convenient way of assigning names to tuples so you can later access them by name<br/>CityCoords = namedtuple("CityCoords", ["city_name", "lat", "lng", "region"])</span><span id="90fd" class="nv lj it nr b gy oa nx l ny nz"># Google Maps Key<br/># GMAPS_KEY = {Place your GMAPS Key here}</span><span id="0a3e" class="nv lj it nr b gy oa nx l ny nz">#Google Place API Request<br/>#Note that we {lat}, {long}, {radius}, {keywords} and {key} will be arguments that we need to supply in later<br/>G_PLACES_API = "<a class="ae lh" href="https://maps.googleapis.com/maps/api/place/nearbysearch/json?location={lat},{lng}&amp;radius={radius}&amp;keyword={keyword}&amp;key={key" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/nearbysearch/json?location={lat},{lng}&amp;radius={radius}&amp;keyword={keyword}&amp;key={key</a>}"</span><span id="05cc" class="nv lj it nr b gy oa nx l ny nz">#Token to skip to next page<br/>G_PLACES_NEXT_PAGE_TOKEN = "<a class="ae lh" href="https://maps.googleapis.com/maps/api/place/nearbysearch/json?pagetoken={page_token}&amp;key={key" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/place/nearbysearch/json?pagetoken={page_token}&amp;key={key</a>}"</span></pre><p id="5829" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">您现在就可以指出您希望形象化的品牌。我最喜欢的四个咖啡品牌是星巴克、咖啡豆和茶叶、蒂姆·霍顿和咖啡计划。</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="15b6" class="nv lj it nr b gy nw nx l ny nz">#Indicate brands you wish to collect<br/>coffee_brands = ["Coffee Bean and Tea Leaf", "Starbucks", "Tim Hortons", "Coffee Project"]</span></pre><p id="a6d0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">定义功能</strong></p><p id="5da7" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">让我们定义我们稍后将调用的函数。回想一下，我们有一个分析设计要遵循，我们将编写与过程的每一步相对应的函数。</p><p id="02e6" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">这一步相当长，所以我们不把它们放在这里。相反，请访问我的<a class="ae lh" href="https://github.com/francisadrianviernes/Mapping-Your-Favorite-Coffee-Shop-in-the-Philippines-using-Google-Places-API-and-Folium" rel="noopener ugc nofollow" target="_blank"> Github页面</a>获取完整代码。</p><p id="f7d0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">我的页面将包含地理编码的菲律宾城市供所有人使用。</p><p id="2738" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">清理数据集</strong></p><p id="d3fa" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">运行代码收集数据后，现在是清理数据的时候了。</p><p id="b0da" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">我们从API请求中获得的数据可能不完全干净。当你使用的关键词与其他品牌的关键词匹配时，这种情况尤其会发生。以咖啡豆和茶叶为例，那里的咖啡也可能与其他咖啡店的相匹配。</p><p id="b801" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">截至2020年10月，我们最喜爱的咖啡店的最终统计结果如下:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/2108a656bed3669c61127998970fd9b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*K4IWZBf173jPFT4gZbpcPg.png"/></div></figure><p id="c115" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">通过树叶进行地理可视化</strong></p><p id="f425" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">首先，要使用our，我们必须将数据框转换为地理数据框:</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="4e6a" class="nv lj it nr b gy nw nx l ny nz">geometry = [Point(xy) for xy in zip(df['lng'], df['lat'])]</span><span id="4cd4" class="nv lj it nr b gy oa nx l ny nz">#Let us create GeoDataFrame with df data and list of Point Geometries<br/>gdf = gpd.GeoDataFrame(df, geometry=geometry)</span></pre><p id="9cd2" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">接下来，我们实例化叶子地图:</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="4665" class="nv lj it nr b gy nw nx l ny nz">#The folium.Map instantiates a folium map object with given parameters<br/>coffee_map = folium.Map(location = [14.5540,120.9752],<br/>                       zoom_start=5, #from experience, this zoom level captures the whole PH<br/>                       tiles='CartoDB dark_matter',<br/>                       control_scale=True,<br/>                       prefer_canvas=True)<br/>#Add Fullscreen Control<br/>Fullscreen(<br/>            title="Full Screen",<br/>            title_cancel = "Exit fullscreen",<br/>            force_separate_button=True).add_to(coffee_map)</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oc"><img src="../Images/1d4d767b49c3eca5232f1cc30b388eda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3jCYN3qk2qwkrsUCQxzMyg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">这就是我们的树叶地图的样子</p></figure><p id="094a" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在我们继续之前，我们需要为每个咖啡品牌分配不同的颜色，以便它在地图上看起来更好:</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="6721" class="nv lj it nr b gy nw nx l ny nz">#Let's Create a Color Dictionary for the Markers<br/>color_dict = {<br/>    "Starbucks": ' #00704A',<br/>    "Coffee Bean and Tea Leaf": '#362d26',<br/>    "Coffee Project": '#654321',<br/>    "Tim Hortons": '#dd0f2d'<br/>}</span></pre><p id="b972" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">之后，让我们添加标记和聚类工具。</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="034d" class="nv lj it nr b gy nw nx l ny nz">#Since we need to add a filter for this, we need to add them by brand:</span><span id="72e6" class="nv lj it nr b gy oa nx l ny nz">for brand in coffee_brands:<br/>    df_i = gdf[gdf['brand']==brand]<br/>    df_i.loc[:, "color"] = color_dict[brand]<br/>    <br/>    #Let's add a marker feature - clustering<br/>    marker_cluster = MarkerCluster(control=False) #False so it will not appear as a layer<br/>    marker_cluster.add_to(coffee_map)<br/>    sub_group = FeatureGroupSubGroup(marker_cluster, name=brand, control=True, show=True)<br/>    <br/>    #Popup Contents<br/>    for index, row in df_i.iterrows():<br/>        <br/>        html = """<br/>        <br/>        &lt;h3&gt;{title}&lt;/h3&gt;&lt;br&gt;<br/>        &lt;b&gt; {brand}&lt;/b&gt;&lt;br&gt;<br/>          {vicinity}&lt;br&gt;<br/>        <br/>        """<br/>        <br/>        popup_contents = folium.Html(html.format(title = df_i.loc[index, 'name'],<br/>                                                     brand = row.brand,<br/>                                                     vicinity = row.vicinity),<br/>                                         script = True)<br/>    <br/>    <br/>        popup = folium.Popup(popup_contents, max_width=2650)<br/>    <br/>        folium.vector_layers.CircleMarker(radius = 8,<br/>                                                  location = (row.geometry.y,<br/>                                                              row.geometry.x),<br/>                                                  popup = popup,<br/>                                                  color = row.color,<br/>                                                  fill = True,<br/>                                                  fill_color = row.color,<br/>                                                  name = brand,<br/>                                                  control = True,<br/>                                                  overlay = True<br/>                                                 ).add_to(sub_group)<br/>        sub_group.add_to(coffee_map)</span></pre><p id="176d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">当我们完成后，我们的地图将看起来像这样:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi od"><img src="../Images/b98dc8d36badeaa201ce21d08e12328e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ZRfIg604XRjWT9bjjBpqrg.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">活动中的叶子标记</p></figure><p id="cb34" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">见解</strong></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oe"><img src="../Images/33d1b22c1de3e1ab130a71194c5e26b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5awinff1jdZ7bd8N8zCmQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">菲律宾的咖啡店集群(星巴克、咖啡豆、茶叶、蒂姆·霍顿和咖啡项目)</p></figure><p id="fc21" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">从上面这张地图，我们可以清楚地看到，我们最喜欢的咖啡品牌大多都相当集中在菲律宾的老牌商业区。</p><p id="0453" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">不过有一点需要注意的是，在菲律宾的其他地方可能没有那么受欢迎的咖啡连锁店，只有我们喜欢的咖啡连锁店才会出现在主要的商业区——大马尼拉、宿务、莱加斯皮、那加和达沃市。</p><p id="a3a0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">人们可以假设一个集群中的咖啡店越多，商业区就越发达，因此我们可以使用这些信息来跟踪哪些正在快速发展。</p><p id="e7c0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">让我知道你们的想法！</p><p id="d33d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">完整代码可从<a class="ae lh" href="https://github.com/francisadrianviernes/Mapping-Your-Favorite-Coffee-Shop-in-the-Philippines-using-Google-Places-API-and-Folium" rel="noopener ugc nofollow" target="_blank"> GitHub </a>获得。</p></div></div>    
</body>
</html>