<html>
<head>
<title>Just Released: BigQuery User-friendly SQL Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">刚刚发布:BigQuery用户友好的SQL函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/just-released-bigquery-user-friendly-sql-functions-979fca9cd007?source=collection_archive---------14-----------------------#2020-10-28">https://towardsdatascience.com/just-released-bigquery-user-friendly-sql-functions-979fca9cd007?source=collection_archive---------14-----------------------#2020-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6326" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从BigQuery截断表到动态SQL支持；我们涵盖了Google Cloud发布的12个用户友好的BigQuery函数。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eb9ad3974709f6339f2e1a229c5ccf6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qE5c6c0f3ZeZ9V3QfJIxhw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">授权给作者的图像</p></figure><p id="b54e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">随着<strong class="la iu"> 12个新的BigQuery SQL特性</strong>的发布，我们很兴奋地看到<a class="ae lu" href="https://www.ancoris.com/google-bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>的能力得到了进一步的提升。谷歌云将这些描述为“<em class="lv">用户友好的SQL功能</em>”。那么，让我们来看看现在有什么可能。</p><h1 id="d77a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">1.通过DDL添加表列</h1><p id="6132" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">BigQuery的新特性是能够通过ALTER TABLE DDL语句添加新列。这是具有传统本地数据库平台背景的数据专业人员所期望的标准，所以很高兴看到Google Cloud已经承认了这一点。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="26b2" class="my lx it mu b gy mz na l nb nc">alter table mydataset.mytable<br/>add column a string,<br/>add column if not exists b geography,<br/>add column c array&lt;numeric&gt;,<br/>add column d date options(description="my description")</span></pre><p id="2bc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们喜欢这样的语法:如果一个列还不存在，就只添加一个，这对于幂等部署来说很方便。也完全支持记录。从 <a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#alter_table_add_column_statement" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> BigQuery文档中了解更多信息。</em>T11】</a></p><h1 id="0450" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">2.截断表格</h1><p id="1fd2" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">现在支持TRUNCATE TABLE，这将满足那些来自本地后台的用户。与BigQuery中会产生扫描成本的DELETE DML语句不同，TRUNCATE属于不断增长的<a class="ae lu" href="https://cloud.google.com/bigquery/pricing#free" rel="noopener ugc nofollow" target="_blank"> BigQuery自由操作</a>列表。我们肯定会经常用到这个。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="e180" class="my lx it mu b gy mz na l nb nc">truncate table [project_name.] dataset_name.] table_name</span></pre><p id="1897" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">为了降低查询扫描成本，我们建议在需要删除表的全部内容时使用TRUNCATE而不是delete。</em></p><h1 id="285a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">3.Unicode表命名</h1><p id="a93d" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">BigQuery现在支持Unicode表命名。由于支持多语言，表名不再仅限于字母、数字和下划线。</p><p id="fc5f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">小心表格命名，确保表格一致、易读，并遵循组织内的命名惯例。</em></p><h1 id="9bb9" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">4.BigQuery联邦表变得(甚至)更好了</h1><p id="e2c0" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">在Ancoris，我们喜欢BigQuery中的联邦(外部)表；它们作为一种强大的零数据工程方法，可以轻松地从Google云存储中摄取文件，包括常见的格式，如JSON和CSV。</p><p id="2b73" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">很高兴看到您现在可以使用DDL语句创建外部表了。</em></p><p id="e698" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面的示例创建了一个从两个不同的存储URIs读取CSV的表:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="2956" class="my lx it mu b gy mz na l nb nc">create external table dataset.CsvTable options(<br/>format = 'CSV',<br/>uris = ['gs://bucket/path1.csv', 'gs://bucket/path2.csv']);</span></pre><p id="6f61" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要了解更多信息，请参见这些创建联邦表的例子。我们计划在接下来的几周内做一个技术指导来展示什么是可能的。</p><h1 id="df16" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">5.使用SQL将数据从BigQuery导出到Google云存储</h1><p id="6617" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">这在发行说明中被掩盖了一点，但是在我们看来这是一个非常强大的特性。您现在可以使用新的EXPORT DATA SQL命令将BigQuery查询的结果导出到Google云存储中；支持所有<a class="ae lu" href="https://cloud.google.com/bigquery/docs/exporting-data" rel="noopener ugc nofollow" target="_blank"> Bigquery支持的数据格式和压缩类型</a>。</p><p id="840e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里有一个取自<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/other-statements#export_data_statement" rel="noopener ugc nofollow" target="_blank"> BigQuery导出数据文档</a>的例子。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="e214" class="my lx it mu b gy mz na l nb nc">export data options(<br/>uri='gs://bucket/folder/*.csv',<br/>format='CSV',<br/>overwrite=true,<br/>header=true,<br/>field_delimiter=';') as<br/>select field1, field2<br/>from table1<br/>order by field1 limit 10</span></pre><p id="ea43" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">很高兴看到没有外出费用；您只需为任何扫描的BigQuery数据和存储在GCS中的数据付费。</em></p><p id="5c72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这似乎加强了谷歌云减少复杂数据工程需求的愿望，这是我们(和我们的许多客户)所共有的。如果将它与从目标GCS bucket触发的云函数结合起来，就可以提供一种简单的机制，将数据传递到BigQuery之外的数据管道中。</p><h1 id="5705" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">6.立即执行(动态SQL)</h1><p id="c4c0" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">BigQuery现在支持动态SQL的执行。语法非常熟悉，特别是对于那些有MS SQL背景的人来说。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="9bf9" class="my lx it mu b gy mz na l nb nc">-- create a temporary table called Books.<br/>execute immediate<br/>‘create temp table books (title string, publish_date int64)’;</span><span id="a26b" class="my lx it mu b gy nd na l nb nc">-- add a row for Hamlet <br/>execute immediate<br/>‘insert into books (title, publish_date) values('Hamlet', 1599)’;</span></pre><p id="9a03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">更多例子见<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting#execute_immediate" rel="noopener ugc nofollow" target="_blank"> BigQuery动态SQL支持</a>。</p><p id="b41e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">一般来说，我们非常谨慎地使用动态SQL，并尽可能避免使用它(主要是因为SQL注入的风险，它会使代码更难阅读和调试)。</em></p><h1 id="b881" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">7.授权的用户定义函数(UDF)</h1><p id="435b" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">对于那些不熟悉<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions#temporary-udf-syntax" rel="noopener ugc nofollow" target="_blank">BigQuery UDF</a>的人来说，这些是big query中的标量函数，允许您使用SQL或Javascript(以及相关的Javascript库)对数据进行操作。</p><p id="e211" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">BigQuery现在支持授权的UDF，这允许授权的使用者(通过IAM)查询数据集中的表，即使调用UDF的用户无权访问这些表。你们中有MS SQL背景的人，这类似于SQL Server中的表值函数的许可；这些通常用作(锁定的)表的安全层，并加强行/列级别的安全性。</p><h1 id="2ef5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">8.查询结果中有重复的列名</h1><p id="00f6" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">BigQuery现在允许您在一个查询中多次选择同一个(未分类的)列，方法是附加一个后缀_n，其中n是观察到的重复次数。</p><h1 id="147a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">9.新的BigQuery最后一天日期函数</h1><p id="be05" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">BigQuery已经很好地支持了使用SQL的日期操作。看起来在这个版本中，谷歌云已经认识到了一个常见的商业主导用例；查找给定期间的最后一天，例如一个月的最后一天或一周的最后一天。</p><p id="415c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">新的LAST_DAY函数具有直观的语法，易于阅读:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6561" class="my lx it mu b gy mz na l nb nc">select last_day(’2020-10-23’, week) as last_day_of_week<br/>2020-10-24</span></pre><p id="bd69" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">注意默认情况下，这将返回下一个星期六，因为在BigQuery中一周从星期日开始。</em></p><p id="d168" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要强制一周从星期一开始:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="eabc" class="my lx it mu b gy mz na l nb nc">-- the last day of the week<br/>-- (week starting monday)</span><span id="8dcc" class="my lx it mu b gy nd na l nb nc">select last_day(’2020-10-23’,<br/>       week(monday)) as last_day_of_week<br/>2020-10-25</span></pre><h1 id="542a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">10.BigQuery中的日期算法</h1><p id="d37e" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">我们习惯于使用data_add和date_sub函数进行日期运算，但是现在您可以使用+和-操作符来完成这项工作。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6a04" class="my lx it mu b gy mz na l nb nc">-- you can now do this<br/>select ’2020-10-23’ + 2<br/>2020-10-25</span><span id="ed69" class="my lx it mu b gy nd na l nb nc">-- instead of this<br/>select date_add(’2020-10-23’, interval 2 day) <br/>2020-10-25</span></pre><h1 id="7441" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">11.新的BigQuery字符串函数</h1><p id="901f" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">许多(总共14个)新的用于操作字符串的<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions" rel="noopener ugc nofollow" target="_blank"> BigQuery SQL函数</a>。以下是我们特别喜欢的几个:</p><h1 id="dd19" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">大查询串联运算符“||”</h1><p id="cc58" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">作为一个团队，我们认为这种连接字符串的方法比concat函数更容易阅读。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="bdea" class="my lx it mu b gy mz na l nb nc">-- the new way<br/>select ’The ’||‘quick ’||‘brown ’||‘fox’ as quip</span><span id="ef91" class="my lx it mu b gy nd na l nb nc">-- the old way<br/>select concat(’The ’,‘quick ’,‘brown ’,‘fox’) as quip</span></pre><h1 id="2e04" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">BigQuery指令</h1><p id="dec3" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">这将返回字符串中搜索值的索引。注意，字符串中的第一个字符索引为1，如果没有找到该字符串，则返回0。</p><p id="c6e1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第三个参数是<strong class="la iu">位置</strong>，表示从哪里开始搜索。默认值为1。如果提供了负数，这表示从字符串末尾开始-n个字符。</p><p id="3835" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后一个参数是<strong class="la iu">的出现次数</strong>，如果提供了该参数，则指定要搜索的字符串的出现次数，例如2表示查找搜索值的第二个出现次数的索引。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="3d61" class="my lx it mu b gy mz na l nb nc">select instr(’banana’,‘an’)<br/>2<br/>select instr(’banana’,‘an’,3)<br/>4<br/>select instr(’banana’,‘an’,1, 2)<br/>4<br/>select instr(’banana’,‘an’,1, 3)<br/>0</span></pre><h1 id="b340" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">BigQuery Soundex</h1><p id="134b" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">这在我们的列表中，因为我们都认为它非常简洁。这个函数返回一个单词的拼音，表示为soundex代码(alpha后跟3个数字)。该算法于1918年首次获得专利，可用于模糊逻辑匹配，例如检测人名的拼写错误:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="2ea8" class="my lx it mu b gy mz na l nb nc">select soundex(’Brian’)<br/>B650<br/>select soundex(’Bryan’)<br/>B650<br/>select soundex(’Briann’)<br/>B650<br/>select soundex(’Brrian’)<br/>B650<br/>select soundex(’Brenda’)<br/><strong class="mu iu">B653</strong></span></pre><h1 id="eca2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">12.扩展信息模式</h1><p id="91db" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">ANSI SQL标准中指定的INFORMATION_SCHEMA允许用户查询包含或引用数据的各种对象或实体的元数据，如表、视图、存储过程和用户定义的函数。下面是<a class="ae lu" href="https://cloud.google.com/bigquery/docs/information-schema-intro" rel="noopener ugc nofollow" target="_blank"> BigQuery INFORMATION_SCHEMA文档</a>。</p><p id="4d5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">BigQuery引入了许多新的对象，包括表、视图、例程(存储过程、UDF)和数据集，使得这一点变得更加容易。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6dbf" class="my lx it mu b gy mz na l nb nc">select table_name<br/>from mydataset.INFORMATION_SCHEMA.TABLES<br/>where table_name like 'scenario%'</span></pre><p id="3543" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lv">注意表格是大写的(BigQuery区分大小写)。</em></p><h1 id="4fb4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">意见</h1><p id="c658" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">总之，这是对BigQuery SQL库的一个很好的补充，我们肯定会在客户端项目中使用它。我们将在即将发布的数据操作系列中讨论其中的一些主题。</p><h1 id="ae23" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">后续步骤</h1><p id="1b84" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">1.阅读<a class="ae lu" href="https://cloud.google.com/blog/topics/developers-practitioners/smile-new-user-friendly-sql-capabilities-bigquery" rel="noopener ugc nofollow" target="_blank">谷歌云Bigquery发布说明</a></p><p id="2c5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.了解更多关于<a class="ae lu" href="https://www.ancoris.com/solutions/data_analytics_ai" rel="noopener ugc nofollow" target="_blank"> Ancoris数据，分析&amp; AI </a></p><p id="d652" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.与<a class="ae lu" href="https://www.linkedin.com/in/google-cloud-platform/" rel="noopener ugc nofollow" target="_blank">作者</a>连线</p></div></div>    
</body>
</html>