<html>
<head>
<title>Data Preparation Guide for Histopathologic Cancer Detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">组织病理学癌症检测的数据准备指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-preparation-guide-for-detecting-histopathologic-cancer-detection-7b96d6a12004?source=collection_archive---------58-----------------------#2020-10-26">https://towardsdatascience.com/data-preparation-guide-for-detecting-histopathologic-cancer-detection-7b96d6a12004?source=collection_archive---------58-----------------------#2020-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c9d8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何为Kaggle组织病理学癌症检测的模型训练准备数据的指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/62cadc1915339aaad4dbf67a080441df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ujOEngL32w4mX-a1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@nci?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">国家癌症研究所</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0694" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kaggle是数据科学和机器学习挑战的绝佳主持人。其中之一是<a class="ae kv" href="https://www.kaggle.com/c/histopathologic-cancer-detection" rel="noopener ugc nofollow" target="_blank">组织病理学癌症检测挑战赛</a>。在这个挑战中，我们提供了一个图像数据集，我们应该在这个数据集上创建一个算法(它说的是算法，而不是明确的机器学习模型，所以如果你是一个天才，有一个替代的方法来检测图像中的转移性癌症；去吧！)来检测转移癌。</p><p id="cd1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章是关于如何准备Kaggle数据集的指南，该指南涵盖了以下四个方面:</p><ul class=""><li id="e86d" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">如何从Kaggle将数据集下载到您的笔记本中</li><li id="ff16" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如何扩充数据集的图像。</li><li id="a227" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如何平衡目标分布，并为训练/测试/验证拆分数据。</li><li id="1932" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如何在Keras中为模型训练构建数据？</li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="23e0" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">在笔记本中下载数据集</h1><p id="464f" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">使用下面的命令下载kaggle包。我在谷歌的Colab上运行它们，但是你应该可以用你的命令行/Jupyter笔记本来运行它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="16ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了使用Kaggle的API用你的账号下载数据，你需要做以下两件事。</p><ul class=""><li id="bdd9" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">转到您的帐户设置，滚动到API部分，单击<strong class="ky ir">过期API令牌</strong>删除以前的令牌(如果您有任何令牌)，然后单击<strong class="ky ir">创建新的API令牌</strong>。这将下载一个<strong class="ky ir"> 'kaggle.json' </strong>文件。</li><li id="f77d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将此文件上传到您的项目目录。</li></ul><p id="7f2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后运行下面的代码，该代码使用json文件授予访问权限，并下载数据集。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="311f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">解压缩zip文件。<strong class="ky ir">这需要几分钟的时间，因为它包含大约6–7 GB的数据。</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="1109" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">此时，你应该有两个文件夹，和两个csv文件。</strong></p><ul class=""><li id="89e5" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">包含训练集图像的“train”文件夹</li><li id="4b5d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">包含测试集图像的“测试”文件夹</li><li id="d8b1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">一个“train _ labels”CSV文件，包含每个图像的id及其相应的标签(0表示无癌症，1表示有癌症)。</li><li id="11ab" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">一个“sample _ submission”CSV文件，它是一个示例，说明如果您想参加Kaggle竞赛，您应该如何提交您的结果。</li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="c392" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">数据扩充</h1><p id="020c" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">什么是数据增强，我们为什么要这样做？从本质上来说，数据扩充是一种通过对数据进行细微更改来增加图像数据集大小的方法。我们的目标是将我们的模型推广到更多通过图像增强引入的例子。<strong class="ky ir">更重要的是</strong>，图像增强还允许我们的模型<strong class="ky ir">概括不同类型图像的不同版本。</strong></p><p id="3b8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看下图。假设左边被画得可怕的猫来自训练数据集，但是右边的猫在测试数据集中。从字面上看，它们是相同的图像，只是右边的图像被翻转了。人类能够很容易地注意到这一点，但是模型可能无法成功完成这项任务，并且无法在测试数据集中识别它。理想情况下，您希望您的模型不关心图像的变化，并正确地对图像进行分类，这就是为什么您引入图像的增强版本，以便模型可以更好地概括。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/12f237317ce9be96719cbb6e18293879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vlGd0s1qeviNhHquMnE3nQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">增强图片的示例</p></figure><p id="6e97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个函数的代码，它通过对图像应用各种变换来放大图像，例如改变图像的对比度、增加图像的亮度、应用随机旋转/移动。这里的代码引用自<a class="ae kv" href="https://www.kaggle.com/qitvision/a-complete-ml-pipeline-fast-ai" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="faf7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们使用此功能来扩充“train”文件夹中提取的图像。下面的代码生成X数量的新图像(基于一个名为<em class="nn"> 'images_to_generate' </em>的变量，您可以更改该变量)，方法是从我们的train集中随机选择图像，应用上面的增强功能，然后将图像保存在train文件夹中，并使用“增强的”+其以前的ID作为新名称。最后，我们还将标签和名称附加到train_labels csv文件，并保存一个新的csv文件，该文件也包含增强图像的ID和标签。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="c066" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">平衡目标分布</h1><p id="bc19" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">在机器学习中，我们希望确保我们的模型能够很好地处理我们扔给它的所有类型的数据！如果我们盲目地使用所有可用的训练数据，可能出现的一个问题是<strong class="ky ir">不平衡的类别/目标分布的情况。这意味着你的数据集包含一个或多个类比其他类更多的观察值。如果我们在这个完整的数据集上训练我们的模型，我们的模型将在预测具有更多数据点的类方面变得非常好，而在分类其他类方面表现不佳。让我们看看在我们的癌症检测模型的情况下会发生什么！</strong></p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="3c0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们观察我们的训练数据集，我们会意识到它是不平衡的。运行下面的代码显示，我们有大约130000张没有癌症的图像，以及大约90000张有癌症的图像。如前所述，使用不平衡数据集进行训练可能会导致我们的模型在识别一个类时变得非常出色，而在其他类上却失败得很惨。在这种情况下，少数类是检测到癌细胞的一类，我们真的不想在对癌症图像进行分类时失败；因为这样做会导致人们带着未确诊的癌症继续生活，而他们应该接受治疗！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="ab90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="0cf4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了解决这个问题，我们可以从无癌症(0)类中删除图像，如下所示。为了更快的训练，我丢弃了多余的图像，但是我们可以简单地保持95000:93099的比例。下面的代码删除图像并保持类的分布相等。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="6021" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有一步，我们需要将我们的数据分成训练、测试和验证集。训练集用于训练我们的模型，验证集用于调整模型的超参数，测试集用于检查模型的性能。下面的代码片段按照60:20:20的比例对训练:测试:验证进行了划分。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="b217" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的例子中，我们有一个丰富的数据集，我们可以从中删除数据点来平衡类分布；然而，如果我们没有丢弃数据的奢侈呢？如果我们需要尽可能多的数据呢？</p><p id="dd89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有几种方法可以做到这一点:</p><ul class=""><li id="e671" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">您可以对minority类进行过采样。在我们的例子中，这将简单地从我们的训练集中随机抽取带有检测到的癌细胞的图像样本，并将这些样本附加到我们的训练集中。您可能对此有点怀疑，但这种技术至少确保了您的模型不会严重依赖多数类进行训练，并且还学会了对少数类进行分类。</li><li id="9bea" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">对于非基于图像的数据集，您可以创建假数据。这可以通过使用像<a class="ae kv" href="https://scikit-learn.org/stable/modules/density.html" rel="noopener ugc nofollow" target="_blank">核密度估计</a>这样的技术来完成，在这种技术中，您可以了解数据集中要素的分布，并从这些分布中抽取样本来生成新数据。</li></ul><p id="db77" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是两种方法，你可以在这里找到更多的<a class="ae kv" rel="noopener" target="_blank" href="/methods-for-dealing-with-imbalanced-data-5b761be45a18">。</a></p><h1 id="36de" class="mn mo iq bd mp mq no ms mt mu np mw mx jw nq jx mz jz nr ka nb kc ns kd nd ne bi translated">Keras生成器的目录结构</h1><p id="6b4a" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">机器学习模型使用存储在计算机/服务器内存中的数据。有时，数据集小到足以容纳在内存中；但在大多数实际情况下，并非如此。为了克服这一点，我们可以使用生成器(<a class="ae kv" rel="noopener" target="_blank" href="/keras-data-generators-and-how-to-use-them-b69129ed779c">它们也执行图像增强</a>，但我手动执行了上面的操作)来拍摄我们的图像，并将它们成批地传递给机器学习模型，而不是一次全部传递。为此，我们需要将图像存储在特定的目录结构中。本例中的目录应采用以下格式。</p><p id="2bba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您在项目基本目录中，它应该是:</p><p id="9f6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">—培训数据文件夹</p><p id="fc4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_0文件夹</p><p id="0534" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_1文件夹</p><p id="ddc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">—测试数据文件夹</p><p id="2fb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_0文件夹</p><p id="e2cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_1文件夹</p><p id="aa3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">—验证数据文件夹</p><p id="b8bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_0文件夹</p><p id="98ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">— — — class_1文件夹</p><p id="0a90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">“培训数据”文件夹有两个子文件夹，其中包含每个类别的图像。测试和验证数据文件夹的结构相似。下面的代码创建了这些目录。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="47f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦我们创建了目录，我们就可以将相应的映像转移到这些目录中。下面的代码可以做到这一点。<strong class="ky ir">在colab上这样做大约需要30分钟，因为我们必须传输160000张图像</strong>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="0cfe" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">结尾注释</h1><p id="4df2" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">太好了！此时，您应该已经设置好数据集，可以输入到您的模型中。完整的A-Z库可以在<a class="ae kv" href="https://github.com/DarthQadir/Histopathlogic-Cancer-Data-Preprocessing" rel="noopener ugc nofollow" target="_blank">这里</a>找到！</p><p id="becb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望您发现这篇文章和笔记有助于理解挑战的预处理数据，以及一般的预处理。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="3dc0" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">参考</h1><ul class=""><li id="5e64" class="ls lt iq ky b kz nf lc ng lf nt lj nu ln nv lr lx ly lz ma bi translated"><a class="ae kv" href="https://www.kaggle.com/c/histopathologic-cancer-detection" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/c/histopathologic-cancer-detection</a></li><li id="6fe8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://www.kaggle.com/qitvision/a-complete-ml-pipeline-fast-ai" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/qit vision/a-complete-ml-pipeline-fast-ai</a></li><li id="325e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/keras-data-generators-and-how-to-use-them-b69129ed779c">https://towards data science . com/keras-data-generators-and-how-to-use-them-b 69129 ed 779 c</a></li><li id="602c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://github.com/DarthQadir/Cancer-Data-Preprocessing-Medium-Article/blob/master/Cancer_Detection_Preprocessing.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/DarthQadir/Cancer-Data-Preprocessing-Medium-Article/blob/master/Cancer _ Detection _ Preprocessing . ipynb</a></li><li id="1c83" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://scikit-learn.org/stable/modules/density.html" rel="noopener ugc nofollow" target="_blank">https://scikit-learn.org/stable/modules/density.html</a></li><li id="da1d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/methods-for-dealing-with-imbalanced-data-5b761be45a18">https://towards data science . com/methods-for-handling-unbalanced-data-5b 761 be 45 a 18</a></li></ul></div></div>    
</body>
</html>