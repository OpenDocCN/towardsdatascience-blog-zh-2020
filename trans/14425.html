<html>
<head>
<title>10 Configs to Make Your Kafka Producer More Resilient</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10种配置让您的Kafka Producer更具弹性</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/10-configs-to-make-your-kafka-producer-more-resilient-ec6903c63e3f?source=collection_archive---------4-----------------------#2020-10-05">https://towardsdatascience.com/10-configs-to-make-your-kafka-producer-more-resilient-ec6903c63e3f?source=collection_archive---------4-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6ab1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让你的卡夫卡制作人更上一层楼</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d319a59a95df7ac827b5ce2d89c7cadc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hm1kxPv6oxbDcVrE"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@jamesponddotco" rel="noopener ugc nofollow" target="_blank">詹姆斯·庞德</a>在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="8be1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated">afka以其弹性、容错和高吞吐量而闻名。但是它的表现并不总是符合所有人的预期。在某些情况下，我们可以通过横向扩展或纵向扩展代理来改进它。而在大多数情况下，我们不得不<em class="me">玩配置的游戏</em>。</p><p id="8ff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">卡夫卡生态系统里真的有<a class="ae ky" href="https://kafka.apache.org/documentation/#configuration" rel="noopener ugc nofollow" target="_blank">吨的配置</a>。几乎不可能掌握每一种配置的想法。一方面，它们无疑使系统更加灵活，但另一方面，开发人员可能会对如何使用它们感到非常困惑。</p><p id="5b6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，大多数配置都是预先定义好的，在大多数情况下都能很好地工作。首先，他们需要了解的强制性配置非常有限。</p><p id="26e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是当然，我假设你正在读这篇文章，因为你想把你的卡夫卡制作人带到一个新的水平。因此，在这篇文章中，我想分享10个配置，我认为它们对提高生产商的适应能力非常重要。</p><p id="a968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将要讨论的配置有<code class="fe mf mg mh mi b">acks</code>、<code class="fe mf mg mh mi b">replica.lag.time.max.ms</code>、<code class="fe mf mg mh mi b">min.insync.replicas</code>、<code class="fe mf mg mh mi b">retries</code>、<code class="fe mf mg mh mi b">enable.idempotent</code>、<code class="fe mf mg mh mi b">max.in.flight.requests.per.connection</code>、<code class="fe mf mg mh mi b">buffer.memory</code>、<code class="fe mf mg mh mi b">max.block.ms</code>、<code class="fe mf mg mh mi b">linger.ms</code>、<code class="fe mf mg mh mi b">batch.size</code>。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="b3ac" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">ack(确认)</h2><p id="8af1" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">ack是生产者从Kafka代理那里得到的确认，以确保消息已经成功提交给该代理。config <code class="fe mf mg mh mi b">acks</code>是生产者在考虑成功提交之前需要接收的确认数量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/ccd477f7d9a3e7f9417be614a43e631e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B7QWstG-YFszq_EM6hg7vw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ack=1和ack=all的区别，高创造</p></figure><p id="1c89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认值为1，这意味着只要生产者收到来自该主题的主代理的ack，它就会将其视为成功的提交，并继续处理下一条消息。不建议设置<code class="fe mf mg mh mi b">acks=0</code>，因为那样你在提交上没有任何保证。<code class="fe mf mg mh mi b">acks=all</code>将确保生产者从该主题的所有<em class="me">同步</em>副本中获得确认。它提供了最强的消息持久性，但也需要很长时间，从而导致更高的延迟。所以，你需要决定什么对你更重要。</p><h2 id="2a73" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">同步副本</h2><p id="4533" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated"><code class="fe mf mg mh mi b">acks=all</code>会从所有的<em class="me">同步</em>副本(ISR)那里得到确认，那么什么是同步副本呢？创建主题时，必须定义想要多少个副本。副本只不过是其中一个代理中消息的副本，因此副本的最大数量就是代理的数量。</p><p id="cfcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这些复制品中，有一个领导者，其余的都是追随者。领导者处理所有的读写请求，而从者被动地复制领导者。<strong class="lb iu">同步副本是在最后10秒完全赶上领先的副本。</strong>时间段可以通过<code class="fe mf mg mh mi b">replica.lag.time.max.ms</code>进行配置。如果某个代理出现故障或出现网络问题，那么他就无法与负责人联系，10秒钟后，该代理就会从ISR中删除。</p><p id="eb81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认最小同步副本(<code class="fe mf mg mh mi b">min.insync.replicas</code>)为1。这意味着，如果所有的追随者都倒下了，那么ISR就只剩下领导者了。即使<code class="fe mf mg mh mi b">acks</code>设置为all，它实际上只将消息提交给1个代理(领导者),这使得消息容易受到攻击。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/bce8a4ddd7e977741e8742c2575bb2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIGtEDGFKkqPhCiCTDlWdw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="np nq ep" href="https://medium.com/u/2adc5a07e772?source=post_page-----ec6903c63e3f--------------------------------" rel="noopener" target="_blank">高</a>创建的不同最小同步副本之间的差异</p></figure><p id="84fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置<code class="fe mf mg mh mi b">min.insync.replicas</code>基本上定义了生产者在考虑成功提交之前必须接收多少副本。这个配置添加在<code class="fe mf mg mh mi b">acks=all</code>之上，使你的消息更加安全。但另一方面，你必须平衡延迟和速度。</p><h2 id="cbf6" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">失败时重试</h2><p id="caa3" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">假设你设置了<code class="fe mf mg mh mi b">acks=all</code>和<code class="fe mf mg mh mi b">min.insync.replicas=2</code>。出于某种原因，跟随者完成了，然后生产者识别出一个失败的提交，因为它不能从<code class="fe mf mg mh mi b">min.insync.replicas</code>代理那里得到确认。</p><p id="eff5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将收到来自生成器的错误消息:</p><pre class="kj kk kl km gt ns mi nt nu aw nv bi"><span id="80b4" class="mq mr it mi b gy nw nx l ny nz">KafkaError{code=NOT_ENOUGH_REPLICAS,val=19,str="Broker: Not enough in-sync replicas"}</span></pre><p id="fe5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到来自正在运行的代理的以下错误消息。这意味着，即使代理正在运行，如果当前的ISR不足，Kafka也不会将消息附加到正在运行的代理。</p><pre class="kj kk kl km gt ns mi nt nu aw nv bi"><span id="ec8b" class="mq mr it mi b gy nw nx l ny nz">ERROR [ReplicaManager broker=0] Error processing append operation on partition test-2-2-0 (kafka.server.ReplicaManager)<br/>org.apache.kafka.common.errors.NotEnoughReplicasException: The size of the current ISR Set(0) is insufficient to satisfy the min.isr requirement of 2 for partition test-2-2-0</span></pre><p id="42c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，生成器不会处理这个错误，因此会丢失消息。这被称为<strong class="lb iu">最多一次语义</strong>。但是您可以通过配置<code class="fe mf mg mh mi b">retries=n</code>让生产者重新发送消息。这基本上是提交失败时生成器可以重试的最大次数。默认值为0。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/e2924518fd0a2e50a05946b8aa4f72bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y43uw_bUSW28gb7P_62pag.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="np nq ep" href="https://medium.com/u/2adc5a07e772?source=post_page-----ec6903c63e3f--------------------------------" rel="noopener" target="_blank">高</a>创建的重试次数=0和重试次数&gt; 0之差</p></figure><p id="5278" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您设置了<code class="fe mf mg mh mi b">retries=5</code>，那么生产者将最多重试5次。您不会注意到生成器日志中的重试次数，因为它只显示提交最终是否成功。但是你可以在代理端看到<code class="fe mf mg mh mi b">retries+1</code>日志消息。</p><h2 id="2576" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">避免重复的消息</h2><p id="08f4" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在某些情况下，消息实际上已提交给所有同步副本，但由于网络问题(例如，只允许单向通信)，代理无法发回ack。同时，我们设置<code class="fe mf mg mh mi b">retries=3</code>，然后生产者将重新发送消息3次。这可能会导致主题中出现重复的消息。</p><p id="f575" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们有一个向主题发送100万条消息的生产者，在消息提交后但生产者收到所有ack之前，代理失败。在这种情况下，我们可能会收到超过100万条关于这个话题的消息。这也被称为<strong class="lb iu">一次性租赁语义</strong>。</p><p id="3e20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最理想的情况是<strong class="lb iu">恰好一次语义</strong>，在这种情况下，即使生产者重新发送消息，消费者也应该只收到一次相同的消息。</p><p id="76d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要的是一个<strong class="lb iu">幂等生产者。</strong> <a class="ae ky" href="https://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation#:~:text=Idempotence%20means%20that%20applying%20an,the%20result%20is%20still%20zero." rel="noopener ugc nofollow" target="_blank">幂等</a>是指一个操作应用一次或者应用多次效果相同。用配置<code class="fe mf mg mh mi b">enable.idempotent=true</code>很容易打开这个特性。</p><p id="31e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它是如何工作的？消息是分批发送的，每批都有一个序列号。在代理端，它跟踪每个分区的最大序列号。如果一个具有较小或相等序列号的批次进入，代理不会将该批次写入主题。这样，也保证了批次的顺序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/4fcea6ad7c128913c69e8f54e1eb8b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j-xsLeFONBgvcdt1ohcSpQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="np nq ep" href="https://medium.com/u/2adc5a07e772?source=post_page-----ec6903c63e3f--------------------------------" rel="noopener" target="_blank">高</a>创造的禁用幂等元和启用幂等元的区别</p></figure><h2 id="25f6" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">按顺序发送消息</h2><p id="3675" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">保证顺序的另一个重要配置是<code class="fe mf mg mh mi b">max.in.flight.requests.per.connection</code>，默认值是5。这表示可以在生成器端缓冲的未确认请求的数量。如果<code class="fe mf mg mh mi b">retries</code>大于1，并且第一个请求失败，但是第二个请求成功，那么第一个请求将被重新发送，并且消息将处于错误的顺序。</p><p id="1904" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据<a class="ae ky" href="http://kafka.apache.org/documentation/#max.in.flight.requests.per.connection" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="oc od oe"><p id="bc1f" class="kz la me lb b lc ld ju le lf lg jx lh of lj lk ll og ln lo lp oh lr ls lt lu im bi translated">请注意，如果此设置设置为大于1，并且发送失败，则存在由于重试(即，如果启用重试)而导致消息重新排序的风险。</p></blockquote><p id="b2c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您没有启用幂等，但是仍然希望保持消息有序，那么您应该将该设置配置为1。</p><p id="aa05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是如果您已经启用了幂等，那么您就不需要显式定义这个配置。卡夫卡会选择合适的价值观，如这里所说的<a class="ae ky" href="http://kafka.apache.org/documentation/#enable.idempotence" rel="noopener ugc nofollow" target="_blank"/>。</p><blockquote class="oc od oe"><p id="e13d" class="kz la me lb b lc ld ju le lf lg jx lh of lj lk ll og ln lo lp oh lr ls lt lu im bi translated">如果用户没有明确设置这些值，将选择合适的值。如果设置了不兼容的值，将抛出一个<code class="fe mf mg mh mi b">ConfigException</code>。</p></blockquote></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="9432" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">发送消息太快</h2><p id="5ab9" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">当生产者调用<code class="fe mf mg mh mi b">send()</code>时，消息不会立即发送，而是添加到内部缓冲区。默认的<code class="fe mf mg mh mi b">buffer.memory</code>是32MB。如果生产者发送消息的速度比发送给代理的速度快，或者出现了网络问题，那么超过了<code class="fe mf mg mh mi b">buffer.memory</code>，那么<code class="fe mf mg mh mi b">send()</code>调用将被阻塞到<code class="fe mf mg mh mi b">max.block.ms</code>(默认为1分钟)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/bbb972ea08f8beb9d70843b646e4c807.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*vgVo-sGlsyvCxrZDFhS4pQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">buffer.memory和max.block.ms由<a class="np nq ep" href="https://medium.com/u/2adc5a07e772?source=post_page-----ec6903c63e3f--------------------------------" rel="noopener" target="_blank">高</a>创建</p></figure><p id="4fb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">增加这两个值可以缓解这个问题。</p><p id="eba5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外两个可以玩的配置是<code class="fe mf mg mh mi b">linger.ms</code>和<code class="fe mf mg mh mi b">batch.size</code>。<code class="fe mf mg mh mi b">linger.ms</code>是批次准备发送前的延迟时间。默认值为0，这意味着即使批处理中只有一条消息，也会立即发送批处理。有时候，人们增加<code class="fe mf mg mh mi b">linger.ms</code>来减少请求的数量，提高吞吐量。但是这将导致更多的消息保存在内存中。所以，确保你照顾到双方。</p><p id="adf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一个和<code class="fe mf mg mh mi b">linger.ms</code>相当的配置，就是<code class="fe mf mg mh mi b">batch.size</code>。这是单批的最大数量。当满足这两个要求中的任何一个时，将发送批次。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="b489" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">结论</h2><p id="c437" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">以下是我认为可以让你的卡夫卡制作人更有弹性的10个配置。当然，它们不是您需要注意的唯一配置，但这可能是一个很好的起点。请务必阅读官方Apache Kafka文档以获得可靠的参考。</p><p id="3949" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有任何其他想法，请在下面留下你的评论。保重！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="107f" class="mq mr it bd ms mt mu dn mv mw mx dp my li mz na nb lm nc nd ne lq nf ng nh ni bi translated">参考</h2><div class="oj ok gp gr ol om"><a href="https://www.cloudkarafka.com/blog/2019-09-28-what-does-in-sync-in-apache-kafka-really-mean.html" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">阿帕奇卡夫卡中的同步副本到底是什么意思？- CloudKarafka，阿帕奇卡夫卡留言…</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">Kafka认为，当同步副本集(ISR)中的所有副本都确认它们…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.cloudkarafka.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">恰好一次语义是可能的:下面是阿帕奇卡夫卡如何做到这一点</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">我很高兴我们达到了Apache Kafkaand社区期待已久的激动人心的里程碑:我们已经…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.confluent.io</p></div></div><div class="ov l"><div class="pb l ox oy oz ov pa ks om"/></div></div></a></div></div></div>    
</body>
</html>