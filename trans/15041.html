<html>
<head>
<title>Query Metabase data in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python中查询元数据库数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-metabase-data-in-python-ea7f866e6782?source=collection_archive---------13-----------------------#2020-10-16">https://towardsdatascience.com/query-metabase-data-in-python-ea7f866e6782?source=collection_archive---------13-----------------------#2020-10-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="741c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">元数据库rest API和Python API</h2></div><p id="2979" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Metabase是一个开源BI工具，您可以在其中存储数据、连接到外部数据源、查询和可视化数据。本文讨论当我们将数据存储在元数据库中时，我们如何在Python中查询数据并获得结果。本文的第一部分讨论了如何使用Metabase rest API来查询数据。第二部分尝试Python API。让我们开始吧。</p><h1 id="a8d8" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">元数据库rest API</h1><h2 id="f183" class="lw lf it bd lg lx ly dn lk lz ma dp lo kr mb mc lq kv md me ls kz mf mg lu mh bi translated">获取会话令牌</h2><p id="fbf9" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">要使用元数据库rest API，我们首先需要获得一个会话令牌。在命令行中键入以下内容:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="170f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输出将是您的令牌。然后将这个令牌保存在Python脚本或Jupyter笔记本中。</p><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="87dc" class="lw lf it mv b gy mz na l nb nc">token = "YOUR_TOKEN"</span></pre><p id="d6a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您可以在Python脚本中运行以下内容来获取令牌:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="9568" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">查询卡片</strong></p><p id="4ea8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有两种方法可以查询元数据库数据。第一个选项是从卡中查询数据，或者在UI上询问问题。在UI中，我们可以直接通过UI提出问题并查询数据:</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/8ae127575896a9caa68580951fba22b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MvxSjTjbQIQuSvXu7iQpRQ.png"/></div></div><p class="nk nl gj gh gi nm nn bd b be z dk translated">来源:元数据库</p></figure><p id="9e55" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦我们创建了问题，我们可以检查这个问题是否出现在<code class="fe no np nq mv b">api/card</code>中:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="f2de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输出显示了一个字典列表，每个字典对应于用户通过UI提出的一个问题。然后我们可以用下面的代码找到卡的ID号并得到卡的结果。这基本上是用你在卡中定义的查询(问题)来查询数据库。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="bc36" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">直接查询数据库</strong></p><p id="daef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第二种选择是直接查询数据库，而不是首先定义卡并查询卡。</p><p id="1385" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们想从数据库<code class="fe no np nq mv b">1</code>中查询表<code class="fe no np nq mv b">users</code>，并输出2020-10-15之后创建的所有行。这里我们需要在SQL本地查询中定义这个查询。然后将查询添加到<code class="fe no np nq mv b">requests.post</code>函数中。由此产生的<code class="fe no np nq mv b">res.json()</code>是一本字典。读入数据和列。我们可以从<code class="fe no np nq mv b">res.json()['data']['row']</code>获取所有数据，然后从<code class="fe no np nq mv b">res.json()['data']['results_metadata']['columns']</code>获取列名。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="97ad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您应该能够在<code class="fe no np nq mv b">df</code>中看到您的查询结果。</p><h1 id="c3e7" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">Python API</h1><p id="e9da" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">我还尝试了一个Python API <a class="ae nr" href="https://github.com/mertsalik/metabasepy/blob/master/docs/guide.md" rel="noopener ugc nofollow" target="_blank">元库</a>。类似于我们上面提到的<strong class="kk iu">查询卡片</strong>部分，这里我们可以用下面的代码查询卡片1:</p><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="9af6" class="lw lf it mv b gy mz na l nb nc">from metabasepy import Client, MetabaseTableParser</span><span id="47c7" class="lw lf it mv b gy ns na l nb nc">cli = Client(username=username, password=password, base_url=endpoint)</span><span id="b032" class="lw lf it mv b gy ns na l nb nc">cli.authenticate()</span><span id="3532" class="lw lf it mv b gy ns na l nb nc">query_response = cli.cards.query(card_id="1")</span><span id="c597" class="lw lf it mv b gy ns na l nb nc">data_table = MetabaseTableParser.get_table(metabase_response=query_response)</span><span id="c5c1" class="lw lf it mv b gy ns na l nb nc">df = pd.DataFrame(data_table.__dict__['rows'])<br/>df</span></pre><p id="b2a7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我感觉Python API不太灵活。但是当然欢迎你去尝试。</p><h1 id="79ab" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">结论</h1><p id="bbf9" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在这里，我向您展示了三种从元数据库查询数据的方法:使用元数据库rest API从卡中查询，使用元数据库rest API通过用户定义的查询直接从数据库中查询，以及使用Python API <a class="ae nr" href="https://github.com/mertsalik/metabasepy/blob/master/docs/guide.md" rel="noopener ugc nofollow" target="_blank">元数据库</a>从卡中查询。</p><p id="25a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我更喜欢使用Metabase rest API通过用户定义的查询直接从数据库中查询。使用这种方法，我们可以在Python脚本中包含所有的查询，并且我们确切地知道我们在查询什么。</p><p id="c18b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在元数据库中还有许多其他可用的API调用，我们没有介绍。本文中的代码应该是您学习和探索其他API函数的良好起点。希望你喜欢它！谢谢！</p><p id="989b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考</p><div class="nt nu gp gr nv nw"><a href="https://github.com/metabase/metabase/wiki/Using-the-REST-API" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">元数据库/元数据库</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">本指南应该有助于回答一些关于使用元数据库REST API的常见问题。如果您有任何问题，请随时提出…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">github.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok ni nw"/></div></div></a></div><div class="nt nu gp gr nv nw"><a href="https://stackoverflow.com/questions/50620095/is-it-possible-to-get-raw-data-from-a-metabase-mbql-sql-query-via-the-rest-api" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">有可能通过REST API从元数据库MBQL / SQL查询中获取原始数据吗？</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">有没有一个元数据库REST API接受一个MBQL/SQL查询并返回原始数据？我可以通过…执行MBQL查询</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">stackoverflow.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok ni nw"/></div></div></a></div></div></div>    
</body>
</html>