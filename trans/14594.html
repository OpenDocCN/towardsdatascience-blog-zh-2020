<html>
<head>
<title>Step-by-Step tutorial to build a minimal CI/CD pipeline for your Python project using Travis-CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Travis-CI为您的Python项目构建最小CI/CD管道的分步教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/step-by-step-tutorial-to-build-a-minimal-ci-cd-pipeline-for-your-python-project-using-travis-ci-c074e42f0c65?source=collection_archive---------21-----------------------#2020-10-08">https://towardsdatascience.com/step-by-step-tutorial-to-build-a-minimal-ci-cd-pipeline-for-your-python-project-using-travis-ci-c074e42f0c65?source=collection_archive---------21-----------------------#2020-10-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="220d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Travis-CI、Codecov和Pypi自动构建、测试和发布您的Python包。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/188950160125effb4e0f685e17a22299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YtYFcW6TcaKLIvYDPd7cDg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Philipp Wüthrich 在<a class="ae kv" href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="2a19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您想在自动发布/部署包之前，节省在多种环境中测试python代码的时间，那么构建CI/CD管道非常有用。这也是一种及早发现错误并确保开发过程的一致性和可重复性的方法。</p><p id="8c1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我最近参与了一个项目，该项目实现了一种相对较新的方法，将深度学习模型应用于结构化数据，该方法的细节可以在这里找到:<a class="ae kv" rel="noopener" target="_blank" href="/training-better-deep-learning-models-for-structured-data-using-semi-supervised-learning-8acc3b536319">使用半监督学习为结构化数据训练更好的深度学习模型</a>。我想建立一个CI/CD管道来完成以下任务:</p><ul class=""><li id="d019" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">在每次合并请求时自动测试代码的。</li><li id="5f5b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">计算并显示主分支的<strong class="ky ir">测试覆盖率</strong>。</li><li id="5d48" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如果登台分支上的构建通过了测试，python包 /wheel的自动<strong class="ky ir">部署到PyPi。</strong></li></ul><p id="9256" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了做到这一点，我使用了Github、<a class="ae kv" href="https://travis-ci.org" rel="noopener ugc nofollow" target="_blank"> Travis-CI </a>和<a class="ae kv" href="https://codecov.io/" rel="noopener ugc nofollow" target="_blank"> Codecov、</a>这两个软件对开源项目都是免费的。</p><h1 id="22e8" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">步骤:</h1><h2 id="a0fa" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">1)登录</h2><p id="452d" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">第一步是使用您的Github帐户登录Travis-CI，然后转到settings并激活您想要处理的存储库:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/3aa5dfc53a7f4999593ba499e17c621e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e3zmuGzFproEj912La3_eA.png"/></div></div></figure><p id="5545" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后用Codecov做同样的事情:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/e98e642cc223283655a8b1a90830c1b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkK7LEBGnhgSimS1yPywwA.png"/></div></div></figure><p id="0ebd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后是PyPI，您需要通过转到account setting来生成一个访问令牌:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/042f34d2aee59ac8f2c1caea5f8f2ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BCBTtfuuvpI9TUmrTjHWIA.png"/></div></div></figure><h2 id="e251" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">2)将PyPI令牌添加到Travis-CI:</h2><p id="f347" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">要自动发布包，您需要将PyPI令牌作为环境变量添加到Travis-CI中。在设置中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/2df91f5c83be9f50cee43eb892753d66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLYfojLfLwPCQSKOF0fXpA.png"/></div></div></figure><h2 id="8312" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">3)代码</h2><p id="5a62" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">代码需要有一个<strong class="ky ir"> setup.py </strong>文件以及一个<strong class="ky ir"> requirements.txt </strong>(如果需要的话)。例如，我的代码依赖于多个像Tensorflow或Pandas这样的库，所以我需要一个这样的需求文件:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="6ce8" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">pandas</strong>==<strong class="nu ir">1.0.4<br/>numpy</strong>==<strong class="nu ir">1.17.3<br/>scipy</strong>==<strong class="nu ir">1.4.1<br/>matplotlib</strong>==<strong class="nu ir">3.1.1<br/>tensorflow_gpu</strong>==<strong class="nu ir">2.0.1<br/>tqdm</strong>==<strong class="nu ir">4.36.1<br/>scikit_learn</strong>==<strong class="nu ir">0.23.2<br/>tensorflow</strong>==<strong class="nu ir">2.3.0</strong></span></pre><p id="9e4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还需要实现一些测试，并将它们放在tests/文件夹中。我的代码中的一个测试示例是在合成训练集上运行一个小训练，并通过在测试集上运行一个评估来检查网络是否学习了:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="6ecb" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">from </strong>deeptabular.deeptabular <strong class="nu ir">import </strong>(<br/>    DeepTabularClassifier,<br/>)<br/><strong class="nu ir">import </strong>pandas <strong class="nu ir">as </strong>pd<br/><strong class="nu ir">import </strong>numpy <strong class="nu ir">as </strong>np<br/><strong class="nu ir">import </strong>tensorflow <strong class="nu ir">as </strong>tf<br/><strong class="nu ir">from </strong>sklearn.metrics <strong class="nu ir">import </strong>accuracy_score<br/><br/><br/><strong class="nu ir">def </strong>test_build_classifier():<br/>    classifier = DeepTabularClassifier(<br/>        cat_cols=[<strong class="nu ir">"C1"</strong>, <strong class="nu ir">"C2"</strong>], num_cols=[<strong class="nu ir">"N1"</strong>, <strong class="nu ir">"N2"</strong>], n_targets=1, num_layers=1<br/>    )<br/>    df = pd.DataFrame(<br/>        {<br/>            <strong class="nu ir">"C1"</strong>: np.random.randint(0, 10, size=5000),<br/>            <strong class="nu ir">"C2"</strong>: np.random.randint(0, 10, size=5000),<br/>            <strong class="nu ir">"N1"</strong>: np.random.uniform(-1, 1, size=5000),<br/>            <strong class="nu ir">"N2"</strong>: np.random.uniform(-1, 1, size=5000),<br/>            <strong class="nu ir">"target"</strong>: np.random.uniform(-1, 1, size=5000),<br/>        }<br/>    )<br/>    df[<strong class="nu ir">"target"</strong>] = df.apply(<br/>        <strong class="nu ir">lambda </strong>x: 1 <strong class="nu ir">if </strong>(x[<strong class="nu ir">"C1"</strong>] == 4 <strong class="nu ir">and </strong>x[<strong class="nu ir">"N1"</strong>] &lt; 0.5) <strong class="nu ir">else </strong>0, axis=1<br/>    )<br/><br/>    test = pd.DataFrame(<br/>        {<br/>            <strong class="nu ir">"C1"</strong>: np.random.randint(0, 10, size=5000),<br/>            <strong class="nu ir">"C2"</strong>: np.random.randint(0, 10, size=5000),<br/>            <strong class="nu ir">"N1"</strong>: np.random.uniform(-1, 1, size=5000),<br/>            <strong class="nu ir">"N2"</strong>: np.random.uniform(-1, 1, size=5000),<br/>            <strong class="nu ir">"target"</strong>: np.random.uniform(-1, 1, size=5000),<br/>        }<br/>    )<br/>    test[<strong class="nu ir">"target"</strong>] = test.apply(<br/>        <strong class="nu ir">lambda </strong>x: 1 <strong class="nu ir">if </strong>(x[<strong class="nu ir">"C1"</strong>] == 4 <strong class="nu ir">and </strong>x[<strong class="nu ir">"N1"</strong>] &lt; 0.5) <strong class="nu ir">else </strong>0, axis=1<br/>    )<br/><br/>    classifier.fit(df, target_col=<strong class="nu ir">"target"</strong>, epochs=100, save_path=<strong class="nu ir">None</strong>)<br/><br/>    pred = classifier.predict(test)<br/><br/>    acc = accuracy_score(test[<strong class="nu ir">"target"</strong>], pred)<br/><br/>    <strong class="nu ir">assert </strong>isinstance(classifier.model, tf.keras.models.Model)<br/>    <strong class="nu ir">assert </strong>acc &gt; 0.9</span></pre><h2 id="435b" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">4)管道</h2><p id="7271" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">Travis-CI中使用的管道被编写为YAML文件。例如，deeptabular存储库中使用的是:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="d3ff" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">language</strong>: python<br/><strong class="nu ir">python</strong>:<br/>  - <strong class="nu ir">"3.6"<br/>  </strong>- <strong class="nu ir">"3.7"<br/>install</strong>:<br/>  - pip install -r requirements.txt<br/>  - pip install codecov<br/>  - pip install pytest-cov<br/>  - pip install .<br/><strong class="nu ir">script</strong>:<br/>  - pytest --cov-report=xml --cov=deeptabular tests/<br/><br/><strong class="nu ir">after_success</strong>:<br/>  - codecov<br/><br/><strong class="nu ir">deploy</strong>:<br/>  <strong class="nu ir">provider</strong>: pypi<br/>  <strong class="nu ir">user</strong>: __token__<br/>  <strong class="nu ir">password</strong>: $TEST_PYPI_TOKEN<br/>  <strong class="nu ir">distributions</strong>: <strong class="nu ir">"sdist bdist_wheel"<br/>  skip_existing</strong>: true<br/>  <strong class="nu ir">on</strong>:<br/>    <strong class="nu ir">branch</strong>: staging</span></pre><p id="0276" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先选择要使用的python版本:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="d397" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">python</strong>:<br/>  - <strong class="nu ir">"3.6"<br/>  </strong>- <strong class="nu ir">"3.7"</strong></span></pre><p id="0feb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后安装库的需求加上库本身，pytest和用于测试的Codecov:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="5ea1" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">install</strong>:<br/>  - pip install -r requirements.txt<br/>  - pip install codecov<br/>  - pip install pytest-cov<br/>  - pip install .</span></pre><p id="218c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行测试并将测试覆盖结果写成XML格式:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="7f7d" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">script</strong>:<br/>  - pytest --cov-report=xml --cov=deeptabular tests/</span></pre><p id="02e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将覆盖报告推送到codecov:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="feaf" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">after_success</strong>:<br/>  - codecov</span></pre><p id="70c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，将包作为zip和wheel发布到PyPI:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="52e5" class="my mh iq nu b gy ny nz l oa ob"><strong class="nu ir">deploy</strong>:<br/>  <strong class="nu ir">provider</strong>: pypi<br/>  <strong class="nu ir">user</strong>: __token__<br/>  <strong class="nu ir">password</strong>: $TEST_PYPI_TOKEN<br/>  <strong class="nu ir">distributions</strong>: <strong class="nu ir">"sdist bdist_wheel"<br/>  skip_existing</strong>: true<br/>  <strong class="nu ir">on</strong>:<br/>    <strong class="nu ir">branch</strong>: staging</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/8e39e5e9c4cceaa0274cb5a45e94c899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4VKkOidEl6V6mvffxQjehw.png"/></div></div></figure><p id="f23c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后将包推送到PyPI:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/f4e894688cb6b148c1f90a47aebce1d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0M6_VZXMCUG4Xg3wzXesXw.png"/></div></div></figure><p id="2bbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试覆盖结果可以在Codecov:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/449989722d7c1612b52cf7fcee8d8c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JnO8tWaJ0KwKZUveu8UbUA.png"/></div></div></figure><p id="078d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结论:</p><p id="2afa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样，每当有代码被推送到任何分支时，这个管道就运行测试，如果staging分支发生变化，就将包发布到PyPI。</p><p id="87f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">参考资料:</p><ol class=""><li id="3e8e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr of ly lz ma bi translated"><a class="ae kv" href="https://dev.to/oscarmcm/distributing-pypi-packages-using-api-tokens-in-travisci-1n9i" rel="noopener ugc nofollow" target="_blank">https://dev . to/oscarmcm/distributing-pypi-packages-using-API-tokens-in-travisci-1n9i</a></li><li id="27c2" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr of ly lz ma bi translated">【https://docs.travis-ci.com/user/languages/python/ T2】号</li></ol><h2 id="1785" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">代码:</h2><p id="f3e2" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">【https://github.com/CVxTz/DeepTabular T4】</p></div></div>    
</body>
</html>