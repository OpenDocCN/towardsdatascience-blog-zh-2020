<html>
<head>
<title>How to connect and interact with search applications from python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从python连接搜索应用程序并与之交互</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-connect-and-interact-with-search-applications-from-python-520118139f69?source=collection_archive---------59-----------------------#2020-10-28">https://towardsdatascience.com/how-to-connect-and-interact-with-search-applications-from-python-520118139f69?source=collection_archive---------59-----------------------#2020-10-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9ef6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个<a class="ae kf" href="https://pyvespa.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> pyvespa </a>图书馆概述:连接、查询、收集数据和评估查询模型。</h2></div><p id="1315" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><a class="ae kf" href="https://vespa.ai/" rel="noopener ugc nofollow" target="_blank"> Vespa </a>是目前可用的更快、更具扩展性和更先进的搜索引擎，imho。它有一个原生张量评估框架，可以执行<a class="ae kf" href="https://blog.vespa.ai/approximate-nearest-neighbor-search-in-vespa-part-1/" rel="noopener ugc nofollow" target="_blank">近似最近邻搜索</a>并部署NLP建模的最新进展，如<a class="ae kf" href="https://blog.vespa.ai/efficient-open-domain-question-answering-on-vespa/" rel="noopener ugc nofollow" target="_blank"> BERT模型</a>。</p><p id="9acd" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="lc">这篇文章将通过</em> <a class="ae kf" href="https://pyvespa.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> pyvespa库</em> </a> <em class="lc">向您概述Vespa python API。</em> <strong class="ki ir"> <em class="lc">该库的主要目标是允许更快的原型开发，并促进Vespa应用的机器学习实验。</em> </strong></p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/8a68a676c38187cb2ff8eff67db193e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CAwFRrsfm-24kuZIoRU1Q.jpeg"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@davidclode?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">大卫·克洛德</a>在<a class="ae kf" href="https://unsplash.com/s/photos/python?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7029" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们将连接到<a class="ae kf" href="https://cord19.vespa.ai/" rel="noopener ugc nofollow" target="_blank"> CORD-19搜索应用</a>，并在此将其作为示例。您可以稍后使用自己的应用程序来复制以下步骤。未来的帖子将会更深入地讨论本概述教程中描述的每个主题。</p><p id="52a5" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">你也可以从<a class="ae kf" href="https://colab.research.google.com/github/vespa-engine/pyvespa/blob/master/docs/sphinx/source/connect-to-vespa-instance.ipynb" rel="noopener ugc nofollow" target="_blank"> Google Colab </a>运行这里包含的步骤。</p><h2 id="0e0f" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">安装</h2><p id="3bc8" class="pw-post-body-paragraph kg kh iq ki b kj mm jr kl km mn ju ko kp mo kr ks kt mp kv kw kx mq kz la lb ij bi translated">警告:库正在开发中，可能会发生向后不兼容的变化。欢迎反馈和贡献。</p><p id="56df" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这个库可以在PyPI上获得，因此可以和<code class="fe mr ms mt mu b">pip</code>一起安装。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="67f3" class="lt lu iq mu b gy mz na l nb nc">!pip install pyvespa</span></pre><h2 id="4905" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">连接到正在运行的Vespa应用程序</h2><p id="8f01" class="pw-post-body-paragraph kg kh iq ki b kj mm jr kl km mn ju ko kp mo kr ks kt mp kv kw kx mq kz la lb ij bi translated">我们可以通过使用适当的url创建一个<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.application.Vespa"> Vespa </a>的实例来连接到一个正在运行的Vespa应用程序。产生的<code class="fe mr ms mt mu b">app</code>将用于与应用程序通信。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="4843" class="lt lu iq mu b gy mz na l nb nc">from vespa.application import Vespa<br/><br/>app = Vespa(url = "https://api.cord19.vespa.ai")</span></pre><h2 id="548e" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">定义查询模型</h2><blockquote class="nd ne nf"><p id="e910" class="kg kh lc ki b kj kk jr kl km kn ju ko ng kq kr ks nh ku kv kw ni ky kz la lb ij bi translated">轻松定义匹配和排名标准</p></blockquote><p id="64f7" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在构建搜索应用程序时，我们通常希望尝试不同的查询模型。一个<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.query.Query">查询</a>模型由匹配阶段和排序阶段组成。匹配阶段将定义如何基于发送的查询匹配文档，排名阶段将定义如何对匹配的文档进行排名。这两个阶段都可能变得相当复杂，能够轻松地表达和试验它们是非常有价值的。</p><p id="4719" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在下面的例子中，我们将匹配阶段定义为<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.query.WeakAnd">weak</a>和<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.query.ANN"> ANN </a>操作符的<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.query.Union">联合</a>。<code class="fe mr ms mt mu b">WeakAnd</code>将根据查询术语匹配文档，而近似最近邻(<code class="fe mr ms mt mu b">ANN</code>)操作符将根据查询和文档嵌入之间的距离匹配文档。这说明了在Vespa中结合术语和语义匹配是多么容易。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="b47e" class="lt lu iq mu b gy mz na l nb nc">from vespa.query import Union, WeakAnd, ANN<br/>from random import random<br/><br/>match_phase = Union(<br/>    WeakAnd(hits = 10), <br/>    ANN(<br/>        doc_vector="title_embedding", <br/>        query_vector="title_vector", <br/>        embedding_model=lambda x: [random() for x in range(768)],<br/>        hits = 10,<br/>        label="title"<br/>    )<br/>)</span></pre><p id="351c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">然后，我们定义由已经在<a class="ae kf" href="https://github.com/vespa-engine/sample-apps/blob/master/vespa-cloud/cord-19-search/src/main/application/schemas/doc.sd" rel="noopener ugc nofollow" target="_blank">应用程序模式</a>中定义的<code class="fe mr ms mt mu b">bm25</code> rank-profile完成的排名。在本教程的后面，我们将<code class="fe mr ms mt mu b">list_features=True</code>设置为能够收集排名特征。在定义了<code class="fe mr ms mt mu b">match_phase</code>和<code class="fe mr ms mt mu b">rank_profile</code>之后，我们可以实例化<code class="fe mr ms mt mu b">Query</code>模型。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="9bd3" class="lt lu iq mu b gy mz na l nb nc">from vespa.query import Query, RankProfile<br/><br/>rank_profile = RankProfile(name="bm25", list_features=True)<br/><br/>query_model = Query(match_phase=match_phase, rank_profile=rank_profile)</span></pre><h2 id="5dac" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">查询vespa应用程序</h2><blockquote class="nd ne nf"><p id="f30b" class="kg kh lc ki b kj kk jr kl km kn ju ko ng kq kr ks nh ku kv kw ni ky kz la lb ij bi translated">通过查询API发送查询。更多示例参见<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/query.ipynb">查询页面</a>。</p></blockquote><p id="3479" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以使用刚刚定义的<code class="fe mr ms mt mu b">query_model</code>通过<code class="fe mr ms mt mu b">query</code>方法向应用程序发出查询。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="f980" class="lt lu iq mu b gy mz na l nb nc">query_result = app.query(<br/>    query="Is remdesivir an effective treatment for COVID-19?", <br/>    query_model=query_model<br/>)</span></pre><p id="712b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以看到Vespa检索到的文档数量:</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="d3de" class="lt lu iq mu b gy mz na l nb nc">query_result.number_documents_retrieved</span><span id="437c" class="lt lu iq mu b gy nj na l nb nc">1121</span></pre><p id="70e0" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">以及返还给我们的文件数量:</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="8c5b" class="lt lu iq mu b gy mz na l nb nc">len(query_result.hits)</span><span id="b722" class="lt lu iq mu b gy nj na l nb nc">10</span></pre><h2 id="158f" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">标记数据</h2><blockquote class="nd ne nf"><p id="b98f" class="kg kh lc ki b kj kk jr kl km kn ju ko ng kq kr ks nh ku kv kw ni ky kz la lb ij bi translated">如何构造标签数据</p></blockquote><p id="6080" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们经常需要通过ML评估查询模型或者收集数据来改进查询模型。在这两种情况下，我们通常需要带标签的数据。让我们创建一些带标签的数据来说明它们的预期格式以及它们在库中的用法。</p><p id="6f1a" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">每个数据点包含一个与查询相关的<code class="fe mr ms mt mu b">query_id</code>、一个<code class="fe mr ms mt mu b">query</code>和<code class="fe mr ms mt mu b">relevant_docs</code>。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="462f" class="lt lu iq mu b gy mz na l nb nc">labelled_data = [<br/>    {<br/>        "query_id": 0, <br/>        "query": "Intrauterine virus infections and congenital heart disease",<br/>        "relevant_docs": [{"id": 0, "score": 1}, {"id": 3, "score": 1}]<br/>    },<br/>    {<br/>        "query_id": 1, <br/>        "query": "Clinical and immunologic studies in identical twins discordant for systemic lupus erythematosus",<br/>        "relevant_docs": [{"id": 1, "score": 1}, {"id": 5, "score": 1}]<br/>    }<br/>]</span></pre><p id="c976" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">默认分配<code class="fe mr ms mt mu b">"score": 0</code>不相关的文档。如果标签数据中缺少该字段，相关文档将默认分配<code class="fe mr ms mt mu b">"score": 1</code>。相关和不相关文档的默认值都可以通过适当的方法进行修改。</p><h2 id="e5a9" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">收集培训数据</h2><blockquote class="nd ne nf"><p id="1cca" class="kg kh lc ki b kj kk jr kl km kn ju ko ng kq kr ks nh ku kv kw ni ky kz la lb ij bi translated">收集培训数据以分析和/或改进排名功能。更多示例参见<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/collect-training-data.ipynb">收集训练数据页面</a>。</p></blockquote><p id="a256" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们可以根据具体的<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.query.Query">查询</a>模型，用<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/reference-api.rst#vespa.application.Vespa.collect_training_data"> collect_training_data </a>方法收集训练数据。下面我们将为每个查询收集两个文档，以及相关的文档。</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="9610" class="lt lu iq mu b gy mz na l nb nc">training_data_batch = app.collect_training_data(<br/>    labelled_data = labelled_data,<br/>    id_field = "id",<br/>    query_model = query_model,<br/>    number_additional_docs = 2,<br/>    fields = ["rankfeatures"]<br/>)</span></pre><p id="5b0b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">默认情况下，会返回许多等级要素。我们可以选择其中的一些进行检查:</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="5ec0" class="lt lu iq mu b gy mz na l nb nc">training_data_batch[<br/>    [<br/>        "document_id", "query_id", "label", <br/>        "textSimilarity(title).proximity", <br/>        "textSimilarity(title).queryCoverage", <br/>        "textSimilarity(title).score"<br/>    ]<br/>]</span></pre><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="ab gu cl nk"><img src="../Images/b4ce8e0c3948410b0c96adb514d7a322.png" data-original-src="https://miro.medium.com/v2/format:webp/1*InlV1d86K6ZxYzW3w9gz-g.png"/></div></figure><h2 id="aeeb" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kp mc md me kt mf mg mh kx mi mj mk ml bi translated">评估查询模型</h2><blockquote class="nd ne nf"><p id="d239" class="kg kh lc ki b kj kk jr kl km kn ju ko ng kq kr ks nh ku kv kw ni ky kz la lb ij bi translated">定义度量并评估查询模型。更多示例参见<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/evaluation.ipynb">评估页</a>。</p></blockquote><p id="a4b5" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们将定义以下评估指标:</p><ul class=""><li id="2e66" class="nl nm iq ki b kj kk km kn kp nn kt no kx np lb nq nr ns nt bi translated">每次查询检索到的文档百分比</li><li id="75e1" class="nl nm iq ki b kj nu km nv kp nw kt nx kx ny lb nq nr ns nt bi translated">每次查询召回10次</li><li id="9aff" class="nl nm iq ki b kj nu km nv kp nw kt nx kx ny lb nq nr ns nt bi translated">每次查询MRR @ 10</li></ul><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="a983" class="lt lu iq mu b gy mz na l nb nc">from vespa.evaluation import MatchRatio, Recall, ReciprocalRank<br/><br/>eval_metrics = [MatchRatio(), Recall(at=10), ReciprocalRank(at=10)]</span></pre><p id="6c96" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">评估:</p><pre class="le lf lg lh gt mv mu mw mx aw my bi"><span id="61fa" class="lt lu iq mu b gy mz na l nb nc">evaluation = app.evaluate(<br/>    labelled_data = labelled_data,<br/>    eval_metrics = eval_metrics, <br/>    query_model = query_model, <br/>    id_field = "id",<br/>)<br/>evaluation</span></pre><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="ab gu cl nk"><img src="../Images/b72f761ec4b3f26932760ab18cf11328.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wqTDexMBUUH-q1Nbm6Tmow.png"/></div></figure></div></div>    
</body>
</html>