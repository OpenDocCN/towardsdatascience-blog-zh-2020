<html>
<head>
<title>How to cluster images based on visual similarity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何基于视觉相似性对图像进行聚类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-cluster-images-based-on-visual-similarity-cd6e7209fe34?source=collection_archive---------1-----------------------#2020-09-29">https://towardsdatascience.com/how-to-cluster-images-based-on-visual-similarity-cd6e7209fe34?source=collection_archive---------1-----------------------#2020-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7dca" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用预训练的神经网络进行特征提取，并使用K-means对图像进行聚类。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/24d69b48b9f2f18b856ee1be502b124b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RARg2hIOV2DCGO-h"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@pietrozj?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Pietro Jeng </a>拍摄</p></figure><h1 id="256d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">目标</h1><p id="5071" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本教程中，我将指导您使用预训练的神经网络从图像中提取特征向量，并根据特征向量的相似程度对图像进行聚类。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="2c8f" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated"><strong class="ak">车型</strong></h2><p id="af76" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">本教程将使用的预训练模型是VGG16卷积神经网络(CNN)，它被认为是图像识别任务的最先进技术。我们将仅使用该模型作为特征提取器，这意味着我们将移除最终(预测)层，以便我们可以获得特征向量。</p><h2 id="e6e9" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">数据</h2><p id="4ac7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这个实现将使用Kaggle的flowers数据集，您可以从这里下载<a class="ae kv" href="https://www.kaggle.com/olgabelitskaya/flower-color-images?" rel="noopener ugc nofollow" target="_blank"/>。该数据集包含10种不同花卉的210张图片，这些图片将被下载为<em class="nd"> png </em>文件。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="5fca" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">进口</h2><p id="2382" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在我们开始之前，我们需要导入所需的模块，以便加载/处理图像以及提取和聚类我们的特征向量的模块。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">导入报表</p></figure><ul class=""><li id="0200" class="ng nh iq lq b lr ni lu nj lx nk mb nl mf nm mj nn no np nq bi translated"><strong class="lq ir"> load_img </strong>允许我们从文件中加载一张图片作为PIL对象</li><li id="303f" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated"><strong class="lq ir"> img_to_array </strong>允许我们将PIL对象转换成NumPy数组</li><li id="8fa9" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated"><strong class="lq ir">preprocess _ input</strong>用于将图像准备成模型要求的格式。您应该使用Keras <strong class="lq ir"> load_img </strong>函数加载图像，以便确保您加载的图像与<strong class="lq ir"> preprocess_input </strong>函数兼容。</li><li id="f826" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated">VGG16 是我们将要使用的预训练模型</li><li id="c5b7" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated"><strong class="lq ir">k表示我们将要使用的聚类算法</strong></li><li id="6552" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated"><strong class="lq ir"> PCA </strong>用于降低我们特征向量的维数</li></ul><h2 id="ff05" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">加载数据</h2><p id="64c2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">既然数据已经下载到您的计算机上，我们希望python指向图像所在的位置。这样，我们不用加载完整的文件路径，只需使用文件名即可。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加载数据</p></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="b211" class="mr kx iq nx b gy ob oc l od oe"># view the first 10 flower entries<br/>print(flowers[:10])</span><span id="1804" class="mr kx iq nx b gy of oc l od oe">output:<br/>['0001.png', '0002.png', '0003.png', '0004.png', '0005.png', '0006.png', '0007.png', '0008.png', '0009.png', '0010.png']</span></pre><p id="ec80" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">现在我们已经将所有的文件名加载到花的列表中，我们可以开始预处理图像了。</p><h2 id="b749" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">数据预处理</h2><p id="64e4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这就是我们使用<strong class="lq ir"> load_img() </strong>和<strong class="lq ir"> preprocess_input() </strong>方法的地方。加载图像时，我们将目标大小设置为(224，224 ),因为VGG模型期望它接收的图像是224x224 NumPy数组。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加载图像</p></figure><p id="909b" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">目前，我们的阵列只有3个维度(行、列、通道),并且该模型在批量样本中运行。所以我们需要扩展我们的数组来增加维度，让模型知道我们给了它多少图像(样本数，行数，列数，通道数)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图像整形</p></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="368d" class="mr kx iq nx b gy ob oc l od oe"><br/>Number of dimensions: 4 <br/>Number of images (batch size): 1 <br/>Number of rows (0th axis): 224 <br/>Number of columns (1st axis): 224 <br/>Number of channels (rgb): 3</span></pre><p id="f7cc" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">最后一步是将整形后的数组传递给<strong class="lq ir"> preprocess_input </strong>方法，我们的图像就可以加载到模型中了。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">预处理输入</p></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="2cd7" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">模型</h2><p id="391e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在我们可以加载VGG模型并手动移除输出层。这意味着新的最终层是具有4，096个输出节点的全连接层。这个4，096个数字的向量是我们将用来对图像进行聚类的特征向量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="8831" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">现在，最后一层被删除，我们可以通过我们的图像通过<strong class="lq ir">预测</strong>方法来获得我们的特征向量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="566d" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">下面是一个函数中的所有代码</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">特征提取流水线</p></figure><p id="6e56" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">现在我们可以使用这个<strong class="lq ir"> feature_extraction </strong>函数从所有图像中提取特征，并将这些特征存储在一个以文件名为关键字的字典中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="0a14" class="mr kx iq nx b gy ob oc l od oe">Wall time: 56.2 s</span></pre><h2 id="efec" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">降维(PCA)</h2><p id="ca18" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">由于我们的特征向量有4000多个维度，如果你将维度数量从4000减少到一个更小的数字，你的计算机会感谢你。我们不能简单地通过切片或使用它的子集来缩短列表，因为我们会丢失信息。如果有一种方法可以在保留尽可能多的信息的同时降低维度就好了。</p><p id="bff8" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">进入主成分分析的领域。</p><p id="3a95" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">我不打算浪费时间解释什么是PCA，因为已经有成吨的文章解释它，我将在这里链接<a class="ae kv" rel="noopener" target="_blank" href="/a-one-stop-shop-for-principal-component-analysis-5582fb7e0a9c"/>。</p><p id="a9ad" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">简单地说，如果您正在处理数据，并且有许多变量需要考虑(在我们的例子中是4096)，PCA允许您减少变量的数量，同时尽可能多地保留原始数据集中的信息。</p><p id="0b55" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">要减少的维度数量由您决定，我相信有一种方法可以找到最佳的组件数量，但在这种情况下，我只是选择100作为一个任意的数字。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="c3bd" class="mr kx iq nx b gy ob oc l od oe">print(f"Components before PCA: <strong class="nx ir">{</strong>f.shape[1]<strong class="nx ir">}</strong>")<br/>print(f"Components after PCA: <strong class="nx ir">{</strong>pca.n_components<strong class="nx ir">}</strong>")</span><span id="3a66" class="mr kx iq nx b gy of oc l od oe">Components before PCA: 4096<br/>Components after PCA: 100</span></pre><p id="289a" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">现在我们有了一个更小的特征集，我们可以对我们的图像进行聚类了。</p><h2 id="7170" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/k-means-clustering-algorithm-applications-evaluation-methods-and-drawbacks-aa03e644b48a"><strong class="ak">k均值</strong>聚类</a></h2><blockquote class="oj"><p id="97e0" class="ok ol iq bd om on oo op oq or os mj dk translated">您将定义一个目标数k，它是指数据集中所需的质心数。质心是代表群集中心的虚拟或真实位置。</p></blockquote><p id="9c7c" class="pw-post-body-paragraph lo lp iq lq b lr ot jr lt lu ou ju lw lx ov lz ma mb ow md me mf ox mh mi mj ij bi translated">该算法将允许我们将我们的特征向量分组为k个簇。每个聚类应该包含视觉上相似的图像。在这种情况下，我们知道有10种不同的花，所以k = 10。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="e436" class="mr kx iq nx b gy ob oc l od oe">kmeans.labels_</span></pre><p id="c22c" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">【6，6，8，6，6，5，4，6，5，6，4，6，3，3，5，6，6，4，4，8，1，<br/> 3，8，4，2，8，4，2，6，9，7，4，4，0，5，4，4，9，8，5，9，3，6，6，<br/> 5，1，3，9，6，5，0，1，3，9，6，7，4，4，5 5，0，5，1，2，9，5，4，8，1，<br/> 7，1，3，5，4，8，5，4，6，9，5，9，5，8，5，8，1，4，9，8，5，4，5，6，<br/> 4，1，8，9，4，6，5，7，5，6，4，8，1，4，5，5，8，6，5，2，4，8，8，<br/> 5，1，1，1，6，6，6 9，0，4，0，6，4，9，0，3，5，0，3，9，9，4，9，5，0，9，5，5，4，<br/> 5，1，8，3，6，4，5，2，6，6，9，5，0，3，3，5，4，5，0，9，4，<br/> 2，1，0，9，4，9，1，2，6，1，6，0</p><p id="b19c" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">列表中的每个标签都是数据集中每个图像的聚类标识符。标签的顺序与每个图像的文件名列表平行。这样，我们可以将图像分组到它们的簇中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="2021" class="mr kx iq nx b gy ob oc l od oe"># view the filenames in cluster 0<br/>groups[0]</span><span id="aeb2" class="mr kx iq nx b gy of oc l od oe">output: <br/>['0035.png',<br/> '0051.png',<br/> '0080.png',<br/> '0149.png',<br/> '0150.png',<br/> '0157.png',<br/> '0159.png',<br/> '0163.png',<br/> '0166.png',<br/> '0173.png',<br/> '0189.png',<br/> '0196.png',<br/> '0201.png',<br/> '0210.png']</span></pre><p id="2c57" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">我们剩下要做的就是查看一个集群，通过检查集群来了解我们的模型表现如何。</p><h2 id="490a" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">群集0</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/0142791c36faf5576f7ac7eb0d7619c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xIIBn2Yajg4naTqJif7q1w.png"/></div></div></figure><h2 id="fa34" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">群组1</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/c2a7e4802bc47f42057d27f4ce1db93a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wiGcYoDls0bInqoq8ixPqA.png"/></div></div></figure><h2 id="04d5" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">群组2</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/92c6fdfac1c793f0efa0bd73b10ae499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cHlZ4tJp91n5DODlS-oZXQ.png"/></div></div></figure><p id="74ee" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">这里我们可以看到我们的模型在花的图像聚类上做得很好。我们甚至可以看到聚类2和聚类0都有黄色的花，但是每个聚类中的花的类型是不同的。</p><h1 id="575d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="b72e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">下面是一个文件中的整个过程。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="cfee" class="pw-post-body-paragraph lo lp iq lq b lr ni jr lt lu nj ju lw lx og lz ma mb oh md me mf oi mh mi mj ij bi translated">希望你们都学到了新的东西，如果有任何问题或有顿悟时刻，请留下评论:)</p><h2 id="66a8" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">参考</h2><ul class=""><li id="ccbe" class="ng nh iq lq b lr ls lu lv lx pa mb pb mf pc mj nn no np nq bi translated"><a class="ae kv" href="https://machinelearningmastery.com/how-to-use-transfer-learning-when-developing-convolutional-neural-network-models/" rel="noopener ugc nofollow" target="_blank">用于特征提取的迁移学习</a></li><li id="4ba7" class="ng nh iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/pca-using-python-scikit-learn-e653f8989e60"> PCA </a></li></ul></div></div>    
</body>
</html>