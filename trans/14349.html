<html>
<head>
<title>Building Image Classification API with Tensorflow and FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Tensorflow和FastAPI构建影像分类API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/image-classification-api-with-tensorflow-and-fastapi-fc85dc6d39e8?source=collection_archive---------7-----------------------#2020-10-03">https://towardsdatascience.com/image-classification-api-with-tensorflow-and-fastapi-fc85dc6d39e8?source=collection_archive---------7-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5779" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从零开始学习用Tensorflow和FastAPI构建图像分类API。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9d0b62e3701e5ba05630206404884805.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zqXu5uuJJheW7DoP_RXymg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:aniketmaurya</p></figure><p id="ff34" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">FastAPI是一个高性能的异步框架，用于在Python中构建API。</p><blockquote class="lr"><p id="20d6" class="ls lt iq bd lu lv lw lx ly lz ma lq dk translated">这个博客也有视频教程</p></blockquote><figure class="mb mc md me mf kk"><div class="bz fp l di"><div class="mg mh l"/></div></figure><blockquote class="mi mj mk"><p id="fc91" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">这个博客的源代码是可用的<a class="ae mp" href="https://github.com/aniketmaurya/tensorflow-web-app-starter-pack" rel="noopener ugc nofollow" target="_blank">aniketmaurya/tensor flow-fastapi-starter-pack</a></p></blockquote><h1 id="e70c" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">让我们从一个简单的hello-world示例开始</h1><p id="16fc" class="pw-post-body-paragraph kv kw iq kx b ky ni jr la lb nj ju ld le nk lg lh li nl lk ll lm nm lo lp lq ij bi translated">首先，我们导入<code class="fe nn no np nq b">FastAPI</code>类并创建一个对象<code class="fe nn no np nq b">app</code>。这个类有有用的<a class="ae mp" href="https://github.com/tiangolo/fastapi/blob/a6897963d5ff2c836313c3b69fc6062051c07a63/fastapi/applications.py#L30" rel="noopener ugc nofollow" target="_blank">参数</a>，比如我们可以为Swagger UI传递标题和描述。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="70ef" class="nv mr iq nq b gy nw nx l ny nz">from fastapi import FastAPI<br/>app <strong class="nq ir">=</strong> FastAPI<strong class="nq ir">(</strong>title<strong class="nq ir">=</strong>'Hello world'<strong class="nq ir">)</strong></span></pre><p id="3bf2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们定义一个函数并用<code class="fe nn no np nq b">@app.get</code>来修饰它。这意味着我们的API <code class="fe nn no np nq b">/index</code>支持GET方法。这里定义的函数是异步的，FastAPI通过为普通的def函数创建一个线程池来自动处理异步和非异步方法，并为异步函数使用一个异步事件循环。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="c9ca" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>get<strong class="nq ir">(</strong>'/index'<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">hello_world():</strong><br/>    <strong class="nq ir">return</strong> "hello world"</span></pre><h1 id="61a2" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">图像识别API</h1><p id="b803" class="pw-post-body-paragraph kv kw iq kx b ky ni jr la lb nj ju ld le nk lg lh li nl lk ll lm nm lo lp lq ij bi translated">我们将创建一个API来对图像进行分类，我们将其命名为<code class="fe nn no np nq b">predict/image</code>。我们将使用Tensorflow创建图像分类模型。</p><blockquote class="mi mj mk"><p id="09dc" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">tensor flow<a class="ae mp" href="https://aniketmaurya.ml/blog/tensorflow/deep%20learning/2019/05/12/image-classification-with-tf2.html" rel="noopener ugc nofollow" target="_blank">图像分类教程</a></p></blockquote><p id="4a98" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们创建一个函数<code class="fe nn no np nq b">load_model</code>，它将返回一个带有预训练权重的MobileNet CNN模型，也就是说，它已经被训练来分类1000个独特的图像类别。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="1770" class="nv mr iq nq b gy nw nx l ny nz">import tensorflow <strong class="nq ir">as</strong> tf</span><span id="ac18" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">load_model():</strong><br/>    model <strong class="nq ir">=</strong> tf<strong class="nq ir">.</strong>keras<strong class="nq ir">.</strong>applications<strong class="nq ir">.</strong>MobileNetV2<strong class="nq ir">(</strong>weights<strong class="nq ir">=</strong>"imagenet"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">print(</strong>"Model loaded"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">return</strong> model</span><span id="98c3" class="nv mr iq nq b gy oa nx l ny nz">model <strong class="nq ir">=</strong> load_model<strong class="nq ir">()</strong></span></pre><p id="8872" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们定义了一个<code class="fe nn no np nq b">predict</code>函数，它将接受一幅图像并返回预测结果。我们将图像的大小调整为224x224，并将像素值归一化为[-1，1]。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="6198" class="nv mr iq nq b gy nw nx l ny nz">from tensorflow.keras.applications.imagenet_utils import decode_predictions</span></pre><p id="7ccf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nn no np nq b">decode_predictions</code>用于解码预测对象的类名。这里我们将返回前2个可能的类。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="215d" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">predict(</strong>image<strong class="nq ir">:</strong> Image<strong class="nq ir">.</strong>Image<strong class="nq ir">):</strong></span><span id="75ba" class="nv mr iq nq b gy oa nx l ny nz">    image <strong class="nq ir">=</strong> np<strong class="nq ir">.</strong>asarray<strong class="nq ir">(</strong>image<strong class="nq ir">.</strong>resize<strong class="nq ir">((</strong>224<strong class="nq ir">,</strong> 224<strong class="nq ir">)))[...,</strong> <strong class="nq ir">:</strong>3<strong class="nq ir">]</strong><br/>    image <strong class="nq ir">=</strong> np<strong class="nq ir">.</strong>expand_dims<strong class="nq ir">(</strong>image<strong class="nq ir">,</strong> 0<strong class="nq ir">)</strong><br/>    image <strong class="nq ir">=</strong> image <strong class="nq ir">/</strong> 127.5 <strong class="nq ir">-</strong> 1.0</span><span id="935a" class="nv mr iq nq b gy oa nx l ny nz">    result <strong class="nq ir">=</strong> decode_predictions<strong class="nq ir">(</strong>model<strong class="nq ir">.</strong>predict<strong class="nq ir">(</strong>image<strong class="nq ir">),</strong> 2<strong class="nq ir">)[</strong>0<strong class="nq ir">]</strong></span><span id="e0b4" class="nv mr iq nq b gy oa nx l ny nz">    response <strong class="nq ir">=</strong> <strong class="nq ir">[]</strong><br/>    <strong class="nq ir">for</strong> i<strong class="nq ir">,</strong> res <strong class="nq ir">in</strong> <em class="ml">enumerate</em><strong class="nq ir">(</strong>result<strong class="nq ir">):</strong><br/>        resp <strong class="nq ir">=</strong> <strong class="nq ir">{}</strong><br/>        resp<strong class="nq ir">[</strong>"class"<strong class="nq ir">]</strong> <strong class="nq ir">=</strong> res<strong class="nq ir">[</strong>1<strong class="nq ir">]</strong><br/>        resp<strong class="nq ir">[</strong>"confidence"<strong class="nq ir">]</strong> <strong class="nq ir">=</strong> f"{res[2]*100:0.2f} %"</span><span id="6ee5" class="nv mr iq nq b gy oa nx l ny nz">        response<strong class="nq ir">.</strong>append<strong class="nq ir">(</strong>resp<strong class="nq ir">)</strong></span><span id="4dcf" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> response</span></pre><p id="d00b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们将创建一个支持文件上传的API <code class="fe nn no np nq b">/predict/image</code>。我们将过滤文件扩展名，仅支持jpg、jpeg和png格式的图像。</p><p id="9b8d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用Pillow来加载上传的图像。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="42e3" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">read_imagefile(</strong><em class="ml">file</em><strong class="nq ir">)</strong> <strong class="nq ir">-&gt;</strong> Image<strong class="nq ir">.</strong>Image<strong class="nq ir">:</strong><br/>    image <strong class="nq ir">=</strong> Image<strong class="nq ir">.</strong><em class="ml">open</em><strong class="nq ir">(</strong>BytesIO<strong class="nq ir">(</strong><em class="ml">file</em><strong class="nq ir">))</strong><br/>    <strong class="nq ir">return</strong> image</span><span id="d60e" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/predict/image"<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">predict_api(</strong><em class="ml">file</em><strong class="nq ir">:</strong> UploadFile <strong class="nq ir">=</strong> File<strong class="nq ir">(...)):</strong><br/>    extension <strong class="nq ir">=</strong> <em class="ml">file</em><strong class="nq ir">.</strong>filename<strong class="nq ir">.</strong>split<strong class="nq ir">(</strong>"."<strong class="nq ir">)[-</strong>1<strong class="nq ir">]</strong> <strong class="nq ir">in</strong> <strong class="nq ir">(</strong>"jpg"<strong class="nq ir">,</strong> "jpeg"<strong class="nq ir">,</strong> "png"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">if</strong> <strong class="nq ir">not</strong> extension<strong class="nq ir">:</strong><br/>        <strong class="nq ir">return</strong> "Image must be jpg or png format!"<br/>    image <strong class="nq ir">=</strong> read_imagefile<strong class="nq ir">(await</strong> <em class="ml">file</em><strong class="nq ir">.</strong>read<strong class="nq ir">())</strong><br/>    prediction <strong class="nq ir">=</strong> predict<strong class="nq ir">(</strong>image<strong class="nq ir">)</strong></span><span id="1f26" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> prediction</span></pre><h1 id="8691" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">最终代码</h1><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="011f" class="nv mr iq nq b gy nw nx l ny nz">import uvicorn<br/>from fastapi import FastAPI<strong class="nq ir">,</strong> File<strong class="nq ir">,</strong> UploadFile</span><span id="1a13" class="nv mr iq nq b gy oa nx l ny nz">from application.components import predict<strong class="nq ir">,</strong> read_imagefile</span><span id="9eda" class="nv mr iq nq b gy oa nx l ny nz">app <strong class="nq ir">=</strong> FastAPI<strong class="nq ir">()</strong></span><span id="a15b" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/predict/image"<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">predict_api(</strong><em class="ml">file</em><strong class="nq ir">:</strong> UploadFile <strong class="nq ir">=</strong> File<strong class="nq ir">(...)):</strong><br/>    extension <strong class="nq ir">=</strong> <em class="ml">file</em><strong class="nq ir">.</strong>filename<strong class="nq ir">.</strong>split<strong class="nq ir">(</strong>"."<strong class="nq ir">)[-</strong>1<strong class="nq ir">]</strong> <strong class="nq ir">in</strong> <strong class="nq ir">(</strong>"jpg"<strong class="nq ir">,</strong> "jpeg"<strong class="nq ir">,</strong> "png"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">if</strong> <strong class="nq ir">not</strong> extension<strong class="nq ir">:</strong><br/>        <strong class="nq ir">return</strong> "Image must be jpg or png format!"<br/>    image <strong class="nq ir">=</strong> read_imagefile<strong class="nq ir">(await</strong> <em class="ml">file</em><strong class="nq ir">.</strong>read<strong class="nq ir">())</strong><br/>    prediction <strong class="nq ir">=</strong> predict<strong class="nq ir">(</strong>image<strong class="nq ir">)</strong></span><span id="8aca" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> prediction<br/></span><span id="c9a8" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/api/covid-symptom-check"<strong class="nq ir">)</strong><br/><strong class="nq ir">def</strong> <strong class="nq ir">check_risk(</strong>symptom<strong class="nq ir">:</strong> Symptom<strong class="nq ir">):</strong><br/>    <strong class="nq ir">return</strong> symptom_check<strong class="nq ir">.</strong>get_risk_level<strong class="nq ir">(</strong>symptom<strong class="nq ir">)</strong><br/></span><span id="1960" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">if</strong> __name__ <strong class="nq ir">==</strong> "__main__"<strong class="nq ir">:</strong><br/>    uvicorn<strong class="nq ir">.</strong>run<strong class="nq ir">(</strong>app<strong class="nq ir">,</strong> debug<strong class="nq ir">=</strong><em class="ml">True</em><strong class="nq ir">)</strong></span></pre><blockquote class="mi mj mk"><p id="7204" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated"><a class="ae mp" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI文档</a>是了解框架核心概念的最佳地方。</p><p id="e00d" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">希望你喜欢这篇文章。</p></blockquote><p id="f0ab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">欢迎在评论中提出你的问题，或者亲自联系我</p><p id="f2a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">👉推特:<a class="ae mp" href="https://twitter.com/aniketmaurya" rel="noopener ugc nofollow" target="_blank">https://twitter.com/aniketmaurya</a></p><p id="801b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">👉领英:【https://linkedin.com/in/aniketmaurya T2】</p></div></div>    
</body>
</html>