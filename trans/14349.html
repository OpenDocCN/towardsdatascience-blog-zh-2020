<html>
<head>
<title>Building Image Classification API with Tensorflow and FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨Tensorflowå’ŒFastAPIæ„å»ºå½±åƒåˆ†ç±»API</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/image-classification-api-with-tensorflow-and-fastapi-fc85dc6d39e8?source=collection_archive---------7-----------------------#2020-10-03">https://towardsdatascience.com/image-classification-api-with-tensorflow-and-fastapi-fc85dc6d39e8?source=collection_archive---------7-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5779" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">ä»é›¶å¼€å§‹å­¦ä¹ ç”¨Tensorflowå’ŒFastAPIæ„å»ºå›¾åƒåˆ†ç±»APIã€‚</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9d0b62e3701e5ba05630206404884805.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zqXu5uuJJheW7DoP_RXymg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">èµ„æ–™æ¥æº:aniketmaurya</p></figure><p id="ff34" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">FastAPIæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥æ¡†æ¶ï¼Œç”¨äºåœ¨Pythonä¸­æ„å»ºAPIã€‚</p><blockquote class="lr"><p id="20d6" class="ls lt iq bd lu lv lw lx ly lz ma lq dk translated">è¿™ä¸ªåšå®¢ä¹Ÿæœ‰è§†é¢‘æ•™ç¨‹</p></blockquote><figure class="mb mc md me mf kk"><div class="bz fp l di"><div class="mg mh l"/></div></figure><blockquote class="mi mj mk"><p id="fc91" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">è¿™ä¸ªåšå®¢çš„æºä»£ç æ˜¯å¯ç”¨çš„<a class="ae mp" href="https://github.com/aniketmaurya/tensorflow-web-app-starter-pack" rel="noopener ugc nofollow" target="_blank">aniketmaurya/tensor flow-fastapi-starter-pack</a></p></blockquote><h1 id="e70c" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„hello-worldç¤ºä¾‹å¼€å§‹</h1><p id="16fc" class="pw-post-body-paragraph kv kw iq kx b ky ni jr la lb nj ju ld le nk lg lh li nl lk ll lm nm lo lp lq ij bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬å¯¼å…¥<code class="fe nn no np nq b">FastAPI</code>ç±»å¹¶åˆ›å»ºä¸€ä¸ªå¯¹è±¡<code class="fe nn no np nq b">app</code>ã€‚è¿™ä¸ªç±»æœ‰æœ‰ç”¨çš„<a class="ae mp" href="https://github.com/tiangolo/fastapi/blob/a6897963d5ff2c836313c3b69fc6062051c07a63/fastapi/applications.py#L30" rel="noopener ugc nofollow" target="_blank">å‚æ•°</a>ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä¸ºSwagger UIä¼ é€’æ ‡é¢˜å’Œæè¿°ã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="70ef" class="nv mr iq nq b gy nw nx l ny nz">from fastapi import FastAPI<br/>app <strong class="nq ir">=</strong> FastAPI<strong class="nq ir">(</strong>title<strong class="nq ir">=</strong>'Hello world'<strong class="nq ir">)</strong></span></pre><p id="3bf2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°å¹¶ç”¨<code class="fe nn no np nq b">@app.get</code>æ¥ä¿®é¥°å®ƒã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„API <code class="fe nn no np nq b">/index</code>æ”¯æŒGETæ–¹æ³•ã€‚è¿™é‡Œå®šä¹‰çš„å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼ŒFastAPIé€šè¿‡ä¸ºæ™®é€šçš„defå‡½æ•°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± æ¥è‡ªåŠ¨å¤„ç†å¼‚æ­¥å’Œéå¼‚æ­¥æ–¹æ³•ï¼Œå¹¶ä¸ºå¼‚æ­¥å‡½æ•°ä½¿ç”¨ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶å¾ªç¯ã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="c9ca" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>get<strong class="nq ir">(</strong>'/index'<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">hello_world():</strong><br/>    <strong class="nq ir">return</strong> "hello world"</span></pre><h1 id="61a2" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">å›¾åƒè¯†åˆ«API</h1><p id="b803" class="pw-post-body-paragraph kv kw iq kx b ky ni jr la lb nj ju ld le nk lg lh li nl lk ll lm nm lo lp lq ij bi translated">æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªAPIæ¥å¯¹å›¾åƒè¿›è¡Œåˆ†ç±»ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º<code class="fe nn no np nq b">predict/image</code>ã€‚æˆ‘ä»¬å°†ä½¿ç”¨Tensorflowåˆ›å»ºå›¾åƒåˆ†ç±»æ¨¡å‹ã€‚</p><blockquote class="mi mj mk"><p id="09dc" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">tensor flow<a class="ae mp" href="https://aniketmaurya.ml/blog/tensorflow/deep%20learning/2019/05/12/image-classification-with-tf2.html" rel="noopener ugc nofollow" target="_blank">å›¾åƒåˆ†ç±»æ•™ç¨‹</a></p></blockquote><p id="4a98" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡½æ•°<code class="fe nn no np nq b">load_model</code>ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªå¸¦æœ‰é¢„è®­ç»ƒæƒé‡çš„MobileNet CNNæ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå·²ç»è¢«è®­ç»ƒæ¥åˆ†ç±»1000ä¸ªç‹¬ç‰¹çš„å›¾åƒç±»åˆ«ã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="1770" class="nv mr iq nq b gy nw nx l ny nz">import tensorflow <strong class="nq ir">as</strong> tf</span><span id="ac18" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">load_model():</strong><br/>    model <strong class="nq ir">=</strong> tf<strong class="nq ir">.</strong>keras<strong class="nq ir">.</strong>applications<strong class="nq ir">.</strong>MobileNetV2<strong class="nq ir">(</strong>weights<strong class="nq ir">=</strong>"imagenet"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">print(</strong>"Model loaded"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">return</strong> model</span><span id="98c3" class="nv mr iq nq b gy oa nx l ny nz">model <strong class="nq ir">=</strong> load_model<strong class="nq ir">()</strong></span></pre><p id="8872" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code class="fe nn no np nq b">predict</code>å‡½æ•°ï¼Œå®ƒå°†æ¥å—ä¸€å¹…å›¾åƒå¹¶è¿”å›é¢„æµ‹ç»“æœã€‚æˆ‘ä»¬å°†å›¾åƒçš„å¤§å°è°ƒæ•´ä¸º224x224ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–ä¸º[-1ï¼Œ1]ã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="6198" class="nv mr iq nq b gy nw nx l ny nz">from tensorflow.keras.applications.imagenet_utils import decode_predictions</span></pre><p id="7ccf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nn no np nq b">decode_predictions</code>ç”¨äºè§£ç é¢„æµ‹å¯¹è±¡çš„ç±»åã€‚è¿™é‡Œæˆ‘ä»¬å°†è¿”å›å‰2ä¸ªå¯èƒ½çš„ç±»ã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="215d" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">predict(</strong>image<strong class="nq ir">:</strong> Image<strong class="nq ir">.</strong>Image<strong class="nq ir">):</strong></span><span id="75ba" class="nv mr iq nq b gy oa nx l ny nz">    image <strong class="nq ir">=</strong> np<strong class="nq ir">.</strong>asarray<strong class="nq ir">(</strong>image<strong class="nq ir">.</strong>resize<strong class="nq ir">((</strong>224<strong class="nq ir">,</strong> 224<strong class="nq ir">)))[...,</strong> <strong class="nq ir">:</strong>3<strong class="nq ir">]</strong><br/>    image <strong class="nq ir">=</strong> np<strong class="nq ir">.</strong>expand_dims<strong class="nq ir">(</strong>image<strong class="nq ir">,</strong> 0<strong class="nq ir">)</strong><br/>    image <strong class="nq ir">=</strong> image <strong class="nq ir">/</strong> 127.5 <strong class="nq ir">-</strong> 1.0</span><span id="935a" class="nv mr iq nq b gy oa nx l ny nz">    result <strong class="nq ir">=</strong> decode_predictions<strong class="nq ir">(</strong>model<strong class="nq ir">.</strong>predict<strong class="nq ir">(</strong>image<strong class="nq ir">),</strong> 2<strong class="nq ir">)[</strong>0<strong class="nq ir">]</strong></span><span id="e0b4" class="nv mr iq nq b gy oa nx l ny nz">    response <strong class="nq ir">=</strong> <strong class="nq ir">[]</strong><br/>    <strong class="nq ir">for</strong> i<strong class="nq ir">,</strong> res <strong class="nq ir">in</strong> <em class="ml">enumerate</em><strong class="nq ir">(</strong>result<strong class="nq ir">):</strong><br/>        resp <strong class="nq ir">=</strong> <strong class="nq ir">{}</strong><br/>        resp<strong class="nq ir">[</strong>"class"<strong class="nq ir">]</strong> <strong class="nq ir">=</strong> res<strong class="nq ir">[</strong>1<strong class="nq ir">]</strong><br/>        resp<strong class="nq ir">[</strong>"confidence"<strong class="nq ir">]</strong> <strong class="nq ir">=</strong> f"{res[2]*100:0.2f} %"</span><span id="6ee5" class="nv mr iq nq b gy oa nx l ny nz">        response<strong class="nq ir">.</strong>append<strong class="nq ir">(</strong>resp<strong class="nq ir">)</strong></span><span id="4dcf" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> response</span></pre><p id="d00b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ç°åœ¨æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„API <code class="fe nn no np nq b">/predict/image</code>ã€‚æˆ‘ä»¬å°†è¿‡æ»¤æ–‡ä»¶æ‰©å±•åï¼Œä»…æ”¯æŒjpgã€jpegå’Œpngæ ¼å¼çš„å›¾åƒã€‚</p><p id="9b8d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">æˆ‘ä»¬å°†ä½¿ç”¨Pillowæ¥åŠ è½½ä¸Šä¼ çš„å›¾åƒã€‚</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="42e3" class="nv mr iq nq b gy nw nx l ny nz"><strong class="nq ir">def</strong> <strong class="nq ir">read_imagefile(</strong><em class="ml">file</em><strong class="nq ir">)</strong> <strong class="nq ir">-&gt;</strong> Image<strong class="nq ir">.</strong>Image<strong class="nq ir">:</strong><br/>    image <strong class="nq ir">=</strong> Image<strong class="nq ir">.</strong><em class="ml">open</em><strong class="nq ir">(</strong>BytesIO<strong class="nq ir">(</strong><em class="ml">file</em><strong class="nq ir">))</strong><br/>    <strong class="nq ir">return</strong> image</span><span id="d60e" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/predict/image"<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">predict_api(</strong><em class="ml">file</em><strong class="nq ir">:</strong> UploadFile <strong class="nq ir">=</strong> File<strong class="nq ir">(...)):</strong><br/>    extension <strong class="nq ir">=</strong> <em class="ml">file</em><strong class="nq ir">.</strong>filename<strong class="nq ir">.</strong>split<strong class="nq ir">(</strong>"."<strong class="nq ir">)[-</strong>1<strong class="nq ir">]</strong> <strong class="nq ir">in</strong> <strong class="nq ir">(</strong>"jpg"<strong class="nq ir">,</strong> "jpeg"<strong class="nq ir">,</strong> "png"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">if</strong> <strong class="nq ir">not</strong> extension<strong class="nq ir">:</strong><br/>        <strong class="nq ir">return</strong> "Image must be jpg or png format!"<br/>    image <strong class="nq ir">=</strong> read_imagefile<strong class="nq ir">(await</strong> <em class="ml">file</em><strong class="nq ir">.</strong>read<strong class="nq ir">())</strong><br/>    prediction <strong class="nq ir">=</strong> predict<strong class="nq ir">(</strong>image<strong class="nq ir">)</strong></span><span id="1f26" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> prediction</span></pre><h1 id="8691" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">æœ€ç»ˆä»£ç </h1><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="011f" class="nv mr iq nq b gy nw nx l ny nz">import uvicorn<br/>from fastapi import FastAPI<strong class="nq ir">,</strong> File<strong class="nq ir">,</strong> UploadFile</span><span id="1a13" class="nv mr iq nq b gy oa nx l ny nz">from application.components import predict<strong class="nq ir">,</strong> read_imagefile</span><span id="9eda" class="nv mr iq nq b gy oa nx l ny nz">app <strong class="nq ir">=</strong> FastAPI<strong class="nq ir">()</strong></span><span id="a15b" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/predict/image"<strong class="nq ir">)</strong><br/><strong class="nq ir">async</strong> <strong class="nq ir">def</strong> <strong class="nq ir">predict_api(</strong><em class="ml">file</em><strong class="nq ir">:</strong> UploadFile <strong class="nq ir">=</strong> File<strong class="nq ir">(...)):</strong><br/>    extension <strong class="nq ir">=</strong> <em class="ml">file</em><strong class="nq ir">.</strong>filename<strong class="nq ir">.</strong>split<strong class="nq ir">(</strong>"."<strong class="nq ir">)[-</strong>1<strong class="nq ir">]</strong> <strong class="nq ir">in</strong> <strong class="nq ir">(</strong>"jpg"<strong class="nq ir">,</strong> "jpeg"<strong class="nq ir">,</strong> "png"<strong class="nq ir">)</strong><br/>    <strong class="nq ir">if</strong> <strong class="nq ir">not</strong> extension<strong class="nq ir">:</strong><br/>        <strong class="nq ir">return</strong> "Image must be jpg or png format!"<br/>    image <strong class="nq ir">=</strong> read_imagefile<strong class="nq ir">(await</strong> <em class="ml">file</em><strong class="nq ir">.</strong>read<strong class="nq ir">())</strong><br/>    prediction <strong class="nq ir">=</strong> predict<strong class="nq ir">(</strong>image<strong class="nq ir">)</strong></span><span id="8aca" class="nv mr iq nq b gy oa nx l ny nz">    <strong class="nq ir">return</strong> prediction<br/></span><span id="c9a8" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">@</strong>app<strong class="nq ir">.</strong>post<strong class="nq ir">(</strong>"/api/covid-symptom-check"<strong class="nq ir">)</strong><br/><strong class="nq ir">def</strong> <strong class="nq ir">check_risk(</strong>symptom<strong class="nq ir">:</strong> Symptom<strong class="nq ir">):</strong><br/>    <strong class="nq ir">return</strong> symptom_check<strong class="nq ir">.</strong>get_risk_level<strong class="nq ir">(</strong>symptom<strong class="nq ir">)</strong><br/></span><span id="1960" class="nv mr iq nq b gy oa nx l ny nz"><strong class="nq ir">if</strong> __name__ <strong class="nq ir">==</strong> "__main__"<strong class="nq ir">:</strong><br/>    uvicorn<strong class="nq ir">.</strong>run<strong class="nq ir">(</strong>app<strong class="nq ir">,</strong> debug<strong class="nq ir">=</strong><em class="ml">True</em><strong class="nq ir">)</strong></span></pre><blockquote class="mi mj mk"><p id="7204" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated"><a class="ae mp" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPIæ–‡æ¡£</a>æ˜¯äº†è§£æ¡†æ¶æ ¸å¿ƒæ¦‚å¿µçš„æœ€ä½³åœ°æ–¹ã€‚</p><p id="e00d" class="kv kw ml kx b ky kz jr la lb lc ju ld mm lf lg lh mn lj lk ll mo ln lo lp lq ij bi translated">å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ã€‚</p></blockquote><p id="f0ab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">æ¬¢è¿åœ¨è¯„è®ºä¸­æå‡ºä½ çš„é—®é¢˜ï¼Œæˆ–è€…äº²è‡ªè”ç³»æˆ‘</p><p id="f2a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ğŸ‘‰æ¨ç‰¹:<a class="ae mp" href="https://twitter.com/aniketmaurya" rel="noopener ugc nofollow" target="_blank">https://twitter.com/aniketmaurya</a></p><p id="801b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ğŸ‘‰é¢†è‹±:ã€https://linkedin.com/in/aniketmaurya T2ã€‘</p></div></div>    
</body>
</html>