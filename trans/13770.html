<html>
<head>
<title>Ditching the AWS GUI Console</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">抛弃AWS GUI控制台</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ditching-the-aws-gui-console-ac77f46a05fa?source=collection_archive---------60-----------------------#2020-09-21">https://towardsdatascience.com/ditching-the-aws-gui-console-ac77f46a05fa?source=collection_archive---------60-----------------------#2020-09-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3650" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过AWS CloudFormation将无服务器基础设施作为代码</h2></div><h2 id="feac" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><a class="ae le" href="https://github.com/boscacci/isTheBryantParkLawnOpen.com" rel="noopener ugc nofollow" target="_blank"> GitHub回购/源代码在此！</a></h2><h1 id="1fd9" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi">2020–09–10</h1><h2 id="2134" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">背景故事:</h2><p id="753d" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">当我在时代广场的一家数据分析公司工作时，我经常在美丽的布莱恩特公园草坪上享用午餐。我可以查看https://bryantpark.org/的草坪目前是否开放，但是org页面加载有点慢；里面全是我不在乎的图像。</p><p id="5ab6" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">因为这个原因(以及学习AWS的愿望)，我从一个ec2盒子上创建了一个愚蠢的<a class="ae le" href="https://www.wikiwand.com/en/Single-serving_site" rel="noopener ugc nofollow" target="_blank">单一服务网站</a>，它只显示草坪是否开放。<strong class="ls iu">你会去</strong> <a class="ae le" href="http://isthebryantparklawnopen.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ls iu">是布莱恩特公园的草坪开点com </strong> </a> <strong class="ls iu">然后看这个:</strong></p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/44f355d9a3cc3230292eda5689054379.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hGpxari8uQ7N1j9T3lR-WQ.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">受<a class="ae le" href="http://hasthelargehadroncolliderdestroyedtheworldyet.com/" rel="noopener ugc nofollow" target="_blank">http://hasthelargehadroncolliderdestroyedtheworldyet.com/</a>的启发</p></figure><p id="72bc" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">在科维德·疫情的萎靡不振中，我的<a class="ae le" href="http://isthebryantparklawnopen.com/" rel="noopener ugc nofollow" target="_blank">简陋的网站</a>已经失修，这提供了进行一些翻新的机会。上一次我做这个的时候，我非常依赖于在AWS GUI控制台方法<strong class="ls iu">、</strong>中的<strong class="ls iu">点击——这是我想要摆脱的行为。</strong></p><h2 id="a1d4" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">目标:</h2><p id="969d" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">今天，我将着手<strong class="ls iu">重新设计</strong>这种(异想天开，可以说是“愚蠢”或“没人要求的”)服务，将其作为基于AWS的<strong class="ls iu">无服务器基础设施</strong>——利用SAM CLI，使用<strong class="ls iu"> CloudFormation </strong>进行配置，并依靠各种其他代码和基础工具。我想在不接触GUI AWS控制台的情况下做到这一点:<strong class="ls iu"> CLI和脚本</strong>全程！</p><h2 id="428b" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">架构流程图:</h2><p id="0dcc" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">这里有一个我认为我会需要的服务的小地图:它都围绕着一个小数据库，一个<a class="ae le" href="http://isthebryantparklawnopen.com/" rel="noopener ugc nofollow" target="_blank"> s3 bucket网站</a>，和一些AWS Lambda函数。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ne"><img src="../Images/36276addf0316743da3900013bdabe9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rUfj3VXtkp22V7kgugwDAw.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">在我看来。以普莱狄卡为蓝本</p></figure><h1 id="dd5d" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">如何使用每项服务:</h1><h2 id="3c14" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">云的形成:</h2><ul class=""><li id="ca5c" class="nf ng it ls b lt lu lw lx kr nh kv ni kz nj mi nk nl nm nn bi translated">从<strong class="ls iu"> YAML模板</strong>中一次性提供以下所有服务</li><li id="73b0" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">在版本控制中被跟踪；be <strong class="ls iu">基础设施符合规范</strong></li><li id="0997" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">学习良好的DevOps实践(这个男孩在找新工作)</li></ul><h2 id="c167" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">RDS数据库:</h2><ul class=""><li id="a80f" class="nf ng it ls b lt lu lw lx kr nh kv ni kz nj mi nk nl nm nn bi translated">仓库我们的开放/封闭二进制草坪数据，加上最少的元数据</li><li id="b693" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">位于私有子网中，只有Lambda函数可以访问，从而不受公众影响</li><li id="beaa" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">拥有大约35，040个数据点后，丢弃旧行。(任意…2年)</li></ul><h2 id="7bbc" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">S3水桶:</h2><p id="463c" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">桶是对象存储容器。他们可以存储文件，也可以服务静态网站。我需要水桶来做以下事情:</p><ul class=""><li id="6bfe" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">主持人一个<a class="ae le" href="http://isthebryantparklawnopen.com/" rel="noopener ugc nofollow" target="_blank">愚蠢简单<strong class="ls iu">静态网站</strong>用HTML/CSS/ES6做成的</a></li><li id="d1b1" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">Lambda函数的仓库代码包</li></ul><h2 id="a817" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">路线53:</h2><ul class=""><li id="7bde" class="nf ng it ls b lt lu lw lx kr nh kv ni kz nj mi nk nl nm nn bi translated">至少给我们愚蠢的网站一个自定义域名</li></ul><h2 id="5474" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">EventBridge(前身为CloudWatch):</h2><ul class=""><li id="d75c" class="nf ng it ls b lt lu lw lx kr nh kv ni kz nj mi nk nl nm nn bi translated">在<a class="ae le" href="https://en.wikipedia.org/wiki/Cron" rel="noopener ugc nofollow" target="_blank"> cron时间表</a>上触发Lambda函数</li></ul><h2 id="1861" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">λ函数(I)至(V):</h2><p id="3d1c" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">为了完成一些计算，无服务器功能即服务绕过了调试云服务器的成本开销。你可以让AWS管理服务器基础设施，并且只在你的代码实际运行时计费，由一些<em class="nw">事件</em>或<em class="nw">时间表</em>触发。以下是我需要的函数:</p><p id="c566" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated"><strong class="ls iu"> I)刮刀:</strong></p><ul class=""><li id="7f20" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">每半个小时，旋转一个无头浏览器，从Bryant park . org网站上获取一个原始的草坪状态字符串(和F数据，为什么不呢)</li><li id="f6cd" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">将收集的原始数据传递给后续的解析器函数</li></ul><p id="28fe" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated"><strong class="ls iu"> II)解析器:</strong></p><ul class=""><li id="2fae" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">接受来自刮刀功能的原始数据</li><li id="3c44" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">将原始草坪状态字符串解析为二进制变量</li><li id="f5b9" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">生成其他有趣的元数据，如星期几和小时</li><li id="5d99" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">将解析后的数据传递给RDS编写器</li></ul><p id="c59e" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated"><strong class="ls iu"> III) RDS编写器:</strong></p><ul class=""><li id="a34e" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">从解析器函数接受干净的解析数据。</li><li id="b402" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">将新行写入RDS数据库</li></ul><p id="3223" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated"><strong class="ls iu"> IV)基本状态更新器:</strong></p><ul class=""><li id="dde7" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">每半小时，读取RDS数据库的最后几行</li><li id="aca7" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">如果草坪状态已经改变(这种情况将避免不必要的频繁S3推杆)，然后更新S3水桶网站的索引页面</li></ul><p id="2419" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated"><strong class="ls iu"> V) Viz生成器:</strong></p><ul class=""><li id="3c90" class="nf ng it ls b lt mj lw mk kr nt kv nu kz nv mi nk nl nm nn bi translated">每天两次，将整个表加载到内存中，并运行一些聚合</li><li id="561f" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">用聚合数据生成Plotly HTML可视化</li><li id="a0e7" class="nf ng it ls b lt no lw np kr nq kv nr kz ns mi nk nl nm nn bi translated">将这些图表推送到简单的S3网站的“统计”页面</li></ul><h1 id="8a31" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">通过云信息配置VPC/数据库</h1><p id="849c" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">是时候开始构建我们的云形成堆栈了。yml！这是我们通过CloudFormation CLI提交的文档，以完美协调的方式一次提供我们需要的所有资源。我一直在研究AWS上的<a class="ae le" href="https://docs.aws.amazon.com/cloudformation/index.html" rel="noopener ugc nofollow" target="_blank">云信息文档</a>，想弄清楚这应该是什么样子:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nx"><img src="../Images/431ee19e0d77c8863bfc481bd4e45599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YaGAO-S_ui9IGomY9kIaYA.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">节选自我的第一个云形成模板</p></figure><pre class="mp mq mr ms gt ny nz oa ob aw oc bi"><span id="5fc3" class="ki kj it nz b gy od oe l of og"># Excerpts from the .yml, provisioning more resources...</span><span id="a5b3" class="ki kj it nz b gy oh oe l of og">lawnDBsubnetGroup: # RDS DB needs a subnet group. This is it<br/>    Type: AWS::RDS::DBSubnetGroup<br/>    Properties: <br/>      DBSubnetGroupDescription: The two private subnets<br/>      DBSubnetGroupName: lawn-DB-subnet-Group<br/>      SubnetIds: <br/>        - !Ref lawnSubnetPrivateA<br/>        - !Ref lawnSubnetPrivateB</span></pre><p id="6264" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">我今天还没有机会测试和调试，但我已经开始为这个应用程序声明我的云基础设施(网络配置，安全规则，数据库实例)。建立我的网络的一个至关重要的资源是这个<a class="ae le" href="https://medium.com/@justanotherspyy/how-to-connect-your-lambda-function-securely-to-your-private-rds-instances-in-your-vpc-29789220a33" rel="noopener">关于</a>保持你的RDS实例私有，同时仍然给Lambda RDS访问，不牺牲Lambda的网络访问。</p><p id="39fc" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">这其中的难点(私有子网RDS +带web访问的Lambdas)是<a class="ae le" href="https://github.com/boscacci/isTheBryantParkLawnOpen.com/blob/master/src/CF_templates/2_lawnNATinstance.yml" rel="noopener ugc nofollow" target="_blank">建立一个廉价的NAT实例(通过ec2 AMI的硬手动方式)</a>而不是简单地在CloudFormation 中提供一个昂贵的<a class="ae le" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-natgateway.html" rel="noopener ugc nofollow" target="_blank">预烤NAT网关。过去，走捷径让我付出了代价，以美元计。</a></p><h1 id="7b2f" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">2020年9月11日:部署试验和错误</h1><p id="1d5a" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">我在反复构建这个云层结构。yml模板(目前)只有一个新的VPC、一些子网、安全组/子网组和一个RDS DB——还没有Lambda函数或S3桶站点。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oi"><img src="../Images/6b900709180e41e10badf96468267160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kM_EXUUZ5RdDJBqllyYwFw.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">在自动气象站云形成设计器中绘制</p></figure><p id="af44" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">部署此堆栈的初始尝试。yml会导致错误，因为我不可能第一次就做对:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oj"><img src="../Images/bbb399fa7f60a5ec37ac203d88afb274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-tgZjtjz5HecqDyszPmfKw.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">通过查看控制台以GUI方式检查错误，这有点作弊</p></figure><p id="2589" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">好了，我们得到了一些合理的错误，例如，对于“lawnDB”资源(我的RDS数据库)，它没有启动，因为我得到了<code class="fe ok ol om nz b">Value of property VPCSecurityGroups must be of type <strong class="ls iu">List of</strong> String</code>。最初，我只给了它一个字符串，而不是字符串列表，这是我的错误。我将递归地纠正这些错误，并继续尝试验证/部署。我现在也很好奇CloudFormation中的<code class="fe ok ol om nz b">!ref</code>功能…</p><p id="4a14" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">原来，<a class="ae le" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html" rel="noopener ugc nofollow" target="_blank"><strong class="ls iu"/></a><code class="fe ok ol om nz b"><a class="ae le" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html" rel="noopener ugc nofollow" target="_blank"><strong class="ls iu">!ref</strong></a></code><a class="ae le" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html" rel="noopener ugc nofollow" target="_blank"><strong class="ls iu">函数</strong> </a> <strong class="ls iu">是云生成<strong class="ls iu">中必不可少的</strong>。</strong>例如，如果您提供一个VPC和一个子网进入其中，子网可能需要<code class="fe ok ol om nz b">!Ref</code>VPC的逻辑名称(您在YAML中为其指定的名称)才能属于该VPC。我的意思是:</p><pre class="mp mq mr ms gt ny nz oa ob aw oc bi"><span id="79e7" class="ki kj it nz b gy od oe l of og"># Inside the CF stack .yml:<br/># See bolded text for relevant bits</span><span id="1c7e" class="ki kj it nz b gy oh oe l of og">Resources:<br/>  <strong class="nz iu">lawnVPC</strong>: # The whole big sandbox. Contains all infra for this app<br/>    Type: AWS::EC2::VPC<br/>    Properties:<br/>      CidrBlock: 10.0.0.0/16<br/>      Tags:<br/>      - Key: Name<br/>        Value: !Join ['', [!Ref "AWS::StackName", "-VPC" ]]</span><span id="83b3" class="ki kj it nz b gy oh oe l of og">  lawnSubnetPublicA: # 1 of 2 public subnets<br/>    Type: AWS::EC2::Subnet<br/>    Properties: <br/>      AvailabilityZone: us-east-1b<br/>      CidrBlock: 10.0.0.0/24<br/><strong class="nz iu">      VpcId: !Ref lawnVPC</strong><br/>      Tags:<br/>        - Key: Name<br/>          Value: lawn-Subnet-Public-A</span></pre><p id="8bcb" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">在掌握了CloudFormation模板之后，看起来我已经有了一个基础设施的雏形，只是一些网络组织垃圾和一个数据库:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi on"><img src="../Images/e14deade0980c0f3c370eb9e23ae80c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6E5cARpTeGcsc-jKAXyXpQ.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">绿色的刻度让我的心在歌唱</p></figure><p id="b220" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">这个。yml已经变得很长了！有没有办法让我把它分开？<a class="ae le" href="https://dev.to/thomasstep/cloudformation-exports-and-imports-1l1p" rel="noopener ugc nofollow" target="_blank">显然，是的</a>。我们可以在带有<strong class="ls iu">输出的栈</strong>之间嵌套CF栈或<strong class="ls iu">输入/输出值。</strong>我会的:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oo"><img src="../Images/0f458f98586fe51967078fc54fda9a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PK_EZzRCMMSs-BWHRl3QTw.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">检查堆栈输出。其他堆栈现在可以引用这些值。</p></figure><p id="dd4e" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">模块化CloudFormation模板感觉很好，就像我们将不祥的大Python模块分成几个一样。</p><p id="ea58" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">接下来，我将尝试组装上面提到的Lambda函数。这是我第一次尝试通过SAM CLI(和docker)在本地调试Lambda函数的地方！</p><h1 id="68af" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">2020年9月16日:λ和云的形成</h1><p id="cae2" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">Lambda到底如何适应这种云计算基础设施即代码模型？我将把它们放入它们自己的“堆栈”中，并给它们分配IAM角色，允许它们做像写RDS和相互调用这样的事情。回想起来，嵌套堆栈可能是一种更好的方法，因为现在我在这个CloudFormation区域中混淆了导出的变量名称空间。</p><h2 id="2d23" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">功能一:刮刀</h2><p id="36c4" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">我发现了一个方便的<a class="ae le" href="https://github.com/ChristopherDedominici/AWSlambda-python-scraper-generator" rel="noopener ugc nofollow" target="_blank"> repo，它生成一个lambda函数，可以用一个无头的selenium浏览器</a>抓取网页。谢谢克里斯托弗。现在将它应用到我自己的scraper函数中，收集关于公园草坪的信息:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi op"><img src="../Images/e41d331c055250569494f20e6b6d47d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_SRW5xX2dV9OPwNxUWrAlg.png"/></div></div></figure><p id="3a9d" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">使用AWS 的<a class="ae le" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> SAM(无服务器应用程序模型)CLI，我能够快速重用和调试这段代码，从。org网站。是我的新果酱。</a></p><h2 id="947c" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">功能二:解析器</h2><p id="05f1" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">这是将从。org网站转换成二进制变量。我有一种感觉，这是我的“应用程序”中最不耐用的部分，因为我不知道这个粗糙的文本字段可能存在的值的范围。目前我只看到“草坪开放”和“草坪关闭”当新的可能值出现时，我会不断更新这个函数。好的方面是它有自己的lambda函数，有自己的日志和故障率。也许我以后会用AWS SNS设置短信故障通知。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/7d750b7ccd0404558720a1a1641012a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*nF6WdTPjYJsVDr8o6rmWKQ.png"/></div><p class="na nb gj gh gi nc nd bd b be z dk translated">一个单独的lambda函数来解析原始字符串</p></figure><p id="1090" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">顺便说一下，所有的原始<a class="ae le" href="https://github.com/boscacci/isTheBryantParkLawnOpen.com" rel="noopener ugc nofollow" target="_blank">代码都在GitHub </a>上公开，如果你之前没有注意到的话！</p><h2 id="0f59" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">功能三:RDS写入器</strong></h2><p id="b3e8" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">最终，我决定让RDS writer函数按计划运行，并通过boto3同步调用子函数I (scraper)和II (parser ):</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi or"><img src="../Images/b0bdcce09e78da7036a43fd105481783.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7AJdKFKqi_ERRkYmdYSsPg.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">在lambda函数中调用lambda函数</p></figure><p id="2890" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">这个lambda函数有<strong class="ls iu">权限</strong>来调用其他Lambda函数，并修改我们在CloudFormation模板中提供的RDS数据库。它最终负责获取新数据并将其写入数据库。我在某处读到过，确保父Lambda函数在其子函数完成工作之前不会超时是个好主意。</p><h2 id="1491" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">功能四:站点更新器</strong></h2><p id="9470" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">这个函数从数据库中读取数据，从两个可能的HTML文档中选择一个(基于二进制的“打开”或“关闭”状态),并将该文档推送到为我们的站点提供服务的s3存储桶:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi os"><img src="../Images/1e845b1c4c07e5f544f069b26c64fb0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*tUT6tPq8ppcuRbij8CGKQA.png"/></div></figure><h1 id="0278" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">2020年9月21日:网站备份</h1><p id="8989" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">现在，我们正在抓取数据，将数据存储到数据库中，并引用该数据库向静态的S3网站编写HTML我们拥有了一个活生生的web服务！</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ot"><img src="../Images/e062becb6f82b221c7924ab4dc435ed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gcCzwDKOlxQ4tPOSF9VM6w.png"/></div></div></figure><p id="338e" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">一个朋友让我注意到了TerraForm，因为我一直陷在AWS粉丝的泡泡里，所以我不知道它的存在。对于任何对“基础设施即代码”感兴趣的人来说，TerraForm似乎是下一个自然要学的东西(例如，在AWS CloudFormation或Google Cloud Deployment Manager之后)。</p><h2 id="d683" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">功能五:图形统计生成器</strong></h2><p id="ec81" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">这个想法是建立一个小Plotly仪表板页面，显示按星期几和一天中的小时数汇总的草坪开放历史数据。</p><p id="6b08" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">在我可以构建一个汇总统计页面之前，我会让我的lambda函数将大约一周的数据刮到RDS数据库中，同时我会申请工作、烹饪千层面和各种丰盛的汤，并玩《野性的呼吸》。</p><p id="6f0c" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">我将在2020年9月28日左右回到这个话题。</p><h1 id="87b9" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">2020年9月28日:统计页面</h1><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ot"><img src="../Images/18b125441eb4ecdd0bdcf6de6fc535fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_3TcwnxvdjbVtX4u6aq2EA.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">现在起来了！</p></figure><p id="4d89" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">简单的统计页面正在工作！目前，这只是一张根据我的2x/小时采样显示布莱恩特公园草坪在一天和一周不同时间的历史平均开放度的热图。</p><p id="19b3" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">为了添加这个页面，首先我编写了一个lambda函数，将我的RDS SQL DB/table完整地导出到S3桶中的一个. csv文件中，这样我就可以下载它，并在Jupyter笔记本中对它进行试验。有时尽可能多地在本地调试真的很有帮助，因此在这个小项目中尝试SAM。</p><p id="877d" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">然后，我修改了Jupyter生成的工作viz生成器代码，使其返回到<a class="ae le" href="https://github.com/boscacci/isTheBryantParkLawnOpen.com/blob/master/src/lambda_funcs/4_viz_gen/lawn_viz_gen/app.py" rel="noopener ugc nofollow" target="_blank"> Lambda函数(V)中，该函数每12小时更新一次新的“stats”页面</a>。</p><p id="f465" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">让我困扰的是再加一个。我的s3存储桶站点的HTML页面没有自动使该页面在浏览器中“可加载”。当我在调试时，我的浏览器一直试图下载。HTML文档到我的本地驱动器，而不只是呈现它。烦人！</p><p id="6c4e" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">起初，我认为这是因为S3网站不支持服务器端脚本，也许我不小心包含了一些服务器负责的代码..？但是没有。网络搜索让我意识到，我只需要确保在上传(put)时包含s3对象的“内容类型”,以便它能被正确地服务:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/b8c04665203ae73a536478613b18dbd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*j8mZL-nk4SLHY5ZmnoVX8w.png"/></div><p class="na nb gj gh gi nc nd bd b be z dk translated">包括boto3 AWS Python API中的ContentType标记，用于网页渲染</p></figure><h1 id="e929" class="lf kj it bd kk lg lh li kn lj lk ll kq jz lm ka ku kc ln kd ky kf lo kg lc lp bi translated">结论</h1><p id="b908" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly kr lz ma mb kv mc md me kz mf mg mh mi im bi translated">有了这些，我觉得我已经准备好去做一个不那么俗气的项目了！在未来，我想研究一下:嵌套的CloudFormation堆栈，远离HTML/CSS/ES6 (TypeScript？节点？反应？)，并在我未来的更多项目中利用一些机器学习(回归/分类)，这是我已经非常熟悉的东西。我也很好奇卡夫卡/SQS、DynamoDB，以及管理用户凭证和会话；在写这本书的时候，我对这些东西知之甚少。</p><p id="5b97" class="pw-post-body-paragraph lq lr it ls b lt mj ju lv lw mk jx ly kr ml ma mb kv mm md me kz mn mg mh mi im bi translated">我最兴奋的是有机会解决一些现实世界的问题！如果你认为我可以开发一些软件，让你的生活(重复的、烦人的部分)变得更容易，或者如果你自己正在构建一些东西(开发团队？)你认为我能帮上忙。</p></div></div>    
</body>
</html>