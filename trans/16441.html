<html>
<head>
<title>Building Custom Layers on AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS Lambda上构建自定义层</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-custom-layers-on-aws-lambda-35d17bd9abbb?source=collection_archive---------3-----------------------#2020-11-13">https://towardsdatascience.com/building-custom-layers-on-aws-lambda-35d17bd9abbb?source=collection_archive---------3-----------------------#2020-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e243" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何为您的无服务器应用程序构建自定义Python层。</h2></div><p id="b8f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">许多开发人员在AWS lambda上导入自定义模块时会遇到问题，您会看到类似“没有名为pandas的模块”或“没有名为numpy的模块”的错误，大多数情况下，解决这一问题的最简单方法是将Lambda函数代码与模块捆绑在一起，并将其部署在AWS Lambda上，这最终会使整个项目变得很大，并且没有灵活性。为了解决这个问题，我们在AWS Lambda上使用了一种叫做<strong class="kh ir">层</strong>的东西。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/e1165a6f528fffe56fabfaccc4612fbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z7tzfj6S6t4riH6F"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated"><a class="ae lr" href="https://unsplash.com/@jdubs?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">王占山</a>在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><h1 id="5b59" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是层？</h1><p id="25e1" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">根据文档，层是包含库、<a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html" rel="noopener ugc nofollow" target="_blank">自定义运行时</a>或其他依赖项的ZIP存档。使用层，您可以在函数中使用库，而无需将它们包含在部署包中。</p><p id="d346" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">层允许你安装你的应用程序运行所需的所有模块，它为你部署你的lambda函数提供了灵活性，甚至通过层，你甚至可以制作你自己的定制代码，并作为层本身添加外部功能。它减轻了您管理包的压力，并允许您将更多的精力放在代码上。</p><h1 id="4e7f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">层的好处</h1><ul class=""><li id="3f39" class="mp mq iq kh b ki mk kl ml ko mr ks ms kw mt la mu mv mw mx bi translated">使您的部署包更小，更容易部署</li><li id="78c4" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">该层也可以跨其他lambda函数使用。</li><li id="9977" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">在控制台上快速更改代码。</li><li id="4c69" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">Lambda层支持版本控制，这允许您添加更多的包，并在需要时使用以前的包版本。</li></ul><p id="d024" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们知道了什么层，也知道了它有多有用，那就让我们来构建一个层吧🚀。</p><h2 id="00f5" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">第一步</h2><p id="814e" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">创建一个新目录，并导航到您计算机上的目录:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="efe1" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~$ mkdir my-lambda-layer &amp;&amp; cd my-lambda-layer</span></pre><h2 id="a93c" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">第二步</h2><p id="7d9b" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">接下来，为需要安装的模块创建一个文件夹结构:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="d731" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer$ mkdir -p aws-layer/python/lib/python3.7/site-packages</span></pre><p id="837c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件夹结构非常重要，因为Python希望在那里找到您已经安装的模块。对于本文，我使用的是python 3.7，如果您想使用不同的python版本，请将上面文件夹中的<em class="ny"> python3.7 </em>更改为所需的版本。</p><h2 id="d536" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">第三步</h2><p id="ec54" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">让我们安装我们的库。要为您的应用程序只安装一个模块，使用下面的命令，在这个例子中我将使用numpy。</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="a84f" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer$ pip3 install numpy --target aws-layer/python/lib/python3.7/site-packages</span></pre><p id="c330" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要安装多个模块，请在基本目录中创建一个requirements.txt文件，并添加模块及其各自的版本:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="60a0" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer$ nano requirements.txt </span></pre><p id="5ae4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加你的模块，如下图所示:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nz"><img src="../Images/b4956cdbf5e010854ce7b7b91f5877cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P0Asn_dLiylQA3IekcHidw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="c819" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后用下面的命令安装它们:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="e643" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer$ pip3 install -r requirements.txt --target aws-layer/python/lib/python3.7/site-packages</span></pre><p id="40e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该有这样一个文件夹树:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/94dfb8fcb9623fe27aa8a30641abb59f.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*BQJAHK8X7p8dGJfvx7n3LQ.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><h2 id="cdb8" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">第四步</h2><p id="ea67" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">接下来，我们导航到<em class="ny"> lambda-layer </em>目录，为将要上传的图层创建一个zip文件。</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="39f9" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer$ cd aws-layer</span></pre><p id="507c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在压缩整个文件夹:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="96e2" class="nd lt iq nq b gy nu nv l nw nx">israel@israel:~/my-lambda-layer/aws-layer$ <!-- -->zip -r9 lambda-layer.zip .</span></pre><p id="3501" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">压缩包后，它将有一个名字“lambda-layer.zip”</p><p id="8535" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用AWS CLI或AWS web控制台将zip文件上传到lambda层，对于本文，我将使用AWS CLI</p><h2 id="9a1d" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">使用CLI</h2><p id="3bf1" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">要使用AWS CLI自动创建lambda层，您可以使用以下命令:</p><pre class="lc ld le lf gt np nq nr ns aw nt bi"><span id="c037" class="nd lt iq nq b gy nu nv l nw nx">aws lambda publish-layer-version \<br/>    --layer-name Data-Preprocessing \<br/>    --description "My Python layer" \<br/>    --zip-file fileb://<!-- -->lambda-layer.zip \<br/>    --compatible-runtimes python3.7</span></pre><p id="8fe2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到在您的Web控制台中创建的lambda层。此外，请确保在AWS CLI上设置您的凭据和权限来部署该层。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ob"><img src="../Images/1cda7fa9b47b82d2be0d89aae86de0c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VvqYJnjDp5bPU0f9hKrgmw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><h2 id="c4c8" class="nd lt iq bd lu ne nf dn ly ng nh dp mc ko ni nj me ks nk nl mg kw nm nn mi no bi translated">测试图层</h2><p id="8888" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">为了测试Lambda层，我简单地创建了一个新的Lambda函数并将我的层添加到其中，您可以通过简单地单击Layers来完成此操作，然后单击custom layer选项并选择您刚刚部署到Lambda的层，最后，您应该会看到下图:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oc"><img src="../Images/41e6c8603d0df3b3de86a601b565f75e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*muX_CelhCYhBARo2-ms8Eg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="b2e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在功能上，我导入了熊猫和numpy</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi od"><img src="../Images/ddcfa736c24863434a124dd2fe72549a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rg9Vevr9sm9NlJNZ3DcfEg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="77bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我测试了这个函数，得到了如下的响应</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ob"><img src="../Images/26c41c4a27edbc37b4f8acf273b94a7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBu7Qckgr7kx6bFyD-egbw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="0207" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从图中可以看出，我们的代码能够成功运行，并且我们可以为我们的应用程序导入外部包。</p><h1 id="4c8e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><p id="740d" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">到目前为止，我们已经看到了层的美丽和它们的强大，你应该在任何你想使用外部模块的地方使用它们，甚至当你有你自己写的定制代码的时候。</p><p id="9dfe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢阅读😊。</p></div></div>    
</body>
</html>