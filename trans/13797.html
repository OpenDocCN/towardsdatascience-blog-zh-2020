<html>
<head>
<title>Airflow in Docker Metrics Reporting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker指标报告中的气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/airflow-in-docker-metrics-reporting-83ad017a24eb?source=collection_archive---------17-----------------------#2020-09-22">https://towardsdatascience.com/airflow-in-docker-metrics-reporting-83ad017a24eb?source=collection_archive---------17-----------------------#2020-09-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6eca" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在官方的Apache气流图像上使用Grafana来监控队列健康状况等等。</h2></div><p id="6985" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个令人不安但可能熟悉的情况:您成功地部署了Airflow，但发现自己不断刷新webserver UI以确保一切顺利运行。</p><p id="6868" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您依赖某些警报任务在上游故障时执行，但是如果队列已满并且任务停止，您将如何得到通知？</p><p id="4993" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个解决方案是:在Airflow上部署Grafana，一个开源的报告服务。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/ca323d54465af7ac0a820df27d5929f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lgpqbwlu53aNLBjo"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">由<a class="ae lr" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马库斯·斯皮斯克</a>在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h2 id="c2d0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">提议的架构</h2><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ml"><img src="../Images/7f683a6738074e2884f0df8ae9dcb4cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Kl_uXh5WCfHPcZxx.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="e661" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我假设对使用Docker和Docker Compose的气流功能和容器化有基本的了解。更多资源可以在<a class="ae lr" href="https://airflow.apache.org/docs/stable/concepts.html" rel="noopener ugc nofollow" target="_blank">这里找到气流</a>，在<a class="ae lr" href="https://docs.docker.com/get-started/overview/" rel="noopener ugc nofollow" target="_blank">这里找到对接</a>，在<a class="ae lr" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank">这里找到对接合成</a>。</p><p id="681b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参考代码跟随:<a class="ae lr" href="https://github.com/sarahmk125/airflow-docker-metrics" rel="noopener ugc nofollow" target="_blank">https://github.com/sarahmk125/airflow-docker-metrics</a></p><p id="72ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，有趣的事情。</p><h1 id="2fd2" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">用过的服务</h1><p id="75c4" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">为了将气流度量放入支持警报的视觉上吸引人的仪表板中，在<code class="fe nc nd ne nf b">docker-compose.yml</code>文件中声明的Docker容器中增加了以下服务:</p><ul class=""><li id="db32" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated"><strong class="kh ir"> Airflow: </strong> Airflow在Dag中运行任务，这些任务在存储于<code class="fe nc nd ne nf b">./dags/</code>文件夹中的Python文件中定义。已经有一个示例DAG声明文件。运行多个容器，特别是使用官方<code class="fe nc nd ne nf b">apache/airflow</code>图像的细微差别。稍后会详细介绍。</li><li id="e54d" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated"><strong class="kh ir">StatsD-Exporter</strong>:StatsD-Exporter容器将StatsD格式的气流度量转换为Prometheus格式，即报告层(Grafana)的数据源。有关StatsD-Exporter的更多信息，请点击查看<a class="ae lr" href="https://github.com/prometheus/statsd_exporter" rel="noopener ugc nofollow" target="_blank">。容器定义包括启动时要执行的命令，定义如何使用公开的端口。</a></li></ul><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="a547" class="ls lt iq nf b gy ny nz l oa ob">statsd-exporter:<br/>  image: prom/statsd-exporter<br/>  container_name: airflow-statsd-exporter<br/>  command: "--statsd.listen-udp=:8125 --web.listen-address=:9102"<br/>  ports:<br/>    - 9123:9102<br/>    - 8125:8125/udp</span></pre><ul class=""><li id="1bb5" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">Prometheus  : Prometheus是一个常用于时间序列数据报告的服务。由于Prometheus是一个受支持的数据源，所以在使用Grafana作为报告UI时特别方便。更多关于普罗米修斯的信息请点击查看<a class="ae lr" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">。容器定义中装载的卷指示数据如何流入/流出Prometheus。</a></li></ul><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="f749" class="ls lt iq nf b gy ny nz l oa ob">prometheus:<br/>  image: prom/prometheus<br/>  container_name: airflow-prometheus<br/>  user: "0"<br/>  ports:<br/>    - 9090:9090<br/>  volumes:<br/>    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml<br/>    - ./prometheus/volume:/prometheus</span></pre><ul class=""><li id="a081" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">Grafana是一个报告UI服务，通常用于连接非关系数据库。在中描述的<a class="ae lr" href="https://github.com/sarahmk125/airflow-docker-metrics" rel="noopener ugc nofollow" target="_blank">代码中，Grafana使用Prometheus作为仪表板的数据源。容器定义包括门户的管理员用户，以及定义已经预先配置的数据源和仪表板的卷。</a></li></ul><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="eae3" class="ls lt iq nf b gy ny nz l oa ob">grafana:<br/>  image: grafana/grafana:7.1.5<br/>  container_name: airflow-grafana<br/>  environment:<br/>    GF_SECURITY_ADMIN_USER: admin<br/>    GF_SECURITY_ADMIN_PASSWORD: password<br/>    GF_PATHS_PROVISIONING: /grafana/provisioning<br/>  ports:<br/>    - 3000:3000<br/>  volumes:<br/>    - ./grafana/volume/data:/grafana<br/>    - ./grafana/volume/datasources:/grafana/datasources<br/>    - ./grafana/volume/dashboards:/grafana/dashboards<br/>    - ./grafana/volume/provisioning:/grafana/provisioning</span></pre><h1 id="e0b9" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">让它走</h1><p id="dc12" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">要启动一切，需要以下工具:Docker、docker-compose、Python3、Git。</p><p id="d1b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">步骤(在终端中运行):</strong></p><ul class=""><li id="7e4d" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">克隆存储库:<code class="fe nc nd ne nf b">git clone <a class="ae lr" href="https://github.com/sarahmk125/airflow-docker-metrics.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sarahmk125/airflow-docker-metrics.git</a></code></li><li id="fa8b" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">导航到克隆的文件夹:<code class="fe nc nd ne nf b">cd airflow-docker-metrics</code></li><li id="aeb9" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">启动容器:<code class="fe nc nd ne nf b">docker-compose -f docker-compose.yml up -d</code>(注意:除了最后分别用<code class="fe nc nd ne nf b">stop</code>或<code class="fe nc nd ne nf b">down</code>外，可以通过运行相同的命令来停止或移除容器)</li></ul><p id="1c65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">结果:</strong></p><ul class=""><li id="242f" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">air flow web server UI:<a class="ae lr" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oc"><img src="../Images/f1e50e55272b5e6ca2fccfa75d3c7db5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rn2RicJYMjFCg5X5DNWBVg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><ul class=""><li id="4087" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">StatsD指标列表:<a class="ae lr" href="http://localhost:9123/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:9123/metrics</a></li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi od"><img src="../Images/c3c3caceb4a256907e4eaff5d7336b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*eg_3T_l1nj4f9nWyS6YKeA.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><ul class=""><li id="7b6c" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">普罗米修斯:<a class="ae lr" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a></li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oe"><img src="../Images/6bbd35efa989269487fe186a60dcb1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVhgLwtnxyJjqAWnzjHCDw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><ul class=""><li id="d1d1" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">grafana:<a class="ae lr" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a>(登录:username= <em class="of"> admin </em>，password =<em class="of">password</em>)<br/>该存储库包括一个气流指标仪表板，可以设置警报，显示一段时间内正在运行和排队的任务数量:</li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi og"><img src="../Images/35cd5ba68df2b0a1a9503989dd2af164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGGzigAYPSKKO0IhOFnWWw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><h1 id="8843" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">解释的步骤</h1><h2 id="b4cd" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">普罗米修斯实际上是如何得到度量的？</h2><p id="7638" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">Prometheus在启动时配置在作为卷挂载的<code class="fe nc nd ne nf b">./prometheus/prometheus.yml</code>文件中:</p><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="764e" class="ls lt iq nf b gy ny nz l oa ob">global:<br/>  scrape_interval: 30s<br/>  evaluation_interval: 30s<br/>  scrape_timeout: 10s<br/>  external_labels:<br/>    monitor: 'codelab-monitor'</span><span id="5107" class="ls lt iq nf b gy oh nz l oa ob">scrape_configs:<br/>  - job_name: 'prometheus'<br/>    static_configs:<br/>      - targets: ['airflow-prometheus:9090']<br/>  <br/>  - job_name: 'statsd-exporter'<br/>    static_configs:<br/>      - targets: ['airflow-statsd-exporter:9102']<br/>    <br/>    tls_config:<br/>      insecure_skip_verify: true</span></pre><p id="a7cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">特别是，<code class="fe nc nd ne nf b">scrape_configs</code>部分声明了要抓取的目的地(<code class="fe nc nd ne nf b">airflow-prometheus</code>容器)和源(<code class="fe nc nd ne nf b">airflow-statsd-exporter</code>容器)。</p><h2 id="1540" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">如何在Grafana中创建仪表板和警报？</h2><p id="b25b" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">供应是您的朋友！</p><p id="79a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Grafana中的供应意味着使用代码来定义数据源、仪表板和启动时存在的警报。当启动容器时，在<a class="ae lr" href="http://localhost:3000/datasources" rel="noopener ugc nofollow" target="_blank">localhost:3000/data sources</a>中已经配置了一个<code class="fe nc nd ne nf b">Prometheus</code>数据源，并且在<a class="ae lr" href="http://localhost:3000/dashboards" rel="noopener ugc nofollow" target="_blank">localhost:3000/dashboards</a>中列出了一个<code class="fe nc nd ne nf b">Airflow Metrics</code>仪表板。</p><p id="93bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">如何调配:</strong></p><ul class=""><li id="e388" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">所有相关数据都作为卷安装到在<code class="fe nc nd ne nf b">docker-compose.yml</code>文件中定义的<code class="fe nc nd ne nf b">grafana</code>容器中(如上所述)</li><li id="baa4" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe nc nd ne nf b">./grafana/volume/provisioning/datasources/default.yaml</code>文件包含所有数据源的定义:</li></ul><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="df84" class="ls lt iq nf b gy ny nz l oa ob">apiVersion: 1<br/>datasources:<br/>  - name: Prometheus<br/>    type: prometheus<br/>    access: proxy<br/>    url: http://prometheus:9090</span></pre><ul class=""><li id="f7cf" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated"><code class="fe nc nd ne nf b">./grafana/volume/provisioning/dashboards/default.yaml</code>文件包含关于在容器中何处安装仪表板的信息:</li></ul><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="a046" class="ls lt iq nf b gy ny nz l oa ob">apiVersion: 1<br/>providers:<br/>  - name: dashboards<br/>    folder: General<br/>    type: file<br/>    editable: true<br/>    updateIntervalSeconds: 10<br/>    allowUiUpdates: true<br/>    options:<br/>      path: /grafana/dashboards<br/>      foldersFromFilesStructure: true</span></pre><ul class=""><li id="2ec1" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated"><code class="fe nc nd ne nf b">./grafana/volume/dashboards/</code>文件夹包含<code class="fe nc nd ne nf b">.json</code>文件，每个文件代表一个仪表板。<a class="ae lr" href="https://github.com/sarahmk125/airflow-docker-metrics/blob/master/grafana/volume/dashboards/airflow_metrics.json" rel="noopener ugc nofollow" target="_blank"> airflow_metrics.json </a>文件在上面显示的仪表板中产生结果。</li></ul><p id="f0b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照这些<a class="ae lr" href="https://grafana.com/docs/grafana/latest/reference/dashboard/" rel="noopener ugc nofollow" target="_blank">指令</a>可以从Grafana UI中检索JSON。</p><p id="1567" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">UI中的警报可以按照这里的<a class="ae lr" href="https://grafana.com/docs/grafana/latest/alerting/create-alerts/" rel="noopener ugc nofollow" target="_blank">所述进行设置；这里还有一篇优秀的中型文章</a><a class="ae lr" href="https://medium.com/@_oleksii_/grafana-alerting-and-slack-notifications-3affe9d5f688" rel="noopener">关于设置Grafana alerting with Slack的</a>。可以采用与仪表板和数据源相同的方式提供警报。</p><h1 id="62b6" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">额外话题:官方气流图像</h1><p id="ed4f" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">在有官方Docker形象之前，<a class="ae lr" href="https://github.com/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank">Matthieu“puck El _”rois il</a>发布了Docker对气流的支持。从Airflow版本1.10.10开始，Apache软件基金会在DockerHub 上发布了一个<a class="ae lr" href="https://hub.docker.com/r/apache/airflow/tags" rel="noopener ugc nofollow" target="_blank">官方图像，这是唯一一个当前持续更新的图像。然而，许多人仍然依赖传统的和非官方的库。</a></p><p id="063c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么这是一个问题？好吧，依赖遗留库意味着在版本1.10.9中限制气流。Airflow 1.10.10开始支持一些很酷的功能，比如在Kubernetes上运行任务。官方仓库也将是即将到来的(和高度期待的)气流2.0将被释放。</p><p id="e02e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在描述的仓库中为<code class="fe nc nd ne nf b">webserver</code>找到的新的<code class="fe nc nd ne nf b">docker-compose</code>声明看起来像这样:</p><pre class="lc ld le lf gt nu nf nv nw aw nx bi"><span id="bd18" class="ls lt iq nf b gy ny nz l oa ob">webserver:<br/>  container_name: airflow-webserver<br/>  image: apache/airflow:1.10.12-python3.7<br/>  restart: always<br/>  depends_on:<br/>    - postgres<br/>    - redis<br/>    - statsd-exporter<br/>  environment:<br/>    - LOAD_EX=n<br/>    - EXECUTOR=Local<br/>    - POSTGRES_USER=airflow<br/>    - POSTGRES_PASSWORD=airflow<br/>    - POSTGRES_DB=airflow<br/>    - AIRFLOW__SCHEDULER__STATSD_ON=True<br/>    - AIRFLOW__SCHEDULER__STATSD_HOST=statsd-exporter<br/>    - AIRFLOW__SCHEDULER__STATSD_PORT=8125<br/>    - AIRFLOW__SCHEDULER__STATSD_PREFIX=airflow<br/>    -AIRFLOW__CORE__SQL_ALCHEMY_CONN= postgresql+psycopg2://airflow:airflow@postgres:5432/airflow<br/>    -AIRFLOW__CORE__FERNET_KEY= pMrhjIcqUNHMYRk_ZOBmMptWR6o1DahCXCKn5lEMpzM=<br/>    - AIRFLOW__CORE__EXECUTOR=LocalExecutor<br/>    - AIRFLOW__CORE__AIRFLOW_HOME=/opt/airflow/<br/>    - AIRFLOW__CORE__LOAD_EXAMPLES=False<br/>    - AIRFLOW__CORE__LOAD_DEFAULT_CONNECTIONS=False<br/>    - AIRFLOW__WEBSERVER__WORKERS=2<br/>    - AIRFLOW__WEBSERVER__WORKER_REFRESH_INTERVAL=1800<br/>  volumes:<br/>    - ./dags:/opt/airflow/dags<br/>  ports:<br/>    - "8080:8080"<br/>  command: bash -c "airflow initdb &amp;&amp; airflow webserver"<br/>  healthcheck:<br/>    test: ["CMD-SHELL", "[ -f /opt/airflow/airflow-webserver.pid ]"]<br/>    interval: 30s<br/>    timeout: 30s<br/>    retries: 3</span></pre><p id="57e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从<code class="fe nc nd ne nf b">puckel/docker-airflow</code>配置的一些变化来突出:</p><ul class=""><li id="aacf" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">以前在<code class="fe nc nd ne nf b">airflow.cfg</code>文件中发现的自定义参数，如<code class="fe nc nd ne nf b">AIRFLOW__CORE__SQL_ALCHEMY_CONN </code>，现在被声明为<code class="fe nc nd ne nf b">docker-compose</code>文件中的环境变量。</li><li id="77f8" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">初始化后端数据库的<code class="fe nc nd ne nf b">airflow initdb</code>命令现在在<code class="fe nc nd ne nf b">docker-compose</code>文件中被声明为一个命令，而不是一个入口点脚本。</li></ul><h1 id="8f81" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">瞧啊。</h1><p id="84ed" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">这就是了。再也不用担心你的任务被无限地排队而没有运行。气流在Docker中运行，Grafana中的仪表盘和警报触手可及。相同的架构可以在部署在GCP或AWS的实例上运行，以实现全天候监控，就像在本地运行一样。</p><p id="f43e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成品可以在这里找到:<a class="ae lr" href="https://github.com/sarahmk125/airflow-docker-metrics" rel="noopener ugc nofollow" target="_blank">https://github.com/sarahmk125/airflow-docker-metrics</a></p><p id="aec5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">需要注意的是，总有改进的空间:</p><ul class=""><li id="08e9" class="ng nh iq kh b ki kj kl km ko ni ks nj kw nk la nl nm nn no bi translated">此监视设置不会捕获容器或实例故障；需要一个单独的或扩展的解决方案来在容器或实例级别进行监控。</li><li id="338e" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">当前代码使用LocalExecutor运行，这对于大型工作负载来说不太理想。可以用CeleryExecutor做进一步的测试。</li><li id="fc89" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">在StatsD中还有许多没有突出显示的可用指标(例如DAG或任务持续时间、任务失败次数等。).可以在Grafana中构建和提供更多的仪表板，以利用所有相关的指标。</li><li id="052d" class="ng nh iq kh b ki np kl nq ko nr ks ns kw nt la nl nm nn no bi translated">最后，本文重点关注自托管(或高度可配置的云)气流部署，但这不是部署气流的唯一选择。</li></ul><h1 id="5922" class="mm lt iq bd lu mn mo mp lx mq mr ms ma jw mt jx md jz mu ka mg kc mv kd mj mw bi translated">有问题吗？评论？</h1><p id="fce7" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">感谢阅读！我喜欢谈论数据堆栈。<a class="ae lr" href="https://www.linkedin.com/in/sarah-krasnik/" rel="noopener ugc nofollow" target="_blank">给我发个消息</a>。</p></div></div>    
</body>
</html>