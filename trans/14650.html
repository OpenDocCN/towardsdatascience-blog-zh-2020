<html>
<head>
<title>Upsample with an average in Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫的样本高于平均值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/upsample-with-an-average-in-pandas-c029032c57ca?source=collection_archive---------25-----------------------#2020-10-09">https://towardsdatascience.com/upsample-with-an-average-in-pandas-c029032c57ca?source=collection_archive---------25-----------------------#2020-10-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="053b" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/getting-started" rel="noopener" target="_blank">入门</a></h2><div class=""/><div class=""><h2 id="5532" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">为您的机器学习对齐不一致的报告数据</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/cbc6814c170e2dce4556610b6a0cc554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uAxuFp5sv6cnfDKGT6AX8A.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图片作者(<a class="ae lh" href="https://about.canva.com/license-agreements/onedesign/" rel="noopener ugc nofollow" target="_blank">许可</a>)</p></figure><p id="c890" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">许多模型输入累积变量，如几小时内的降雨量或几个月内的公司收入。不幸的是，数据源通常在时间上不一致。一个传感器每隔奇数小时提供数据，另一个在偶数小时提供数据。一家公司在五月提供信息，另一家在六月。</p><p id="5ce0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您不想等待所有数据源都收集输入数据，或者当不适合向模型提供来自不同时间段的数据时，您必须将测量结果分散到相同的时间段。熊猫本身可以完成部分工作，但在本文中，我们将探索如何用平均值进行上采样，这需要一点额外的编码。</p><p id="4860" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以通过Github上共享的笔记本运行本教程中的所有示例—<a class="ae lh" href="https://github.com/vaclavdekanovsky/data-analysis-in-examples/blob/master/Pandas/Upsample/Upsample%20to%20average.ipynb" rel="noopener ugc nofollow" target="_blank">up sample _ to _ average . ipynb</a></p><h1 id="478f" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">重采样</h1><h2 id="5db2" class="mw mf it bd mg mx my dn mk mz na dp mo lr nb nc mq lv nd ne ms lz nf ng mu iz bi translated">向下采样</h2><p id="5482" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated"><a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/resampling.html" rel="noopener ugc nofollow" target="_blank">python的Pandas中的重采样</a>允许您将频率较高的值转换为频率较低的值— <code class="fe nm nn no np b"><strong class="lk jd">downsample</strong></code>，例如，将每小时的数据转换为每天的总和、计数和平均值，或者将每天的值转换为每月的值。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="8afd" class="mw mf it np b gy nu nv l nw nx"># downsample:<br/>CAT|DATE|VALUE<br/>abc|0101|10<br/>abc|0102|20<br/>abc|0103|15</span><span id="d0d0" class="mw mf it np b gy ny nv l nw nx"># downsample<br/><strong class="np jd">[IN]:</strong> df.groupby("CAT").resample("W", on="DATE").agg({"VALUE":["sum","count","mean","first","last"]})</span><span id="d3dd" class="mw mf it np b gy ny nv l nw nx"><strong class="np jd">[OUT]:<br/></strong>CAT|DATE|SUM|COUNT|MEAN|MIN|MAX|FIRST|LAST<br/>abc|0107|45 |   3 | 15 | 10| 20|  10 | 15</span></pre><p id="352a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它被称为<code class="fe nm nn no np b">downsample</code>,因为数据行的数量减少了。可以申请<code class="fe nm nn no np b">sum</code>、<code class="fe nm nn no np b">count</code>、<code class="fe nm nn no np b">mean</code>(平均)、<code class="fe nm nn no np b">median</code>、<code class="fe nm nn no np b">min</code>、<code class="fe nm nn no np b">max</code>、<code class="fe nm nn no np b">first</code>或<code class="fe nm nn no np b">last</code>。基于每日输入，您可以重采样到周、月、季度、年，也可以重采样到半月——参见pandas文档中<a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases" rel="noopener ugc nofollow" target="_blank">重采样选项的完整列表。您还可以对乘法进行重新采样，例如<code class="fe nm nn no np b">5H</code>以5小时为一组。</a></p><h2 id="3dc5" class="mw mf it bd mg mx my dn mk mz na dp mo lr nb nc mq lv nd ne ms lz nf ng mu iz bi translated">向上采样</h2><p id="b28b" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">重新采样到更频繁的时间戳被称为<code class="fe nm nn no np b"><strong class="lk jd">upsampling</strong></code>。你可以把几天变成几小时，或者几个月变成几天。进行上采样时，必须首先将日期时间列设置为数据框的索引(<code class="fe nm nn no np b">.set_index</code>)，然后才能进行上采样。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="dfe9" class="mw mf it np b gy nu nv l nw nx"># error in case you try upsample using .resample("D", on="col")<br/><strong class="np jd">ValueError</strong>: Upsampling from level= or on= selection is not supported, use .set_index(...) to explicitly set index to datetime-like</span></pre><p id="93b2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">除上述功能外，上采样还支持<code class="fe nm nn no np b">backfill/bfill</code>、<code class="fe nm nn no np b">ffill/pad</code>和<code class="fe nm nn no np b">nearest</code>。但是如果你认为应用<code class="fe nm nn no np b">mean</code>会把每天的值分割成每小时的平均值，那你就错了。所有加起来的样本都用<code class="fe nm nn no np b">NaN</code>填充。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h2 id="eb09" class="mw mf it bd mg mx my dn mk mz na dp mo lr nb nc mq lv nd ne ms lz nf ng mu iz bi translated">为什么我们要向上采样到平均值</h2><p id="9b20" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">假设你有一个商店组合，试着估算一下销售额。您输入<code class="fe nm nn no np b">Jan-1</code>、<code class="fe nm nn no np b">Jan-2</code>和<code class="fe nm nn no np b">Jan-3</code>的收入，并执行回归以猜测<code class="fe nm nn no np b">Jan-4</code>的目标值。你对你所有的商店进行训练，并使用模型来预测未来的销售。</p><p id="c1ba" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是如果有些商店只提供<code class="fe nm nn no np b">Jan-2</code>和<code class="fe nm nn no np b">Jan-3</code>的数据呢？其他仅在<code class="fe nm nn no np b">Jan-1</code>和<code class="fe nm nn no np b">Jan-3</code>上。您可以使用这3天中的<code class="fe nm nn no np b">sum</code>或<code class="fe nm nn no np b">average</code>进行缩减采样和建模，但在这种情况下，您会丢失有价值的输入信息，如周五的收入或周一的收入。</p><p id="bebd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">与普遍看法相反，这种情况很典型。当分析公司的基本数据以预测未来的股票价格时，一些公司每季度报告一次，而另一些公司每年报告两次。有些在11月，有些在8月。如果你等到每个人都提供了他们的数据，你可能会得出一个精确的预测，但那时所有有利可图的股票都会被卖出。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/8930fe2d85a5df7f4b4faa82a86775c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VSkoXXHY_muJAnQoHpethw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图片作者(<a class="ae lh" href="https://about.canva.com/license-agreements/onedesign/" rel="noopener ugc nofollow" target="_blank">许可</a>)</p></figure><blockquote class="ob oc od"><p id="b517" class="li lj oe lk b ll lm kd ln lo lp kg lq of ls lt lu og lw lx ly oh ma mb mc md im bi translated">通常80%的输入保持相同的模式，20%包括一些重要的场景具有不寻常的结构，你必须重新计算。</p></blockquote><p id="dcf4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要解决这些数据泄漏，您可以向上采样到平均值。</p><h2 id="1d6c" class="mw mf it bd mg mx my dn mk mz na dp mo lr nb nc mq lv nd ne ms lz nf ng mu iz bi translated">用平均值向上采样</h2><p id="8863" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">我说的是平滑不一致的报告数据的选项，这样您就可以</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="4afe" class="mw mf it np b gy nu nv l nw nx"><strong class="np jd">[IN]:</strong><br/>data="""<br/><strong class="np jd">CAT|DATE|VALUE</strong><br/>abc|0101|10<br/>abc|0103|20<br/>abc|0105|15<br/>efg|0102|40<br/>efg|0105|30"""</span><span id="9138" class="mw mf it np b gy ny nv l nw nx"><strong class="np jd">[OUT]:</strong><br/><strong class="np jd">CAT|DATE|VALUE</strong><br/>abc|0102|10<br/>abc|0103|10   # 20 on 0103 covers interval 0102-0103 (2 days)<br/>abc|0104|7.5<br/>abc|0105|7.5  # 15 on 0105 covers interval 0104-0105 (2 days)<br/>efg|0103|10<br/>efg|0104|10<br/>efg|0105|10   # 30 on 0105 covers interval 0103-0105 (3 days)</span></pre><p id="733f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">上面的例子很简单，但是想象一下你有几千个类别。有些是每天报告，有些是单双日报告，其余的是每三天或不定期报告。</p><h2 id="ebb4" class="mw mf it bd mg mx my dn mk mz na dp mo lr nb nc mq lv nd ne ms lz nf ng mu iz bi translated">如何做一般的魔术</h2><p id="4582" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">为了计算平均值，你需要两个东西——<code class="fe nm nn no np b">sum</code>除以<code class="fe nm nn no np b">count</code>。您知道总数，因为它已被报告，但从最后一个值算起的天数(月数、周数……)未知。幸运的是，熊猫重采样包含一个参数<code class="fe nm nn no np b">.group</code>,它显示了上采样时创建了多少个群组。</p><p id="cd5a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">不幸的是，它本身不能与<code class="fe nm nn no np b">groupby</code>一起工作，所以我们将首先查看单个类别。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="7afc" class="mw mf it np b gy nu nv l nw nx">data="""<br/>CAT|DATE|VALUE<br/>abc|<strong class="np jd">0101</strong>|10<br/>abc|<strong class="np jd">0103</strong>|20<br/>abc|<strong class="np jd">0106</strong>|15"""</span></pre><p id="dafe" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/resampling.html" rel="noopener ugc nofollow" target="_blank">重采样</a>方法有两个属性:</p><ul class=""><li id="5ad5" class="oi oj it lk b ll lm lo lp lr ok lv ol lz om md on oo op oq bi translated"><code class="fe nm nn no np b">indices</code> —显示输入数据出现的位置</li><li id="e191" class="oi oj it lk b ll or lo os lr ot lv ou lz ov md on oo op oq bi translated"><code class="fe nm nn no np b">groups</code> —用组索引对每个日期时间值进行索引。</li></ul><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="61ff" class="mw mf it np b gy nu nv l nw nx"># indices<br/>[In]: df.set_index("DATE").resample("D").<strong class="np jd">indices</strong><br/>[Out]: <br/>defaultdict(list,<br/>            {Timestamp('1900-01-<strong class="np jd">01</strong> 00:00:00', freq='D'): [0],<br/>             Timestamp('1900-01-<strong class="np jd">03</strong> 00:00:00', freq='D'): [1],<br/>             Timestamp('1900-01-<strong class="np jd">06</strong> 00:00:00', freq='D'): [2]})</span><span id="4ea2" class="mw mf it np b gy ny nv l nw nx"># groups<br/>[In]: df.set_index("DATE").resample("D").<strong class="np jd">groups</strong><br/>[Out]:<br/>{Timestamp('1900-01-01 00:00:00', freq='D'): 1,<br/> Timestamp('1900-01-02 00:00:00', freq='D'): 1,<br/> Timestamp('1900-01-03 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-04 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-05 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-06 00:00:00', freq='D'): 3}</span></pre><p id="a4c1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">1月1日和2日形成第一组，3日至5日是第二组，最后一个数据样本属于最后一组。大多数情况下，报告的数据包含报告日期的值—1月3日报告的20个数据涵盖1月2日和1月3日。在这种情况下，您使用<code class="fe nm nn no np b">label</code>参数并将其设置为<code class="fe nm nn no np b">right</code>。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="6ff4" class="mw mf it np b gy nu nv l nw nx"># groups<br/>[In]: df.set_index("DATE").resample("D", label="right).<strong class="np jd">groups</strong><br/>[Out]:<br/>{<br/> Timestamp('1900-01-02 00:00:00', freq='D'): 1,<br/> Timestamp('1900-01-03 00:00:00', freq='D'): 1,<br/> Timestamp('1900-01-04 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-05 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-06 00:00:00', freq='D'): 2,<br/> Timestamp('1900-01-07 00:00:00', freq='D'): 3,}</span></pre><p id="81e1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">或者，您可以将组转换成数据帧，并移动值</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="de05" class="mw mf it np b gy nu nv l nw nx">df_groups = pd.DataFrame(df.set_index("DATE").resample("D").groups, index=["group"]).T.shift(1)</span></pre><p id="f54a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后你计算每组中出现的次数。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="d491" class="mw mf it np b gy nu nv l nw nx">s = df_groups.groupby("group").size()<br/>s.name = "count"</span></pre><p id="595b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">并将计数与日期和回填值连接起来。它会生成一个数据帧，其中包含该时间段的总和以及该时间段内的发生次数，这就是计算平均值所需的全部内容。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="baa3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你现在兴奋地大叫，坚持住，我们还没有到达终点。我们已经计算了单个组的平均值，但是如果我们想要<code class="fe nm nn no np b">groupby</code>多个类别，例如，当我们有许多商店、公司或传感器要处理时，我们必须分别计算每个组的平均值。</p><p id="978e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这并不复杂，但如果您有许多输入，这可能会很耗时。参见下面的代码:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="94ae" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您已经将数据平滑到平均值，但通常您不需要每个月的平均值。您只需要涵盖不同的报告期。例如，在审查上市公司<a class="ae lh" rel="noopener" target="_blank" href="/stock-fundamental-analysis-eda-of-secs-quarterly-data-summary-455e62ff4817">业绩的财务分析</a>中，大多数公司在季度末报告数据。但是有些是在不同的月份，甚至不是每季度。如果你想对一大堆公司的行为建模，你首先要对那些没有季度报告的公司进行平滑平均，然后使用<code class="fe nm nn no np b">rolling</code>函数将输入限制为仅季度。</p><blockquote class="ob oc od"><p id="12ee" class="li lj oe lk b ll lm kd ln lo lp kg lq of ls lt lu og lw lx ly oh ma mb mc md im bi translated">更多的输入意味着更多的模型参数和更长的计算时间</p></blockquote><p id="ec2d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们看一下股票市场分析的例子:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="49a0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">编码再次让我们感到惊讶。当您对<strong class="lk jd">天</strong>应用<code class="fe nm nn no np b">.resample("D", label="right")</code>重采样时，结果与<code class="fe nm nn no np b">.resample("D", label="right", <strong class="lk jd">closed="left"</strong>)</code>相同。如果在重新采样到<strong class="lk jd">月</strong>时做同样的操作，<code class="fe nm nn no np b">label="right"</code>与<code class="fe nm nn no np b">label="right", <strong class="lk jd">closed="right"</strong></code>相匹配。因此，您必须为每月计算指定<code class="fe nm nn no np b">label="right", closed="left"</code>,或者使用上述带有<code class="fe nm nn no np b">shift</code>的变通方法。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="dae3" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">结论</h1><p id="9fa0" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">我希望你不仅学到了关于重采样的知识，还学到了在输入机器学习模型时如何使用替代方法来对齐不一致的数据。</p><pre class="ks kt ku kv gt nq np nr ns aw nt bi"><span id="0395" class="mw mf it np b gy nu nv l nw nx">The images were with <a class="ae lh" href="https://partner.canva.com/vdek" rel="noopener ugc nofollow" target="_blank">canva.com</a> (affiliate link, when you click on it and purchase a product, you won't pay more, but I can receive a small reward; you can always write canva.com to your browser to avoid this). Canva offer some free templates and graphics too. <br/>Other articles:<br/>* <a class="ae lh" rel="noopener" target="_blank" href="/complete-guide-to-pythons-cross-validation-with-examples-a9676b5cac12">Everything you wanted to know about Kfold train-test split</a><br/>* <a class="ae lh" rel="noopener" target="_blank" href="/stop-persisting-pandas-data-frames-in-csvs-f369a6440af5">Why it's worth considering another file types than csv</a><br/>* <a class="ae lh" rel="noopener" target="_blank" href="/pythons-geocoding-convert-a-list-of-addresses-into-a-map-f522ef513fd6">How to turn a list of addreses into a map</a></span><span id="1397" class="mw mf it np b gy ny nv l nw nx">Great thanks to <a class="ae lh" href="https://towardsdatascience.com/" rel="noopener" target="_blank">Towards data science</a></span></pre><p id="20f8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Github上的完整代码—<a class="ae lh" href="https://github.com/vaclavdekanovsky/data-analysis-in-examples/blob/master/Pandas/Upsample/Upsample%20to%20average.ipynb" rel="noopener ugc nofollow" target="_blank">up sample _ to _ average . ipynb</a>。</p></div></div>    
</body>
</html>