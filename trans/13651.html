<html>
<head>
<title>Structuring ML Pipeline Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建ML管道项目</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/structuring-ml-pipeline-projects-97c16348be4a?source=collection_archive---------19-----------------------#2020-09-19">https://towardsdatascience.com/structuring-ml-pipeline-projects-97c16348be4a?source=collection_archive---------19-----------------------#2020-09-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2d27" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个有组织的代码库使你能够更快地实现变化，犯更少的错误，最终导致更高的代码和模型质量。阅读更多内容，了解如何使用Tensorflow Extended (TFX)构建您的ML项目，这是一种简单明了的方法。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9f3c0a4fd0f3f6a8af856a0864ac1d4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Whp3OSNl8mkWYMcLqsVow.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://pixabay.com/illustrations/lego-building-game-toy-drawing-3388163/" rel="noopener ugc nofollow" target="_blank">图片由来自Pixabay的Francis Ray拍摄</a></p></figure><h1 id="9c7b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">项目结构:需求</h1><ul class=""><li id="c254" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">启用<code class="fe mj mk ml mm b">multiple</code>管道实验</li><li id="94d3" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">支持<code class="fe mj mk ml mm b">local</code>执行模式和<code class="fe mj mk ml mm b">deployment</code>执行模式。这确保了创建两个独立的运行配置，第一个用于本地开发和端到端测试，第二个用于在云中运行。</li><li id="54f4" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">Reuse code</code>如果这样做有意义的话，跨管道变量</li><li id="efd2" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">提供一个易于使用的<code class="fe mj mk ml mm b">CLI interface</code>来执行具有不同<code class="fe mj mk ml mm b">configurations</code>和数据的流水线</li></ul><p id="fe54" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">一个正确的实现还可以确保测试很容易被整合到您的工作流程中。</p><h1 id="3822" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">项目结构:设计决策</h1><ul class=""><li id="38c8" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">用Python。</li><li id="8091" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">使用Tensorflow Extended (TFX)作为管道框架。</li></ul><p id="eadc" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">在本文中，我们将演示如何以最少的麻烦在本地和Kubeflow管道系统上运行TFX管道。</p><h1 id="f01f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设计决策引起的副作用</h1><ul class=""><li id="555a" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">通过使用TFX，我们将使用<code class="fe mj mk ml mm b">tensorflow</code>。请记住，tensorflow支持更多类型的模型，如<a class="ae ky" href="https://www.tensorflow.org/tutorials/estimator/boosted_trees" rel="noopener ugc nofollow" target="_blank">增强树</a>。</li><li id="2b12" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">Apache Beam可以在本地、kubernetes运行的任何地方以及所有公共云提供商上执行。例子包括但不限于:GCP数据流，Azure数据砖。</li><li id="46cd" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">由于Apache Beam，我们需要确保项目代码很容易被python的<code class="fe mj mk ml mm b">sdist</code>打包，以获得最大的可移植性。这体现在项目的顶层模块结构上。(如果您使用外部库，请确保通过向apache beam提供一个参数来包含它们。<em class="nh">阅读更多关于</em> <a class="ae ky" href="https://beam.apache.org/documentation/sdks/python-pipeline-dependencies/" rel="noopener ugc nofollow" target="_blank"> <em class="nh"> Apache Beam:管理Python管道依赖关系</em> </a> <em class="nh">)。</em></li></ul><blockquote class="ni nj nk"><p id="a0c5" class="ms mt nh lt b lu mu ju mv lw mw jx mx nl my mz na nm nb nc nd nn ne nf ng me im bi translated"><strong class="lt iu">【可选】</strong>在继续之前，花点时间阅读一下提供的<a class="ae ky" href="https://www.tensorflow.org/tfx/guide/cli" rel="noopener ugc nofollow" target="_blank"> TFX CLI </a>。目前，<a class="ae ky" href="https://github.com/tensorflow/tfx/issues/2164" rel="noopener ugc nofollow" target="_blank">运行起来非常慢</a>，而且目录结构比它需要的要冗长得多。它也不包括任何关于可再现性和代码重用的注释。</p></blockquote></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="dd7a" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">目录结构及其背后的直觉</h1><ul class=""><li id="b60f" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">$project-name</code>是项目的根目录</li><li id="44ac" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">$project-name/ml</code>包括机器学习相关的东西。</li><li id="ae22" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">$project-name/ml/pipelines</code>包括实际的ML管道代码</li><li id="26e9" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">通常，您可能会发现自己需要管理多个ML管道，例如<code class="fe mj mk ml mm b">$project-name/ml/pipelines/predict-sales</code>和<code class="fe mj mk ml mm b">$project-name/ml/pipelines/classify-fraud</code>或类似的管道。</li><li id="d44d" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated">下面是一个简单的<code class="fe mj mk ml mm b">tree</code>视图:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="fb10" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated"><code class="fe mj mk ml mm b">$project-name/ml/pipelines</code>包括以下内容:</p><ul class=""><li id="39db" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">data</code> →少量代表性培训数据在本地运行，用于测试和CI。如果您的系统没有专门的组件来从某个地方提取数据，那就是真的。如果是这样的话，请确保包含一个带有少量有限项目的抽样查询。</li><li id="cf9e" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">util</code> →跨<code class="fe mj mk ml mm b">$pipeline-name</code>重复使用和共享的代码。不需要包含<code class="fe mj mk ml mm b">input_fn_utils.py</code>和<code class="fe mj mk ml mm b">model_utils.py</code>。在这里使用任何有意义的东西。以下是一些例子:</li></ul><p id="fce8" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">在我自己的项目中，在实用模块上抽象一些部分是有意义的，比如为keras模型构建命名的输入和输出层。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="320a" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">使用张量流变换输出构建服务签名元图。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="b888" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">使用关键字将特征预处理成组。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="2761" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">以及其他常见的重复性任务，如使用Tensorflow数据集api构建输入管道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><ul class=""><li id="10b0" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">cli.py</code> →管道的入口点和命令行界面。以下是使用TFX时需要考虑的一些常见问题。</li></ul><p id="5595" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">通过使用<code class="fe mj mk ml mm b"><a class="ae ky" href="https://github.com/abseil/abseil-py" rel="noopener ugc nofollow" target="_blank">abseil</a></code>,你可以声明和访问全局标志。<a class="ae ky" href="https://abseil.io/docs/python/guides/flags" rel="noopener ugc nofollow" target="_blank">每个模块都定义了特定的标志。这是一个分布式系统。这意味着常见的标志，如<code class="fe mj mk ml mm b">--data_dir=...</code>、<code class="fe mj mk ml mm b">--hparam_tuning</code>、<code class="fe mj mk ml mm b">--pipeline_root</code>、<code class="fe mj mk ml mm b">--ml_metadata_url</code>、<code class="fe mj mk ml mm b">--use_cache</code>、<code class="fe mj mk ml mm b">--train_epochs</code>可以在实际的<code class="fe mj mk ml mm b">cli.py</code>文件中定义。另外，可以在子模块上为每个管道定义更具体的参数。</a></p><p id="e014" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">这个文件充当系统的入口点。它使用<code class="fe mj mk ml mm b">pipeline.py</code>中的内容来设置管道的组件，并根据某些标志(如<code class="fe mj mk ml mm b">--pipeline_name=$pipeline-name</code>或其他配置)提供用户提供的模块文件(在树形示例中为<code class="fe mj mk ml mm b">constants.py</code>、<code class="fe mj mk ml mm b">model.py</code>、<code class="fe mj mk ml mm b">training.py</code>)。</p><p id="78aa" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">最后，对于组装好的管道，它通过使用一个<code class="fe mj mk ml mm b">--runner=</code>标志来调用某个<code class="fe mj mk ml mm b">_runner.py</code>文件。</p><ul class=""><li id="ae9f" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">pipeline.py</code> →参数化管道组件声明和接线。这通常只是一个声明一堆TFX组件并返回一个<code class="fe mj mk ml mm b">tfx.orchestration.Pipeline</code>对象的函数。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><ul class=""><li id="1e5a" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">local_beam_dag_runner.py</code> →使用便携式光束运行器进行本地运行的配置。这通常几乎不需要配置，只需使用<code class="fe mj mk ml mm b">BeamDagRunner</code>。</li><li id="d69b" class="lr ls it lt b lu mn lw mo ly mp ma mq mc mr me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">kfp_runner.py</code> →在Kubeflow管道上运行的配置。这通常包括不同的数据路径和管道输出前缀，并自动绑定ml-metadata实例。</li></ul><blockquote class="ni nj nk"><p id="fa56" class="ms mt nh lt b lu mu ju mv lw mw jx mx nl my mz na nm nb nc nd nn ne nf ng me im bi translated">注意:你可以有更多的运行者，像在GCP上运行的东西，只是配置更多的供应资源，如TPU实例，并行人工智能平台超参数搜索等。</p></blockquote></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h2 id="7bd2" class="of la it bd lb og oh dn lf oi oj dp lj ly ok ol ll ma om on ln mc oo op lp oq bi translated">$管道名称</h2><p id="e081" class="pw-post-body-paragraph ms mt it lt b lu lv ju mv lw lx jx mx ly or mz na ma os nc nd mc ot nf ng me im bi translated">这是用户提供的代码，用于制作不同的模型，安排不同的实验，等等。</p><p id="cfe3" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">由于有了<code class="fe mj mk ml mm b">util</code>子模块，每个管道下的代码应该更精简。不需要把它分成3个以上的文件。但是这并不禁止将你的代码分割成更多的文件。</p><p id="01e3" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">从实验中，我收敛到一个<code class="fe mj mk ml mm b">constants</code>、<code class="fe mj mk ml mm b">model</code>和<code class="fe mj mk ml mm b">training</code>分裂。</p><ul class=""><li id="3499" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">constants.py</code> →申报。要跟踪的训练参数、超参数键和声明、特性键、特性组、评估配置和指标的合理默认值。这里有一个小例子:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><ul class=""><li id="6200" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">model.py</code> →模型定义。通常包含一个<code class="fe mj mk ml mm b">build_keras_model</code>函数，并使用来自<code class="fe mj mk ml mm b">util</code>和<code class="fe mj mk ml mm b">$pipeline-name.constants</code>的导入。这是我最近一个项目中的一个例子:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><ul class=""><li id="8301" class="lr ls it lt b lu mu lw mw ly oc ma od mc oe me mf mg mh mi bi translated">最后，<code class="fe mj mk ml mm b">training.py</code>包括训练模型所需的所有细节。这通常包括:预处理定义、超参数搜索、设置训练数据或模型——并行策略和张量板日志，以及保存用于生产的模块。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="315f" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">就是这样。谢谢你看完！</p><p id="292a" class="pw-post-body-paragraph ms mt it lt b lu mu ju mv lw mw jx mx ly my mz na ma nb nc nd mc ne nf ng me im bi translated">我希望你喜欢读这篇文章，就像我喜欢写它一样。</p></div></div>    
</body>
</html>