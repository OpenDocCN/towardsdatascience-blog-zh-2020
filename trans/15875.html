<html>
<head>
<title>Run StyleGAN2 ADA on an AWS Spot Instance in No Time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">立即在AWS Spot实例上运行StyleGAN2 ADA</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/run-stylegan2-ada-on-an-aws-spot-instance-in-no-time-d2022fc1e119?source=collection_archive---------33-----------------------#2020-11-01">https://towardsdatascience.com/run-stylegan2-ada-on-an-aws-spot-instance-in-no-time-d2022fc1e119?source=collection_archive---------33-----------------------#2020-11-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="478c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在AWS上运行StyleGAN2，与预训练的模型一起玩，或者从头开始训练一个模型。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e6a214bbf038ebcc7feb5be9f4622d8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oczKCfny8fTtHCXzW1pH0g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例使用有限数量的训练数据为几个数据集生成图像，使用StyleGAN2 ADA进行训练(图像来自“<a class="ae kv" href="https://arxiv.org/abs/2006.06676" rel="noopener ugc nofollow" target="_blank">使用有限数据训练生成式对抗网络</a>”论文)。</p></figure><h1 id="5196" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="afb6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">最近NVIDIA发表了一篇名为“<a class="ae kv" href="https://arxiv.org/abs/2006.06676" rel="noopener ugc nofollow" target="_blank">用有限数据训练生成对抗网络</a>的论文，并发布了<a class="ae kv" href="https://github.com/NVlabs/stylegan2-ada" rel="noopener ugc nofollow" target="_blank">代码</a>。他们提出了一种自适应鉴别器增强(ADA)机制，可以稳定StyleGAN2训练，并在小数据集上取得明显更好的结果。</p><p id="adfc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本文中，我们将展示如何在AWS Spot实例上快速运行这段代码。</p><h1 id="bb32" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">启动AWS Spot实例</h1><blockquote class="mp mq mr"><p id="f56d" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">“Spot实例是未使用的EC2实例，其可用价格低于按需价格。因为Spot实例使您能够以大幅折扣请求未使用的EC2实例，所以您可以显著降低Amazon EC2的成本。”</p><p id="5abb" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">— <a class="ae kv" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html" rel="noopener ugc nofollow" target="_blank">现场实例</a>，AWS文档</p></blockquote><p id="ec2e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了启动一个Spot实例并在环境中运行Docker容器，我们将使用<a class="ae kv" href="https://spotty.cloud" rel="noopener ugc nofollow" target="_blank"> Spotty </a>。Spotty是一个开源工具，旨在简化云中深度学习模型的开发。</p><p id="4c9b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用pip安装最新版本:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7066" class="nb kx iq mx b gy nc nd l ne nf">pip install -U spotty</span></pre><p id="dbb0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Spotty只需要在项目的根目录中有一个描述实例和容器参数的<code class="fe ng nh ni mx b">spotty.yaml</code>配置文件。而且我们已经在原回购的<a class="ae kv" href="https://github.com/spotty-playground/stylegan2-ada" rel="noopener ugc nofollow" target="_blank">这个</a>叉里给你准备好了。</p><p id="d01e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用以下命令克隆项目:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="af1c" class="nb kx iq mx b gy nc nd l ne nf">git clone <a class="ae kv" href="https://github.com/spotty-playground/stylegan2-ada" rel="noopener ugc nofollow" target="_blank">https://github.com/spotty-playground/stylegan2-ada</a></span></pre><p id="3d5f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">默认情况下，Spotty将在<code class="fe ng nh ni mx b">us-east-1</code>区域启动一个<code class="fe ng nh ni mx b">p2.xlarge</code> Spot实例，但是，如果需要，您总是可以在<code class="fe ng nh ni mx b">spotty.yaml</code>文件中更改这些参数。</p><p id="f65c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在启动实例之前，请确保您已经安装并配置了AWS CLI。更多信息，请参见<a class="ae kv" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank">安装AWS CLI </a>和<a class="ae kv" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank">配置基础知识</a>。</p><p id="5000" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要启动实例，请从项目根目录运行以下命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="10c0" class="nb kx iq mx b gy nc nd l ne nf">spotty start aws-1</span></pre><p id="9573" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">等待实例启动:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="508d" class="nb kx iq mx b gy nc nd l ne nf">Bucket "spotty-stylegan2-ada-la4gun6uy92a-eu-central-1" was created.<br/>Syncing the project with the S3 bucket...<br/>Creating IAM role for the instance...<br/>Preparing CloudFormation template...<br/>  - volume "stylegan2-ada-aws-1-workspace" will be created<br/>  - availability zone: auto<br/>  - on-demand instance<br/>  - AMI: "Deep Learning AMI (Ubuntu 16.04) Version 35.0" (ami-01955a821cfdfaf73)</span><span id="f62f" class="nb kx iq mx b gy nj nd l ne nf">Volumes:<br/>+-----------+------------+------------+-----------------+<br/>| Name      | Mount Path | Type       | Deletion Policy |<br/>+===========+============+============+=================+<br/>| workspace | /workspace | EBS volume | Retain Volume   |<br/>+-----------+------------+------------+-----------------+</span><span id="3e4a" class="nb kx iq mx b gy nj nd l ne nf">Waiting for the stack to be created...<br/>  - launching the instance... DONE<br/>  - preparing the instance... DONE<br/>  - mounting volumes... DONE<br/>  - syncing project files... DONE<br/>  - building Docker image... DONE<br/>  - starting container... DONE</span><span id="e6ee" class="nb kx iq mx b gy nj nd l ne nf">+---------------------+---------------+<br/>| Instance State      | running       |<br/>+---------------------+---------------+<br/>| Instance Type       | p2.xlarge     |<br/>+---------------------+---------------+<br/>| Availability Zone   | us-east-1e    |<br/>+---------------------+---------------+<br/>| Public IP Address   | 100.26.50.220 |<br/>+---------------------+---------------+<br/>| Purchasing Option   | Spot Instance |<br/>+---------------------+---------------+<br/>| Spot Instance Price | $0.2700       |<br/>+---------------------+---------------+</span><span id="eb73" class="nb kx iq mx b gy nj nd l ne nf">Use the "spotty sh" command to connect to the container.</span></pre><p id="326c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">就是这样！只需连接到容器并使用代码:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="d1af" class="nb kx iq mx b gy nc nd l ne nf">spotty sh aws-1</span></pre><p id="80ca" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Spotty使用<a class="ae kv" href="https://github.com/tmux/tmux/wiki/Getting-Started" rel="noopener ugc nofollow" target="_blank"> tmux </a>，所以如果你的互联网连接断开了，你也不会丢失你的进度。有关tmux的更多信息，请阅读<a class="ae kv" href="https://github.com/tmux/tmux/wiki/Getting-Started" rel="noopener ugc nofollow" target="_blank">官方文档</a>或<a class="ae kv" href="https://tmuxcheatsheet.com/" rel="noopener ugc nofollow" target="_blank"> Tmux备忘单</a>。</p><h1 id="7287" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">例子</h1><h2 id="4a4a" class="nb kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">生成MetFaces图像</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/fba17032529619e0895ea76b4d6d614d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrbx3LJuCEr_rApT2Y2_yw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nw">met faces模型生成的图像。</em></p></figure><p id="6ccc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">连接到容器后，使用以下命令通过预先训练的模型生成图像:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0517" class="nb kx iq mx b gy nc nd l ne nf">python generate.py — outdir=out/metfaces — trunc=1 — seeds=85,265,297,849 \<br/> — network=<a class="ae kv" href="https://nvlabs-fi-cdn.nvidia.com/stylegan2-ada/pretrained/metfaces.pkl" rel="noopener ugc nofollow" target="_blank">https://nvlabs-fi-cdn.nvidia.com/stylegan2-ada/pretrained/metfaces.pkl</a></span></pre><p id="6622" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">该命令将在<code class="fe ng nh ni mx b">out/metfaces/</code>目录中生成4幅图像。您可以使用以下命令将它们下载到您的本地计算机上:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7458" class="nb kx iq mx b gy nc nd l ne nf">spotty download aws-1 -i 'out/*'</span></pre><h2 id="b3c0" class="nb kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">使用FFHQ模型将图像投影到潜在空间</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="c83d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这个例子中，我们将展示如何使用自定义的Spotty脚本。</p><p id="32ff" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要找到一个潜在向量并生成一个进展视频，将一个目标图像<code class="fe ng nh ni mx b">target.jpg</code>放到本地机器上的<code class="fe ng nh ni mx b">data/</code>目录中，并运行以下命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="4349" class="nb kx iq mx b gy nc nd l ne nf">spotty run aws-1 projector-ffhq -p TARGET=data/target.jpg -p OUTPUT_DIR=out/projection</span></pre><p id="a6dc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">该脚本将在一个<a class="ae kv" href="https://github.com/tmux/tmux/wiki/Getting-Started" rel="noopener ugc nofollow" target="_blank"> tmux </a>会话中运行。因此，即使您的互联网连接断开，该进程仍将运行，您可以在以后的任何时间重新连接它。</p><p id="58eb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">脚本完成后，使用<code class="fe ng nh ni mx b">Ctrl+b, x</code>组合键关闭tmux窗口，并将结果下载到您的本地机器:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0c90" class="nb kx iq mx b gy nc nd l ne nf">spotty download aws-1 -i 'out/*'</span></pre></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="7ef6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">完成后，不要忘记停止实例！使用<code class="fe ng nh ni mx b">spotty stop</code>命令。如果不再需要这些数据，请删除EBS卷。</p></div></div>    
</body>
</html>