<html>
<head>
<title>Image Classification using Fastai v2 on Colab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Colab上使用Fastai v2进行图像分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/image-classification-using-fastai-v2-on-colab-33f3ebe9b5a3?source=collection_archive---------18-----------------------#2020-09-24">https://towardsdatascience.com/image-classification-using-fastai-v2-on-colab-33f3ebe9b5a3?source=collection_archive---------18-----------------------#2020-09-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6ea6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一步一步的指导训练和分类图像，只需几行代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d431837f12756acdec785d7451df3339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9DmTWGgWORccHLiE"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">瑞安·卡彭特在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="02c8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="5f01" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><a class="ae ky" href="https://www.fast.ai/" rel="noopener ugc nofollow" target="_blank"> Fastai </a>是一个基于PyTorch构建的库，用于深度学习应用。他们的使命是让深度学习更容易使用，并让更多来自各种背景的人参与进来。他们还为Fastai提供免费课程。</p><p id="0b3a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Fastai v2于8月发布，我将使用它来构建和训练一个深度学习模型，在Colab上对不同的运动领域进行分类，只需几行代码。</p><h1 id="837c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">数据收集</h1><p id="77f7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">首先，我需要收集图像供模型学习。我希望有一个模型来分类不同的运动领域:棒球，篮球，足球，网球和美式足球。我搜索并下载了这些图片，保存在不同的文件夹中，然后上传到Google Drive。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/872cc86ce8b7d62ee0d6ab99ca8e5ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CK9Iom_GHZLbiMef-On6qA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">文件夹包含运动场图片。(图片由作者提供)</p></figure><h1 id="71af" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设置Colab环境</h1><p id="5128" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦数据集准备好了，我就可以开始Colab的工作了。</p><p id="e90c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首次升级fastai，</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="4744" class="my la it mu b gy mz na l nb nc">!pip install fastai --upgrade -q</span></pre><p id="47b9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">并导入<code class="fe nd ne nf mu b">fastai.vision</code>，</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="e3b3" class="my la it mu b gy mz na l nb nc">from fastai.vision.all import *</span></pre><p id="892c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后安装Google Drive并设置路径</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="065f" class="my la it mu b gy mz na l nb nc">from google.colab import drive<br/>drive.mount(‘/content/gdrive’, force_remount=True)<br/>root_dir = ‘gdrive/My Drive/Colab Notebooks/’<br/>base_dir = root_dir + ‘ball_class’<br/>path=Path(base_dir)</span></pre><p id="32a2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我们准备好出发了。</p><h1 id="474a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">数据块和数据加载器</h1><p id="ab73" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Fastai提供了一个中级API: DataBlock来处理数据，它非常容易使用。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="1fb4" class="my la it mu b gy mz na l nb nc">fields = DataBlock(blocks=(ImageBlock, CategoryBlock),<br/>   get_items=get_image_files,<br/>   get_y=parent_label,<br/>   splitter=RandomSplitter(valid_pct=0.2, seed=42),<br/>   item_tfms=RandomResizedCrop(224, min_scale=0.5),<br/>   batch_tfms=aug_transforms())</span></pre><p id="1145" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">可以使用不同的<code class="fe nd ne nf mu b">blocks</code>，在这种情况下，我们使用<code class="fe nd ne nf mu b">ImageBlock</code>作为x，使用<code class="fe nd ne nf mu b">CategoryBlock</code>作为标签。对于不同的应用，也可以使用其他块，例如MultiCategoryBlock、MaskBlock、PointBlock、BBoxBlock、BBoxLblBlock。</p><p id="6f3a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我使用fastai中的<code class="fe nd ne nf mu b">get_image_files</code>函数获得图像的路径作为x，并使用<code class="fe nd ne nf mu b">parent_label</code>方法找到文件夹名称作为标签。fastai中有一些内置函数，你也可以自己写函数来做这个。</p><p id="cc7a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后我用<code class="fe nd ne nf mu b">RandomSplitter</code>分割训练和验证数据集。</p><p id="e1a9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后使用<code class="fe nd ne nf mu b">RandomResizedCrop</code>将图像调整为224，使用<code class="fe nd ne nf mu b">aug_transforms()</code>进行数据扩充。</p><p id="3b40" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是Fastai数据块的一种模板，它非常灵活，你可以根据你的情况改变它。你可以在这里找到详细的<a class="ae ky" href="https://docs.fast.ai/tutorial.datablock" rel="noopener ugc nofollow" target="_blank"> tutoria </a> l。</p><p id="ea4a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">准备好数据块后，我们可以创建数据加载器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/082d3808e74538fb1186a29146dffde3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G7qaUDvlxqGdEJJM91-LvA.png"/></div></div></figure><p id="cbe4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">并使用<code class="fe nd ne nf mu b">vocab</code>检查标签</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/47b98f316d34b96a3617e32f48e8f083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Dksh8c6VebWELZStoHNyg.png"/></div></div></figure><p id="d322" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">展示一些带有标签的图片</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/8f0331be472be70ce412f75e12bf41dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M0CD3pmCB4eAOx63u1DKnA.png"/></div></div></figure><h1 id="61f5" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">火车</h1><p id="6e17" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在我们准备好训练了。</p><p id="aa60" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我使用resnet34创建了一个CNN学习者:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="153d" class="my la it mu b gy mz na l nb nc">learn = cnn_learner(dls, resnet34, metrics=error_rate)</span></pre><p id="77e9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">并使用<code class="fe nd ne nf mu b">lr_find()</code>找到合适的学习率</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/a09288e5d7a9fdd983f20f15dfb199bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LTaf0EI7Xn5LyPLg3BKJSA.png"/></div></div></figure><p id="e23e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后我们可以使用<code class="fe nd ne nf mu b">fit_one_cycle</code>训练模型</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/b110188aa63ba7797223de8019c92431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55O3ShuNSN44R7cadGGC6A.png"/></div></div></figure><p id="a76e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">只有经过5个历元，我们才能达到&gt; 90%的准确率。</p><p id="cde7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我们可以解冻网络，训练整个网络。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/49f8d4648779ebadfa987c21697c81e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U3sKQt6dWr1fpsKIq0VbyA.png"/></div></div></figure><p id="4317" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们来看看，仅仅经过几个纪元，我们就达到了95%的准确率。</p><h1 id="201c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解释</h1><p id="542c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们也可以解释这个模型。混淆矩阵可以用以下公式绘制:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/ad6a23002070f99e544926d40a1e4fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qyUhCIOKzMhMARztoat7pQ.png"/></div></div></figure><p id="df98" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们也可以用这个来看损失最高的图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/540c7a57c97589ebbb387b75293b5797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SYg4NhCvjyKKswqRQC8oHg.png"/></div></div></figure></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="e874" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">本文展示了一个使用fastai进行图像分类的简单快捷的例子。使用这个强大的库可以创建更复杂和有趣的应用程序。</p><p id="9657" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢阅读，编码快乐。</p></div></div>    
</body>
</html>