<html>
<head>
<title>Mask Detection from the edge to the cloud — with TensorFlow and Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从边缘到云的遮罩检测—使用TensorFlow和Kafka</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mask-detection-from-the-edge-to-the-cloud-with-tensorflow-and-kafka-1b6668f15a60?source=collection_archive---------47-----------------------#2020-10-13">https://towardsdatascience.com/mask-detection-from-the-edge-to-the-cloud-with-tensorflow-and-kafka-1b6668f15a60?source=collection_archive---------47-----------------------#2020-10-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="91d1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Raspberry Pi和Coral USB edge TPU在边缘进行模型推断</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/23a28e30f7ce6b59be658dde2d37d5b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KT4QQYHmAhzoNu1B4jWlAw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Benedikt Geyer 在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a9cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated"><span class="l lw lx ly bm lz ma mb mc md di">一个</span>在这个社会距离越来越远的时代，科技更新了它建立一个更安全世界的承诺。热像仪、掩模检测机制不是COVID疫情的解决方案，但可以帮助检测风险区域，并通过调整当地公共政策来减缓集群的增长。</p><p id="3a3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我概述了如何基于配备摄像头和人脸检测人工智能的物联网设备网络构建一个系统，以识别某个空间内的人们是否戴着面罩，并收集此类事件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi me"><img src="../Images/3c666ffc1ea6805fafa17b2fa188e705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*EB6PHqkWH1QrfGnMpwYDhg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">演示—在Pi上运行屏蔽检测，并向Kafka主题发出和发布警报—图片由作者提供</p></figure><p id="8a23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本项目中使用的工具有:</p><ul class=""><li id="598b" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">面向人脸检测模型(TensorFlow)的边缘Python。</li><li id="31e2" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">剩下的代码用<a class="ae ky" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>编程语言。</li><li id="cedb" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><a class="ae ky" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>用于服务间的异步通信。</li><li id="4b9c" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><a class="ae ky" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank">用于模式定义和消息串行化的协议缓冲器</a>。</li><li id="80dc" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">用于存储的SQL数据库(<a class="ae ky" href="https://www.sqlite.org/index.html" rel="noopener ugc nofollow" target="_blank"> SQLite </a>在边缘，<a class="ae ky" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>在云端)。</li></ul><p id="1956" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个项目你需要一个<a class="ae ky" href="https://en.wikipedia.org/wiki/Raspberry_Pi" rel="noopener ugc nofollow" target="_blank">树莓Pi </a> 4和它的<a class="ae ky" href="https://projects.raspberrypi.org/en/projects/getting-started-with-picamera" rel="noopener ugc nofollow" target="_blank">相机</a>。我还使用了一个<a class="ae ky" href="https://coral.ai/products/accelerator/" rel="noopener ugc nofollow" target="_blank"> Coral USB加速器</a>来更快地推断圆周率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/9a39499bfbbad2f212fef840d54a5206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rwtlHxlcCdomMm5MI66CXQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用于收集和处理事件“这个人没有戴面具”的架构的大图—事件驱动的架构—图片由作者提供</p></figure><p id="d52c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与任何架构和工具选择一样，这是一个固执己见的问题。我在文章的最后略微阐述了我选择的工具的优点、缺点、局限性和优势。你有什么烦心事吗？大家在评论里讨论一下吧。😉</p><h1 id="9e8e" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">深潜</h1><p id="72fc" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">现在，让我们看看如何实现这个体系结构的每个组件。从逻辑上讲，我们可以把这个系统分成三个不同的部分。完整的代码可以从我的GitHub获得。</p><ol class=""><li id="03f3" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu nr ml mm mn bi translated">从Raspberry Pi摄像头馈送中检测某人是否戴着面具。【github.com/fpaupier/pi-mask-detection】-<a class="ae ky" href="https://github.com/fpaupier/pi-mask-detection" rel="noopener ugc nofollow" target="_blank"/></li><li id="da49" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu nr ml mm mn bi translated">从Pi到Google Cloud引擎的事件收集和分发:<br/>-<a class="ae ky" href="https://github.com/fpaupier/alertDispatcher" rel="noopener ugc nofollow" target="_blank">github.com/fpaupier/alertDispatcher</a>-<br/>-<a class="ae ky" href="https://github.com/fpaupier/alertIngress" rel="noopener ugc nofollow" target="_blank">github.com/fpaupier/alertIngress</a></li><li id="d37f" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu nr ml mm mn bi translated">事件的进一步处理:<br/>-<a class="ae ky" href="https://github.com/fpaupier/notifyMask" rel="noopener ugc nofollow" target="_blank">github.com/fpaupier/notifyMask</a></li></ol><p id="d5c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们重点关注这些组件之间的联系。</p><h2 id="6ecc" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">1.掩模检测</h2><p id="04d3" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">在我们系统的边缘，配备了一个Pi，它的摄像头检测是否有<em class="oe">事件</em>发生。我将事件定义为:“<em class="oe">某人没有戴面具。”</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/efc67b4102998571c60fc3c22aa75d4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YoL7IGk8MaCNoABWGuL32Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="8e9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了检测某人是否戴着面具，我们遵循以下步骤:</p><ol class=""><li id="1b2c" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu nr ml mm mn bi translated">检测当前画面中是否有人脸(<a class="ae ky" href="https://ai.googleblog.com/2018/04/mobilenetv2-next-generation-of-on.html" rel="noopener ugc nofollow" target="_blank"> MobileNet v2 </a>)</li><li id="80c4" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu nr ml mm mn bi translated">如果是，将图像裁剪到该面部边界框。</li><li id="a152" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu nr ml mm mn bi translated">在裁剪的面上应用遮罩/无遮罩二元分类器。(<a class="ae ky" href="https://github.com/fpaupier/pi-mask-detection/tree/master/models/mask_detector" rel="noopener ugc nofollow" target="_blank">型号</a>为此项目培训)</li><li id="875a" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu nr ml mm mn bi translated">如果没有检测到掩码，则创建一个事件，并将其存储在本地存储中。</li></ol><p id="df33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">逻辑详见我的<code class="fe of og oh oi b"><a class="ae ky" href="https://github.com/fpaupier/pi-mask-detection/blob/master/detect_mask.py" rel="noopener ugc nofollow" target="_blank">detect_mask.py</a></code>的<code class="fe of og oh oi b">main()</code>功能</p><h2 id="2cf6" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">2.收集事件</h2><p id="87f7" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">一旦Pi记录了一个事件，我们就将其发送到服务器进行存档和进一步处理。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/28ac5abbee47db5add78628e69fc6934.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuZTLO_PI9_zkCQii95Rng.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="da26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我们可以在Pi上直接运行通知系统。尽管如此，我们在这里的目标是说明一个由几个物联网设备报告事件的系统。进一步的处理是在云上完成的，以便在1)边缘的事件收集和2)受控环境中的高级处理之间进行适当的分离。</p><p id="830a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑这部分的两个存储库:</p><ul class=""><li id="cfff" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated"><a class="ae ky" href="https://github.com/fpaupier/alertDispatcher" rel="noopener ugc nofollow" target="_blank">github.com/fpaupier/alertDispatcher</a>为圆周率上运行的代码发布了一个卡夫卡主题的提示。</li><li id="b260" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><a class="ae ky" href="https://github.com/fpaupier/alertIngress" rel="noopener ugc nofollow" target="_blank">github.com/fpaupier/alertIngress</a>用于在服务器上运行的代码，订阅Kafka主题并将来自不同设备的警报存储到PostgreSQL实例中。</li></ul><p id="ce1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个设备将其事件发布到Kafka主题—“<em class="oe">警报—主题</em>”—用于Pi和警报入口服务之间的异步通信。事件消息符合使用<a class="ae ky" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank">协议缓冲区定义的模式。</a></p><p id="ee17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在云上，alert ingress服务订阅了<em class="oe"> alert-topic </em>，并将传入的事件存档在PostgreSQL中。然后，入口服务发布通知服务将使用的消息。</p><h2 id="08f5" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">3.通知服务</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/e606cbaaf30d27cbd336c996aca7e097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EjDtxbCmxaKBqFwXPbF7PA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="3d62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经将事件存档在云中，现在该怎么办？让我们添加一个通知服务，向管理员发送包含事件摘要的电子邮件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/64f403cf49c892ddb1b5a1c229cf3d77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfU78sXVFjk7d1IzhNq4pg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通知服务发送的电子邮件-作者图片</p></figure><p id="93b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个有趣的后续工作是构建一个地理可视化工具来分析每个位置和时间的事件📍🗺</p></div><div class="ab cl ok ol hx om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="im in io ip iq"><h2 id="d94e" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">改进的余地</h2><p id="695c" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">这个原型说明了这个概念，但不是一个生产就绪的基础设施。将这一概念应用到生产中需要考虑的关键因素有:</p><ul class=""><li id="8d06" class="mf mg it lb b lc ld lf lg li mh lm mi lq mj lu mk ml mm mn bi translated">事件重复数据删除——当前的实施为单个警报发送多个通知，因为我们为每个引发的警报发送一封电子邮件。某个没戴面具的人可能会出现在摄像机视频中一段时间。可以在服务器级别实施重复数据消除策略。</li><li id="6969" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">想想您的<a class="ae ky" href="https://en.wikipedia.org/wiki/Retention_period" rel="noopener ugc nofollow" target="_blank">保留策略</a> —定义一个合理的期限，在此期限内，您可以存储警报，然后再删除它们。您不希望将敏感数据(如人脸)保留一段不确定的时间。</li><li id="0eda" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated"><a class="ae ky" href="https://docs.cloudera.com/csp/2.0.1/schema-registry-overview/topics/csp-schema_registry_overview.html" rel="noopener ugc nofollow" target="_blank">模式注册中心</a> —模式注册中心确保跨服务的一致消息定义。更新和向后兼容性不是小事。如果您决定更改、添加或删除警报事件中的字段，该怎么办？您如何将这种变化传播到您的物联网设备中？</li><li id="58ec" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">机器学习模型管理-您在边缘推送和部署的模型可能会随着时间的推移而<a class="ae ky" href="https://en.wikipedia.org/wiki/Concept_drift" rel="noopener ugc nofollow" target="_blank">漂移</a>并看到其性能下降，从而导致误报或戴面具的人未被报告。检查<a class="ae ky" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> ML流程</a>项目，了解关于该主题的见解。</li><li id="9914" class="mf mg it lb b lc mo lf mp li mq lm mr lq ms lu mk ml mm mn bi translated">设备注册流程—可以手动部署和设置您的第一批设备。十几年后它变成了挑战，一百年后它变成了噩梦。考虑为加入您的物联网设备群的设备自动执行入职流程(下载ML模型，获取Kafka证书)</li></ul><h2 id="dcef" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">工具</h2><p id="0025" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated"><strong class="lb iu">语言选择— </strong>为什么选择Python和Go？Python便于与TensorFlow集成。请使用它的强类型和对网络相关操作的本机支持。</p><p id="dadc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">异步消息队列选择</strong> —为什么是卡夫卡？许多其他解决方案在内存占用方面更轻量级，可以在边缘实现这个功能(<a class="ae ky" href="https://mqtt.org/" rel="noopener ugc nofollow" target="_blank"> MQTT </a>)。但是，随着今天日益增长的计算能力的边缘，为什么烦恼呢？一个树莓Pi 4有8Go内存。</p><p id="06f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">模式定义策略— </strong>为什么选择Protobufs？我明白你的意思；JSON使用起来会更舒服，而且在这里也能做到。为了像这样的概念验证，使用JSON将省去很多麻烦，因为我们处理的是单个设备。然而，模式定义和一致性是事件驱动架构的一个关键特性，protobufs使这变得更容易。</p></div><div class="ab cl ok ol hx om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="im in io ip iq"><h2 id="916c" class="ns mv it bd mw nt nu dn na nv nw dp ne li nx ny ng lm nz oa ni lq ob oc nk od bi translated">伦理考虑</h2><p id="42f7" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">这种想法有助于定位和缓解集群的增长，但可能会对个人隐私构成严重威胁。</p><p id="daa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于负责任的机器学习的资源变得越来越容易获得，我邀请你在构建基于人工智能的系统时记住这些指导原则。</p><p id="0cfc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另请注意，通用数据保护条例(<a class="ae ky" href="https://eur-lex.europa.eu/eli/reg/2016/679/oj" rel="noopener ugc nofollow" target="_blank"> GDPR </a>)对个人数据的收集和处理进行了严格的规定。</p><blockquote class="or"><p id="41a2" class="os ot it bd ou ov ow ox oy oz pa lu dk translated">没有良知的科学是永恒的— <em class="pb"> </em> <a class="ae ky" href="https://en.wikipedia.org/wiki/Fran%C3%A7ois_Rabelais" rel="noopener ugc nofollow" target="_blank"> <em class="pb">弗朗索瓦·拉伯雷</em> </a> <em class="pb">在</em> <a class="ae ky" href="https://en.wikipedia.org/wiki/Gargantua_and_Pantagruel" rel="noopener ugc nofollow" target="_blank"> <em class="pb">的《巨大的生命与巨大的痛苦》</em> </a></p></blockquote></div></div>    
</body>
</html>