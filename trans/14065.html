<html>
<head>
<title>How To Compile TensorFlow 2.3 with CUDA 11.1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用CUDA 11.1编译TensorFlow 2.3</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-compile-tensorflow-2-3-with-cuda-11-1-8cbecffcb8d3?source=collection_archive---------5-----------------------#2020-09-28">https://towardsdatascience.com/how-to-compile-tensorflow-2-3-with-cuda-11-1-8cbecffcb8d3?source=collection_archive---------5-----------------------#2020-09-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c924" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当一切都不工作时，将它用作TensorFlow安装的最后手段</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1183f5ef9ae0ed09ab3545bb35cea1c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYSfS4PQu1Y4smrI9F-ebQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@robertbye?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">罗伯特拜拜</a>在<a class="ae ky" href="https://unsplash.com/s/photos/mess?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="3cf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TensorFlow是一个用于构建机器学习项目的框架，非常易于使用。然而，这并不意味着它总是很容易设置，尤其是当你在玩前沿功能的时候。</p><h1 id="7ed6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">这篇文章是为了将来的参考</h1><p id="e7a6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在过去几年中，我多次遇到TensorFlow在某些环境下无法工作的情况。每次发生这种情况，我都要花几个小时在网上搜索支离破碎的信息，还要额外花几个小时把碎片拼在一起。这一次，我决定写一个详细的教程，以挽救未来的情况下，没有工作。</p><h1 id="9e15" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">这次出了什么问题？</h1><p id="2c96" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">今天早些时候，我用一个基于GAN的网络构建了一个快速实验，我发现实验性的Keras预处理API很有帮助，但不幸的是，它刚刚被添加到2.3版中(我是在2.2版上):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/2c9b2a0028b5efe1e860d1621a124741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_3CwyEj8SC-PnvKEQwpJA.png"/></div></div></figure><p id="ecb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一个普通的Python包，一个简单的<code class="fe mt mu mv mw b">pip install -U tensorflow</code>就可以了，如果没有，<code class="fe mt mu mv mw b">conda install tensorflow</code>将是备份，但是，不幸的是，TensorFlow一点也不普通。</p><p id="a23a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在完成了<code class="fe mt mu mv mw b">pip install -U</code>之后，各种CUDA和TensorRT“未找到”的错误开始出现，更糟糕的是，ANACONDA还在之前的版本中。</p><p id="e78f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在努力修复这些库一段时间后，我决定从源代码编译TensorFlow可能是挽救这种局面的唯一方法。</p><p id="64eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们要从源代码编译，为什么不同时使用最新的CUDA和tensort(那些是TensorFlow依赖的Nvidia库)，所以计划是安装TensorFlow 2.3和CUDA 11.1、CuDNN 8.0和TensorRT 7(预编译TensorFlow使用CUDA 10.1、CuDNN 7.6和TensorRT 6)。</p><h1 id="02d8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">步骤1:安装开发库</h1><p id="8680" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">因为我们正在编译Python库，所以需要开发库和头文件。我们可以得到那些带有<code class="fe mt mu mv mw b">sudo apt install python3-dev python3-pip</code>的。</p><p id="fb88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同时，我们还需要TensorFlow的纯Python部分，是外挂而不是编译的。我们可以安装它们:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="59c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要Nvidia库:</p><ul class=""><li id="0413" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><a class="ae ky" href="https://developer.nvidia.com/cuda-toolkit" rel="noopener ugc nofollow" target="_blank"> CUDA 11.1 </a></li><li id="7cdc" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://developer.nvidia.com/rdp/cudnn-download#" rel="noopener ugc nofollow" target="_blank"> CuDNN 8 </a></li><li id="3f43" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://developer.nvidia.com/nvidia-tensorrt-7x-download" rel="noopener ugc nofollow" target="_blank"> TensorRT 7.2 </a>(注意:用zip文件而不是DEB文件安装，因为它会抱怨CUDA版本是11.1而不是11.0)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/ceca45cacb2a08e85e894a9cb4abfc18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-4doLF2vcHr7_QvqqI4UA.png"/></div></div></figure><p id="c8cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:你不必得到确切的版本，因为本教程是关于安装任何最新版本。</p><p id="117e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后需要的是Bazel，TensorFlow使用的构建系统，你可以在这里找到如何安装它<a class="ae ky" href="https://docs.bazel.build/versions/master/install-ubuntu.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="b26a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:到目前为止，您需要Bazel 3.1.0来编译TensorFlow，但是TensorFlow会在编译设置期间提示您更改Bazel版本的命令。</p><h1 id="9f2e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">步骤2:配置安装并开始编译</h1><p id="ab27" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">由于我们是从源代码编译，所以需要先用<code class="fe mt mu mv mw b">git clone <a class="ae ky" href="https://github.com/tensorflow/tensorflow.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow.git</a></code>获取源代码。</p><p id="2ca0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了配置编译，我们需要在克隆的存储库中运行<code class="fe mt mu mv mw b">./configure</code>。</p><p id="7d3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该命令将提示我们一些选项，我们需要选择CUDA为版本11，TensorRT为版本7，并提供以下路径来查找Nvidia库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="4100" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:列表中的最后一个是TensorRT 7.2 zip文件解压缩到的位置。</p><p id="e277" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成配置后，我们可以使用以下命令开始编译TensorFlow:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="6446" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">步骤3:修复错误</h1><p id="671c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">不幸的是，一旦开始编译，各种错误就会开始出现，但最有可能的是，您会看到类似这样的内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="5b49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是说，没有找到所需的特定版本的Nvidia库。如果您严格遵循了上面的库安装步骤，那么您应该能够排除它确实丢失的可能性，剩下的只是TensorFlow正在对它们如何版本化做出一些假设。</p><p id="541c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我来说，就是抱怨<code class="fe mt mu mv mw b">libcudart.so.11.1</code>不见了。用<code class="fe mt mu mv mw b">locate libcudart.so</code>快速搜索发现，不是11.1，我有<code class="fe mt mu mv mw b">libcudart.so.11.0</code>。这意味着，尽管CUDA在11.1版本中，但<code class="fe mt mu mv mw b">libcudart.so</code>可能没有变化，所以它仍然是11.0。</p><p id="4e55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了解决这个问题，我们需要打开<code class="fe mt mu mv mw b">third_party/gpus/cuda_configure.bzl</code>(感谢<a class="no np ep" href="https://medium.com/u/1f89df37e1b0?source=post_page-----8cbecffcb8d3--------------------------------" rel="noopener" target="_blank"> Pwuertz </a>指出一个错别字！)并替换以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="678c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:如果您遇到问题的库不是<code class="fe mt mu mv mw b">cudart</code>，您仍然可以通过修改其他组件的配置来修复它。</p><p id="23f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">修复后，它应该开始编译(编译需要一段时间，所以要准备好过夜)。</p><p id="74ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要点是，对于TensorFlow安装，您应该总是从Anaconda或Virtualenv安装开始，如果它不起作用，并且您可以忍受一直使用docker，那么使用官方Docker映像，但是如果所有这些都不起作用，请将这篇文章作为您的最后手段，这样至少您可以开始构建东西。</p><h1 id="5eb2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">更新</h1><p id="63d6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">感谢<a class="no np ep" href="https://medium.com/u/1f89df37e1b0?source=post_page-----8cbecffcb8d3--------------------------------" rel="noopener" target="_blank"> Pwuertz </a>指出，有时你也必须为<code class="fe mt mu mv mw b">libcublas</code>指定“11”，因为Nvidia将后缀减少为<code class="fe mt mu mv mw b">libcublas.so.11</code>，但TensorFlow使用<code class="fe mt mu mv mw b">libcublas.so.11.2.1.74</code>或其他变量，这取决于确切的版本。</p><h1 id="3eeb" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><p id="66d2" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">感谢来自以下人员的精彩建议:</p><ul class=""><li id="3a23" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><a class="ae ky" href="https://github.com/tensorflow/tensorflow/issues/43588" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow/issues/43588</a></li><li id="b780" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://github.com/tensorflow/tensorflow/issues/26289" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow/issues/26289</a></li><li id="2393" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://github.com/tensorflow/tensorflow/issues/26150" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow/issues/26150</a></li></ul></div></div>    
</body>
</html>