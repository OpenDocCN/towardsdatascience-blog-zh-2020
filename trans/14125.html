<html>
<head>
<title>Leveraging BigQuery with Google Analytics Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用BigQuery和Google分析数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/leveraging-bigquery-with-google-analytics-data-b6085d8415b?source=collection_archive---------17-----------------------#2020-09-29">https://towardsdatascience.com/leveraging-bigquery-with-google-analytics-data-b6085d8415b?source=collection_archive---------17-----------------------#2020-09-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a1583e5985eba07269422a5c3f00659b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*reTVqP90zrBxF3GMMUKJTg.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者照片</p></figure><p id="ce77" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">谷歌分析是一个了不起的工具。它使您能够让数据为您服务，获得更广泛的图片，并更好地了解您的访问者。</p><p id="d9b5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">当你对这个“报告”工具有更多期望时，问题就来了。我会告诉你为什么你应该考虑利用BigQuery(或类似的工具)以及你的谷歌分析数据。</p></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><p id="d6ac" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">目录:</strong></p><p id="e124" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">A.为什么要将BigQuery与谷歌分析数据结合使用？</p><p id="7786" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">B.用BigQuery查询Google Analytics数据</p><p id="bd2b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一.如何运作？</p><p id="6966" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">二。先决条件</p><p id="17e6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">三。我们来查询一下</p></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><h2 id="b7d6" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated">A.为什么要将BigQuery与谷歌分析数据结合使用？</h2><h2 id="316e" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated">3个原因:</h2><p id="0268" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated"><strong class="kh iu"> 1。处理随时间变化:</strong></p><p id="d2fd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">随着时间的推移，每个网站都会经历变化。与此同时，存储数据的方式也将发生变化。因此，为了进行苹果之间的比较，您需要将数据转换成一个通用的视图。</p><p id="54ab" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu"> 2。数据采样</strong></p><p id="b9ea" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你依赖Google Analytics，你会知道GA经常对其数据进行采样。只要你没有足够的建模数据或者你使用的是现成的报告，GA会给你100%准确的数据。只有当你开始过滤数据或增加其基数时，谷歌分析才会开始按比例对数据进行采样，以保持其速度。</p><p id="f114" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">*采样:在采样过程中，GA会根据较小的样本空间而不是整个数据池返回指标。</p><p id="e43d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu"> 3。缺乏数据操作和转换</strong></p><p id="c6ab" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一旦数据存储在分析服务器中，您将无法使用公式或其他逻辑修改数据。这一点非常重要，因为对于一个拥有大量受众和多种内容类别的网站来说，数据分类和转换的空间总是很大。此外，在一些情况下，您需要清理数据。这些场景可能是人为错误、实施出错、谷歌分析遗漏的机器人。如果你想知道更多关于识别被谷歌分析遗漏的机器人的信息，<a class="ae mi" href="https://sumilmehta.in/blog/bot-detection-recaptcha/?utm_source=analytics_vidhya&amp;utm_medium=referral&amp;utm_campaign=guest_post" rel="noopener ugc nofollow" target="_blank">阅读我关于这个主题的文章</a>。</p></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><h2 id="eef2" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated">B.利用BigQuery</h2><p id="64e0" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">BigQuery是一个基于云的数据仓库工具，可以让你以闪电般的速度存储和分析数Pb的数据。对于GA 360用户，Google为你提供了将网站每日会话数据转储到BigQuery的选项。你可以利用这些数据来克服谷歌分析的局限性。</p><p id="1cf7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">一、如何运作？:</strong></p><ol class=""><li id="61cd" class="mj mk it kh b ki kj km kn kq ml ku mm ky mn lc mo mp mq mr bi translated">Google Analytics每天都将其会话数据存储在BigQuery服务器中。这个会话数据是一个表，其中每一行都专用于一次用户访问，而每一列都代表一个不同的维度或指标，可以重复和嵌套。大致来说:A列:访问者Id或cookie id，B列:会话日期。当表在一行中存储所有的点击量(事件)、页面浏览量和定制维度时，它就变得复杂了。这就是BigQuery不同于平面表系统的地方。</li></ol><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/66595b170ec1ad20e9e60bd52abf572a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNHBdGL1VMDQICf_EYvXHQ.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">BigQuery中的Google Analytics数据示例(作者提供图片)</p></figure><p id="a0d2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">2.这个表作为我们的输入。首先，我们通过展平这个复杂的嵌套数据来取消嵌套和缝合。然后，我们根据需要把它缝回去。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/9a716eab92157d564811e33e09e8f8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cduSD-43RlFieB9MAfD-xw.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">扁平化数据(作者照片)</p></figure><p id="2398" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">3.作为一个合适的基于云的ETL工具，它为我们提供了很好的转换特性，并以很快的速度返回未采样的数据。</p><p id="5bd3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在接下来的章节中，你将深入了解Google Analytics如何存储和计算所有报告。期待一些创造性的想法出现在你的脑海中，找到谷歌分析无法提供的答案。</p><h2 id="c9e0" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated">二。先决条件</h2><p id="9708" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">下面几节将期待谷歌分析指标的基本知识和SQL的一些知识。这是一篇来自“LovesData”的Benjamin的伟大文章，用来修正<a class="ae mi" href="https://www.lovesdata.com/blog/google-analytics-glossary" rel="noopener ugc nofollow" target="_blank"> Google Analytics Metrics </a>概念。我最喜欢的教程网站:W3 School提供的另一个很棒的修改SQL概念的<a class="ae mi" href="https://www.w3schools.com/sql/" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><h2 id="a5b6" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated">三。让我们查询</h2><p id="48ca" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">下面是存储在BigQuery中的Google Analytics 数据的<a class="ae mi" href="https://support.google.com/analytics/answer/3437719?hl=en" rel="noopener ugc nofollow" target="_blank">详细模式。我将首先从高级和基本的指标开始，如会话、用户等，然后逐渐转向更深入和复杂的指标。有两种方法可以计算高级指标:第一种方法是查询表中的“总计”记录；第二种方法是查询扁平表(将复杂数据结构解析为扁平表)并应用相关逻辑。对于这篇博客中的所有指标，我将采用第二种方法。我们将使用这个特殊的</a><a class="ae mi" href="https://bigquery.cloud.google.com/table/bigquery-public-data:google_analytics_sample.ga_sessions_20170801" rel="noopener ugc nofollow" target="_blank">数据集</a>进行学习</p><ol class=""><li id="4aa8" class="mj mk it kh b ki kj km kn kq ml ku mm ky mn lc mo mp mq mr bi translated">用户</li></ol><p id="7d71" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">该表包含一个名为“完整访问者Id”的字段。这只是一个cookie ID，对于机器上的浏览器是唯一的。因此，如果您可以找到这些id的不同数量，您就可以找到用户的数量。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="b84d" class="lk ll it mz b gy nd ne l nf ng">Select<br/>Count ( Distinct fullVisitorId) as Users</span><span id="93e7" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span></pre><p id="5909" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">2.会议</p><p id="9762" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">除了“完整访问者id”字段，该表还包含“visitNumber”等字段，这是该用户特定会话的序列号(完整访问者Id)。此外，“visitStartTime”表示会话开始的时间。如果我们将这些术语连接起来并找到不同的计数，我们将得到会话的数量。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="095f" class="lk ll it mz b gy nd ne l nf ng">Select</span><span id="810e" class="lk ll it mz b gy nh ne l nf ng">Count ( Distinct</span><span id="f5a0" class="lk ll it mz b gy nh ne l nf ng">CASE<br/>WHEN totals.visits=1 THEN<br/>CONCAT( fullvisitorid,"-",CAST(visitNumber AS string),"-",CAST(visitStartTime AS string))</span><span id="be1e" class="lk ll it mz b gy nh ne l nf ng">End)<br/>as Sessions</span><span id="4b0b" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span></pre><p id="714d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">3.浏览量</p><p id="2226" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了计算浏览的页面数量，我们将通过计算会话中页面浏览点击/事件的次数来使用“点击类型”字段。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="db89" class="lk ll it mz b gy nd ne l nf ng">Select</span><span id="943b" class="lk ll it mz b gy nh ne l nf ng">SUM(<br/>Case when hits.type="PAGE" then 1 else 0 END<br/>)</span><span id="7cab" class="lk ll it mz b gy nh ne l nf ng">as Pageviews</span><span id="5f28" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span></pre><p id="6025" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">4.独特的浏览量</p><p id="1af1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">通过忽略一个会话的重复浏览量来计算唯一浏览量。如果页面A在一个会话中有2次浏览量，A的唯一浏览量将只有1次。</p><p id="9e91" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，我们需要会话标识符和页面标识符的组合，并对该组合进行唯一计数。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="238a" class="lk ll it mz b gy nd ne l nf ng">Select</span><span id="1c24" class="lk ll it mz b gy nh ne l nf ng">Count ( Distinct <br/>CONCAT( fullvisitorid,"-",CAST(visitNumber AS string),"-",CAST(visitStartTime AS string),"-",hits.page.pagePath)<br/>)</span><span id="cdd9" class="lk ll it mz b gy nh ne l nf ng">as Unique_Pageviews</span><span id="e8d9" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span></pre><p id="d1a1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">5.跳出率</p><p id="553b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">退回是指只有一个交互事件的会话。为了计算这一点，我们将计算总反弹，并除以会话数。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="6dbe" class="lk ll it mz b gy nd ne l nf ng">SELECT<br/>Page,</span><span id="7511" class="lk ll it mz b gy nh ne l nf ng">( ( bounces / sessions ) * 100 ) AS Bounce_Rate,<br/>Sessions</span><span id="c87f" class="lk ll it mz b gy nh ne l nf ng">FROM (</span><span id="c362" class="lk ll it mz b gy nh ne l nf ng">SELECT</span><span id="54ce" class="lk ll it mz b gy nh ne l nf ng">hits.page.pagePath AS Page,</span><span id="aff2" class="lk ll it mz b gy nh ne l nf ng">Count ( Distinct<br/>CASE<br/>WHEN totals.visits=1 THEN<br/>CONCAT( fullvisitorid,"-",CAST(visitNumber AS string),"-",CAST(visitStartTime AS string))<br/>End)<br/>as Sessions,</span><span id="bd93" class="lk ll it mz b gy nh ne l nf ng">SUM ( totals.bounces ) AS Bounces</span><span id="9ccf" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801` , UNNEST(hits) AS hits</span><span id="89df" class="lk ll it mz b gy nh ne l nf ng">GROUP BY<br/>Page )<br/>ORDER BY<br/>Sessions DESC</span></pre><p id="8675" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">6.入口</p><p id="dddb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">入口是通过使用一个名为isEntrance的字段来计算的。如果命中是会话的第一个，则该字段的值为“真”。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="d96a" class="lk ll it mz b gy nd ne l nf ng">Select<br/>hits.page.pagePath AS Page,</span><span id="5dae" class="lk ll it mz b gy nh ne l nf ng">SUM(<br/>CASE<br/>WHEN hits.isEntrance = TRUE and hits.type="PAGE" AND totals.visits=1 THEN 1<br/>ELSE 0<br/>END<br/>) AS Entrances,</span><span id="7939" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span><span id="d131" class="lk ll it mz b gy nh ne l nf ng">group by Page</span></pre><p id="5b10" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">7.出口</p><p id="cf62" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">类似地，也有一个专用于出口的字段。如果点击是该会话的最后一次点击，则设置为TRUE。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="aa43" class="lk ll it mz b gy nd ne l nf ng">Select<br/>hits.page.pagePath AS Page,</span><span id="69a3" class="lk ll it mz b gy nh ne l nf ng">SUM(<br/>CASE<br/>WHEN hits.isExit = TRUE and hits.type="PAGE" AND totals.visits=1 THEN 1<br/>ELSE 0<br/>END<br/>) AS Exits,</span><span id="2d22" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span><span id="aa14" class="lk ll it mz b gy nh ne l nf ng">group by Page</span></pre><p id="c3cd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">8.平均会话持续时间</p><p id="6ece" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">用于计算参与度指标Avg。会话持续时间，我们将首先计算每个会话的总持续时间。这是通过找到该会话中交互点击的点击时间来完成的。然后，将这个持续时间汇总到一个维度(如Channel)中，并除以会话数。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="b7b2" class="lk ll it mz b gy nd ne l nf ng">Select Channel, SUM(Total_Session_Duration)/Count(Distinct Session) as Avg_Session_Duration<br/>from(</span><span id="2a29" class="lk ll it mz b gy nh ne l nf ng">Select</span><span id="180b" class="lk ll it mz b gy nh ne l nf ng">Channel, Session,</span><span id="01f0" class="lk ll it mz b gy nh ne l nf ng">MAX(hitTIme)as Total_Session_Duration</span><span id="0a1e" class="lk ll it mz b gy nh ne l nf ng">from(</span><span id="810a" class="lk ll it mz b gy nh ne l nf ng">Select</span><span id="62bb" class="lk ll it mz b gy nh ne l nf ng">channelGrouping as Channel,</span><span id="f785" class="lk ll it mz b gy nh ne l nf ng">case when totals.visits=1 then CONCAT( fullvisitorid ,"-",Cast(visitNumber as string),"-",cast(visitStartTime as string)) end as Session,</span><span id="e5b9" class="lk ll it mz b gy nh ne l nf ng">Case when hits.IsInteraction=TRUE then  hits.Time/1000 else 0 end as hitTime,</span><span id="4566" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits<br/>           <br/> )<br/> group by channel, session)</span><span id="c94e" class="lk ll it mz b gy nh ne l nf ng">group by Channel</span></pre><p id="f69c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">9.页面上的平均时间</p><p id="9539" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">计算一个页面的平均时间类似于计算avg。会话持续时间。主要区别在于，我们汇总了特定页面的最后交互点击的时间戳，而不是会话的时间戳。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="3760" class="lk ll it mz b gy nd ne l nf ng">select <br/>  <br/>  Page, SUM(TIMEOnPage) as TimeOnPage, SUM(Exits) as Exits, SUM(Pageviews) as Pageviews,<br/>  safe_divide(SUM(TIMEOnPage),(SUM(Pageviews)-Sum(Exits))) as Avg_Time_On_Page</span><span id="5c72" class="lk ll it mz b gy nh ne l nf ng">from(</span><span id="484f" class="lk ll it mz b gy nh ne l nf ng">SELECT<br/>  Sessions, Page, Pageviews,<br/>  <br/> Case when exit =TRUE <br/>  then  LastInteraction-hitTime<br/>  else  LEAD(hitTime) OVER (PARTITION BY Sessions ORDER BY hitseq) - hitTime<br/>  end  as TimeOnPage, <br/>  <br/>  Exits<br/>FROM (<br/>  SELECT<br/>   CASE<br/>      WHEN totals.visits=1 THEN CONCAT( fullvisitorid,"-",CAST(visitNumber AS string),"-",CAST(visitStartTime AS string))<br/>  END<br/>    AS Sessions,<br/>    <br/>    hits.Page.pagePath AS Page,<br/>    hits.IsExit AS exit,<br/>     Case when hits.Isexit =TRUE <br/>  then 1 else 0 end As Exits,<br/>    hits.hitNUmber as hitSeq,<br/>    hits.Type AS hitType,<br/>    hits.time/1000 AS hitTime,<br/>   <br/>    CASE<br/>      WHEN type="PAGE" AND totals.visits=1 THEN 1<br/>    ELSE<br/>    0<br/>  END<br/>    AS PageViews,<br/>    MAX(<br/>    IF<br/>      (hits.isInteraction =TRUE<br/>      ,<br/>        hits.time / 1000,<br/>        0)) OVER (PARTITION BY fullVisitorId, visitStartTime) AS LastInteraction,<br/>  <br/>  <br/> from<br/> `dm-corp-marketing-001.137933647.ga_sessions_20200803` , UNNEST(hits) AS hits<br/>  <br/>  <br/>    order by Sessions,hitSeq<br/>    )<br/>WHERE<br/>  hitType='PAGE'<br/>  )<br/>  group by Page order by Pageviews  desc</span></pre><p id="ba19" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">10.基于事件的目标</p><p id="71b4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果您想要计算基于事件的目标的总完成数，您需要计算发生该事件的会话数。以下示例计算了事件类别的目标完成情况:销售线索生成和事件活动:手册下载。我使用的是正则表达式筛选器，而不是“等于”运算符；在这种情况下你可以使用任何一个。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="a774" class="lk ll it mz b gy nd ne l nf ng">Select</span><span id="d23f" class="lk ll it mz b gy nh ne l nf ng">Count( distinct</span><span id="5a56" class="lk ll it mz b gy nh ne l nf ng">CASE  WHEN <br/>REGEXP_CONTAINS(hits.eventInfo.eventAction,r'^Brochure Download$') AND <br/>REGEXP_CONTAINS(hits.eventInfo.eventCategory,r'^Lead Generation')</span><span id="3997" class="lk ll it mz b gy nh ne l nf ng">THEN CONCAT( fullvisitorid,"-", CAST(visitStartTime AS string) ) <br/>end)</span><span id="eec9" class="lk ll it mz b gy nh ne l nf ng">as Goal_Lead_Generation</span><span id="e337" class="lk ll it mz b gy nh ne l nf ng">from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801`<!-- --> , UNNEST(hits) AS hits</span></pre><p id="3d41" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">11.第n()页路径</p><p id="951e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你想看到最常见的第n()页比如最常见的第1页(登陆页)，最常见的第2页(登陆页之后的页面)等等，那么这段代码就是为你准备的。您可以操作这些代码来查看不同的页面流，直到第n()级和顶级页面路径级，还可以查看这些“数据视图”以了解特定的行为，如转换、设备类型等。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="4707" class="lk ll it mz b gy nd ne l nf ng">SELECT<br/>    second_page_path, count (distinct SessionIdentity) as Sessions<br/>  FROM (<br/>    SELECT<br/>      CASE<br/>        WHEN totals.visits=1 THEN CONCAT( fullvisitorid,"-",CAST(visitNumber AS string),"-",CAST(visitStartTime AS string))<br/>    END<br/>      AS SessionIdentity,<br/>  <br/>      CASE<br/>        WHEN hits.isEntrance=TRUE THEN hits.page.pagePath<br/>    END<br/>      AS Landing_Page,<br/>      CASE<br/>          WHEN hits.isEntrance = TRUE THEN LEAD( hits.page.pagePath,1) OVER (PARTITION BY fullVisitorId, visitNumber ORDER BY hits.type)<br/>        ELSE<br/>        NULL<br/>      END<br/>        AS second_page_path,<br/>        CASE<br/>          WHEN hits.isEntrance = TRUE THEN LEAD( hits.page.pagePath,2) OVER (PARTITION BY fullVisitorId, visitNumber ORDER BY hits.type)<br/>        ELSE<br/>        NULL<br/>      END<br/>        AS third_page_path,<br/>        CASE<br/>          WHEN hits.isEntrance = TRUE THEN LEAD( hits.page.pagePath,3) OVER (PARTITION BY fullVisitorId, visitNumber ORDER BY hits.type)<br/>        ELSE<br/>        NULL<br/>      END<br/>        AS fourth_page_path,<br/>        CASE<br/>          WHEN hits.isEntrance = TRUE THEN LEAD( hits.page.pagePath,4) OVER (PARTITION BY fullVisitorId, visitNumber ORDER BY hits.type)<br/>        ELSE<br/>        NULL<br/>      END<br/>        AS fifth_page_path,<br/>   <br/>   from<br/>`bigquery-public-data.google_analytics_sample.ga_sessions_20170801` , UNNEST(hits) AS hits<br/>   ORDER BY<br/>      SessionIdentity,<br/>      Landing_Page)<br/>  WHERE<br/>    SessionIdentity IS NOT NULL<br/>    AND landing_page IS NOT NULL<br/>  GROUP BY<br/>    second_page_path<br/>    <br/>  ORDER BY<br/>    Sessions Desc</span></pre></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><p id="ce93" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，我要说BigQuery是利用GA数据的一个很好的工具。它为你提供了查看数据的自由，这是通过谷歌分析无法看到的。</p><blockquote class="ni nj nk"><p id="3b5f" class="kf kg nl kh b ki kj kk kl km kn ko kp nm kr ks kt nn kv kw kx no kz la lb lc im bi translated">认识作者:<a class="ae mi" href="http://www.sumilmehta.in" rel="noopener ugc nofollow" target="_blank"> www.sumilmehta.in </a></p></blockquote></div></div>    
</body>
</html>