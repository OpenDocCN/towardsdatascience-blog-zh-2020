<html>
<head>
<title>How to use OpenCV with GPU on Colab?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Colab上配合GPU使用OpenCV？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-opencv-with-gpu-on-colab-25594379945f?source=collection_archive---------15-----------------------#2020-10-07">https://towardsdatascience.com/how-to-use-opencv-with-gpu-on-colab-25594379945f?source=collection_archive---------15-----------------------#2020-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b6d1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用其NVIDIA GPU在Google Colab上运行OpenCV的“dnn”</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/41ac41a1e85c8de8bba913cef6107d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*27ugWJknGtedsYLK"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@nanadua11?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">娜娜杜瓦</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7dd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> OpenCV的‘深度神经网络’(dnn)</strong>模块是一个方便的计算机视觉工具，它非常容易应用一些技术，如Yolo和OpenPose。然而，OpenCV的主要缺点是缺乏GPU支持，导致推理速度缓慢。幸好从<strong class="lb iu"> OpenCV 4.2 </strong>开始，支持NVIDIA GPU/CUDA。</p><p id="4225" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它仍然需要一些作品使用GPU，你可以查看Pyimagesearch的文章<a class="ae ky" href="https://www.pyimagesearch.com/2020/02/03/how-to-use-opencvs-dnn-module-with-nvidia-gpus-cuda-and-cudnn/" rel="noopener ugc nofollow" target="_blank">这里</a>，他们演示了如何建立一个Ubuntu机器。</p><p id="1be3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你和我一样没有带GPU的机器，可以考虑用<strong class="lb iu"> Google Colab </strong>，这是一个免费的服务，有强大的NVIDIA GPU。它也更容易设置，大部分的要求已经得到满足。在这篇文章中，我将分享我如何用几行代码为OpenCV的<code class="fe lv lw lx ly b">dnn</code>设置Colab环境。你也可以在这里查看<a class="ae ky" href="https://answers.opencv.org/question/233476/how-to-make-opencv-use-gpu-on-google-colab/" rel="noopener ugc nofollow" target="_blank"/>，我根据回答做了细微的改动。</p><p id="31e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将<code class="fe lv lw lx ly b">dnn</code>分配给GPU的代码很简单:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="8634" class="md me it ly b gy mf mg l mh mi">import cv2<br/>net = cv2.dnn.readNetFromCaffe(protoFile, weightsFile)<br/>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_CUDA)<br/>net.setPreferableTarget(cv2.dnn.DNN_TARGET_CUDA)</span></pre><p id="edbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果您直接在Colab上运行该单元格，您将看到以下错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/a8cce4f090ae9918c057b5a17e937cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ON3yEN8-CHeGLJu-uvu9w.png"/></div></div></figure><p id="c629" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们需要做点什么。</p><p id="1304" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你在Colab上检查预装OpenCV的版本，你会看到这个:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/df8faa66ad36a6bbb3413813a415d0fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QIaYQ5FvPNwNxgKyD7m3Qg.png"/></div></div></figure><p id="6e04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要自己安装cv2。</p><p id="fd20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，运行这个单元:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="0747" class="md me it ly b gy mf mg l mh mi">%cd /content</span><span id="f0d1" class="md me it ly b gy ml mg l mh mi">!git clone https://github.com/opencv/opencv</span><span id="ecde" class="md me it ly b gy ml mg l mh mi">!git clone https://github.com/opencv/opencv_contrib</span><span id="72b7" class="md me it ly b gy ml mg l mh mi">!mkdir /content/build</span><span id="954f" class="md me it ly b gy ml mg l mh mi">%cd /content/build</span><span id="c801" class="md me it ly b gy ml mg l mh mi">!cmake -DOPENCV_EXTRA_MODULES_PATH=/content/opencv_contrib/modules  -DBUILD_SHARED_LIBS=OFF  -DBUILD_TESTS=OFF  -DBUILD_PERF_TESTS=OFF -DBUILD_EXAMPLES=OFF -DWITH_OPENEXR=OFF -DWITH_CUDA=ON -DWITH_CUBLAS=ON -DWITH_CUDNN=ON -DOPENCV_DNN_CUDA=ON /content/opencv</span><span id="2557" class="md me it ly b gy ml mg l mh mi">!make -j8 install</span></pre><p id="c70c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mm"><img src="../Images/8f3da31ed35068f01516a46c3e348157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-f3I5E-t7SJrceCxHNxOoQ.png"/></div></div></figure><p id="d61c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这需要一段时间，完成后你可以检查OpenCV的版本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/1bb43d750d8c8fd011234e9b1c89fa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qoA7-dqmSPRWkAmaoHiWnQ.png"/></div></div></figure><p id="765c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这样吧！现在你应该能够正确无误地将<code class="fe lv lw lx ly b">dnn</code>设置为CUDA了。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="8165" class="md me it ly b gy mf mg l mh mi">net.setPreferableBackend(cv2.dnn.DNN_BACKEND_CUDA)<br/>net.setPreferableTarget(cv2.dnn.DNN_TARGET_CUDA)</span></pre><p id="3092" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是第一步要花很多时间，每次启动笔记本都需要做。这样很费时间，也不理想。</p><p id="e420" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里你可以做的一件事是将第一步的结果保存到你的Google Drive(你必须挂载它)。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="dd91" class="md me it ly b gy mf mg l mh mi">!mkdir  "/content/gdrive/My Drive/cv2_gpu"</span><span id="4384" class="md me it ly b gy ml mg l mh mi">!cp  /content/build/lib/python3/cv2.cpython-36m-x86_64-linux-gnu.so   "/content/gdrive/My Drive/cv2_gpu"</span></pre><p id="7f39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在下次启动笔记本时将其复制到您的工作目录中。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="6f26" class="md me it ly b gy mf mg l mh mi">!cp "/content/gdrive/My Drive/cv2_gpu/cv2.cpython-36m-x86_64-linux-gnu.so" .</span></pre><p id="0a70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并检查版本以确保完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/1bb43d750d8c8fd011234e9b1c89fa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qoA7-dqmSPRWkAmaoHiWnQ.png"/></div></div></figure><p id="880b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不想安装你的Google Drive，你可以把它上传到云中的某个地方，然后用<code class="fe lv lw lx ly b">!wget</code>把它下载到你的工作目录。</p><p id="30ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。感谢阅读。享受GPU带来的乐趣。</p></div></div>    
</body>
</html>