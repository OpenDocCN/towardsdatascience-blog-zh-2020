<html>
<head>
<title>Ultimate Pandas Guide — Reshaping Your Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫终极指南——重塑您的数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ultimate-pandas-guide-reshaping-your-data-75bc40ab05c4?source=collection_archive---------41-----------------------#2020-10-04">https://towardsdatascience.com/ultimate-pandas-guide-reshaping-your-data-75bc40ab05c4?source=collection_archive---------41-----------------------#2020-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/4d7e2ac750aae2efcab34d4879bdb2c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rjMqO0cgsxNkFW1Rp1OAew.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">劳拉·伍德伯里摄于<a class="ae jg" href="https://www.pexels.com/photo/panda-bear-on-green-grass-3608263/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a></p></figure><div class=""/><div class=""><h2 id="cbea" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">通过掌握“pivot_table”和“melt”来控制您的数据</h2></div><p id="e663" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">概括地说，数据可以用两种形状来组织——长型或宽型。</p><p id="5831" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，我们可以用两种方式表示总统选举结果:</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi lu"><img src="../Images/06ce52629a1a105c3326e14c947074ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BPWi1wksiuvqsH3-2MAhSw.png"/></div></div></figure><p id="898e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当我们的数据很长时，这意味着每条记录代表我们测量的变量的一个实例。在上面的例子中，每个记录都有候选人、州和他们收到的票数。</p><p id="d2a2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当我们的数据很宽时，这意味着我们测量的变量是跨行和列分布的。在上面的例子中，每条记录是一个州，我们有为每个候选人投票的列。</p><p id="c1e3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Pandas最有用的功能之一是能够快速轻松地重塑数据。</p><p id="ba5d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我将介绍如何毫不费力地在各种形状之间转换，以最好地满足您的分析需求。</p><h1 id="9780" class="lz ma jj bd mb mc md me mf mg mh mi mj kp mk kq ml ks mm kt mn kv mo kw mp mq bi translated">为什么我们需要不同的形状？</h1><p id="0de4" class="pw-post-body-paragraph ky kz jj la b lb mr kk ld le ms kn lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">最终，“正确”的形状将总是取决于用例。不同的场景需要不同的形状——这就是为什么我们需要在它们之间切换的功能。</p><p id="9d6b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">比方说，我们的选举数据有一个“长”形:</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/3832aa1cca053fc54fb47fa1847e540c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*rkgsdm2dlMw3989zp-IKfA.png"/></div></figure><p id="97ac" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们想建立一个模型来预测希拉里·克林顿获得总票数的百分比，这种形状是行不通的。为了创建州级预测模型，我们需要州级数据。</p><p id="b112" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一方面，如果我们想使用<a class="ae jg" href="https://seaborn.pydata.org/generated/seaborn.barplot.html" rel="noopener ugc nofollow" target="_blank"> seaborn </a>可视化软件包绘制一个条形图，我们将需要长格式。这并不是因为任何高度技术性的原因，只是因为seaborn barplot方法期望数据是这种格式。</p><h1 id="c49c" class="lz ma jj bd mb mc md me mf mg mh mi mj kp mk kq ml ks mm kt mn kv mo kw mp mq bi translated">长到宽—“数据透视表”</h1><p id="c194" class="pw-post-body-paragraph ky kz jj la b lb mr kk ld le ms kn lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">“pivot_table”方法是一种将数据形状从长变宽的简单方法。</p><p id="299f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是一个DataFrame方法，因此它会被您想要整形的DataFrame调用:</p><pre class="lv lw lx ly gt mx my mz na aw nb bi"><span id="ca4c" class="nc ma jj my b gy nd ne l nf ng">data.pivot_table()</span></pre><p id="8ee3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有四个主要参数要传递给此方法:</p><ol class=""><li id="c853" class="nh ni jj la b lb lc le lf lh nj ll nk lp nl lt nm nn no np bi translated"><strong class="la jk"> Index </strong>:我们希望在输出表中用作索引的列的名称</li><li id="9b60" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk">列</strong>:其唯一值将成为输出表中的列的列名</li><li id="586f" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk">值</strong>:我们想要聚合的列的名称</li><li id="3f24" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk"> Aggfunc </strong>:我们要使用的聚合函数的名称</li></ol><p id="731a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了让这一点变得生动，下面是一个使用“pivot_table”方法将数据从长变宽的例子:</p><pre class="lv lw lx ly gt mx my mz na aw nb bi"><span id="87b7" class="nc ma jj my b gy nd ne l nf ng">long_data.pivot_table(index = ‘state’, columns= ‘candidate’,<br/> values = ‘candidatevotes’, aggfunc = ‘sum’)</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nv"><img src="../Images/4acd267ce7640b500b9580d0dc9ba564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tJhJtKagIKXYqAwKRmvN0Q.png"/></div></div></figure><p id="b7f8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，如果我们的索引/列对有重复的值，那么只需要传递“values”和“aggfunc”参数。</p><p id="55cd" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">换句话说，如果我们有希拉里·克林顿在阿拉巴马州的两个计票记录，我们将希望传递“values”和“aggfunc ”,以便告诉该方法如何处理这些重复的记录(即将它们相加、平均等等。).</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/417663aeb7defbdbf2ab62b3b4feed05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/1*IwlWLiRERlFMf5DfsV_QOQ.png"/></div></figure><p id="a652" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">默认方法是使用np.mean函数。这可能导致<strong class="la jk">潜在的陷阱，</strong>因为我们不总是<em class="nx">想要</em>在上面的例子中取平均值。为了避免问题，您应该确保知道您的数据中是否有重复项。</p><p id="74b8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还有另一种方法——“pivot”——类似于pivot_table。</p><p id="9087" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，“pivot”不允许您拥有副本。如果我们尝试使用“pivot ”,并且我们有两个阿拉巴马州希拉里·克林顿的记录，此方法将返回ValueError:</p><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ny"><img src="../Images/2dcdda97482c88789848db483b77f4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fIdZTNm_UXmuaIadznOqCA.png"/></div></div></figure><p id="bb65" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因为“pivot”限制性更强，所以我建议在需要从long转换到wide时，只需使用“pivot_table”即可。</p><h1 id="24c9" class="lz ma jj bd mb mc md me mf mg mh mi mj kp mk kq ml ks mm kt mn kv mo kw mp mq bi translated">从宽到长—“融化”</h1><p id="bf0d" class="pw-post-body-paragraph ky kz jj la b lb mr kk ld le ms kn lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">Melt是我在Pandas中最喜欢的方法之一，因为它提供了“反透视”功能，这比它的SQL或excel等价物要简单得多。</p><p id="04f2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与我们的“pivot_table”方法类似，我们将使用几个主要参数来取消数据透视:</p><ol class=""><li id="7448" class="nh ni jj la b lb lc le lf lh nj ll nk lp nl lt nm nn no np bi translated"><strong class="la jk"> id_vars </strong>:您希望在输出中保持不变的列的名称</li><li id="2cab" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk"> value_vars: </strong>要在输出中折叠成单个分类列的列名</li><li id="3aaa" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk"> var_name: </strong>输出表中value_vars的列名。</li><li id="a5f6" class="nh ni jj la b lb nq le nr lh ns ll nt lp nu lt nm nn no np bi translated"><strong class="la jk"> value_name </strong>:输出表中值的列名。</li></ol><p id="04f3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是一个使用我们的选举数据的例子:</p><pre class="lv lw lx ly gt mx my mz na aw nb bi"><span id="4e1a" class="nc ma jj my b gy nd ne l nf ng">wide_data.melt(id_vars = 'state', <br/>            value_vars = ['Clinton, Hillary','Johnson, Gary','Stein, Jill','Trump, Donald J.'],<br/>            var_name = 'candidate',<br/>            value_name = 'candidatevotes')</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi lu"><img src="../Images/b2b5c299cad1d0766f047c62dd0dd3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vv5g1_6hy6qMAhHhdWaGQ.png"/></div></div></figure><p id="fa85" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，默认情况下，该方法会将“value_vars”参数设置为表中不在“id_vars”中的列的完整列表。因此，如果我们确实想使用所有这些列，从技术上讲，我们不需要向“value_vars”传递任何东西。</p><p id="1c62" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一方面，通过在“value_vars”参数中仅包含一个候选项，很容易获得该候选项的数据:</p><pre class="lv lw lx ly gt mx my mz na aw nb bi"><span id="b613" class="nc ma jj my b gy nd ne l nf ng">wide_data.melt(id_vars = 'state', <br/>            value_vars = ['Clinton, Hillary'],<br/>            var_name = 'candidate',<br/>            value_name = 'candidatevotes')</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/a6366b96a4178bb5e6bd8f491997e70d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*l6RHLopXxyHstpTLMBh3LA.png"/></div></figure><p id="419a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在帖子的开头，我提到了seaborn函数，barplot要求我们的数据是长格式的。</p><p id="584f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你感到好奇，下面的代码可以比较佛罗里达州和德克萨斯州候选人的投票结果:</p><pre class="lv lw lx ly gt mx my mz na aw nb bi"><span id="cbc4" class="nc ma jj my b gy nd ne l nf ng">sns.barplot(x=”candidate”, y=”candidatevotes”, hue=”state”, data=long_data[long_data.state.isin([‘Texas’, ‘Florida’])])</span></pre><figure class="lv lw lx ly gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oa"><img src="../Images/72881ae5ea4e682eb079eb3609dbc50e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R8iIpN635RKlxEDvDiI8AA.png"/></div></div></figure><p id="aa8c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，请注意，如果我们的数据是宽格式的，这是行不通的，因为我们没有一个单独的数字列传递给“y”参数。</p><h1 id="f47e" class="lz ma jj bd mb mc md me mf mg mh mi mj kp mk kq ml ks mm kt mn kv mo kw mp mq bi translated">结束语</h1><p id="2e07" class="pw-post-body-paragraph ky kz jj la b lb mr kk ld le ms kn lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">与SQL或Excel等其他分析工具相比，Pandas在重塑数据方面更胜一筹。</p><p id="0516" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过两个简单的函数pivot _ table和melt您可以有效地重塑您的数据，以帮助促进分析管道中接下来的连接、可视化或模型训练。编码快乐！</p><figure class="lv lw lx ly gt iv"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div></div>    
</body>
</html>