<html>
<head>
<title>Become a BigQuery Power User</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">成为BigQuery超级用户</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/become-a-bigquery-power-user-94089b8cdef2?source=collection_archive---------29-----------------------#2020-09-30">https://towardsdatascience.com/become-a-bigquery-power-user-94089b8cdef2?source=collection_archive---------29-----------------------#2020-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="32a0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">帮助你让这种野兽工作的5个技巧</h2></div></div><div class="ab cl kf kg hu kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="ij ik il im in"><p id="3c9d" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">BigQuery是Google的分析数据库，它查询大型数据集的速度快得惊人，并且可以让你免费使用。在编写本报告时，处理的前1TB数据是空闲的，存储的前10GB数据是空闲的。在这篇文章中，我将向你展示一些技巧，告诉你如何充分利用这个神奇的系统。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/22fdf406022cd6b153093db524cdce5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*exXgLe69Bqd_ledc"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated"><a class="ae ly" href="https://unsplash.com/@ktsfish?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">李坦</a>在<a class="ae ly" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="5c71" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">BigQuery是一个分布式系统，它将分布式存储与一个计算集群结合在一起，该集群(通常)会向您的查询并行抛出2000个或更多的插槽(vCPUs)。使用这些提示来很好地利用这种力量。</p><h1 id="6808" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">提示#1:使用Unnest </strong>动态生成测试数据</h1><p id="4fb8" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">你会在文档中经常看到这种情况，但可能会让新读者感到困惑。</p><p id="5987" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">UNNEST<a class="ae ly" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#unnest" rel="noopener ugc nofollow" target="_blank">函数让您可以像查询一个表一样查询一个数组字段。数组的每个元素都成为表中的一行。如果数组包含基元类型，结果表将有一列。在下面的示例中，每个数组元素都是一个STRUCT字段，它转换为表中的列。</a></p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/9c667e0f8edd9a16dac9376fbfb94ae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*-MC0I-wdeSn9UPE9W8fQrA.png"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">作者图片</p></figure><h1 id="1c8a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">提示2:一次使用CTE和多个语句</strong></h1><p id="b639" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">不要打开多个BigQuery控制台窗口，每个窗口都有自己的查询，而是在同一个控制台窗口中编写多个语句，并用分号分隔。您可以通过选择一个或多个查询并点击<code class="fe mx my mz na b">RUN</code>来单独执行，或者不选择任何内容，然后一次性运行。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/65a91e74d28c57cbc9fae1fa26459f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:436/format:webp/1*ASZaKJ5yv5D0hdFLsfo5PQ.png"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">作者图片</p></figure><p id="25ce" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">公共表表达式(cte)对于充分利用BigQuery强大的多级聚合分析能力也非常有用。这涉及到SQL <code class="fe mx my mz na b">WITH</code>关键字来定义层内存中的临时表，这些表可以随意连接和选择。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="1d62" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">提示3:使用变量</strong></h1><p id="7170" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">变量可以帮助您将文字分布在多个语句中，并使查询更容易重用。这对于在多个查询或公共表表达式(cte)之间保持日期范围过滤器非常有用。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="bf31" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">提示#4:用户定义的函数</strong></h1><p id="4c2e" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">除了已经嵌入BigQuery 的许多<a class="ae ly" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators" rel="noopener ugc nofollow" target="_blank">函数之外，您还可以</a><a class="ae ly" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank">定义自己的临时或持久函数</a>。函数可以用SQL或Javascript编写。后者对于从解析JSON到解码URL的任何事情都非常方便。让这些计算节点与您的自定义函数一起工作！</p><p id="5ed6" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">请记住，您不能导入模块，但可以引用存储在您的Google云存储桶中的库文件。</p><p id="a95e" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">下面是两个JS UDF的例子，一个是利用存储在GCS中的库的持久函数，另一个是对数组进行集合操作的临时函数。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nc nd l"/></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">JS UDF示例</p></figure><h1 id="a2df" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">提示5:存储过程</strong></h1><p id="a939" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">存储过程为您提供了脚本功能，允许您使用if和while语句控制执行流。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="b487" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">结果如下。很明显，这种能力对于数据转换和重构非常有用。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ne"><img src="../Images/6a4d07acf8f795c4e3835e57af8a8e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*eUu7iaX6wEHosQahfPhIBg.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">作者图片</p></figure><h1 id="c61e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">结论</strong></h1><p id="2af2" class="pw-post-body-paragraph km kn iq ko b kp mr jr kr ks ms ju ku kv mt kx ky kz mu lb lc ld mv lf lg lh ij bi translated">BigQuery是一个非常强大的数据仓库和分析工具。</p><ul class=""><li id="4d42" class="nf ng iq ko b kp kq ks kt kv nh kz ni ld nj lh nk nl nm nn bi translated">使用BigQuery来利用SQL强大的数组和结构类型</li><li id="dfd3" class="nf ng iq ko b kp no ks np kv nq kz nr ld ns lh nk nl nm nn bi translated">使用UNNEST将数组和结构转换成表</li><li id="d268" class="nf ng iq ko b kp no ks np kv nq kz nr ld ns lh nk nl nm nn bi translated">将CTE用于多级聚合，或者代替高度嵌套的查询，并将多条语句组合在一起执行</li><li id="4ce2" class="nf ng iq ko b kp no ks np kv nq kz nr ld ns lh nk nl nm nn bi translated">使用变量来参数化查询或在连续查询之间传递数据</li><li id="9372" class="nf ng iq ko b kp no ks np kv nq kz nr ld ns lh nk nl nm nn bi translated">使用用户定义函数(UDF)使您的查询片段可重用，或者在查询中利用JavaScript的强大功能</li><li id="5e37" class="nf ng iq ko b kp no ks np kv nq kz nr ld ns lh nk nl nm nn bi translated">存储过程可以使常见任务易于重复，并避免代码重复。</li></ul><p id="8f55" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">它会变得越来越好，所以请关注这个空间，获取更多有用的提示。</p></div></div>    
</body>
</html>