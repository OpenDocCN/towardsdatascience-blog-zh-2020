<html>
<head>
<title>It’s Time to Change Dimensions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">是时候改变维度了</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/its-time-to-change-dimensions-be3302893dd6?source=collection_archive---------33-----------------------#2020-10-31">https://towardsdatascience.com/its-time-to-change-dimensions-be3302893dd6?source=collection_archive---------33-----------------------#2020-10-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/bc152d05fabfc547bbb4dc8129fb36d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2SZ4QLEHmjGCXK484H_yg.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">安东尼·加兰在<a class="ae kf" href="https://unsplash.com/s/photos/constitution?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="cdc4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">任何事物都有一个季节，每个目的都有一个时间…让我们用一个缓慢变化的维度(SCD)来记录这些变化。</p><p id="c894" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">缓变维度是什么？这是一个随着时间逐渐变化的表，就像一组当选的官员。假设我们将下面一组美国参议员加载到数据库中。</p><p id="e5e4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://theunitedstates.io/congress-legislators/legislators-current.csv" rel="noopener ugc nofollow" target="_blank">https://the United States . io/congress-立法者/立法者-current.csv </a></p><p id="670c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管许多人已经在位很长时间，但有些人即将改变。根据我们的宪法第一条，第三节，第二款，这些参议员的三分之一将受到改变。</p><blockquote class="le lf lg"><p id="bf3a" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">[合众国参议院]在第一次选举结果产生后，应立即尽可能平等地分成三个等级。第一等参议员的席位应在第二年期满时空出，第二等参议员的席位在第四年期满时空出，第三等参议员的席位在第六年期满时空出，以便每隔一年选出三分之一的参议员</p></blockquote><p id="6cdc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有许多方法可以实现渐变维度。保持一个简单的模式可以简化你决定如何改变的过程。</p><p id="e881" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确定标识唯一行的列以及要跟踪的列。</p><p id="7b7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我希望每个州和每个阶层都有一个独特的参议员。州参议员没有阶级重叠，因此在一个特定的州的选举周期中只有一个人可以参加选举。目前，格鲁吉亚是个例外，但我们不会深入探讨。</p><p id="db5d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们已经将上述CSV文件的原始数据存放到一个表中。为了将原始数据处理到当前参议院的表中，我们将行插入到一个维度表中。</p><p id="c514" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我已经将惟一的行标识为我的MATCH_GUID，将CHANGE_HASH标识为H as值。我使用散列来最小化SQL上的CPU处理时间。</p><p id="7c5f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MATCH_GUID对行中的所有更改进行编码，如果有任何更改，它将使用新记录更新维度。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="92ca" class="lu lv it lq b gy lw lx l ly lz">insert into OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT(CONGRESS_SEAT_GUID,<br/>                                               LAST_NAME,<br/>                                               FIRST_NAME,<br/>                                               FULL_NAME,<br/>                                               BIRTHDAY,<br/>                                               GENDER,<br/>                                               TYPE,<br/>                                               STATE,<br/>                                               DISTRICT,<br/>                                               SENATE_CLASS,<br/>                                               PARTY,<br/>                                               ADDRESS,<br/>                                               PHONE,<br/>                                               CONTACT_FORM,<br/>                                               DW_MATCH_HASH)<br/>with source as (<br/>    SELECT hash(STATE,<br/>                SENATE_CLASS)    MATCH_GUID,<br/>           LAST_NAME,<br/>           FIRST_NAME,<br/>           FULL_NAME,<br/>           BIRTHDAY,<br/>           GENDER,<br/>           TYPE,<br/>           STATE,<br/>           DISTRICT,<br/>           SENATE_CLASS,<br/>           PARTY,<br/>           ADDRESS,<br/>           PHONE,<br/>           CONTACT_FORM,<br/><br/>           hash(<br/>                   LAST_NAME,<br/>                   FIRST_NAME,<br/>                   FULL_NAME,<br/>                   BIRTHDAY,<br/>                   GENDER,<br/>                   TYPE,<br/>                   DISTRICT,<br/>                   PARTY,<br/>                   ADDRESS,<br/>                   PHONE,<br/>                   CONTACT_FORM) CHANGE_HASH<br/>    from OWLMTN.STAGE.CONGRESS_MEMBERS sor<br/>    where type = 'sen'<br/>),<br/>     target as (<br/>         select CONGRESS_SEAT_GUID,<br/>                DW_MATCH_HASH match_hash<br/>         from OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT tar<br/>         where DW_ACTIVE = 'T'<br/>     )<br/>select source.MATCH_GUID,<br/>       source.LAST_NAME,<br/>       source.FIRST_NAME,<br/>       source.FULL_NAME,<br/>       source.BIRTHDAY,<br/>       source.GENDER,<br/>       source.TYPE,<br/>       source.STATE,<br/>       source.DISTRICT,<br/>       source.SENATE_CLASS,<br/>       source.PARTY,<br/>       source.ADDRESS,<br/>       source.PHONE,<br/>       source.CONTACT_FORM,<br/>       source.CHANGE_HASH<br/>from source<br/>         left outer join target<br/>                         on target.CONGRESS_SEAT_GUID = source.MATCH_GUID<br/>where target.match_hash is null<br/>   or target.match_hash &lt;&gt; source.CHANGE_HASH;</span></pre><p id="0d3c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更新查询将找到任何新行，并将它们标记为活动的。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="5960" class="lu lv it lq b gy lw lx l ly lz">-- Arrange the dimensions on the SCD.<br/>update OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT new_data<br/>    set new_data.DW_ACTIVE = update_logic.DW_ACTIVE,<br/>        new_data.DW_FROM_DATE = update_logic.new_from_dw_date,<br/>        new_data.DW_TO_DATE = update_logic.new_to_dw_date,<br/>        DW_UPDATE_DATE = current_timestamp()<br/>from (<br/><br/>    with updated_gui as (<br/>        select DIM_CONGRESS_SEAT_KEY, CONGRESS_SEAT_GUID<br/>        from OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT<br/>        where dw_from_date is null<br/>        )<br/>    select current_row.DIM_CONGRESS_SEAT_KEY,<br/>           current_row.dw_active as old_active,<br/>           case when current_row.DW_FROM_DATE is null<br/>               then TRUE<br/>               else FALSE end as DW_ACTIVE,<br/><br/>           current_row.DW_FROM_DATE,<br/>            case when current_row.DW_FROM_DATE is null<br/>               then CURRENT_TIMESTAMP()<br/>               else current_row.DW_FROM_DATE end as new_from_dw_date,<br/><br/>           current_row.DW_TO_DATE,<br/><br/>           case when current_row.DW_FROM_DATE is null<br/>                 then to_timestamp_ltz('2099-12-31 00:00:00')<br/>               else CURRENT_TIMESTAMP() end as new_to_dw_date,<br/>           current_row.DW_MATCH_HASH<br/>        from updated_gui<br/>        inner join OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT current_row<br/>            on updated_gui.CONGRESS_SEAT_GUID = current_row.CONGRESS_SEAT_GUID<br/>                   and (DW_FROM_DATE is NULL or current_row.DW_ACTIVE=TRUE)<br/>        left outer join OWLMTN.WAREHOUSE.DIM_CONGRESS_SEAT old<br/>            on current_row.CONGRESS_SEAT_GUID = old.CONGRESS_SEAT_GUID<br/>                   and old.dw_ACTIVE<br/><br/>      ) update_logic<br/>where new_data.DIM_CONGRESS_SEAT_KEY = update_logic.DIM_CONGRESS_SEAT_KEY;</span></pre><p id="112c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么11月3日之后会发生什么，座位状态有变化？让我们追踪一下我最喜欢的科罗拉多州的选举，假设一下席位的变化。</p><p id="75d0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae kf" href="https://azri.us/" rel="noopener ugc nofollow" target="_blank"> Azri.us上的数据预测，</a>希肯卢珀比目前占据席位的加德纳多10个百分点的优势。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ma"><img src="../Images/eec625418933104855ae6e2b6cc39208.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*De9ax4Bggm5esNTMqnOHMQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图片由Google GeoChart基于538个原始数据制作</p></figure><p id="7ce6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">查看前面的插入查询中的散列比较，我们看到MATCH_GUID保持不变(相同的席位)，但是CHANGE_HASH发生了变化(新参议员)。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/daab5b0e2a77590485d6837618e5991f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*GSCXqSS_SNdBPXr4B0eeFQ.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">SCD哈希匹配策略</p></figure><p id="bc8b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在insert检测到一个已更改的记录后，它还不是活动的，我们需要以一种事务方式激活该记录，当新行替换旧记录时，将旧记录设置为非活动的。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mc"><img src="../Images/6192dbda62381345882c154e1fdcef29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_DV9G7aIpD8DkZdk_7IhQ.png"/></div></div></figure><p id="9787" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行移动当前活动行上的日期的查询会将非活动行移动到活动行。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi md"><img src="../Images/6e6b079babbd22e4eaae8db124a8ca97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWRdekZEJfnuCMwWTr7pwQ.png"/></div></div></figure><p id="62db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于给定时间点的任何查询，声明为unique的项将始终返回一行。</p><p id="14e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我想知道在特定时间谁是科罗拉多州2级参议员，我可以指定时间，它永远不会改变。</p><p id="88db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，DW_FROM_DATE小于该日期，而DW_TO_DATE大于或等于该日期。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="052d" class="lu lv it lq b gy lw lx l ly lz">select CONGRESS_SEAT_GUID, FULL_NAME, DW_MATCH_HASH, DW_ACTIVE, DW_FROM_DATE, DW_TO_DATE<br/>from owlmtn.WAREHOUSE.DIM_CONGRESS_SEAT<br/>where state = 'CO' and SENATE_CLASS = 2<br/>  and DW_FROM_DATE &lt; '2020-10-30 21:51:58.166000000 -07:00'<br/>  and DW_TO_DATE &gt;= '2020-10-30 21:51:58.166000000 -07:00';</span></pre><h1 id="6463" class="me lv it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">结论</h1><p id="aa38" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">缓慢变化的维度表是数据仓库的基础。它允许分析师跟踪趋势，查看历史，并遵守保存所有数据的原则。</p><p id="c75a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一些SQL结构可能比较复杂，一些数据库本身就支持SCD。然而，使用基本的SQL SCD模式将使您的代码具有可移植性和清晰性。</p></div></div>    
</body>
</html>