<html>
<head>
<title>Tutorial: Stop Running Jupyter Notebooks from your Command Line</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程:停止从命令行运行Jupyter笔记本</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tutorial-stop-running-jupyter-notebooks-from-your-command-line-b3af93265230?source=collection_archive---------5-----------------------#2020-10-20">https://towardsdatascience.com/tutorial-stop-running-jupyter-notebooks-from-your-command-line-b3af93265230?source=collection_archive---------5-----------------------#2020-10-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3e87" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将您的Jupyter笔记本作为独立的网络应用程序运行</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/75c6fcb3dde295485267e48c9f244612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RHdT3jldqj7mHs7yP2XQhA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Justin Jairam的照片来自<a class="ae ky" href="https://www.instagram.com/jusspreme/?hl=en" rel="noopener ugc nofollow" target="_blank"> @jusspreme </a>(经允许)</p></figure><p id="1a18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Jupyter Notebook提供了一个很好的平台来生成包含代码、等式、分析及其描述的人类可读文档。一些人甚至认为它与NBDev结合是一个强大的发展。对于这样一个完整的工具，开箱启动并不是最好的。每次使用都需要从命令行启动Jupyter web应用程序，并输入您的令牌或密码。整个web应用程序依赖于打开的终端窗口。有些人可能会“混淆”这个过程，然后使用<a class="ae ky" href="https://www.computerhope.com/unix/unohup.htm" rel="noopener ugc nofollow" target="_blank"> nohup </a>将它从他们的终端中分离出来，但这不是最优雅和可维护的解决方案。</p><p id="b991" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，Jupyter已经提出了一个解决这个问题的方案，推出了Jupyter笔记本的扩展，作为一个可持续的网络应用程序运行，并具有内置的用户身份验证。为了在上面添加一个樱桃，它可以通过Docker管理和维护，允许隔离的开发环境。</p><p id="bab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章的最后，我们将利用JupyterHub的能力来访问一个Jupyter笔记本实例，该实例可以在没有终端的情况下从网络中的多个设备访问，并且是一种更加用户友好的身份验证方法。</p><h1 id="c62a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">先决条件</h1><p id="1c2d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">关于Docker和命令行的基本知识将有助于设置这一功能。</p><p id="dcd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我建议在你拥有的最强大的设备上这样做，并且一天的大部分时间都是开着的，最好是一整天。这种设置的一个好处是，你可以在网络上的任何设备上使用Jupyter Notebook，但是所有的计算都在我们配置的设备上进行。</p><h1 id="a1c4" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是Jupyter Hub</h1><p id="db1f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">JupyterHub将笔记本电脑的强大功能带给用户组。JupyterHub背后的想法是将Jupyter笔记本的使用范围扩大到企业、教室和大型用户组。然而，Jupyter Notebook应该作为一个本地实例，由一个开发人员在一个节点上运行。不幸的是，JupyterHub的可用性和可伸缩性与运行本地Jupyter笔记本的简单性之间没有折中。也就是说，直到现在。</p><p id="e215" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JupyterHub有预建的Docker映像，我们可以利用这些映像心血来潮地生成一个笔记本，在技术复杂性方面几乎没有开销。我们将使用Docker和JupyterHub的组合，从同一网址随时随地访问Jupyter笔记本。</p><h1 id="bac0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">体系结构</h1><p id="7659" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们的JupyterHub服务器的架构将由两个服务组成:JupyterHub和JupyterLab。JupyterHub将是入口点，并将为任何用户生成JupyterLab实例。这些服务中的每一个都将作为Docker容器存在于主机上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/c72335e83bb87fc4d1fd6c101264f15f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K4a0t7MYl52pVXH2.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">JupyterLab架构图(图片由作者提供)</p></figure><h1 id="b801" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">构建Docker图像</h1><p id="c346" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了构建我们的家用JupyterHub服务器，我们将使用JupyterHub &amp; JupyterLab的预构建Docker映像。</p><h1 id="17e1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">码头文件</h1><p id="94ef" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">JupyterHub Docker图像很简单。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="7ea2" class="my lw it mu b gy mz na l nb nc">FROM jupyterhub/jupyterhub:1.2</span><span id="e966" class="my lw it mu b gy nd na l nb nc"># Copy the JupyterHub configuration in the container<br/>COPY jupyterhub_config.py .</span><span id="67d5" class="my lw it mu b gy nd na l nb nc"># Download script to automatically stop idle single-user servers<br/>COPY cull_idle_servers.py .</span><span id="09e8" class="my lw it mu b gy nd na l nb nc"># Install dependencies (for advanced authentication and spawning)<br/>RUN pip install dockerspawner</span></pre><p id="3124" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用预先构建的JupyterHub Docker映像，并添加我们自己的配置文件来停止空闲的服务器，<code class="fe ne nf ng mu b">cull_idle_servers.py</code>。最后，我们通过Docker安装额外的包来生成JupyterLab实例。</p><h1 id="2475" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Docker撰写</h1><p id="2cac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了将所有的东西放在一起，让我们创建一个<code class="fe ne nf ng mu b">docker-compose.yml</code>文件来定义我们的部署和配置。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6c73" class="my lw it mu b gy mz na l nb nc">version: '3'</span><span id="09a4" class="my lw it mu b gy nd na l nb nc">services:<br/>  # Configuration for Hub+Proxy<br/>  jupyterhub:<br/>    build: .                # Build the container from this folder.<br/>    container_name: jupyterhub_hub   # The service will use this container name.<br/>    volumes:                         # Give access to Docker socket.<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>      - jupyterhub_data:/srv/jupyterlab<br/>    environment:                     # Env variables passed to the Hub process.<br/>      DOCKER_JUPYTER_IMAGE: jupyter/tensorflow-notebook<br/>      DOCKER_NETWORK_NAME: ${COMPOSE_PROJECT_NAME}_default<br/>      HUB_IP: jupyterhub_hub<br/>    ports:<br/>      - 8000:8000<br/>    restart: unless-stopped</span><span id="3b06" class="my lw it mu b gy nd na l nb nc">  # Configuration for the single-user servers<br/>  jupyterlab:<br/>    image: jupyter/tensorflow-notebook<br/>    command: echo</span><span id="fafc" class="my lw it mu b gy nd na l nb nc">volumes:<br/>  jupyterhub_data:</span></pre><p id="e111" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的关键环境变量是<code class="fe ne nf ng mu b">DOCKER_JUPYTER_IMAGE</code>和<code class="fe ne nf ng mu b">DOCKER_NETWORK_NAME</code>。JupyterHub将使用环境变量中定义的图像创建Jupyter笔记本。有关选择Jupyter图像的更多信息，您可以访问以下Jupyter <a class="ae ky" href="https://jupyter-docker-stacks.readthedocs.io/en/latest/using/selecting.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="8c52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ne nf ng mu b">DOCKER_NETWORK_NAME</code>是服务使用的Docker网络的名称。这个网络从Docker Compose自动获得一个名称，但是集线器需要知道这个名称来连接Jupyter笔记本服务器。为了控制网络名，我们使用了一个小技巧:我们将一个环境变量COMPOSE_PROJECT_NAME传递给Docker Compose，网络名是通过向它附加_default获得的。</p><p id="3839" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在与<code class="fe ne nf ng mu b">docker-compose.yml</code>文件相同的目录下创建一个名为<code class="fe ne nf ng mu b">.env</code>的文件，并添加以下内容:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="f53f" class="my lw it mu b gy mz na l nb nc">COMPOSE_PROJECT_NAME<strong class="mu iu">=</strong>jupyter_hub</span></pre><h1 id="07db" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">停止空闲服务器</h1><p id="4459" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">因为这是我们的主设置，所以我们希望能够停止空闲的实例来保留我们机器上的内存。JupyterHub有一些服务可以和它一起运行，其中之一就是jupyterhub-idle-culler 。该服务停止任何长时间空闲的实例。</p><p id="44ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要添加这个服务，创建一个名为<code class="fe ne nf ng mu b">cull_idle_servers.py</code>的新文件，并将<a class="ae ky" href="https://raw.githubusercontent.com/jupyterhub/jupyterhub-idle-culler/master/jupyterhub_idle_culler/__init__.py" rel="noopener ugc nofollow" target="_blank"> jupyterhub-idle-culler项目</a>的内容复制到其中。</p><blockquote class="nh ni nj"><p id="743c" class="kz la nk lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated">请确保“cull_idle_servers.py”与docker文件位于同一文件夹中。</p></blockquote><p id="8bc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要了解更多关于JupyterHub服务的信息，请查看他们的官方文档。</p><h1 id="00e5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Jupyterhub配置</h1><p id="d051" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">最后，我们需要定义配置选项，如卷装载、Docker映像、服务、身份验证等。对于我们的JupyterHub实例。</p><p id="f19f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是我使用的一个简单的<code class="fe ne nf ng mu b">jupyterhub_config.py</code>配置文件。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="7592" class="my lw it mu b gy mz na l nb nc">import os<br/>import sys</span><span id="3bb3" class="my lw it mu b gy nd na l nb nc">c.JupyterHub.spawner_class <strong class="mu iu">=</strong> 'dockerspawner.DockerSpawner'<br/>c.DockerSpawner.image <strong class="mu iu">=</strong> os.environ['DOCKER_JUPYTER_IMAGE']<br/>c.DockerSpawner.network_name <strong class="mu iu">=</strong> os.environ['DOCKER_NETWORK_NAME']<br/>c.JupyterHub.hub_connect_ip <strong class="mu iu">=</strong> os.environ['HUB_IP']<br/>c.JupyterHub.hub_ip <strong class="mu iu">=</strong> "0.0.0.0" <em class="nk"># Makes it accessible from anywhere on your network</em></span><span id="33bc" class="my lw it mu b gy nd na l nb nc">c.JupyterHub.admin_access <strong class="mu iu">=</strong> True</span><span id="b672" class="my lw it mu b gy nd na l nb nc">c.JupyterHub.services <strong class="mu iu">=</strong> [<br/>    {<br/>        'name': 'cull_idle',<br/>        'admin': True,<br/>        'command': [sys.executable, 'cull_idle_servers.py', '--timeout=42000']<br/>    },<br/>]</span><span id="109c" class="my lw it mu b gy nd na l nb nc">c.Spawner.default_url <strong class="mu iu">=</strong> '/lab'</span><span id="87d2" class="my lw it mu b gy nd na l nb nc">notebook_dir <strong class="mu iu">=</strong> os.environ.get('DOCKER_NOTEBOOK_DIR') <strong class="mu iu">or</strong> '/home/jovyan/work'<br/>c.DockerSpawner.notebook_dir <strong class="mu iu">=</strong> notebook_dir<br/>c.DockerSpawner.volumes <strong class="mu iu">=</strong> {<br/>    '/home/sidhu': '/home/jovyan/work'<br/>}</span></pre><p id="ce6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意以下配置选项:</p><ul class=""><li id="3f52" class="no np it lb b lc ld lf lg li nq lm nr lq ns lu nt nu nv nw bi translated"><code class="fe ne nf ng mu b">'command': [sys.executable, 'cull_idle_servers.py', '--timeout=42000']</code> : Timeout是空闲Jupyter实例关闭之前的秒数。</li><li id="6801" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><code class="fe ne nf ng mu b">c.Spawner.default_url = '/lab'</code>:使用Jupyterlab代替Jupyter笔记本。注释掉这一行以使用Jupyter笔记本。</li><li id="3230" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><code class="fe ne nf ng mu b">'/home/sidhu': '/home/jovyan/work'</code>:我将我的主目录挂载到JupyterLab主目录，以便访问我桌面上的任何项目和笔记本。这也允许我们在创建新笔记本的情况下实现持久性，它们被保存到我们的本地机器，并且不会在我们的Jupyter Notebook Docker容器被删除时被删除。</li></ul><p id="5ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不希望挂载您的主目录，请删除这一行，并且不要忘记将<code class="fe ne nf ng mu b">sidhu</code>改为您的用户名。</p><h1 id="671b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">启动服务器</h1><p id="9840" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要启动服务器，只需运行<code class="fe ne nf ng mu b">docker-compose up -d</code>，在浏览器中导航到<code class="fe ne nf ng mu b">localhost:8000</code>，您应该能够看到JupyterHub登录页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/40d3512d53a65af4271afc6fab259484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xcd_4w0Pou-DM4-6.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">JupyterHub登陆页面截图(图片由作者提供)</p></figure><p id="66cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在网络上的其他设备(如asva笔记本电脑、iPad等)上访问它，请通过在Unix机器上运行<code class="fe ne nf ng mu b">ifconfig</code>在Windows上运行&amp; <code class="fe ne nf ng mu b">ipconfig</code>来识别主机的IP。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/8c95427f1b379030fbf7b880bad86ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QqyX7uYlVpJN48rx.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Ipconfig(图片作者提供)</p></figure><p id="b493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从您的另一台设备上，导航到您在端口8000: <code class="fe ne nf ng mu b">http://IP:8000</code>上找到的IP，您应该会看到JupyterHub登录页面！</p><h1 id="e92f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">鉴定</h1><p id="f045" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这就给我们留下了向服务器进行认证的最后一项任务。因为我们没有设置LDAP服务器或OAuth，所以JupyterHub将使用PAM(可插拔认证模块)认证来认证用户。这意味着JupyterHub使用主机的用户名和密码进行身份验证。</p><p id="0c99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了利用这一点，我们必须在JupyterHub Docker容器上创建一个用户。还有其他方法可以做到这一点，例如在容器上放置一个脚本，并在容器启动时执行，但我们将手动完成它作为一个练习。如果您拆除或重建容器，您将必须重新创建用户。</p><blockquote class="nh ni nj"><p id="153e" class="kz la nk lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated">我不建议将用户凭证硬编码到任何脚本或docker文件中。</p></blockquote><p id="5144" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1)找到JupyterLab容器ID: <code class="fe ne nf ng mu b">docker ps -a</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/3d8a96699655e8e74127d7d261092d7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6l2zRp8FcsSsK4iZ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">JupyterLab容器ID(图片由作者提供)</p></figure><p id="0f4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2)“SSH”进入容器:<code class="fe ne nf ng mu b">docker exec -it $YOUR_CONTAINER_ID bash</code></p><p id="097b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3)创建用户，按照终端提示创建密码:<code class="fe ne nf ng mu b">useradd $YOUR_USERNAME</code></p><p id="1ece" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4)使用凭证登录，一切就绪！</p><p id="4dd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经拥有了一台随时可用的Jupyter笔记本电脑服务器，可以从任何设备访问，尽在您的掌握之中！编码快乐！</p><h1 id="2e2a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">反馈</h1><p id="a978" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我欢迎任何关于我的帖子和教程的反馈。你可以在sidhuashton@gmail.com的<a class="ae ky" href="https://twitter.com/ashtonasidhu" rel="noopener ugc nofollow" target="_blank">推特</a>上给我发消息，或者发电子邮件给我。</p></div></div>    
</body>
</html>