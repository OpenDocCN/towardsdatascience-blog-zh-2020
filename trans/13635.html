<html>
<head>
<title>Deploy a Python API on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上部署Python API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-a-python-api-on-aws-c8227b3799f0?source=collection_archive---------3-----------------------#2020-09-19">https://towardsdatascience.com/deploy-a-python-api-on-aws-c8227b3799f0?source=collection_archive---------3-----------------------#2020-09-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c732" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">烧瓶+ Lambda + API网关</h2></div><p id="47b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建我自己的应用程序并将其部署在云上以便每个人都可以使用它的第一个想法让我非常兴奋，这也是我写这篇文章的灵感。如果这个想法也引起了你的兴趣，请继续阅读这篇文章，从这篇文章中，你将一步一步地学习如何部署python应用程序。</p><h1 id="6753" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">首先，你需要一个应用程序</h1><p id="bb7f" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">你需要将你的想法包装在一个应用程序中，或者说是一个API，它可以处理来自互联网的呼叫。这里的就是一个例子<a class="ae mb" href="https://github.com/MJeremy2017/referral-api" rel="noopener ugc nofollow" target="_blank">。这是一个烧瓶应用程序，</a></p><figure class="mc md me mf gt mg"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="55b8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">关键在于<code class="fe mj mk ml mm b">app.py</code>文件，这个应用程序接收你的简历并帮助你在内部推荐。请注意，我们甚至不需要docker文件，AWS Lambda非常轻量级，您甚至不需要将代码包装在容器中！</p><h1 id="867d" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">其次，下载Zappa</h1><p id="af77" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated"><a class="ae mb" href="https://github.com/Miserlou/Zappa" rel="noopener ugc nofollow" target="_blank"> Zappa </a>，引自官方文件，它</p><p id="de4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mn">让在AWS Lambda + API Gateway上构建和部署无服务器、事件驱动的Python应用程序(包括但不限于WSGI web应用程序)变得极其简单。可以把它想象成Python应用程序的“无服务器”网络托管。这意味着无限扩展、零停机、零维护，而成本只是您当前部署的一小部分！</em></p><p id="d4b5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你已经使用AWS服务有一段时间了，你会知道在云上部署一个使用多种不同服务和配置的服务不是一件容易的事情，但是Zappa来拯救你，用简单的命令(相信我，它真的只有几行！)，所有的起重配置都会完成！</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="be0e" class="ms lf it mm b gy mt mu l mv mw">pip install zappa</span></pre><p id="8384" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">顺便说一下，我假设您已经在项目虚拟环境中安装了所有的包，如果没有，请安装</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="2a3d" class="ms lf it mm b gy mt mu l mv mw">virtualenv -p `which python3` env</span></pre><p id="4821" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">(您需要预装virtualenv)</p><p id="b2ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在做</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="de72" class="ms lf it mm b gy mt mu l mv mw">zappa init</span></pre><p id="8309" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一个一个的检查设置，如果你不明白就用默认的，之后你仍然可以改变它。在这之后，你的根文件夹中会有一个<code class="fe mj mk ml mm b">zappa_setting.json</code>,我的是这样的</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="6528" class="ms lf it mm b gy mt mu l mv mw">{<br/>    "production": {<br/>        "app_function": "app.app",<br/>        "aws_region": "ap-southeast-1",<br/>        "profile_name": "default",<br/>        "project_name": "referral-api",<br/>        "runtime": "python3.7",<br/>        "s3_bucket": "zappa-referral-api-eu2hzy8sf"<br/>    }<br/>}</span></pre><h1 id="a92e" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">第三，让Zappa访问你的AWS</h1><p id="327b" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">现在你需要去你的AWS控制台，但是等等，你说Zappa会为我们做所有的AWS工作？是的，但是请这样想，在Zappa可以代表您做出任何更改之前，它需要访问您的AWS资源，这一步是给Zappa一个做这些事情的凭证。</p><p id="fdd3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以遵循这里的步骤<a class="ae mb" href="https://pythonforundergradengineers.com/deploy-serverless-web-app-aws-lambda-zappa.html" rel="noopener ugc nofollow" target="_blank">部署-无服务器-应用</a>(相信我，这是一个真正的说明性指南，包含您需要的所有映像)。</p><p id="48e1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于附加到组的策略，请使用此策略！<em class="mn">(上面链接中的那个不能让你更新应用</em>)</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="5ce4" class="ms lf it mm b gy mt mu l mv mw">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "iam:AttachRolePolicy",<br/>        "iam:GetRole",<br/>        "iam:CreateRole",<br/>        "iam:PassRole",<br/>        "iam:PutRolePolicy"<br/>      ],<br/>      "Resource": [<br/>        "arn:aws:iam::XXXXXXXXXXXXXXXX:role/*-ZappaLambdaExecutionRole"<br/>      ]<br/>    },<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "lambda:CreateFunction",<br/>        "lambda:ListVersionsByFunction",<br/>        "logs:DescribeLogStreams",<br/>        "events:PutRule",<br/>        "lambda:GetFunctionConfiguration",<br/>        "cloudformation:DescribeStackResource",<br/>        "apigateway:DELETE",<br/>        "apigateway:UpdateRestApiPolicy",<br/>        "events:ListRuleNamesByTarget",<br/>        "apigateway:PATCH",<br/>        "events:ListRules",<br/>        "cloudformation:UpdateStack",<br/>        "lambda:DeleteFunction",<br/>        "events:RemoveTargets",<br/>        "logs:FilterLogEvents",<br/>        "apigateway:GET",<br/>        "lambda:GetAlias",<br/>        "events:ListTargetsByRule",<br/>        "cloudformation:ListStackResources",<br/>        "events:DescribeRule",<br/>        "logs:DeleteLogGroup",<br/>        "apigateway:PUT",<br/>        "lambda:InvokeFunction",<br/>        "lambda:GetFunction",<br/>        "lambda:UpdateFunctionConfiguration",<br/>        "cloudformation:DescribeStacks",<br/>        "lambda:UpdateFunctionCode",<br/>        "lambda:DeleteFunctionConcurrency",<br/>        "events:DeleteRule",<br/>        "events:PutTargets",<br/>        "lambda:AddPermission",<br/>        "cloudformation:CreateStack",<br/>        "cloudformation:DeleteStack",<br/>        "apigateway:POST",<br/>        "lambda:RemovePermission",<br/>        "lambda:GetPolicy"<br/>      ],<br/>      "Resource": "*"<br/>    },<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "s3:ListBucketMultipartUploads",<br/>        "s3:CreateBucket",<br/>        "s3:ListBucket"<br/>      ],<br/>      "Resource": "arn:aws:s3:::zappa-*"<br/>    },<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "s3:PutObject",<br/>        "s3:GetObject",<br/>        "s3:AbortMultipartUpload",<br/>        "s3:DeleteObject",<br/>        "s3:ListMultipartUploadParts"<br/>      ],<br/>      "Resource": "arn:aws:s3:::zappa-*/*"<br/>    }<br/>  ]<br/>}</span></pre><p id="98c7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您将为Zappa创建的凭证添加到您的本地文件(凭证和配置)，我的如下所示</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="6de6" class="ms lf it mm b gy mt mu l mv mw">[default]<br/>aws_access_key_id = ****<br/>aws_secret_access_key = ****</span><span id="b3f4" class="ms lf it mm b gy mx mu l mv mw">[zappa]<br/>aws_access_key_id = ****<br/>aws_secret_access_key = ****</span></pre><p id="0df3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像这样配置</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="9d56" class="ms lf it mm b gy mt mu l mv mw">[default]<br/>region = ap-southeast-1<br/>output = json</span><span id="734b" class="ms lf it mm b gy mx mu l mv mw">[zappa]<br/>region = ap-southeast-1<br/>output = json</span></pre><p id="5b1d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我专门为Zappa创建了一个，因为我相信我们大多数人都会有自己的默认凭证，这个设置可以让你在不同的配置文件之间切换。</p><p id="b2aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在它已经准备好部署了！</p><pre class="mc md me mf gt mo mm mp mq aw mr bi"><span id="df71" class="ms lf it mm b gy mt mu l mv mw">export AWS_DEFAULT_PROFILE=zappa<br/>zappa deploy production</span></pre><p id="7455" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您会在命令行后面看到您的API url。现在转到您的AWS Lambda，您应该会看到我们部署的API:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi my"><img src="../Images/88bba813b1de3edc2d6957c3849b1f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBnK2Bpk6XQ0Zh2koF3J-w.png"/></div></div></figure><p id="c6f8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在API Gateway中，您可以看到:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nf"><img src="../Images/bbc422ab1bce956a1d10654c9834f1dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hlmfH4fsE_qom4ClQS2h-Q.png"/></div></div></figure><p id="ba4d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">既然我可以在postman上测试公共端点并获得响应:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ng"><img src="../Images/d6b28268d7fe38c9f4ad34951b439fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oH5JumeDWC3pZkoZQwTVEQ.png"/></div></div></figure><p id="0df2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">恭喜你。现在你已经用Lambda和API Gateway把你的应用完全部署到AWS上了！</p><p id="7966" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果这已经满足了您的需要，您可以就此打住，但是如果您想要分发您的API并为其添加限制，您可以继续下一部分。</p><h1 id="4e29" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">Extra1:向API添加密钥</h1><p id="06b5" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">您可能已经注意到，到目前为止，我们的API是公开可访问的，这意味着任何人都可以访问我们的API，它很容易受到恶意攻击。为了避免这种不受欢迎的访问，我们需要对我们的API使用(使用计划)和凭证(x-api-key)添加额外的限制来限制访问。</p><p id="6e36" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要给你的API添加一个密钥，请遵循这里的步骤<a class="ae mb" href="https://medium.com/@bansalnagesh/how-to-sell-your-apis-b4b5c9a273f8" rel="noopener"/>。</p><h1 id="2e5e" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">Extra2:通过RapidAPI发布您的API</h1><p id="6ff6" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">RapidAPI 是每个人都可以免费向全世界开放和出售他们的API的地方，只要有人愿意为此付费。</p><ol class=""><li id="eca0" class="nh ni it kk b kl km ko kp kr nj kv nk kz nl ld nm nn no np bi translated">转到<a class="ae mb" href="https://a419iuifac.execute-api.ap-southeast-1.amazonaws.com/production" rel="noopener ugc nofollow" target="_blank"> RapidAPI </a>并点击<code class="fe mj mk ml mm b">Add New API</code></li><li id="d150" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated">填写您的API的基本信息</li><li id="8bf1" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated">对于API的URL，粘贴我们之前通过Zappa部署后获得的AWS url</li><li id="f4c2" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated">在访问控制中添加您的api密钥，如下所示</li></ol><figure class="mc md me mf gt mg gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/b3a43f252f76d8c6d8c352e44b08f123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*76wvhcxYYb90j499nVwlGQ.png"/></div></figure><p id="8f06" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.添加一个定价计划，您就可以向公众推出它了！</p><p id="c924" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，如果你有兴趣，你可以看看我的<a class="ae mb" href="https://rapidapi.com/zhangyue9306/api/job-referral/endpoints" rel="noopener ugc nofollow" target="_blank">推荐API </a>。如果你正在寻找一份新的职业，到目前为止，它可以帮助你找到Bytedance公司，并通过内部门户网站进行抓取。</p><p id="0bb7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个帖子最初是受<a class="ae mb" rel="noopener" target="_blank" href="/develop-and-sell-a-python-api-from-start-to-end-tutorial-9a038e433966">这个</a>的启发，一个很棒的帖子帮助我开始了这个计划，请随意查看！</p></div></div>    
</body>
</html>