<html>
<head>
<title>How to synchronize Elasticsearch with MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用MySQL同步Elasticsearch</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-synchronize-elasticsearch-with-mysql-ed32fc57b339?source=collection_archive---------1-----------------------#2020-11-12">https://towardsdatascience.com/how-to-synchronize-elasticsearch-with-mysql-ed32fc57b339?source=collection_archive---------1-----------------------#2020-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="621a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Logstash创建一个连接Elasticsearch和MySQL的数据管道，以便从零开始建立一个索引，并将数据库记录上发生的任何变化复制到Elasticsearch中</h2></div><h2 id="4e13" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">快速访问链接</h2><ul class=""><li id="c0d5" class="lb lc iq ld b le lf lg lh ko li ks lj kw lk ll lm ln lo lp bi translated">GitHub上的资源库:<a class="ae lq" href="https://github.com/redouane-dev/sync-elasticsearch-mysql" rel="noopener ugc nofollow" target="_blank"> sync-elasticsearch-mysql </a>。</li></ul><h2 id="07db" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">技术栈</h2><ul class=""><li id="ff6d" class="lb lc iq ld b le lf lg lh ko li ks lj kw lk ll lm ln lo lp bi translated">MySQL作为主数据库(版本8.0.22)</li><li id="3cd5" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">作为文本搜索引擎的弹性搜索(版本7.9.3)</li><li id="33ee" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">Logstash作为从MySQL到Elasticsearch的连接器或数据管道(7.9.3版)</li><li id="1cb4" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">用于监控和数据可视化的Kibana(版本7.9.3)</li><li id="6e4c" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">JDBC连接器/J(版本8.0.22)</li></ul><h2 id="6d4a" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">内容</h2><ul class=""><li id="8ab4" class="lb lc iq ld b le lf lg lh ko li ks lj kw lk ll lm ln lo lp bi translated">问题陈述</li><li id="6014" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">解决方案<br/> -使用Logstash的好处<br/> -用例</li><li id="a380" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">实施概念验证<br/> -为项目创建主机目录<br/> -设置MySQL数据库<br/> -设置Elasticsearch和Kibana <br/> -设置Logstash将数据从MySQL传输到Elasticsearch: <br/> *第一个场景—从头开始创建Elasticsearch索引<br/> *第二个场景—将数据库记录的更改复制到Elasticsearch</li><li id="2163" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">结论</li><li id="a8bb" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">资源</li></ul><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/fa58b6501b2cc23301926a2799f16245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QMSK_VDh23IsCc6l"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">照片由<a class="ae lq" href="https://unsplash.com/@seb?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sébastien Jermer </a>在<a class="ae lq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="59c7" class="mm kg iq bd kh mn mo mp kk mq mr ms kn jw mt jx kr jz mu ka kv kc mv kd kz mw bi translated">问题陈述</h1><p id="b42c" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi nk translated"><span class="l nl nm nn bm no np nq nr ns di">科技公司的一个常见场景是开始围绕一个或多个数据库构建其核心业务功能，然后开始将服务连接到这些数据库，以对文本数据执行搜索，例如在用户表的用户地址列中搜索街道名称，或者在图书馆的目录中搜索书名和作者姓名。</span></p><p id="e29d" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">到目前为止一切都很好。公司不断发展壮大，获得了越来越多的客户。但随后搜索速度开始变得越来越慢，这往往会激怒他们的客户，并很难说服新的潜在客户购买。</p><p id="b37e" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">从本质上看，工程师们意识到MySQL的<code class="fe ny nz oa ob b">FULLTEXT </code>索引对于在大型数据集上进行文本查找并不理想，为了扩大他们的业务，工程师们决定转向更专用的、经过实战检验的文本搜索引擎。</p><p id="6591" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">进入Elasticsearch及其底层<a class="ae lq" href="https://lucene.apache.org/core/" rel="noopener ugc nofollow" target="_blank"> Lucene搜索引擎</a>。Elasticsearch使用一个<a class="ae lq" href="https://en.wikipedia.org/wiki/Inverted_index" rel="noopener ugc nofollow" target="_blank">倒排文档索引</a>来索引数据，这导致了极快的全文搜索。</p><p id="f6b5" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">一个新的挑战随之而来:<strong class="ld ir">如何将MySQL数据库中的数据放入Elasticsearch索引，以及如何保持后者与前者同步？</strong></p><h1 id="aa2d" class="mm kg iq bd kh mn mo mp kk mq mr ms kn jw mt jx kr jz mu ka kv kc mv kd kz mw bi translated">解决办法</h1><p id="3005" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi nk translated">现代数据管道工的工具包中包含了大量的软件，可用于任何数据操作任务。在本文中，我们将关注来自<a class="ae lq" href="https://www.elastic.co/what-is/elk-stack" rel="noopener ugc nofollow" target="_blank"> ELK stack </a>的Logstash，以便定期从MySQL获取数据，并将其镜像到Elasticsearch上。这将考虑到MySQL数据记录的任何变化，如<code class="fe ny nz oa ob b">create</code>、<code class="fe ny nz oa ob b">update</code>和<code class="fe ny nz oa ob b">delete</code>，并在Elasticsearch文档中复制相同的内容。</p><h2 id="be56" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">使用Logstash的好处</h2><p id="3fb6" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi translated">我们在这里试图解决的问题——定期从MySQL向Elasticsearch发送数据以同步两者——可以通过cron作业或任何作业调度程序运行的Shell或Python脚本来解决，但这将剥夺我们通过配置Logstash及其基于插件的设置所获得的好处:</p><ul class=""><li id="fd0a" class="lb lc iq ld b le nt lg nu ko oc ks od kw oe ll lm ln lo lp bi translated">虽然我们在这里主要关注MySQL，<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html" rel="noopener ugc nofollow" target="_blank"> Logstash可以从许多来源获取数据，</a>使它成为一个集中式数据输入节点。</li><li id="509f" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">当数据从源传递到目的地时，Logstash提供了动态解析、转换和过滤数据的可能性。</li><li id="2ae4" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">至于输入源，有<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html" rel="noopener ugc nofollow" target="_blank">许多输出目的地可用</a>——elastic search是首选输出。</li><li id="9e96" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">作为ELK堆栈的一部分，稍后，Elasticsearch和Kibana将为度量和可视化提供很好的整合。</li></ul><h2 id="d341" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">用例</h2><p id="65f8" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi translated">我们将在以下步骤中介绍两种情况:</p><ol class=""><li id="a7cc" class="lb lc iq ld b le nt lg nu ko oc ks od kw oe ll of ln lo lp bi translated">从头开始创建弹性搜索索引和索引数据库记录<em class="og">。</em></li><li id="2dbb" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll of ln lo lp bi translated"><em class="og">增量</em> <em class="og">根据数据库记录发生的变化(创建、更新、删除)更新弹性搜索索引的</em>。</li></ol><h1 id="7b59" class="mm kg iq bd kh mn mo mp kk mq mr ms kn jw mt jx kr jz mu ka kv kc mv kd kz mw bi translated">实施概念验证</h1><p id="3ecb" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi translated">想象一下，你正在开一个在线图书馆，热心的读者可以在那里搜索你的图书目录，找到他们的下一本书。您的目录包含数百万个标题，从科学文献卷到有关异国冒险的小册子。</p><p id="b004" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们将创建一个初始数据库表<code class="fe ny nz oa ob b">books</code>,其中有几千条记录，包括书名、作者、ISBN和出版日期。我们将使用可以在Kaggle 上找到的<a class="ae lq" href="https://www.goodreads.com/" rel="noopener ugc nofollow" target="_blank"> Goodreads </a>图书目录。这个初始表将用于构建用例的原型(1)从零开始构建索引。</p><p id="2d19" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们将在表<code class="fe ny nz oa ob b">books</code>上创建触发器，该触发器将用<code class="fe ny nz oa ob b">books</code>表上的所有更改填充日志表<code class="fe ny nz oa ob b">books_journal</code>(例如<code class="fe ny nz oa ob b">create</code>、<code class="fe ny nz oa ob b">update</code>、<code class="fe ny nz oa ob b">delete</code>)。这意味着无论何时在<code class="fe ny nz oa ob b">books</code>表上创建、更新或删除一条记录，该操作都将被记录在<code class="fe ny nz oa ob b">books_journal</code>表上，同样的操作也将在相应的Elasticsearch文档上执行。这将用于原型用例(2)弹性搜索指数的增量更新。</p><p id="0675" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们将通过使用<a class="ae lq" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> docker-compose </a>定义微服务架构来原型化和测试上述概念。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/887d03c4c70f46bc2d8647fe3d64dd94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*Y41nmy6XiIlCno6wtif0RQ.png"/></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">该项目的建筑——作者图片</p></figure><h2 id="0dbe" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">先决条件</strong></h2><ul class=""><li id="5822" class="lb lc iq ld b le lf lg lh ko li ks lj kw lk ll lm ln lo lp bi translated"><a class="ae lq" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">安装对接器</a>和<a class="ae lq" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank">对接器组成</a></li></ul><h2 id="7f1c" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">步骤</strong></h2><blockquote class="oi oj ok"><p id="4498" class="mx my og ld b le nt jr mz lg nu ju na ol nv nc nd om nw nf ng on nx ni nj ll ij bi translated">完整的源代码可以在GitHub的<a class="ae lq" href="https://github.com/redouane-dev/sync-elasticsearch-mysql" rel="noopener ugc nofollow" target="_blank">sync-elastic search-MySQL</a>找到。</p></blockquote><ol class=""><li id="d711" class="lb lc iq ld b le nt lg nu ko oc ks od kw oe ll of ln lo lp bi translated"><strong class="ld ir">首先创建一个目录</strong>来托管这个项目(命名为<code class="fe ny nz oa ob b">sync-elasticsearch-mysql</code>)，并在该目录中创建一个docker-compose.yaml文件，初始设置如下:</li></ol><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="a114" class="kf kg iq ob b gy os ot l ou ov">version: "3"<br/>services:<br/>...<br/># Here will come the services definition<br/>...</span></pre><p id="deea" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir"> 2。设置一个MySQL数据库:</strong>创建一个目录<code class="fe ny nz oa ob b">data/</code>，我们将在其中存储MySQL转储文件，这些文件包含<code class="fe ny nz oa ob b">books</code>表的预清理图书数据，以及<code class="fe ny nz oa ob b">books</code>表的触发器(关于创建、更新和删除)，还有一个<code class="fe ny nz oa ob b">new_arrivals</code>表，其中包含我们将添加到目录中以模拟新记录的图书，以及表<code class="fe ny nz oa ob b">books_journal</code>。</p><p id="12ed" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">您可以在<a class="ae lq" href="https://github.com/redouane-dev/sync-elasticsearch-mysql/tree/main/data" rel="noopener ugc nofollow" target="_blank">项目资源库</a>中找到这些转储文件。请将它们复制到<code class="fe ny nz oa ob b">data/</code>目录，以便MySQL容器在启动过程中将它们添加到<code class="fe ny nz oa ob b">books</code>数据库中。</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="1e4f" class="kf kg iq ob b gy os ot l ou ov">version: "3"<br/>services:<br/>  # add this:<br/>  mysql:<br/>    image: mysql:8<br/>    container_name: sem_mysql<br/>    ports:<br/>      - 3306:3306<br/>    environment:<br/>      MYSQL_RANDOM_ROOT_PASSWORD: "yes"<br/>      MYSQL_DATABASE: books<br/>      MYSQL_USER: avid_reader<br/>      MYSQL_PASSWORD: i_love_books<br/>    volumes:<br/>      # Dump files for initiating tables<br/>      - ./data/:/docker-entrypoint-initdb.d/</span></pre><blockquote class="oi oj ok"><p id="99ff" class="mx my og ld b le nt jr mz lg nu ju na ol nv nc nd om nw nf ng on nx ni nj ll ij bi translated">请注意，不建议在源代码中以纯文本形式存储用户名和密码。以上只是为了建立这个项目的原型，在任何情况下都不是推荐的做法。</p></blockquote><p id="694f" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">要启动MySQL并检查数据是否已成功添加，请在终端上运行项目目录:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="6214" class="kf kg iq ob b gy os ot l ou ov">docker-compose up -d mysql # -d is for detached mode</span><span id="bd6e" class="kf kg iq ob b gy ow ot l ou ov"># Once container started, log into the MySQL container<br/>docker exec -it sem_mysql bash</span><span id="bc45" class="kf kg iq ob b gy ow ot l ou ov"># Start a MySQL prompt<br/>mysql -uavid_reader -pi_love_books</span><span id="cfdc" class="kf kg iq ob b gy ow ot l ou ov"># Check that tables have been loaded from dump files<br/>use books;<br/>show tables;</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ox"><img src="../Images/26d64b890991e4868460fa03ee5fd84d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XTn72P2P5lgk2fOjuNiHgQ.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">可用表格列表和数据示例—按作者分类的图片</p></figure><p id="524c" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">要以类似JSON的格式显示触发器，请使用命令:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="6e91" class="kf kg iq ob b gy os ot l ou ov">SHOW TRIGGERS \G;</span><span id="3465" class="kf kg iq ob b gy ow ot l ou ov"># To exit the MySQL prompt press CTRL+D<br/># To logout from the MySQL container, press CTRL+D</span></pre><p id="e15b" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">既然我们已经正确地建立了数据库，我们就可以继续进行这个项目的实质性工作了。</p><p id="527b" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir"> 3。设置Elasticsearch和Kibana: </strong>要设置Elasticsearch(还没有索引任何文档)，请将其添加到docker-compose.yaml文件中:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="d4f6" class="kf kg iq ob b gy os ot l ou ov">version: "3"<br/>services:<br/>...<br/>  elasticsearch:<br/>    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.3<br/>    container_name: sem_elasticsearch<br/>    environment:<br/>      - discovery.type=single-node<br/>      - bootstrap.memory_lock=true<br/>      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"<br/>    volumes:<br/>      - ./volumes/elasticsearch:/usr/share/elasticsearch/data<br/>    logging:<br/>        driver: "json-file"<br/>        options:<br/>            max-size: "10k"<br/>            max-file: "10"<br/>  kibana:<br/>    image: docker.elastic.co/kibana/kibana:7.9.3<br/>    container_name: sem_kibana<br/>    environment:<br/>      - "ELASTICSEARCH_URL=<a class="ae lq" href="http://elasticsearch:9200" rel="noopener ugc nofollow" target="_blank">http://elasticsearch:9200</a>"<br/>      - "SERVER_NAME=127.0.0.1"<br/>    ports:<br/>      - 5601:5601<br/>    depends_on:<br/>      - elasticsearch</span></pre><blockquote class="oi oj ok"><p id="7ea4" class="mx my og ld b le nt jr mz lg nu ju na ol nv nc nd om nw nf ng on nx ni nj ll ij bi translated">请注意，为了将弹性搜索索引数据从docker卷挂载到您的目录文件系统，建议使用卷定义。</p></blockquote><p id="3a51" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">要启动Elasticsearch和Kibana，请从您的项目目录运行以下命令:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="e25f" class="kf kg iq ob b gy os ot l ou ov">docker-compose up -d elasticsearch kibana # -d is for detached mode</span><span id="90dc" class="kf kg iq ob b gy ow ot l ou ov"># To check if everything so far  is running as it should, run:<br/>docker-compose ps</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi oy"><img src="../Images/3cd3e039f6af7ac64f61636e837af34b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P8NK8ixComX2Xu51QrU_dg.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">在执行上述命令后，3个容器应该启动并运行——Image by Author</p></figure><p id="e5fd" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">让我们检查到目前为止我们的Elasticsearch节点中是否有任何索引:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="d7ae" class="kf kg iq ob b gy os ot l ou ov"># On your terminal, log into the Elasticsearch container<br/>docker exec -it sem_elasticsearch bash</span><span id="b2e4" class="kf kg iq ob b gy ow ot l ou ov"># Once logged in, use curl to request a listing of the indexes<br/>curl localhost:9200/_cat/indices</span></pre><p id="16f6" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">如果Kibana已经启动并运行，您将看到一个用于度量和可视化的索引列表，但是还没有与我们的书相关的内容——如果Kibana还没有启动，索引列表将是空的。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi oz"><img src="../Images/63f2b6d3364a01fbdf6f4f92ef10bd25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rEaviHEujxQqwfMjde-FPA.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">由Kibana创建的索引列表—图片由作者提供</p></figure><p id="9cbb" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir"> 4。设置Logstash将数据从MySQL传输到Elasticsearch: </strong></p><p id="972f" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">为了将Logstash连接到MySQL，我们将使用官方的JDBC驱动程序，该驱动程序可以在<a class="ae lq" href="https://dev.mysql.com/downloads/connector/j/" rel="noopener ugc nofollow" target="_blank">这个地址</a>获得。</p><p id="2679" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">让我们创建一个Dockerfile(在同一个目录中命名为<code class="fe ny nz oa ob b">Dockerfile-logstash</code>)来提取一个Logstash映像，下载JDBC连接器，并启动一个Logstash容器。将这些行添加到您的docker文件中:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="926b" class="kf kg iq ob b gy os ot l ou ov">FROM docker.elastic.co/logstash/logstash:7.9.3</span><span id="f2f9" class="kf kg iq ob b gy ow ot l ou ov"># Download JDBC connector for Logstash<br/>RUN curl -L --output "mysql-connector-java-8.0.22.tar.gz" "<a class="ae lq" href="https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.22.tar.gz" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.22.tar.gz</a>" \<br/>    &amp;&amp; tar -xf "mysql-connector-java-8.0.22.tar.gz" "mysql-connector-java-8.0.22/mysql-connector-java-8.0.22.jar" \<br/>    &amp;&amp; mv "mysql-connector-java-8.0.22/mysql-connector-java-8.0.22.jar" "mysql-connector-java-8.0.22.jar" \<br/>    &amp;&amp; rm -r "mysql-connector-java-8.0.22" "mysql-connector-java-8.0.22.tar.gz"</span><span id="9d5b" class="kf kg iq ob b gy ow ot l ou ov">ENTRYPOINT ["/usr/local/bin/docker-entrypoint"]</span></pre><p id="c692" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">然后将下面的代码片段添加到docker-compose.yaml文件中:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="7988" class="kf kg iq ob b gy os ot l ou ov">version: "3"<br/>services:<br/>...<br/>  logstash:<br/>    build:<br/>      context: .<br/>      dockerfile: Dockerfile-logstash<br/>    container_name: sem_logstash<br/>    depends_on:<br/>      - mysql<br/>      - elasticsearch<br/>    volumes:<br/>      # We will explain why and how to add volumes below</span></pre><p id="2e6b" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">Logstash使用定义的管道来知道从哪里获取数据，如何过滤数据，以及数据应该去往哪里。我们将定义两个管道:一个用于从头创建一个Elasticsearch索引(第一个场景)，另一个用于数据库记录变更的增量更新(第二个场景)。</p><p id="a3f8" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">有关管道定义中使用的每个字段的解释，请查看文档:</p><ul class=""><li id="34be" class="lb lc iq ld b le nt lg nu ko oc ks od kw oe ll lm ln lo lp bi translated">输入:<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html" rel="noopener ugc nofollow" target="_blank"> JDBC输入插件</a></li><li id="138c" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">过滤:<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-mutate.html#plugins-filters-mutate-remove_field" rel="noopener ugc nofollow" target="_blank">变异</a> <code class="fe ny nz oa ob b"><a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-mutate.html#plugins-filters-mutate-remove_field" rel="noopener ugc nofollow" target="_blank">remove_field</a></code></li><li id="dd9a" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">输出:<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch输出插件</a></li></ul><p id="5fb4" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir"> 4.a .第一个场景——从头开始创建弹性搜索指数:</strong></p><p id="fe97" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在您的项目目录中，创建一个<code class="fe ny nz oa ob b">volumes</code>文件夹(如果还没有创建的话),然后创建一个目录来托管我们的Logstash配置:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="e5b0" class="kf kg iq ob b gy os ot l ou ov">mkdir -p volumes/logstash/config</span></pre><p id="a18c" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">然后在这个配置目录下，创建一个文件<code class="fe ny nz oa ob b">pipelines.yml</code>，包含:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="f10b" class="kf kg iq ob b gy os ot l ou ov">- pipeline.id: from-scratch-pipeline<br/>  path.config: "/usr/share/logstash/pipeline/from-scratch.conf"</span></pre><p id="9c9e" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">然后，我们创建一个文件夹<code class="fe ny nz oa ob b">pipeline</code>来存放我们的管道定义:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="3320" class="kf kg iq ob b gy os ot l ou ov">mkdir volumes/logstash/pipeline</span></pre><p id="1d45" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">并在那里创建一个文件<code class="fe ny nz oa ob b">from-scratch.conf</code>，内容如下:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="1880" class="kf kg iq ob b gy os ot l ou ov">input {<br/>  jdbc {<br/>    jdbc_driver_library =&gt; "/usr/share/logstash/mysql-connector-java-8.0.22.jar"<br/>    jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"<br/>    jdbc_connection_string =&gt; "jdbc:mysql://mysql:3306"<br/>    jdbc_user =&gt; "avid_reader"<br/>    jdbc_password =&gt; "i_love_books"<br/>    clean_run =&gt; true<br/>    record_last_run =&gt; false<br/>    statement_filepath =&gt; "/usr/share/logstash/config/queries/from-scratch.sql"<br/>  }<br/>}</span><span id="0135" class="kf kg iq ob b gy ow ot l ou ov">filter {<br/>  mutate {<br/>    remove_field =&gt; ["<a class="ae lq" href="http://twitter.com/version" rel="noopener ugc nofollow" target="_blank">@version</a>", "<a class="ae lq" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>"]<br/>  }<br/>}</span><span id="225b" class="kf kg iq ob b gy ow ot l ou ov">output {<br/>  # stdout { codec =&gt; rubydebug { metadata =&gt; true } }<br/>  elasticsearch {<br/>    hosts =&gt; ["<a class="ae lq" href="http://elasticsearch:9200" rel="noopener ugc nofollow" target="_blank">http://elasticsearch:9200</a>"]<br/>    index =&gt; "books"<br/>    action =&gt; "index"<br/>    document_id =&gt; "%{isbn}"<br/>  }<br/>}</span></pre><p id="a760" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们在<code class="fe ny nz oa ob b">jdbc_driver_library</code>中定义了在哪里找到JDBC连接器，在<code class="fe ny nz oa ob b">jdbc_connection_string</code>中设置了在哪里找到MySQL，在<code class="fe ny nz oa ob b">clean_run</code>中指示插件从头开始运行，并且我们在<code class="fe ny nz oa ob b">statement_filepath</code>中定义了在哪里找到SQL语句来获取和格式化数据记录。</p><p id="79da" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">过滤器基本上删除了插件添加的额外字段。</p><p id="4ab9" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在输出中，我们定义在哪里找到Elasticsearch主机，将索引的名称设置为<code class="fe ny nz oa ob b">books</code>(可以是新的或现有的索引)，定义要执行的操作(可以是<code class="fe ny nz oa ob b">index</code>、<code class="fe ny nz oa ob b">create</code>、<code class="fe ny nz oa ob b">update</code>、<code class="fe ny nz oa ob b">delete</code> — <a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-action" rel="noopener ugc nofollow" target="_blank">参见文档</a>，并设置哪个字段将作为<code class="fe ny nz oa ob b">books</code>索引中的唯一ID—<a class="ae lq" href="https://en.wikipedia.org/wiki/International_Standard_Book_Number" rel="noopener ugc nofollow" target="_blank">ISBN是图书的国际唯一ID</a>。</p><p id="d3e4" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">为了添加由<code class="fe ny nz oa ob b">statement_filepath</code>引用的SQL查询，让我们创建一个文件夹<code class="fe ny nz oa ob b">queries</code>:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="d087" class="kf kg iq ob b gy os ot l ou ov">mkdir volumes/logstash/config/queries/</span></pre><p id="dd99" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">然后添加文件<code class="fe ny nz oa ob b">from-scratch.sql</code>，只有:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="f877" class="kf kg iq ob b gy os ot l ou ov">SELECT * FROM books.books</span></pre><p id="f822" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">用到目前为止我们的<code class="fe ny nz oa ob b">books</code>表中所有可用的记录构建我们的索引。注意，查询不应该以分号(；).</p><p id="9598" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">现在，要挂载上面创建的配置文件和定义，请将以下内容添加到docker-compose.yaml文件中:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="5204" class="kf kg iq ob b gy os ot l ou ov">version: "3"<br/>services:<br/>...<br/>  logstash:<br/>    ...<br/>    volumes:<br/>      - ./volumes/logstash/pipeline/:/usr/share/logstash/pipeline/<br/>      - ./volumes/logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml<br/>      - ./volumes/logstash/config/queries/:/usr/share/logstash/config/queries/</span></pre><blockquote class="oi oj ok"><p id="e365" class="mx my og ld b le nt jr mz lg nu ju na ol nv nc nd om nw nf ng on nx ni nj ll ij bi translated">请注意，<code class="fe ny nz oa ob b">volumes</code>指令是一种告诉Docker将容器内的目录或文件(的右侧)挂载到您的机器或服务器上的目录或文件(的左侧)的方式。在<code class="fe ny nz oa ob b">volumes</code>上查看<a class="ae lq" href="https://docs.docker.com/compose/compose-file/#volumes" rel="noopener ugc nofollow" target="_blank">官方Docker撰写文档</a>。</p></blockquote><p id="d421" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir">测试</strong></p><p id="b655" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">为了测试第一个场景的实现，在您的终端上运行:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="57c6" class="kf kg iq ob b gy os ot l ou ov">docker-compose up logstash</span></pre><p id="e708" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">如果运行成功，您将看到类似于<code class="fe ny nz oa ob b">Logstash shut down</code>的消息，容器将退出，并返回错误代码0。</p><p id="e8b0" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">现在在你的浏览器上打开Kibana(例如<a class="ae lq" href="http://localhost:5601/app/monitoring#/elasticsearch/indices" rel="noopener ugc nofollow" target="_blank">这个链接</a>，让我们开始尝试看看我们是否有一个<code class="fe ny nz oa ob b">books</code>索引，以及我们如何搜索书籍。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pa"><img src="../Images/c46869de29e255c1fa9a26235be151e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uczg_Zl3VPzqsBm2x3FAJw.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">图书索引已成功创建，包含1k个文档—图片由作者提供</p></figure><p id="2051" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在Dev Tools面板中，您可以运行定制查询来通过字段值获取文档。例如，让我们搜索标题中带有“魔法”一词的书籍。将此查询粘贴到开发工具控制台上:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="165d" class="kf kg iq ob b gy os ot l ou ov">GET books/_search<br/>{<br/>  "query": {<br/>    "match": {<br/>      "title": "magic"<br/>    }<br/>  }<br/>}</span></pre><p id="07d1" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们得到9份文件:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pb"><img src="../Images/071c0a9641b9f6dc048d9affbb6492ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVQbiLpT1lPZY0zM0WcDMA.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">搜索标题中包含“魔法”一词的书籍-作者图片</p></figure><figure class="lx ly lz ma gt mb"><div class="bz fp l di"><div class="pc pd l"/></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">图片由<a class="ae lq" href="https://media.giphy.com/media/5pUxc9KypDZSkGRRXe/giphy.gif" rel="noopener ugc nofollow" target="_blank"> Giphy </a>提供</p></figure></div><div class="ab cl pe pf hu pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="ij ik il im in"><p id="547c" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir"> 4.b .第二个场景—将数据库记录上的更改复制到Elasticsearch: </strong></p><p id="7565" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">大部分配置和调整已经在前一部分完成。我们将简单地添加另一个管道来负责增量更新(复制)。</p><p id="f4d4" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在文件<code class="fe ny nz oa ob b">volumes/logstash/config/pipelines.yml</code>中，添加这两行:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="6de3" class="kf kg iq ob b gy os ot l ou ov">- pipeline.id: incremental-pipeline<br/>  path.config: "/usr/share/logstash/pipeline/incremental.conf"</span></pre><p id="7158" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在同一个文件中，您可能想要注释掉与“从头开始”部分(第一个场景)相关的前两行，以便指示Logstash只运行这个增量管道。</p><p id="51ff" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">让我们在目录<code class="fe ny nz oa ob b">volumes/logstash/pipeline/</code>中创建一个文件<code class="fe ny nz oa ob b">incremental.conf</code>，内容如下:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="f459" class="kf kg iq ob b gy os ot l ou ov">input {<br/>  jdbc {<br/>    jdbc_driver_library =&gt; "/usr/share/logstash/mysql-connector-java-8.0.22.jar"<br/>    jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"<br/>    jdbc_connection_string =&gt; "jdbc:mysql://mysql:3306"<br/>    jdbc_user =&gt; "avid_reader"<br/>    jdbc_password =&gt; "i_love_books"<br/>    statement_filepath =&gt; "/usr/share/logstash/config/queries/incremental.sql"<br/>    use_column_value =&gt; true<br/>    tracking_column =&gt; "journal_id"<br/>    tracking_column_type =&gt; "numeric"<br/>    schedule =&gt; "*/5 * * * * *"<br/>  }<br/>}</span><span id="0bf3" class="kf kg iq ob b gy ow ot l ou ov">filter {<br/>  if [action_type] == "create" or [action_type] == "update" {<br/>    mutate { add_field =&gt; { "[<a class="ae lq" href="http://twitter.com/metadata" rel="noopener ugc nofollow" target="_blank">@metadata</a>][action]" =&gt; "index" } }<br/>  } else if [action_type] == "delete" {<br/>    mutate { add_field =&gt; { "[<a class="ae lq" href="http://twitter.com/metadata" rel="noopener ugc nofollow" target="_blank">@metadata</a>][action]" =&gt; "delete" } }<br/>  }</span><span id="cbf6" class="kf kg iq ob b gy ow ot l ou ov">mutate {<br/>    remove_field =&gt; ["<a class="ae lq" href="http://twitter.com/version" rel="noopener ugc nofollow" target="_blank">@version</a>", "<a class="ae lq" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>", "action_type"]<br/>  }<br/>}</span><span id="de2d" class="kf kg iq ob b gy ow ot l ou ov">output {<br/>  # stdout { codec =&gt; rubydebug { metadata =&gt; true } }<br/>  elasticsearch {<br/>    hosts =&gt; ["<a class="ae lq" href="http://elasticsearch:9200" rel="noopener ugc nofollow" target="_blank">http://elasticsearch:9200</a>"]<br/>    index =&gt; "books"<br/>    action =&gt; "%{[<a class="ae lq" href="http://twitter.com/metadata" rel="noopener ugc nofollow" target="_blank">@metadata</a>][action]}"<br/>    document_id =&gt; "%{isbn}"<br/>  }<br/>}</span></pre><p id="794b" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">与之前的管道定义相比，我们看到了一些额外的参数。</p><p id="a5a3" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><code class="fe ny nz oa ob b">schedule</code>参数有一个类似cron的语法(当左边增加一个值时，分辨率下降到秒)，并在后台使用<a class="ae lq" href="https://github.com/jmettraux/rufus-scheduler" rel="noopener ugc nofollow" target="_blank"> Rufus调度器</a>。这里我们用<code class="fe ny nz oa ob b">*/5 * * * * *</code>指示Logstash每5秒运行一次这个管道。</p><blockquote class="oi oj ok"><p id="b137" class="mx my og ld b le nt jr mz lg nu ju na ol nv nc nd om nw nf ng on nx ni nj ll ij bi translated">网站<a class="ae lq" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> crontab.guru </a>可以帮你读懂crontab表达式。</p></blockquote><p id="b178" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在每次定期运行期间，参数<code class="fe ny nz oa ob b">tracking_column</code>指示Logstash存储获取的最后一条记录的<code class="fe ny nz oa ob b">journal_id</code>值，并将其存储在文件系统上的某个位置(参见<a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html#plugins-inputs-jdbc-last_run_metadata_path" rel="noopener ugc nofollow" target="_blank">文档，此处</a>用于<code class="fe ny nz oa ob b">last_run_metadata_path</code>)。在接下来的运行中，Logstash将从<code class="fe ny nz oa ob b">journal_id + 1</code>开始获取记录，其中<code class="fe ny nz oa ob b">journal_id</code>是当前运行中存储的值。</p><p id="cba1" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在<code class="fe ny nz oa ob b">filter</code>部分中，当数据库操作类型为“创建”或“更新”时，我们将Elasticsearch操作设置为“索引”,这样新文档就会被索引，现有文档也会被重新索引以更新它们的值。避免重新索引现有文档的另一种方法是编写一个定制的“更新”脚本，并使用“更新”动作。对于“删除”操作，Elasticsearch上的文档会被删除。</p><p id="95bc" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">让我们使用以下查询创建并填充目录<code class="fe ny nz oa ob b">volumes/logstash/config/queries/</code>中的文件<code class="fe ny nz oa ob b">incremental.sql</code>:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="22ba" class="kf kg iq ob b gy os ot l ou ov">SELECT<br/>        j.journal_id, j.action_type, j.isbn,<br/>        b.title, b.authors, b.publication_date<br/>FROM books.books_journal j<br/>LEFT JOIN books.books b ON b.isbn = j.isbn<br/>WHERE j.journal_id &gt; :sql_last_value<br/>        AND j.action_time &lt; NOW()<br/>ORDER BY j.journal_id</span></pre><p id="f6ed" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated"><strong class="ld ir">测试</strong></p><p id="8901" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们来看看表<code class="fe ny nz oa ob b">books.new_arrival</code>。它包含刚刚交付给我们的书籍，我们没有时间将它们添加到主<code class="fe ny nz oa ob b">books.books</code>表中。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pl"><img src="../Images/c113ae850eecde7f36c17792e97c6cb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yHrYxbbcx8HICZa87CRQ_w.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">“SELECT * FROM books.new _ arrival”—作者图片</p></figure><p id="77e4" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">如我们所见，该表中没有一本书在我们的Elasticsearch索引中。让我们试试上表中的第三本书《浪漫之路(艾尔西·霍金斯#4)》，ISBN 9780060598891:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pm"><img src="../Images/7ed158a0bce17774bca5c92dc855b0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XjpXtByTR3Dj7BbeNc0Plw.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">搜索ISBN 9780060598891返回空结果—作者图片</p></figure><p id="7524" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">现在，让我们将图书从新到货表转移到我们的主<code class="fe ny nz oa ob b">books</code>表:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="044d" class="kf kg iq ob b gy os ot l ou ov">INSERT INTO books<br/>SELECT * FROM new_arrival WHERE isbn = 9780060598891;</span></pre><p id="fa76" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">在Elasticsearch上运行相同的搜索，我们很高兴地看到该文档现已可用:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pb"><img src="../Images/7b3682dea3c9e944f3030b0190df022a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*654uSRGFzN_tlSB5jahP3A.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">现在ISBN 9780060598891可以在弹性搜索索引上找到——作者图片</p></figure><p id="e85b" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">同步成功了！</p><p id="c60e" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">让我们测试同一个ISBN的更新:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="3b7e" class="kf kg iq ob b gy os ot l ou ov">UPDATE books<br/>SET title = "The Rocky what ??"<br/>WHERE isbn = 9780060598891;</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pa"><img src="../Images/742e3faa02db7b5ead27ca8cf61e0e55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3BJayZ_2rPWo12rXbGHcqQ.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">数据库记录的更新被成功复制到Elasticsearch文档——按作者分类的图片</p></figure><p id="191f" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">…以及删除相同的ISBN:</p><pre class="lx ly lz ma gt oo ob op oq aw or bi"><span id="6063" class="kf kg iq ob b gy os ot l ou ov">DELETE from books WHERE isbn = 9780060598891;</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pn"><img src="../Images/d88628ed193bf41e0362b2bcb25cc8f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0eKxCJbl1wtAlM4XaqjFOQ.png"/></div></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">从数据库中删除的记录也将从elastic search index-Image by Author中删除</p></figure><figure class="lx ly lz ma gt mb"><div class="bz fp l di"><div class="po pd l"/></div><p class="mi mj gj gh gi mk ml bd b be z dk translated">图片由<a class="ae lq" href="https://media.giphy.com/media/WKdPOVCG5LPaM/giphy.gif" rel="noopener ugc nofollow" target="_blank"> Giphy </a>提供</p></figure></div><div class="ab cl pe pf hu pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="ij ik il im in"><h1 id="009a" class="mm kg iq bd kh mn pp mp kk mq pq ms kn jw pr jx kr jz ps ka kv kc pt kd kz mw bi translated">结论</h1><p id="4266" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi translated">我们设法在很短的时间内获得了一个概念证明，即如何从MySQL数据库将数据索引到Elasticsearch中，以及如何使Elasticsearch与数据库保持同步。</p><p id="2dac" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">我们使用的技术是业内的黄金标准，许多企业每天都依赖这些技术来服务他们的客户，很可能许多企业已经遇到或将会遇到我们在这个项目中解决的相同问题。</p><h1 id="893c" class="mm kg iq bd kh mn mo mp kk mq mr ms kn jw mt jx kr jz mu ka kv kc mv kd kz mw bi translated"><strong class="ak">取得联系</strong></h1><p id="2a9b" class="pw-post-body-paragraph mx my iq ld b le lf jr mz lg lh ju na ko nb nc nd ks ne nf ng kw nh ni nj ll ij bi translated">如果你想联系我，或者你只是想让我知道你对这个项目的想法，不要犹豫，留下评论，或者通过电子邮件或<a class="ae lq" href="https://linkedin.com/in/redouane-achouri" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><p id="069d" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">如果你觉得这个教程有用，并且你想支持高质量文章的制作，考虑<a class="ae lq" href="https://www.buymeacoffee.com/redouaneachouri" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a>！</p><p id="e8d0" class="pw-post-body-paragraph mx my iq ld b le nt jr mz lg nu ju na ko nv nc nd ks nw nf ng kw nx ni nj ll ij bi translated">你可以点击“关注”按钮来获取我的最新文章和帖子！</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pu"><img src="../Images/c6cac29c20a9cdd325be670a3ceb550f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*unAZ0wJciBonN2DADyGhtw.gif"/></div></div></figure><h1 id="d28b" class="mm kg iq bd kh mn mo mp kk mq mr ms kn jw mt jx kr jz mu ka kv kc mv kd kz mw bi translated">资源</h1><ul class=""><li id="a3d7" class="lb lc iq ld b le lf lg lh ko li ks lj kw lk ll lm ln lo lp bi translated"><a class="ae lq" href="https://nlp.stanford.edu/IR-book/html/htmledition/a-first-take-at-building-an-inverted-index-1.html" rel="noopener ugc nofollow" target="_blank">首次尝试建立倒排索引</a></li><li id="8408" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated"><a class="ae lq" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html" rel="noopener ugc nofollow" target="_blank">数据输入:文件和索引</a></li><li id="3c58" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated"><a class="ae lq" href="https://www.elastic.co/blog/how-to-keep-elasticsearch-synchronized-with-a-relational-database-using-logstash" rel="noopener ugc nofollow" target="_blank">如何使用Logstash和JDBC保持Elasticsearch与关系数据库同步</a>。这篇文章很有启发性，但是它并不涉及从零开始索引和删除记录。</li><li id="8f21" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated">本项目使用的数据可在Kaggle数据集<a class="ae lq" href="https://www.kaggle.com/jealousleopard/goodreadsbooks" rel="noopener ugc nofollow" target="_blank"> Goodreads-books </a>中获得。</li><li id="caea" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated"><a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html" rel="noopener ugc nofollow" target="_blank">日志JDBC输入插件</a></li><li id="1dc1" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated"><a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-mutate.html" rel="noopener ugc nofollow" target="_blank">日志隐藏变异过滤器插件</a></li><li id="da1f" class="lb lc iq ld b le lr lg ls ko lt ks lu kw lv ll lm ln lo lp bi translated"><a class="ae lq" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html" rel="noopener ugc nofollow" target="_blank"> Logstash Elasticsearch输出插件</a></li></ul></div></div>    
</body>
</html>