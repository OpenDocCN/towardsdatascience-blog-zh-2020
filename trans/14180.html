<html>
<head>
<title>Geospatial Indexing with Quadkeys</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用四键的地理空间索引</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geospatial-indexing-with-quadkeys-d933dff01496?source=collection_archive---------16-----------------------#2020-09-30">https://towardsdatascience.com/geospatial-indexing-with-quadkeys-d933dff01496?source=collection_archive---------16-----------------------#2020-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0e7e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">给地球正方</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/093019f8bbf209f14121e7d926366404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b9aOwxJiTJKjBPkZ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@steve_j?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯蒂夫·约翰森</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="f82c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你在网上或手机上浏览交互式地图时，你看到的是一幅幅方形拼贴画的效果。每个图块包含一点地图信息，并与其周围的八个图块完美匹配。这种安排非常有效，以至于你几乎不可能察觉到你不是在浏览一个无限的位图，而是一个有限的小方块。</p><p id="d650" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文的目的不是深入研究所谓的“<a class="ae ky" href="https://wiki.openstreetmap.org/wiki/Slippy_Map" rel="noopener ugc nofollow" target="_blank">滑动地图</a>的复杂性，而是讨论一个有趣的数学副产品，它用于唯一地引用瓦片，但在地理空间索引应用程序中也非常有用。为了跟踪他们的交互式地图解决方案，微软开发了一个索引概念，这在其在线文档中有详细描述，即<a class="ae ky" href="https://docs.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system" rel="noopener ugc nofollow" target="_blank"> Bing地图磁贴系统</a>。</p><p id="7196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个索引系统还有其他不太明显的应用，比如地理空间区域的划分和它们在数据库中的有效索引。它的工作原理有点像优步的H3，但是它没有使用“六边形”，而是使用了“正方形”的层次结构我在几何形状的名字周围加了引号，因为它们在球体上的投影自然会扭曲它们。</p><p id="3d2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们之前已经看到了使用<a class="ae ky" rel="noopener" target="_blank" href="/fast-geospatial-indexing-with-h3-90e862482585"> H3地理空间索引</a>系统的优势，不仅用于快速参考，还用于快速距离查询。由于它们的几何形状，正方形的工作效率不高。不过，它们也有显著的优势，不仅在为光滑地图生成定制切片时，而且在索引矩形数据时。这里我考虑的是对在线地图服务的查询。这些查询通常需要一个边界框规格，矩形(至少在投影坐标中)，而不是六边形。</p><h1 id="7afe" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">缓存使用案例</h1><p id="c984" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了激励使用Bing地图磁贴系统及其“四键”概念背后的数学，让我们回到我已经发布的关于探索<a class="ae ky" href="https://arxiv.org/abs/1905.02081" rel="noopener ugc nofollow" target="_blank">车辆能源数据集</a>的代码。在之前的一组<a class="ae ky" rel="noopener" target="_blank" href="/geographic-clustering-with-hdbscan-ef8cb0ed6051">文章</a>中，我通过将数据转换成数据库，将出行数据聚类成其端点簇，使用H3计算地理围栏多边形，并最终命名它们来接近VED。</p><p id="079d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命名过程包括通过他们的公共和免费的<a class="ae ky" href="http://overpass-api.de/" rel="noopener ugc nofollow" target="_blank">天桥API </a>从<a class="ae ky" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"> OpenStreetMap </a>服务中检索数据。我还设计了一个非常简单的缓存机制，以避免在开发代码时重复调用API。用户不应该滥用API并尽可能缓存检索到的数据。我缓存API结果的方法很幼稚，因为我使用集群标识符作为文件名的基础。这里没有地理参考，并且如果聚类算法参数化改变，这些文件名容易改变。</p><p id="b71e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在本文中探索的另一个解决方案涉及到使用以某种方式在地理上被引用并且与算法变化无关的文件名。输入四键代码。</p><h1 id="b373" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">四键</h1><p id="21e5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">quadkey这个名字是quadtree key的缩写。这些键中的每一个都编码了由细节级别组织的纬度和经度空间中的正方形区域。在第一层，整个可绘制的地球表面分成四个四键。可以把它想象成一个地图缩放级别，让你看到整个世界。每个四键都有一个一位数的代码，从0到3。通过放大到下一个级别，四个原始四键中的每一个都分裂成四个，我们在代码中添加另一个数字。下面的图片来自微软官方文档，描述了这个过程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/1556f76b1f3db524e565766b954721f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*lk1bJh5c6vdfYUyKXKaYNg.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">上图说明了如何根据位置和细节层次导出四键代码。(图片来源:微软- <a class="ae ky" href="https://docs.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system" rel="noopener ugc nofollow" target="_blank">必应地图磁贴系统</a>)</p></figure><p id="a533" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过查看上面的图像，我们可以立即想象一个可能的“代数”来操作四键。计算特定四键的邻居、孩子或父母的操作会立即浮现在脑海中。也可以查询四键的地理属性，比如角、中心和边的长度。幸运的是，这种数学工具已经以"<a class="ae ky" href="https://docs.muetsch.io/pyquadkey2/" rel="noopener ugc nofollow" target="_blank"> pyquadkey2 </a> " Python包的形式存在。</p><p id="4730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你用低级软件开发人员的眼光来看待四键编码，你会发现编码一个细节层次只需要两位。典型的23级最大值只需要46位来编码，这允许我们使用64位整数来存储这些代码。幸运的是，上面的包所遵循的<a class="ae ky" href="https://github.com/joekarl/binary-quadkey" rel="noopener ugc nofollow" target="_blank">二进制四键</a>的规范已经存在。</p><h1 id="f913" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">缓存示例</h1><p id="b813" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们看看如何在缓存用例中使用四键。这个想法是收集包含所有聚类点的最小四键集，然后只查询OSM的边界坐标。然后，代码将每个回复存储在一个相应的JSON编码的文本文件中，该文件根据使用的四键命名。通过这种方式，我们得到了一个仅依赖于地理位置的OSM数据缓存，而不是依赖于聚类方案。下图显示了编号为52的簇的18级四键。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/403795d0f02e2b7f32c8e29bd2a2aae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2w7v7gJyfwLkBOvYhLeG9Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">上图显示了52号星团，叠加的四键用于缓存其OSM数据。作者创造的形象。</p></figure><p id="27e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所看到的，细节层次的选择是一个重要的决定，它允许您在四键的数量和为每个键收集的信息量之间进行权衡。<a class="ae ky" href="https://docs.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system" rel="noopener ugc nofollow" target="_blank">官方文档</a>包含一个指导您选择细节层次的表格。表格的第三列显示了在赤道以米/像素测量的地面分辨率。选择每像素米作为单位揭示了它的最终目的:使用256像素宽的方形图块的光滑地图。您需要将列值乘以256，以获得赤道上四键边的米数。在第18层，我们得到152.88米。请记住，当你远离赤道，宽度缩小到零。</p><h2 id="248f" class="mu lw it bd lx mv mw dn mb mx my dp mf li mz na mh lm nb nc mj lq nd ne ml nf bi translated">密码</h2><p id="6dc5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要遵循代码描述，请克隆<a class="ae ky" href="https://github.com/joaofig/ved-explore" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>并运行名为:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1908" class="mu lw it nh b gy nl nm l nn no">07-cluster-names-quadkey.ipynb</span></pre><p id="f64d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个文件是一个已有文件的修订版，具有相同的前缀号码和旧的缓存实现。请注意，在运行上面的笔记本之前，您可能必须执行以前的笔记本，以准备好要使用的数据库。</p><p id="ae2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们从管理缓存的函数开始。第一个是对OSM API的低级调用，在没有缓存信息时使用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="273a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个函数使用四键作为输入来查询数据。它确定数据是否已经被缓存，在这种情况下，它只从相应的文件中读取数据，如果没有，则从API中查询数据并缓存它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="24c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意我们是如何查询quadkey在西南角和东北角的地理坐标的。现在我们有了四键数据，我们必须在查询它之前合并它。请记住，每个簇通常有多个四键。为了连接数据，我们必须首先查询它的元素类型，即“node”和“way”，为此我们使用了next函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="5848" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行实际合并的函数剥离所有元数据，只保留“元素”数组。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6596" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，当合并OSM数据包列表时，我们可以使用前面的函数作为构建块。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="226a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该代码使用下面的函数检索与单个集群相关联的四键。每个点被转换成一个四键代码，并添加到一个集合中，为了唯一性，转换回一个列表，并返回。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="1840" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在准备将所有代码放在一个函数中，该函数检索单个集群的合并OSM数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="925f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这个函数开始，笔记本代码非常接近于它的原始版本。唯一有意义的增加是在地图上再现了四键“方块”,如上面星团52的图像所示。</p><h1 id="cf82" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="86d8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">本文展示了如何使用四键数学来生成地理空间索引。这些操作非常类似于H3，但是是正方形而不是六边形。我们已经看到六边形对于某些应用更好，例如KNN搜索。尽管如此，正方形对于模拟sippy地图瓦片和与地球的纬线和经线对齐的矩形区域是完美的。由于将四键代码打包成64位整数更加方便，并且支持非常高效的Python包，四键确实是地理空间工具包中的另一个好工具。</p><h1 id="8a09" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><p id="7c53" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system" rel="noopener ugc nofollow" target="_blank">必应地图磁贴系统</a></p><h1 id="5639" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">资源</h1><p id="34e0" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/joaofig/ved-explore" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a></p><p id="94ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/muety/pyquadkey2" rel="noopener ugc nofollow" target="_blank"> pyquadkey2资源库</a></p><p id="6905" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CartoDB <a class="ae ky" href="https://github.com/CartoDB/python-quadkey" rel="noopener ugc nofollow" target="_blank"> python-quadkey存储库</a>(这里使用的替代包)</p><p id="b144" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">YouTube: <a class="ae ky" href="https://www.youtube.com/watch?v=OXVByYRkUHs" rel="noopener ugc nofollow" target="_blank">地球平铺显示四键</a></p><h1 id="749a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">相关文章</h1><div class="nr ns gp gr nt nu"><a rel="noopener follow" target="_blank" href="/geographic-clustering-with-hdbscan-ef8cb0ed6051"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">使用HDBSCAN进行地理聚类</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">如何使用HDBSCAN、H3、图论和OSM探索地理数据。</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">towardsdatascience.com</p></div></div><div class="od l"><div class="oe l of og oh od oi ks nu"/></div></div></a></div><div class="nr ns gp gr nt nu"><a rel="noopener follow" target="_blank" href="/fast-geospatial-indexing-with-h3-90e862482585"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">H3的快速地理空间索引</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">H3六角电力重装上阵！</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">towardsdatascience.com</p></div></div><div class="od l"><div class="oj l of og oh od oi ks nu"/></div></div></a></div></div></div>    
</body>
</html>