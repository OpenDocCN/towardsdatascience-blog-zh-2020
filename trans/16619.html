<html>
<head>
<title>FastAPI + AWS = secure API (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">FastAPI + AWS =安全API(第2部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fastapi-aws-secure-api-part-2-1123bff28b55?source=collection_archive---------20-----------------------#2020-11-16">https://towardsdatascience.com/fastapi-aws-secure-api-part-2-1123bff28b55?source=collection_archive---------20-----------------------#2020-11-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a83d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们用FastAPI、AWS Lambda、API Gateway、CloudWatch和AWS X-Ray构建一个安全且可观察的Python REST API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7f0a226ebce8ba9c23aaec071b4f6e64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ghb6VstOk-p8LoqZ6q6jMg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@spencer-selover-142259?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">斯潘塞·塞洛弗</a>从<a class="ae ky" href="https://www.pexels.com/photo/adult-color-palette-colorful-colors-567452/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</p></figure><p id="7252" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文的第1部分中，我们讨论了如何使用API Gateway和Amazon Lambda为AWS构建和部署FastAPI应用程序。在第2部分中，我们将在此基础上确保我们的API是安全的、易于重新部署的，并且我们可以通过分布式日志记录和跟踪来监控它的健康状况。本文基于一种<strong class="lb iu">自上而下的方法</strong>:我们将首先创建所有的资源，然后我们将更深入地了解它们的细节，并讨论所有这些服务如何协同工作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="ee5b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">目录:</h2><ol class=""><li id="c3b2" class="mv mw it lb b lc mx lf my li mz lm na lq nb lu nc nd ne nf bi translated">通过创建API密钥并为其分配使用计划来保护API</li><li id="7571" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">在Postman中测试API键</li><li id="b48f" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">对API进行更改并重新部署</li><li id="2753" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">通过X射线启用CloudWatch日志和分布式跟踪</li><li id="b8bc" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">深入探究这一切是如何协同工作的</li><li id="0ad7" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">结论</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f8a9" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">1.通过创建API密钥并为其分配使用计划来保护API</h1><h2 id="9573" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">需要API密钥</h2><p id="b9f0" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">首先，在API网关中，我们需要为方法和资源代理设置选项“需要API密钥”为<code class="fe nz oa ob oc b">true</code>:</p><div class="kj kk kl km gt ab cb"><figure class="od kn oe of og oh oi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/84f49e7993ba42f544b9f9a871d91c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*9Zt7-OxkTa5hFTtrMLYT0A.png"/></div></figure><figure class="od kn oj of og oh oi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/91873e98b4db2bd5ae3440c5efe0162c.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*r1Q5yuzJ1iE-RShyRhFUEQ.png"/></div></figure><figure class="od kn ok of og oh oi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/45a068775f54c1fa0d63cc0d813fa805.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*jt7vpblbTpZ1J5AOF2S0Yw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk ol di om on translated">作者图片</p></figure></div></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="f8d4" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创建API密钥</h2><p id="d738" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">转到左侧导航面板中的“API密钥”部分:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/957b0647f3cab2c1d851aab66a9d0f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZSDPCLo1vTNu8Fx60t0DlQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以创建一个API键:操作→创建API键→保存:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/525713b08da26fb43db1cabec6341fa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43dzJA14YjODqq62OkeXQg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="1d96" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创建使用计划</h2><p id="4c27" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">然后，让我们创建一个使用计划[1]:转到<strong class="lb iu">使用计划</strong>(API键上方左侧导航栏中的<em class="oq">)→创建:</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/14e5179507473e16f724eef492bdb922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2YXbpPiI5S600OtUwK7rmQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建使用计划—按作者分类的图像</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/403512224da6e486ae70c7c5ffdb4503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-0DTeBN88foekd75H0EW8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我输入的数字是任意的——可以根据您的需要随意调整。作者图片</p></figure><p id="fdfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们有了使用计划，我们可以<strong class="lb iu">将它与部署到<code class="fe nz oa ob oc b">dev</code>阶段的API </strong>关联起来:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/53dffb9e375fd1111d4a4c4a7f76766a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vp6H8rdIHkQbmm2x1tRFaw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a0c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们<strong class="lb iu">将</strong>之前创建的<strong class="lb iu"> API键与这个使用计划</strong>相关联:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/a89cce702e5a77db6c8e069c1deafe4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9MKXLHQ-xl89D_dycFeFrw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/b113eb8fc75c28650bc34ff224c1b578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KyLF2d1U8QGFcZzYu7Nagw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4de9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在最重要的部分是:要激活对API密匙的更改，我们需要<strong class="lb iu">重新部署我们的</strong> <code class="fe nz oa ob oc b"><strong class="lb iu">dev</strong></code> <strong class="lb iu"> API阶段</strong>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/fd45023cd633558d00dc75d28262cc92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCVSsGzqY_MmmQ7PzVnUcg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/0449468eaf9cb207149094d8d4c1363b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tKOe9QIRCKSNkgG_FBk-TA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="239e" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">2.测试API密钥</h1><p id="c1b2" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">在我们的浏览器中，我们现在应该会看到一条消息“禁止”(<em class="oq">可能需要1-2分钟，更改才会生效</em>)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/d2a4b6cd40a5db9722ac0369da5477e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*657pIDybdmJq1koIHU9tLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2197" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过<a class="ae ky" href="https://www.postman.com/downloads/" rel="noopener ugc nofollow" target="_blank"> Postman </a>用我们的API密匙测试使用情况:</p><ul class=""><li id="8782" class="mv mw it lb b lc ld lf lg li oy lm oz lq pa lu pb nd ne nf bi translated">首先，在API键旁边，我们单击“Show ”,然后复制API键并将其粘贴到Postman中的<strong class="lb iu">请求头</strong>字段<code class="fe nz oa ob oc b">Value</code>:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/46e7abf72b535dc4b6b441a041f0fdba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vk3b43BRw-SUWWe1OD4vbg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><ul class=""><li id="b684" class="mv mw it lb b lc ld lf lg li oy lm oz lq pa lu pb nd ne nf bi translated"><code class="fe nz oa ob oc b">Key</code>必须设置为<code class="fe nz oa ob oc b">x-api-key</code>，而<code class="fe nz oa ob oc b">Value</code>是你从管理控制台复制的API Key:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/29cee1a7cd951a15c621c6df67702b1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKbE8F1FtkU8LMJvUouimQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9995" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击“发送”后，您应该会看到正确的API响应。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="420b" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">3.对API进行更改和重新部署</h1><p id="89ed" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">您可以从Github库下载该项目的代码。</p><p id="9b9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们对根路径的返回值做一个小小的改变:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="c6e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了对部署到AWS的API进行这些更改，我们重复打包代码的步骤，如本文第1部分所述:</p><div class="pg ph gp gr pi pj"><a rel="noopener follow" target="_blank" href="/fastapi-aws-robust-api-part-1-f67ae47390f9"><div class="pk ab fo"><div class="pl ab pm cl cj pn"><h2 class="bd iu gy z fp po fr fs pp fu fw is bi translated">FastAPI + AWS =健壮的API(第1部分)</h2><div class="pq l"><h3 class="bd b gy z fp po fr fs pp fu fw dk translated">让我们用FastAPI、Amazon Lambda和API Gateway构建一个可伸缩的基于Python的REST API</h3></div><div class="pr l"><p class="bd b dl z fp po fr fs pp fu fw dk translated">towardsdatascience.com</p></div></div><div class="ps l"><div class="pt l pu pv pw ps px ks pj"/></div></div></a></div><p id="fed2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">我们需要:</strong></p><ul class=""><li id="7bed" class="mv mw it lb b lc ld lf lg li oy lm oz lq pa lu pb nd ne nf bi translated">压缩代码及其所有依赖项</li><li id="257b" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu pb nd ne nf bi translated">上传这个压缩文件到S3</li><li id="03e8" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu pb nd ne nf bi translated">更新Lambda函数。</li></ul><p id="722d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一切都可以通过以下几行实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="1ad2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在执行命令:<code class="fe nz oa ob oc b">bash package_and_update_lambda_code.bash</code>之后，我们应该能够看到API中反映的更改(<em class="oq">不需要重新部署API stage，因为我们只对底层Lambda函数进行了更改，而没有对API网关资源进行更改</em>):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi py"><img src="../Images/736d3cb417568e0430bc6977892e1102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SnJoGKnP_hRRBGJBEZAAxA.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3134" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">4.通过X射线启用CloudWatch日志和分布式跟踪</h1><p id="955b" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">为了利用集中式日志记录，我们需要做的就是选中CloudWatch Logs旁边的复选框。就是这样！我们可以选择所需的日志级别以及是否<strong class="lb iu">记录完整的请求/响应数据</strong>。</p><p id="325a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最重要的是，我们可以启用<strong class="lb iu">访问日志</strong>，这有助于了解哪些用户或代理使用了特定的端点。这样的话，如果出了问题，我们就可以追踪访问记录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pz"><img src="../Images/2d386eb5080a3a6775f759adc1675a1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P2QoX91KVrtcJj3pnCtCXw.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="b244" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">x射线:服务地图</h2><p id="68a3" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">在启用X射线跟踪并发出一些API请求后，我们应该能够看到收集到的跟踪和指标:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qa"><img src="../Images/7b0eda9bf4d10967799636acef537db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qqv4Ryt9GeDIyjA2pQS3ug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务地图中可视化的x射线追踪-由作者提供的图像</p></figure><p id="24b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上图中标记为黄色的错误是我试图在没有使用API密钥进行身份验证的情况下从浏览器访问API的结果。</p><h2 id="72e9" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated"><strong class="ak">跟踪CloudWatch中的API日志</strong></h2><p id="4233" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">为了为您的API找到正确的日志组，请查找以API ID开头的日志组。然后，您可以找到所有API请求和响应的日志:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qb"><img src="../Images/d131b16101d7b0aea22a23f5fe4f95d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u8bD-D9MY6AzKKc_Ma8u0A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云观察日志-按作者分类的图片</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cabb" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">5.深入探究这一切是如何协同工作的</h1><p id="c353" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">让我们更深入地了解这些服务是如何工作的，以及如何有效地使用它们。</p><p id="f686" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 1。什么是使用计划？</strong></p><p id="551e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API Gateway允许我们构建可以作为产品<a class="ae ky" href="https://rapidapi.com/marketplace" rel="noopener ugc nofollow" target="_blank">货币化</a>的API。使用计划以及相关的API密钥让我们能够以特定的请求率和速度向授权客户提供我们的API:</p><blockquote class="qc qd qe"><p id="b168" class="kz la oq lb b lc ld ju le lf lg jx lh qf lj lk ll qg ln lo lp qh lr ls lt lu im bi translated"><em class="it">“使用计划指定了</em> <strong class="lb iu"> <em class="it">谁</em> </strong> <em class="it">可以访问一个或多个已部署的API阶段和方法，以及</em><strong class="lb iu"><em class="it"/></strong><em class="it">和</em> <strong class="lb iu"> <em class="it">他们可以多快</em> </strong> <em class="it">访问它们。”[4] </em></p></blockquote><p id="2410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着通过在特定的API阶段将API键分配给特定的使用计划。dev或prod ，我们可以对不同的API阶段实现不同级别的权限和不同的节流限制。我们可以为每个使用计划分配许多API键，这允许细粒度的访问控制。</p><p id="7c95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2。我们如何使用API键？</strong></p><p id="328e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API密钥是简单的字符串(<em class="oq"> 30-128个字符长</em>)，可以分配给使用计划或Lambda授权者。它们允许我们在API阶段和请求类型级别分配权限。</p><p id="b06f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们可能希望在<code class="fe nz oa ob oc b">dev</code>阶段有更多的开放访问，而在<code class="fe nz oa ob oc b">prod</code>阶段有更多的限制访问。这意味着一个特权用户可以访问两个阶段<code class="fe nz oa ob oc b">dev</code>和<code class="fe nz oa ob oc b">prod</code>，而其他一些用户可以获得一个API密钥，该密钥只分配给与<code class="fe nz oa ob oc b">dev</code> API阶段相对应的使用计划。</p><p id="21f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 3。我们如何区分Lambda执行和API网关请求的CloudWatch日志？</strong></p><p id="ff36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CloudWatch将日志存储在与每个服务相对应的独立日志组中(例如API网关)和服务内资源(您的特定API)。您可以通过查找API ID来识别与API网关日志相对应的日志组。您可以在URL端点或管理控制台中找到它:</p><pre class="kj kk kl km gt qi oc qj qk aw ql bi"><span id="ace0" class="mc md it oc b gy qm qn l qo qp">https://&lt;API-ID&gt;.execute-api.&lt;REGION&gt;.amazonaws.com/&lt;API_STAGE&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qq"><img src="../Images/39f11e1da741a0a934e6283a5e401290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*urkB31BZxSa7_6adRWpkJQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如何找到你的API ID——图片作者</p></figure><p id="bcff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API Gateway中对应于您的API的<strong class="lb iu">日志组</strong>将类似于:</p><pre class="kj kk kl km gt qi oc qj qk aw ql bi"><span id="f3e9" class="mc md it oc b gy qm qn l qo qp">API-Gateway-Execution-Logs_&lt;YOUR_API_ID&gt;/&lt;YOUR_API_STAGE&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qr"><img src="../Images/70a0f1c63c1341d453f7dcf38641f99b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lp3dRt1IhlH5WrJPwS0Wyg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">API网关日志—按作者分类的图片</p></figure><p id="1007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> Amazon Lambda </strong>日志可以通过函数名来识别:</p><pre class="kj kk kl km gt qi oc qj qk aw ql bi"><span id="b5de" class="mc md it oc b gy qm qn l qo qp">/aws/lambda/&lt;YOUR_FUNCTION_NAME&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qs"><img src="../Images/a4de51a76754975280675206dc86d009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sCoQg4BRUO8i5h2759Qtjw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda日志—作者图片</p></figure><p id="4ac7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 4。X射线是如何工作的？</strong></p><p id="93c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">x射线是一种分布式跟踪服务。它跟踪诸如对我们的API的请求的延迟和成功率以及我们的服务中的不同组件如何相互依赖等指标。X-Ray的主要好处是它生成了一个<strong class="lb iu">服务图</strong>，这让我们可以分析哪些请求被其他下游请求跟随，以及我们的API中有哪些潜在的瓶颈。</p><p id="2f3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在内部，X-Ray通过使用<strong class="lb iu">段</strong>生成跟踪，即执行API请求的计算资源，如API Gateway和Amazon Lambda。这些片段可以被分解成<strong class="lb iu">子片段</strong>以进行更细粒度的跟踪——例如，我们可以在FastAPI代码中使用X-Ray的<a class="ae ky" href="https://github.com/aws/aws-xray-sdk-python" rel="noopener ugc nofollow" target="_blank"> Python SDK </a>来添加新的子片段，进行注释，并整体上使我们的跟踪更细粒度。</p><p id="23e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单个<strong class="lb iu">跟踪</strong>收集由特定请求生成的所有段和子段。</p><p id="0709" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 5。X射线会自动跟踪并记录每个请求吗？</strong></p><p id="dccb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之:不。测量每一个请求将是昂贵的，并且很可能是不必要的(<em class="oq">如果前50个相同类型的请求每个花费200毫秒，那么接下来的500万个后续请求很可能也是如此</em>)。x射线使用<strong class="lb iu">代表样本</strong>:默认情况下，它跟踪每秒的第一个请求，外加所有附加请求的5%。这个采样规则可以根据您的特定请求的属性进行配置[2]。</p><p id="5693" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有两种不同类型的跟踪:<strong class="lb iu">主动</strong>和<strong class="lb iu">被动</strong>。两者具有相同的效果，因为它们导致X射线对请求进行采样并收集跟踪。</p><p id="e2fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们在调用我们的Lambda函数的API网关中启用X射线时，这意味着在这个Lambda函数上启用了<strong class="lb iu">被动跟踪</strong>，因为上游服务(<em class="oq">即API网关</em>)负责添加跟踪头，告诉Lambda是否发送跟踪。相反，如果我们直接从Lambda配置而不是从API Gateway启用跟踪，这将是<strong class="lb iu">主动跟踪</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qt"><img src="../Images/ff414c9597696e9875a3c543b0604fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4sp-ETz4Pf1YfkBw-8klOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在Lambda配置中启用活动跟踪—按作者分类的图像</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qu"><img src="../Images/5650a8830235c60824e4726d3daf3616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Ph7zSUh1MTwNndNGA84Ng.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在API网关阶段配置中为Lambda启用被动跟踪—图片由作者提供</p></figure><p id="be3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 5。X射线与CloudWatch和CloudTrail有什么不同？</strong></p><p id="21d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> X射线</strong>让我们收集关于特定API或微服务的指标。<strong class="lb iu"> CloudTrail </strong>拥有更广泛的“受众”——因为AWS中的一切都是API调用，所以我们的AWS帐户中的每个操作都可以用CloudTrail跟踪。有可能<strong class="lb iu">将X射线与CloudTrail </strong>集成起来，以跟踪用户、IAM角色或任何AWS服务所做的额外操作，并在X射线跟踪中分析它们[3]。</p><p id="22dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相比之下，<strong class="lb iu"> CloudWatch </strong>允许我们跟踪执行日志、访问日志，甚至完整的请求和响应数据，并直接在CloudWatch控制台中或在Kibana或Grafana等工具中分析它们。</p><blockquote class="qv"><p id="b241" class="qw qx it bd qy qz ra rb rc rd re lu dk translated">虽然<strong class="ak"> CloudWatch </strong>为我们提供了<strong class="ak">详细的日志</strong>，但X-Ray只为我们提供了关于延迟和采样请求状态的指标。</p></blockquote><p id="a8aa" class="pw-post-body-paragraph kz la it lb b lc rf ju le lf rg jx lh li rh lk ll lm ri lo lp lq rj ls lt lu im bi translated"><strong class="lb iu"> 6。这些服务的费用是多少？</strong></p><p id="e645" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">价格根据您的AWS地区、API类型(<em class="oq"> REST、HTTP </em>)和您的请求数量(<em class="oq">批量折扣</em>)而有所不同。在撰写本报告时:</p><ul class=""><li id="2142" class="mv mw it lb b lc ld lf lg li oy lm oz lq pa lu pb nd ne nf bi translated"><a class="ae ky" href="https://aws.amazon.com/api-gateway/pricing/" rel="noopener ugc nofollow" target="_blank"> API网关</a>每100万次请求的成本在1-4.25美元之间。</li><li id="3f8b" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu pb nd ne nf bi translated">AWS X射线的价格大约是每一百万道1美元。</li><li id="2d40" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu pb nd ne nf bi translated">AWS Lambda 根据调用次数和代码运行时间收费，以毫秒为单位。</li><li id="7ad2" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu pb nd ne nf bi translated">最后，<a class="ae ky" href="https://aws.amazon.com/cloudwatch/pricing/" rel="noopener ugc nofollow" target="_blank"> CloudWatch </a>日志的价格在每月收集的每GB日志0.50-0.90美元之间(<em class="oq">同样，价格因地区而异</em>)。</li></ul><p id="b204" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<a class="ae ky" href="https://calculator.aws/#/" rel="noopener ugc nofollow" target="_blank"> AWS定价计算器</a>来获得与您的用例相对应的更现实的估计。另外，请注意，使用免费层，您可以(<em class="oq">有限的</em>)免费访问API Gateway、Amazon Lambda和CloudWatch日志。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="43de" class="nl md it bd me nm nn no mh np nq nr mk jz ns ka mn kc nt kd mq kf nu kg mt nv bi translated">6.结论</h1><p id="a0c1" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">在本文中，我们研究了如何使我们的API安全且易于维护。我们讨论了如何分配使用计划和API键，以及如何通过启用分布式日志记录和跟踪来监控API的健康状况。最后，我们深入研究了这些服务是如何工作的，以及如何有效地使用它们。</p><p id="a335" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">如果这篇文章有帮助，</strong> <a class="ae ky" href="https://medium.com/@anna.anisienia" rel="noopener"> <strong class="lb iu">关注我</strong> </a> <strong class="lb iu">看我下一篇文章。</strong></p><p id="ecde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">参考文献:</strong></p><p id="8dc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[1] <a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html" rel="noopener ugc nofollow" target="_blank">关于使用计划的API网关文档</a></p><p id="47c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[2] <a class="ae ky" href="https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html" rel="noopener ugc nofollow" target="_blank"> AWS X射线文件</a>关于取样请求和追踪</p><p id="a152" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[3] AWS Edx课程<a class="ae ky" href="https://courses.edx.org/courses/course-v1:AWS+OTP-AWSD12+3T2020/course/" rel="noopener ugc nofollow" target="_blank">在AWS上构建现代Python应用</a></p></div></div>    
</body>
</html>