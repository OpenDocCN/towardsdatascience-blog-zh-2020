<html>
<head>
<title>Connect to PostgreSQL Database Server Using Python Module of psycopg2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用psycopg2的Python模块连接到PostgreSQL数据库服务器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/connect-to-postgresql-database-server-using-psycopg2-with-an-elegant-configuration-file-dba6fc885989?source=collection_archive---------6-----------------------#2020-10-30">https://towardsdatascience.com/connect-to-postgresql-database-server-using-psycopg2-with-an-elegant-configuration-file-dba6fc885989?source=collection_archive---------6-----------------------#2020-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/5859e0304ae6c588768fcc3c40834f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y6OENSQkC2DIEqCx"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">Jan Antonin Kolar 在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h2 id="14da" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">动手教程</a></h2><div class=""/><div class=""><h2 id="ebb0" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">开发一个整洁的脚本和目录来本地或远程连接到PostgreSQL</h2></div><h2 id="5de0" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">目录(仅适用于web)</h2><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="d8df" class="lh li jj mh b gy ml mm l mn mo">1 <a class="ae jg" href="#6107" rel="noopener ugc nofollow">What’s it all about?</a><br/>2 <a class="ae jg" href="#64a2" rel="noopener ugc nofollow">The psycopg module to connect a PostgreSQL</a><br/>3 <a class="ae jg" href="#2ac2" rel="noopener ugc nofollow">How to connect with PostgreSQL</a><br/>4 <a class="ae jg" href="#23f6" rel="noopener ugc nofollow">Create, Read, Update, and Delete (CRUD) using psycopg2</a><br/>  • <a class="ae jg" href="#e1a3" rel="noopener ugc nofollow">Create a table</a><br/>  • <a class="ae jg" href="#be50" rel="noopener ugc nofollow">Insert data to a table</a><br/>  • <a class="ae jg" href="#b149" rel="noopener ugc nofollow">Retrieve a table</a><br/>  • <a class="ae jg" href="#5d20" rel="noopener ugc nofollow">Update a table</a><br/>  • <a class="ae jg" href="#fd24" rel="noopener ugc nofollow">Delete rows or a table</a><br/>5 <a class="ae jg" href="#194d" rel="noopener ugc nofollow">Conclusion</a><br/>6 <a class="ae jg" href="#0c68" rel="noopener ugc nofollow">References</a></span></pre></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><h2 id="6107" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">这是怎么回事？</h2><p id="60c0" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi np translated">ostgreSQL是一个关系数据库管理系统，它是开源的，也有很多功能。在Python中，我们有几个模块可以连接到PostgreSQL，比如<code class="fe ny nz oa mh b"><strong class="my jt">SQLAlchemy</strong></code>、<code class="fe ny nz oa mh b"><strong class="my jt">pg8000</strong></code>、<code class="fe ny nz oa mh b"><strong class="my jt">py-postgresql</strong></code>等。然而，<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>成为最受欢迎的一个。所以在本教程中，我们将讨论如何使用<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code> <strong class="my jt"> </strong>连接到PostgreSQL。</p><h2 id="64a2" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">连接PostgreSQL的psycopg模块</h2><p id="9250" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>是Python开发人员通常用来连接Python的PostgreSQL连接器。它是本教程的核心模块，所以请确保我们已经在机器上安装了它。在终端上使用以下命令安装<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>模块。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="1c88" class="lh li jj mh b gy ml mm l mn mo"><strong class="mh jt">$</strong>pip3 install psycopg2</span></pre><h2 id="2ac2" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">如何连接PostgreSQL</h2><p id="1c57" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">要连接到PostgreSQL，我们必须在PostgreSQL上创建一个代表我们的数据库的文件。我们将把数据库配置文件保存到<code class="fe ny nz oa mh b"><strong class="my jt">&lt;filename&gt;.ini</strong></code>。<strong class="my jt"> <em class="ob">如果我们与公众分享我们的主要Python脚本</em> </strong>，它会保证我们数据库配置的安全。在这种情况下，我们将它命名为<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code> <strong class="my jt"> </strong>。请输入您的数据库配置，如<em class="ob">主机名</em>，<em class="ob">数据库名</em>，<em class="ob">用户名</em>，<em class="ob">密码</em>，<em class="ob">端口号</em>等至<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code> <strong class="my jt"> </strong>如下。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="66a2" class="lh li jj mh b gy ml mm l mn mo">[postgresql]<br/>host = localhost<br/>database = customer<br/>user = postgres<br/>password = admindb<br/>port = 5432</span></pre><p id="db97" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">关于数据库配置的信息。</p><ul class=""><li id="fa11" class="oh oi jj my b mz oc nc od lq oj lu ok ly ol no om on oo op bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">host</strong></code> —是运行PostgreSQL的服务器名称或IP地址</li><li id="b083" class="oh oi jj my b mz oq nc or lq os lu ot ly ou no om on oo op bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">database</strong></code> —是我们要连接的数据库名称</li><li id="34d6" class="oh oi jj my b mz oq nc or lq os lu ot ly ou no om on oo op bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">user </strong></code> —是PostgreSQL的用户名称</li><li id="326e" class="oh oi jj my b mz oq nc or lq os lu ot ly ou no om on oo op bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">password</strong></code> —是连接PostgreSQL所需的密钥</li><li id="ff74" class="oh oi jj my b mz oq nc or lq os lu ot ly ou no om on oo op bi translated"><code class="fe ny nz oa mh b"><strong class="my jt">port</strong></code> —监听TCP/IP连接时将使用的端口号。默认端口号是5432</li></ul><p id="4221" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">为了解析来自<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code>文件的信息，我们用如下脚本创建了<code class="fe ny nz oa mh b"><strong class="my jt">config.py</strong></code>文件。它还创建了一个返回项目根文件夹的函数。</p><blockquote class="ov ow ox"><p id="4030" class="mw mx ob my b mz oc kt nb nc od kw ne oy oe ng nh oz of nj nk pa og nm nn no im bi translated">注意:<code class="fe ny nz oa mh b"><strong class="my jt">section = ‘postgresql’</strong></code>的设置取决于<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code>文件的文件头。我们以后可以修改它。</p></blockquote><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="b59f" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>from configparser import ConfigParser<br/>from pathlib import Path<br/>def get_project_root() -&gt; Path:<br/>  """Returns project root folder."""<br/>  return Path(__file__).parents[1]<br/>def config(config_db):<br/>  section = 'postgresql'<br/>  config_file_path = 'config/' + config_db<br/>  if(len(config_file_path) &gt; 0 and len(section) &gt; 0):<br/>    # Create an instance of ConfigParser class<br/>    config_parser = ConfigParser()<br/>    # Read the configuration file<br/>    config_parser.read(config_file_path)<br/>    # If the configuration file contains the provided section name<br/>    if(config_parser.has_section(section)):<br/>      # Read the options of the section<br/>      config_params = config_parser.items(section)<br/>      # Convert the list object to a python dictionary object<br/>      # Define an empty dictionary<br/>      db_conn_dict = {}<br/>      # Loop in the list<br/>      for config_param in config_params:<br/>        # Get options key and value<br/>        key = config_param[0]<br/>        value = config_param[1]<br/>        # Add the key value pair in the dictionary object<br/>        db_conn_dict[key] = value<br/>      # Get connection object use above dictionary object<br/>      return db_conn_dict</span></pre><p id="08ea" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">当我们的作品需要定期读取数据库上的表格时，我们可以创建一个文件名为<code class="fe ny nz oa mh b"><strong class="my jt">db_conn.py</strong></code>的函数，如下。它将加载符合我们输入的表(<code class="fe ny nz oa mh b"><strong class="my jt">config_db</strong></code>和<code class="fe ny nz oa mh b"><strong class="my jt">query</strong></code>)。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="968d" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Take in a PostgreSQL table and outputs a pandas dataframe<br/>def load_db_table(config_db, query):<br/>    params = config(config_db)<br/>    engine = psycopg2.connect(**params)<br/>    data = pd.read_sql(query, con = engine)<br/>    return data</span></pre><p id="58fc" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">为了编译我们的脚本，我们设置我们的目录来定位<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code>、<code class="fe ny nz oa mh b"><strong class="my jt">config.py</strong></code>和<code class="fe ny nz oa mh b"><strong class="my jt">db_conn.py</strong></code>。使用以下设置。</p><figure class="mc md me mf gt iv gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/45496af4b822f53d5fd7157c1c0a03ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*FAiEyQ-DhsZVZvZJMS2NBA.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">运行脚本的推荐目录(图片由作者提供)</p></figure><p id="76ca" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">等等！有<code class="fe ny nz oa mh b"><strong class="my jt">main.py</strong></code>文件，是什么？好吧，那么，它必须是一个Python脚本来测试我们通过Python的PostgreSQL连接。所以，这里是<code class="fe ny nz oa mh b"><strong class="my jt">main.py</strong></code>。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="7a57" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>from src.data.db_conn import load_db_table<br/>from config.config import get_project_root<br/># Project root<br/>PROJECT_ROOT = get_project_root()<br/># Read database - PostgreSQL<br/>df = load_db_table(config_db = 'database.ini', query = 'SELECT * FROM tablename LIMIT 5')<br/>print(df)</span></pre><p id="3ebc" class="pw-post-body-paragraph mw mx jj my b mz oc kt nb nc od kw ne lq oe ng nh lu of nj nk ly og nm nn no im bi translated">有用！现在，我们将自定义并创建其他PostgreSQL命令，以便通过Python创建、读取、更新或删除。</p><h2 id="23f6" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">使用psycopg2创建、读取、更新和删除(CRUD)</h2><h2 id="e1a3" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">创建表格</h2><p id="e97b" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">通过<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>创建一个表使用了<code class="fe ny nz oa mh b"><strong class="my jt">CREATE TABLE</strong></code>语句，但是是在Python脚本中。之前，我们保存了数据库配置文件。当我们想连接PostgreSQL时，只需导入<code class="fe ny nz oa mh b"><strong class="my jt">config</strong></code>函数。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="b084" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Connect to PostgreSQL<br/>params = config(config_db = 'database.ini')<br/>engine = psycopg2.connect(**params)<br/>print('Python connected to PostgreSQL!')<br/># Create table<br/>cur = con.cursor()<br/>cur.execute("""<br/>CREATE TABLE customer(<br/>customer_id INT PRIMARY KEY NOT NULL,<br/>name CHAR(50) NOT NULL,<br/>address CHAR(100),<br/>email CHAR(50),<br/>phone_number CHAR(20));<br/>""")<br/>print('Table created in PostgreSQL')<br/># Close the connection<br/>con.commit()<br/>con.close()</span></pre><h2 id="be50" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">将数据插入表格</h2><p id="6291" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">创建一个新表<code class="fe ny nz oa mh b"><strong class="my jt">customer</strong></code>后，我们将通过SQL语句<code class="fe ny nz oa mh b"><strong class="my jt">INSERT INTO</strong></code>向表中插入一些值。这里有一个例子。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="ae8e" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Connect to PostgreSQL<br/>params = config(config_db = 'database.ini')<br/>engine = psycopg2.connect(**params)<br/>print('Python connected to PostgreSQL!')<br/># Insert values to the table<br/>cur = con.cursor()<br/>cur.execute("""<br/>INSERT INTO customer (customer_id,name,address,email,phone_number)<br/>VALUES (12345,'Audhi','Indonesia','myemail@gmail.com','+621234567');<br/>""")<br/>cur.execute("""<br/>INSERT INTO customer (customer_id,name,address,email,phone_number)<br/>VALUES (56789,'Aprilliant','Japan','email@gmail.com','+6213579246');<br/>""")<br/>print('Values inserted to PostgreSQL')<br/># Close the connection<br/>con.commit()<br/>con.close()</span></pre><h2 id="b149" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">取回桌子</h2><p id="e6f8" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">我们通过<code class="fe ny nz oa mh b"><strong class="my jt">SELECT</strong></code> SQL语句检索我们的<code class="fe ny nz oa mh b"><strong class="my jt">customer</strong></code>表。在这种情况下，我们将检索<code class="fe ny nz oa mh b"><strong class="my jt">customer</strong></code>表的前五行。</p><blockquote class="ov ow ox"><p id="a863" class="mw mx ob my b mz oc kt nb nc od kw ne oy oe ng nh oz of nj nk pa og nm nn no im bi translated"><strong class="my jt">注意:</strong>要从PostgreSQL中检索数据，请确保我们选择了正确的表名和列。不要使用<code class="fe ny nz oa mh b"><strong class="my jt">*</strong></code>语句，因为它会减慢我们的进度</p></blockquote><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="81a4" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Connect to PostgreSQL<br/>params = config(config_db = 'database.ini')<br/>engine = psycopg2.connect(**params)<br/>print('Python connected to PostgreSQL!')<br/># Read the table<br/>cur = con.cursor()<br/>cur.execute("""<br/>SELECT customer_id,name,email FROM customer LIMIT 5;<br/>""")<br/>print('Read table in PostgreSQL')<br/># Close the connection<br/>con.commit()<br/>con.close()</span></pre><h2 id="5d20" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">更新表格</h2><p id="e013" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">当在数据库上工作时，定期更新我们的数据库是正常的，使用<code class="fe ny nz oa mh b"><strong class="my jt">UPDATE</strong></code>语句很容易执行。假设我们将更新拥有<code class="fe ny nz oa mh b"><strong class="my jt">customer_id = 12345</strong></code>的客户的地址。查看我们的表格，它将通过<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>自动更新。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="04ea" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Connect to PostgreSQL<br/>params = config(config_db = 'database.ini')<br/>engine = psycopg2.connect(**params)<br/>print('Python connected to PostgreSQL!')<br/># Insert values to the table<br/>cur = con.cursor()<br/>cur.execute("""<br/>UPDATE customer SET address = 'Japan' WHERE customer_id = 12345;<br/>""")<br/>print('Values updated in PostgreSQL')<br/># Close the connection<br/>con.commit()<br/>con.close()</span></pre><h2 id="fd24" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">删除行或表格</h2><p id="06ce" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">最后，<strong class="my jt"> D </strong>用于使用<code class="fe ny nz oa mh b"><strong class="my jt">DELETE</strong></code>语句删除(行或表)。在这种情况下，我们希望从一个<code class="fe ny nz oa mh b"><strong class="my jt">customer</strong></code>表中删除拥有<code class="fe ny nz oa mh b"><strong class="my jt">customer_id = 12345</strong></code>的客户信息。</p><pre class="mc md me mf gt mg mh pb bn pc pd bi"><span id="0ad4" class="pe li jj mh b be pf pg l ph mo"># Import libraries<br/>import pandas as pd<br/>import psycopg2<br/>from config.config import config<br/># Connect to PostgreSQL<br/>params = config(config_db = 'database.ini')<br/>engine = psycopg2.connect(**params)<br/>print('Python connected to PostgreSQL!')<br/># Delete rows from the table<br/>cur = con.cursor()<br/>cur.execute("""<br/>DELETE FROM customer WHERE customer_id = 12345;<br/>""")<br/>print('Values deleted from PostgreSQL')<br/># Close the connection<br/>con.commit()<br/>con.close()</span></pre><h2 id="194d" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">结论</h2><p id="c9ba" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">当处理大量代码时，我们不仅需要创建一个特定的脚本，还需要创建一个整洁干净的目录。有时，我们的脚本包含秘密信息，如数据库配置等。所以，我们在主脚本之外创建了<code class="fe ny nz oa mh b"><strong class="my jt">database.ini</strong></code>。对于<code class="fe ny nz oa mh b"><strong class="my jt">psycopg2</strong></code>模块，它有许多函数可以与PostgreSQL本地或远程交互，这使得我们可以更容易地开发自动化，而不是通过PgAdmin手动进行CRUD操作。</p><h2 id="0c68" class="lh li jj bd lj lk ll dn lm ln lo dp lp lq lr ls lt lu lv lw lx ly lz ma mb jp bi translated">参考</h2><p id="fa46" class="pw-post-body-paragraph mw mx jj my b mz na kt nb nc nd kw ne lq nf ng nh lu ni nj nk ly nl nm nn no im bi translated">[1] Python-Dev。<a class="ae jg" href="https://pypi.org/project/psycopg2/" rel="noopener ugc nofollow" target="_blank"><em class="ob">psycopg 2 2 . 8 . 6</em>【https://pypi.org/project/psycopg2/】【2020】</a><a class="ae jg" href="https://pypi.org/project/psycopg2/" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>