<html>
<head>
<title>CausalImpact and R: Analysing Time Series Interventions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">因果影响和R:分析时间序列干预</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/causalimpact-and-r-analysing-time-series-interventions-27a5dfaec999?source=collection_archive---------25-----------------------#2020-10-04">https://towardsdatascience.com/causalimpact-and-r-analysing-time-series-interventions-27a5dfaec999?source=collection_archive---------25-----------------------#2020-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="30bb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">分析R中的时间序列干预</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b807a240b70f535a7363db3e992e1ef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Ji_bz2-eFljLbf6aOt9bQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:图片来自<a class="ae ky" href="https://pixabay.com/photos/clock-alarm-clock-watch-time-old-1274699/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="876e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">免责声明:本文是在“原样”的基础上编写的，没有担保。它旨在提供数据科学概念的概述，不应被解释为投资建议或任何其他类型的专业建议。</em></p><p id="5882" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">干预(或独立于时间序列的外部因素)通常会影响所述序列。</p><p id="4c8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，营销活动可以影响公司未来的销售额。政府政策的改变会对经济活动产生重大影响。</p><p id="751c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">分析干预的主要问题是，不可能分析如果干预没有发生会发生什么——至少不可能直接分析。</p><p id="b029" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">R中的<strong class="lb iu">因果影响</strong>库允许通过使用单独的系列(不受干预影响的系列)作为协变量来分析干预效应。</p><h1 id="f12d" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">我们的例子</h1><p id="8e2b" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">2017年11月，英国央行决定加息。当一个国家的中央银行决定以这种方式操纵利率时——货币的价值可能会受到影响——因为这种决定会影响投资者通过持有特定货币可以获得的收益率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/6b8e18c9b12a01ba977bc72acea07687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Oxq4tVXbIZ9TKYwRQkxBQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:tradingeconomics.com</p></figure><p id="4452" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这方面，我们想研究一下利率上升是否会影响英镑/美元的价值。</p><p id="5185" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，选择欧元/美元货币作为协变量——假设该货币不受干预的影响——因为欧洲央行在此期间没有加息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/88f1d40fe99d5af5707706be32583d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QritgRCoVp4U7EUZqyOcNQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:tradingeconomics.com</p></figure><p id="aa89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相关数据来自使用Quandl的FRED数据库。</p><p id="2970" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是两种货币的曲线图:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="a671" class="na lx it mw b gy nb nc l nd ne">set.seed(1)<br/>x1 &lt;- eurusd$Value<br/>y &lt;- gbpusd$Value<br/>data &lt;- cbind(y, x1)</span><span id="5a0c" class="na lx it mw b gy nf nc l nd ne">dim(data)<br/>head(data)<br/>matplot(data, type = "l")</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/30cd60cd9e1197d86015ff9397b342d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*uyrCSRKwYrKDM5sD5VY7nQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:RStudio</p></figure><p id="dc35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理金融时间序列时，通常会将数据转换为对数格式。虽然这在分析具有显著不同价格范围的股票价格时是有意义的，但是在这个例子中数据是“按原样”分析的。</p><p id="f058" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">原因是货币数据的规模比大多数其他资产价格小得多，使用对数规模会使这些值非常接近，以至于在使用对数规模时，可以在原始系列中检测到的任何干预都可能无法检测到。</p><p id="7cbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用该数据，定义了<strong class="lb iu">前期</strong>和<strong class="lb iu">后期</strong>，然后绘制数据。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="c059" class="na lx it mw b gy nb nc l nd ne">pre.period &lt;- c(1, 230)<br/>post.period &lt;- c(231, 249)</span><span id="9a2f" class="na lx it mw b gy nf nc l nd ne">impact &lt;- CausalImpact(data, pre.period, post.period)<br/>plot(impact)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/5befe87f3ab8b899c38872d7de992a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*z7JoZjM-yRK89JjbsbRQGw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:RStudio</p></figure><p id="ff62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将生成影响摘要:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="dde1" class="na lx it mw b gy nb nc l nd ne">&gt; summary(impact)<br/>Posterior inference {CausalImpact}</span><span id="89ec" class="na lx it mw b gy nf nc l nd ne">Average           Cumulative     <br/>Actual                   1.3               25.5           <br/>Prediction (s.d.)        1.3 (0.0099)      25.4 (0.1878)  <br/>95% CI                   [1.3, 1.4]        [25.1, 25.8]   <br/>                                                          <br/>Absolute effect (s.d.)   0.0014 (0.0099)   0.0275 (0.1878)<br/>95% CI                   [-0.018, 0.02]    [-0.349, 0.38] <br/>                                                          <br/>Relative effect (s.d.)   0.11% (0.74%)     0.11% (0.74%)  <br/>95% CI                   [-1.4%, 1.5%]     [-1.4%, 1.5%]</span><span id="a587" class="na lx it mw b gy nf nc l nd ne">Posterior tail-area probability p:   0.44186<br/>Posterior prob. of a causal effect:  56%</span><span id="e409" class="na lx it mw b gy nf nc l nd ne">For more details, type: summary(impact, "report")</span></pre><p id="24c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们看到，预测值与实际值(平均值)在<strong class="lb iu"> 1.3 </strong>处是相同的，累积值之间只有微小的差异(25.5比25.4)。</p><p id="be2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因果效应的后验概率为56%。</p><p id="8fd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们仔细看看生成的摘要报告。其中一部分指出:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="2bb8" class="na lx it mw b gy nb nc l nd ne">Although the intervention appears to have caused a positive effect, this effect is not statistically significant when considering the entire post-intervention period as a whole. Individual days or shorter stretches within the intervention period may of course still have had a significant effect, as indicated whenever the lower limit of the impact time series (lower plot) was above zero. The apparent effect could be the result of random fluctuations that are unrelated to the intervention. This is often the case when the intervention period is very long and includes much of the time when the effect has already worn off. It can also be the case when the intervention period is too short to distinguish the signal from the noise. Finally, failing to find a significant effect can happen when there are not enough control variables or when these variables do not correlate well with the response variable during the learning period.</span><span id="eb04" class="na lx it mw b gy nf nc l nd ne">The probability of obtaining this effect by chance is p = 0.442. This means the effect may be spurious and would generally not be considered statistically significant.</span></pre><h1 id="705e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">与pycausalimpact的比较Python版本</h1><p id="d94f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当用pycausalimpact分析同一个例子时，结果略有不同。</p><p id="9c88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型定义如下:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="7ec1" class="na lx it mw b gy nb nc l nd ne">&gt;&gt;&gt; ci = CausalImpact(data, pre_period, post_period)<br/>&gt;&gt;&gt; print(ci.summary())<br/>&gt;&gt;&gt; print(ci.summary(output='report'))<br/>&gt;&gt;&gt; ci.plot()</span></pre><p id="05c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是生成的输出:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="16e0" class="na lx it mw b gy nb nc l nd ne">Posterior Inference {Causal Impact}<br/>                          Average            Cumulative<br/>Actual                    1.34               25.46<br/>Prediction (s.d.)         1.32 (0.0)         25.17 (0.08)<br/>95% CI                    [1.32, 1.33]       [25.01, 25.33]</span><span id="d69c" class="na lx it mw b gy nf nc l nd ne">Absolute effect (s.d.)    0.02 (0.0)         0.29 (0.08)<br/>95% CI                    [0.01, 0.02]       [0.13, 0.45]</span><span id="965c" class="na lx it mw b gy nf nc l nd ne">Relative effect (s.d.)    1.15% (0.32%)      1.15% (0.32%)<br/>95% CI                    [0.52%, 1.77%]     [0.52%, 1.77%]</span><span id="4c4a" class="na lx it mw b gy nf nc l nd ne">Posterior tail-area probability p: 0.0<br/>Posterior prob. of a causal effect: 100.0%</span></pre><p id="7dda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与R中的模型不同，该模型预测了因果效应的100%后验概率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/40b25abbfd8ab4841d5acadb40a6e41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YyKLymp2VYvRCVOj-S7sRw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><p id="0eaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个库的R和Python版本在分析干预的方式上有所不同。具体来说，R更多地依赖于先验概率，从而将先前的知识纳入模型假设中，而Python更多地依赖于结构性时间序列组件的分析，以便最大化似然函数。</p><p id="c7e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，假设先验现在设置为<strong class="lb iu">无</strong>，即<em class="lv">先验_级别_ sd =无</em>。</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="2895" class="na lx it mw b gy nb nc l nd ne">ci = CausalImpact(data, pre_period, post_period, prior_level_sd=None)<br/>print(ci.summary())<br/>print(ci.summary(output='report'))<br/>ci.plot()</span></pre><p id="754e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果如下:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="fdde" class="na lx it mw b gy nb nc l nd ne">Posterior Inference {Causal Impact}<br/>                          Average            Cumulative<br/>Actual                    1.34               25.46<br/>Prediction (s.d.)         1.35 (0.02)        25.57 (0.3)<br/>95% CI                    [1.31, 1.38]       [24.98, 26.15]<br/><br/>Absolute effect (s.d.)    -0.01 (0.02)       -0.11 (0.3)<br/>95% CI                    [-0.04, 0.02]      [-0.7, 0.47]<br/><br/>Relative effect (s.d.)    -0.45% (1.17%)     -0.45% (1.17%)<br/>95% CI                    [-2.72%, 1.86%]    [-2.72%, 1.86%]<br/><br/>Posterior tail-area probability p: 0.37<br/>Posterior prob. of a causal effect: 63.34%</span></pre><p id="f61f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型确实预测了比率从1.34到1.35的变化，但是该模型指出:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="3d44" class="na lx it mw b gy nb nc l nd ne">The probability of obtaining this effect by chance is p = 36.66%.<br/>This means the effect may be spurious and would generally not be<br/>considered statistically significant.</span></pre><p id="92cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这点上，先验的选择可以显著影响模型的假设，从而影响干预最终是否会被检测到。</p><h1 id="71e5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="3023" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在本文中，您已经看到:</p><ul class=""><li id="2aee" class="ni nj it lb b lc ld lf lg li nk lm nl lq nm lu nn no np nq bi translated">因果关系在预测干预中的应用</li><li id="e955" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">R和Python版本之间的区别</li><li id="41ab" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">先验假设在确定干预检测中的作用</li><li id="86a6" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">干预分析和总结报告的生成</li></ul><p id="4d7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢您的阅读，欢迎任何问题或反馈。</p><h1 id="7731" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">参考</h1><ul class=""><li id="4585" class="ni nj it lb b lc mo lf mp li nw lm nx lq ny lu nn no np nq bi translated"><a class="ae ky" href="https://github.com/dafiti/causalimpact" rel="noopener ugc nofollow" target="_blank">GitHub:dafi ti/causal impact</a></li><li id="505d" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=GTgZfCltMm8" rel="noopener ugc nofollow" target="_blank">使用Kay Brodersen的因果关系推断事件的影响</a></li><li id="a46c" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.investing.com/economic-calendar/interest-rate-decision-170" rel="noopener ugc nofollow" target="_blank"> investing.com:英国利率决议</a></li><li id="1dbd" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.rdocumentation.org/packages/CausalImpact/versions/1.2.4/topics/CausalImpact" rel="noopener ugc nofollow" target="_blank">记录:造成影响</a></li></ul></div></div>    
</body>
</html>