<html>
<head>
<title>Around the World in 80 Lines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">80行环游世界</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/around-the-world-in-80-lines-crossing-the-antimeridian-with-python-and-shapely-c87c9b6e1513?source=collection_archive---------12-----------------------#2020-10-20">https://towardsdatascience.com/around-the-world-in-80-lines-crossing-the-antimeridian-with-python-and-shapely-c87c9b6e1513?source=collection_archive---------12-----------------------#2020-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5ebd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Python和Shapely进行全球地理空间分析</h2></div><h2 id="0d0a" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">处理穿过反子午线(又名180度经线或国际日期变更线)的有问题的现实世界几何图形(多边形)</h2><p id="fa1d" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">得益于物联网、运输、物流和气候/地球科学领域新发展的激增，越来越多的数据分析师/科学家(通常熟悉<strong class="ld ir"> Python </strong>生态系统)正在将地理空间分析纳入他们的问题和工作流程。</p><p id="52d6" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">虽然流行的Python库，如Shapely或GeoPandas，通常都是开箱即用的，但我现在遇到了几个例子，人们在使用<strong class="ld ir">笛卡尔坐标系</strong>时经常会遇到问题。特别是，如果一个多边形穿过<a class="ae lu" href="https://en.wikipedia.org/wiki/180th_meridian" rel="noopener ugc nofollow" target="_blank">反子午线</a>(又名180度经线) :</p><ul class=""><li id="0bdd" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt mf mg mh mi bi translated">“我的多边形在我的可视化/地图上看起来像一团乱麻！”</li><li id="4512" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated"><em class="mj">“我的地理空间谓词/操作(例如包含、交集等。)失败"</em></li><li id="4f1c" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated"><em class="mj">“我不知道怎么/懒得把这个吓人的多边形分割开来”</em></li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/e14b202b4292b33a766294d06743374c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O51tvkzEjTgAT5u_p3GDlA.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">棘手的多边形[<em class="nf">I</em>mage by pawa rit Laosunthara]:甚至可能在视觉上看起来很好，但进一步的地理空间操作很可能会向南<strong class="bd ng"><em class="nf">(双关语)</em> </strong></p></figure><p id="7ffe" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">你并不孤单。事实上，即使是官方的GeoJSON标准也认识到了这个问题，并提倡沿着反子午线分割几何图形。虽然分割一个线串应该足够简单，但对于挑战<strong class="ld ir">多边形</strong>来说，这可能并不简单:</p><ul class=""><li id="e98f" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt mf mg mh mi bi translated">多次来回穿越反子午线</li><li id="beed" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated">包含孔或内环(即不只是简单的实心形状)</li><li id="b2f1" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated">会分裂成两个以上的组成部分</li></ul><p id="ec79" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">放心吧——确实有几种工具可以解决这个问题。然而，我将介绍一个精简的、可访问的Python实现，它只需要80行代码…不包括文档字符串😅</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="b531" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">TL；DR — </strong> <a class="ae lu" href="https://gist.github.com/PawaritL/ec7136c0b718ca65db6df1c33fd1bb11" rel="noopener ugc nofollow" target="_blank">这是我对多边形反子午线分裂的实现</a>(最后的片段也在文章的最后提供)。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="b548" class="no kg iq bd kh np nq nr kk ns nt nu kn jw nv jx kr jz nw ka kv kc nx kd kz ny bi translated"><strong class="ak">让我们来看物理</strong></h1><p id="b960" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">正如本文标题中提到的，我们将利用Shapely来解决这个问题最核心的方面。因此，任何几何构造最终都应符合<a class="ae lu" href="https://shapely.readthedocs.io/en/stable/manual.html#polygons" rel="noopener ugc nofollow" target="_blank"> Shapely Polygon API规范</a>。</p><p id="1f82" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">下面是一个输入GeoJSON(作为一个Python字典)的例子，它将被提供给最终的<code class="fe nz oa ob oc b">split_polygon</code>函数(参见本文底部):</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="684a" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">我们还应该提出一些实际的假设:</p><ol class=""><li id="d7f5" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt of mg mh mi bi translated">如果两个连续点之间的<strong class="ld ir">纵向距离</strong>超过180度，那么我们假设反子午线被穿过。</li><li id="52c3" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt of mg mh mi bi translated">我们假设两个连续点之间的纵向距离<strong class="ld ir"> </strong>总是最小的。例如，[-179，0]到[179，0]表示纵向距离为2度，而不是358度。</li><li id="82ff" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt of mg mh mi bi translated">我们假设感兴趣的多边形的跨度小于360度(即不会环绕整个地球)。这个要求是由于对<a class="ae lu" href="https://shapely.readthedocs.io/en/stable/manual.html#shapely.ops.split" rel="noopener ugc nofollow" target="_blank"> Shapely的分割操作的可接受类型的约束。</a></li></ol><p id="da3f" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">步骤1:检测反子午线交叉</strong></p><p id="1838" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">根据上面的假设1，我们可以编写一个超短函数来检测反子午线是否交叉。该功能将应用于<a class="ae lu" href="http://esri.github.io/geometry-api-java/doc/Polygon.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ld ir">每个多边形环</strong>的连续坐标对。</a></p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7bde" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">步骤2:将顶点移动到笛卡尔空间⬅️ ➡️ </strong></p><p id="b853" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">对于<em class="mj">每个环</em>的每个坐标:如果检测到交叉，我们<strong class="ld ir">现在基于假设2执行</strong> <strong class="ld ir">移位</strong>以确保连续顶点之间的纵向距离总是最小。在这个新的移位空间中，我们可以设置范围[-180，+180]之外的x坐标(即移位经度)。下面是基本的，* <strong class="ld ir">不完整的* </strong>骨架:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="25fd" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">小心，小心:</strong>如果一个多边形的边界(外壳)穿过反子午线<em class="mj">并因此移动</em>，但是任何内环<strong class="ld ir"> </strong>不包含任何交叉点，那么移动后的几何体可能会以<strong class="ld ir">损坏或</strong>无效而告终。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi og"><img src="../Images/9d0e3fd44b25d960088ec149b4b266f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7255y-Cn_N9rmpImzkkuMg.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">理想的视觉表现[ <em class="nf">我</em>法师由帕瓦里·劳孙塔拉]使用:<a class="ae lu" href="https://geojson.io/" rel="noopener ugc nofollow" target="_blank">https://geojson.io/</a></p></figure><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi oh"><img src="../Images/6e852497eb3e780fe9ff5068d1aabe70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GPmOsmpwK_q1jpqnYxIR8Q.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">如果在没有任何修正的情况下执行移位，则会导致损坏</p></figure><p id="e311" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">为了解决这个问题，我们需要跟踪外壳的边界。在对每个内环执行<strong class="ld ir">步骤2 </strong>后，如果相应环的任何坐标仍然位于外壳的边界之外，则必须首先对整个环应用+/- 360度的x分量<strong class="ld ir">校正</strong>。随后，我们现在可以注意到<strong class="ld ir">(移位)环</strong>是否与线<code class="fe nz oa ob oc b">x = -180</code>或<code class="fe nz oa ob oc b">x = 180</code>重叠。本质上，这一行将作为我们的<a class="ae lu" href="https://shapely.readthedocs.io/en/stable/manual.html#shapely.ops.split" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"/></a>。</p><p id="a41f" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">第三步:拆分✂️并翻译🔙至经度、纬度</strong></p><p id="281b" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">在所有这些转变之后，我们现在可以:</p><ol class=""><li id="31f7" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt of mg mh mi bi translated">用我们的移位环在笛卡尔空间中实例化一个形状优美的多边形</li><li id="e181" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt of mg mh mi bi translated"><em class="mj">让刀来做工作</em> : Shapely会自动用对应于反子午线的适当线串来分割我们的良好成形的多边形。<strong class="ld ir">注意:</strong> Shapely的分割器只能使用笛卡尔几何进行插值，不能使用测地线。</li><li id="571f" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt of mg mh mi bi translated">将生成的几何图形转换回有效的地理空间坐标</li></ol><p id="fe9c" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated">…我们完成了！(代码见下面的要点)</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi oi"><img src="../Images/b49194dffa8393ef6efcc49505bc4b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b9aSmKAvIOoPj31AxJLE_A.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">成功分割后的示例结果[<em class="nf">I</em>pawa rit Lao sunthara的法师]</p></figure><h1 id="6619" class="no kg iq bd kh np oj nr kk ns ok nu kn jw ol jx kr jz om ka kv kc on kd kz ny bi translated"><em class="nf">裹住</em>-起来</h1><p id="c63c" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">希望本演练和下面的实现对您有所帮助。如果您有任何疑问、反馈或问题，请随时通过<a class="ae lu" href="https://www.linkedin.com/in/pawarit-laosunthara/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>与我联系。感谢您的宝贵时间！</p><h1 id="6561" class="no kg iq bd kh np oj nr kk ns ok nu kn jw ol jx kr jz om ka kv kc on kd kz ny bi translated"><strong class="ak">Python的最终实现</strong></h1><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="1bec" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">常见问题/议题</strong></p><ul class=""><li id="3aff" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt mf mg mh mi bi translated"><a class="ae lu" href="https://github.com/Toblerity/Shapely/issues/495" rel="noopener ugc nofollow" target="_blank">https://github.com/Toblerity/Shapely/issues/495</a></li><li id="bec9" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated"><a class="ae lu" href="https://gis.stackexchange.com/questions/226605/shapely-polygons-crossing-the-antimeridian" rel="noopener ugc nofollow" target="_blank">https://GIS . stack exchange . com/questions/226605/shapely-polygons-crossing-the-anti meridian</a></li><li id="9950" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated"><a class="ae lu" href="https://gis.stackexchange.com/questions/95990/split-a-polygon-that-crosses-international-date-line-arcpy" rel="noopener ugc nofollow" target="_blank">https://GIS . stack exchange . com/questions/95990/split-a-polygon-that-crossed-international-date-line-arcpy</a></li></ul><p id="a583" class="pw-post-body-paragraph lb lc iq ld b le lv jr lg lh lw ju lj ko lx ll lm ks ly lo lp kw lz lr ls lt ij bi translated"><strong class="ld ir">替代工具/实施</strong></p><ul class=""><li id="4d5a" class="ma mb iq ld b le lv lh lw ko mc ks md kw me lt mf mg mh mi bi translated">https://www.gplates.org/docs/pygplates/generated/pygplates.DateLineWrapper.html</li><li id="0a6d" class="ma mb iq ld b le mk lh ml ko mm ks mn kw mo lt mf mg mh mi bi translated"><a class="ae lu" href="https://github.com/briannaAndCo/Leaflet.Antimeridian" rel="noopener ugc nofollow" target="_blank">https://github.com/briannaAndCo/Leaflet.Antimeridian</a></li></ul></div></div>    
</body>
</html>