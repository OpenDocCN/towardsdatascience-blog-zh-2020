<html>
<head>
<title>Using Azure Data Factory to incrementally copy files based on URL pattern over HTTP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure Data Factory基于HTTP上的URL模式增量复制文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-azure-data-factory-to-incrementally-copy-files-based-on-url-pattern-over-http-569476b625fc?source=collection_archive---------3-----------------------#2020-09-24">https://towardsdatascience.com/using-azure-data-factory-to-incrementally-copy-files-based-on-url-pattern-over-http-569476b625fc?source=collection_archive---------3-----------------------#2020-09-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a8fc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个创新的Azure数据工厂管道，通过HTTP从第三方网络服务器增量复制多个文件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/349479b15fd4e9cd31b7726e2dc55846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4wm7yLZ9yo_YP24YdWWAjg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@realaxer" rel="noopener ugc nofollow" target="_blank">田宽</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="5684" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Azure数据工厂复制文件很简单；然而，如果文件被托管在第三方web服务器上，那么这就变得很棘手了，复制它们的唯一方法是使用它们的URL。</p><p id="af54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将看到数据工厂活动的一种创新用法，即动态生成URL，通过HTTP获取内容，并将其存储在我们的存储帐户中以供进一步处理。</p><p id="c407" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">警告:</strong> <em class="lv"> Microsoft Azure是一项付费服务，遵循本文可能会导致您或您的组织承担财务责任。</em></p><p id="2dfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">在继续本文之前，请阅读我们的使用条款:</em><a class="ae ky" href="https://dhyanintech.medium.com/disclaimer-disclosure-terms-of-use-fb3bfbd1e0e5" rel="noopener"><em class="lv">https://dhyanintech . medium . com/disclaimer-disclosure-disclosure-terms-of-use-fb3 BF BD 1e 0e 5</em></a></p><h1 id="84e5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">先决条件</h1><ol class=""><li id="fe2a" class="mo mp it lb b lc mq lf mr li ms lm mt lq mu lu mv mw mx my bi translated">有效的Microsoft Azure订阅</li><li id="a249" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">Azure数据工厂实例</li><li id="10da" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">Azure数据湖存储第二代存储</li></ol><p id="e6f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">如果您还没有设置先决条件，请参考我们之前的文章，了解如何创建它们:</em></p><div class="ne nf gp gr ng nh"><a href="https://medium.com/@dhyanintech/a-definitive-guide-to-turn-csv-files-into-power-bi-visuals-using-azure-4483cf406eab" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">使用Azure将CSV文件转换为Power BI视觉效果的权威指南</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">使用Microsoft Azure产品将新冠肺炎数据转化为惊人的Power BI视觉效果的分步指南。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">medium.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv ks nh"/></div></div></a></div></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="da9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将建立我们的数据工厂，从GitHub的<a class="ae ky" href="https://github.com/CSSEGISandData/COVID-19" rel="noopener ugc nofollow" target="_blank">新冠肺炎存储库中获取公开可用的CSV文件，GitHub由约翰·霍普金斯大学系统科学与工程中心(JHU·CSSE)运营。我们对驻留在<strong class="lb iu">csse _ covid _ 19 _ data/csse _ covid _ 19 _ daily _ reports</strong>中的数据感兴趣。</a><a class="ae ky" href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_daily_reports" rel="noopener ugc nofollow" target="_blank">此文件夹</a>包含每日病例报告，自2020年1月22日起，每天添加一次新报告。文件遵循一致的命名约定<strong class="lb iu"> MM-DD-YYYY </strong>。战斗支援车</p><div class="ne nf gp gr ng nh"><a href="https://github.com/CSSEGISandData/COVID-19" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">CSSEGISandData/新冠肺炎</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">这是由约翰·霍普金斯大学运营的2019年新型冠状病毒视觉仪表板的数据存储库…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="od l ns nt nu nq nv ks nh"/></div></div></a></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/9598b72d416d3505a2aefc7b79a38ae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KS264smZ89_tRtzSGwmNeQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据来源:GitHub的文件列表(图片由作者提供)</p></figure><p id="9096" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为我们的项目获取这些文件的典型方式是从GitHub下载zip格式的存储库，在您的客户机上提取文件，然后手动将文件上传到我们的存储帐户。另一方面，如果我们希望我们的Power BI报告与新冠肺炎数据保持同步，我们必须每天上传一个新文件。我们希望找到一种解决方案来自动执行摄取任务，从而在无需额外手动操作的情况下保持数据最新。我们可以使用Azure数据工厂来实现这一点。我们的思考过程应该是:</p><ul class=""><li id="3b0e" class="mo mp it lb b lc ld lf lg li of lm og lq oh lu oi mw mx my bi translated">创建一个从GitHub获取文件的管道，并将其存储在我们的存储帐户中</li><li id="bdc8" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated">我们使用其<strong class="lb iu"> Raw </strong> URL一次只能获取一个文件(在<a class="ae ky" href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_daily_reports" rel="noopener ugc nofollow" target="_blank"> GitHub URL </a>打开一个文件，点击Raw打开没有GitHub UI的文件):<a class="ae ky" href="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/01-22-2020.csv" rel="noopener ugc nofollow" target="_blank">https://Raw . githubusercontent . com/CSSEGISandData/新冠肺炎/master/csse _ covid _ 19 _ data/csse _ covid _ 19 _ daily _ reports/01-22-2020 . CSV</a></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/b6b5540c7a01a0b0140444f3cfcdfc92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0W1RFgwjYogmWvZKxWlPLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据源:获取<strong class="bd ok"> Raw </strong> URL(图片由作者提供)</p></figure><ul class=""><li id="aa8d" class="mo mp it lb b lc ld lf lg li of lm og lq oh lu oi mw mx my bi translated">回想一下，文件遵循一个命名约定(MM-DD-yyyy . CSV)；我们需要创建数据工厂活动来自动生成文件名，即通过管道请求的下一个URL。</li><li id="ef05" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated">我们需要多次重复这项任务；第一次，我们将获取存储库中已经存在的所有文件，然后每天一次。</li><li id="d94a" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated">使用Azure数据块转换接收的文件</li></ul><blockquote class="ol"><p id="a15d" class="om on it bd oo op oq or os ot ou lu dk translated"><em class="ov">活动通常包含Azure数据工厂工作的转换逻辑或分析命令，并定义对数据执行的操作。</em></p><p id="99f3" class="om on it bd oo op ow ox oy oz pa lu dk translated"><em class="ov">管道是一起执行任务的数据工厂活动的逻辑分组。可以调度管道执行，或者可以定义触发器来确定何时需要开始管道执行。</em></p></blockquote><p id="2071" class="pw-post-body-paragraph kz la it lb b lc pb ju le lf pc jx lh li pd lk ll lm pe lo lp lq pf ls lt lu im bi translated"><em class="lv">延伸阅读:</em></p><div class="ne nf gp gr ng nh"><a href="https://docs.microsoft.com/en-us/azure/data-factory/concepts-pipelines-activities" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">Azure数据工厂中的管道和活动— Azure数据工厂</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">适用于:Azure数据工厂Azure Synapse Analytics(预览版)本文帮助您了解管道和…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.microsoft.com</p></div></div><div class="nq l"><div class="pg l ns nt nu nq nv ks nh"/></div></div></a></div><p id="f640" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">登录到<a class="ae ky" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>，找到并打开你的数据工厂。我们可以通过多种方式做到这一点:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/019997fe3dced261f2d3888e10fc2ccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w_0GbSWbsHBRYOzdxwL1ZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure门户:定位资源(图片由作者提供)</p></figure><h1 id="b75b" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">设置数据工厂组件</h1><p id="23e1" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">在<strong class="lb iu">概述</strong>页面上选择<strong class="lb iu">作者&amp;监视器</strong>，以在新的浏览器选项卡中加载我们的数据工厂实例。切换到下一个标签页(我们的数据工厂),在左上角的菜单中选择<strong class="lb iu">管理</strong>。让我们从创建链接服务开始，告诉数据工厂我们的资源在哪里。</p><h1 id="3975" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">链接服务</h1><blockquote class="ol"><p id="a6f7" class="om on it bd oo op ow ox oy oz pa lu dk translated"><em class="ov">链接服务就像连接字符串，它定义了数据工厂连接外部资源所需的连接信息。</em></p></blockquote><p id="a802" class="pw-post-body-paragraph kz la it lb b lc pb ju le lf pc jx lh li pd lk ll lm pe lo lp lq pf ls lt lu im bi translated">我们需要创建两个链接的服务，第一个告诉数据工厂我们的数据源(即GitHub)以及如何连接到它。我们需要提供HTTP地址(<strong class="lb iu"> Raw </strong>没有文件名的存储库URL)作为<strong class="lb iu">基URL</strong>(https://Raw . githubusercontent . com/CSSEGISandData/新冠肺炎/master/csse _ covid _ 19 _ data/csse _ covid _ 19 _ daily _ reports/)。遵循以下步骤:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/c739c069711bfc9076a17ebaa7b169c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-PtfjTpcHq3eDUnzzP8xw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建链接服务(图片由作者提供)</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/8d6e77bf738c460ab98484ececaff61c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*oUv1vG_qWhUbpbe3hMeQ5w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建HTTP链接服务(图片由作者提供)</p></figure><p id="11af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个链接的服务告诉我们的数据工厂数据目的地(即存储帐户)。创建一个新的链接服务，在<strong class="lb iu">新链接服务</strong>刀片上搜索<strong class="lb iu">存储</strong>，从匹配的资源列表中选择<strong class="lb iu"> Azure Data Lake Store Gen2 </strong>，点击<strong class="lb iu">继续</strong>。从下拉列表(4)中选择正确的存储帐户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/e3cda95e3d6932282a873c79655c6097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*AVxc-CTbza5TS9x0nZVqzQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建存储链接服务(图片由作者提供)</p></figure><p id="4199" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，您的屏幕应该如下所示。点击<strong class="lb iu">发布所有</strong>以保存您的更改，即保存。点击<strong class="lb iu">上的<strong class="lb iu">发布</strong>发布所有</strong>刀片，等待展开完成；可能需要几秒钟。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/838e75f9e30f68f85f6567dc31b06020.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GL7EFRayKsj-X8spMoO7cg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:发布更改(图片由作者提供)</p></figure><p id="b02f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要创建数据集来告诉我们的数据工厂使用什么数据及其格式。我们需要创建两个数据集链接到我们的两个链接服务。</p><h1 id="6d1e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据集</h1><blockquote class="ol"><p id="85d5" class="om on it bd oo op ow ox oy oz pa lu dk translated">数据集是数据的命名视图，它简单地指向或引用我们想要在活动中用作输入和输出的数据。数据集表示不同数据存储中的数据，可通过链接服务访问。</p></blockquote><p id="d49e" class="pw-post-body-paragraph kz la it lb b lc pb ju le lf pc jx lh li pd lk ll lm pe lo lp lq pf ls lt lu im bi translated">在左上角菜单中选择<strong class="lb iu">作者</strong>，在<strong class="lb iu">工厂资源</strong>刀片上找到<strong class="lb iu">数据集</strong>，点击显示的数字。选择<strong class="lb iu">新数据集</strong>并按照步骤创建我们的第一个数据集来表示我们的GitHub数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pp"><img src="../Images/1845cfe6fe37fcf467e3a25a4f888597.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOMfmUcP78I4FH8Rs0V6hg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pq"><img src="../Images/6d617fb9d3b64d47f070c0b5b70b9f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*62yI4xbdFA64YIh0Fc2rVA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建数据集(作者图片)</p></figure><p id="b69c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的新数据集将打开，显示进一步配置和定义我们的数据结构的选项。注意，<strong class="lb iu">连接</strong>选项卡下的<strong class="lb iu">基本URL </strong>填充了我们在链接服务中提供的原始文件夹URL。我们的数据位于文件URL，因此我们需要为数据工厂提供绝对URL来消费数据。我们将使用<strong class="lb iu">相对URL </strong>字段来导出文件的完整URL(基本URL +相对URL)。然而，我们希望我们的管道获取多个文件；因此，我们将使用一个参数动态生成文件名，而不是提供一个简单的文件名。</p><blockquote class="pr ps pt"><p id="ea38" class="kz la lv lb b lc ld ju le lf lg jx lh pu lj lk ll pv ln lo lp pw lr ls lt lu im bi translated">我们可以使用参数将<strong class="lb iu">外部</strong>值传递到管道、数据集、链接服务和数据流中。通过参数化资源，我们可以每次用不同的值重用它们。</p><p id="7eaa" class="kz la lv lb b lc ld ju le lf lg jx lh pu lj lk ll pv ln lo lp pw lr ls lt lu im bi translated">参数<strong class="lb iu">设置</strong>用于管道运行的整个持续时间。它们就像编程语言中的常量一样，定义在源代码的顶部。</p></blockquote><p id="6c97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">切换到<strong class="lb iu">参数</strong>选项卡，点击<strong class="lb iu"> + New </strong>创建一个新参数。如下所示设置字段；我们使用第一个CSV文件的名称作为默认值。切换到<strong class="lb iu">连接</strong>页签，将<strong class="lb iu">相对URL </strong>设置为<code class="fe px py pz qa b">@dataset().fileName</code> <em class="lv">。</em></p><p id="2094" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">语法引用数据集参数:</em> <code class="fe px py pz qa b">@dataset().PARAMETER_NAME</code></p><p id="95a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用正确的语法键入参数名称，或者使用<strong class="lb iu">添加动态内容</strong>刀片来填充它(5–7)。</p><blockquote class="ol"><p id="fade" class="om on it bd oo op ow ox oy oz pa lu dk translated">Azure数据工厂中的动态内容使用表达式语言。</p></blockquote><p id="af42" class="pw-post-body-paragraph kz la it lb b lc pb ju le lf pc jx lh li pd lk ll lm pe lo lp lq pf ls lt lu im bi translated"><em class="lv">延伸阅读:</em></p><div class="ne nf gp gr ng nh"><a href="https://docs.microsoft.com/en-us/azure/data-factory/control-flow-expression-language-functions" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">Azure数据工厂中的表达式和函数——Azure数据工厂</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">适用于:Azure数据工厂Azure Synapse Analytics(预览版)本文提供了有关表达式和…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.microsoft.com</p></div></div><div class="nq l"><div class="qb l ns nt nu nq nv ks nh"/></div></div></a></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qc"><img src="../Images/dba98f63fecb76045acfc0ef8312ba44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QJdJc0UFnHUTfpwEfRVNhQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建和引用数据集参数(作者图片)</p></figure><p id="a4a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个新的数据集来表示我们的存储帐户中的数据。遵循前面提到的步骤(在<strong class="lb iu">新数据集</strong>刀片上搜索<strong class="lb iu">Azure Data Lake Storage gen 2</strong>而不是HTTP)。您的新数据集应该如下所示；发布所有更改，使它们可以在我们的数据工厂中使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qd"><img src="../Images/d96a2b3e8cdd201cb0cdad65a858515a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*Ub_oSGEENLpGcGlOy0GbYQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:创建数据集(作者图片)</p></figure><p id="8331" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经满足了建立数据工厂的要求，那么是时候创建一个执行实际任务的管道了。让我们从从<strong class="lb iu">工厂资源</strong>刀片创建一个新管道开始(类似于创建一个新数据集)。</p><h1 id="1770" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">管道</h1><p id="a191" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">为您的新管道命名，并在<strong class="lb iu">变量</strong>选项卡中创建两个类型为string和01–22–2020的变量(I和j)作为默认值<strong class="lb iu">。</strong></p><blockquote class="pr ps pt"><p id="963b" class="kz la lv lb b lc ld ju le lf lg jx lh pu lj lk ll pv ln lo lp pw lr ls lt lu im bi translated">变量可以在管道开始时设置，并在运行过程中读取和修改。变量在运行时包含实值，可以赋给参数。</p><p id="170f" class="kz la lv lb b lc ld ju le lf lg jx lh pu lj lk ll pv ln lo lp pw lr ls lt lu im bi translated">它们就像编程语言中的常规变量<strong class="lb iu"/>。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qe"><img src="../Images/07427bad6011616521883e62ddb03d04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g1mOBKUIVSyjCyusz-nLyQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:使用变量设置管道(图片由作者提供)</p></figure><h1 id="3c21" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">活动</h1><p id="6e3b" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">是时候将活动添加到我们的渠道中了；所有活动都可以在<strong class="lb iu">活动</strong>刀片上进行。我们将使用以下活动:</p><ul class=""><li id="325f" class="mo mp it lb b lc ld lf lg li of lm og lq oh lu oi mw mx my bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/control-flow-get-metadata-activity" rel="noopener ugc nofollow" target="_blank">获取元数据</a>:获取我们商店中存在的所有CSV文件的列表。最初，这将返回null，因为我们的存储中还没有文件。该输出将作为下一个<em class="lv">设置变量</em>活动的输入。</li><li id="7b07" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/control-flow-set-variable-activity" rel="noopener ugc nofollow" target="_blank">设置变量</a> (1):用我们存储的最新文件名设置我们的变量<em class="lv"> i </em>。最初，这将使用变量<em class="lv"> j </em>的默认值(即01–22–2020)设置<em class="lv"> i </em>，因为从<em class="lv">获取元数据</em>活动的输入将为空。计算输出(变量<em class="lv"> i </em>)将作为下一个<em class="lv">的输入，直到</em>活动。</li><li id="9432" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/control-flow-until-activity" rel="noopener ugc nofollow" target="_blank">直到</a>:生成从最近可用文件日期到今天的文件名，输入值<em class="lv"> i </em>将作为开始日期，今天-1将作为结束日期。生成的输出(变量<em class="lv"> i </em>)将作为下一个<em class="lv">复制数据</em>子活动的输入。</li><li id="1147" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-overview" rel="noopener ugc nofollow" target="_blank">复制数据</a>:通过HTTP复制实际的文件并存储到我们的存储器中。从<em class="lv">到</em> activity(变量<em class="lv"> i </em>)的输入将被传递给我们的源数据集的参数<em class="lv"> fileName，</em>完成我们到原始CSV文件的URL。该文件将通过HTTP访问，并保存到我们的存储。成功端将连接到我们的下一个<em class="lv">设置变量</em>活动。</li><li id="11d2" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu oi mw mx my bi translated">设置变量(2 &amp; 3):为下一次迭代增加变量<em class="lv"> i </em>。我们需要两个设置变量活动，因为我们不能引用在<strong class="lb iu">值</strong>字段中设置的变量；因此，我们将使用变量<em class="lv"> j </em>作为中间变量来增加<em class="lv"> i </em>。</li></ul><h2 id="09b1" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">获取元数据</h2><p id="9d97" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">在<strong class="lb iu">常规</strong>类别下找到<strong class="lb iu">获取元数据</strong>，将其拖放到画布上。给它一个名字并继续，如下所示。</p><p id="1c27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">语法引用获取元数据活动的输出:</em> <code class="fe px py pz qa b">@{activity('GET_METADATA_ACTIVITY_NAME').output.FIELD_NAME}</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qr"><img src="../Images/2b149575f6049332c8227e1f6604ce36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j6lhMc8Jqm4mfcLO_RaTCA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:获取元数据活动(图片由作者提供)</p></figure><h2 id="b242" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">设置变量(1)</h2><p id="4f2b" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">在<strong class="lb iu">常规</strong>类别下找到<strong class="lb iu">设置变量</strong>，将其拖放到画布上。将其与获取元数据活动的<strong class="lb iu">成功</strong>(绿色)结束连接。给它一个名字，并如下设置变量<em class="lv"> i </em></p><pre class="kj kk kl km gt qs qa qt qu aw qv bi"><span id="4e1c" class="qf lx it qa b gy qw qx l qy qz">@if(empty(last(activity('ac_checkAllAvailableFiles').output.childItems)),variables('j'),formatDateTime(addDays(formatDateTime(replace(last(activity('ac_checkAllavailableFiles').output.childItems).name,'.csv',''),'MM-dd-yyyy'),1),'MM-dd-yyyy'))</span></pre><p id="3558" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击<strong class="lb iu">值</strong>字段可以打开<strong class="lb iu">添加动态内容</strong>刀片；您可以键入或复制粘贴上面的表达式，或者使用blade的控件来创建表达式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ra"><img src="../Images/6aff0724143f3c6ad0ad03627265e364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*5GnC03MCEOGPlvuf5B9aKA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:设置变量活动(图片由作者提供)</p></figure><h2 id="d097" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">直到</h2><p id="6f05" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">将<strong class="lb iu">定位到<strong class="lb iu">迭代&amp;条件</strong>类别下的</strong>处，将其拖放到画布上，并将其与之前设置的变量活动的成功结束连接。给它一个名字；在<strong class="lb iu">设置</strong>选项卡中，输入以下<strong class="lb iu">表达式</strong>:</p><pre class="kj kk kl km gt qs qa qt qu aw qv bi"><span id="cf31" class="qf lx it qa b gy qw qx l qy qz">@greater(dayOfYear(formatDateTime(variables('i'),'MM-dd-yyyy')),dayOfYear(subtractFromTime(utcnow(),1,'Day')))</span></pre><p id="d561" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">移至<strong class="lb iu">活动</strong>选项卡，点击编辑图标添加其余活动。我们将在中添加其他活动<em class="lv">，直到我们需要多次执行它们。单击编辑图标将显示一个空画布，表示我们现在正在向Until活动中添加要迭代的活动。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qr"><img src="../Images/9a89272f2b17c410a16c162e0e5f1639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mw61MWqF9gHT01toSEEGNw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:直到活动(图片由作者提供)</p></figure><h2 id="d49b" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">复制数据</h2><p id="27b5" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">在<strong class="lb iu">移动&amp;变换</strong>类别下找到<strong class="lb iu">复制数据</strong> a，将其拖放到画布上。给它命名，设置<strong class="lb iu">源</strong>和<strong class="lb iu">宿</strong>标签配置，如图所示。我们将用变量<em class="lv"> i </em>给<strong class="lb iu">文件名</strong>参数赋值。下面是<strong class="lb iu">文件名</strong>表达式，方便复制粘贴:)</p><pre class="kj kk kl km gt qs qa qt qu aw qv bi"><span id="4b51" class="qf lx it qa b gy qw qx l qy qz">@concat(formatDateTime(variables('i'),'MM-dd-yyyy'),'.csv')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi rb"><img src="../Images/24de5c021be66600af64e1d36e7530c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nH7NmDcT-46wX0wDRWOWIw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:用参数复制数据活动(图片由作者提供)</p></figure><h2 id="10db" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">设置变量(2和3)</h2><p id="9be6" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">添加另一个<strong class="lb iu">设置变量</strong>活动。将其与<strong class="lb iu">复制数据</strong>活动的s <em class="lv">成功</em>结束连接。给它一个名称，并将变量<em class="lv"> j </em>设置为</p><pre class="kj kk kl km gt qs qa qt qu aw qv bi"><span id="c22e" class="qf lx it qa b gy qw qx l qy qz">@addDays(formatDateTime(variables('i'),'MM-dd-yyyy'),1)</span></pre><p id="87c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加另一个设置变量活动，并将其与前一个设置变量活动的<em class="lv">成功</em>结束连接。将<em class="lv"> i </em>设为<code class="fe px py pz qa b">@variables('j')</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi rc"><img src="../Images/63eacb87d5f8434a3293eca8045bb456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hzap0iVmghTNEMIbikIGvQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:递增参数值(图片由作者提供)</p></figure><p id="d419" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的管道现在已经准备好了；它应该看起来像下面这样。此外，出于任何故障排除的目的，您可以参考本文末尾来自GitHub的我们管道的JSON。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi rd"><img src="../Images/b3aa4e8c1f502288b6e984bdfad83b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2S8I_VKpV19yMhnxb99ahQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:通过HTTP复制文件的管道</p></figure><p id="eedf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加所有活动后的下一步是验证我们的管道。找到并选择<strong class="lb iu"> Validate </strong>选项，以确保我们的管道没有错误并准备好执行。管道<strong class="lb iu">验证输出</strong>刀片将向我们显示验证的结果。</p><p id="7990" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有两种选择来运行我们的管道和看到我们的劳动成果。我们可以调试运行我们的管道而不发布我们的更改，或者我们可以先发布我们的更改。建议<strong class="lb iu">先调试</strong>运行管道，然后发布更改；调试运行在管道的<strong class="lb iu">输出</strong>选项卡中显示us日志和其他有用的跟踪信息。花几分钟时间浏览输出日志，以清楚地了解执行和各种活动。示例输出如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi re"><img src="../Images/e774b41ed54ec02c76dd932e096c78ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wIKrv3DihAMOQopkun1c_A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure数据工厂:典型的调试管道输出(图片由作者提供)</p></figure><p id="3c07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以使用<strong class="lb iu"> Add trigger </strong>选项立即运行管道，或者设置一个自定义触发器，以特定的间隔、时间或基于外部事件运行管道。</p><h2 id="a2b0" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">管道JSON</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="rf rg l"/></div></figure><h1 id="856b" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="1629" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">我们提出了一个通过使用URL在HTTP上复制数据的引人注目的问题。我们讨论了构成管道的各种组件，并建立了一个创新的数据工厂管道来解决手头的问题。我们还讨论了如何设置管道的自动执行，以及管道执行日志的简要概述。</p><h1 id="2ce0" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">后续步骤</h1><p id="4437" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">如果您正在关注我们关于将CSV数据转换为Power BI视觉效果的系列文章，请阅读我们的下一篇文章，继续使用PySpark清理和转换Azure Databricks中的数据。</p><div class="ne nf gp gr ng nh"><a href="https://medium.com/@dhyanintech/cleansing-and-transforming-schema-drifted-csv-files-into-relational-data-in-azure-databricks-519e82ea84ff" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">在Azure Databricks中将模式漂移的CSV文件清理并转换为关系数据</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">使用PySpark处理模式漂移文件并将其加载到Azure Databricks中的Azure Synapse Analytics数据仓库</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">medium.com</p></div></div><div class="nq l"><div class="rh l ns nt nu nq nv ks nh"/></div></div></a></div><p id="67c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您试图在您的数据工厂管道中添加和执行Databricks笔记本，我们有完美的东西向您展示。</p><div class="ne nf gp gr ng nh"><a href="https://medium.com/@dhyanintech/executing-azure-databricks-notebook-in-azure-data-factory-pipeline-using-access-tokens-3326b8703432" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">使用访问令牌在Azure数据工厂管道中执行Azure Databricks笔记本</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">关于如何使用Azure Key Vault安全访问在数据工厂管道中添加和执行Databricks笔记本的指南…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">medium.com</p></div></div><div class="nq l"><div class="ri l ns nt nu nq nv ks nh"/></div></div></a></div></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="21a8" class="qf lx it bd ly qg qh dn mc qi qj dp mg li qk ql mi lm qm qn mk lq qo qp mm qq bi translated">喜欢这个帖子？与Dhyan联系</h2><p id="4bb0" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li pi lk ll lm pj lo lp lq pk ls lt lu im bi translated">让我们做朋友吧！你可以在<a class="ae ky" href="https://www.linkedin.com/in/dhyans/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我或者在<a class="ae ky" href="https://dhyanintech.medium.com/membership" rel="noopener"> Medium </a>上<strong class="lb iu">加入</strong>我。</p></div></div>    
</body>
</html>