<html>
<head>
<title>Quirky Keras: Custom and Asymmetric Loss Functions for Keras in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">古怪的Keras:R中Keras的定制和非对称损失函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/quirky-keras-custom-and-asymmetric-loss-functions-for-keras-in-r-a8b5271171fe?source=collection_archive---------11-----------------------#2020-10-24">https://towardsdatascience.com/quirky-keras-custom-and-asymmetric-loss-functions-for-keras-in-r-a8b5271171fe?source=collection_archive---------11-----------------------#2020-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="a156" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><figure class="gl gn jx jy jz ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/5a4d09f6c192810335f71170a799c070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgvprIMcowprN3Fg7HdhUg.jpeg"/></div></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">[图片由蒙提洛夫在<a class="ae kl" href="https://unsplash.com/@montylov?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上拍摄]</p></figure><p id="c1ac" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">TL；DR——本教程向您展示如何使用<em class="lk">包装器</em>函数来构建自定义损失函数，该函数采用除y_pred和y_true之外的参数用于r中的Keras。请参见线性指数误差(LINEXE)和加权最小二乘误差(WLSE)的示例代码。</p><h1 id="b68f" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">背景</h1><p id="ee84" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">在统计学习中，损失函数是将非正式的哲学建模目标翻译成正式的数学语言(Hennig &amp; Kutlukaya，2007)。因此，估算中损失函数的选择有些主观，取决于模型的具体应用或使用时的决策。以下是一些需要考虑的损失函数:</p><figure class="mp mq mr ms gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi mo"><img src="../Images/d3c37719a7ccd30ab163055f944889a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GoMga2XWrNUOs5aTuaC6Mw.png"/></div></div></figure><h1 id="ee71" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">对称损失</h1><ul class=""><li id="3551" class="mt mu iq ko b kp mj kt mk kx mv lb mw lf mx lj my mz na nb bi translated"><strong class="ko ja">均方误差(MSE) </strong>是简单最小二乘回归中常见的目标函数，它是一个凸函数，通过平方误差来强调远离大部分数据的点。MSE对较大误差的惩罚大于较小误差；该函数在尾部比在中部更陡。</li><li id="7903" class="mt mu iq ko b kp nc kt nd kx ne lb nf lf ng lj my mz na nb bi translated">对于较小的x，<strong class="ko ja">对数双曲余弦(LOGCOSH) </strong>或log(cosh(x))近似为1/2(x^2，对于较大的x，【abs(x) — log(2)】。因此，LOGCOSH的工作方式与MSE非常相似，但受偶然的非常不正确的预测的影响较小，在这方面，它类似于<strong class="ko ja">平均绝对误差(MAE) </strong>。当较大值的估计误差不需要像MSE中那样通过平方来惩罚时，LOGCOSH和MAE是有用的。</li><li id="e204" class="mt mu iq ko b kp nc kt nd kx ne lb nf lf ng lj my mz na nb bi translated"><strong class="ko ja">均方百分比误差(MSPE) </strong>在相对误差更令人感兴趣的问题中很有用(例如，10/100的误差比10/100，000的误差更令人感兴趣)。然而，MSPE偏向于较低的预测值，不适合于数据为正偏差的问题(例如，流量总是&gt; =0)。</li></ul><p id="8e96" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是为MSPE编写的自定义代码。注意，函数只取y_true和y_pred。</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="59a5" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">不对称损失</h1><p id="fc8a" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">当低估和高估相同的绝对误差时，对称函数产生相同的损失。然而，<em class="lk">不对称</em>损失函数对不同的损失方向应用不同的惩罚。例如，在水文预测中，不对称的损失函数会迫使模型在洪水时高估流量，而在干旱时低估流量，而不是相反。这种方法导致水资源管理者做出更保守的决策，因为模型预测了更多的极端洪水和干旱。</p><p id="8a6e" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">首先，需要一个简单的分类模型将观测值标记为洪水(洪水==1)和干旱(洪水==0)。对于每个流域，整个记录的平均降水量可以指定为一个硬阈值；如果某个月的降雨量低于这个数值，这种现象被称为“干旱”，如果高于这个数值，则被称为“洪水”给定这个名称，现在，不同的损失可以应用于数据中不同位置的预测误差。</p><h1 id="4322" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Keras不对称损失:用包装器向损失函数传递附加参数</h1><p id="47ee" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">让我们从WLSE(等式1)开始，其中α和β对于标记为洪水和干旱的观测值具有不同的值。因此，我们将αd、βd、αf和βf作为损失函数的输入。</p><figure class="mp mq mr ms gt ka gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/639492242e8afcc5e45575dffd0bcdc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*5oz9wAXH748WqDe01qhdcw.png"/></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">情商。一</p></figure><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="9f06" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，快克；Keras中的损失只能接受两个参数:y_true和y_pred，它们分别是目标张量和模型输出张量。然而，如果我们希望损失依赖于其他张量，如α和β向量，我们需要使用函数闭包。这里，wlse loss函数接受我们想要的任何参数，包装函数返回仅依赖于y_true和y_pred的函数。</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="4ae4" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是与LINEXE相同的概念:</p><p id="dc1c" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">LINEXE(等式2)取决于phi，对于标记为洪水和干旱的观测值，phi具有不同的值。因此，我们将phid和phif作为损失函数的输入。</p><figure class="mp mq mr ms gt ka gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/4622e02b26b47a992604cc8263b6d464.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*n2Qe00zNHrtc5nbj_Y_tLA.png"/></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">情商。2</p></figure><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="1d43" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">…包装材料:</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="4567" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，继续建模。首先，我们定义神经网络模型的架构:</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">*“trainsetpv”是训练集预测变量。</p></figure><p id="eec0" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，我们必须编译并拟合模型。对于对称损耗，我们有:</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">*“trainsetrv”是训练集响应变量。</p></figure><p id="5510" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">…对于对称损耗，我们的工作已经完成！</p><p id="a77d" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在不对称损失中，由于我们现在已经标记了观测值(洪水或干旱)，我们需要这种指定来正确地与每个y_true和y_pred对齐。因此，我们不能再使用在不改变加扰算法以适应标签的情况下对数据进行加扰的迷你批次训练方法。迷你批次的大小由验证分割(例如，0.2)决定，并且仅帮助加速模型训练。为了在没有迷你批次的情况下仍然做出准确的预测，我们可以简单地增加训练时段，并且通过设置shuffle=FALSE，我们不再有洪水和干旱标签与数据不一致的问题。</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="a817" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，预测可以来自:</p><figure class="mp mq mr ms gt ka"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">*“testsetpvs”是测试集预测变量。</p></figure><h1 id="b520" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">示例结果</h1><p id="e9bf" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">图1显示了加利福尼亚州一个河流流域的流量预测，即北福克坝的美国河(White，E. 2020)。我们可以看到WLSE和LINEXE的不对称损失，预测总是高估洪水而低估干旱！这是我们希望发生的。这样我们可以做出更保守的决定，并为更极端的情况做好准备。</p><figure class="mp mq mr ms gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi nl"><img src="../Images/7c91ade5328a0be4c978f66027eea979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCCscwWXtWx7wXPH_NS4qw.png"/></div></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">图一。North Fork大坝美国河流流量的神经网络预测[图片由作者用ggplot2制作]。</p></figure><h1 id="d306" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">结论</h1><p id="568e" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">Keras中的损失只能接受两个参数:y_true和y_pred，它们分别是目标张量和模型输出张量。然而，如果我们希望损失依赖于其他张量——如不对称损失的情况——我们需要使用函数闭包。这里，loss函数接受我们想要的任何参数，并返回仅依赖于y_true和y_pred的函数。因此，命名为包装器。</p><p id="2cd3" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一般来说，选择损失函数的灵活性在基于风险的决策中特别有用，在这种情况下，建模的目的是准确预测概率分布，特别是在可能发生高成本后果的尾部。不对称损失函数在这方面证明是有用的。</p><h2 id="7a89" class="nm lm iq bd ln nn no dn lr np nq dp lv kx nr ns lz lb nt nu md lf nv nw mh iw bi translated">参考资料:</h2><p id="dbd3" class="pw-post-body-paragraph km kn iq ko b kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le lf mn lh li lj ij bi translated">C.关于损失函数设计的一些想法(2007)。REVSTAT–统计杂志，5 (1)，19–39。</p><p id="0b87" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">E.White，<a class="ae kl" href="https://watershed.ucdavis.edu/shed/lund/students/Ellie_White_dissertation2020.pdf" rel="noopener ugc nofollow" target="_blank">无资料流域未受损流量预测的统计学习</a> (2020)。博士论文。</p></div></div>    
</body>
</html>