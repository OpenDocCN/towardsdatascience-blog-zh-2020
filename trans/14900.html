<html>
<head>
<title>Weather Model Processing With FOSS4G and JavaScript: Best Practices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用FOSS4G和JavaScript处理天气模型:最佳实践</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/weather-model-processing-with-foss4g-and-javascript-best-practices-d583e6dde201?source=collection_archive---------53-----------------------#2020-10-13">https://towardsdatascience.com/weather-model-processing-with-foss4g-and-javascript-best-practices-d583e6dde201?source=collection_archive---------53-----------------------#2020-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2d1bba1b2691cf0d51768278cbfab46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ANNGwmBDia_5IAyxzZ_-A.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><div class=""/><div class=""><h2 id="5c14" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">使用免费开源地理软件(FOSS4G)和/或JavaScript检索、处理和管理天气模型数据的技巧和诀窍。</h2></div><p id="d2ae" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一年前我写了《用FOSS4G自动化天气模型处理<a class="ae lq" href="https://medium.com/swlh/automated-weather-model-processing-with-foss4g-lessons-learned-8aaaeda1e3bc" rel="noopener"> <strong class="kw jg"> <em class="lr">:经验教训</em> </strong> </a>，概述了我创建一个使用开源地理软件自动检索、处理和管理天气模型数据的系统的旅程。我已经用这个系统工作了一年，包括为科罗拉多州发布了一个最先进的天气预报网站，并有机会向商业和学术天气预报领域的关键人物学习。</p><p id="76fa" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">作为分发和使用原始天气模型数据的常见范例的介绍，原始文章中的发现仍然很有用。后续文章在此基础上进行扩展，涵盖了处理这些数据的最佳实践和技术，仅使用免费和开源地理软件(FOSS4G)。还有一些使用JavaScript处理这些数据的技巧和诀窍，JavaScript正在成为一种更普遍的语言，包括在地理信息系统(GIS)领域。</p><p id="16e1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">本文假设您已经安装了<a class="ae lq" href="https://gdal.org/" rel="noopener ugc nofollow" target="_blank"> GDAL </a>，并且已经知道从哪里下载天气模型文件以及它们通常是如何构造的。“索引文件”会经常被引用，也就是您经常看到的伴随着<code class="fe ls lt lu lv b">grib2</code>文件的<code class="fe ls lt lu lv b">.idx</code>文件:</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/fa6e2d7b9d32884d503c75a306f8ca14.png" data-original-src="https://miro.medium.com/v2/resize:fit:494/format:webp/1*G0fkMMwq_e2c-FGdm1BLZg.png"/></div></figure><p id="b307" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这些文件对于管理大型栅格和可变波段排序非常有用，您应该尽可能地利用它们。</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mb"><img src="../Images/cd0ca62b4942587348cf7b870f4723cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QTU8Ou7CECnfFZvYhL7ueg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h2 id="c07d" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">1.使用梯度</h2><p id="86e6" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">不直接推荐这一点的原因是它偏离了本文的主题-已经有大量的人在使用GIS和地理空间栅格做令人难以置信的事情，目标是帮助在该领域更容易地访问天气模型数据并利用现有的人才。</p><p id="c644" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，如果你的重点是纯粹的气象学或更科学的学科，你可能只想使用<a class="ae lq" href="http://cola.gmu.edu/grads/" rel="noopener ugc nofollow" target="_blank">处理天气模型和其他科学数据的行业标准——GRaDS</a>。该软件有自己的脚本语言，它需要大量的工作来制作看起来像普通桌面GIS应用程序中可以轻松生成的质量的地图，因此它代表了一种可能超出GIS学科范围的用例。</p><h2 id="ed72" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">2.除非需要在web地图上绘制数据，否则不要重新投影数据</h2><p id="bc03" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">天气模型有各种各样的投影(通常是某种形式的朗伯共形圆锥曲线)，如果不丢失数据或强制插值，就不容易重新投影到EPSG:4326或Web墨卡托。如果查询重新投影的数据，与原始模型数据相比，您可能会得到不准确的预测。</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/f751766f6df4e793f6aa99461898d7ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33cavp_i9KQbk9DXv8RqSQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">顶部栅格(NAM 3km模型)处于其原始投影中。底部栅格是重新投影到EPSG的结果:4326。忽略倾斜(底部的图像仍然用顶部图像的投影绘制在地图上)，注意原始数据是如何未被充分表示的，例如画圈的像素簇。图片作者。</p></figure><h2 id="2073" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">3.基于JavaScript的投影库(如Proj4js)不能正确地重新投影大多数天气模型的坐标</h2><p id="66b7" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">如果您正在使用Node.js查询地理空间栅格(使用类似于<a class="ae lq" href="https://geotiffjs.github.io/" rel="noopener ugc nofollow" target="_blank"> Geotiff.js </a>的东西)，并且您希望在查询纬度/经度坐标时将它们保留在原始投影中，那么GDAL提供的Proj4和WKT字符串可以传递给<a class="ae lq" href="http://proj4js.org/" rel="noopener ugc nofollow" target="_blank"> proj4js </a> —但是您会注意到重新投影后出现了一些非常严重的空间误差(许多英里，而不是几英尺)。有些转换是proj4js做不到的，似乎大多数天气模型预测都属于这一类。</p><p id="d526" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您将需要使用gdal绑定(<a class="ae lq" href="https://www.npmjs.com/package/gdal-js" rel="noopener ugc nofollow" target="_blank"> gdal-js </a> —不理想，因为它们需要旧版本的GDAL)或者调用一个shell来调用GDAL的<code class="fe ls lt lu lv b">gdaltransform</code>以获得更精确的重新投影——或者JavaScript之外的另一个重新投影库。为了简单起见，您可以将grib2文件加载到QGIS中，并使用“提取投影”工具导出一个可以传递给<code class="fe ls lt lu lv b">gdaltransform</code>的<code class="fe ls lt lu lv b">.prj</code>文件。</p><h2 id="63ea" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">4.使用PostGIS out-db栅格来管理大量文件</h2><p id="c5eb" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">如果您以任何程度的规律性处理天气模型数据，您将拥有大量的地理空间栅格，其中包含许多波段。<a class="ae lq" href="https://postgis.net/" rel="noopener ugc nofollow" target="_blank"> PostGIS for PostgreSQL </a>是一个很好的工具来组织这些数据，但是在读取/写入数据本身时太慢了——但是，您可以将栅格作为文件系统上的GeoTIFF(或任何东西)保存，并从PostGIS中将其作为<a class="ae lq" href="https://postgis.net/docs/RT_reference.html#outdb" rel="noopener ugc nofollow" target="_blank"> out-db栅格进行引用。</a></p><h2 id="4f14" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">5.对于制作处理地理空间天气模型数据的API来说，Node.js是一个不错的选择</h2><p id="2118" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">使用其他语言作为后端或API有很多好处(比如python，<a class="ae lq" href="https://pypi.org/project/GDAL/" rel="noopener ugc nofollow" target="_blank">及其GDAL绑定</a>)，但是Node.js越来越流行，它是处理这些数据的可行选择。如果您使用Postgres和GeoTIFF文件，这是一个可以接受的解决方案，但是如果您预计有巨大的并发需求，您可能会希望采用不同的方法，使用原始二进制文件或极端的缓存技术。对于基于JS的方法，您可以使用Geotiff.js加载天气模型GeoTIFF文件，并以不错的性能查询它们。<a class="ae lq" rel="noopener" target="_blank" href="/geotiff-coordinate-querying-with-javascript-5e6caaaf88cf">我写了一篇文章，详细介绍了这里的细节。</a></p><h2 id="8b9d" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">6.识别未知波段</h2><p id="6318" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">NOAA的NCEP(通常负责开发和传播天气模型的美国机构)与GRIB2格式的使用并不完全一致，这导致了各种GRIB解码器，包括NOAA自己创建的一些解码器！在撰写本文时，NBMv4模型显示了未知的谱带，甚至在NCEP自己的索引查找文件中也是如此:</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/e1783bfc3ed2c6b4080082a73551488d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FLWdXEfBVHUreDiYp7GjPA.png"/></div></div></figure><p id="c640" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，GDAL似乎比其他一些库更难识别波段，因此您的栅格中可能有许多“未知”波段。如果元数据似乎无法描述天气模型参数和/或级别，则尝试找出波段所属的工作流程如下:</p><ol class=""><li id="7f23" class="nc nd jf kw b kx ky la lb ld ne lh nf ll ng lp nh ni nj nk bi translated">试着在附随里找。grib2文件的idx文件。</li><li id="68a7" class="nc nd jf kw b kx nl la nm ld nn lh no ll np lp nh ni nj nk bi translated">使用美国宇航局的<a class="ae lq" href="https://www.giss.nasa.gov/tools/panoply/" rel="noopener ugc nofollow" target="_blank">全景数据查看器</a>，它似乎比其他GRIB解码器如degrib更成功。</li><li id="3377" class="nc nd jf kw b kx nl la nm ld nn lh no ll np lp nh ni nj nk bi translated">使用<a class="ae lq" href="https://www.cpc.ncep.noaa.gov/products/wesley/wgrib2/" rel="noopener ugc nofollow" target="_blank"> wgrib2 </a>，这是标准的(也是GRaDS中使用的一个选项)，但可能很难使用。</li></ol><p id="1e11" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">Grib2文件在历史上被辛勤工作的GDAL贡献者忽略了一点，但它们在修复我最近在更新的天气模型(如NBMv4)中发现的一些错误方面非常棒。这些模型应该在GDAL &gt;3.1中完全工作，但是旧版本，比如一些Linux发行版中的当前上游版本(3.0.4)，在处理一些参数(比如积雪)时会出现阻塞。如果您注意到其他问题，请联系gdal listserv！</p><h2 id="cefb" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">7.订阅游牧者列表服务</h2><p id="9d35" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">天气模型的主要分发服务器——NCEP游牧部落——往往会以相当惊人的频率经历中断，但通常会被排除或很快在列表服务器上发布中断通知。其他重要的通知包括对模型的更改以及对它们的添加或删除，这可能会破坏您的脚本。</p><h2 id="b6ec" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">8.优化服务器的读/写速度和RAM，而不是CPU速度</h2><p id="0f9d" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">一般来说，如果您只是执行天气模型数据的基本转换和简单的分析或查询，那么您将受到在磁盘上读/写数据和将大型栅格文件加载到RAM中的能力的限制，而您的CPU大部分时间都处于空闲状态。你肯定应该使用固态硬盘。如果你正在做大量的光栅文件重投影，CPU将会更重要。如果你要存储全球天气模型或者一些更高级的模型(比如NAM或者HRRR ),你需要几兆字节的硬盘空间。</p><h2 id="d445" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">9.“表面”高度完全取决于模型的分辨率</h2><p id="4d52" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">在不同空间分辨率的模型之间比较表面上的两个值(例如温度)是不公平的比较，尤其是在崎岖的地形中。每个模型都有一个基本的DEM，通常可以从“分析”预测小时(也就是零)中提取。例如，根据相应的索引文件，此数据在<code class="fe ls lt lu lv b">fh00</code> / analysis的NAM模型中可用:</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/297e4edd284fb2c139cc3bbdb1d1a531.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*SvDkb-iQIrWsBZ_J6rzMQg.png"/></div></figure><h2 id="653b" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">10.索引文件可能会将两个变量视为同一字节范围的一部分</h2><p id="ff4a" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">你可能会在风的<code class="fe ls lt lu lv b">ugrd</code>和<code class="fe ls lt lu lv b">vgrd</code>分量中遇到这种情况。</p><figure class="lx ly lz ma gt is gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/82fafc4f5ceaf13743362b63a8554cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*OIIqiQy_HrUoGkkx3h89mQ.png"/></div></figure><p id="f65d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您只能同时获得这两个变量，这意味着如果您的检索/处理脚本完全依赖于索引文件中每一行的一个变量，事情将会出错。当您检索这个字节范围时，您将得到一个双波段栅格，第一个波段属于<code class="fe ls lt lu lv b">ugrd</code>，第二个属于<code class="fe ls lt lu lv b">vgrd</code>。</p><h2 id="e269" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">11.有些模型的投影经度范围为0到360度</h2><p id="ea6c" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">这似乎是全球通用的模式，如GFS和GEFS。当你开始使用这个投影时，奇怪的事情会发生。在处理这些数据之前，您可能想用<code class="fe ls lt lu lv b">--config CENTER_LONG 0</code>(或者Python绑定中的<code class="fe ls lt lu lv b">config=["CENTER_LONG 0"]</code>)调用<code class="fe ls lt lu lv b">gdalwarp</code>。</p></div></div>    
</body>
</html>