<html>
<head>
<title>Pandas Groupby vs SQL Group By</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pandas Groupby vs SQL Group By</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-groupby-vs-sql-group-by-39ccd7d2b779?source=collection_archive---------20-----------------------#2020-10-28">https://towardsdatascience.com/pandas-groupby-vs-sql-group-by-39ccd7d2b779?source=collection_archive---------20-----------------------#2020-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="892d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">举例说明</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fb756e620fbd3436300d93d5adcabb65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mh8tWujATNawO_6x.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·斯皮斯克在<a class="ae ky" href="https://unsplash.com/s/photos/different-colors?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="dbd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas是Python的一个数据分析和操作库。SQL是大多数关系数据库管理系统(RDBMS)用来管理数据库的编程语言。它们的共同点是Pandas和SQL都操作表格数据(即表格由行和列组成)。</p><p id="5ca4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然有不同的语法，但类似的操作或查询可以使用Pandas或SQL来完成。典型数据分析过程中最常见的操作之一是根据数字特征比较类别。两者在执行此类任务时效率都很高。</p><p id="6a70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本帖中，我们将做很多例子来掌握这些操作是如何用熊猫的<strong class="lb iu"> groupby </strong>函数和SQL的<strong class="lb iu"> GROUP BY </strong>语句完成的。</p><p id="6eb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图说明了“groupby”操作背后的逻辑。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl lv"><img src="../Images/bf4582b1ebe89261d64b63fb400323e7.png" data-original-src="https://miro.medium.com/v2/format:webp/0*DZ2msoVAFep3O73e.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Groupby操作(图片由作者提供)</p></figure><p id="535b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用Kaggle上提供的<a class="ae ky" href="https://www.kaggle.com/shubh0799/churn-modelling" rel="noopener ugc nofollow" target="_blank">客户流失数据集</a>。对于熊猫，数据集存储在“变动”数据帧中。对于SQL，数据在“变动”表中。</p><p id="7f37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是数据集的快照。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/0db73d217c4a621ad5e906abbf4a8552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nt9S8HU1ZciPXN_xXXkoGQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="ea89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一些功能可以提供关于客户及其银行账户的信息。“已离开”栏显示客户是否离开银行。</p><p id="7d27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将定义一些有助于我们探索数据集的度量，并使用Pandas和SQL来计算它们。</p><p id="c327" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧。</p><h1 id="3656" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated"><strong class="ak">基于国家/地区的流失率</strong></h1><p id="e55f" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">这将有助于我们了解不同国家的流失率是否存在差异。将exited列按geography列分组并取平均值将得到结果。</p><p id="f7c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">熊猫</strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="b2c6" class="mz ly it mv b gy na nb l nc nd">churn[['Geography','Exited']].groupby('Geography').mean()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/3470b9db71afeb6b1e6f70b026b6aa75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*rwiB9HTpUaO8GSK-qKDhAw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="4c8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> SQL </strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="58f7" class="mz ly it mv b gy na nb l nc nd">SELECT Geography, AVG(Exited)<br/>FROM CHURN<br/>GROUP BY Geography;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/ecb1160d4bc2031a767767d5258b4b7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*TJ4TnTJFmqMiog3bDDhz8A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="7607" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主要的区别在于我们应用聚合函数的地方。SQL允许在选择列时直接应用函数，而在Pandas的groupby函数之后应用。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="0c2d" class="lx ly it bd lz ma nn mc md me no mg mh jz np ka mj kc nq kd ml kf nr kg mn mo bi translated">基于国家和性别的流失率</h1><p id="50c4" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">SQL和Pandas都允许基于多个列进行分组，这可以提供更多的洞察力。例如，我们可能想要检查性别如何影响不同国家的客户流失。</p><p id="fa65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先按性别对平均流失率进行分组，然后按国家分组。</p><p id="5cd1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">熊猫</strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="b261" class="mz ly it mv b gy na nb l nc nd">churn[['Gender','Geography','Exited']]\<br/>.groupby(['Gender','Geography']).mean()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/3428f7ceb05aaacd258abf39992d1866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*nrZ458q6O9n9GuOXvYkXOA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="160b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> SQL </strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="9c77" class="mz ly it mv b gy na nb l nc nd">SELECT Gender, Geography, AVG(Exited)<br/>FROM CHURN<br/>GROUP BY Gender, Geography<br/>ORDER BY Gender, Geography;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/0b7c82304b715c5f94d4e5bc0404b616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*eLGijMwPWMlpygFTLrFW4Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="f8b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我添加了ORDER BY子句来匹配Pandas返回的顺序，并使它看起来更有结构。</p><p id="5444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Pandas和SQL，分组中列的顺序对结果帧的结构很重要。这些值不会改变。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="82fd" class="lx ly it bd lz ma nn mc md me no mg mh jz np ka mj kc nq kd ml kf nr kg mn mo bi translated">每个国家的平均余额和客户总数</h1><p id="eede" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">Pandas和SQL都提供了对不同的列应用不同的聚合函数的方法。例如，我们可能想要检查每个国家的平均余额和客户总数。</p><p id="7135" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是怎么做的。</p><p id="48ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">熊猫</strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1966" class="mz ly it mv b gy na nb l nc nd">churn[['Geography','Balance','Exited']].groupby(['Geography'])\<br/>.agg({'Balance':'mean', 'Exited':'sum'})</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/c517b0d88c8c4736e53e0549e5b8b3a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*BrTuSspnoWfrpNRAPg3f8A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="7bac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们向agg (aggregate)函数传递一个字典，指定哪个函数应用于哪个列。</p><p id="b0b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> SQL </strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="b557" class="mz ly it mv b gy na nb l nc nd">SELECT Geography, AVG(Balance), SUM(Exited)<br/>FROM CHURN<br/>GROUP BY Geography;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/fee54b1e963133ea9358a59cc38a5338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*1EbjFQWw49Suh5hJJSdEqA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="ff45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用SQL很简单，因为它允许我们在选择列时指定函数。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="1ce6" class="lx ly it bd lz ma nn mc md me no mg mh jz np ka mj kc nq kd ml kf nr kg mn mo bi translated"><strong class="ak">基于产品数量的平均和总流失率</strong></h1><p id="db0c" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">我们可以在同一个数字列上应用多个聚合函数。如果类别之间不平衡，建议同时检查平均值和计数。在这种情况下，只检查平均值可能会产生误导。</p><p id="648e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看产品数量和客户流失之间的关系。我们将计算平均流失率和流失客户总数。</p><p id="24b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">熊猫</strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="18a3" class="mz ly it mv b gy na nb l nc nd">churn[['NumOfProducts','Exited']]\<br/>.groupby('NumOfProducts').agg(['mean','count'])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/0991251e313a36e61da2160cc5d79026.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*E1t6KL1g1BOH1SBWlANsdg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="837f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为只有一个数值列，所以我们不必向agg函数传递字典。我们将只使用函数列表。</p><p id="0454" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> SQL </strong></p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="244b" class="mz ly it mv b gy na nb l nc nd">SELECT NumOfProducts, AVG(Exited), COUNT(Exited)<br/>FROM CHURN<br/>GROUP BY NumOfProducts;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/6e5df5ae1cd96a8223927d6aab2e355d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*_njRev-rX9r3NIbtyTAOxQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="7cd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅仅检查平均值会产生误导，因为拥有2件以上产品的客户数量远远少于拥有1件或2件产品的客户数量。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="9b7c" class="lx ly it bd lz ma nn mc md me no mg mh jz np ka mj kc nq kd ml kf nr kg mn mo bi translated"><strong class="ak">结果排序怎么样？</strong></h1><p id="ee75" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">分组的目标是根据计算出的数值列找到具有高值或低值的类别。因此，排序是分组操作的一个重要部分。</p><p id="7c99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQL和熊猫在排序上都很灵活。我们可以根据任何计算值和任何顺序进行排序。</p><p id="bff1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑前面的查询，我们根据产品数量检查客户流失。</p><p id="bf43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们对结果进行排序。</p><p id="b774" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">熊猫</p><p id="18ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以使用sort_values函数。我们通常只传递其值将用于排序的列的名称。但是，如果使用多个聚合函数，我们需要传递一个指示列索引的元组。</p><p id="75d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下代码将根据平均流失率(Exited，mean)对结果进行排序。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1075" class="mz ly it mv b gy na nb l nc nd">churn[['NumOfProducts','Exited']]\<br/>.groupby('NumOfProducts').agg(['mean','count'])\<br/>.sort_values(by=('Exited','mean'))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/303fa51ec601e429521edfc7591ea1a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*29wbCs9WKzZJQe3J2Yuc1Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="2205" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> SQL </strong></p><p id="65c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只需要在末尾添加一个ORDER BY子句。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="5dbe" class="mz ly it mv b gy na nb l nc nd">SELECT NumOfProducts, AVG(Exited), COUNT(Exited)<br/>FROM CHURN<br/>GROUP BY NumOfProducts<br/>ORDER BY AVG(Exited);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/6999129de527ef94af9dceca47c413e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*j7ENf3HVs1aT-xyJAXfDRQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="b141" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，Pandas和SQL都按升序对值进行排序。为了按降序排序，只需修改代码如下:</p><ul class=""><li id="139d" class="nz oa it lb b lc ld lf lg li ob lm oc lq od lu oe of og oh bi translated">熊猫:<code class="fe oi oj ok mv b">sort_values(by=(‘Exited’,’mean’), ascending=False)</code></li><li id="13ef" class="nz oa it lb b lc ol lf om li on lm oo lq op lu oe of og oh bi translated">SQL: <code class="fe oi oj ok mv b">ORDER BY AVG(Exited) DESC;</code></li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="5122" class="lx ly it bd lz ma nn mc md me no mg mh jz np ka mj kc nq kd ml kf nr kg mn mo bi translated"><strong class="ak">结论</strong></h1><p id="9549" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">正如我们在示例中看到的，Pandas和SQL的分组背后的逻辑非常相似。一旦你熟悉了其中的一种，学习另一种就相当容易了。这只是一个语法问题。</p><p id="b17b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你正在从事或者打算从事数据科学领域的工作，我强烈推荐你学习熊猫和SQL。</p><p id="f803" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。如果您有任何反馈，请告诉我。</p></div></div>    
</body>
</html>