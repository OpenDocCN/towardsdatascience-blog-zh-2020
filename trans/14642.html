<html>
<head>
<title>Building Kriging Models in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在R中构建克里金模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-kriging-models-in-r-b94d7c9750d8?source=collection_archive---------17-----------------------#2020-10-09">https://towardsdatascience.com/building-kriging-models-in-r-b94d7c9750d8?source=collection_archive---------17-----------------------#2020-10-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1bb5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用空间统计算法进行空间预测</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aa4430185c07ce2c53e345818551cda1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nMl6hFu-YboUDBl-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">西蒙·米加吉在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="2962" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="ab95" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在当今世界，我们可以访问大量地理标记数据。我们能够以各种方式利用这些信息，创造新的信息，从而做出更好的决策，而不是将它们存放在数据库或文本文件中。</p><p id="85c3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">空间统计模型的优势之一是能够通过计算邻近点和感兴趣点之间的相关性来分析空间中的任何点。有许多空间模型可以使用，但我最喜欢的是克里金法。虽然地理加权回归(GWR)或反距离加权(IDW)等其他方法可能是有用的探索工具，但根据我的经验，克里金法往往会随着数据的增加而扩展得更好，并且在许多情况下，可以做出更准确的预测。</p><p id="e22a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本文中，我将展示如何使用R中的克里金法进行预测，并使用芝加哥市警察局的数据(在此处找到数据<a class="ae kv" href="https://data.cityofchicago.org/Public-Safety/Police-Stations/z8bn-74gv" rel="noopener ugc nofollow" target="_blank"/>)提供<strong class="lq ir">提示&amp;技巧</strong>。目标是对芝加哥市任一给定点的犯罪频率进行插值。这种空间统计技术允许我们利用现有的数据，构建一个模型来解释该区域的空间结构，并基于该空间结构对空间中任何其他纬度/经度点进行预测。</p><h1 id="71ae" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">数据准备</h1><p id="0590" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在我们开始之前，我想讨论一下数据集，这样我们就能理解预测的是什么。数据可以在<a class="ae kv" href="https://data.cityofchicago.org/Public-Safety/Police-Stations/z8bn-74gv" rel="noopener ugc nofollow" target="_blank">这里找到</a>，我将csv文件下载到我的本地驱动器上。该文件有22个变量和超过700万行，但对于本教程，我们将只利用坐标点(<em class="mp">纬度</em>和<em class="mp">经度</em>)、犯罪的<em class="mp">主要类型</em>和犯罪的<em class="mp">描述</em>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/71cffb06df87fd22e268b1dc1612013f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uWb3y-N2e9IBWKj2"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Nikola Johnny Mirkovic 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="bc00" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">【Tips&amp;Tricks】</strong>重要的是克里格只有特定类别类型的值。这意味着我们一次只能为一种犯罪类型插入点，否则插入的点没有任何意义。因此，我们将重点关注的特定犯罪是<em class="mp">对车辆的刑事损坏</em>，我们将使用克里金法来插值芝加哥市此类犯罪的频率。</p><h2 id="60ee" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">数据准备的r代码:</h2><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="6315" class="mr kx iq ne b gy ni nj l nk nl">library(data.table)# fast read/write function<br/>library(dplyr)</span><span id="c0c4" class="mr kx iq ne b gy nm nj l nk nl">df_1 &lt;- reported_crimes %&gt;% filter(PrimaryType=='CRIMINAL DAMAGE') %&gt;% filter(Description=='TO VEHICLE')</span><span id="aa3f" class="mr kx iq ne b gy nm nj l nk nl">df_2 &lt;- df_1 %&gt;% <br/>  group_by(Latitude, Longitude) %&gt;% <br/>  count() %&gt;% <br/>  ungroup() %&gt;% <br/>  inner_join(df_1, by=c('Latitude', 'Longitude')) %&gt;% <br/>  distinct(Latitude, Longitude, .keep_all = TRUE) %&gt;%<br/>  select(Latitude, Longitude, n) %&gt;%<br/>  mutate(location_id = group_indices(., Latitude, Longitude))</span></pre><p id="b378" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦我们过滤了数据，在每个唯一的位置(<em class="mp">纬度</em>和<em class="mp">经度</em>)计算犯罪的频率(变量名为<em class="mp"> n </em>，并为每个唯一的位置添加一个索引(<em class="mp"> location_id) </em>，数据将类似于图1。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/2368b347ce2c8abfc619d445ae1bcd69.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*EcgT03DZcQMFd0T-Ak8Etg.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1:前10行准备好的数据(图片由作者提供)</p></figure><p id="10b3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">克里金法背后的思想是使用一组有限的数据点来预测给定区域中的其他邻近点。这种方法允许该领域的科学家只对少量数据点进行采样，并对其余数据点进行插值，从而节省了时间和金钱。因此，为了模拟这种方法，我们可以随机选取10，000个点作为训练集来构建模型(如图2(a)所示)。</p><h2 id="f42e" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated"><strong class="ak">用于创建训练集的R代码:</strong></h2><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="4aac" class="mr kx iq ne b gy ni nj l nk nl">random_generator &lt;- sample(1:nrow(df_2), round(nrow(df_2)*.3), replace=F)</span><span id="5503" class="mr kx iq ne b gy nm nj l nk nl">train_df &lt;- df_2 %&gt;%<br/>  filter(!location_id %in% random_generator) %&gt;% <br/>  slice(1:10000)</span></pre><p id="5640" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，我们可以在感兴趣区域周围的点网格上使用该模型，如图2(b)所示。点网格是通过构建一个多边形并在该多边形内创建超过76，000个纬度/经度点自动生成的(为简洁起见，本文不包含该代码)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/ac27092371920a3370300fa90d22509a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zWtE3VhZCQnjxzhut-GiuQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2:训练与网格(图片由作者提供)</p></figure><h1 id="084c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">构建变异函数</strong></h1><p id="36b9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">准备好数据后，第一步是构建变异函数并对其拟合曲线函数，该函数可用于对点格网的值进行插值。幸运的是，有了R中的gstat包，这可以使用变差函数轻松完成。</p><h2 id="b8c7" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated"><strong class="ak">建立变差函数模型的R代码:</strong></h2><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="630b" class="mr kx iq ne b gy ni nj l nk nl">coordinates(train_df) &lt;- c("Longitude", "Latitude")<br/>proj4string(train_df) &lt;- CRS("+proj=longlat +datum=WGS84")</span><span id="0f60" class="mr kx iq ne b gy nm nj l nk nl">lzn.vgm &lt;- variogram(log(n) ~ Latitude + Longitude, train_df, width=0.1)</span><span id="d130" class="mr kx iq ne b gy nm nj l nk nl">lzn.fit = fit.variogram(lzn.vgm, vgm(c("Gau", "Sph", "Mat", "Exp")), fit.kappa = TRUE)</span></pre><p id="764b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">【T21技巧】</strong>log函数用于确保所有插值保持正值。exp函数将用于归一化本文“克里格”部分的结果。</p><p id="80f7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">可以绘制变差函数和曲线函数来了解我们区域的空间结构，如图3所示。直观的说，我们可以看到曲线函数(Matern)可以比较好的描述点之间的自相关性。我们可以看到，在1.1 km左右，点对不再具有空间相关性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/7a243510664c1a2147b64147f5174d7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ewS5LsMabBg53NvCJzt_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图3:变异函数模型(图片由作者提供)</p></figure><h1 id="62ac" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">让我们克里格</h1><p id="d1a8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，我们可以使用gstat包中的克里格函数使用这些信息来克里格点格网。如前所述，点的网格已经生成，为了简洁起见，本文不再赘述。但是，数据中未包含在训练集中的任何其他点都可以用于插值点和测试精度。</p><h2 id="6df1" class="mr kx iq bd ky ms mt dn lc mu mv dp lg lx mw mx li mb my mz lk mf na nb lm nc bi translated">克里金法的r代码:</h2><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="79e5" class="mr kx iq ne b gy ni nj l nk nl">coordinates(grid) &lt;- c("Longitude", "Latitude")<br/>proj4string(grid) &lt;- CRS("+proj=longlat +datum=WGS84")</span><span id="b4c4" class="mr kx iq ne b gy nm nj l nk nl">lzn.kriged &lt;-krige(log(n) ~ Latitude + Longitude, train_df, grid, model = lzn.fit, maxdist=10, nmax=50)</span><span id="5c28" class="mr kx iq ne b gy nm nj l nk nl"># Retrieve interpolated values<br/>predicted &lt;- lzn.kriged@data$var1.pred %&gt;%<br/>  as.data.frame() %&gt;%<br/>  rename(krige_pred = 1) %&gt;% <br/>  mutate(krige= exp(krige))</span><span id="6433" class="mr kx iq ne b gy nm nj l nk nl">variance &lt;- lzn.kriged@data$var1.var %&gt;%<br/>  as.data.frame() %&gt;%<br/>  mutate(variance = exp(variance))</span></pre><p id="3d37" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">图4(a)显示了用于构建模型的点，并放大到芝加哥住宅区以便更好地查看数据点。一旦应用了代码并对网格点进行了克里格处理，我们就可以看到图4(b)中所示的预测。显示的是模型计算出对车辆的<em class="mp">犯罪损害的最高频率的热点，以及该犯罪发生频率可能较低的区域。克里金法填补了我们没有的数据空白。虽然在图4(a)中我们可能有许多数据点可供选择，但并没有涵盖该区域的每个点。对于所有这些我们没有的点，克里金法开始发挥作用并填充空洞，从而增加区域的覆盖范围，如图4(b)所示。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/2e457328b2b7e1206a011dfa7617f374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wzV63zRhyi3SqeTwblBydg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图4:芝加哥住宅区的预测点(图片由作者提供)</p></figure><h1 id="168b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="3664" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">由<a class="ae kv" href="https://www.esri.com/arcgis-blog/products/product/analytics/the-power-of-where-how-spatial-analysis-leads-to-insight/" rel="noopener ugc nofollow" target="_blank"> Esri </a>雄辩地陈述，</p><blockquote class="nr ns nt"><p id="fe20" class="lo lp mp lq b lr mk jr lt lu ml ju lw nu mm lz ma nv mn md me nw mo mh mi mj ij bi translated">空间分析使您能够解决复杂的定位问题，并更好地了解您的世界中正在发生的位置和事件。它不仅仅是绘制地图，还能让你研究地方的特征以及它们之间的关系。空间分析为您的决策提供了新的视角。</p></blockquote><p id="3861" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在空间上理解我们的数据是进行预测的重要一步。这也是我喜欢克里金法的原因之一。当我们构建变差函数时(如图3所示)，很清楚点之间的自相关何时停止，这告诉我们在什么距离上数据不再相关。然后利用变差函数对新数据进行插值。</p><p id="f98a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">虽然视觉效果总是令人兴奋，但在现实世界中实施之前，测试模型的准确性是至关重要的。虽然本文中没有讨论，但是我们使用训练/测试分割方法对数据(14%训练和86%测试)进行了测试，以测量模型的准确性，RMSE为1.81，MAE为0.80。</p><p id="c6fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">有了空间统计，我们可以凭直觉判断数据的空间相关性，并通过数学方法精确计算相关性的终点。我希望这篇文章能帮助您集思广益，找出其他哪些数据集可能是空间相关的，以及克里金法如何帮助您更好地理解它！</p></div></div>    
</body>
</html>