<html>
<head>
<title>Host Your Own Offline Mapping Server with Jupyter Notebook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jupyter笔记本托管您自己的离线地图服务器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/host-your-own-offline-mapping-server-with-jupyter-notebook-ff21b878b4d7?source=collection_archive---------13-----------------------#2020-10-29">https://towardsdatascience.com/host-your-own-offline-mapping-server-with-jupyter-notebook-ff21b878b4d7?source=collection_archive---------13-----------------------#2020-10-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="7a7e" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="17c9" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在本地服务器上部署底图服务器的分步指南——整个项目可在我的<a class="ae kr" href="https://github.com/incubated-geek-cc/offline-mapping-server/blob/master/Host%20Your%20Own%20Offline%20Mapping%20Server.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中找到</h2></div><h1 id="1fa1" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated"><strong class="ak">概述</strong></h1><p id="1441" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated"><a class="ae kr" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank"> LeafletJS </a>，<a class="ae kr" href="https://www.mapbox.com/" rel="noopener ugc nofollow" target="_blank"> MapBox </a>，<a class="ae kr" href="https://www.esri.com/" rel="noopener ugc nofollow" target="_blank"> Esri </a>等。这些只是一些地图插件，分析师，开发者等。需要各种地理空间可视化的人倾向于使用。不用说，所有这些插件都有一些共同点-它们都需要底图服务来实现有意义的交互。得益于许多开源地图服务，如<a class="ae kr" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"> OpenStreetMap(OSM) </a>，解析地图服务url进行渲染几乎不费吹灰之力:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者代码片段|使用LeafletJS初始化底图的简单示例</p></figure><h1 id="1735" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">托管离线底图的基本原理</h1><p id="451c" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">然而，当应用程序由于不可预见的情况(如缺少WiFi、互联网连接故障、底图服务不再可用等)而无法连接到地图服务时，这种简单的可访问性可能会适得其反。作为一项预防措施，考虑在本地服务器上本地托管自己的底图总是比较明智的，尤其是在需要演示或在工作中使用应用程序的时候。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/674941e29c96eeac0ea1225981e26430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rjd1gCZBdXWBszhPbVYwhQ.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|本地托管底图示例</p></figure><p id="e050" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">虽然有几种方法可以做到这一点，我的首选是利用小叶的mbtiles插件称为<a class="ae kr" href="https://gitlab.com/IvanSanchez/Leaflet.TileLayer.MBTiles" rel="noopener ugc nofollow" target="_blank">小叶。这需要一些准备步骤，我将在下面介绍。这包括一点计算、一个本地web服务器、实用python包</a><a class="ae kr" href="https://github.com/mapbox/mbutil" rel="noopener ugc nofollow" target="_blank"> mbutil </a>和基础leafletJS库(因为选择mbtiles插件意味着与leafletJS集成)。</p><h1 id="0c0d" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">步骤1:在线搜索预先存在的底图服务并进行选择</h1><p id="d6a4" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">首先，决定离线托管的特定底图。一个好的起点是http://maps.stamen.com/，那里有大量可供公众使用的底图。此外，决定托管哪个底图有助于清楚地了解每个地图切片的url格式<strong class="lm jd"> (KIV:这一点极其重要，我们将在后面看到。)</strong>。为了进行演示，我将选择MapStamen的碳粉底图。确定想要托管的底图类型后，继续:</p><ol class=""><li id="c2f6" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ni nj nk nl bi translated">缩放至所需的最小缩放级别，例如<code class="fe nm nn no np b">11</code>，并确保当前浏览器视窗当前正在捕获<strong class="lm jd">所有正在渲染<strong class="lm jd">地区/省份/国家/大陆</strong>的</strong>地图图块图像。例如，假设我的目标是托管国家新加坡的底图，我的浏览器应该如下所示:</li></ol><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nq"><img src="../Images/9cd2fa6e60f7828ec35a6e360e45fb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6f_6bmBOQCbzi7rbRQhPZA.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|展示缩放级别为11的<a class="ae kr" href="http://maps.stamen.com/" rel="noopener ugc nofollow" target="_blank">maps.stamen.com</a>墨粉底图</p></figure><p id="ece9" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">2.右键单击并选择“检查”或Ctrl+Shift+i(在Windows上)</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nr"><img src="../Images/32bf8060f5618e50eea13f480e806ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d6R3vrJ8B4jFeF_rpqTCmA.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片| Google Chrome浏览器中的开发者工具截图|请注意，底图的每个切片图像中都嵌入了“src”属性</p></figure><p id="6f2b" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">虽然不同的浏览器有不同的配置，但两个基本组件是:</p><p id="67fa" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">1.浏览器<strong class="lm jd">控制台</strong></p><p id="25f6" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">2.<strong class="lm jd">元素</strong>选项卡查看html标记。</p><p id="56df" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">从呈现的每个地图区块图像的<code class="fe nm nn no np b">src</code>属性的格式来看，它遵循传统的<a class="ae kr" href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames" rel="noopener ugc nofollow" target="_blank">滑动地图</a>格式，其中URL包含<code class="fe nm nn no np b">{s}-{z}/{x}/{y}</code>:</p><ul class=""><li id="abc3" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated"><code class="fe nm nn no np b">z</code>:缩放级别</li><li id="9746" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><code class="fe nm nn no np b">x</code>:平铺图像的X坐标，以像素为单位</li><li id="5efa" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><code class="fe nm nn no np b">y</code>:平铺图像的Y坐标，单位为像素</li><li id="3c08" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><code class="fe nm nn no np b">s</code>:指子域。由于大量使用地图服务，子域<code class="fe nm nn no np b">a</code>、<code class="fe nm nn no np b">b</code>、<code class="fe nm nn no np b">c</code>配置到位。</li></ul><p id="c0dd" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">将以下JavaScript代码片段复制并粘贴到控制台中:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="418a" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">输出应该类似于以下内容:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ny"><img src="../Images/e42982f682409d519e2f3e48330c6f97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ikE3C5V8jpPqjSJ52mTszA.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|运行JavaScript代码片段后，从缩放级别为11的底图的每个<strong class="bd nz"> &lt; img / &gt; </strong>标记的图像<code class="fe nm nn no np b"><strong class="bd nz">src</strong></code> <strong class="bd nz"> </strong>属性中检索所有x，y坐标</p></figure><p id="4976" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">说明</strong>:由于底图中渲染的每个地图分块的url格式遵循以下格式:<br/> <code class="fe nm nn no np b">http://c.tile.stamen.com/toner/11/1614/1016@2x.png</code>，通过使用标记<code class="fe nm nn no np b">/</code>对其进行定界并将其转换为数组，我们可以看到以下结果:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="1c3d" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">说明</strong>:最上面一列代表数组的索引。在这种情况下，在缩放级别<code class="fe nm nn no np b">11</code>:</p><ul class=""><li id="1d72" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated"><code class="fe nm nn no np b">x</code>可以在<code class="fe nm nn no np b">5</code>位置找到</li><li id="f7ae" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><code class="fe nm nn no np b">y</code>可以在<code class="fe nm nn no np b">6</code>位置找到</li></ul><p id="303b" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">maps.stamen中其他可能的底图选项包括:</p><ul class=""><li id="eaa9" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated">http://tile.stamen.com/toner/{z}/{x}/{y}.png(墨粉)</li><li id="45c8" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><a class="ae kr" href="http://tile.stamen.com/terrain/%7Bz%7D/%7Bx%7D/%7By%7D.jpg" rel="noopener ugc nofollow" target="_blank">http://tile.stamen.com/terrain/{z}/{x}/{y}.jpg</a>(特雷恩)</li><li id="0e9d" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated">http://tile.stamen.com/watercolor/{z}/{x}/{y}.jpg(水彩)</li></ul><h1 id="7538" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">第二步。导入python包并初始化纬度/经度或X/Y转换函数</h1><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated"><a class="ae kr" href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Lon..2Flat._to_tile_numbers_2" rel="noopener ugc nofollow" target="_blank"> Slippy_map_tilenames </a>处的代码段源代码|函数<code class="fe nm nn no np b">num2deg</code>根据缩放级别(<code class="fe nm nn no np b">zoom</code>参数)将<code class="fe nm nn no np b">x</code>和<code class="fe nm nn no np b">y</code>分别转换为<code class="fe nm nn no np b">latitude</code>和<code class="fe nm nn no np b">longitude</code>。</p></figure><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated"><a class="ae kr" href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Lon..2Flat._to_tile_numbers_2" rel="noopener ugc nofollow" target="_blank"> Slippy_map_tilenames </a>处的代码段源代码|函数<code class="fe nm nn no np b">deg2num</code>根据缩放级别(<code class="fe nm nn no np b">zoom</code>参数)将<code class="fe nm nn no np b">lat_deg</code>和<code class="fe nm nn no np b">lon_deg</code>分别转换为图块图像的<code class="fe nm nn no np b">x</code>和<code class="fe nm nn no np b">y</code></p></figure><h1 id="e3c9" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">2.1将所有图块坐标(x，y)转换成坐标(纬度，经度)以将所有标记组合成一个<a class="ae kr" href="https://tools.ietf.org/html/rfc7946#section-3.3" rel="noopener ugc nofollow" target="_blank"> GeoJSON特征集合</a>对象</h1><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者的代码片段|请注意，标记保存在一个文件(<strong class="ak"> output.geojson </strong>)中，4个变量—<strong class="ak">minx val</strong><strong class="ak">maxx val minYVal maxYVal</strong>在这里被初始化，用于后续计算</p></figure><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者的代码片段|输出将在后续计算中使用的前4个变量的值</p></figure><p id="8ef6" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">上面代码的输出是:</strong></p><p id="3cdc" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">minXVal的值为:1612<br/>maxx val的值为:1616<br/>miny val的值为:1015<br/>maxy val的值为:1018</p><h2 id="132f" class="oa kt it bd ku ob oc dn ky od oe dp lc lt of og le lx oh oi lg mb oj ok li iz bi translated">2.2使用output.geojson可视化地图标记</h2><p id="7734" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">将GeoJSON文件渲染到任何地图渲染平台上，以查看实际地图上的坐标。我个人推荐<a class="ae kr" href="http://geojson.io/" rel="noopener ugc nofollow" target="_blank">http://geojson.io/</a>，因为它有直观的界面和实用的功能。基于上述示例，从缩放级别<code class="fe nm nn no np b">11</code>的图块转换的坐标应如下所示:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/c96811d5eced9217c8dca2b4663573f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*glTgimw70oSJyyEXqHBw-A.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">图片作者|可视化<strong class="bd nz"> output.geojson </strong>数据文件|注意上图尺寸显示的是<strong class="bd nz"> 4 × 6地图标记</strong>，相当于<strong class="bd nz"> 4 × 6平铺</strong>。</p></figure><h1 id="db8f" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">第三步。计算其他缩放级别的(X，Y)值</h1><p id="9a37" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">在进行实际计算之前，重要的是要确定滑动贴图的图块坐标遵循以下规则:</p><p id="5838" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">瓷砖总数= 2ᶻᵒᵒᵐ × 2ᶻᵒᵒᵐ</p><p id="1510" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">例如，当缩放级别= <code class="fe nm nn no np b">11</code>时，底图具有2 × 2 = 2048 × 2048个切片</p><p id="ee28" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">根据地图上显示的标记，图块数量为:<strong class="lm jd"> 4 × 6图块</strong>，其中:</p><ul class=""><li id="3be8" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated"><strong class="lm jd">最小(x) </strong> = 1612 <br/> <strong class="lm jd">最大(x) </strong> = 1616</li><li id="50c2" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><strong class="lm jd">最小(y) </strong> = 1015 <br/> <strong class="lm jd">最大(y) </strong> = 1018</li></ul><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/35ac4388f5db0dde3f596849cd96b93b.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*sq2Dtorq_MHDRfqo9c4R9Q.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|底图缩放级别为11的切片尺寸| x范围为1612至1616(含)| y范围为1015至1018(含)</p></figure><p id="2454" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">因此，基于上述逻辑，对于缩放级别<code class="fe nm nn no np b">12</code>:</p><p id="e799" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">瓷砖总数=2 × 2 = 4096 × 4096</p><p id="7311" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">这转化为:(4/2048)×4096×(6/2048)×4096 tiles =<strong class="lm jd">8×12 tiles</strong>其中:</p><ul class=""><li id="983b" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated"><strong class="lm jd">min(x)</strong>= 1612/4×8 = 3224<br/><strong class="lm jd">max(x)</strong>= 1616/4×8 = 3232</li><li id="86f3" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated"><strong class="lm jd">最小(y)</strong>= 1015/6×12 = 2030<br/><strong class="lm jd">最大(y) </strong> = 1018/6 × 12 = 2036</li></ul><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/faebca4091f8d0164a647dcff0f19fb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*-3qTBET_3hKAY3jFeyzBuQ.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|底图缩放级别为12的切片尺寸| x范围从3224到3232(含)| y范围从2030到2036(含)</p></figure><h1 id="76c6" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">3.1上述等式有效的概念证明</h1><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者的代码片段| POC _ equation _ of _ zoom _ map _ tiles . py的代码片段生成了<strong class="ak"> output.json </strong>，其中包含一个切片URL列表|要测试计算是否合法，只需导航到几个链接以确保链接没有断开，预期结果应该是一个切片图像</p></figure><p id="14b5" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">根据上述计算的图示，现在可以计算和检索所需的所有底图切片图像。接下来，将根据Slippy地图规则建立文件夹层次结构，以包含本地保存的后续图块图像。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi on"><img src="../Images/b9c410c54e7972d62167cd00d0ebdfd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*PhcyuMLf5_dinIDBjTK0Fg.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片| http://maps.stamen.com/<a class="ae kr" href="http://maps.stamen.com/" rel="noopener ugc nofollow" target="_blank">浏览器后端截图</a>显示了存储图片的文件夹结构</p></figure><p id="b4ba" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">因此，从上面可以推断出地图切片图像存储在以下文件夹结构中:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oo"><img src="../Images/648e0e421e6b43e6a6c188dd73ec139d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JYZgXRPaJZ6tgDqHqXx3mg.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|要创建的切片图像的文件夹层次结构</p></figure><p id="90e0" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">下一节将尝试创建所需的文件夹层次结构。在执行此操作之前，应确定底图的缩放上限。通常，当用户需要查看街道级别的详细信息时，<code class="fe nm nn no np b">17</code>或<code class="fe nm nn no np b">18</code>是很好的选择。对于本教程，我将设置我的缩放水平上限，只是<code class="fe nm nn no np b">15</code>。</p><p id="d77a" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">早先，缩放级别11和12的区块尺寸都被导出。因此，在缩放级别<code class="fe nm nn no np b">n</code>，由于平铺数量= 2ᶻᵒᵒᵐ × 2ᶻᵒᵒᵐ，<br/>尺寸应为:(4×(2ⁿ)×(6×(2ⁿ)平铺</p><p id="a9fd" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">最小(x) </strong> = 1612/4 × 4(2ⁿ) <br/> <strong class="lm jd">最大(x) </strong> = 1616/4 × 4(2ⁿ)</p><p id="063b" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">min(y)</strong>= 1015/6×6(2ⁿ)<br/><strong class="lm jd">max(y)</strong>= 1018/6×6(2ⁿ)</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/d3a66d618e0f1cac78fe6ad9885714eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*w8-cmrwZJuTWlfnyfd9N9A.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|底图缩放级别n的切片尺寸| x范围从最小值(x)到最大值(x)(含)| y范围从最小值(y)到最大值(y)(含)</p></figure><p id="a5f0" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">为了减少重复代码，应创建一个应用上述逻辑的函数，以便在任何缩放级别检索图块的<code class="fe nm nn no np b">x</code>和<code class="fe nm nn no np b">y</code>坐标:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者代码片段|输出为:<strong class="ak">缩放级别为11到15的文件夹结构已创建。</strong></p></figure><h1 id="90b5" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">第四步。将切片图像流式传输到创建的本地文件夹中</h1><p id="72f8" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">初始化文件夹结构后，我们现在可以从底图服务中检索缩放级别在<code class="fe nm nn no np b">minZoomLevel</code>和<code class="fe nm nn no np b">maxZoomLevel</code>(含)范围内的切片图像。</p><h2 id="03ec" class="oa kt it bd ku ob oc dn ky od oe dp lc lt of og le lx oh oi lg mb oj ok li iz bi translated">需要注意的是:</h2><ol class=""><li id="f616" class="nd ne it lm b ln lo lq lr lt op lx oq mb or mf ni nj nk nl bi translated">如果指定的缩放级别上限很高，例如，高于缩放级别<code class="fe nm nn no np b">17</code>将显著增加运行代码的持续时间，则该步骤可能需要几个小时</li><li id="19d2" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ni nj nk nl bi translated">输出的切片图像将占用相当多的磁盘空间。通常，来自地图服务(如OpenStreetMap)的栅格切片(由单个国家的缩放级别<code class="fe nm nn no np b">11</code>到<code class="fe nm nn no np b">17</code>组成)大约占用500MB。</li><li id="ad43" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ni nj nk nl bi translated">如果托管的底图类型是卫星地图，由于卫星影像的高分辨率，最终输出通常会达到几GB，因此明智的做法是在将切片图像保存到本地磁盘驱动器之前确保有足够的可用磁盘空间。</li></ol><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">Author | Output的代码片段是:<strong class="ak">缩放级别为11到15的所有地图切片图像都已保存到本地目录中。</strong></p></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi os"><img src="../Images/d31adb17f019059a464eec0277b4fba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GtAs4yHut2V7LHk72XrYQ.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|所有图块图像保存到本地文件夹后，它应该与上面类似。基本上，这是上述所有步骤的总结。</p></figure><h1 id="a0d7" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">4.1在web服务器上托管文件夹，以确保切片图像保存成功</h1><p id="d8e2" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">最后，为了确保保存正确的切片图像，应设置一个web服务器，并直接从文件夹中调用底图(只有在确保底图正确渲染后才能进行打包)。</p><p id="fdc1" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">在本演示中，将使用库<code class="fe nm nn no np b">Flask</code>和<code class="fe nm nn no np b">werkzeug</code>直接在jupyter笔记本中设置一个web服务器来托管底图。</p><p id="7ace" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">先决条件</strong></p><ul class=""><li id="e3d7" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ns nj nk nl bi translated">包含基础传单库:<a class="ae kr" href="https://unpkg.com/leaflet@1.0.0/dist/leaflet.css" rel="noopener ugc nofollow" target="_blank">传单样式表</a>和<a class="ae kr" href="https://unpkg.com/leaflet@1.0.0/dist/leaflet-src.js" rel="noopener ugc nofollow" target="_blank">传单JS </a></li><li id="a3ac" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated">包括传单插件<a class="ae kr" href="http://ivansanchez.gitlab.io/Leaflet.TileLayer.MBTiles/Leaflet.TileLayer.MBTiles.js" rel="noopener ugc nofollow" target="_blank"> L.TileLayer.mbTiles插件</a>及其依赖关系<a class="ae kr" href="https://unpkg.com/sql.js@0.3.2/js/sql.js" rel="noopener ugc nofollow" target="_blank"> sql.js </a></li><li id="f349" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated">将步骤2生成的文件<code class="fe nm nn no np b">output.geojson</code>放入下面指定目录结构的<code class="fe nm nn no np b">static</code>文件夹中</li><li id="8156" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated">将图块图像文件夹如<strong class="lm jd">碳粉</strong>复制并粘贴到以下指定目录结构的<code class="fe nm nn no np b">static/maps</code>文件夹中</li><li id="cbef" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ns nj nk nl bi translated">保存一个空白的黑色图块，并将其重命名为<code class="fe nm nn no np b">error.png</code>。将其放入下面指定目录结构的<code class="fe nm nn no np b">static</code>文件夹中</li></ul><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/91c0bc9df67d2f43164edcdaf629e278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*OGKjy-k0-mozwcJrxyqHWg.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|代表整个文件夹结构，包括jupyter笔记本</p></figure><p id="c305" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">最后，继续在<code class="fe nm nn no np b">&lt;script&gt;&lt;/script&gt;</code>标记之间的<code class="fe nm nn no np b">index.html</code>中包含以下代码片段，以直接从文件夹渲染底图:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者的代码片段|上面的代码片段使用leafletJS初始化了一个新的地图对象|步骤2中生成的文件<strong class="ak"> output.geojson </strong>通过AJAX调用，并继续在底图的bbox中设置地图视图</p></figure><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者代码片段| Flask web应用程序的初始化。注意，已经创建了一个关闭web服务器的API。这个API是通过链接<a class="ae kr" href="http://localhost:9000/shutdown" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/shut down</a>访问的</p></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/22a4279b66565e43452d3b98338b3e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eosJF8FfrY-yPcmaQ4djmA.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|渲染的初始底图视图示例</p></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/c9cbfe2364007dda3ddc2cb2806574a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ABf0oL5ZKlZyQdg2KJJQSQ.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">按作者分类的图像|底图的放大视图</p></figure><h1 id="f50b" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">4.2用python包将文件夹打包— <code class="fe nm nn no np b">mbutil</code></h1><p id="2276" class="pw-post-body-paragraph lk ll it lm b ln lo kd lp lq lr kg ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">既然我们已经确保底图渲染了正确的切片图像，现在可以将文件夹打包到单个mbTile文件中。这是通过python包<a class="ae kr" href="https://pypi.org/project/mbutil/" rel="noopener ugc nofollow" target="_blank"> mbutil </a>完成的。要安装mbutil，我们需要严格遵循以下说明:</p><ol class=""><li id="b561" class="nd ne it lm b ln my lq mz lt nf lx ng mb nh mf ni nj nk nl bi translated">导航至<a class="ae kr" href="https://github.com/mapbox/mbutil" rel="noopener ugc nofollow" target="_blank"> mbutil </a></li><li id="0c6a" class="nd ne it lm b ln nt lq nu lt nv lx nw mb nx mf ni nj nk nl bi translated">继续克隆/下载git存储库，并将ZIP存档保存到jupyter笔记本所在的文件夹中</li></ol><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/327c7df8e2e16f01b919cf718cb1542a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*sKPYKjdg3YzvZXuHfCqcJQ.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|为mbutil选择“下载ZIP”</p></figure><p id="2681" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">3.提取文件夹<code class="fe nm nn no np b">mbutil-master</code>并重命名为<code class="fe nm nn no np b">mbutil</code>。</p><p id="5023" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">4.在mbutil文件夹中导航并<strong class="lm jd">删除</strong>文件<code class="fe nm nn no np b">.gitignore</code>。它现在应该是这样的:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/5ac18e935f03cba54314991a08a0d7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*BleMsHx9dyqDqKP8tMqy9A.png"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|显示mbutil python包的内容</p></figure><p id="8754" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">5.继续打开该文件夹中的终端/命令提示符并运行:<code class="fe nm nn no np b">python mb-util ../static/maps/toner ../static/maps/toner.mbtiles</code></p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ow"><img src="../Images/363e649edfe813e54d6c62dc432768c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kQ8RYSWaATN5lyN3QNKH4Q.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者图片|显示命令提示符，表明<code class="fe nm nn no np b">mbutil</code>的打包过程正在进行</p></figure><p id="c0e9" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">6.<code class="fe nm nn no np b">toner.mbtiles</code>现在已创建，最新的文件夹结构应该如下所示:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ox"><img src="../Images/20de2e4b02cdc2f212ff12fb957a4f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5MjYP1O-O87-9u7w6thAg.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">图片作者| ( <strong class="bd nz">左</strong>)上一个项目结构| ( <strong class="bd nz">右</strong>)当前项目结构</p></figure><p id="461d" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">7.因此，继续修改标签之间的<code class="fe nm nn no np b">index.html</code>中的代码片段，以渲染来自<code class="fe nm nn no np b">toner.mbtiles</code>文件的底图:</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者代码片段|上面的代码片段与前面的代码片段几乎相同，只是不是从<strong class="ak">static/maps/toner/{ z }/{ x }/{ y }渲染底图。png </strong>，底图现在由打包的mbtiles文件<strong class="ak">static/maps/toner . MB tiles</strong>渲染而成</p></figure><h1 id="e8b7" class="ks kt it bd ku kv kw kx ky kz la lb lc ki ld kj le kl lf km lg ko lh kp li lj bi translated">第五步。使用mbtile文件和传单重新运行web应用程序。TileLayer.MBTiles.js插件</h1><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ml mm l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">作者代码片段|重新初始化flask应用程序以渲染底图</p></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oy"><img src="../Images/548a6f9973faf1f857061cf2a5addb4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v3UckWfXPV5EbbPIiv5N-g.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">图片由作者提供|如上所述，所有切片地图图像的url均以二进制格式呈现，从<strong class="bd nz"> toner.mbtiles </strong>获取-本地底图现已成功打包到单个mbtiles文件中，并部署到本地服务器上以供使用。</p></figure><p id="5967" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">注意</strong>:您可以继续删除文件夹<code class="fe nm nn no np b">static/maps/toner</code>，只留下mbtiles文件供应用程序使用。</p><p id="ed74" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated"><strong class="lm jd">恭喜你！现在，您已经在本地服务器上渲染了底图。</strong></p><p id="a40a" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">请随意在我的<a class="ae kr" href="https://github.com/incubated-geek-cc/offline-mapping-server" rel="noopener ugc nofollow" target="_blank"> GitHub </a>分叉项目，并查看实际的<a class="ae kr" href="https://github.com/incubated-geek-cc/offline-mapping-server/blob/master/Host%20Your%20Own%20Offline%20Mapping%20Server.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>。</p><p id="bc0a" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">如果你对更多与地理空间相关的内容感兴趣，你可以在Medium上关注我，我很乐意分享更多我自己的作品或发现。</p><p id="2dd8" class="pw-post-body-paragraph lk ll it lm b ln my kd lp lq mz kg ls lt na lv lw lx nb lz ma mb nc md me mf im bi translated">希望你们觉得这有用，感谢阅读！</p><div class="oz pa gp gr pb pc"><a href="https://geek-cc.medium.com/membership" rel="noopener follow" target="_blank"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd jd gy z fp ph fr fs pi fu fw jc bi translated">通过我的推荐链接加入灵媒——李思欣·崔</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">获得李思欣·崔和其他作家在媒体上的所有帖子！😃您的会员费直接…</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">geek-cc.medium.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq mw pc"/></div></div></a></div></div></div>    
</body>
</html>