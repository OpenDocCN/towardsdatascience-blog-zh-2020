<html>
<head>
<title>Ultimate Pandas Guide — Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫终极指南——窗口功能</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ultimate-pandas-guide-window-functions-f527f64fd550?source=collection_archive---------25-----------------------#2020-09-30">https://towardsdatascience.com/ultimate-pandas-guide-window-functions-f527f64fd550?source=collection_archive---------25-----------------------#2020-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/91d6177a8ebb9400884aede1b8eb4a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*q-ILm1uS7tBzTbxNHso-dA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">劳拉·伍德伯里摄于<a class="ae jg" href="https://www.pexels.com/photo/panda-bear-on-green-grass-3608263/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a></p></figure><div class=""/><div class=""><h2 id="dc3a" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">掌握您对数据中的组的理解</h2></div><p id="ca2a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">窗口函数是一种有效的方法，可以更好地了解数据中的每条记录与其所属的组之间的关系。</p><p id="84f1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它们也是常见的数据科学面试问题，因此很好地理解它们是件好事。</p><p id="b1b0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我将对窗口函数以及如何在Pandas中实现它们进行直观的解释。</p><h1 id="52a7" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">了解窗口功能</h1><p id="8b7e" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在标准的“分组”中，我们将数据分成组，应用聚合，然后将每个结果合并到一个新表中。</p><p id="2906" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这有助于我们回答关于数据中群体特征的问题。</p><p id="30ac" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，如果我们有每月客户级别的销售数据，我们可以使用groupby来了解我们每月的总销售额:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mr"><img src="../Images/72db69163b77786a9daaceeba1abbc80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_1R9Xdg78WQXvLku5cypvA.png"/></div></div></figure><p id="5b1d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你对这个功能有点生疏，我建议你看看我在groupby函数上的帖子:</p><div class="is it gp gr iu mw"><a rel="noopener follow" target="_blank" href="/ultimate-pandas-guide-mastering-the-groupby-104306251739"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd jk gy z fp nb fr fs nc fu fw ji bi translated">熊猫终极指南——驾驭群体</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">数据分析中最常见的练习之一是将数据分组并执行聚合。</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk ja mw"/></div></div></a></div><p id="25d5" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们只关心月销售额，上面的输出是有用的。</p><p id="2fb8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是这个结果的缺点是，我们的信息现在分布在两个表中——第一个表给出销售明细，第二个表给出每个月的汇总信息。</p><p id="0f61" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">窗口函数通过将组级别的聚合返回到初始表来帮助我们弥合这一差距:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nl"><img src="../Images/c2858689943e72918c83f0581d1353c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yv3PA4qDO-RgGy3qM8DGSA.png"/></div></div></figure><p id="16c7" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果不清楚这为什么有用，让我们在输出中添加一个百分比列:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/5e7f2ed1ad8411c223c756aa2f3bdea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RdS_qQUz5JQnFmRJM_x1Zw.png"/></div></div></figure><p id="f2f0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们可以看到每个记录占每月总销售额的百分比。</p><p id="be54" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">窗口函数很有用，因为它帮助我们运行这些类型的计算，而不必执行任何单独的连接。</p><h1 id="ffb5" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">使用变换方法的pandas中的窗口函数</h1><p id="d76d" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">Pandas中窗口函数的语法非常简单，非常类似于我们在groupby聚合中使用的语法。</p><p id="d7cc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关键区别在于，要执行窗口功能，我们使用“transform”方法，而不是“agg”方法:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nn"><img src="../Images/95972c5635ec0ad7eb618d6906610950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mj5DGOAQlnCTWfERsloegQ.png"/></div></div></figure><p id="6e9d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">transform方法返回一个序列而不是一个数据帧，所以如果我们希望它成为原始数据帧的一部分，我们需要将它作为一列添加:</p><pre class="ms mt mu mv gt no np nq nr aw ns bi"><span id="d382" class="nt lv jj np b gy nu nv l nw nx">sales_data[“monthly_sales”] = sales_data.groupby(“month”).transform(<br/>sum)[“purchase_amount”]</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ny"><img src="../Images/62289142a8871b805f01349795379350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rsBGCErifhn8dGW4wjhpYA.png"/></div></div></figure><p id="783b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样！不算太坏。</p><p id="d16b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们再举一个例子。下面我们<strong class="la jk">按州对每笔交易进行排名</strong>:</p><pre class="ms mt mu mv gt no np nq nr aw ns bi"><span id="1044" class="nt lv jj np b gy nu nv l nw nx">sales_data['state_rank'] = sales_data.sort_values(by =                   'purchase_amount', ascending = False).groupby("state")<br/>.transform('rank', method = 'min')["purchase_amount"]</span></pre><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nz"><img src="../Images/97838086de1888f18665774c7644aceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*78beSV6GyFD2WrXYW1NuSQ.png"/></div></div></figure><p id="0e48" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意以下几点:</p><ol class=""><li id="d6af" class="oa ob jj la b lb lc le lf lh oc ll od lp oe lt of og oh oi bi translated">我们使用“sort_values”函数来确保我们按照购买金额的顺序进行排序。</li><li id="2dfc" class="oa ob jj la b lb oj le ok lh ol ll om lp on lt of og oh oi bi translated">我们将一个参数(“min”)传递给转换中的“method”参数。这是rank方法的一个参数，在执行时传递给它。</li><li id="e6d0" class="oa ob jj la b lb oj le ok lh ol ll om lp on lt of og oh oi bi translated">当我们想要返回组内的“顶部”值时，这种类型的分析往往很有用。例如，我们可以筛选每个州内前2笔交易的结果，然后将这些结果传递给覆盖每个州的销售代表。</li></ol><h1 id="53da" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">Pandas中的窗口函数与SQL</h1><p id="217a" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">对于那些有很强SQL背景的人来说，这个语法可能有点奇怪。</p><p id="2828" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在SQL中，我们通过从聚合开始执行窗口函数，然后将它应用于可选的“partition by”和“order by”之上:</p><pre class="ms mt mu mv gt no np nq nr aw ns bi"><span id="cd9a" class="nt lv jj np b gy nu nv l nw nx">select rank() over (partition by state order by purchase_amount desc)</span></pre><p id="bf97" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了帮助协调这两种方法，我将上面的Pandas代码的元素转换成它们的SQL等价物:</p><figure class="ms mt mu mv gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oo"><img src="../Images/1a1e5bf3d13db8d97a9875f1b362d8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qDwZtZ-5ASl2ODA3mZNuvg.png"/></div></div></figure><h1 id="c282" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">结束语</h1><p id="a546" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在Pandas中，窗口函数功能强大、高效，并且实现起来相当简单。</p><p id="8a6f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，值得注意的是,“transform”方法并不是执行基于位置的聚合的正确方法，比如对前5条记录的列值求和。为了解决这个问题，我们将在以后的文章中更深入地研究熊猫的“转变”和“扩展”功能。</p><div class="is it gp gr iu mw"><a rel="noopener follow" target="_blank" href="/ultimate-pandas-guide-time-series-window-functions-a5362b782f3e"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd jk gy z fp nb fr fs nc fu fw ji bi translated">终极熊猫指南:时间序列窗口函数</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">掌握时间序列分析的“移位”、“滚动”和“扩展”</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="op l nh ni nj nf nk ja mw"/></div></div></a></div><p id="33e1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！</p><figure class="ms mt mu mv gt iv"><div class="bz fp l di"><div class="oq or l"/></div></figure></div></div>    
</body>
</html>