<html>
<head>
<title>Cloud processing is now simpler and cheaper!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云处理现在更简单，更便宜！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9?source=collection_archive---------37-----------------------#2020-09-29">https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9?source=collection_archive---------37-----------------------#2020-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1148" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在云上运行/分发您的* <strong class="ak">现有* </strong>处理/训练代码的一种*非常简单*且*便宜*的方式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ed6be5827a6b7295335c42e78b00afa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8jVNipJ12pDvswai0Y8jA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="823e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这发生在我身上，我相信也发生在你和许多从事中小型项目的数据科学家身上:</p><p id="75d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您已经在自己的训练管道(预处理-&gt;训练-&gt;测试)上投入了很多，使用不同的参数在本地尝试了几次，看起来很棒。但是……你意识到你需要更多的RAM/CPU/GPU/GPU内存或者所有这些加在一起才能充分利用它吗？</p><p id="01f2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它的发生有很多原因——</p><ul class=""><li id="441b" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">您的本地设置花费了太多时间来进行培训</li><li id="bec6" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">您需要更大的批处理大小，并且它不适合您的本地GPU内存</li><li id="7c28" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">你想要<a class="ae mf" href="https://en.wikipedia.org/wiki/Hyperparameter_optimization" rel="noopener ugc nofollow" target="_blank">调整超参数</a>，所以需要很多训练</li><li id="c7fa" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">您希望将一些预处理步骤移到培训期间完成，例如，为了节省磁盘空间/加载时间，而CPU / RAM无法完成</li><li id="14e2" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi">…</li></ul><p id="491b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，<em class="mg">，</em>理论上，你已经拥有了你需要的一切，但是你只需要在一个更好的硬件上运行它……这在今天应该不是问题，不是吗？</p><h1 id="1e1c" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">现有解决方案</h1><p id="b68e" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">确实有很多解决方案，这里有一些相关的技术/平台/解决方案:</p><h2 id="13c2" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated"><strong class="ak">通用</strong></h2><ol class=""><li id="1267" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated"><a class="ae mf" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a> —“以编程方式创作、安排和监控工作流的平台”</li><li id="2d02" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://ray.io/" rel="noopener ugc nofollow" target="_blank">雷</a>——“快速简单的分布式计算”</li></ol><h2 id="dcb7" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated"><strong class="ak">云提供商AI解决方案</strong></h2><ol class=""><li id="0bb1" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated"><a class="ae mf" href="https://www.kubeflow.org/" rel="noopener ugc nofollow" target="_blank">kube flow</a>——“kubernetes的机器学习工具包”(<a class="ae mf" href="https://www.kubeflow.org/docs/pipelines/overview/pipelines-overview/" rel="noopener ugc nofollow" target="_blank"> pipelines </a>)</li><li id="5de5" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://cloud.google.com/ai-platform/" rel="noopener ugc nofollow" target="_blank"> GCP人工智能平台</a>——“一个平台来构建、部署和管理机器学习模型”(<a class="ae mf" href="https://cloud.google.com/ai-platform/training/docs/overview" rel="noopener ugc nofollow" target="_blank">训练</a>、<a class="ae mf" href="https://cloud.google.com/ai-platform/pipelines/docs" rel="noopener ugc nofollow" target="_blank">管道</a>、<a class="ae mf" href="https://cloud.google.com/ai-platform/training/docs/distributed-pytorch" rel="noopener ugc nofollow" target="_blank">分布式PyTorch </a>、分布式<a class="ae mf" href="https://cloud.google.com/ai-platform/training/docs/distributed-training-details" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>)</li><li id="b24d" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://azure.microsoft.com/en-us/services/machine-learning/" rel="noopener ugc nofollow" target="_blank"> Azure机器学习</a>——“企业级机器学习服务，更快地构建和部署模型”(<a class="ae mf" href="https://docs.microsoft.com/en-us/azure/machine-learning/how-to-set-up-training-targets" rel="noopener ugc nofollow" target="_blank">培训</a>)</li><li id="d2c6" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank"> AWS Sagemaker </a> —“面向每一个开发者和数据科学家的机器学习”(<a class="ae mf" href="https://docs.aws.amazon.com/sagemaker/latest/dg/how-it-works-training.html" rel="noopener ugc nofollow" target="_blank">培训</a>、<a class="ae mf" href="https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/using_pytorch.html#distributed-pytorch-training" rel="noopener ugc nofollow" target="_blank">分布式PyTorch </a>、<a class="ae mf" href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#distributed-training" rel="noopener ugc nofollow" target="_blank">分布式TensorFlow </a>)</li></ol><h2 id="d8b2" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">分布式培训框架</h2><ol class=""><li id="66d9" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated"><a class="ae mf" href="https://medium.com/distributed-computing-with-ray/faster-and-cheaper-pytorch-with-raysgd-a5a44d4fd220" rel="noopener">rays GD</a>——“分布式深度学习的轻量级库”，构建在Ray之上</li><li id="62f1" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://github.com/horovod/horovod" rel="noopener ugc nofollow" target="_blank">Horovod</a>——“分布式深度学习训练框架”</li></ol><h2 id="53af" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">张量流</h2><ol class=""><li id="e649" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated"><a class="ae mf" href="https://www.tensorflow.org/guide/distributed_training" rel="noopener ugc nofollow" target="_blank"> TensorFlow分布式培训文档</a></li><li id="7915" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://www.tensorflow.org/guide/keras/training_keras_models_on_cloud" rel="noopener ugc nofollow" target="_blank"> TensorFlow自己的GCP分布式GCP培训教程</a></li><li id="3e2f" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://www.kubeflow.org/docs/components/training/tftraining/" rel="noopener ugc nofollow" target="_blank"> TensorFlow培训(TFJob) </a>针对Kubernetes(kube flow的一部分)</li></ol><h2 id="6d2a" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated"><strong class="ak"> PyTorch </strong></h2><ol class=""><li id="cfd2" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated"><a class="ae mf" href="https://pytorch.org/tutorials/beginner/dist_overview.html" rel="noopener ugc nofollow" target="_blank"> PyTorch分发的培训文件</a></li><li id="790b" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://pytorch.org/tutorials/beginner/aws_distributed_training_tutorial.html" rel="noopener ugc nofollow" target="_blank"> PyTorch自己的AWS分布式培训教程</a></li><li id="217a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://github.com/pytorch/elastic/tree/master/kubernetes" rel="noopener ugc nofollow" target="_blank">Kubernetes的火炬控制器</a></li><li id="7ce5" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><a class="ae mf" href="https://aihub.cloud.google.com/u/0/p/products%2F59f96517-9a20-4d4d-916c-ff2d2affda6d" rel="noopener ugc nofollow" target="_blank">在CPU或GPU上运行分布式PyTorch培训(使用Kubeflow管道)</a></li></ol><p id="be93" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi">…</p><p id="f7c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所有现有解决方案的优缺点的比较值得一提(甚至是一系列)，我肯定我忘了提到许多其他的:)</p><p id="2f80" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是，我找不到一个可以让你运行我现有代码的工具，只需要很少或者不需要额外的编码，很便宜，也不需要很多之前的特定平台知识。我也只是想尝试拥有自己的开源项目，包括文档和完全自动化的测试和发布管道:)<br/>这就是我想出<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker" rel="noopener ugc nofollow" target="_blank"><em class="mg">simple-sagemaker</em></a>和这篇文章<em class="mg">的原因。</em></p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><h1 id="17a0" class="mh mi iq bd mj mk ob mm mn mo oc mq mr jw od jx mt jz oe ka mv kc of kd mx my bi translated">很简单-Sagemaker来拯救</h1><p id="7948" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated"><a class="ae mf" href="https://github.com/shiftan/simple_sagemaker" rel="noopener ugc nofollow" target="_blank"><em class="mg">Simple——sagemaker</em></a>允许您将现有的代码原封不动地放在云上运行，不需要或只需要很少的代码修改。</p><p id="256e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章的剩余部分展示了如何使用这个库进行通用处理。后续文章将展示如何将其用于更高级的案例，如PyTorch分布式培训等。</p><p id="bc6e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更全面的文档和例子可以在<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker" rel="noopener ugc nofollow" target="_blank"> github项目</a>上找到，还有一些<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker/tree/master/examples" rel="noopener ugc nofollow" target="_blank">更多例子</a>，包括这篇文章中所有例子的<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker/tree/master/examples/medium/intro" rel="noopener ugc nofollow" target="_blank">源代码。</a></p><h2 id="f036" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">要求</h2><ol class=""><li id="c472" class="lr ls iq kx b ky mz lb na le nq li nr lm ns lq nt lx ly lz bi translated">Python 3.6以上版本</li><li id="eabe" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">为boto3配置的AWS帐户+区域和凭证，如<a class="ae mf" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html" rel="noopener ugc nofollow" target="_blank"> Boto3文档</a>中所述</li></ol><h2 id="13f7" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">装置</h2><pre class="kg kh ki kj gt og oh oi oj aw ok bi"><span id="ed51" class="ne mi iq oh b gy ol om l on oo">pip install simple-sagemaker</span></pre><h2 id="0f44" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">运行shell命令</h2><p id="130d" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">现在，要让shell命令<code class="fe op oq or oh b">cat /proc/cpuinfo &amp;&amp; nvidia-smi</code>在单个<code class="fe op oq or oh b">ml.p3.2xlarge</code><strong class="kx ir"/><strong class="kx ir">实例</strong>上运行，只需运行下面的<code class="fe op oq or oh b">ssm</code>命令(关于<code class="fe op oq or oh b">ssm</code> CLI的文档在下面的<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker/tree/develop#cli" rel="noopener ugc nofollow" target="_blank">中给出):</a></p><pre class="kg kh ki kj gt og oh oi oj aw ok bi"><span id="26ab" class="ne mi iq oh b gy ol om l on oo">ssm shell -p ssm-ex -t ex1 -o ./out1 --it ml.p3.2xlarge --cmd_line "cat /proc/cpuinfo &amp;&amp; nvidia-smi"</span></pre><p id="5221" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦任务完成(几分钟)，输出日志就会下载到<code class="fe op oq or oh b">./out1</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="9904" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您可能猜到的那样，使用这个命令行，您会得到:</p><ol class=""><li id="9720" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated">选择一个用于运行代码的<a class="ae mf" href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md" rel="noopener ugc nofollow" target="_blank">预构建映像</a>(默认为Sagemaker的PyTorch框架映像)。</li><li id="da81" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">一个IAM角色(默认名称为<code class="fe op oq or oh b">SageMakerIAMRole_ssm-ex</code>)和<a class="ae mf" href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html#sagemaker-roles-amazonsagemakerfullaccess-policy" rel="noopener ugc nofollow" target="_blank">amazonseagemakerfullaccess</a>策略被自动创建用于运行任务。</li><li id="d34b" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">一个<code class="fe op oq or oh b">ml.p3.2xlarge</code> <strong class="kx ir"> spot </strong>实例为你启动，你只需为你使用它的时间付费！<br/>注意:这比执行时间稍长，因为它包括启动(如下载图像、代码、输入)和关闭(保存输出)等时间。</li><li id="d49c" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">在实例上执行shell命令。</li><li id="3c27" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">shell命令exist代码为0，因此它被认为已成功完成。</li><li id="2e2f" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">输出日志保存到CloudWatch，然后从CloudWatch下载到<code class="fe op oq or oh b">./out1 </code>文件夹。</li></ol><p id="a30e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">很酷的第一名，不是吗？</p><h2 id="64d7" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">分发Python代码</h2><p id="edfd" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">同样，在<strong class="kx ir">上运行下面的<code class="fe op oq or oh b">ssm_ex2.py</code>两个</strong><em class="mg">ml . p 3.2x large</em><strong class="kx ir"><em class="mg">spot</em>实例</strong>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="71ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">只需运行下面的<code class="fe op oq or oh b">ssm</code>命令:</p><pre class="kg kh ki kj gt og oh oi oj aw ok bi"><span id="54d8" class="ne mi iq oh b gy ol om l on oo">ssm run -p ssm-ex -t ex2 -e <!-- -->ssm_ex2<!-- -->.py -o ./out2 --it ml.p3.2xlarge --ic 2</span></pre><p id="3955" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">输出被保存到<code class="fe op oq or oh b">./out2</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="9b27" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可能已经猜到了，这里您还会得到以下内容:</p><ol class=""><li id="1f96" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated">本地python脚本被复制到S3上的一个专用路径(<code class="fe op oq or oh b">[Bucket name]/[Project name]/[Task name]/[Job Name]/source/sourcedir.tar.gz</code>)(更多细节<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker#data-maintenance-on-s3" rel="noopener ugc nofollow" target="_blank">在这里</a>)。</li><li id="4790" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">两个spot实例用S3桶中的代码启动。</li></ol><p id="ed57" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">很酷的#2，不是吗？</p><h1 id="bcbb" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">高水位流量</h1><p id="d7fc" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">这是一个代表高层次流程的图表:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/6a39be056a3503357c1ed0fe1a2d219c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TkhGU_tNx11zTd3F9-PWUA.png"/></div></div></figure><h1 id="35ff" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">一个功能全面的高级示例</h1><p id="dc64" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">现在是一个高级的和完全(嗯，几乎:)特色的版本，但实现起来很简单。注意:当我们定制图像时，需要docker引擎。</p><p id="d3d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该示例由两部分组成，每一部分都展示了一些特性。此外，这两个部分是“链式”的，这意味着第一个部分的输出是第二个部分的输入。</p><p id="26b8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了举例说明大多数功能，使用了以下目录结构:</p><pre class="kg kh ki kj gt og oh oi oj aw ok bi"><span id="bdfd" class="ne mi iq oh b gy ol om l on oo">.<br/>|-- code<br/>|   |-- internal_dependency<br/>|   |   `-- lib2.py<br/>|   |-- requirements.txt<br/>|   `-- ssm_ex3_worker.py<br/>|-- data<br/>|   |-- sample_data1.txt<br/>|   `-- sample_data2.txt<br/>`-- external_dependency<br/>    `-- lib1.py</span></pre><ol class=""><li id="4a2c" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated"><strong class="kx ir">代码</strong> —源代码文件夹</li></ol><ul class=""><li id="6abe" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">internal_dependency —源代码文件夹中的依赖项</li><li id="a2cb" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">requirements.txt — pip需求文件列出了在运行worker <br/> <code class="fe op oq or oh b">transformers==3.0.2</code>之前需要安装的包</li></ul><p id="999d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">2.<strong class="kx ir">数据</strong> —输入数据文件</p><p id="2ea5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.<strong class="kx ir">外部依赖</strong> —附加代码依赖</p><p id="b84a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用to任务，首先得到两个输入通道</p><h2 id="c2fc" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">第一项任务</h2><p id="367c" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">该任务获得两个输入通道:</p><ol class=""><li id="abfa" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated"><em class="mg">数据</em>通道——分布在两个实例之间的<code class="fe op oq or oh b">./data</code>上的本地路径(由于<code class="fe op oq or oh b">ShardedByS3Key</code>)</li><li id="e2b2" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">人物频道——S3的一条公共道路</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="016d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">演示了以下内容:</p><ol class=""><li id="c08e" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated">命名项目(<code class="fe op oq or oh b">-p</code>)和任务(<code class="fe op oq or oh b">-t</code>)。</li><li id="25ce" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">使用本地数据文件夹作为输入，它分布在实例中(<code class="fe op oq or oh b">— i</code>、<code class="fe op oq or oh b">ShardedByS3Key</code>)。该文件夹首先被同步到S3上专用于该特定任务的目录中(根据项目/任务名称)，然后被提供给工人。如果你再次运行相同的任务，就不需要上传整个数据集，只需要再次同步即可。</li><li id="720d" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">使用公共s3存储桶作为附加输入(<code class="fe op oq or oh b">--is</code>)。角色会自动添加到所使用的IAM策略中，以允许该访问。</li><li id="7c63" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">构建一个定制的docker映像(<code class="fe op oq or oh b">--df</code>、<code class="fe op oq or oh b">--repo_name</code>、<code class="fe op oq or oh b">-- aws_repo_name</code>)，以使<code class="fe op oq or oh b">pandas </code>和<code class="fe op oq or oh b">sklearn</code>库对工人可用。基本映像是自动获取的(PyTorch框架是默认的)，映像在本地构建，然后上传到ECR供正在运行的实例使用。</li><li id="496d" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">超参数任务类型。任何额外的参数都被认为是超参数。在<code class="fe op oq or oh b">--</code>(后面跟一个空格)之后的任何内容都按原样传递给执行的脚本命令行。</li><li id="411b" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">启动两个实例(<code class="fe op oq or oh b">--ic</code>)。</li><li id="efbc" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><code class="fe op oq or oh b">--force_running</code> —确保我们再次运行任务(作为本例的一部分)。</li><li id="8d57" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">使用按需实例(<code class="fe op oq or oh b">--no_spot</code>)。</li><li id="9931" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><code class="fe op oq or oh b">requirements.txt</code>的用法——因为它是源代码文件夹(<code class="fe op oq or oh b">-e</code>)的一部分，所以在运行worker之前会自动安装。</li><li id="2a16" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><code class="fe op oq or oh b">internal_dependecty</code>文件夹作为源代码文件夹的一部分被复制。</li></ol><p id="0f63" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">很酷的3号，不是吗？</p><p id="5ecd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">工人代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="b718" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">工人可以通过使用<code class="fe op oq or oh b">WorkerConfig</code>对象或环境变量来访问其配置。例如:</p><ul class=""><li id="3b4a" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated"><code class="fe op oq or oh b">worker_config.channel_data</code> —输入数据</li><li id="6981" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><code class="fe op oq or oh b">worker_config.channel_persons</code> —来自公共s3桶的数据</li><li id="a283" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><code class="fe op oq or oh b">worker_config.instance_state</code> —实例状态，在相同任务的执行之间维护</li></ul><p id="84da" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这种情况下，工作进程将输入通道数据中的文件“处理”到模型输出文件夹中，并将附加文件写入输出数据文件夹。</p><p id="784b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完整的配置文件可以在<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker/tree/develop#worker-environment" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="8c18" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">第二项任务</h2><p id="a476" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">第二个任务也获得两个输入通道:</p><ol class=""><li id="6f84" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated"><em class="mg"> ex3_1_model </em>通道—第一个任务的模型输出</li><li id="d066" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated"><em class="mg"> ex3_1_state </em>通道—第一个任务的状态</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="3fc1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">演示了以下附加功能:</p><ol class=""><li id="d93d" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq nt lx ly lz bi translated">链接—使用第1部分的输出(<code class="fe op oq or oh b">— iit</code>)作为该部分的输入。模型输出和凝视都被采用。</li><li id="fd9a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">使用附加的本地代码依赖项(<code class="fe op oq or oh b">-d</code>)。</li><li id="f0cf" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">使用TensorFlow框架作为预建图像(<code class="fe op oq or oh b">-f</code>)。</li><li id="3d58" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">标记作业(<code class="fe op oq or oh b">-- tag</code>)。</li><li id="13db" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nt lx ly lz bi translated">定义一个Sagemaker度量(<code class="fe op oq or oh b">-- md</code>)。</li></ol><p id="efe3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">很酷的4号，不是吗？</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="ce8b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">代码可以使用<code class="fe op oq or oh b">worker_config.ex3_1_state</code>和<code class="fe op oq or oh b">worker_config.ex3_1_state</code>访问其输入数据通道。</p><p id="e722" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，分数日志由上面的<code class="fe op oq or oh b">ssm</code>命令中的<code class="fe op oq or oh b">"Score=(.*?);"</code>正则表达式捕获，然后可以在<a class="ae mf" href="https://console.aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank"> AWS控制台</a>上查看度量图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/62b9bf5b02c117a2b55e8e01305930a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*TIECq17IVmFYbAhCNXrHEg.jpeg"/></div></figure><h2 id="a240" class="ne mi iq bd mj nf ng dn mn nh ni dp mr le nj nk mt li nl nm mv lm nn no mx np bi translated">完整的代码</h2><p id="f21e" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">我们可以把这两个worker放在一个文件中，使用<code class="fe op oq or oh b">task_type</code>超参数来区分这两种类型的执行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="os ot l"/></div></figure><h1 id="26d2" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">结论</h1><p id="7185" class="pw-post-body-paragraph kv kw iq kx b ky mz jr la lb na ju ld le nb lg lh li nc lk ll lm nd lo lp lq ij bi translated">我希望我成功地传达了简单的信息，并说服您下次需要更强大的硬件来处理脚本时，尝试一下<a class="ae mf" href="https://github.com/shiftan/simple_sagemaker" rel="noopener ugc nofollow" target="_blank">s<em class="mg">imple-sagemaker</em></a><em class="mg"/>。上面的例子，以及总结你所得到的“非常酷”的观点，不言自明:)。</p><p id="d384" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我知道你是否喜欢它，在下面鼓掌/看github项目。</p></div></div>    
</body>
</html>