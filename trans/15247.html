<html>
<head>
<title>Map Matching done right using Valhalla’s Meili</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Valhalla的Meili进行地图匹配</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/map-matching-done-right-using-valhallas-meili-f635ebd17053?source=collection_archive---------7-----------------------#2020-10-20">https://towardsdatascience.com/map-matching-done-right-using-valhallas-meili-f635ebd17053?source=collection_archive---------7-----------------------#2020-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="db61" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">处理GPS误差的生产就绪解决方案</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/34c05f26edcb039f8e2d5a5591342519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5UCbEwih6uqYxBrKns-VuA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="b244" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">GPS不够精确的问题并不新鲜,“捕捉到道路”功能主要是将GPS轨迹与道路进行匹配。大多数有这个问题的项目都是通过<a class="ae lr" href="https://developers.google.com/maps/documentation/roads/snap" rel="noopener ugc nofollow" target="_blank">谷歌地图道路应用编程接口</a>或者<a class="ae lr" href="http://project-osrm.org/docs/v5.22.0/api/?language=cURL#match-service" rel="noopener ugc nofollow" target="_blank"> OSRM匹配服务应用编程接口</a>来解决这个问题。但我要向你展示我走过的路，我没有后悔任何事。</p><h1 id="1132" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题</h1><p id="19b0" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">我的主要问题是计算汽车每天和每月行驶的距离。同样重要的是，我试图构建一个可以每天都这样做的生产解决方案，而不仅仅是研究部分。</p><p id="235e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因为我在GeoJSON中已经有了多个预处理的GPS轨迹，所以我创建了一个Python脚本，它使用<code class="fe mp mq mr ms b">geopy.distance.geodesic</code>函数计算距离，并在整个行程的地理点上循环。据我粗略估计，这种方法有时会有超过30%的错误率，这实际上是非常可怕的。我来解释一下原因。</p><p id="4a21" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如下图所示，有时GPS追踪并不精确。显然，司机使用的是这里的道路，但我们从GPS上获得的地理点位于道路附近，而不是道路上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/4fbb1790138611b0470c48b06587c414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oTz8uQ62baO1PsdX-lSLJA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="c34d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决办法</h1><p id="45d4" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">首先，我想自己解决这个问题。我认为这可以通过一些数学计算来完成，但谢天谢地，我很快就明白了这个问题更多的是在进行数学计算之前从哪里获得道路的坐标，并发现OSRM /谷歌地图API可以为我完成整个过程。</p><p id="ad6a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">谷歌地图API并没有让我感到惊讶，因为它只能在他们的Snap to Roads方法中获得最多100个地理点，这对于汽车的GPS跟踪来说是非常低的。另一方面，OSRM API看起来不错，直到我偶然发现瓦尔哈拉。</p><h1 id="3eb9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">瓦尔哈拉殿堂</h1><p id="ee41" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">正如他们的<a class="ae lr" href="https://github.com/valhalla/valhalla" rel="noopener ugc nofollow" target="_blank"> GitHub知识库</a>中完美指出的，Valhalla是一个开源路由引擎和附带的库，用于OpenStreetMap数据。Valhalla还包括时间+距离矩阵计算、等时线、高程采样、地图匹配和旅游优化(旅行推销员)等工具。</p><p id="1e8b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是我能想到的使用瓦尔哈拉的好处:</p><ol class=""><li id="d3d9" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">并行化。您可以在不同的服务器上使用不同的地图安装。例如，您有法国和德国的用户，您可以在服务器1中设置法国地图，在服务器2中设置德国地图，并根据您的业务逻辑向它们中的任何一个发送代理请求。此外，你可以建立一个大的星球地图或几个大陆地图，无论哪个最适合你——瓦尔哈拉已经准备好了。</li><li id="3f7f" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">定制。您可以管理自己的配置，使用许多可选参数请求信息，这些参数实际上可以引导您找到更好的解决方案。</li><li id="7c0a" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">性能。Valhalla是用C++写的。说真的。还需要我多解释吗？它快得惊人。</li><li id="e58f" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">本地化。我主要对路线步骤的英语、俄语和印地语本地化感兴趣，并惊讶地在瓦尔哈拉看到所有这些。</li><li id="1933" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">易于安装。Valhalla可以安装在各种平台上:Ubuntu、Debian、苹果macOS和微软Windows。</li><li id="1d73" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">开放性。贡献是允许的，也是受欢迎的。麻省理工许可下的开源。</li></ol><h1 id="7464" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">魅力</h1><p id="dcfb" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">梅里是瓦尔哈拉内部的主要模块之一。它的功能是执行地图匹配(捕捉道路功能)，这正是我需要解决我的问题。</p><p id="eb80" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了简要说明其工作原理，Meili首先在给定位置的给定半径内找到最近的候选路段，然后在隐马尔可夫模型(HMM)的上下文中使用维特比算法检测最高概率地图匹配(维特比路径)。</p><p id="4d0e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我不打算用这些算法的细节以及如何在您的机器上设置Valhalla和运行服务器的信息来填充这篇文章。在<a class="ae lr" href="https://github.com/valhalla/valhalla" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上有很完美的解释，建议你为此去一趟。</p><p id="ab5a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">而是让我们实际一点，用Python，熊猫和Valhalla的Meili来修复我们的GPS痕迹。</p><h1 id="3d0a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">数据</h1><p id="407d" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">为了简化这个例子，我将使用包含这些列的Pandas数据帧(df_trip ):</p><ol class=""><li id="559c" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">经度</li><li id="84dc" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">纬度</li><li id="f26a" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">时间(日期时间)</li></ol><p id="8c18" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我的示例由82行组成，代表实际GPS轨迹的地理点:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/5b9a275e218eef58eed13d611e261e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*42CjnTSNUajd2jROw2mVlw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="3227" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">向Meili发送请求</h1><p id="c4f0" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">让我们准备一个请求的正文:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="8952" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在让我们添加头并对本地服务器执行一个实际的请求:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="1afe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里有一个服务器日志，上面有瓦尔哈拉的正确回应:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="54e4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果瓦尔哈拉没有回复200，主要是因为:</p><ol class=""><li id="12ad" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">GPS追踪实际上并不在公路附近。</li><li id="feee" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">GPS跟踪是在我们没有为其构建磁贴的国家进行的(回到Valhalla的<a class="ae lr" href="https://github.com/valhalla/valhalla#running" rel="noopener ugc nofollow" target="_blank"> GitHub </a>，用正确国家的pbf文件重新做README的“运行”部分)。</li><li id="3ee2" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">GPS轨迹有缺陷(例如，多条轨迹合并为一条，时间和坐标相差很大)。</li></ol><h1 id="1c9f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">处理响应</h1><p id="a029" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">我用这个代码来处理来自Meili的响应。它并不漂亮，但很有效:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="dd06" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是这段代码的结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/713e07f2b70c7fc2026a7f93f1f0e0be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AEoTpZ10BuriSI1ET7kgjA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8c31" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">结果增加了3个新列:</p><ol class=""><li id="4dd4" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated"><em class="nm"> name </em> —它包含我们的司机当时使用的街道名称。很酷，如果你问我。</li><li id="21df" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated"><em class="nm">距离</em>——Valhalla也计算了地球点之间的距离，这完美地解决了我在本文中为自己设定的首要目标。</li><li id="e528" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated"><em class="nm">位置</em>——这一列包含了我们从梅里(抓拍到马路上)得到的坐标。</li></ol><p id="89b0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要保存无法捕捉到任何道路的地理点(例如，停车场上的一些运动)，您可以使用此代码来解析我们之前从Meili获得的“位置”列:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="d8a1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结果</h1><p id="d5b4" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">因此，我们有一个非常整洁的GPS跟踪，捕捉到实际的道路，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/bdb8afabb36efaba8f7afc5d04781b3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mrWUTxOS-X-CXONV3xVYtw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d0b6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们结合两种GPS轨迹(优化的和非优化的)来看看区别:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/dc195ac0ca2bd797f503e5c0bcd4b3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w8JWM8GkSSOcpk4oO6RQVA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="da90" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后的话</h1><p id="e48f" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">我选择Valhalla而不是OSRM API的主要原因是，Valhalla是一个生产就绪的解决方案，还有许多其他好处。</p><p id="1384" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">出于快速研究的目的，您可以使用OSRM API而不是Valhalla，因为您可以在没有预先设置环境的情况下完成这项工作。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="c7ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我想对所有Valhalla的贡献者说一声非常感谢。尤其是《魅力》的创作者，https://github.com/ptpt(<a class="ae lr" href="https://github.com/ptpt" rel="noopener ugc nofollow" target="_blank">)和凯文·克莱泽(</a><a class="ae lr" href="https://github.com/kevinkreiser" rel="noopener ugc nofollow" target="_blank">https://github.com/kevinkreiser</a>)。你们太棒了。</p><p id="9b87" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">希望这篇文章对你有所帮助。欢迎在LinkedIn<a class="ae lr" href="https://www.linkedin.com/in/szotov/" rel="noopener ugc nofollow" target="_blank">上联系我或者在下面留言。</a></p><p id="36c4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你也可以探索<a class="ae lr" href="https://github.com/zotttttttt/gps-trace-optimization/blob/main/GPS-trace-optimization-via-Valhalla.ipynb" rel="noopener ugc nofollow" target="_blank">完整的Jupyter笔记本</a>，通过一些小的添加来解决这个问题。</p></div></div>    
</body>
</html>