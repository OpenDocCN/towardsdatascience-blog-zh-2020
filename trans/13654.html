<html>
<head>
<title>Scraping a table in a PDF and then test the data quality in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在PDF中抓取表格，然后在Python中测试数据质量</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/scraping-a-table-in-a-pdf-reliably-and-then-test-data-quality-6718bb91d471?source=collection_archive---------22-----------------------#2020-09-19">https://towardsdatascience.com/scraping-a-table-in-a-pdf-reliably-and-then-test-data-quality-6718bb91d471?source=collection_archive---------22-----------------------#2020-09-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d39f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何在Python中抓取PDF中的表格，对数据进行质量单元测试，然后上传到S3。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/29307e1c859b0e1a87d90ffe58ac057a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i6Bix6qoKU0ZMdLDVfA3ww.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">蒂姆·莫斯霍尔德在<a class="ae kv" href="https://unsplash.com/s/photos/spacex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="9216" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="79f6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">假设您需要将一些数据接收到您的数据仓库中，在与您的利益相关者进一步讨论之后，这些数据的来源是一个PDF文档。幸运的是，使用一个名为<a class="ae kv" href="https://pypi.org/project/tabula-py/" rel="noopener ugc nofollow" target="_blank"> tabula-py </a>的Python包很容易做到这一点。在这篇文章中，我将带你了解如何抓取嵌入在PDF文件中的表格，使用<a class="ae kv" href="https://github.com/great-expectations/great_expectations" rel="noopener ugc nofollow" target="_blank"> Great Expectations </a>对数据进行单元测试，如果有效，将文件保存在AWS的S3中。你可以在<a class="ae kv" href="https://github.com/AshHimself/etl-pipeline-from-pdf" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到这篇文章的完整源代码，或者在<a class="ae kv" href="https://colab.research.google.com/drive/1Vh9sWzbfXC2CDC6OlJkHGUCwG95LjGyr?usp=sharing" rel="noopener ugc nofollow" target="_blank"> Google Colab </a>上找到一个工作示例。</p><h1 id="823f" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">0) <strong class="ak">所需依赖关系</strong></h1><p id="85dc" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在编写任何代码之前，让我们安装所有必需的包。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="069c" class="mp kx iq ml b gy mq mr l ms mt">pip install tabula-py<br/>pip install great_expectations<br/>pip install boto3</span></pre><h1 id="6f7d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">1)所需进口</h1><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="f44a" class="mp kx iq ml b gy mq mr l ms mt">from tabula import read_pdf<br/>import great_expectations as ge<br/>import boto3<br/>from io import StringIO</span></pre><h1 id="b731" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak"> 2)阅读PDF文件</strong></h1><p id="66b1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">下面我有两个PDF文件，其中包括一些与SpaceX发射相关的数据。一个是干净的预期格式，另一个是有意的错误，我们将在单元测试数据输出时使用。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="b95d" class="mp kx iq ml b gy mq mr l ms mt">clean = "https://raw.githubusercontent.com/AshHimself/etl-pipeline-from-pdf/master/spacex_launch_data.pdf"</span><span id="be42" class="mp kx iq ml b gy mu mr l ms mt">messy = "https://raw.githubusercontent.com/AshHimself/etl-pipeline-from-pdf/master/spacex_launch_mess_data.pdf"</span><span id="25f1" class="mp kx iq ml b gy mu mr l ms mt">source_pdf = read_pdf(clean, lattice=True, pages=”all”)</span><span id="1a30" class="mp kx iq ml b gy mu mr l ms mt">df = source_pdf[0]</span></pre><h1 id="3c98" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">3)审查数据</h1><p id="cc84" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们来看看我们的数据，看看tabula-py只用一行代码就工作得有多好！</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="bbcb" class="mp kx iq ml b gy mq mr l ms mt">df.head()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/684a08b3bfd7b4cbdfd56fb552b44cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0GWeY1pJ2IRuxNIlB8hMiw.png"/></div></div></figure><p id="2ddc" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">相当令人印象深刻！唯一值得注意的问题是，这些标题在数据库中不能很好地工作，所以让我们稍微清理一下。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="bbb9" class="mp kx iq ml b gy mq mr l ms mt">#Rename the headers<br/>fields = {‘Flight Numb’: ‘flight_number’, ‘Dr ate’: ‘date’,’Time (UTC)’: ‘time_utc’,’Booster Ver’:’booster_version’,’iLoanunch Site’:’launch_site’}</span><span id="5f2c" class="mp kx iq ml b gy mu mr l ms mt">df = df.rename(columns=fields) #rename columns<br/>df.columns = map(str.lower, df.columns) ##lower case is nicer</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/10c10ad0d1e2b81689cccfdf5ef3f69f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nM7KVrV6IXs1d8pP6kU2ag.png"/></div></div></figure><p id="fcc5" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">到目前为止，我们已经从PDF中抓取了表格，并将其保存在熊猫数据框中，如果我们愿意，我们可以将数据框保存到S3的CSV文件中。然而，如果这个PDF的格式改变了，如果有人改变了域名，我们如何保证数据将可靠地保存在S3？</p><h1 id="d583" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">4)断言数据</h1><p id="8b10" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了测试我们的数据，我们将使用一个名为<a class="ae kv" href="https://github.com/great-expectations/great_expectations" rel="noopener ugc nofollow" target="_blank"> Great Expectations </a>的神奇包。我甚至不会触及这个包的表面，所以我强烈建议检查一下！。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="6e07" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">如果我们现在运行代码，使用我们的<a class="ae kv" href="https://github.com/AshHimself/etl-pipeline-from-pdf/raw/master/spacex_launch_data.pdf" rel="noopener ugc nofollow" target="_blank">预期pdf </a>，它应该通过所有断言。然而，看看<a class="ae kv" href="https://github.com/AshHimself/etl-pipeline-from-pdf/raw/master/spacex_launch_messy_data.pdf" rel="noopener ugc nofollow" target="_blank">凌乱的pdf </a>。我特意添加了一些重复的flight_number行，并重命名了输出列。如果我们使用混乱的PDF再次运行<em class="ne">(从第2节</em>更新PDF源文件)，上面的代码应该返回“一些断言已经失败:(”。validation_results的输出也相当详细，但是您可以在这里查看完整的输出<a class="ae kv" href="https://gist.github.com/AshHimself/8b26c5fb88e7bad0dfd73a59fa84aadf" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="db3b" class="mp kx iq ml b gy mq mr l ms mt">{“Expected Column Position”: 7,”Expected”: “outcome”,”Found”: “mission outcome”}</span></pre><p id="dbd2" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">像这样在ETL管道中进行一些基本的测试可以很容易地帮助确保数据质量的一致性和可靠性。</p><h1 id="deb8" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">5)在S3保存我们的数据</h1><p id="e788" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">教您如何设置具有正确权限的S3存储桶超出了本文的范围，所以我假设您知道如何做或者知道如何解决这个问题。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="92ce" class="mp kx iq ml b gy mq mr l ms mt">AWSAccessKeyId=’your_access_key_id’<br/>AWSSecretKey=’your_secret_key’</span><span id="ddf6" class="mp kx iq ml b gy mu mr l ms mt">bucket = ‘scrape-pdf-example’ # your S3 bucket</span><span id="349c" class="mp kx iq ml b gy mu mr l ms mt">csv_buffer = StringIO()</span><span id="da14" class="mp kx iq ml b gy mu mr l ms mt">s3 = boto3.client(‘s3’, aws_access_key_id=AWSAccessKeyId, aws_secret_access_key=AWSSecretKey)</span><span id="21c3" class="mp kx iq ml b gy mu mr l ms mt">df.to_csv(csv_buffer) #save our dataframe into memory<br/>s3_resource = boto3.resource(‘s3’)<br/>s3_resource.Object(bucket, ‘df.csv’).put(Body=csv_buffer.getvalue()) #push CSV to S3</span></pre><p id="3ce4" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">来自<a class="ae kv" href="https://stackoverflow.com/questions/38154040/save-dataframe-to-csv-directly-to-s3-python" rel="noopener ugc nofollow" target="_blank"> Stefan </a>的代码片段！</p><p id="6623" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">搞定了。你现在应该在你的S3桶中有一个CSV文件，如果你愿意，它可以被其他AWS服务<em class="ne"> (Glue，Redshift等)接收。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/cc7e294322559f6437425a88e190ee70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OfjaPa4XOv1DZ4QoEBS7Zg.png"/></div></div></figure><blockquote class="ng"><p id="9393" class="nh ni iq bd nj nk nl nm nn no np mj dk translated">您在生产中测试过数据的质量吗？</p></blockquote><h1 id="094c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw nq jx li jz nr ka lk kc ns kd lm ln bi translated">结束语</h1><p id="157f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">使用<a class="ae kv" href="https://aws.amazon.com/textract/" rel="noopener ugc nofollow" target="_blank"> AWS服务Textract </a>服务或其他Python包可以轻松实现上述代码，但对我来说，Tabula在处理简单和更复杂的PDF文档时效果很好，这些文档包含多个表格和更复杂的表格结构。</p><p id="247e" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">总的来说，数据质量和测试数据至关重要，但却常常被忽视。像<a class="ae kv" href="https://docs.getdbt.com/docs/building-a-dbt-project/tests/" rel="noopener ugc nofollow" target="_blank"> DBT </a>和<a class="ae kv" href="https://www.matillion.com/resources/blog/assert-unit-test-components-validating-objects-in-matillion-etl/" rel="noopener ugc nofollow" target="_blank">马提利翁</a>这样的解决方案提供了测试/断言你的数据的功能，使这个过程变得非常容易。你使用什么工具？</p><p id="b93b" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated">将最终输出保存到S3显然是可选的。我只是选择这样做，因为未来的文章将利用S3的CSV文件作为起点。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="9a28" class="pw-post-body-paragraph lo lp iq lq b lr mw jr lt lu mx ju lw lx my lz ma mb mz md me mf na mh mi mj ij bi translated"><em class="ne">关于我:对万物数据充满热情，活在</em> <strong class="lq ir"> <em class="ne">商业</em> </strong> <em class="ne">，</em> <strong class="lq ir"> <em class="ne">数据</em> </strong> <em class="ne">，</em> <strong class="lq ir"> <em class="ne">机器学习</em> </strong> <em class="ne">。想聊天可以在</em><a class="ae kv" href="https://www.linkedin.com/in/ashleygsmith/" rel="noopener ugc nofollow" target="_blank"><em class="ne">LinkedIn</em></a><em class="ne">上联系我！</em></p></div></div>    
</body>
</html>