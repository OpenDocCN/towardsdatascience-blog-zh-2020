<html>
<head>
<title>Tensorflow SavedModel in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java中的Tensorflow SavedModel</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/running-savedmodel-in-java-1351e7bdf0a4?source=collection_archive---------23-----------------------#2020-10-03">https://towardsdatascience.com/running-savedmodel-in-java-1351e7bdf0a4?source=collection_archive---------23-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b94a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何将您的TF SavedModel与当前版本的<a class="ae kf" href="https://github.com/tensorflow/java" rel="noopener ugc nofollow" target="_blank"> Tensorflow Java </a>一起使用</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/22db01d78781dd7d507dabac5c4eb7ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*odXy8TQi3XXeF6KA5GFuwQ.jpeg"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">来源:https://unsplash.com/@ricaros<a class="ae kf" href="https://unsplash.com/@ricaros" rel="noopener ugc nofollow" target="_blank"/></p></figure><h1 id="dfd4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="b34e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">机器学习最流行的编程语言是Python。大多数数据科学家和ML工程师用Python来构建他们管道。尽管Python是一个广泛使用的解决方案，但它可能不是所有栈或用例的最佳选择。在本文中，我将向您展示如何在当前版本的<a class="ae kf" href="https://github.com/tensorflow/java" rel="noopener ugc nofollow" target="_blank"> Tensorflow Java </a>中使用您的SavedModel，这可能会有用。</p><p id="2591" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注:如你所见</strong><a class="ae kf" href="https://github.com/tensorflow/java" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir">tensor flow Java</strong></a><strong class="lq ir">还在建设中。因此，可能会发生一些意想不到的行为。请记住这一点。</strong></p><h1 id="66d3" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">设置maven项目</h1><p id="56a4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">首先创建一个Maven项目并打开pom.xml。我用Java 11，因为它是LTS。</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="0d9a" class="mu kx iq mq b gy mv mw l mx my">&lt;properties&gt;<br/>  &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br/>  &lt;maven.compiler.source&gt;1.11&lt;/maven.compiler.source&gt;<br/>  &lt;maven.compiler.target&gt;1.11&lt;/maven.compiler.target&gt;<br/>&lt;/properties&gt;</span></pre><p id="f607" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，将Tensorflow Java工件添加到项目中。在撰写本文时，它们还没有托管在maven上。因此，您必须手动添加Sonatype的OSS库。你总能在他们的Github资源库<a class="ae kf" href="https://github.com/tensorflow/java" rel="noopener ugc nofollow" target="_blank"> Tensorflow/Java </a>中找到最新的指令。</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="5b40" class="mu kx iq mq b gy mv mw l mx my">&lt;repositories&gt;<br/>    &lt;repository&gt;<br/>        &lt;id&gt;tensorflow-snapshots&lt;/id&gt;               &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/url&gt;<br/>        &lt;snapshots&gt;<br/>            &lt;enabled&gt;true&lt;/enabled&gt;<br/>        &lt;/snapshots&gt;<br/>    &lt;/repository&gt;<br/>&lt;/repositories&gt;<br/><br/>&lt;dependencies&gt;<br/>    &lt;dependency&gt;<br/>       &lt;groupId&gt;org.tensorflow&lt;/groupId&gt;<br/>       &lt;artifactId&gt;tensorflow-core-platform&lt;/artifactId&gt;<br/>       &lt;version&gt;0.2.0-SNAPSHOT&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><h1 id="8a1f" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">准备SavedModel</h1><p id="9c4e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">出于演示的目的，我将使用GPT-2模型。但是任何其他SavedModel都可以。下载/创建SavedModel文件后，我将整个文件夹移动到Java项目的resource文件夹中。然后转到终端，输入以下行:</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="09cc" class="mu kx iq mq b gy mv mw l mx my">saved_model_cli show --dir PATH/TO/SAVEDMODEL/FOLDER --all<br/># my output:<br/>MetaGraphDef with tag-set: 'serve' contains the following SignatureDefs:</span><span id="32e4" class="mu kx iq mq b gy mz mw l mx my">signature_def['predict']:<br/>  The given SavedModel SignatureDef contains the following input(s):<br/>  inputs['context'] tensor_info:<br/>    dtype: DT_INT32<br/>    shape: (1, -1)<br/>    name: Placeholder:0<br/>  The given SavedModel SignatureDef contains the following          output(s):<br/>  outputs['sample'] tensor_info:<br/>    dtype: DT_INT32<br/>    shape: (1, -1)<br/>    name: sample_sequence/while/Exit_3:0<br/>Method name is: tensorflow/serving/predict</span></pre><p id="e575" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这为您提供了关于模型的所有相关信息，例如标签集、输入和输出节点等。执行推理时需要这些信息。</p><h1 id="4788" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">运行SavedModel</h1><p id="61ad" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建一个新的Java类，创建一个main方法，并添加以下代码行来加载带有特定标记集的SavedModel:</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="a532" class="mu kx iq mq b gy mv mw l mx my">SavedModelBundle model = SavedModelBundle.load(modelPath, "serve");</span></pre><p id="30fa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">此时，我们需要为模型创建输入张量。所有可用转换的概述可在<a class="ae kf" href="https://github.com/tensorflow/java-models/blob/master/tensorflow-examples/src/main/java/org/tensorflow/model/examples/tensors/TensorCreation.java" rel="noopener ugc nofollow" target="_blank">TensorCreation.java</a>中找到。在我的例子中，GPT-2取一个带有形状(1，-1)和int值的张量。所以我用一些随机手写的int值创建了一个形状为(1，9)的张量</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="ed11" class="mu kx iq mq b gy mv mw l mx my">IntNdArray input_matrix = NdArrays.ofInts(Shape.of(1, 9));<br/>input_matrix.set(NdArrays.vectorOf(1, 2, 3, 5, 7, 21, 23, 43, 123), 0);<br/>Tensor&lt;TInt32&gt; input_tensor = TInt32.tensorOf(input_matrix);</span></pre><p id="a305" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后创建一个映射，它有一个字符串键和一个张量作为值。关键是输入张量的名称和您将用作输入的张量的值。这应该会让你想起以前的Tensorflow 1。x天，您必须创建一个feed_dict，并在会话期间将其插入到图表中。在Java中，我们可以简单地创建一个散列表，并将我们创建的输入传感器插入其中:</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="a643" class="mu kx iq mq b gy mv mw l mx my">Map&lt;String, Tensor&lt;?&gt;&gt; feed_dict = new HashMap&lt;&gt;();<br/>feed_dict.put("context", input_tensor);</span></pre><p id="ccb1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">剩下要做的就是调用signature_def函数。</p><pre class="kh ki kj kk gt mp mq mr ms aw mt bi"><span id="06a1" class="mu kx iq mq b gy mv mw l mx my">model.function("predict").call(feed_dict)</span></pre><p id="7695" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并且你完成了，所有的代码都可以在这个<a class="ae kf" href="https://gist.github.com/steven-mi/c4578d312546bd2414b152331100ac26" rel="noopener ugc nofollow" target="_blank">要点</a>中找到。</p></div></div>    
</body>
</html>