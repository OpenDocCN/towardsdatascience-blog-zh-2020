<html>
<head>
<title>How much faster is image integral?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">图像积分快多少？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-much-faster-is-image-integral-90ba0008497a?source=collection_archive---------32-----------------------#2020-10-17">https://towardsdatascience.com/how-much-faster-is-image-integral-90ba0008497a?source=collection_archive---------32-----------------------#2020-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2a09" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Google Colab比较暴力和图像积分</h2></div><p id="798f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我寻求学习更多关于计算机视觉和python的过程中，我一直在阅读Viola-James物体检测框架，这里的<a class="ae lb" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.10.6807" rel="noopener ugc nofollow" target="_blank">论文对此做了最好的总结</a>。</p><p id="f3e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，他们描述了图像积分的概念，这是一种描述图像的数组的总面积表，他们的观点是——暴力计算积分比提前计算图像积分并从数组中取出数字要慢得多。这种计算经常在计算机视觉应用中使用。</p><p id="4f2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我很好奇——快了多少？这篇论文发表于2001年，我们现在的处理器肯定要快得多(20年后)，这不会有什么不同吧？嗯，我是<em class="lc">非常错误的</em>。</p><h2 id="d7ef" class="ld le iq bd lf lg lh dn li lj lk dp ll ko lm ln lo ks lp lq lr kw ls lt lu lv bi translated"><strong class="ak">跟着一起:</strong> <a class="ae lb" href="https://colab.research.google.com/drive/1UJOd9ByM9chEWs3GQ7G2PE6CrLj5Xfu9?usp=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Google Colab笔记本</strong> </a></h2><h1 id="b7da" class="lw le iq bd lf lx ly lz li ma mb mc ll jw md jx lo jz me ka lr kc mf kd lu mg bi translated">图像积分</h1><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/7325f3699d7f33bc15598f553c46ff79.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/0*uTUqZOvC3QOv7dQB.png"/></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">图像转换成图像积分。来源:<a class="ae lb" href="https://stackoverflow.com/questions/16546130/efficient-implementation-of-summed-area-table-integral-image-in-r" rel="noopener ugc nofollow" target="_blank">Stackoverflow.com</a></p></figure><p id="6409" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用左上角作为索引0，0 (x=0，y=0)，水平和垂直计算积分。</p><p id="62f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在积分图像(右侧)中，索引(x=1，y=0)是5，它是原始图像(so，4+1=5)中的(0，0)和(1，0)中包含的值的总和</p><p id="5a34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，integral image index (2，2) = 9，也就是左上2x2块之和:4+4+1+0 = 9。</p><p id="b657" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我举了几个更简单的例子:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/8a027f7c23c23e60fddabcd7029992e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*Oluwme9YL0aQShhyVRx6QA.png"/></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">来源:图片由作者提供。灵感来自<a class="ae lb" href="https://vinsol.com/blog/2016/06/28/computer-vision-face-detection/" rel="noopener ugc nofollow" target="_blank">vinsol.com</a></p></figure><h1 id="8832" class="lw le iq bd lf lx ly lz li ma mb mc ll jw md jx lo jz me ka lr kc mf kd lu mg bi translated">图像设置</h1><p id="daff" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">让我们浏览一下图像的设置、上传和转换等。首先，导入您的库:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">设置您的库</p></figure><p id="3b7c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我要用这张哈巴狗的照片:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/bde7ffe5deb98547544f145bd801d62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nJGNDLJXIeoqrl5sjaCZ8w.jpeg"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">资料来源:Unsplash.com</p></figure><p id="9536" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很好，现在图像已经上传了，接下来要做一些事情:将它转换成黑白图像，然后转换成一个numpy数组:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">黑白转换，然后转换成numpy数组</p></figure><p id="a8b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用open cv (cv2)中的图像积分函数。它用零填充积分，所以我们将删除下面第2行中的那些。</p><p id="615e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从第4行开始，我们将定义一个强力函数进行比较，它所做的只是对行和列求和:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">使用OpenCV并定义强力函数</p></figure><h1 id="7f12" class="lw le iq bd lf lx ly lz li ma mb mc ll jw md jx lo jz me ka lr kc mf kd lu mg bi translated">多次CPU迭代</h1><p id="665f" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我将进行三种类型的迭代，并记录执行每种计算所需的时间。我们将每个迭代运行500次，以尽量减少可变性。</p><p id="6ece" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在对图像做深度学习的时候，500次大概是一个很低的数字；图像计算大概是几百万到几十亿的量级。</p><p id="24d4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还将选择上图中的位置(1000，1000)进行计算。</p><h2 id="117b" class="ld le iq bd lf lg lh dn li lj lk dp ll ko lm ln lo ks lp lq lr kw ls lt lu lv bi translated">迭代1——强力推进图像积分</h2><p id="5279" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">这是“控制”时间:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div></figure><h2 id="d215" class="ld le iq bd lf lg lh dn li lj lk dp ll ko lm ln lo ks lp lq lr kw ls lt lu lv bi translated">迭代2-重复图像积分计算</h2><p id="5f35" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">这里，我们将在每次重复时重复cv.integral，而不是只计算一次:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="ae45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果呢？121.8x！即使我们每次重复重新计算积分。</p><pre class="mi mj mk ml gt ng nh ni nj aw nk bi"><span id="dccb" class="ld le iq nh b gy nl nm l nn no">Image Integral is: 121.8 times faster</span></pre><h2 id="0873" class="ld le iq bd lf lg lh dn li lj lk dp ll ko lm ln lo ks lp lq lr kw ls lt lu lv bi translated">迭代3-使用预先计算的图像积分</h2><p id="2c15" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">这类似于对一幅图像计算一次积分，然后对同一幅图像进行数百次计算。</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="140d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果= 33073.65x. <strong class="kh ir">比三十三个</strong> <strong class="kh ir">快一千个</strong>倍。</p><pre class="mi mj mk ml gt ng nh ni nj aw nk bi"><span id="3a54" class="ld le iq nh b gy nl nm l nn no">Image Integral is: 33073.65 times faster</span></pre><h1 id="c955" class="lw le iq bd lf lx ly lz li ma mb mc ll jw md jx lo jz me ka lr kc mf kd lu mg bi translated">GPU计算</h1><p id="e475" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">当然，所有深度学习的学生都是GPU的忠实粉丝，但在这种情况下，它不会成功。</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="809d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有GPU开销，如CUDA初始化、内核调用、内存分配，使这个过程慢得多。重复做500次非常慢，我不得不减少到50次，这样我就不会永远无所事事。</p><p id="d436" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果？CPU图像积分计算一次(上面的迭代3)几乎比GPU快37，000倍。</p><p id="5d90" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GPU计算实际上比所有CPU迭代都要慢。</p><h2 id="7f0d" class="ld le iq bd lf lg lh dn li lj lk dp ll ko lm ln lo ks lp lq lr kw ls lt lu lv bi translated">如果你错过了上面的，这里是<a class="ae lb" href="https://colab.research.google.com/drive/1UJOd9ByM9chEWs3GQ7G2PE6CrLj5Xfu9?usp=sharing" rel="noopener ugc nofollow" target="_blank"> Colab笔记本</a></h2><h1 id="6852" class="lw le iq bd lf lx ly lz li ma mb mc ll jw md jx lo jz me ka lr kc mf kd lu mg bi translated">参考</h1><p id="a652" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">[1] <a class="ae lb" href="https://en.wikipedia.org/wiki/Viola%E2%80%93Jones_object_detection_framework" rel="noopener ugc nofollow" target="_blank"> Viola-Jones对象检测框架</a>，维基百科，2020年10月访问</p><p id="4339" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[2] <a class="ae lb" href="https://pypi.org/project/opencv-python/" rel="noopener ugc nofollow" target="_blank"> OpenCV-Python </a>，2020年10月访问</p><p id="0bcd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[3] <a class="ae lb" href="https://cupy.dev/" rel="noopener ugc nofollow" target="_blank"> CuPy </a>，2020年10月访问</p></div></div>    
</body>
</html>