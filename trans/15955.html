<html>
<head>
<title>How I Improved Performance Retrieving Big Data With S3-Select</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何通过S3选择提高检索大数据的性能</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-i-improved-performance-retrieving-big-data-with-s3-select-2bd2850bc428?source=collection_archive---------10-----------------------#2020-11-03">https://towardsdatascience.com/how-i-improved-performance-retrieving-big-data-with-s3-select-2bd2850bc428?source=collection_archive---------10-----------------------#2020-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="1ef3" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="c46f" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何使用S3选择有效地提取数据，以及它与亚马逊雅典娜有何不同</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/d303b1ead9f3df7348eeb61a5396e1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LsdlLBmA_FCMTOM28uFoLw.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://www.pexels.com/photo/abstract-blur-bright-color-243908/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae lh" href="https://www.pexels.com/@erkan?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Erkan Utu </a>拍摄</p></figure><p id="727d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我最近在S3遇到一个功能，在处理大数据时特别有用。您可以编写一个简单的SQL查询来选择特定的列并筛选特定的行，以便只检索您的应用程序所需的数据。在本文中，我将演示如何使用Python的<code class="fe me mf mg mh b">boto3</code>库来实现这一点。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="8c79" class="mp mq it bd mr ms mt mu mv mw mx my mz ki na kj nb kl nc km nd ko ne kp nf ng bi translated">示例使用案例</h1><p id="9304" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">想象以下场景:</p><ul class=""><li id="e235" class="nm nn it lk b ll lm lo lp lr no lv np lz nq md nr ns nt nu bi translated">你经常会得到一个<strong class="lk jd">大型CSV文件</strong>，它存储在一个S3桶中。该文件包括您的网上商店活跃的所有国家的营销数据。</li><li id="8d50" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">然而，你有一个运行在AWS Lambda中的应用程序，它只需要来自某个特定国家的营销数据。</li></ul><p id="a367" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通常，您必须下载整个大文件并过滤掉应用程序中的数据。问题是你的Lambda函数可能没有足够的内存将这个大文件读入内存。有一些方法可以解决这个问题，比如读取和过滤块中的数据或者将函数移动到Docker容器，但是在这个场景中最简单和最具成本效益的解决方案是使用<strong class="lk jd"> S3选择</strong>特性。这是它的工作原理。</p><h1 id="8ccf" class="mp mq it bd mr ms oa mu mv mw ob my mz ki oc kj nb kl od km nd ko oe kp nf ng bi translated">履行</h1><p id="af60" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">首先，由于我实际上没有任何营销数据，我们将使用来自纽约的出租车出行数据[1]，我们将过滤具有<strong class="lk jd">未知支付类型</strong>的可疑记录，根据<a class="ae lh" href="https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf" rel="noopener ugc nofollow" target="_blank">数据字典</a>编码为<code class="fe me mf mg mh b">payment_type==5</code>。</p><p id="d21a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们看看整个文件有多少行，相比之下，只有那些与<code class="fe me mf mg mh b">payment_type==5</code>。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="f700" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这意味着我们只对50万条记录中的12条感兴趣。仅仅为了获得这12行数据而将整个数据集下载并读取到内存中是一种巨大的资源浪费！</p><h2 id="3b52" class="oh mq it bd mr oi oj dn mv ok ol dp mz lr om on nb lv oo op nd lz oq or nf iz bi translated">S3-选择</h2><p id="57f0" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">为了展示S3选择的实际效果，我们首先将我们的大型CSV文件[1]上传到S3存储桶:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="0b8a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，我们可以使用S3选择来仅获取付款类型等于5的数据，即<strong class="lk jd">我们仅从S3检索我们感兴趣的数据</strong> —付款类型未知的数据。最棒的是，这一切都是在一个简单的SQL查询中定义的:</p><ul class=""><li id="dc39" class="nm nn it lk b ll lm lo lp lr no lv np lz nq md nr ns nt nu bi translated">在我们的查询中，我们只选择用例需要的列</li><li id="ad89" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">我们只过滤<code class="fe me mf mg mh b">payment_type='5'</code> —注意，在S3，平面文件中的所有列都被认为是文本，所以一定要用引号<code class="fe me mf mg mh b">'5'</code>将值括起来。</li></ul><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="2365" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在上面的代码片段中，我们必须定义<code class="fe me mf mg mh b">InputSerialization='CSV'</code>来指定这是我们的S3对象的格式。此外，我们将<code class="fe me mf mg mh b">FileHeaderInfo</code>设置为<code class="fe me mf mg mh b">'Use'</code>，这确保我们可以在S3选择查询中使用列名。</p><p id="b50c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过使用<code class="fe me mf mg mh b">OutputSerialization</code>参数，我们定义我们希望我们的输出是逗号分隔的，这允许我们将结果存储在一个单独的CSV文件中。如果您想在API中使用S3选择，您可能更喜欢<code class="fe me mf mg mh b">JSON</code>格式。</p><p id="6038" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">一些额外的警告:</strong></p><ul class=""><li id="9360" class="nm nn it lk b ll lm lo lp lr no lv np lz nq md nr ns nt nu bi translated">S3选择只返回记录，不返回列名(<em class="os">标题</em>)，所以在第27行，我确保在<code class="fe me mf mg mh b">query</code>中定义的相同列也作为第一行包含在<code class="fe me mf mg mh b">TARGET_FILE</code>中。</li><li id="1dc0" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">S3选择返回一个<strong class="lk jd">编码字节流</strong> [2]，所以我们必须循环返回的流并解码输出:<code class="fe me mf mg mh b">.decode('utf-8')</code>。</li></ul><h2 id="dab5" class="oh mq it bd mr oi oj dn mv ok ol dp mz lr om on nb lv oo op nd lz oq or nf iz bi translated">测试结果</h2><p id="7531" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">让我们交叉检查一下<code class="fe me mf mg mh b">TARGET_FILE </code>——它应该只有12行。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="2bbb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">结果是:</p><pre class="ks kt ku kv gt ot mh ou ov aw ow bi"><span id="6119" class="oh mq it mh b gy ox oy l oz pa">Nr of rows: 12<br/>    ID  distance  tip  total<br/>0    1       9.7    0  31.80<br/>1    1      10.0    0  30.80<br/>2    1       0.4    0   7.80<br/>3    1      13.6    0  40.80<br/>4    1       0.5    0   7.80<br/>5    1       1.7    0  11.80<br/>6    1       6.4    0  22.80<br/>7    1       4.0    0  16.80<br/>8    1       1.7    0  11.30<br/>9    1       5.6    0  22.80<br/>10   1       7.3    0  30.42<br/>11   1       6.7    0  24.80</span></pre></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="2a52" class="mp mq it bd mr ms mt mu mv mw mx my mz ki na kj nb kl nc km nd ko ne kp nf ng bi translated">S3-选择vs雅典娜</h1><p id="221b" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">您可能会问:如果S3这么容易使用，为什么我们需要Athena来查询数据湖？这两者的主要区别如下:</p><ul class=""><li id="3482" class="nm nn it lk b ll lm lo lp lr no lv np lz nq md nr ns nt nu bi translated">雅典娜可以一次<strong class="lk jd">查询</strong> <strong class="lk jd">多个对象</strong>，而使用S3选择，我们只能查询单个对象(<em class="os"> ex。单个平面文件</em></li><li id="5405" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">有了Athena，我们可以使用符合ANSI的SQL查询封装复杂的业务逻辑，而<strong class="lk jd"> S3选择</strong>让您只执行基本查询，在从S3加载数据之前<strong class="lk jd">过滤掉数据</strong>。</li><li id="5de5" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">雅典娜支持更多的文件格式和更多形式的文件压缩比S3选择。例如，<strong class="lk jd"> S3选择</strong>只支持<strong class="lk jd"> CSV、JSON和Parquet </strong>，而Athena另外允许TSV、ORC文件等等。</li><li id="d1d4" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">S3选择<strong class="lk jd">仅适用于S3 API </strong>(例如。通过使用Python <strong class="lk jd"> boto3 </strong> SDK)，而Athena可以通过JDBC从管理控制台或SQL客户端直接查询。</li><li id="6aab" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">Athena允许许多<strong class="lk jd">优化</strong>技术来获得更好的性能和成本优化，例如分区、列存储，而S3选择是一个非常基本的查询，除了过滤数据什么都不是。</li><li id="81fc" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">S3选择可以直接查询，而<strong class="lk jd">雅典娜</strong>需要定义一个<strong class="lk jd">模式</strong>。</li></ul><h1 id="3204" class="mp mq it bd mr ms oa mu mv mw ob my mz ki oc kj nb kl od km nd ko oe kp nf ng bi translated">S3-精选的优势</h1><p id="57a5" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">简而言之，这个API的好处是:</p><ul class=""><li id="1d83" class="nm nn it lk b ll lm lo lp lr no lv np lz nq md nr ns nt nu bi translated">减少IO，从而提高性能</li><li id="3b5b" class="nm nn it lk b ll nv lo nw lr nx lv ny lz nz md nr ns nt nu bi translated">由于数据传输费用减少，降低了成本。</li></ul><h1 id="3337" class="mp mq it bd mr ms oa mu mv mw ob my mz ki oc kj nb kl od km nd ko oe kp nf ng bi translated">结论</h1><p id="5b3c" class="pw-post-body-paragraph li lj it lk b ll nh kd ln lo ni kg lq lr nj lt lu lv nk lx ly lz nl mb mc md im bi translated">在本文中，我们讨论了S3选择，它允许过滤存储在S3的数据。S3选择应该只在处理单个文件时使用，并且只需要从平面文件中选择特定的列和特定的行。</p><p id="710c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">如果这篇文章有帮助，</strong> <a class="ae lh" href="https://medium.com/@anna.anisienia" rel="noopener"> <strong class="lk jd">关注我</strong> </a> <strong class="lk jd">看我下一篇文章。</strong></p><p id="8f6a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下面链接的文章中，我讨论了在S3存储桶之间传输大量数据的各种选择。</p><div class="pb pc gp gr pd pe"><a href="https://medium.com/better-programming/it-took-2-days-and-7-engineers-to-move-data-between-s3-buckets-d79c55b16d0" rel="noopener follow" target="_blank"><div class="pf ab fo"><div class="pg ab ph cl cj pi"><h2 class="bd jd gy z fp pj fr fs pk fu fw jc bi translated">7名工程师花了2天时间在S3存储桶之间移动数据</h2><div class="pl l"><h3 class="bd b gy z fp pj fr fs pk fu fw dk translated">在两个S3存储桶之间传输大数据的最佳选择</h3></div><div class="pm l"><p class="bd b dl z fp pj fr fs pk fu fw dk translated">medium.com</p></div></div><div class="pn l"><div class="po l pp pq pr pn ps lb pe"/></div></div></a></div><p id="06d7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">资源:</strong></p><p id="4b5e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[1] TLC行程记录数据:<a class="ae lh" href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page" rel="noopener ugc nofollow" target="_blank">https://www1 . NYC . gov/site/TLC/about/TLC-Trip-Record-Data . page</a></p><p id="0aa6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[2]boto 3 Docs:<a class="ae lh" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.select_object_content" rel="noopener ugc nofollow" target="_blank">https://boto 3 . Amazon AWS . com/v1/documentation/API/latest/reference/services/S3 . html # S3。客户端.选择_对象_内容</a></p><p id="fe72" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[3] AWS文档:<a class="ae lh" href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_InputSerialization.html" rel="noopener ugc nofollow" target="_blank">https://Docs . AWS . Amazon . com/Amazon S3/latest/API/API _ input serialization . html</a>和<a class="ae lh" href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_SelectObjectContent.html" rel="noopener ugc nofollow" target="_blank">https://Docs . AWS . Amazon . com/Amazon S3/latest/API/API _ selectobject content . html</a></p></div></div>    
</body>
</html>