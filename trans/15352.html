<html>
<head>
<title>Types of Samplings in PySpark 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PySpark 3中的采样类型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/types-of-samplings-in-pyspark-3-16afc64c95d4?source=collection_archive---------4-----------------------#2020-10-22">https://towardsdatascience.com/types-of-samplings-in-pyspark-3-16afc64c95d4?source=collection_archive---------4-----------------------#2020-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3796" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Spark中采样技术的解释及其在Pyspark中的具体实现步骤</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9fc7517c6a0c793c6ddeae8fa335a947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SIKIaS3Ww3SHHqOgOoFSBA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://pixabay.com/photos/color-letters-colorful-letters-4003283/" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kw">来源</strong> </a></p></figure><p id="db99" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><a class="ae kv" href="https://www.scribbr.com/methodology/sampling-methods/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir">抽样</strong> </a>是为特定的案例研究从数据集中确定一个有代表性的亚组的过程。抽样代表重要的研究和商业决策结果。因此，在所提供的技术中使用最合适和最有用的取样方法是至关重要的。本文主要面向希望在采样子领域使用<a class="ae kv" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Spark </a>最新增强功能的数据科学家和数据工程师。</p><p id="c485" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">Spark支持的采样方法有两种:<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sample" rel="noopener ugc nofollow" target="_blank"><strong class="kz ir"><em class="lt">sample</em></strong></a>和<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sampleBy" rel="noopener ugc nofollow" target="_blank"><strong class="kz ir"><em class="lt">sample by</em></strong></a><strong class="kz ir"><em class="lt"/></strong>详见后面的章节。</p><h1 id="3de1" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">1.样本()</h1><p id="a49d" class="pw-post-body-paragraph kx ky iq kz b la mm jr lc ld mn ju lf lg mo li lj lk mp lm ln lo mq lq lr ls ij bi translated">如果使用<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sample" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir"> sample() </strong> </a>，<a class="ae kv" href="https://www.investopedia.com/terms/s/simple-random-sample.asp" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir">简单随机抽样</strong> </a>，数据集中的每个元素都有相似的机会被优先选择。以随机指定的分数比率从数据集中选择变量，而不基于任何变量进行分组或聚类。</p><p id="1104" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">该方法使用3个参数。<strong class="kz ir"><em class="lt">with replacement</em></strong>参数默认设置为<strong class="kz ir"><em class="lt">False</em></strong><em class="lt"/>，因此该元素只能被选作样本一次。如果该值被更改为<strong class="kz ir"> <em class="lt">真</em> </strong>，则可以再次在同一采样中选择一个样本值。由于可以多次选择元素，因此<strong class="kz ir"><em class="lt">with replacement = True</em></strong>和<strong class="kz ir"><em class="lt">with replacement = False</em></strong>的数量可能略有不同。</p><p id="7fb8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">另一个参数是<strong class="kz ir"> <em class="lt">分数</em> </strong>字段，需要填写，在<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame.sampleBy" rel="noopener ugc nofollow" target="_blank"> <em class="lt"> Spark的官方文档</em> </a>中有说明，不能除以指定的百分比值。</p><p id="4868" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果任何数字被分配给<strong class="kz ir"> <em class="lt">种子</em> </strong>字段，它可以被认为是分配一个特殊的id给那个采样。这样，每次运行脚本时都会选择相同的样本。如果该值保留为<strong class="kz ir"> <em class="lt">无</em> </strong>，则每次创建不同的采样组。</p><p id="17e7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">下面我用<a class="ae kv" href="https://www.kaggle.com/yassinealouini/m5-sales-hierarchy-dataset" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir"> Kaggle数据集</strong> </a> <strong class="kz ir">添加一个我在本地Jupyter笔记本上编码的例子。</strong></p><p id="f8a7" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在下面的例子中，<strong class="kz ir"><em class="lt">with replacement</em></strong>值被设置为<strong class="kz ir"> <em class="lt"> True </em>，</strong>的<strong class="kz ir"> <em class="lt">分数</em> </strong>参数被设置为<strong class="kz ir"> <em class="lt"> 0.5 </em> </strong>，<strong class="kz ir"> <em class="lt">种子</em> </strong>参数被设置为<strong class="kz ir"> <em class="lt"> 1234 </em> </strong>，这是一个可以赋值的id</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/6377188a84794d4a6ee0f1349a975e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckn1xrGUKcKHxuinLCQ8Bg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd kw">图一。</strong> sample()方法同<strong class="bd kw"/><em class="ms">【with replacement = True】</em>(图片由作者提供)</p></figure><p id="53da" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在下面的例子中，<strong class="kz ir"><em class="lt">with replacement</em></strong>值被设置为<strong class="kz ir"> <em class="lt"> False </em>，</strong>的<strong class="kz ir"/>分数被设置为<strong class="kz ir"> <em class="lt"> 0.5 </em> </strong>，<strong class="kz ir"> <em class="lt">种子</em> </strong>参数被设置为<strong class="kz ir"> <em class="lt"> 1234</em></strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/2788c24f4ab14652cd96621d7c9bfca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9SmN1yplkELmf3Erf-n-w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd kw">图二。</strong> sample()方法同<strong class="bd kw"/><em class="ms">【with replacement = False】</em>(图片由作者提供)</p></figure><p id="fa55" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">下面，有对<strong class="kz ir"> sample() </strong>方法的详细解释。</p><h2 id="cd5f" class="mu lv iq bd lw mv mw dn ma mx my dp me lg mz na mg lk nb nc mi lo nd ne mk nf bi translated">样本(替换=无，分数=无，种子=无)</h2><p id="53a2" class="pw-post-body-paragraph kx ky iq kz b la mm jr lc ld mn ju lf lg mo li lj lk mp lm ln lo mq lq lr ls ij bi translated">该方法返回一个<a class="ae kv" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir">数据帧</strong> </a>的采样子集。</p><p id="c1bb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><strong class="kz ir"> <em class="lt">参数:</em> </strong></p><blockquote class="ng nh ni"><p id="dd11" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir">有替换的</strong> —有替换或没有替换的样本(默认值设置为假)。<strong class="kz ir">(可选)</strong></p><p id="94fc" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir"> — withReplacement=True: </strong>同一个元素在样本的最终结果集中有被重现多次的概率。</p><p id="bf81" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir"> — withReplacement=False </strong>:数据的每一个特征只被采样一次。</p><p id="aacb" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir">分数</strong> —要生成的行的分数，范围[0.0，1.0]。<strong class="kz ir">(必选)</strong></p><p id="9d82" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir">种子</strong> —抽样的种子(默认为随机种子)<strong class="kz ir">(可选)</strong></p></blockquote><p id="d947" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><strong class="kz ir"> <em class="lt">注:</em> </strong> <em class="lt">不保证准确提供给定</em> <a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame" rel="noopener ugc nofollow" target="_blank"> <em class="lt">数据帧</em> </a> <em class="lt">的总计数的指定分数。</em></p><h1 id="82a2" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">2.抽样依据()</h1><p id="c4a9" class="pw-post-body-paragraph kx ky iq kz b la mm jr lc ld mn ju lf lg mo li lj lk mp lm ln lo mq lq lr ls ij bi translated">另一种可以作为采样方法的技术是<a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sampleBy" rel="noopener ugc nofollow" target="_blank"><strong class="kz ir">sample by()</strong></a><strong class="kz ir"><em class="lt">。</em></strong></p><p id="2d32" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">第一个参数是<strong class="kz ir"> <em class="lt"> col </em> </strong>字段，它决定在采样过程中对哪个变量进行子分组和采样。</p><p id="941c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">例如，如果<strong class="kz ir">位置</strong>写在该域中，将根据<strong class="kz ir">位置</strong>值进行采样。<strong class="kz ir">位置</strong>下的值将包含在采样中的百分比在<strong class="kz ir"> <em class="lt">分数</em> </strong>字段中确定，这是另一个参数。不是强制填充，如果不是，则设置为0，没有指定分数率的值将不包括在抽样中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/ffe7aac74c8b27272ff4fbfadcf2cf48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ji7wpJ87lrC8AzVGTQB_kg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd kw">图三。</strong>位置特征在数据集中的分布(图片由作者提供)</p></figure><p id="fd6f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在下面的例子中，选择了数据集字段中具有<strong class="kz ir"> CA </strong>的元素的<strong class="kz ir"> 50% </strong>，具有<strong class="kz ir"> TX、</strong>的元素的<strong class="kz ir"> 30% </strong>，以及具有<strong class="kz ir"> WI </strong>的元素的最后<strong class="kz ir"> 20% </strong>。在本例中，<em class="lt"> 1234 </em> id被分配给<strong class="kz ir"> <em class="lt">种子</em> </strong>字段，也就是说，每次运行脚本时都将选择用<em class="lt"> 1234 </em> id选择的样本。如果<strong class="kz ir"> <em class="lt">种子</em> </strong>值保留为<strong class="kz ir"> <em class="lt">无</em> </strong>，则在执行过程中每次都会选择不同的样本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/a4168a80a5175bbc357b49b7639816ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QX_2-kBIGj7V4JFY6AmCXg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd kw">图4。</strong>所有“位置”变量的值都在“分数”参数中指定(图片由作者提供)</p></figure><p id="dfa5" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">下面再举一个例子，dataset字段中带有<strong class="kz ir"> CA </strong>的元素的<strong class="kz ir"> 60% </strong>，带有<strong class="kz ir"> TX </strong>的元素的<strong class="kz ir"> 20% </strong>被选中，由于没有指定所有其他元素的百分比，所以它们没有包含在最终的采样结果集中。在本例中，再次将<em class="lt"> 1234 </em> id分配给<strong class="kz ir"> <em class="lt">种子</em> </strong>字段，也就是说，每次运行脚本时都将选择用<em class="lt"> 1234 </em> id选择的样本。如果<strong class="kz ir"> <em class="lt">种子</em> </strong>值保留为<strong class="kz ir"> <em class="lt">无</em> </strong>，则在执行过程中每次选择不同的样本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/f525dbe9732919a47777d258b33ab0fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O_BaV9tiZ4PggqVFwZiFKw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd kw">图5。</strong>在“分数”中只指定了“位置”变量的两个值(图片由作者提供)</p></figure><h2 id="b1a3" class="mu lv iq bd lw mv mw dn ma mx my dp me lg mz na mg lk nb nc mi lo nd ne mk nf bi translated">sampleBy(列，分数，种子=无)</h2><p id="2a32" class="pw-post-body-paragraph kx ky iq kz b la mm jr lc ld mn ju lf lg mo li lj lk mp lm ln lo mq lq lr ls ij bi translated">这种方法返回一个分层样本，而不根据每个层上给出的分数进行替换。</p><p id="8adc" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><strong class="kz ir"> <em class="lt">参数:</em> </strong></p><blockquote class="ng nh ni"><p id="9039" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir"> col </strong> —定义地层的列</p><p id="fb7b" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir">分数</strong> —每个地层的取样分数。如果未指定地层，其分数将被视为零。</p><p id="c35a" class="kx ky lt kz b la lb jr lc ld le ju lf nj lh li lj nk ll lm ln nl lp lq lr ls ij bi translated"><strong class="kz ir">种子</strong>—随机种子id。</p></blockquote></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><p id="05bd" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">非常感谢您的提问和评论！</p></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><h2 id="231e" class="mu lv iq bd lw mv mw dn ma mx my dp me lg mz na mg lk nb nc mi lo nd ne mk nf bi translated">参考</h2><ol class=""><li id="d9b2" class="nv nw iq kz b la mm ld mn lg nx lk ny lo nz ls oa ob oc od bi translated"><a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sample" rel="noopener ugc nofollow" target="_blank">样品</a></li><li id="7431" class="nv nw iq kz b la oe ld of lg og lk oh lo oi ls oa ob oc od bi translated"><a class="ae kv" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/sql/dataframe.html#DataFrame.sampleBy" rel="noopener ugc nofollow" target="_blank">取样依据</a></li><li id="f5d0" class="nv nw iq kz b la oe ld of lg og lk oh lo oi ls oa ob oc od bi translated"><a class="ae kv" href="https://www.investopedia.com/terms/s/simple-random-sample.asp" rel="noopener ugc nofollow" target="_blank">简单随机抽样</a></li><li id="93c5" class="nv nw iq kz b la oe ld of lg og lk oh lo oi ls oa ob oc od bi translated"><a class="ae kv" href="https://www.investopedia.com/terms/stratified_random_sampling.asp" rel="noopener ugc nofollow" target="_blank">分层抽样</a></li></ol></div></div>    
</body>
</html>