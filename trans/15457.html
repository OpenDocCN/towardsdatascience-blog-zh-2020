<html>
<head>
<title>Query and analyze Stripe data in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python中查询和分析条带数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-and-analyze-stripe-data-in-python-e6b4c3dd349?source=collection_archive---------12-----------------------#2020-10-24">https://towardsdatascience.com/query-and-analyze-stripe-data-in-python-e6b4c3dd349?source=collection_archive---------12-----------------------#2020-10-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="968d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">MRR和流失计算</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/81cecdedaefabd39ee367fab52656b1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uAxT0lN8bgD7RQpQRCaqA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://unsplash.com/photos/ZVprbBmT8QA" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/ZVprbBmT8QA</a></p></figure><p id="d8aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Stripe是一家在线支付公司，提供用于处理支付和业务管理的软件和API。我喜欢Stripe为不同的语言提供不同的API，这让人们的生活变得轻松了许多。</p><p id="478a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我主要使用Stripe Python API。要安装:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7e98" class="ma mb it lw b gy mc md l me mf">pip install --upgrade stripe</span></pre><p id="01e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也可以做<code class="fe mg mh mi lw b">conda install stripe</code>。但是该库的最新版本似乎还没有在Conda上提供。我使用的版本是Stripe 2.55.0。</p><p id="38d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您将需要一个API密钥来访问条带API。转到stripe.com—开发者— API密钥，然后点击“+创建密钥”获取API密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/917a74939c37b72349597facd2a175c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bCUU8_EEFPtWtawWSxx30A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:stripe.com</p></figure><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a74f" class="ma mb it lw b gy mc md l me mf">stripe.api_key = YOUR_API_KEY<br/>stripe.api_version = "2020-08-27"</span></pre><p id="54f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以定义条带api_key，并且不要忘记定义api_version。我使用的是最新版本。如果您使用不同版本的API，某些功能/数据格式会有所不同。</p><h1 id="10cf" class="mk mb it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">获取条带数据</h1><p id="25b5" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">很好，现在一切都设置好了，我们可以开始查询条带数据了。这里我写了一个函数来获取数据。</p><ul class=""><li id="1a00" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">条带API包含许多资源(数据集)。在这个函数中，我们可以传入资源的名称来获取相应的数据。例如，获取订阅数据的基本格式是<code class="fe mg mh mi lw b">stripe.Subscription.list()</code>。我们在函数中使用了<code class="fe mg mh mi lw b">getattr</code>,以便将资源作为参数包含在函数中。</li><li id="d1b8" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">我们使用<code class="fe mg mh mi lw b">list</code> API批量获取资源。</li><li id="ff0a" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">每个API调用最多返回100个对象。这就是为什么我们使用<code class="fe mg mh mi lw b">auto_page_iter()</code>来自动给列表结果分页。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="49e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这个函数，我们可以简单地调用函数来获取所有时间或定义的时间段的不同资源。例如:</p><ul class=""><li id="2ca2" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">客户数据:<code class="fe mg mh mi lw b">stripe_get_data('Customer')</code></li><li id="6863" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">事件数据:<code class="fe mg mh mi lw b">stripe_get_data('Event')</code>(仅返回过去30天的事件)</li><li id="a9ab" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">发票数据:<code class="fe mg mh mi lw b">stripe_get_data('Invoice')</code></li><li id="3267" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">余额交易数据:<code class="fe mg mh mi lw b">stripe_get_data('BalanceTransaction')</code></li><li id="f18c" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">订阅数据:<code class="fe mg mh mi lw b">stripe_get_data('Subscription', start_date=datetime(2020,9,1), end_date=datetime(2020,10,1))</code>(如果没有指定，只返回“活动”和“过期”状态的订阅)。</li></ul><p id="bc23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其他资源可以在<a class="ae ky" href="https://stripe.com/docs/api/" rel="noopener ugc nofollow" target="_blank"> Stripe API文档</a>中找到。您也可以使用这个函数查询其他资源。</p><h1 id="e5c9" class="mk mb it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">条带计费分析仪表板</h1><p id="5cfc" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">stripe Billing Analytics Dashboard提供了您的帐户的汇总视图，其中提供了许多有用的信息，如MRR、客户流失等。不幸的是，没有用于条带计费分析仪表板的API(我实际上联系了支持人员并询问了这个问题)。所以，我不能把仪表板直接放到Python上。但是Stripe确实就他们如何计算这些指标提供了一些指导。我按照说明，计算了MRR和流失率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/c8ad5911d7a48a9d49d010dd4edc9400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9X0tIalOUoYQgkrs3Htf3g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:stripe.com/docs/dashboard</p></figure><h1 id="e84c" class="mk mb it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">维护、修理和更换</h1><blockquote class="nx ny nz"><p id="b832" class="kz la oa lb b lc ld ju le lf lg jx lh ob lj lk ll oc ln lo lp od lr ls lt lu im bi translated">每月经常性收入(MRR)可以被认为是您可以可靠地预期在经常性基础上收到的每月收入总额。这是SAAS企业要跟踪的最重要的指标之一，因为它提供了对增长和预测收入的前瞻性衡量…您可以通过对当时收取费用的所有订阅的每月标准化金额求和来计算大致的MRR。</p></blockquote><p id="5409" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计算MRR的语法如下所示。</p><ul class=""><li id="f9af" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">首先，我们需要获得所有的订阅数据。这里我设置<code class="fe mg mh mi lw b">status="all"</code>来获取所有订阅数据，包括取消的订阅。我们也不能包含此参数来仅获得“活动”和“过期”状态，因为我们在此计算中不使用“已取消”状态。</li><li id="16a0" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">然后我们得到关于订阅计划的信息，即金额和间隔(年度或月度计划)。</li><li id="b9e3" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">如果有人的计划有折扣，我们会得到有关折扣的信息。</li><li id="e215" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">接下来，我们通过标准化年度金额并应用折扣来计算标准化的<strong class="lb iu">月度</strong>计划金额。</li><li id="9460" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">最后，MRR被计算为那些具有“活动”或“过期”状态的人的标准化<strong class="lb iu">每月</strong>计划金额的总和。</li></ul><p id="5df8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个计算是基于<a class="ae ky" href="https://support.stripe.com/questions/understanding-monthly-recurring-revenue-(mrr)" rel="noopener ugc nofollow" target="_blank">条纹文章</a>和一篇<a class="ae ky" href="https://hellowebbooks.com/news/calculating-mrr-with-stripe/" rel="noopener ugc nofollow" target="_blank">博客文章</a>。结果值看起来与仪表板上显示的值略有不同。但是已经很近了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="74aa" class="mk mb it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">流失率</h1><blockquote class="nx ny nz"><p id="bec6" class="kz la oa lb b lc ld ju le lf lg jx lh ob lj lk ll oc ln lo lp od lr ls lt lu im bi translated">流失率的计算方法是，将过去30天内流失的用户总数除以30天前的活跃用户数，再加上这30天内新增的用户数。</p></blockquote><p id="e60a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是计算流失率的代码。</p><ul class=""><li id="2ad1" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">首先，我们计算过去30天内的用户数量。我们可以使用事件数据，也可以使用订阅数据，查看在过去30天内谁取消了订阅。</li><li id="63fa" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">其次，我们计算活动订阅或过期订阅的数量。</li><li id="e5ea" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">然后我们可以根据这两个数字计算出流失率。</li></ul><p id="4ec8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该计算基于这篇<a class="ae ky" href="https://support.stripe.com/questions/calculating-churn-rate-in-billing" rel="noopener ugc nofollow" target="_blank">文章</a>中的描述。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="fab0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您知道了如何查询条带数据并计算MRR和流失率。希望你喜欢这篇文章。谢谢！</p><h1 id="8759" class="mk mb it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">参考</h1><div class="oe of gp gr og oh"><a href="https://stripe.com/docs/api" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">条带API参考</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">Stripe API的完整参考文档。包括我们的Python的代表性代码片段和示例…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">stripe.com</p></div></div></div></a></div><p id="9794" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://support.stripe.com/questions/billing-analytics-dashboard" rel="noopener ugc nofollow" target="_blank">https://support . stripe . com/questions/billing-analytics-dashboard</a></p></div></div>    
</body>
</html>