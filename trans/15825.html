<html>
<head>
<title>How I made my girlfriend happy with a Telegram Bot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用电报机器人让我的女朋友开心</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-i-made-my-girlfriend-happy-with-a-simple-telegram-bot-2be8e4b150e7?source=collection_archive---------17-----------------------#2020-10-31">https://towardsdatascience.com/how-i-made-my-girlfriend-happy-with-a-simple-telegram-bot-2be8e4b150e7?source=collection_archive---------17-----------------------#2020-10-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7b1a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在我的树莓Pi上构建电报机器人的短暂旅程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/13df7f1e7165ce50c643ab8507a7dce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DiE2v9sAEc0EYr00"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@jeshoots?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">JESHOOTS.COM</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="4b46" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将解释我设计的电报机器人的实现细节:<strong class="ky ir">家庭下载器</strong>。</p><p id="b5b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">家庭下载器允许用户轻松地从互联网上下载视频，然后在他们喜欢的任何设备上观看。它是由用户的简单请求触发的，用户将请求发送到所选的URL。收到文本后，<strong class="ky ir"> home-downloader </strong>会检查不需要的用户。然后，它将相关视频下载到一个目录中，该目录存储在Raspberry Pi上，可通过本地网络访问。最后，Pi会将视频播放到用户选择的屏幕上，而用户则可以尽情享用一些受之无愧的爆米花。</p><h1 id="230e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题是</h1><p id="8245" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我家里有两台电视，一台是<em class="mp">智能</em>的，第二台……没那么多。为了帮助第二个(主要由我的女朋友使用)跟上新的花哨技术，我买了一个小米Mi Box S。然而，仍然缺少一些东西:我的女朋友不为所动，尽管她可以访问任何发明的媒体服务。问题:她想播放她在网上找到的视频，但有些视频太重，无法通过Mi Box打开。Chromecast也不是一个可行的选择，因为它不允许她从这样的网站上播放视频！</p><blockquote class="mq mr ms"><p id="21b3" class="kw kx mp ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">废话！这让我陷入了困境…当我的全新PS5到来时，我该怎么办？谁会宣称智能电视的所有权？！</p></blockquote><p id="57f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我决定解决这个问题，并告诉她</p><h1 id="810f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决方案</h1><p id="bc97" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">好了，让我们建立一些约束/要求:</p><ul class=""><li id="1203" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">我不想在这上面花钱，我想用家里现有的东西。</li><li id="c72a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">任何一种<strong class="ky ir">用户交互</strong>都应该尽可能流畅，我女朋友不是计算机科学家，也不是科技爱好者:)</li><li id="629e" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><strong class="ky ir"> Python </strong>！</li></ul><p id="3b33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我向工程师提出的解决方案必须解决以下问题:</p><ul class=""><li id="22d1" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">给我一个网址，我能下载视频吗？</li><li id="9587" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">Android盒子将如何访问下载的视频？</li><li id="ab9a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">以上两点如何实现自动化？</li><li id="768a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">最好的用户界面是什么？</li></ul><p id="7e61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">原来下载网络视频最简单的方法是youtube-dl。这款软件的优势之一是它不仅适用于YouTube:)</p><blockquote class="mq mr ms"><p id="94ed" class="kw kx mp ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">tbh，不是每个网站都能用的，不过好在兼容的网站列表还挺大的。是啊。</p></blockquote><p id="ef51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我决定从我的Raspberry Pi (RPI)运行<em class="mp"> youtube-dl </em>并将视频保存在RPI上托管的文件夹中，并与<a class="ae kv" href="https://www.samba.org/samba/what_is_samba.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">桑巴</strong> </a>共享。这个文件夹对于位于同一个本地网络的Android Box (AB)是可见的。</p><p id="fa05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在仍然缺少一个重要的部分:从AB读取视频。在这一点上，我很确定VLC会成功。从AB访问Samba目录是非常简单的……除非你使用的是VLC桌面！因此，试图将AB和VLC合并是一个巨大的混乱…事实上，我发现这是一个非常著名的，仍然没有解决的问题。但是后来<a class="ae kv" href="https://kodi.tv/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> KODI </strong> </a>出来帮我:易如反掌:)</p><p id="eef4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">至此，我才明白<strong class="ky ir"> home-downloader </strong>应该是一个<strong class="ky ir">电报机器人</strong>。我懒得实现任何接口/API，但也不想把工作外包给:D电报公司！因此，我决定让用户与电报机器人互动，也就是通过简单的聊天。毕竟，Telegram已经提供了实现这一点所需的所有API。</p><p id="457e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在下面看到完整的建筑图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/b31814c7f0250ef043b443f7e24ec7f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rh-3t0zF2UD5bfF5w_GJwg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由作者创建</p></figure><h1 id="ce07" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">履行</h1><p id="59f9" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我选择的语言是Python 3.8。</p><p id="e7eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该项目由两个<em class="mp">组成。py </em>脚本和一个<em class="mp">。json </em>配置文件:</p><ul class=""><li id="3f03" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">它存储了Bot令牌和其他一些我们不想硬编码到python脚本中的信息。</li><li id="2442" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><strong class="ky ir"> modules.py </strong>它包含三个函数。</li><li id="5d46" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><strong class="ky ir">home _ downloader . py</strong>main。</li></ul><p id="69a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在深入了解代码的本质之前，这里是我的设置:</p><ul class=""><li id="c6be" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">我使用了一个名为<a class="ae kv" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank"> python-telegram-bot </a>的不错的库，它为原始的电报API提供了友好的接口。</li><li id="20e4" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">我在我的<a class="ae kv" href="https://www.raspberrypi.org/products/raspberry-pi-2-model-b/?resellerType=home" rel="noopener ugc nofollow" target="_blank"> Raspberry Pi 2 Model B </a>上运行<a class="ae kv" href="https://archlinuxarm.org/" rel="noopener ugc nofollow" target="_blank">拱臂</a>，并且我按照这个<a class="ae kv" href="https://wiki.archlinux.org/index.php/samba" rel="noopener ugc nofollow" target="_blank">拱臂</a>提供的指导方针设置桑巴。</li><li id="c2a8" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">我之前用<em class="mp">机器人父亲机器人</em>注册了一个电报机器人，目的是引导用户完成注册。<a class="ae kv" href="https://core.telegram.org/bots" rel="noopener ugc nofollow" target="_blank">官方指南</a>会给你一个相当透彻的介绍。</li></ul><h2 id="fb6a" class="nl lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">配置文件</h2><p id="80fc" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这里，我们保存:<strong class="ky ir">a)</strong>home-downloader Bot的秘密令牌；<strong class="ky ir"> b) </strong>可以与机器人交互的用户列表，<strong class="ky ir"> c) </strong>主人(这里是我)与机器人聊天的ID。</p><p id="8954" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于<strong class="ky ir"> c) </strong>，出于隐私考虑，我不想让任何未经授权的用户进入！因此，当新用户开始与<strong class="ky ir"> home-downloader </strong>聊天时，它会检查该用户是否属于预先确定的白名单。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="dc55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">备注</strong>:在部署机器人之前，所有者必须读取他和机器人之间的聊天ID并保存到配置文件中。这是每次新用户开始与机器人聊天时，从机器人向主人发送直接消息的唯一方式:<strong class="ky ir">电报机器人不能在给定用户名的情况下发送直接消息。</strong></p><p id="3fa7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要找出聊天ID，只需与机器人开始一个新的对话，并在我们将要看到的一个函数中打印这个属性:</p><pre class="kg kh ki kj gt nz oa ob oc aw od bi"><span id="19b9" class="nl lt iq oa b gy oe of l og oh">update.message.chat_id</span></pre><h2 id="05ba" class="nl lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">模块</h2><p id="1be8" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">该项目包括三个主要功能。</p><p id="7621" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们设置了一个日志记录器:当你在后台运行几天时，检索关于脚本执行的信息是很有用的！其次，我们打开<em class="mp">。json </em>配置，这样项目的所有功能都可以看到它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="ff64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的函数是<em class="mp"> youtube-dl </em>的包装器，由<em class="mp">子进程</em>执行。<em class="mp">子进程</em>库允许您从Python运行bash命令并返回输出。执行的结果用于确定视频是否被正确下载。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="1625" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们必须绑定聊天动作和触发电报机器人的命令。正如我上面提到的，每当一个新用户开始一个对话时，以及当一条新消息被发送时，这个机器人应该被触发。</p><p id="9d5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">欢迎</strong>功能在每次用户开始聊天时打印一条欢迎消息(即通过习惯的<em class="mp"> /start </em>命令)。而且，当前聊天的用户的用户名随后被发送给主人(我！)，在<em class="mp"> config.json </em>文件中定义。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="7565" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，<strong class="ky ir">incoming _ message _ action</strong>函数对新消息的处理进行编码。对每条消息进行解析，以发现URL(第8–11行)。</p><p id="e3fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果URL被批准，该函数将检查网站域(第14行):事实上，我可能希望只允许某些网站被用作来源。原因很简单:我不想让我的RPI在没有我的允许下下载数十亿字节的资料！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="52a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能已经注意到函数<strong class="ky ir"> incoming_message_action </strong>和<strong class="ky ir"> welcome </strong>有一些共同点。首先，它们接受两个名为<em class="mp">更新</em>和<em class="mp">上下文</em>的参数，这两个参数包含触发机器人的用户的信息和聊天消息。其次，它们都共享这段代码:</p><pre class="kg kh ki kj gt nz oa ob oc aw od bi"><span id="46a2" class="nl lt iq oa b gy oe of l og oh">if update.message.chat.username not in config["valid_users"]:<br/>    return False</span></pre><p id="7991" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面代码片段的目的是检查与聊天交互的用户是否被允许这样做。</p><blockquote class="mq mr ms"><p id="43f1" class="kw kx mp ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">这是将bot的使用限制在特定用户范围内的唯一方法。希望Telegram能添加一个合适的特性来做到这一点。</p></blockquote><h2 id="023a" class="nl lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">家庭下载器</h2><p id="d65b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><strong class="ky ir"> home_downloader.py </strong>把我们目前看到的内容汇总在一起。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="86bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">机器人被初始化，处理程序基于我们到目前为止看到的函数被创建。</p><p id="8305" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，通过调用函数<strong class="ky ir"> start_polling </strong>来启动bot。</p><h1 id="38de" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="bfcf" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本文中，我想展示我如何处理现实生活中的问题以及我实现的解决方案。我试图强调每个决定背后的创造过程。</p><p id="53de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是项目的GitHub链接。由于这是一项正在进行的工作，一些代码可能与本文中的略有不同:我已经在开发一些新的特性和改进。无论如何，上面的代码是你构建自己的Bot并根据你的需要定制它所需要的全部。</p></div><div class="ab cl oi oj hu ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="ij ik il im in"><h2 id="8f33" class="nl lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">特别感谢阅读和评论这篇文章草稿的人们:</h2><p id="1e61" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">加布里埃尔·约马佐和克里斯蒂安·孔特雷拉斯·坎帕纳</p></div></div>    
</body>
</html>