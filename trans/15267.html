<html>
<head>
<title>Emulating a PID Controller with Long Short-term Memory: Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模拟具有长短期记忆的PID控制器:第3部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-3-23da7df3e033?source=collection_archive---------27-----------------------#2020-10-20">https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-3-23da7df3e033?source=collection_archive---------27-----------------------#2020-10-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5b40" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用LSTM控制温度控制实验室</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ac90655b795e5468d98fce522e0bdf53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wRFNVCt4JxRH7M9-"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Johannes Plenio 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="3755" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">欢迎来到这个项目的第3部分！现在，你的雇主正在看着你的结果，说“那又怎么样？”你已经做了很多跑腿的工作，但是到目前为止，它只是在电脑上看起来不错。嗯，这是“那又怎样”的部分。这就是我们最终实现这个LSTM神经网络来模拟PID控制器行为的地方。简单回顾一下，我们已经走过的路和将要去的地方如下:</p><ol class=""><li id="edf0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@nrlewis929/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08" rel="noopener">使用温度控制实验室创建比例积分微分控制器数据</a></li><li id="cc13" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47" rel="noopener">在Keras中训练一个长短期记忆神经网络，以模拟PID控制器</a></li><li id="6b58" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">用LSTM控制温度控制实验室(本文)</li><li id="c21f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b" rel="noopener">用LSTM控制器代替PID控制器进行温度控制的实际应用</a></li></ol><p id="59aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和往常一样，你可以自由地自己运行<a class="ae ky" href="https://github.com/nrlewis929/TCLab_emulate_PID" rel="noopener ugc nofollow" target="_blank">代码</a>，最好是和温度控制实验室<a class="ae ky" href="http://apmonitor.com/pdc/index.php/Main/ArduinoTemperatureControl" rel="noopener ugc nofollow" target="_blank">一起运行，这样你就可以看到实时数据。</a></p><h1 id="4c12" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">最后一次检查</h1><p id="6375" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">虽然我们上次检查了LSTM控制器的输出，但我们还是想先练习安全。我们不想在运行像反应堆温度这样敏感的东西时调试我们的控制回路。因此，首先，我们将保留我们的PID控制器，但也计算LSTM控制器输出。这使我们能够看到我们编程的LSTM控制器与PID控制器相比做了什么，并对其进行调试。</p><p id="bf91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，您对此已经很熟悉了，但是设置跑步只需要做一些调整:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="8197" class="nl mk it nh b gy nm nn l no np">#### Set up run ####</span><span id="a7b5" class="nl mk it nh b gy nq nn l no np"># Import model and model parameters<br/>model = load_model('pid_emulate.h5')<br/>model_params = pickle.load(open('model_params.pkl', 'rb'))</span><span id="2f20" class="nl mk it nh b gy nq nn l no np">s_x = model_params['Xscale']<br/>s_y = model_params['yscale']<br/>window = model_params['window']</span><span id="5546" class="nl mk it nh b gy nq nn l no np"># Run time in minutes<br/>run_time = 30.0</span><span id="aab4" class="nl mk it nh b gy nq nn l no np"># Number of cycles<br/>loops = int(60.0*run_time)</span><span id="8ff0" class="nl mk it nh b gy nq nn l no np"># arrays for storing data<br/>T1 = np.zeros(loops) # measured T (degC)<br/>Qpid = np.zeros(loops) # Heater values for PID controller<br/>Qlstm = np.zeros(loops) # Heater values for LSTM controller<br/>tm = np.zeros(loops) # Time</span><span id="22b5" class="nl mk it nh b gy nq nn l no np"># Temperature set point (degC)<br/>with tclab.TCLab() as lab:<br/>    Tsp = np.ones(loops) * lab.T1</span><span id="3c10" class="nl mk it nh b gy nq nn l no np"># vary temperature setpoint<br/># leave 1st window + 15 seconds of temp set point as room temp<br/>end = window + 15 <br/>while end &lt;= loops: <br/>    start = end<br/>    # keep new temp set point value for anywhere from 4 to 10 min<br/>    end += random.randint(240,600) <br/>    Tsp[start:end] = random.randint(30,70)</span><span id="c128" class="nl mk it nh b gy nq nn l no np"># leave last 120 seconds as room temp<br/>Tsp[-120:] = Tsp[0]</span></pre><p id="b497" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将注意到的第一件事是，我们从训练运行中加载了模型和预处理参数。这些匹配很重要，否则结果会很糟糕，或者根本不起作用。我跑了30分钟，因为我只需要看到足够多的东西来确信它是可行的，而不是试图生成足够多的高质量数据来训练LSTM。我还有两个独立的加热器阵列，一个存储PID输出，一个存储LSTM输出。最后，在最后2分钟，我把我的温度设定值调回到室温。通常你不需要担心这个，但是因为我连续做了两次测试，这使得第二次测试从接近室温开始，而不需要在两次测试之间额外等待几分钟。</p><p id="1fa1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们编写的控制回路将与PID控制器相同(如果需要，请参见<a class="ae ky" rel="noopener" target="_blank" href="/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08">第1部分</a>复习)，只是现在我们还想看看LSTM控制器会输出什么。我已经把它放在一个函数<code class="fe nr ns nt nh b">lstm(T1_m,Tsp_m)</code>中，但是我建议先把它直接放在代码中以便调试。<code class="fe nr ns nt nh b">T1_m</code>是LSTM模型传感器1的温度，我们将在每个时间点读取，而<code class="fe nr ns nt nh b">Tsp_m</code>是LSTM模型的设定点温度。让我们来看看我们用它做什么。</p><p id="4add" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，计算误差，确保它与我们在<a class="ae ky" href="https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47" rel="noopener">第二部分</a>中训练LSTM时计算的方法相同。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="fe55" class="nl mk it nh b gy nm nn l no np"># Calculate error (necessary feature for LSTM input)<br/>err = Tsp_m - T1_m</span></pre><p id="69a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要将现有的数据转换成LSTM所期望的格式，因此用与第2部分相同的方式将其放入一个数组中，对其进行缩放和整形。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="b418" class="nl mk it nh b gy nm nn l no np"># Format data for LSTM input<br/>X = np.vstack((Tsp_m,err)).T<br/>Xs = s_x.transform(X)<br/>Xs = np.reshape(Xs, (1, Xs.shape[0], Xs.shape[1]))</span></pre><p id="8a49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了输入数据，我们可以调用<code class="fe nr ns nt nh b">model.predict()</code>函数来获得加热器输出。回想一下，这是一个缩放值，对我们的实际加热器没有多大用处，所以我们取消了对真实值的缩放。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e18d" class="nl mk it nh b gy nm nn l no np"># Predict Q for controller and unscale<br/>Q1c_s = model.predict(Xs)<br/>Q1c = s_y.inverse_transform(Q1c_s)[0][0]</span></pre><p id="5acd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，正如我们在第2部分培训时注意到的，有时LSTM会预测有效[0，100]范围之外的值，因此我们将只限制可能的输出值。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="901e" class="nl mk it nh b gy nm nn l no np"># Ensure Q1c is between 0 and 100<br/>Q1c = np.clip(Q1c,0.0,100.0)</span></pre><p id="117a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你能明白我为什么决定在安装之前测试和调试它！</p><p id="1f00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们在控制回路中时，最后要做的一件事。回想一下，我们指定了一个特定的数据点窗口作为LSTM输入的历史。我们必须等到有了那个数量的数据点，才能向LSTM控制器输入任何东西。这是这个模拟器的一个潜在的缺点，也是为什么你想保持窗口适当低的一个原因。然而，在最初的窗口期过后，事情就一帆风顺了。下面是控制循环中的最终实现:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="f629" class="nl mk it nh b gy nm nn l no np"># Run LSTM model to get Q1 value for control<br/>if i &gt;= window:<br/>   # Load data for model<br/>   T1_m = T1[i-window:i]<br/>   Tsp_m = Tsp[i-window:i]<br/>   # Predict and store LSTM value for comparison<br/>   Qlstm[i] = lstm(T1_m,Tsp_m)</span></pre><p id="3129" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还保存了一些控制器行为的快照，并把它们放入视频中。让我们看看它是如何工作的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/2dc8e6d901157e1458d6f0632b519498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*CEfDmOHfT79OWF-eB-1n2Q.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者的情节</p></figure><p id="3a17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相当惊人！请记住，蓝线(PID)是真正控制加热器，绿色(LSTM)只是作为参考。它不完全匹配，我也不一定期望它匹配。LSTM控制器看起来更倾向于降低加热器值，这可能会导致现实生活中的超调量增加。它通常也会有较低的输出，但由于高温往往更危险，我很高兴看到它更保守。总的来说，看起来我们已经编程正确，所以我相信LSTM运行加热器输出值来控制温度。让我们看看接下来会是什么样子。</p><h1 id="6583" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">用LSTM控制</h1><p id="870f" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在，我们期待已久的！让我们把控制器交给LSTM。这里真的没有什么新东西，但是为了完整起见，这里是我的代码看起来像使用LSTM来控制加热器输出，模拟PID控制器的行为。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1967" class="nl mk it nh b gy nm nn l no np"># Run test<br/>with tclab.TCLab() as lab:<br/>    # Find current T1, T2<br/>    print('Temperature 1: {0:0.2f} °C'.format(lab.T1))<br/>    print('Temperature 2: {0:0.2f} °C'.format(lab.T2))</span><span id="6e7b" class="nl mk it nh b gy nq nn l no np">    start_time = time.time()</span><span id="5e7a" class="nl mk it nh b gy nq nn l no np">    for i in tqdm(range(loops)):<br/>        # Delay 1 second<br/>        if time.time() &gt; prev_time + 1.0:<br/>            print('Exceeded cycle time: ',time.time()-prev_time-1.0)<br/>        else:<br/>            while time.time() &lt; prev_time + 1.0:<br/>                pass</span><span id="dcdd" class="nl mk it nh b gy nq nn l no np">        # Record time<br/>        t = time.time()<br/>        tm[i] = t - start_time</span><span id="9214" class="nl mk it nh b gy nq nn l no np">        # Read temperature (C)<br/>        T1[i] = lab.T1</span><span id="b2c0" class="nl mk it nh b gy nq nn l no np">        # Run LSTM model to get Q1 value for control<br/>        if i &gt;= window:<br/>            # Load data for model<br/>            T1_m = T1[i-window:i]<br/>            Tsp_m = Tsp[i-window:i]<br/>            # Predict and store LSTM value for comparison<br/>            Qlstm[i] = lstm(T1_m,Tsp_m)</span><span id="c6f9" class="nl mk it nh b gy nq nn l no np">        # Write heater output (0-100)<br/>        lab.Q1(Qlstm[i])</span></pre><p id="a18f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们表现如何？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/71c62a4bcd96cbc0de90b499dc708600.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*lSwNQnYutSoSeuoLTSbhhA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者的情节</p></figure><p id="0bda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哇哦。我不知道你怎么想，但这是令人兴奋的事情。我们成功地复制了具有LSTM神经网络的PID控制器的行为，并能够实时地将它用于全新的数据来控制温度。这就是机器学习如此令人兴奋的原因！</p><h1 id="2df4" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">最后的想法</h1><p id="1153" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">当然，你可能会注意到一些需要改进的地方。控制器在运行中期很难将温度一直提高到70°c。我们总是可以调整LSTM模型中的超参数，并且拥有更多训练数据也无妨(还有什么其他想法可以提高LSTM控制器对PID控制器的保真度？).但是即使LSTM控制器与PID控制器不完全匹配，它仍然完成了模拟行为的目标，这本身就是令人兴奋的！</p><p id="b159" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，你的老板还在疑惑“那又怎样？”如果PID控制器已经做了我们想要的事情，这又有什么意义呢？这就是我们接下来要做的，所以请留下来进行一些更刺激的探索吧！像往常一样，在这里随意跟随代码<a class="ae ky" href="https://github.com/nrlewis929/TCLab_emulate_PID" rel="noopener ugc nofollow" target="_blank">，希望在您自己的TCLab上，您可以在您的办公桌上运行！</a></p></div></div>    
</body>
</html>