<html>
<head>
<title>Ultimate Pandas Guide — Mastering the Groupby</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫终极指南——驾驭群体</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ultimate-pandas-guide-mastering-the-groupby-104306251739?source=collection_archive---------17-----------------------#2020-09-27">https://towardsdatascience.com/ultimate-pandas-guide-mastering-the-groupby-104306251739?source=collection_archive---------17-----------------------#2020-09-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/c897e116f479b45d985fb09e0e68cf54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*8vlXYOWJrVHPeGQdCObkZQ.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">劳拉·伍德伯里摄于<a class="ae jc" href="https://www.pexels.com/photo/panda-bear-on-green-grass-3608263/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a></p></figure><div class=""/><div class=""><h2 id="4930" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">加深对“分组”和“聚集”的理解</h2></div><p id="4ee5" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">数据分析中最常见的练习之一是将数据分组并执行聚合。</p><p id="8f73" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，假设您有几个不同维度的客户销售数据:</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lq"><img src="../Images/0c4ef96991eedc78718353fe38cab535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xZJVGCXiqNo9xmJjIFpalA.png"/></div></div></figure><p id="a228" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一个自然的问题可能是问——各州的总销售额是多少？还是按性别？还是按月？</p><p id="7476" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇文章中，我将介绍熊猫“groupby”的来龙去脉，帮助你自信地回答Python中的这类问题。</p><h1 id="b33b" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">“分组”数据的可视化表示</h1><p id="62b6" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">记住“分组”是做什么的最简单的方法是把它分成三个步骤:“分割”、“应用”和“组合”。</p><p id="d627" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">1.<strong class="kw jg"> Split: </strong>这意味着基于数据中的一列创建单独的组。例如，我们可以将销售数据分成<strong class="kw jg">个月。</strong></p><p id="0932" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">2.<strong class="kw jg">应用:</strong>这意味着我们对每个组执行一个功能。例如，我们可以<strong class="kw jg">合计</strong>每个月的销售额。</p><p id="c36a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">3.<strong class="kw jg">合并</strong>:这意味着我们返回一个新的数据表，包含“应用”阶段的每个结果。</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mw"><img src="../Images/efe1e297f7539bfcf3048f75b5c79b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RnpCYSH0ZnG51ngblMWHtQ.png"/></div></div></figure><p id="388b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">“groupby”的神奇之处在于它可以帮助你在非常紧凑的代码中完成所有这些步骤。</p><h1 id="d860" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">在熊猫中进行“分组”</h1><p id="f484" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">为了获得每月的销售额，我们可以简单地运行以下命令:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="f09c" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby('month').agg(sum)[['purchase_amount']]</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/7978f0c5a8025a7029e6f2828455ab14.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*msKkKIVab0YtNaL9Pr3ceg.png"/></div></figure><h1 id="e7b2" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">了解熊猫的“分裂”步骤</h1><p id="9a67" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">首先要指出的是，当我们运行上面的代码时，我们实际上是在运行两个不同的函数——groupby和agg——其中group by处理“拆分”阶段，agg处理“应用”阶段。</p><p id="4f83" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，下面的代码实际上将我们的数据分成“月”组:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="7236" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby('month')</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ni"><img src="../Images/8da921657091e0ab3eb6504da184429f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oO7TXU7kDJ5U2i-Dfm008A.png"/></div></div></figure><p id="a8da" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">虽然这个输出并不特别有趣，但是在到达聚合阶段之前，我们还可以对这个对象做一些事情:</p><ol class=""><li id="9b91" class="nj nk jf kw b kx ky la lb ld nl lh nm ll nn lp no np nq nr bi translated"><strong class="kw jg">查看“组”属性:</strong></li></ol><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="666f" class="nc ma jf my b gy nd ne l nf ng">grouped = sales_data.groupby('month')<br/>grouped.groups</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ns"><img src="../Images/0c49e8853b8de960d187aef159bb8d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D2Z-Yek-cbg2BgKJnjLB5A.png"/></div></div></figure><p id="0732" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意,“groups”属性返回一个字典，它的键是组，值是每个组的行索引。</p><p id="17ab" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw jg"> 2。使用“获取组”方法检查单个组:</strong></p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="b300" class="nc ma jf my b gy nd ne l nf ng">grouped.get_group('August')</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nt"><img src="../Images/c9fdd34b93b336331cac447957f70bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Gljx9SZmTaJFXflofNm0w.png"/></div></div></figure><p id="4723" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw jg"> 3。遍历每个组:</strong></p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="6890" class="nc ma jf my b gy nd ne l nf ng">for name, group in grouped:<br/>    print(name, group)</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nu"><img src="../Images/782c8117e165fc6ae7e1d505629e6a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9cSD9V8B-pYEDfnItaSDA.png"/></div></div></figure><h1 id="02fd" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">了解熊猫的“agg”步骤</h1><p id="7044" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">现在我们来探讨一下“agg”函数。</p><p id="e8d8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以传递给“agg”的最简单的东西是我们想要在每个组上执行的聚合的名称:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="8783" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby('month').agg(sum)</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/706e90864cc25b333444507ccdf661f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*4f3EORu9Q6yWHzVtngzTHw.png"/></div></figure><p id="d806" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，这种方法将返回数据帧中所有可用数字列的总和。</p><p id="043b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，在本例中，返回“year”或“customer_id”列的总和没有任何意义。我们可以通过使用我们希望在agg调用结束时看到的列列表进行索引来解决这个问题:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="00e8" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby('month').agg(sum)[['purchase_amount']]</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/7978f0c5a8025a7029e6f2828455ab14.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*msKkKIVab0YtNaL9Pr3ceg.png"/></div></figure><p id="7226" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们也可以用一个单独的列进行索引(与list相反):</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="e5b1" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby('month').agg(sum)['purchase_amount']</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/e8fe0281cfc5366c50a00c42b96b4356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*WsaF2KgHPjzYdPoXCxb1Cg.png"/></div></figure><p id="4785" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这种情况下，我们得到的是一个Series对象，而不是DataFrame。我倾向于使用数据框架，所以我通常选择第一种方法。</p><h1 id="202c" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">高级“分组依据”概念</h1><p id="0343" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">现在我们已经有了基本的东西，让我们来看看我们能做的一些更高级的事情。</p><h2 id="f4df" class="nc ma jf bd mb nx ny dn mf nz oa dp mj ld ob oc ml lh od oe mn ll of og mp oh bi translated">多重聚合</h2><p id="6bc1" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">首先，假设我们想要总销售额<strong class="kw jg">和每月平均销售额</strong>。为此，我们可以向“agg”传递一个函数列表:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="e0cc" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(‘month’).agg(<strong class="my jg">[sum, np.mean]</strong>)[‘purchase_amount’]</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/f3075e3a9175595cea40d71dbd7a8cc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*pynjPyxK4DpuBnMZT_JmDQ.png"/></div></figure><p id="a77e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是有帮助的，但是现在我们被以聚合函数命名的列(即总和及平均值)。</p><p id="2478" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我们想要为多个列返回多个聚合时，这就变得更加困难了:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="c968" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(‘month’).agg(<strong class="my jg">[sum, np.mean]</strong>)[[‘purchase_amount’, 'year']]</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/867d1c13d1e30209aa8401ddeeecf521.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*XtL8QKQOjQkHJAMa0LYFiw.png"/></div></figure><p id="7c99" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这种情况下，我们坚持使用<a class="ae jc" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/advanced.html" rel="noopener ugc nofollow" target="_blank">多索引</a>作为列名:</p><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ok"><img src="../Images/6ed5508cf56afa30b765336b05ae91bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PWBp8anLeE41gFhuC_nsCw.png"/></div></div></figure><p id="2bee" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了解决这个问题，我们可以利用Pandas提供的“NamedAgg”对象。这里的语法有点不同，但是我们的输出非常清楚地表明了这里发生的事情:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="0099" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(“month”).agg(<br/>   total_sales=pd.NamedAgg(column=’purchase_amount’, aggfunc=sum),<br/>   avg_sales=pd.NamedAgg(column=’purchase_amount’, aggfunc=np.mean),<br/>   max_year=pd.NamedAgg(column=’year’, aggfunc=max))</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/40346f840914869877c847619f42b4c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*7BgDX3EqQQlJCS3yn8xd3w.png"/></div></figure><p id="e3c8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是一种非常有用的机制，可以在不同的列上执行多种功能，同时保持对输出中列名的控制。</p><p id="fce8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们还可以向agg函数传递一个字典，但是这并没有给我们提供相同的灵活性来命名我们得到的列:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="4501" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(“month”).agg( </span><span id="a056" class="nc ma jf my b gy om ne l nf ng">        {‘purchase_amount’: [sum, np.mean],<br/>        ‘year’: [max]}</span><span id="b92a" class="nc ma jf my b gy om ne l nf ng">)</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/f23bf7da3cdd36ed3318771b5214ac5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*tLiZlLuF032Re33MnhIkEQ.png"/></div></figure><h2 id="d8c8" class="nc ma jf bd mb nx ny dn mf nz oa dp mj ld ob oc ml lh od oe mn ll of og mp oh bi translated">多列分组</h2><p id="47c6" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">我们可能想做的另一件事是按月份和州获取总销售额。</p><p id="f928" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了按多列分组，我们只需将一个列表传递给group by函数:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="43a4" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(["month", "state"]).agg(sum)[['purchase_amount']]</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/52df84f75780a28790649ca44eb1b090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*3hD0Vvg-X-XpxDM-l9CnlQ.png"/></div></figure><p id="424a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您还会注意到我们的“分组关键字”——月份和州——已经成为我们的索引。通过运行“reset_index”函数，我们可以很容易地将它们转换成列:</p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="c96a" class="nc ma jf my b gy nd ne l nf ng">g = sales_data.groupby([“month”, “state”]).agg(sum) </span><span id="fe2f" class="nc ma jf my b gy om ne l nf ng">g[[‘purchase_amount’].reset_index()</span></pre><figure class="lr ls lt lu gt iv gh gi paragraph-image"><div class="gh gi op"><img src="../Images/688fb40a2d212bf783a950d9eb90250f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*fQKIA5ULjKm1eKVxX5uQag.png"/></div></figure><h1 id="1192" class="lz ma jf bd mb mc md me mf mg mh mi mj kl mk km ml ko mm kp mn kr mo ks mp mq bi translated">结束语</h1><p id="79c9" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">一旦你对“分割-应用-组合”方法有了坚实的直觉，在Pandas中运行“分组”就相当简单了。</p><p id="636c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">尽管如此，当您第一次熟悉这些函数时，仍然可能会遇到语法问题。如果您面临错误，我建议您更仔细地查看您传递的数据类型。</p><p id="4f4d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，如果您正在运行类似于下面的代码，请确保您正在将一个函数列表的<strong class="kw jg">传递给agg，并且您正在将一个列列表</strong>的<strong class="kw jg">放置在另一组括号内以进行列索引:</strong></p><pre class="lr ls lt lu gt mx my mz na aw nb bi"><span id="e0b9" class="nc ma jf my b gy nd ne l nf ng">sales_data.groupby(‘month’).agg(<strong class="my jg">[sum, np.mean]</strong>)[<strong class="my jg">[‘purchase_amount’, ‘year’]</strong>]</span></pre><p id="d991" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">关于熊猫索引的快速回顾，请查看我下面的直观指南。编码快乐！</p><figure class="lr ls lt lu gt iv"><div class="bz fp l di"><div class="oq or l"/></div></figure></div></div>    
</body>
</html>