<html>
<head>
<title>How to Fix Cassandra Consistency Issues using Read Repair</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用读取修复修复Cassandra一致性问题</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-fix-cassandra-consistency-issues-using-read-repair-6dd45911819d?source=collection_archive---------21-----------------------#2020-09-19">https://towardsdatascience.com/how-to-fix-cassandra-consistency-issues-using-read-repair-6dd45911819d?source=collection_archive---------21-----------------------#2020-09-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7c9db59e61d6d1cd5879a93c91dd9ab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RlGB6bwCsZBXS-Ym"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kf" href="https://unsplash.com/@louishansel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Louis Hansel @shotsoflouis </a>拍摄的照片</p></figure><h1 id="ced4" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">为什么CAP定理中存在一致性问题或C</h1><p id="1a18" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">很多人可能都知道，Cassandra是AP大数据存储。换句话说，当网络分区发生时，Cassandra仍然可用，并放松了一致性属性。人们总是说它最终是一致的，或者换句话说，它将在未来的某个时间点上是一致的。</p><p id="b7dc" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">需要知道的不太明显的重要事项是:</p><ul class=""><li id="2bf6" class="mh mi it lg b lh mc ll md lp mj lt mk lx ml mb mm mn mo mp bi translated"><strong class="lg iu">集群</strong>变<strong class="lg iu">经常不一致</strong>。当然，有许多因素会影响群集的稳定性，例如适当的配置、专用资源、生产负载、运营人员的专业水平等，但事实是，节点不时出现故障从而导致数据变得不一致的可能性非常高。</li><li id="d155" class="mh mi it lg b lh mq ll mr lp ms lt mt lx mu mb mm mn mo mp bi translated">该集群不会自动<strong class="lg iu">或</strong>再次变得一致<strong class="lg iu">。</strong>这与上帝对现代成熟分布式系统的感觉背道而驰。除非您有企业版的Datastax并启用了DSE v6的最新功能，否则您必须手动修复不一致问题<strong class="lg iu">。</strong></li></ul><h1 id="6962" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">修复不一致的方法</h1><p id="c843" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">幸运的是，有一些方法可以解决不一致的问题。这里有几个选项:</p><ul class=""><li id="0896" class="mh mi it lg b lh mc ll md lp mj lt mk lx ml mb mm mn mo mp bi translated"><strong class="lg iu"> nodetool维修工具</strong>。这可能是要使用的主要和默认方法。在所有表或特定表关闭的节点上运行命令。不过有一点需要注意:当您运行命令时，所有的节点都应该处于运行状态。</li><li id="d70c" class="mh mi it lg b lh mq ll mr lp ms lt mt lx mu mb mm mn mo mp bi translated"><strong class="lg iu">阅读修复</strong>卡珊德拉特写。这是一个重要的特征，意味着在读取请求期间，集群有机体正在自我修复，更准确地说，它修复正确的数据副本。如果读取请求中涉及的复制副本不一致，则会再次对齐它们</li></ul><h1 id="b840" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">何时及为何阅读修复</h1><p id="7d8c" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如上所述，修复不一致的默认和主要方法是nodetool修复工具，因此自然的问题是何时以及为什么使用read修复方法。让我用我的一个项目的经验来回答这个问题。</p><p id="927a" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在某个时候，我们进入了一个时期，此时我们的Cassandra集群开始变得非常不稳定，并且花费了大量的时间，直到所有节点再次返回到运行状态。这导致了两个主要后果:</p><ul class=""><li id="dc23" class="mh mi it lg b lh mc ll md lp mj lt mk lx ml mb mm mn mo mp bi translated">数据不一致</li><li id="b411" class="mh mi it lg b lh mq ll mr lp ms lt mt lx mu mb mm mn mo mp bi translated">在此期间，无法使用nodetool修复工具来修复不一致</li></ul><p id="5f8b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这种情况下，我们能做的最好的事情就是使用读取修复功能来确保至少在大多数复制副本中，在仲裁级别，数据是一致的，因此对于使用仲裁一致性级别的所有读取，数据都是一致的和最新的</p><h1 id="28c0" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">如何使用读取修复</h1><p id="7e11" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">读修复特性只修复读操作所涉及的记录的一致性，那么如何修复整个表呢？</p><p id="5a81" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">可以使用以下方法:</p><ul class=""><li id="93e5" class="mh mi it lg b lh mc ll md lp mj lt mk lx ml mb mm mn mo mp bi translated">选择一个最窄的列进行阅读</li><li id="8c53" class="mh mi it lg b lh mq ll mr lp ms lt mt lx mu mb mm mn mo mp bi translated">使用copy命令读取整个表，将数据导出到文件中</li></ul><p id="f953" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">因此，让我们考虑在一个keyspace“test”中有一个Cassandra表“event”，其中一个最窄的列称为“id”；复制命令如下所示:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="484c" class="ne kh it na b gy nf ng l nh ni">cqlsh -e "consistency QUORUM; copy test.event(fid) to '/tmp/tid'"</span></pre><p id="4c56" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">或者，您可以读取整个记录并将它们发送到'/dev/null ':</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f790" class="ne kh it na b gy nf ng l nh ni">cqlsh -e "consistency QUORUM; copy test.event to '/dev/null'"</span></pre><p id="31ac" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">当然，当所有节点都启动时，您可以使用consistency ALL，但在这种情况下，最好使用nodetool修复工具，如下所示:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="0187" class="ne kh it na b gy nf ng l nh ni">nodetool repair test event</span></pre><h1 id="f0b4" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="bdb4" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Cassandra是伟大的大数据存储，但为了充分利用它，它需要很好地理解主要原则，它是如何工作的，就像任何美丽的东西一样，它需要一些小心:)</p></div></div>    
</body>
</html>