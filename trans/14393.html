<html>
<head>
<title>Implementing an XGBoost Model in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在R中实现XGBoost模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/implementing-an-xgboost-model-in-r-59ee1892be2f?source=collection_archive---------18-----------------------#2020-10-04">https://towardsdatascience.com/implementing-an-xgboost-model-in-r-59ee1892be2f?source=collection_archive---------18-----------------------#2020-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6367" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用XGBoost预测酒店取消预订</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/020ae8338dfbd7c97288285d1d28d4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FSswaFfJhtBuvwXtjc6eRw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:图片来自<a class="ae ky" href="https://pixabay.com/vectors/interface-internet-program-browser-3614766/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="ec8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，在R中构建了一个XGBoost模型来预测客户取消酒店预订的发生率。该分析基于来自<a class="ae ky" href="https://www.sciencedirect.com/science/article/pii/S2352340918315191" rel="noopener ugc nofollow" target="_blank"> Antonio、Almeida和Nunes (2019):酒店预订需求数据集</a>的数据。</p><p id="72f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">H1数据集用于训练和验证，而H2数据集用于测试目的。</p><h1 id="293f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">背景</h1><p id="3377" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了预测将取消预订的客户(其中变量<strong class="lb iu">is cancelled = 1</strong>表示取消，而<strong class="lb iu">is cancelled = 0</strong>表示客户坚持预订)，在R中构建了一个XGBoost模型，具有以下特性:</p><ul class=""><li id="1728" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">研制周期</li><li id="1298" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">原产国</li><li id="d1ad" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">细分市场</li><li id="2986" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">存款类型</li><li id="1282" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">客户类型</li><li id="0e85" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">所需的停车位</li><li id="a6cf" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">抵达周</li></ul><h1 id="1bec" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据操作</h1><p id="eacb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了使数据适合用R中的XGBoost模型进行分析，需要一些数据操作过程。</p><p id="50da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，加载<strong class="lb iu"> xgboost </strong>和<strong class="lb iu">矩阵</strong>库:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="d7d1" class="nl lw it nh b gy nm nn l no np">require(xgboost)<br/>library(Matrix)</span></pre><p id="7edb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过将变量<strong class="lb iu">定义为. numeric </strong>，并在适当的时候以因子格式定义，形成特征的数据框架。然后数据帧被转换成<strong class="lb iu">矩阵</strong>格式。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="bf99" class="nl lw it nh b gy nm nn l no np">leadtime&lt;-as.numeric(H1$LeadTime)<br/>country&lt;-as.numeric(factor(H1$Country))<br/>marketsegment&lt;-as.numeric(factor(H1$MarketSegment))<br/>deposittype&lt;-as.numeric(factor(H1$DepositType))<br/>customertype&lt;-as.numeric(factor(H1$CustomerType))<br/>rcps&lt;-as.numeric(H1$RequiredCarParkingSpaces)<br/>week&lt;-as.numeric(H1$ArrivalDateWeekNumber)</span><span id="7b6c" class="nl lw it nh b gy nq nn l no np">df&lt;-data.frame(leadtime,country,marketsegment,deposittype,customertype,rcps,week)<br/>attach(df)<br/>df&lt;-as.matrix(df)</span></pre><p id="fbda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标签(取消)被定义为一个因素。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e519" class="nl lw it nh b gy nm nn l no np">IsCanceled&lt;-as.numeric(factor(H1$IsCanceled))</span></pre><p id="0e72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，R将<strong class="lb iu"> 0 </strong>值标记为<strong class="lb iu"> 1 </strong>，将<strong class="lb iu"> 1 </strong>值标记为2。</p><p id="d91e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使数据与XGBoost一起工作，必须定义0和1标签。</p><p id="e625" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，标签值相应地替换如下:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="5045" class="nl lw it nh b gy nm nn l no np">IsCanceled[IsCanceled == "1"] &lt;- "0"<br/>IsCanceled[IsCanceled == "2"] &lt;- "1"</span></pre><p id="b4d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">训练集和验证集是分开的，每个都被定义为一个<strong class="lb iu">dgc matrix</strong>——这是一种特殊类型的矩阵，与r中的XGBoost模型一起工作。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="6180" class="nl lw it nh b gy nm nn l no np">train &lt;- df[1:32000,]<br/>val &lt;- df[32001:40060,]</span><span id="23d2" class="nl lw it nh b gy nq nn l no np">train=as(train, "dgCMatrix")<br/>train</span><span id="71c8" class="nl lw it nh b gy nq nn l no np">val=as(val, "dgCMatrix")<br/>val</span><span id="59b0" class="nl lw it nh b gy nq nn l no np">IsCanceled_train=IsCanceled[1:32000]<br/>IsCanceled_val=IsCanceled[32001:40060]</span></pre><h1 id="591a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">模型预测</h1><p id="7ab6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">定义增压模型并生成预测:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="700f" class="nl lw it nh b gy nm nn l no np">bst &lt;- xgboost(data = train, label = IsCanceled_train, max.depth = 2, eta = 1, nthread = 2, nrounds = 2, objective = "binary:logistic")</span><span id="9dac" class="nl lw it nh b gy nq nn l no np">pred &lt;- predict(bst, val)</span></pre><p id="5a7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是培训和验证错误:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a122" class="nl lw it nh b gy nm nn l no np">&gt; bst &lt;- xgboost(data = train, label = IsCanceled_train, max.depth = 2, eta = 1, nthread = 2, nrounds = 2, objective = "binary:logistic")<br/>[1] train-error:0.252000 <br/>[2] train-error:0.222188</span><span id="143e" class="nl lw it nh b gy nq nn l no np">&gt; pred &lt;- predict(bst, val)<br/>&gt; print(length(pred))<br/>[1] 8060<br/>&gt; print(head(pred))<br/>[1] 0.31375486 0.31375486 0.31375486 0.31375486 0.01498148<br/>[6] 0.01498148<br/><br/>&gt; prediction &lt;- as.numeric(pred &gt; 0.5)<br/>&gt; print(head(prediction))<br/>[1] 0 0 0 0 0 0<br/><br/>&gt; err &lt;- mean(as.numeric(pred &gt; 0.5) != IsCanceled_val)<br/>&gt; print(paste("val-error=", err))<br/>[1] "val-error= 0.1287841191067"</span></pre><p id="5bc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从上面的输出中，我们可以看到<strong class="lb iu"> 0.12 </strong>的验证误差明显低于<strong class="lb iu"> 0.25 </strong>和<strong class="lb iu"> 0.22 </strong>两个报告的训练误差。</p><p id="65e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还会生成一个重要性矩阵，以确定对酒店取消最重要的影响因素:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="8084" class="nl lw it nh b gy nm nn l no np"># Importance Matrix<br/>importance_matrix &lt;- xgb.importance(model = bst)<br/>print(importance_matrix)<br/>xgb.plot.importance(importance_matrix = importance_matrix)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/0e3b0ec7ce144f517071ce79afe36b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*W8Rljr5z58noIXKqZoJxkw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:RStudio</p></figure><p id="3b11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是对重要性矩阵的更详细的介绍:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="50a0" class="nl lw it nh b gy nm nn l no np">&gt; print(importance_matrix)<br/>         Feature      Gain     Cover Frequency<br/>1:       country 0.3589183 0.2266091 0.3333333<br/>2:      leadtime 0.2767732 0.2807021 0.1666667<br/>3:          rcps 0.2198606 0.2967366 0.3333333<br/>4: marketsegment 0.1444479 0.1959522 0.1666667</span></pre><p id="28fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如下文所述<a class="ae ky" href="https://datascience.stackexchange.com/questions/12318/how-to-interpret-the-output-of-xgboost-importance" rel="noopener ugc nofollow" target="_blank">堆叠交换</a>后——增益、覆盖和频率说明如下:</p><ul class=""><li id="106c" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><strong class="lb iu">增益:</strong>说明了模型中每棵树的特征贡献，较高的值说明对预测结果变量更重要。</li><li id="0a2c" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><strong class="lb iu"> Cover: </strong>与所讨论的特征相关的相对观察值的数量。</li><li id="3458" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><strong class="lb iu">频率:</strong>一个特征在模型树中出现的次数。</li></ul><p id="3fe9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">增益</strong>是评估特性对模型的相对贡献时最重要的特性。由于国家变量的增益为<strong class="lb iu"> 0.35 </strong>，这被表示为模型中最重要的特征，即客户的原籍国将对决定他们最终是否取消酒店预订产生重大影响。</p><h2 id="a22d" class="nl lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">解释</h2><p id="22b3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">通过观察训练和验证错误，看起来该模型在预测该特定验证集的取消方面表现得相当好，但是不能保证它在其他数据集上也能如此。</p><p id="5982" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们使用了一个独立的测试集(H2)来验证XGBoost模型是否仍能很好地预测取消发生率。</p><p id="e246" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">H2集合中的变量再次被定义:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="9dc1" class="nl lw it nh b gy nm nn l no np">leadtime&lt;-as.numeric(H2$LeadTime)<br/>country&lt;-as.numeric(factor(H2$Country))<br/>marketsegment&lt;-as.numeric(factor(H2$MarketSegment))<br/>deposittype&lt;-as.numeric(factor(H2$DepositType))<br/>customertype&lt;-as.numeric(factor(H2$CustomerType))<br/>rcps&lt;-as.numeric(H2$RequiredCarParkingSpaces)<br/>week&lt;-as.numeric(H2$ArrivalDateWeekNumber)</span><span id="3846" class="nl lw it nh b gy nq nn l no np">test&lt;-data.frame(leadtime,country,marketsegment,deposittype,customertype,rcps,week)<br/>attach(test)<br/>test&lt;-as.matrix(test)</span><span id="f1a3" class="nl lw it nh b gy nq nn l no np">test=as(test, "dgCMatrix")<br/>test</span><span id="ca5d" class="nl lw it nh b gy nq nn l no np">IsCanceled_H2&lt;-as.numeric(factor(H2$IsCanceled))<br/>IsCanceled_H2[IsCanceled_H2 == "1"] &lt;- "0"<br/>IsCanceled_H2[IsCanceled_H2 == "2"] &lt;- "1"<br/>IsCanceled_H2&lt;-as.numeric(IsCanceled_H2)</span></pre><p id="a9be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用H1数据集构建的XGBoost模型现在用于合并H2的要素数据:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="5728" class="nl lw it nh b gy nm nn l no np">pred &lt;- predict(bst, test)</span></pre><p id="085d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是产生的测试错误:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="b720" class="nl lw it nh b gy nm nn l no np">&gt; print(length(pred))<br/>[1] 79330<br/>&gt; print(head(pred))<br/>[1] 0.3137549 0.7707853 0.7707853 0.7707853 0.7707853 0.7707853<br/>&gt; <br/>&gt; prediction &lt;- as.numeric(pred &gt; 0.5)<br/>&gt; print(head(prediction))<br/>[1] 0 1 1 1 1 1<br/>&gt; <br/>&gt; err &lt;- mean(as.numeric(pred &gt; 0.5) != IsCanceled_H2)<br/>&gt; print(paste("test-error=", err))<br/>[1] "test-error= 0.274335056094794"</span></pre><p id="982b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 0.27 </strong>的测试误差高于<strong class="lb iu"> 0.12 </strong>的验证误差，这是我们在预测新数据时可以合理预期的。</p><p id="5a66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，0.25和0.22的原始训练误差仅略低于测试误差——这表明该模型没有显示出过度拟合的证据。如果我们遇到训练误差远低于测试误差的情况，那么这显然是一个问题，因为它表明模型在预测用于建立模型的数据而不是新数据方面表现良好。</p><h1 id="d679" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="a895" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这个例子中，您已经看到了如何使用r运行XGBoost模型。</p><p id="9bea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">具体来说，您已经看到:</p><ul class=""><li id="6680" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">如何将数据转换成<strong class="lb iu"> dgCMatrix </strong>格式，以便与R的XGBoost模型一起工作</li><li id="dc48" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">如何通过重要性矩阵可视化特征的重要性</li><li id="0509" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">对测试数据运行XGBoost模型，以验证模型的准确性</li></ul><p id="7ceb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢您的阅读，非常感谢您的任何问题或反馈。您可以在下面找到这个例子的相关存储库、R代码和数据集，以及其他有用的参考资料。</p><h1 id="efd7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><ul class=""><li id="598c" class="ms mt it lb b lc mn lf mo li od lm oe lq of lu mx my mz na bi translated"><a class="ae ky" href="https://www.sciencedirect.com/science/article/pii/S2352340918315191" rel="noopener ugc nofollow" target="_blank">安东尼奥、阿尔梅达和努内斯(2019):酒店预订需求数据集</a></li><li id="192a" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="https://datascience.stackexchange.com/questions/12318/how-to-interpret-the-output-of-xgboost-importance" rel="noopener ugc nofollow" target="_blank">数据科学StackExchange:如何解读XGBoost重要性的输出？</a></li><li id="4df2" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="https://github.com/MGCodesandStats/hotel-modelling" rel="noopener ugc nofollow" target="_blank">GitHub:MGCodesandStats/酒店建模</a></li><li id="f61f" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="https://xgboost.readthedocs.io/en/latest/R-package/xgboostPresentation.html" rel="noopener ugc nofollow" target="_blank"> XGBoost文档:XGBoost R教程</a></li></ul></div></div>    
</body>
</html>