<html>
<head>
<title>Automate your Cloud SQL data synchronization to BigQuery with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Airflow自动将云SQL数据同步到BigQuery</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automate-your-cloud-sql-data-synchronization-to-bigquery-with-airflow-7f9d992da18f?source=collection_archive---------14-----------------------#2020-11-02">https://towardsdatascience.com/automate-your-cloud-sql-data-synchronization-to-bigquery-with-airflow-7f9d992da18f?source=collection_archive---------14-----------------------#2020-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2bdf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用私有IP连接和云SQL代理保护您的数据和工作负载</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6c6c962b18dabdab21ba855a392bd395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SNY6U-w9HDwlMIpC"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">斯科特·韦伯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c0b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你正在使用GCP (Google Cloud Platform)来存储你的数据，很可能你正在使用BigQuery作为你的数据仓库或者数据湖解决方案(或者作为它的一部分)。存储交易数据的一些解决方案包括数据存储、云扳手和云SQL。在许多情况下，尤其是从本地迁移到GCP时，云SQL是事务性数据的自然选择，因为它提供了托管MySQL和PosgreSQL。</p><p id="8250" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有许多方法可以将云SQL数据同步到BigQuery。一个解决方案是使用带有云SQL  BigQuery特性的<a class="ae kv" href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries?hl=en" rel="noopener ugc nofollow" target="_blank">联邦查询。尽管这种解决方案具有速度快、成本低的优势，但它至少有一个限制:还不可能将云SQL联邦查询与私有云SQL实例一起使用，这意味着留给您的是不太安全的公共实例。本文介绍了一种高度安全、自动化和生产就绪的方式，将您的云SQL数据导入BigQuery。</a></p><h2 id="09e8" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">你会得到什么</h2><p id="1caa" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在本文结束时，您将获得</p><ol class=""><li id="e543" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr mv mw mx my bi translated">在GCP上构建云SQL数据同步到BigQuery工作流的详细分步指南。</li><li id="4bb1" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">访问包含用于构建工作流程的所有材料的gitlab存储库。您将能够使用存储库代码作为实现您自己的数据同步工作流的起点。</li></ol><h2 id="3c96" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">你需要跟进什么</h2><p id="8570" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这篇文章对于至少对GCP有基本了解的读者来说是最有价值的。如果你想知道这三个字母代表什么，我建议你花点时间<a class="ae kv" href="https://www.coursera.org/learn/gcp-fundamentals" rel="noopener ugc nofollow" target="_blank">在这里</a>好好了解一下GCP。我还假设你接触过阿帕奇气流和库伯内特斯。如果不是这样，你可以在Udemy上查看<a class="ae kv" href="https://www.udemy.com/course/the-complete-hands-on-course-to-master-apache-airflow/" rel="noopener ugc nofollow" target="_blank">这篇</a>优秀的气流介绍。你也可以在这里找到Kubernetes <a class="ae kv" href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" rel="noopener ugc nofollow" target="_blank">的快速入门。</a></p><p id="8034" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要跟进，你需要的是一个GCP项目。如果你没有可用的项目，或者如果你只是想在现有项目中不产生任何费用的情况下尝试一下，你可以创建一个新的谷歌账户，并使用该账户创建一个<a class="ae kv" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">免费的</a> GCP账户和项目。</p><h2 id="c939" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">你会做什么</h2><p id="8d5d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在接下来的几分钟内，您将:</p><ol class=""><li id="920b" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr mv mw mx my bi translated">设置Apache气流</li><li id="9cb7" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">创建云SQL实例</li><li id="5302" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">设置Airflow和云SQL之间的私有连接</li><li id="7d66" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">创建大查询数据集</li><li id="5e57" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">编写和部署数据同步任务</li><li id="9117" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">将新的模拟数据插入云SQL</li><li id="a1f2" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">监控同步任务</li></ol></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="cae9" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">设置Apache气流</h1><p id="043f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">请记住，Airflow是一种工具，其目的是协调、自动化和监控批处理作业。在我们的上下文中，实际的同步工作是通过调用GCP API来完成的，我们将在<a class="ae kv" href="#5e39" rel="noopener ugc nofollow"> <em class="nw">编写和部署数据同步任务</em> </a> <em class="nw">时看到。</em></p><p id="b847" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在GCP上安装Airflow有很多选择，包括在谷歌计算引擎或谷歌Kubernetes引擎上定制安装。在这里，我们部署了一个Google Cloud Composer环境资源，它提供了一个GKE集群(以及其他GCP资源),并在该集群上安装了Airflow。</p><p id="52b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要创建部署，请执行以下操作:</p><ul class=""><li id="47ed" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">打开您的云shell，并将其配置为使用正确的GCP项目。将<project_id>替换为您打算使用的GCP项目的ID:</project_id></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="0717" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">如果适用，启用编写器API(这可能需要2分钟)</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="dd2e" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">创建一个名为“cloud-composer”的服务帐户，并为其指定角色“roles/composer.worker”、“roles/cloudsql.client”、“roles/bigquery.user”和roles/bigquery.dataEditor。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="d443" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">使用VPC本地和专用GKE集群创建名为“data-synchronization-env”的composer环境。请耐心等待，直到<a class="ae kv" href="#09ec" rel="noopener ugc nofollow"> <em class="nw">设置好气流和云之间的私有连接SQL </em> </a>我会在这里详细介绍一下VPC本地和私有GKE集群。为环境分配“cloud-composer”服务帐户。分配给服务帐户的云SQL和BigQuery角色由Airflow用来读取云SQL数据库和创建BigQuery同步表。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="ca03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大约30分钟后，您的cloud composer环境应该在GCP项目的默认VPC网络中启动并运行。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="fc4f" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">创建云SQL实例</h1><p id="250d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们的云SQL到BigQuery同步架构的主要优势之一是，它实施了安全最佳实践。实际上，我们将使用私有实例，而不是为云SQL数据库使用公共实例。</p><p id="a7f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在创建私有云SQL实例之前，我们需要在GCP项目中的VPC网络(这里我们选择“默认”VPC网络)和云SQL实例所在的VPC网络之间创建一个VPC(虚拟私有云)对等连接。“默认”网络上的实例将能够使用该VPC对等连接连接到私有云SQL实例。要了解更多关于创建云SQL私有实例的信息，请查看<a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/configure-private-ip#gcloud" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><p id="e192" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下四个命令创建一个云SQL MySQL私有实例:</p><ul class=""><li id="0c69" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">如果适用，启用服务网络API</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="9e62" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">创建一个地址范围，并使用它来创建VPC对等连接。用您的项目id替换<project_id>(这可能需要1分钟)。</project_id></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="63c1" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">创建云SQL私有实例</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="ca7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了能够连接到SQL实例，让我们创建一个云SQL用户。我还将创建一个数据库，我们将在本文后面将其同步到BigQuery。</p><ul class=""><li id="e050" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">创建云SQL实例用户，用适当的值替换<user_name>。主机“cloudsqlproxy~%”的值使得无法从云sql代理服务器进程之外的其他地方连接到用户<user_name>的实例。</user_name></user_name></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="a3a2" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">在云SQL实例中创建一个数据库。称这个数据库为“经典模型”</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="3cfc" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">从其<a class="ae kv" href="https://sp.mysqltutorial.org/wp-content/uploads/2018/03/mysqlsampledatabase.zip" rel="noopener ugc nofollow" target="_blank"> sql转储文件</a>中导入流行的<a class="ae kv" href="https://www.mysqltutorial.org/mysql-sample-database.aspx/" rel="noopener ugc nofollow" target="_blank">‘classic models’</a>数据库。为此，我们首先创建一个GCS bucket。为了方便起见，用您的GCP项目的名称来命名这个存储桶。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="d8b1" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">复制GCS (Google云存储)中的sql转储文件。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="b0c9" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">检索云SQL实例正在使用的服务帐户:注意“serviceAccountEmailAddress”字段的值</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="1278" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">将存储桶“cloudsql-to-bigquery”上的storage.objectAdmin角色授予该服务帐户。用上一步中检索到的电子邮件地址替换<service_account_email_address/></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="feb6" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">执行转储文件导入</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="09ec" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">设置Airflow和云SQL之间的私有连接</h1><p id="e9c3" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">回想一下，我们的Airflow安装运行在一个私有的VPC本地GKE集群上。一方面，顾名思义，私有集群是一种没有为工作节点分配公共IP的集群。事实上，我们不需要通过互联网公开我们的GKE工人。首先，将公共IP分配给工作节点可能会导致安全漏洞。其次，公共IP在这里没有用，因为云SQL实例不能通过公共IP连接访问。</p><p id="fc8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，VPC本地意味着GKE集群使用别名IP地址范围将流量从一个pod路由到另一个pod。事实上，就IP路由而言，VPC本地GKE集群有许多有用的好处。例如，当启用VPC本地模式时，集群VPC网络和通过VPC网络对等连接到它的任何网络之间存在本地路由。更多关于VPC本地集群的信息可以在这里找到。</p><p id="af84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果到目前为止，为气流创建的GKE集群正在名为“default”的默认VPC内运行。至于云SQL实例，它运行在一个VPC网络中，该网络位于一个由GCP代表我们管理的项目中。既然GKE的工作人员属于两个不同的网络，并且没有公共IP，他们怎么可能与SQL实例通信呢？</p><p id="fa1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还记得我们之前在我们的项目“默认”VPC网络和云SQL实例所在的VPC网络之间建立了一个VPC对等连接。这意味着我们的GKE工作人员和我们的云SQL实例可以通过私有IP连接进行本地通信，这要归功于启用了VPC本地模式。您可以在云控制台上找到有关这种对等的详细信息。</p><p id="0a98" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开云控制台，点击菜单(左上角的汉堡图标)，向下滚动直到找到‘VPC网络’。悬停在“VPC网络”上。在下拉列表中，单击“VPC网络对等”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/16ac44d22f91aa7f9d86bd447bbe0f44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2URwmI5rGfZCkJdofHsxPQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GKE集群VPC网络和云SQL托管网络之间的VPC对等连接，图片由作者提供</p></figure><p id="31dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，我们已经为云SQL到BigQuery的同步作业做好了准备，因为执行这些作业的GKE工作人员无法从互联网上访问。然而，我们可以更进一步，加密GKE(或气流)和云SQL之间的连接。</p><p id="3ea9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">传统上，这是使用SSL证书完成的，这意味着配置和管理SSL证书的开销。</p><p id="9015" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">加密到云SQL实例的连接的一种更简单的方法是使用云SQL代理。云SQL代理的工作方式是，让一个本地进程(称为代理客户端)运行在连接发起的环境中，让一个“远程”进程(称为代理服务器)运行在与云SQL实例相同的环境中。请访问这个<a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/sql-proxy?hl=en" rel="noopener ugc nofollow" target="_blank">文档</a>，获得关于云SQL代理的全面解释。</p><p id="223b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在GKE上安装SQL代理，方法是创建一个运行SQL代理进程的pod，然后创建一个服务在内部向集群公开该pod。</p><p id="8119" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是在到达那里之前，我们需要设置kubectl二进制文件来与集群通信。为了实现这一目标:</p><ul class=""><li id="1303" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">通过运行以下命令获取GKE群集名称。复制“名称”字段下的值</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="552e" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">连接到集群并配置kubectl二进制文件。用先前命令的值替换<cluster_name/></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="7b3f" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">获取云外壳服务器IP地址</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="3bf8" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">将云shell服务器列入白名单，以便GKE集群主服务器接受来自它的传入连接。确保在上一步中将<cluster_name>替换为集群名称，将<shell_server_ip_address>替换为IP地址</shell_server_ip_address></cluster_name></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="79fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在准备在GKE集群上安装SQL代理。首先，在集群中为代理相关资源创建一个名称空间。为此，创建一个空文件，并将其命名为“namespace.yaml”。然后将以下内容复制到文件中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建cloud-sql-to-bq命名空间的GKE清单</p></figure><p id="e6c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在创建名称空间:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="47a5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后创建一个名为“pod.yaml”的文件。然后将以下内容复制到文件中。请确保用您的GCP项目ID的值替换<project_id>。</project_id></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建云sql代理pod的GKE清单</p></figure><p id="6e88" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">继续创建运行云SQL代理流程的pod</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="6196" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，代理运行在GKE集群内的pod“cloud-SQL-proxy”的容器“airflow-sqlproxy”中。最后，创建一个名为“service.yaml”的文件，并向其中添加以下内容。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建云sql代理服务服务的GKE清单</p></figure><p id="d9dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将该清单应用到GKE集群，以实际创建服务，该服务将代理流程公开给集群中运行的其余pod。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b93a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样！我们已经在GKE工作者(以及气流工作者)和云SQL实例之间配置了一个私有的加密连接。架构现在看起来像这样:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/efc8dcb8bd252bbc9c32a10212dd1711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0GAW-kiEzf8NLxmvSUcy8g.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">架构图:为Airflow和云SQL之间的通信而设置的云SQL，图片由作者提供</p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="369e" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">创建大查询数据集</h1><p id="4090" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在您的GCP项目中创建一个bigquery数据集，以保存将要从云SQL同步的所有表。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="5e39" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">编写和部署数据同步任务</h1><p id="b4fc" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">从云SQL到BigQuery的实际数据同步是由Airflow DAG(有向无环图)处理的。DAG由三个任务组成:</p><ul class=""><li id="353e" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">第一个任务将数据从云SQL实例数据库“classicmodels”导出到之前创建的GCS存储桶。这是使用气流<a class="ae kv" href="https://airflow.apache.org/docs/stable/_modules/airflow/contrib/operators/mysql_to_gcs.html" rel="noopener ugc nofollow" target="_blank">MySqlToGoogleCloudStorageOperator</a>完成的</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b003" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">到云SQL实例的连接是私有的和加密的(因为使用了私有实例和云SQL代理)，并使用Airflow连接字符串“cloud_sql_proxy_conn”。</p><p id="f334" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要配置此连接字符串:</p><ol class=""><li id="3724" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr mv mw mx my bi translated">打开气流用户界面。打开云控制台。接下来，单击控制台右上角的菜单栏。向下滚动直到找到“Composer”并点击它。然后点击“数据-同步-环境”菜单。在出现的水平栏上，单击“环境配置”。下一步向下滚动，直到你找到“气流网络用户界面”。单击“Airflow web UI”旁边的链接。使用正确的google帐户进行身份验证。气流用户界面如下所示:</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/8ac29a56539ed5688384589e1ac84c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-sLGJMcFYLhD7hElKLCNQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流用户界面，图片由作者提供</p></figure><p id="e912" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.点击“管理”并在打开的下拉列表中选择“连接”。使用以下信息创建连接。将<user_name>替换为您之前创建的云SQL实例用户名，并点击“保存”。</user_name></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/5fbba601af401c4af5a88ba64f346a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3FMvlOEdVyNz6KvZjtzdNA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">MysqlToGoogleCloudStorageOperator的气流连接</p></figure><ul class=""><li id="bedb" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">第二个任务使用<a class="ae kv" href="https://airflow.apache.org/docs/stable/_api/airflow/contrib/operators/gcs_to_bq/index.html" rel="noopener ugc nofollow" target="_blank">GoogleCloudStorageToBigQueryOperator</a>将数据从GCS存储桶导入BigQuery表</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="b918" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">第三个任务通过<a class="ae kv" href="https://airflow.apache.org/docs/stable/_api/airflow/contrib/operators/bigquery_operator/index.html" rel="noopener ugc nofollow" target="_blank"> BigQueryOperator </a>从第二步创建的表中创建一个聚合表。为了使事情看起来更具体一些，我在这个任务中根据销售数字计算了classicmodels示例数据库中的前5名雇员。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="7460" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">创建一个名为“cloud_sql_to_bq.py”的文件，并将DAG代码片段复制到其中。</li><li id="ca35" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated">通过查找字段“dagGcsPrefix”的值来检索云合成器dags目录的名称</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="20bc" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">将文件“cloud_sql_to_bq.py”复制到Cloud Composer dags目录中</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5540" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">过一会儿，您的DAG应该开始运行，当它结束时，您应该在BigQuery数据集中找到您的新表。</p><p id="cac6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">恭喜你！您已经成功部署了数据同步DAG并实施了目标体系结构的所有部分:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/592ac5821ad325ffb9b7e6598c81eaa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-WfKfeDC_G6n67yxGMw52Q.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">架构图:云SQL数据同步到BigQuery，图片由作者提供</p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="4b99" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">将新的模拟数据插入云SQL</h1><p id="b39d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">为了让同步作业在每次运行时获取新数据，我在GKE上创建了一个CRON作业，它每2分钟运行一次，向“classicmodels”数据库的“employees”表添加新数据。</p><p id="8ef0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会在这里花太多时间讨论新的数据插入过程，因为它偏离了我们的主题。如果你有兴趣了解更多关于我是如何实现这个过程的，请耐心听我讲完，你将会看到一个Gitlab库，里面有迄今为止讨论过的所有材料。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="0309" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">监控同步任务</h1><p id="d066" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Airflow modern用户界面(UI)为任务监控提供了许多有用的功能，包括工作流和任务状态、自定义图表、使用标准SQL的即席查询。此外，Cloud Composer还提供本机<a class="ae kv" href="https://cloud.google.com/composer/docs/monitoring-dashboard" rel="noopener ugc nofollow" target="_blank">指标和仪表盘</a>来监控气流作业和GKE集群。</p><p id="8905" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">同步作业计划每2分钟运行一次(在现实生活中，您不会有这么高的运行速度)。下图显示了上次作业运行的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/a352667712a40ce74501073ea17297d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XSeSX8wTI_HbyrFs-ePTjQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">同步作业的成功dag运行执行图，按作者显示的图像</p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="c5ea" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">总结</h1><p id="c907" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在本文中，我展示了一种将数据从云SQL同步到BigQuery的安全方法，使用完全同步而不是增量同步。完整的代码可以在这个<a class="ae kv" href="https://gitlab.com/marcdjoh/cloud-sql-synchronization-bigquery-airflow" rel="noopener ugc nofollow" target="_blank"> gitlab私人仓库</a>中获得。如果你有兴趣，请发一个访问请求给我，地址是marcgeremie@gmail.com<strong class="ky ir">的</strong>，我很乐意将你添加到资源库中。</p><h1 id="e892" class="nl lt iq bd lu nm og no lx np oh nr ma jw oi jx md jz oj ka mg kc ok kd mj nv bi translated">结束注释</h1><p id="0895" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">可以肯定地说，本文中实现的架构已经可以投入生产了。尽管如此，还是有一些方法可以改进它。其中包括:</p><ul class=""><li id="b96a" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr nx mw mx my bi translated">为高可用性的云SQL实例添加故障转移副本。</li><li id="7228" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated">为云SQL实例添加一个读取副本，并从副本中读取同步作业，而不是直接从主实例中读取。</li><li id="3b9f" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated">不要使用在cloud Composer GKE集群中运行作业的操作符<a class="ae kv" href="https://airflow.apache.org/docs/stable/_modules/airflow/contrib/operators/mysql_to_gcs.html" rel="noopener ugc nofollow" target="_blank">MySqlToGoogleCloudStorageOperator</a>，考虑使用数据流或Spark操作符将表从云SQL导出到GCS。</li><li id="5a95" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated">考虑使用增量同步代替完全同步，以降低作业成本并提高性能。</li><li id="0dee" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated">本文使用了一个MySQL cloud SQL实例。然而，它可以很容易地用PosgreSQL cloud SQL实例进行复制，只需对命令进行最少的更改。</li></ul></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="cb74" class="nl lt iq bd lu nm nn no lx np nq nr ma jw ns jx md jz nt ka mg kc nu kd mj nv bi translated">参考</h1><ul class=""><li id="eaba" class="mq mr iq ky b kz ml lc mm lf ol lj om ln on lr nx mw mx my bi translated"><a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/sql-proxy?hl=en" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sql/docs/mysql/sql-proxy?hl=en</a></li><li id="0651" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated"><a class="ae kv" href="https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/concepts/private-cluster-concept</a></li><li id="2445" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated"><a class="ae kv" href="https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/concepts/alias-IPS</a></li><li id="ccad" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr nx mw mx my bi translated"><a class="ae kv" href="https://medium.com/grensesnittet/copy-data-from-cloud-sql-to-bigquery-using-apache-airflow-b51bdb277463" rel="noopener">https://medium . com/grensenittet/copy-data-from-cloud-SQL-to-big query-using-Apache-air flow-b 51 BDB 277463</a></li></ul></div></div>    
</body>
</html>