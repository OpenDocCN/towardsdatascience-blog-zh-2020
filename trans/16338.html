<html>
<head>
<title>FastAPI + AWS = robust API (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">FastAPI + AWS =健壮的API(第1部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fastapi-aws-robust-api-part-1-f67ae47390f9?source=collection_archive---------0-----------------------#2020-11-11">https://towardsdatascience.com/fastapi-aws-robust-api-part-1-f67ae47390f9?source=collection_archive---------0-----------------------#2020-11-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="eaf1" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="a83d" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">让我们用FastAPI、AWS Lambda和API Gateway构建一个可伸缩的无服务器的基于Python的REST API</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/699b00a95f08793accb442fce9f83d83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKXhiZbVs1iNYzRL9XeO1g.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">背景照片由<a class="ae lh" href="https://www.pexels.com/@spencer-selover-142259?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">斯潘塞·塞洛弗</a>拍摄，来自<a class="ae lh" href="https://www.pexels.com/photo/adult-color-palette-colorful-colors-567452/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pexels</a>——作者编辑</p></figure><p id="7252" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi me translated">astAPI彻底改变了开发现代基于Python的REST APIs的方式。从一开始，这个项目就被大公司采用，如微软、优步和网飞，而且它越来越受欢迎，我们可以通过每天增长的Github明星数量来观察。</p><p id="c8ca" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">能够构建快速、健壮、安全和可伸缩的API是任何后端(数据)工程师的必备技能。在本文中，我们将构建一个简单的REST API，以您选择的货币(<em class="mn">欧元、美元等)显示市场情绪和所选加密货币的当前价格。</em>)。</p><p id="292f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将使用<strong class="lk jd">自顶向下的方法</strong>:从打包和部署API到深入了解它的细节。在第1部分中，我们将利用Amazon Lambda和API Gateway将FastAPI代码部署到AWS。在<a class="ae lh" rel="noopener" target="_blank" href="/fastapi-aws-secure-api-part-2-1123bff28b55">未来的文章(第2部分)</a>中，我们将确保通过使用API密钥来保护我们的API。我们还将演示如何启用分布式跟踪和日志记录来跟踪应用程序的健康状况。让我们开始吧！</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="ee5b" class="mv mw it bd mx my mz dn na nb nc dp nd lr ne nf ng lv nh ni nj lz nk nl nm iz bi translated">目录:</h2><ol class=""><li id="ba26" class="nn no it lk b ll np lo nq lr nr lv ns lz nt md nu nv nw nx bi translated">用虚拟环境创建一个Pycharm项目</li><li id="800b" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">安装所需的库</li><li id="fcde" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">在本地测试API</li><li id="b084" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">打包您的代码并准备部署管道(<em class="mn">包括创建Lambda函数</em>)</li><li id="5589" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">在API网关中创建REST API</li><li id="faf2" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">将Lambda函数配置为代理，将请求从API Gateway转发到Amazon Lambda</li><li id="e903" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">将API部署到<code class="fe od oe of og b">dev</code>阶段</li><li id="82af" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">测试端点</li><li id="19d0" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">深入探究这一切是如何协同工作的</li><li id="84ae" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">使用Swagger UI演示加密货币API</li><li id="eddc" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md nu nv nw nx bi translated">结论</li></ol></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="0488" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">1.用虚拟环境创建一个Pycharm项目</h1><p id="3745" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">让我们从在Pycharm中创建一个具有虚拟环境的项目开始。你可以使用<code class="fe od oe of og b">Virtualenv</code>或<code class="fe od oe of og b">Conda</code>——随你喜欢。我一般在macOS上用<code class="fe od oe of og b">Virtualenv</code>，在Windows上用<code class="fe od oe of og b">Conda</code>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ov"><img src="../Images/cb5f9654f13f1254e964ff4368749727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y9Z8yw7fkV5jzCADgvuShQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">苹果电脑上Pycharm中的Virtualenv图片由作者提供</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ow"><img src="../Images/aab86c8812b30fe113d48c3130acdfcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPx4OAYUd3-8Uo8PAr4lJQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Windows上Pycharm中的Conda虚拟环境—图片由作者提供</p></figure><p id="40f6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你想跟进，<a class="ae lh" href="https://github.com/anna-anisienia/cryptoAPI" rel="noopener ugc nofollow" target="_blank">这个Github库</a>包含了这个项目的代码。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="0ca1" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">2.安装所需的库</h1><p id="de05" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">让我们将当前工作目录更改为<code class="fe od oe of og b">api</code>文件夹，并安装所需的包:</p><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="6160" class="mv mw it og b gy pb pc l pd pe">cd api &amp;&amp; pip<em class="mn"> </em>install -r requirements.txt</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="f19f" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">3.在本地测试API</h1><p id="3d1a" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">安装完所有的包依赖项后，我们可以在终端中启动Uvicorn ASGI服务器:</p><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="39b1" class="mv mw it og b gy pb pc l pd pe">uvicorn<em class="mn"> </em>main:app --reload</span></pre><p id="3e67" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您配置了虚拟环境，并从Github下载(或克隆)了代码，那么您应该能够从浏览器访问交互式Swagger UI:</p><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="68ec" class="mv mw it og b gy pb pc l pd pe">http://localhost:8000/docs</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pf"><img src="../Images/e0e35b2ce8606874f6cef25af2757db9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kRBFJ5JE3VOk62GJTPtnHA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我们正在构建并部署到AWS的简单API图片由作者提供</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="32b4" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">4.打包您的代码并准备部署管道</h1><p id="b1af" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">为了使我们的API可以从API Gateway访问，我们需要:</p><ul class=""><li id="d09e" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">将我们的API代码和所有的<code class="fe od oe of og b">site-packages</code>依赖项压缩成一个zip文件，这个文件将被我们的Lambda函数使用</li></ul><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pk pl l"/></div></figure><ul class=""><li id="b0ed" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">将这个zip文件上传到S3 ( <em class="mn">理论上，我们可以将它直接上传到Lambda，但是有一个10MB的zip文件大小限制</em> → <em class="mn">为了准备我们的应用程序的增长，我们将把它直接上传到S3，并且在Amazon Lambda创建期间，我们将确保Amazon Lambda使用这个来自S3的zip文件</em></li></ul><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pk pl l"/></div></figure><blockquote class="pm pn po"><p id="8fb6" class="li lj mn lk b ll lm kd ln lo lp kg lq pp ls lt lu pq lw lx ly pr ma mb mc md im bi translated">注意:本部分要求您安装并配置AWS CLI</p></blockquote><ul class=""><li id="a015" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">使用Python 3.8运行时创建Amazon Lambda函数，选择选项<em class="mn">“创建一个具有基本Lambda权限的新角色”，</em>，将Lambda处理程序配置为<code class="fe od oe of og b">main.handler</code>，如GIF所示:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ps"><img src="../Images/2699a819c2bfe5fd8f8c07efe020661f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*2_v-mn9gQKye0qib6-3xTw.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">创建一个Lambda函数+配置处理程序——图片作者</p></figure><ul class=""><li id="6e32" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">更新函数以确保它使用来自S3的打包代码(<em class="mn">我们也可以从管理控制台执行此操作</em>):</li></ul><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="d8fb" class="mv mw it og b gy pb pc l pd pe"><em class="mn">aws </em>lambda update-function-code --function-name medium-demo \<br/>--s3-bucket $bucket_name --s3-key lambda.zip</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="5b06" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">5.在API网关中创建REST API</h1><p id="803f" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">从管理控制台，确保为API Gateway中的API选择与Lambda函数相同的区域。尽管API网关和Lambda函数可能位于不同的区域，但这可能会导致<a class="ae lh" href="https://stackoverflow.com/questions/57704237/multi-region-api-lambda-architecture-latency-issue" rel="noopener ugc nofollow" target="_blank">一些额外的延迟</a>。</p><p id="3c8d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后:创建API →选择REST API ( <em class="mn">不是私有的</em> ) →构建→输入你的API的名字→创建API。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pt"><img src="../Images/ecca5adf5bc3c9b7a989fc44711596a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptyjXPAxFUd4bAdgJ0a3Rg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">创建REST API—按作者分类的图像</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pu"><img src="../Images/557703b3cce778874b85143f63816e5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1IJfcDdEgc7fVwNTJR2k5g.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">为API选择一个名称。保留区域端点—按作者分类的图像</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="04a8" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">6.将Lambda函数配置为代理，将请求从API Gateway转发到Amazon Lambda</h1><p id="ae62" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">现在我们需要为我们的请求方法配置<strong class="lk jd">集成点</strong>。使用Lambda函数作为<code class="fe od oe of og b">ANY</code>类型请求(<em class="mn">即GET、POST、PATCH、DELETE等)的集成点。</em>)，我们将创建一个<strong class="lk jd">方法</strong> ( <em class="mn">处理根路径</em>)和一个子<strong class="lk jd">资源</strong> ( <em class="mn">处理所有子路径</em>)。我们将通过使用<strong class="lk jd"> Lambda代理集成</strong> [1]来配置它们，以处理对API网关的任何请求。</p><h2 id="93c2" class="mv mw it bd mx my mz dn na nb nc dp nd lr ne nf ng lv nh ni nj lz nk nl nm iz bi translated">创建一个方法</h2><ul class=""><li id="71d0" class="nn no it lk b ll np lo nq lr nr lv ns lz nt md pj nv nw nx bi translated">从下拉菜单<strong class="lk jd">中选择动作:</strong> <br/> 1。创建方法<br/> 2。选择<code class="fe od oe of og b">ANY</code> <br/> 3。选择Lambda函数作为您的集成类型，并确保选中复选框<em class="mn">“使用Lambda代理集成”</em> <br/> 4。添加您的Lambda函数的名称(<em class="mn">及其对应的区域</em>)并保留其他所有内容的默认值→保存</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pv"><img src="../Images/156bd07329006fcce9bf15549e0d8c31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8-dgiTSQUMUrLmKj10VcoA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">1.创建方法—按作者创建图像</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pw"><img src="../Images/325ceecaf0e75753377f2ee63865c21c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2o5vdIkeFg5pY8CkR0DpWQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">2.选择任意→添加Lambda函数的名称→保存—按作者分类的图像</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi px"><img src="../Images/38eb0078ff15c25e3a510bb67742e3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-a9XH4yM5XS6wy2urCjsw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">确认权限-按作者分类的图像</p></figure><p id="498e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当弹出窗口询问您是否要授予API网关调用Lambda函数的权限时，请确认。没有它，API Gateway将无权调用您的Lambda函数。</p><h2 id="e1d2" class="mv mw it bd mx my mz dn na nb nc dp nd lr ne nf ng lv nh ni nj lz nk nl nm iz bi translated">创建资源</h2><p id="0e09" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">类似于<em class="mn">“方法”</em>配置，转到操作→创建资源。确保选中复选框<em class="mn">“配置为代理资源”</em>，并保留默认设置以启用Lambda代理集成(<em class="mn">与之前的</em>)，然后选择您的Lambda函数并保存。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi py"><img src="../Images/e2c9833a029e7db7243f76160c9c6140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rnl5P8ReZJbDIpThQ6t3dg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">创建资源-按作者分类的图像</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pz"><img src="../Images/9befa19e8a464f1130d92592f1e96051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OUmVFl-r0jv6v5IF_cmf5A.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">将Lambda配置为代理—按作者排序的图像</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qa"><img src="../Images/ecd5072f29445b2a4e7fc73665c65827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzO1I9vq5kT1OS0IGXqRMg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">从菜单中选择你的Lambda函数并保存——作者图片</p></figure><p id="c820" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">再次确认您允许API Gateway代表您的API请求调用Lambda函数:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi px"><img src="../Images/38eb0078ff15c25e3a510bb67742e3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-a9XH4yM5XS6wy2urCjsw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">确认权限-按作者分类的图像</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="2ec0" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">7.部署API</h1><p id="7234" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">既然我们的Lambda现在已经配置好了，我们就可以部署API了。我们可以把它命名为<code class="fe od oe of og b">dev</code>阶段。部署对于激活Lambda函数集成至关重要。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qb"><img src="../Images/20bd1471b7e17d682a19547556e08715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NL57UsjDeM9tfL7AcPts1A.png"/></div></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qc"><img src="../Images/1a0f0c44155f4b22e01e2fdbaf47fa01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jh0ubgMDPFQ33m6gm3-Swg.png"/></div></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="63ee" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">8.测试端点</h1><p id="5f50" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">将API部署到任何部署阶段都可以确保API Gateway创建一个URL作为API的前门。您可以点击这个URL并测试API是否已经正确配置。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qd"><img src="../Images/9625331874a35b309df960bb0b4795f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gXStBIOI9fKqkLKJRGvWIQ.png"/></div></div></figure><p id="7205" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在您的浏览器中，您应该会看到对应于FastAPI代码的根GET路径的响应:</p><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="bcaa" class="mv mw it og b gy pb pc l pd pe">{"Hello Medium Reader": "from FastAPI &amp; API Gateway"}</span></pre><p id="fcb8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以继续直接从浏览器测试更多的端点:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qe"><img src="../Images/043c0d5ca84122971f798d4df60ead40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nHzS51qw-r-UF-dJt_aB4A.png"/></div></div></figure><p id="6881" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> <em class="mn">边注:</em> </strong>如果端点<code class="fe od oe of og b">dev/v1/prices/ETH</code>不为您工作，并且您得到消息<code class="fe od oe of og b">{"message": "Missing Authentication Token"}</code>，您应该重试创建资源代理并重新部署API。</p><p id="1e1f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">至此，我们可以看到任何人都可以公开访问我们的API。在第2部分的<a class="ae lh" rel="noopener" target="_blank" href="/fastapi-aws-secure-api-part-2-1123bff28b55">中，我们将通过直接从API网关控制台创建一个API键</a>来改变它。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="f8a9" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">9.深入探究这一切是如何协同工作的</h1><p id="a549" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">现在，你可能有许多问题。我将试着猜测并以问答的形式回答这些问题:</p><p id="c7da" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 1。我们如何让本地FastAPI代码与Amazon Lambda一起工作？</strong></p><p id="ae59" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们使用了<code class="fe od oe of og b">Mangum</code>库[5]，它是运行在AWS Lambda和API Gateway内部的ASGI APIs的包装器。它提供了一种适配器，该适配器:</p><ul class=""><li id="909b" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">将对API网关的请求路由到我们的Lambda函数，</li><li id="ee7b" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">将Lambda函数响应路由回API网关。</li></ul><p id="5862" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们只需添加两行(<em class="mn">第1行和第7行</em>)就可以将<code class="fe od oe of og b">main.py</code>中的FastAPI代码转换为Amazon Lambda处理程序:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pk pl l"/></div></figure><p id="062f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 2。API Gateway中的方法和资源有什么区别？</strong></p><p id="4f5f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe od oe of og b">ANY</code> <strong class="lk jd">方法</strong>将把请求路由到根路径<code class="fe od oe of og b">/</code>到执行FastAPI代码的Lambda函数。相比之下，子<strong class="lk jd">资源</strong>将以贪婪模式路由根路径<code class="fe od oe of og b">/</code>下的所有路径(<em class="mn">贪婪路径参数:</em> <code class="fe od oe of og b"><em class="mn">{proxy+}</em></code> ) [7]，即，它会将FastAPI代码中定义的所有其他端点路由到Lambda，例如路径<code class="fe od oe of og b">/v1/prices/BTC/.</code></p><p id="7a0d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 3。为什么我们需要</strong> <code class="fe od oe of og b"><strong class="lk jd">{proxy+}</strong></code> <strong class="lk jd">？</strong></p><p id="ae64" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">使用代理，我们不需要编写任何映射模板来将特定路径路由到不同的Lambda函数——相反，我们有一个服务于所有端点的Lambda函数[6]。然后，API Gateway会将所有类型的请求(<em class="mn"> GET、POST、DELETE、PATCH、… </em>)从API Gateway路由到<code class="fe od oe of og b">FastAPI</code>代码中定义的路径。由于有了<code class="fe od oe of og b">Mangum</code>适配器，FastAPI代码可以在Lambda函数内部执行。</p><p id="dc34" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 4。这种架构如何扩展？</strong></p><p id="402c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">每个对API Gateway的请求都会调用一个Lambda函数。这意味着我们可以有数以千计的对我们的API的并行请求，因为每一个都将由一个单独的Lambda函数调用来服务。</p><p id="a194" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，对于每个帐户可以有多少个并行Lambda执行，存在软并发限制(在撰写本文时为1000个)。如果你需要更多，你可以使用<a class="ae lh" href="https://console.aws.amazon.com/support/v1#/case/create?issueType=service-limit-increase" rel="noopener ugc nofollow" target="_blank">支持中心控制台</a>请求增加这个限制【2】。</p><p id="eb2c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 5。这种架构为什么有吸引力？</strong></p><p id="647a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它提供了一个<strong class="lk jd">完全无服务器的</strong> API基础设施，有很多好处:</p><ul class=""><li id="055e" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">Python和令人惊叹的<code class="fe od oe of og b">FastAPI</code>库的所有优势与无服务器架构的优势相结合</li><li id="61eb" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated"><strong class="lk jd">可伸缩性</strong> &amp;无需管理后端服务器——API Gateway将根据需要运行尽可能多的Lambda函数来处理对我们API的所有请求</li><li id="6e93" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">非常<strong class="lk jd">划算</strong>，尤其是对于那些可能还没有收到数百万次请求的小型API</li><li id="babd" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">性能:由于Lambda的<strong class="lk jd">上下文重用</strong>，连续的请求(从前一个请求起15分钟内的<em class="mn">)重用冻结的执行上下文，允许减轻无服务器功能的冷启动</em></li><li id="04d6" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">如果启用，API网关<strong class="lk jd">缓存</strong>允许进一步改善延迟</li><li id="3c56" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">API密钥的简单管理<strong class="lk jd"/></li><li id="1005" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">API Gateway提供与活动目录和第三方身份验证提供者的集成，例如通过<strong class="lk jd"> Cognito </strong>使用<em class="mn">“Google/Amazon帐户登录”</em></li><li id="04d8" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">所有API请求和响应的现成集中式<strong class="lk jd">日志</strong>，以及通过<code class="fe od oe of og b">CloudWatch</code>的访问日志</li><li id="3a81" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">通过启用X射线追踪的分布式<strong class="lk jd">追踪</strong>功能。</li></ul><p id="c734" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 6。为什么我们使用虚拟环境中的站点包来安装包依赖项？</strong></p><p id="fb31" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以将库安装到某个特定的目录中(例如<code class="fe od oe of og b">libs</code>目录)添加标志<code class="fe od oe of og b">-t</code>，代表目标:</p><pre class="ks kt ku kv gt ox og oy oz aw pa bi"><span id="ceeb" class="mv mw it og b gy pb pc l pd pe">pip install -r requirements.txt -t ../libs/</span></pre><p id="37d4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后我们可以将这个目录添加到我们的<code class="fe od oe of og b">lambda.zip</code>中。</p><p id="20eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然而，这样一来，我们的项目将会被安装到项目目录中的Python包弄得乱七八糟，并且这可能会使其他开发人员以后更难区分实际的API代码和它的依赖项。我们可能必须将<code class="fe od oe of og b">libs</code>目录添加到<code class="fe od oe of og b">.gitignore</code>中。总的来说，这会增加额外的工作，如果我们使用虚拟环境和它的<code class="fe od oe of og b">site-packages</code>，就不需要这样做。</p><p id="618c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 7。我们是否可以使用无服务器框架或AWS SAM来创建部署管道？</strong></p><p id="c27b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">是的，这种设置与<a class="ae lh" href="https://github.com/serverless/serverless" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>配合得很好。下面是一个可能的例子:</p><div class="qf qg gp gr qh qi"><a href="https://github.com/jordaneremieff/serverless-mangum-examples/tree/main/fastapi-example" rel="noopener  ugc nofollow" target="_blank"><div class="qj ab fo"><div class="qk ab ql cl cj qm"><h2 class="bd jd gy z fp qn fr fs qo fu fw jc bi translated">jordaneremieff/无服务器-mangum-示例</h2><div class="qp l"><h3 class="bd b gy z fp qn fr fs qo fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="qq l"><p class="bd b dl z fp qn fr fs qo fu fw dk translated">github.com</p></div></div><div class="qr l"><div class="qs l qt qu qv qr qw lb qi"/></div></div></a></div><p id="d9b5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然而，我更喜欢最小化我的项目中的依赖性，并且<code class="fe od oe of og b">serverless</code>需要额外的组件，比如节点包管理器。</p><p id="4e52" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您也可以将此设置与<a class="ae lh" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank"> AWS SAM </a>一起使用。</p><p id="f058" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> 8。这要花多少钱？</strong></p><p id="1dc2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">使用免费等级，您可以每月(<em class="mn">免费</em>)访问:</p><ul class=""><li id="342e" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">100万个API网关请求</li><li id="f2b8" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">每月100万次Lambda调用，计算时间高达320万秒</li></ul><p id="e645" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">除此之外，价格可能会根据您的AWS地区和您的请求数量而有所不同(<em class="mn">批量折扣</em>)，但它们的范围是每一百万个请求1-4.25美元(在撰写时为<em class="mn">)。Lambda的定价基于调用次数和代码运行时间，以毫秒为单位。你可以在这里找到更多<a class="ae lh" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank">，在这里</a>找到更多<a class="ae lh" href="https://aws.amazon.com/api-gateway/pricing/" rel="noopener ugc nofollow" target="_blank">。</a></em></p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="60be" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">10.使用Swagger UI演示加密货币API</h1><p id="ef25" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">最后，这是API正在做的事情——所有功能都基于来自CryptoCompare [4]的信息:</p><ul class=""><li id="33d3" class="nn no it lk b ll lm lo lp lr pg lv ph lz pi md pj nv nw nx bi translated">我们正在获取交易信号，以获得关于特定加密货币的市场情绪的信息，即当前是上升还是下降趋势</li><li id="3f03" class="nn no it lk b ll ny lo nz lr oa lv ob lz oc md pj nv nw nx bi translated">我们正在获取选定加密货币的实时价格，并可以用我们选择的特定货币显示它们。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qx"><img src="../Images/04788f516a0b2727c5281e7a861024d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*XynXYOtZuNMK1Q1fQV_HTA.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我们的示例API的演示——作者制作的GIF</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="43de" class="oh mw it bd mx oi oj ok na ol om on nd ki oo kj ng kl op km nj ko oq kp nm or bi translated">11.结论</h1><p id="a0c1" class="pw-post-body-paragraph li lj it lk b ll np kd ln lo nq kg lq lr os lt lu lv ot lx ly lz ou mb mc md im bi translated">在本文中，我们讨论了利用FastAPI、API Gateway和Amazon Lambda将REST API部署到AWS的过程。在这个过程中，我们学习了如何打包代码和创建部署管道，并讨论了所有这些微服务组件如何协同工作。</p><p id="fb26" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在第2部分文章中，我们将继续构建这个API，通过API密钥添加身份验证、分布式日志记录和跟踪，以及在对FastAPI代码进行更改后如何重新部署API。</p><div class="qf qg gp gr qh qi"><a rel="noopener follow" target="_blank" href="/fastapi-aws-secure-api-part-2-1123bff28b55"><div class="qj ab fo"><div class="qk ab ql cl cj qm"><h2 class="bd jd gy z fp qn fr fs qo fu fw jc bi translated">FastAPI + AWS =安全API(第2部分)</h2><div class="qp l"><h3 class="bd b gy z fp qn fr fs qo fu fw dk translated">让我们用FastAPI、AWS Lambda、API Gateway、CloudWatch和AWS X-Ray构建一个安全且可观察的Python REST API</h3></div><div class="qq l"><p class="bd b dl z fp qn fr fs qo fu fw dk translated">towardsdatascience.com</p></div></div><div class="qr l"><div class="qy l qt qu qv qr qw lb qi"/></div></div></a></div><p id="a335" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">如果这篇文章有用，</strong> <a class="ae lh" href="https://medium.com/@anna.anisienia" rel="noopener"> <strong class="lk jd">关注我</strong> </a> <strong class="lk jd">看我下一篇文章。</strong></p><p id="ecde" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">参考文献:</strong></p><p id="8dc8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">肖恩·拜尔的博客</p><p id="a152" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[2] <a class="ae lh" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank">亚马逊Lambda文档</a></p><p id="c68b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[3] <a class="ae lh" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-rest-api.html" rel="noopener ugc nofollow" target="_blank"> API网关文档</a></p><p id="2021" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[4] <a class="ae lh" href="https://min-api.cryptocompare.com/documentation?key=Price&amp;cat=SingleSymbolPriceEndpoint" rel="noopener ugc nofollow" target="_blank"> CryptoCompare API文档</a></p><p id="3d9d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[5] <a class="ae lh" href="https://mangum.io/" rel="noopener ugc nofollow" target="_blank">曼古姆文档</a></p><p id="37b7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">[6]关于<a class="ae lh" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html" rel="noopener ugc nofollow" target="_blank">λ代理整合</a></p><p id="f62a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">【7】<a class="ae lh" href="https://www.1strategy.com/blog/2017/06/06/how-to-use-amazon-api-gateway-proxy/" rel="noopener ugc nofollow" target="_blank">如何使用亚马逊API网关{proxy+} </a></p></div></div>    
</body>
</html>