<html>
<head>
<title>Data Analysis in Python: Using Regular Expressions on WhatsApp Messages</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的数据分析:在WhatsApp消息上使用正则表达式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/whatsapp-messages-visualizing-interjections-sent-by-users-and-other-perks-ea97bbd7f7c5?source=collection_archive---------37-----------------------#2020-11-07">https://towardsdatascience.com/whatsapp-messages-visualizing-interjections-sent-by-users-and-other-perks-ea97bbd7f7c5?source=collection_archive---------37-----------------------#2020-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6864" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在识别消息中的感叹词的上下文中，使用Python和Pandas中的正则表达式进行数据分析的面向示例的教程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/37a5b1b6d77fbddb88ccedaaf14dbb1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VizORblmzw3_lxSV"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@_giri_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">AARN·GIRI</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1db5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大概以前也发生过:你打开你的WhatsApp，通过很多群看了很多“早上好”、“晚上好”、“下午好”的消息。现在，假设您想要可视化该群组的消息，以便获得更多的洞察力，例如，来自某人的消息数量，或者哪一天的消息数量最多，或者在这种情况下，发现每个人在特定的WhatsApp群组中发送了多少个“早上好”式的感叹词。如何做到这一点？</p><p id="f0d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本帖中，我们将研究Python和Pandas的正则表达式的使用，以达到我们的目的。</p><h1 id="0d9c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">数据</h1><p id="5b98" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这些数据是从WhatsApp的群聊中获取的，并通过该应用程序导出。就该职位而言，该小组有57名成员，其语言为葡萄牙语。</p><p id="8af9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于消息，数据遵循以下格式:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="990a" class="mu lt iq mq b gy mv mw l mx my">DAY/MONTH/YEAR HOUR:MINUTE — USER: MESSAGE</span></pre><h1 id="3a09" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">该项目</h1><p id="9887" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这个项目是基于<a class="ae kv" href="https://github.com/kurasaiteja/Whatsapp-Analysis" rel="noopener ugc nofollow" target="_blank">kurasaiteja/WhatsApp-Analysis</a>。虽然这个项目遵循类似的路径，但一些核心设计选择和其他改进将被讨论。它是用Python写的。</p><h2 id="25b8" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">进口</h2><p id="f7e5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">本项目使用<a class="ae kv" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a>、<a class="ae kv" href="https://numpy.org/" rel="noopener ugc nofollow" target="_blank"> NumPy </a>、<a class="ae kv" href="https://matplotlib.org/" rel="noopener ugc nofollow" target="_blank"> Matplotlib </a>、<a class="ae kv" href="https://pypi.org/project/emoji/" rel="noopener ugc nofollow" target="_blank">表情符号</a>、<a class="ae kv" href="https://pypi.org/project/regex/" rel="noopener ugc nofollow" target="_blank"> regex </a>和<a class="ae kv" href="https://plotly.com/" rel="noopener ugc nofollow" target="_blank"> Plotly </a>。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9a5b" class="mu lt iq mq b gy mv mw l mx my">import re<br/>import regex<br/>import pandas as pd<br/>import numpy as np<br/>import emoji<br/>import plotly<br/>import plotly.express as px<br/>import matplotlib.pyplot as plt<br/>from os import path</span></pre><h2 id="9b1a" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">助手功能</h2><p id="66d9" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了确定输入中的行是否以日期时间符号开始，starts_with_date_time函数被定义为:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="47a9" class="mu lt iq mq b gy mv mw l mx my">def starts_with_date_time(s):<br/>    pattern = '^([0-9]+)(\/)([0-9]+)(\/)([0-9]+)[ ]([0-9]+):([0-9]+)[ ]-'<br/>    result = re.match(pattern, s)<br/>    if result:<br/>        return True<br/>    return False</span></pre><p id="bbd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们已经完成了开始日期的验证，我们继续寻找是否有一个author字段(即USER: MESSAGE是否存在)。为此，我们要查看该行中出现的字符':'的数量。在这一步中，Whatsapp-Analysis项目不考虑消息正文中是否有字符。如果存在，则消息没有作者，因为“:”的数量不等于2。为了防止这种情况，需要验证“:”字符的数量是否大于1。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="d4a1" class="mu lt iq mq b gy mv mw l mx my">def find_author(s):<br/>  s=s.split(":")<br/>  if len(s) &gt; 1:<br/>    return True<br/>  else:<br/>    return False</span></pre><p id="fe8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">split_count函数被定义为列出每条消息中出现的表情符号。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="b731" class="mu lt iq mq b gy mv mw l mx my">def split_count(text):<br/>    emoji_list = []<br/>    data = regex.findall(r'\X', text)<br/>    for word in data:<br/>        if any(char in emoji.UNICODE_EMOJI for char in word):<br/>            emoji_list.append(word)<br/>    return emoji_list</span></pre><p id="61de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们的助手函数已经定义好了，现在是时候把数据解析成一个数组了，这样就可以把它转换成Pandas DataFrame。函数get_data_point是一个使用has_author的函数，它将该行拆分为日期、时间、作者和消息字段。一旦消息被解析成大小为4的数组，它就被追加到解析后的变量中。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="43a9" class="mu lt iq mq b gy mv mw l mx my">def get_data_point(line):<br/>    split_l = line.split(' - ')<br/>    date_time = split_l[0]<br/>    date, time = date_time.split(' ')<br/>    message = ' '.join(split_l[1:])<br/>    if has_author(message):<br/>        split_msg = message.split(': ')<br/>        author = split_msg[0]<br/>        message = ' '.join(split_msg[1:])<br/>    else:<br/>        author = None<br/>    return date, time, author, message</span><span id="89c4" class="mu lt iq mq b gy nk mw l mx my">parsed = []<br/>path = './input/wpp_input.txt'<br/>with open(path, encoding="utf-8") as fp:<br/>    fp.readline()<br/>    msg_buffer = []<br/>    date, time, author = None, None, None<br/>    while True:<br/>        line = fp.readline()<br/>        if not line:<br/>            break<br/>        line = line.strip()<br/>        if starts_with_date_time(line):<br/>            if len(msg_buffer) &gt; 0:<br/>                parsed.append([date, time, author, ' '.join(msg_buffer)])<br/>            msg_buffer.clear()<br/>            date, time, author, message = get_data_point(line)<br/>            msg_buffer.append(message)<br/>        else:<br/>            msg_buffer.append(line)</span></pre><h2 id="b9e1" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">创建数据帧</h2><p id="3dc6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">既然信息被解析成一个二维数组，我们可以把它转换成熊猫数据帧。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="48bf" class="mu lt iq mq b gy mv mw l mx my">df = pd.DataFrame(parsed, columns=['date', 'time', 'author', 'message'])<br/>df["date"] = pd.to_datetime(df["date"])<br/>df.info()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/fc57df376589bf09bfb41a9a2098784c.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*zglZJY2AqhY-2QcicXiWaQ.png"/></div></figure><h2 id="30cc" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">作者匿名</h2><p id="473d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">但现在我们有一个问题:我们不想使用组中那些人的名字或电话号码，但我们更希望他们被匿名识别。为了做到这一点，我们可以使用author列的unique()函数，然后根据作者在unique()数组中的位置对其姓名进行更新，再加上1以获得更好的可读性。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="a5d5" class="mu lt iq mq b gy mv mw l mx my">anon = df.copy()<br/>anon = anon.dropna() # This drops any null author messages<br/>authors = anon.author.unique()</span><span id="43c3" class="mu lt iq mq b gy nk mw l mx my">anon.author = anon.author.apply(lambda author: 'Author ' + str(np.where(authors == author)[0][0] + 1))<br/>authors = anon.author.unique()</span><span id="d766" class="mu lt iq mq b gy nk mw l mx my">anon.tail()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/9c1dcc90e9cfb7a3b0ce10f5376a0a2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zr3GJzn790LMVuAULgZigA.png"/></div></div></figure><h2 id="97cd" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">数据过滤</h2><p id="eb92" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">既然作者的身份已经保留，我们就可以过滤数据了。在这个项目中，我们将过滤字数，表情列表，网址计数和问候的数据，但是，由于目标是找出用户发送了多少感叹词，只有问候将被使用。</p><p id="6b16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了发现消息中是否有感叹词，使用了正则表达式匹配。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="f327" class="mu lt iq mq b gy mv mw l mx my">media_msgs = anon[anon['message'] == '&lt;Arquivo de mídia oculto&gt;']<br/>text_msgs = anon.drop(media_msgs.index)<br/>text_msgs['word_count'] = text_msgs['message'].apply(lambda s : len(s.split(' ')))<br/>text_msgs["emoji"] = anon["message"].apply(split_count)<br/>text_msgs['urlcount'] = text_msgs.message.apply(lambda x: re.findall(r'(https?://\S+)', x)).str.len()<br/>text_msgs['greetings'] = anon.message.apply(lambda msg: True if re.match('([B|b]om dia)|([B|b]oa tarde)|([B|b]oa noite)', msg) else False)</span><span id="6ecf" class="mu lt iq mq b gy nk mw l mx my">text_msgs.tail()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/f4313a3cf2c140d9103289cd7cda640d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EFgzxdx5EBobzGGOy7p6WA.png"/></div></div></figure><h2 id="3535" class="mu lt iq bd lu mz na dn ly nb nc dp mc lf nd ne me lj nf ng mg ln nh ni mi nj bi translated">测绘</h2><p id="b0dc" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在我们有了greetings值，我们只需要绘制它。在这种情况下，条形图提供了很好的可视化效果。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8672" class="mu lt iq mq b gy mv mw l mx my">author_group = text_msgs.groupby("author").sum()<br/>author_group.reset_index(inplace=True)<br/>fig = px.bar(author_group, y="author", x="greetings", color="author", color_discrete_sequence=["red", "green", "blue", "goldenrod", "magenta"])</span><span id="53d1" class="mu lt iq mq b gy nk mw l mx my">plotly.offline.plot(fig, filename='output/wpp_analysis.html')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/ab8d12fa7cd148124dfa81886c023e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aCC3BScUY9NnnAKV8XYBgA.png"/></div></div></figure><h1 id="6142" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="7ea9" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">可以看出，作者43使用定义感叹词最多，作者30次之。他们是使用公告的最频繁的用户。通过这个可以收集更多的信息，例如用户平均说了多少感叹词，或者一周中的哪一天显示了最多的感叹词。但是，因为这篇文章的目标是正则表达式和消息解析，所以这将是以后的工作。这里有很多可能性，这确实显示了正则表达式的强大功能。</p><p id="4af9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的GitHub上可以找到这个项目，以及运行它的说明。</p><h1 id="b552" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考</h1><div class="np nq gp gr nr ns"><a href="https://pandas.pydata.org" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">熊猫</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">pandas是一个快速、强大、灵活且易于使用的开源数据分析和操作工具，构建于…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">pandas.pydata.org</p></div></div><div class="ob l"><div class="oc l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://numpy.org" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">NumPy</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">为什么是NumPy？强大的n维数组。数值计算工具。可互操作。表演。开源。</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">numpy.org</p></div></div><div class="ob l"><div class="oh l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://matplotlib.org" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">Matplotlib: Python绘图- Matplotlib 3.3.2文档</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Matplotlib是一个全面的库，用于在Python中创建静态、动画和交互式可视化…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">matplotlib.org</p></div></div><div class="ob l"><div class="oi l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://pypi.org/project/emoji/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">绘文字</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Python的表情符号。这个项目的灵感来自kyokomi。unicode定义的整套表情代码…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">pypi.org</p></div></div><div class="ob l"><div class="oj l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://pypi.org/project/regex/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">正则表达式</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">问题编号与Python bug tracker相关，除了列为“Hg问题”的地方。一个条件的测试…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">pypi.org</p></div></div><div class="ob l"><div class="ok l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://plotly.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">plot ly:ML和数据科学模型的前端</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Plotly为ML、数据科学、工程和科学创造和管理领先的数据界面工具。语言…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">plotly.com</p></div></div><div class="ob l"><div class="ol l od oe of ob og kp ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://github.com/murilobnt/whatsapp-interjections" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">murilobnt/whatsapp-感叹词</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="om l od oe of ob og kp ns"/></div></div></a></div></div></div>    
</body>
</html>