<html>
<head>
<title>Portfolio Optimization With SciPy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SciPy优化投资组合</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/portfolio-optimization-with-scipy-aa9c02e6b937?source=collection_archive---------7-----------------------#2020-10-30">https://towardsdatascience.com/portfolio-optimization-with-scipy-aa9c02e6b937?source=collection_archive---------7-----------------------#2020-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/d59bccba961165ac49c9f2bfe11a98ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UycV4b4sErLnQ4-7"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://unsplash.com/@campaign_creators?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">活动发起人</a>在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="c162" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">使用Python计算带约束的最优投资组合</h2></div><p id="c11c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk"> <em class="lu">来自《走向数据科学》编辑的提示:</em> </strong> <em class="lu">虽然我们允许独立作者根据我们的</em> <a class="ae jg" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="lu">规则和指导方针</em> </a> <em class="lu">发表文章，但我们并不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae jg" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="lu">读者术语</em> </a> <em class="lu">。</em></p><p id="f30a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lu">无意成为投资建议。你可以在我的GitHub上找到我的代码。</em> </p><p id="110c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi lv translated">是时候写另一篇关于投资组合优化的文章了，因为我最近一直在做这方面的工作。如果你需要复习，这里是我以前写的关于这个话题的文章:</p><div class="is it gp gr iu me"><a rel="noopener follow" target="_blank" href="/understanding-portfolio-optimization-795668cef596"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd jk gy z fp mj fr fs mk fu fw ji bi translated">了解投资组合优化</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">从概念上理解优化投资组合意味着什么</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">towardsdatascience.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms ja me"/></div></div></a></div><div class="is it gp gr iu me"><a rel="noopener follow" target="_blank" href="/portfolio-optimization-with-numpy-93e1428525a5"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd jk gy z fp mj fr fs mk fu fw ji bi translated">基于NumPy的投资组合优化</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">你所需要的只是一些矩阵代数来做出最优投资组合</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">towardsdatascience.com</p></div></div><div class="mn l"><div class="mt l mp mq mr mn ms ja me"/></div></div></a></div><p id="d2d9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尽管仅仅用矩阵代数和NumPy来优化投资组合很有趣，但有时我们需要添加约束。例如，许多投资者不想或不被允许做空投资。我们不能保证使用矩阵代数产生的最优投资组合不包括空头头寸(负权重)。因此，我们转而求助于<strong class="la jk">优化</strong>。</p><p id="ff15" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你没有阅读我以前关于优化的文章，<strong class="la jk">优化是指在给定风险水平下最大化回报(或最小化特定回报水平下的风险)的资产组合的求解过程</strong>。优化的期望输出是一组能够产生最优投资组合的投资组合权重(针对每项资产)。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="775b" class="nb nc jj bd nd ne nf ng nh ni nj nk nl kp nm kq nn ks no kt np kv nq kw nr ns bi translated">运行投资组合优化</h1><p id="f2ca" class="pw-post-body-paragraph ky kz jj la b lb nt kk ld le nu kn lg lh nv lj lk ll nw ln lo lp nx lr ls lt im bi translated">投资组合优化的两个关键输入是:</p><ol class=""><li id="1844" class="ny nz jj la b lb lc le lf lh oa ll ob lp oc lt od oe of og bi translated"><strong class="la jk">被考虑的每项资产的预期收益</strong>。</li><li id="908a" class="ny nz jj la b lb oh le oi lh oj ll ok lp ol lt od oe of og bi translated">资产收益的<strong class="la jk">协方差矩阵</strong>。嵌入其中的是关于<a class="ae jg" rel="noopener" target="_blank" href="/understanding-correlation-and-diversification-661c19a26555"> <strong class="la jk">交叉资产相关性</strong> </a>和<a class="ae jg" rel="noopener" target="_blank" href="/understanding-investment-risk-3882c58e00e0"> <strong class="la jk">每个资产的波动率</strong> </a> y(对角线)的信息。</li></ol><p id="52aa" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">预期回报很难估计——有些人喜欢使用历史平均值(因为过去往往不代表未来，这很危险)，其他人有自己的方法来估计回报预测。我计划写一整篇关于这个的文章，所以这次我不会详细讨论。今天我们将关注优化过程本身。因此，我们将假装我们从一个顾问那里得到了预期回报估计。顺便说一句，<strong class="la jk"> <em class="lu">这些都是我非常粗略的估算，绝对不应该作为投资建议</em> </strong>。</p><figure class="on oo op oq gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/8e9d1730f5ed1821bfdafcd11faadf9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*myA7_SvTSoWSQxquHxgphA.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">我们优化的预期回报(图形由作者创建)</p></figure><p id="eadc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如你从上面的图表中所看到的，我们有一个包含八种投资的投资组合，从股票、债券到大宗商品。对于那些不熟悉这个缩写的人来说，TIPS是财政部通货膨胀保值证券——换句话说，是没有通货膨胀风险的国债。</p><p id="4ca7" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是用过去10年的回报率估算的相关性。越低越好，所以蓝色阴影的单元格代表多样化的潜在机会。从技术上来说，优化需要协方差矩阵，但是相关矩阵提供的信息更多。</p><figure class="on oo op oq gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/222b10640615e282b9ec0ec464d29ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*Rg20jFu49mA3iMG3zOVCqw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">相关矩阵(图形由作者创建)</p></figure><p id="8b57" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了输入，让我们来看看代码。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="d8cc" class="nb nc jj bd nd ne nf ng nh ni nj nk nl kp nm kq nn ks no kt np kv nq kw nr ns bi translated">编码投资组合优化</h1><p id="3c3a" class="pw-post-body-paragraph ky kz jj la b lb nt kk ld le nu kn lg lh nv lj lk ll nw ln lo lp nx lr ls lt im bi translated">我使用了与我在<a class="ae jg" rel="noopener" target="_blank" href="/portfolio-optimization-with-numpy-93e1428525a5">之前的优化文章</a>中相同的数据集，除了现在有八个资产而不是四个。每项资产的标签是:</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="9f52" class="ow nc jj os b gy ox oy l oz pa">factors = ['S&amp;P 500','Emerging Markets','Small Cap',<br/>           'Treasury Bonds',<br/>           'High Yield','TIPS','Gold','Oil']</span></pre><p id="ff1a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将每日收益存储在一个名为<strong class="la jk"> factor_returns </strong>的熊猫数据框架中。计算我们资产的协方差矩阵非常简单:</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="4a79" class="ow nc jj os b gy ox oy l oz pa">cov =  factor_returns.cov()</span></pre><p id="d050" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我上面提到的，我们将使用我创建的退货预测(退货的指定顺序与它们在因子中列出的顺序相同):</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="25e3" class="ow nc jj os b gy ox oy l oz pa">expected_returns = np.array([[ 0.080],<br/>                             [ 0.092],<br/>                             [ 0.092],<br/>                             [-0.017],<br/>                             [ 0.034],<br/>                             [ 0.001],<br/>                             [ 0.010],<br/>                             [ 0.079]])</span></pre><p id="2480" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们导入优化所需的Python库:</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="6a2c" class="ow nc jj os b gy ox oy l oz pa">from scipy.optimize import minimize, Bounds, LinearConstraint</span></pre><p id="8aca" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将稍微不按实际编码的顺序来解释，因为这样更容易理解。下一个代码块显示了一个名为<strong class="la jk"> optimize </strong>的函数，它使用SciPy的<strong class="la jk"> minimize </strong>函数运行优化。</p><p id="9a28" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">看看调用minimize的地方(我加粗了)。第一个参数<strong class="la jk"> func </strong>是我们想要最小化的函数。第二个参数<strong class="la jk"> W </strong>是允许优化器改变的输入— <strong class="la jk"> W是我们正在求解的，对应于我们投资组合中资产的权重</strong>。我们需要从猜测开始——没有任何强有力的先验，我只是对每项资产进行同等加权。</p><p id="b26c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk"> args </strong>参数中的<strong class="la jk"> exp_ret </strong>(预期回报)和<strong class="la jk"> cov </strong>(协方差)变量是提供给优化器的不允许改变的输入。</p><p id="184e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">因此，优化器所做的是，在给定我们提供的预期回报和协方差矩阵的情况下，搜索使func最小化的投资组合权重向量(W)。</strong></p><p id="d6ca" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在函数的最后，你会看到我返回了<strong class="la jk"> optimal_weights['x'] </strong>。这是因为在优化器对象中，我们从mimimize返回的‘x’属于优化的权重w。</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="c721" class="ow nc jj os b gy ox oy l oz pa">W = np.ones((factor_moments.shape[0],1))*(1.0/factor_moments.shape[0])</span><span id="b4b1" class="ow nc jj os b gy pb oy l oz pa"># Function that runs optimizer<br/>def optimize(func, W, exp_ret, cov, target_return):<br/>    opt_bounds = Bounds(0, 1)<br/>    opt_constraints = ({'type': 'eq',<br/>                        'fun': lambda W: 1.0 - np.sum(W)},<br/>                       {'type': 'eq',<br/>                        'fun': lambda W: target_return - W.T@exp_ret})</span><span id="446e" class="ow nc jj os b gy pb oy l oz pa">    optimal_weights = <strong class="os jk">minimize(func, W, <br/>                               args=(exp_ret, cov),<br/>                               method='SLSQP',<br/>                               bounds=opt_bounds,<br/>                               constraints=opt_constraints)</strong><br/>    return optimal_weights['x']</span></pre><p id="abd4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可能会注意到，minimize还可以接受两个可选参数— <strong class="la jk">边界</strong>和<strong class="la jk">约束</strong>。这些很重要，所以让我们一个一个地看。界限很简单。我们希望W中的每个权重介于0和1之间，换句话说，没有负权重或杠杆:</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="1f9b" class="ow nc jj os b gy ox oy l oz pa">opt_bounds = Bounds(0, 1)</span></pre><p id="0607" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于约束条件，我们有两个——<strong class="la jk">我们希望我们的权重总和为1 </strong>(为了使它成为一个合适的投资组合)，以及<strong class="la jk">我们希望实现预先指定的目标回报</strong>(你也可以将其设置为目标风险，或者完全不考虑)。我们设定回报目标的原因是为了避免这样的情况:我们优化并获得了一个甜蜜而多样化的投资组合，但该投资组合的预期回报是3%或其他一些太低的值。</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="8fcf" class="ow nc jj os b gy ox oy l oz pa">opt_constraints = ({'type': 'eq',<br/>                        'fun': lambda W: 1.0 - np.sum(W)},<br/>                       {'type': 'eq',<br/>                        'fun': lambda W: target_return - W.T@exp_ret})</span></pre><p id="48ac" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们来看看我之前跳过的那部分代码。一、什么是<strong class="la jk"> func </strong>？当我们求解最优投资组合时，我们试图找到每单位风险回报最高的投资组合(其中风险是投资组合的标准差)。</p><p id="5854" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">所以我们要最大化回报率，我们可以计算为W.T@exp_ret </strong>(这将每项资产的回报率乘以其权重并求和)<strong class="la jk">和风险，我们可以计算为W . T @ cov @ W .</strong>@字符表示矩阵乘法。</p><p id="4ca6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于我们使用了一个优化函数来最小化事物，我们需要在我们的风险回报率上加上一个负号——这样当我们最小化它时，我们实际上是在最大化它。</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="c1ff" class="ow nc jj os b gy ox oy l oz pa"># Function to optimize<br/>def ret_risk(W, exp_ret, cov):<br/>    return -((W.T@exp_ret) / (W.T@cov@W)**0.5)</span></pre><p id="0894" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在剩下要做的就是优化我们的产品组合:</p><pre class="on oo op oq gt or os ot ou aw ov bi"><span id="a793" class="ow nc jj os b gy ox oy l oz pa">x = optimize(ret_risk, W, expected_returns, cov, <br/>             target_return=0.055)</span></pre><p id="e1de" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是最佳重量的样子:</p><figure class="on oo op oq gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/f8d97880a2793e4164ea4586ccb10a1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*1XyheuUsl4yOruZ76KiaXw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">最佳投资组合权重(作者制作的图表)</p></figure><p id="2102" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">重量方面突出的几件事:</p><ul class=""><li id="bf8d" class="ny nz jj la b lb lc le lf lh oa ll ob lp oc lt pc oe of og bi translated">小型股和新兴市场的预期回报率最高，但权重不高。这是因为它们的波动性(又称风险)明显高于标准普尔500(见下图)。此外，它们与标准普尔500高度相关，因此很少提供多样化。</li><li id="6e66" class="ny nz jj la b lb oh le oi lh oj ll ok lp ol lt pc oe of og bi translated">美国国债的预期回报率为负，但却是权重第二高的资产类别。这是因为它也是与股票相关性最小的资产类别(负相关性约为-0.40)。因此，实际上，当股市崩盘时，投资组合的回报依赖于股票和高收益债券，保险依赖于美国国债。</li><li id="6d50" class="ny nz jj la b lb oh le oi lh oj ll ok lp ol lt pc oe of og bi translated">尽管石油回报率相对较高，与其他资产的相关性较低，但它的波动性太大，因此权重较低。</li></ul><figure class="on oo op oq gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/8fd3b9d040ae3b5230bb2a7c29e014c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*CXiSvqP62Uuh_tf68PZymg.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">每个资产类别的年化标准差(由作者创建的图表)</p></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="180e" class="nb nc jj bd nd ne nf ng nh ni nj nk nl kp nm kq nn ks no kt np kv nq kw nr ns bi translated">结论</h1><p id="116a" class="pw-post-body-paragraph ky kz jj la b lb nt kk ld le nu kn lg lh nv lj lk ll nw ln lo lp nx lr ls lt im bi translated">这就是SciPy的优化。投资组合策略过程的下一步将是尽最大努力来衡量模型和估计误差的影响。也就是说，我们想知道哪些输入可能是错误指定的(测量误差),以及我们的模型输出对这种误差有多敏感。提示:预期收益是非常嘈杂的，优化的输出对预期收益的微小变化都非常敏感。下一次，我们将看看如何解决这个问题。干杯！</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><p id="ef26" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae jg" href="https://tonester524.medium.com/membership" rel="noopener"> <strong class="la jk"> <em class="lu">如果你总体上喜欢这篇文章和我的写作，请考虑通过我在这里的推荐链接注册Medium来支持我的写作。谢谢！</em> </strong> </a></p></div></div>    
</body>
</html>