<html>
<head>
<title>How to Copy between Encrypted S3 Buckets Cross Account</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在加密的S3桶交叉帐户之间复制</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a?source=collection_archive---------6-----------------------#2020-11-14">https://towardsdatascience.com/how-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a?source=collection_archive---------6-----------------------#2020-11-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1f2f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">包括一步一步的教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/f44a4b8a3f6dfda88be9d42e9992e274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*rZNRjfrC3L8vLyKhpKHV3w.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">在加密存储桶、交叉帐户之间复制时涉及的所有资源的概述。用<a class="ae ku" href="https://desk.draw.io/support/solutions/articles/16000042494-usage-terms-for-diagrams-created-in-diagrams-net" rel="noopener ugc nofollow" target="_blank"> Draw.io </a>创建</p></figure><p id="f647" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">加密很棘手，即使你使用的是AWS这样的托管服务。</p><p id="4a46" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在<a class="ae ku" rel="noopener" target="_blank" href="/aws-iam-introduction-20c1f017c43">我的上一篇文章</a>中，我讲述了你需要了解的关于IAM的内容，IAM是AWS提供的身份和访问管理服务。在这篇文章中，我想更具体一点，介绍一个常见的场景，其中有大量不同的权限在起作用。在这里，您将看到我之前谈到的所有不同类型的资源都在运行，希望一切都会顺利。</p><blockquote class="lr ls lt"><p id="a87e" class="kv kw lu kx b ky kz ju la lb lc jx ld lv lf lg lh lw lj lk ll lx ln lo lp lq im bi translated">如果你需要AWS中权限如何工作的基础知识，请阅读我的<a class="ae ku" rel="noopener" target="_blank" href="/aws-iam-introduction-20c1f017c43">对IAM的介绍帖子</a>。</p></blockquote><h1 id="51bc" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">概观</h1><p id="2ad7" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">假设我们使用几个AWS账户，我们想将某个S3桶中的数据从一个<em class="lu">源</em>账户复制到某个<em class="lu">目的地</em>账户，如上图所示。此外，让我们想象我们的数据必须在静态下加密，出于监管目的；这意味着我们在<em class="lu">和</em>账户中的桶也必须被加密。</p><p id="d02b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在AWS上实现上述目标有很多方法，但我将讨论以下组合:</p><ul class=""><li id="3c53" class="mv mw it kx b ky kz lb lc le mx li my lm mz lq na nb nc nd bi translated">KMS用于主密钥的加密/解密。一种替代方法是实现客户端加密并自己管理主密钥。</li><li id="f068" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated"><a class="ae ku" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html" rel="noopener ugc nofollow" target="_blank">使用客户管理密钥的S3服务器端加密</a>适合您的使用案例。与S3托管密钥相比，客户托管密钥有几个优点，比如审计跟踪。</li><li id="bd26" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated"><a class="ae ku" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/bucket-encryption.html" rel="noopener ugc nofollow" target="_blank"> S3默认加密</a>适合你的桶对象；这意味着添加到bucket中的对象将被自动加密，而不需要您指定一个标志来加密它们。</li><li id="420c" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated">作为执行复制的身份的角色，与用户相对。</li></ul><h1 id="c482" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">政策</h1><p id="0ad8" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">这里有5个主要的资源:我们的两个处理桶加密的主密钥，我们的两个S3桶，以及我们的角色。这意味着您需要4个资源策略(不包括角色的信任策略)和1个身份策略才能正常工作。</p><p id="7344" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">注意:你不能复制/粘贴下面的所有内容。对于每个策略，您必须将资源ARNs和帐户id更改为属于您的源/目标的资源ARNs和帐户id。</p><h2 id="985a" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">角色身份策略</h2><p id="b4b7" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">这是我们将附加到我们的<code class="fe nv nw nx ny b">S3Porter</code>角色的身份策略，以便让它联系S3和KMS。这里有4个必要的语句:顶部图表中的每个资源一个。</p><ol class=""><li id="acf4" class="mv mw it kx b ky kz lb lc le mx li my lm mz lq nz nb nc nd bi translated">从跨帐户来源时段复制。跨帐户访问要求<em class="lu">发送方的身份策略<em class="lu">和接收方的资源策略</em>都允许访问。在本例中，我们允许发送者发出请求。</em></li><li id="e5a0" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq nz nb nc nd bi translated">复制到同一个AWS帐户中的bucket。请注意下面的策略是如何将资源限制在单个S3存储桶中的:作为一种最佳实践，重要的是将您的策略限制在它们绝对需要的资源上。</li><li id="696e" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq nz nb nc nd bi translated">使用跨帐户KMS密钥来解密我们的源桶中的对象。</li><li id="a98d" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq nz nb nc nd bi translated">加密到我们的目的地账户。这可能看起来很有趣，我们仍然需要对我们的目的地bucket的<code class="fe nv nw nx ny b">kms:Decrypt</code>权限，因为我们只是将数据复制到其中。我们需要<code class="fe nv nw nx ny b">kms:Decrypt </code>是因为，<a class="ae ku" href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-multipart-kms-decrypt/#:~:text=Because%20the%20parts%20are%20encrypted,Amazon%20S3%20with%20SSE%2DKMS." rel="noopener ugc nofollow" target="_blank">在幕后，S3可能会把你的文件分成块，然后重新组合</a>以便把它们复制到一个桶里。重组过程可能需要您的角色具有解密权限，因为文件的大部分在最初上传时将被加密，并且在重组前需要再次解密。您可能会注意到该策略需要<code class="fe nv nw nx ny b">kms:GenerateDataKey</code>权限；之所以需要这些，是因为S3会用从你的主密钥导出的唯一密钥来加密你的每个对象，这个过程被称为信封加密。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="ca3b" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">目标存储桶资源策略</h2><p id="ca2a" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">我们的目的地bucket不需要资源策略，因为对它的请求来自同一个 AWS帐户中的S3Porter角色，并且我们已经在我们的身份策略中添加了对目的地bucket的<code class="fe nv nw nx ny b">s3:PutObject</code>权限。</p><p id="6b17" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">值得注意的是，我们还可以在目的地桶上添加一个资源策略，而不是在上面的<code class="fe nv nw nx ny b">S3Porter</code>身份策略上添加它。</p><h2 id="9558" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">目标加密密钥资源策略</h2><p id="ff1f" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">下面实际上是<a class="ae ku" href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default" rel="noopener ugc nofollow" target="_blank">默认的密钥策略</a>。有点无聊。</p><p id="3866" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">然而，值得注意的是，KMS的关键政策不同于大多数资源政策。如果没有显式访问权限，则不允许仅身份策略上的IAM权限访问CMK，即使在同一个AWS帐户中也是如此。在KMS密钥策略中，赋予帐户内策略访问密钥的能力的默认方式是允许根帐户用户访问密钥；这也将使其他IAM策略能够关键地采取行动，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="1d38" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">源时段资源策略</h2><p id="e0e7" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">为了允许跨帐户访问S3存储桶，我们需要添加一个资源策略，称为<em class="lu">存储桶策略，</em>到我们的S3存储桶。这个策略相对简单:</p><ul class=""><li id="b8d2" class="mv mw it kx b ky kz lb lc le mx li my lm mz lq na nb nc nd bi translated">在主体部分中，我们指定要授予权限的交叉帐户角色的ARN。</li><li id="1e93" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated">在actions部分，我们提供了<code class="fe nv nw nx ny b">s3:GetObject</code>和<code class="fe nv nw nx ny b">s3:ListObject</code>权限。这两个都是获取我们桶中所有内容所必需的。</li><li id="0b11" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated">作为资源，我们指定了bucket本身<code class="fe nv nw nx ny b">arn:aws:s3:::source</code>以及bucket中的所有对象 t <code class="fe nv nw nx ny b">arn:aws:s3:::source/*</code>。</li></ul><p id="24dc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">缺少任何这些东西都可能导致一个相当模糊的403(拒绝访问)。</p><p id="f5b4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">更复杂的bucket策略可能使用<a class="ae ku" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/amazon-s3-policy-keys.html" rel="noopener ugc nofollow" target="_blank">条件</a>来限制IP地址范围或缩小我们的<code class="fe nv nw nx ny b">S3Porter</code>角色可以访问的对象。</p><p id="d309" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">授予以下权限的另一种方式是使用<a class="ae ku" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html" rel="noopener ugc nofollow" target="_blank">访问控制列表(ACL)</a>。ACL是IAM之前S3管理权限的“老方法”。ACL没有被弃用，但是它们<em class="lu">是</em>遗留的，并且<a class="ae ku" href="https://aws.amazon.com/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/" rel="noopener ugc nofollow" target="_blank"> AWS推荐使用桶策略来代替</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="c6c5" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">源加密密钥资源策略</h2><p id="69c5" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">最后，我们还有一个策略，允许我们的<code class="fe nv nw nx ny b">S3Porter</code>从我们的跨帐户源桶中解密数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="227b" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">漫游教程</h1><p id="6dc3" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">下面我设置并执行两个桶之间的复制，交叉帐户。</p><p id="72e5" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我建议在自动化或使用<a class="ae ku" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank">基础设施即代码</a>签入东西之前，自己完成下面的内容，以获得跨帐户存储桶访问的舒适性。</p><ul class=""><li id="8f3b" class="mv mw it kx b ky kz lb lc le mx li my lm mz lq na nb nc nd bi translated">为了隐私，我已经把所有的id，ARNs，账户等等的名字都改了。</li><li id="bee3" class="mv mw it kx b ky ne lb nf le ng li nh lm ni lq na nb nc nd bi translated">当然，首先您必须拥有创建所有必要对象的权限。对于本教程，我假设您有两个概要文件:<code class="fe nv nw nx ny b">source-admin</code>和<code class="fe nv nw nx ny b">destination-admin</code>。你可以看到我是如何用下面的<code class="fe nv nw nx ny b">~/.aws/credential</code>文件建立这些档案的。</li></ul><p id="873a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">注意:</strong>这里值得一提的是，我们使用的是AWS CLI的第2版。AWS CLI很棒，因为默认情况下，它使用TLS 1.2对我们传输中的数据进行加密，所以不用担心我们在这里通过网络发送明文。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">为我们的教程创建和设置所有的资源。</p></figure><p id="13db" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来，我们需要编辑我们的<code class="fe nv nw nx ny b">~/.aws/credentials</code>文件；这将让我们使用我们的搬运工角色作为个人资料。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">这是AWS概要文件在设置了上述所有用户和S3Porter角色后的样子。请注意来自承担角色的凭证是如何手动添加的。</p></figure><h2 id="27f6" class="nj lz it bd ma nk nl dn me nm nn dp mi le no np mk li nq nr mm lm ns nt mo nu bi translated">最后的步骤</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="22ed" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">如果你遵循了上面的例子，记得在这么做的时候拆掉你创造的任何资源！</strong></p><p id="bde0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">感谢阅读！如果你想聊天或对帖子有反馈，你可以随时通过Twitter、LinkedIn或evankozliner@gmail.com联系我</p><h1 id="3ca0" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">笔记</h1><p id="a1be" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">[1]对信封加密的全面概述超出了本文的范围，但是信封加密是一个重要的(也是有趣的)话题。信封加密很方便的原因有很多:从简化主密钥的轮换并确保它们留在<a class="ae ku" href="https://en.wikipedia.org/wiki/Hardware_security_module" rel="noopener ugc nofollow" target="_blank"> HSMs </a>中，到通过允许使用不同的算法来存储对象和密钥来加速加密。</p></div></div>    
</body>
</html>